I"šQ<blockquote>
  <p>è·ç¦»ä¸Šä¸€ç¯‡ <a href="https://mritd.me/2016/10/09/kubernetes-1.4-create-cluster/">kubernetes 1.4 é›†ç¾¤æ­å»º</a> å‘å¸ƒé—´éš”ä¸ç®—å¤ªä¹…ï¼Œè‡ªå·±ä¹Ÿä¸æ–­åœ°åœ¨ç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒé¼“æ£ï¼Œæœ‰ä¸å°‘ â€œé€—æ¯”â€ çš„ç»å†ï¼Œå‡†å¤‡å†™ä¸€ä¸‹å…·ä½“çš„ kubeadm æ­å»ºé›†ç¾¤çš„ä¸€äº›å‘å’Œè¸©å‘çš„ç»éªŒï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨è¿‡ kubeadm çš„åŒå­¦ï¼Œæœ€å¥½å…ˆçœ‹ä¸‹ä¸Šé¢çš„æ–‡ç« ï¼Œç„¶åé¼“æ£ä¸€éï¼Œä¹Ÿè®¸å¹¶ä¸ä¼šæˆåŠŸï¼Œä½†å¤§éƒ¨åˆ†å‘å†æ¥çœ‹æ­¤æ–‡ä¼šæœ‰æ”¶è·</p>
</blockquote>

<h3 id="ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</h3>

<p>é¦–å…ˆç¯å¢ƒè¿˜æ˜¯ä¸‰å°è™šæ‹Ÿæœºï¼Œè™šæ‹Ÿæœºåœ°å€å¦‚ä¸‹</p>

<table>
  <thead>
    <tr>
      <th>IP åœ°å€</th>
      <th>èŠ‚ç‚¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>192.168.1.167</td>
      <td>master</td>
    </tr>
    <tr>
      <td>192.168.1.189</td>
      <td>node1</td>
    </tr>
    <tr>
      <td>192.168.1.176</td>
      <td>node2</td>
    </tr>
  </tbody>
</table>

<p>ç„¶åæ¯å°æœºå™¨å®‰è£…å¥½ dockerï¼Œè‡³äº rpm å®‰è£…åŒ…ç‰ˆæœ¬ä¸‹é¢ä»‹ç»</p>

<h3 id="äºŒè¯´ç‚¹æ­£ç»äº‹">äºŒã€è¯´ç‚¹æ­£ç»äº‹</h3>

<h4 id="21å®‰è£…åŒ…ä»å“ªæ¥">2.1ã€å®‰è£…åŒ…ä»å“ªæ¥</h4>

<p>å®˜æ–¹çš„æ–‡æ¡£é¡µé¢æ›´æ–°å¹¶ä¸åŠæ—¶ï¼ŒåŒæ—¶ä»–çš„ yum æºæ›´æ–°ä¹Ÿå¾ˆæ…¢ï¼Œå†è€…â€¦é‚£ä»–å¦ˆå¯æ˜¯ Google çš„æœåŠ¡å™¨ï¼Œèƒ½ç‰¹ä¹ˆè¿ä¸Šå—ï¼Ÿä»¥å‰æ€»æ˜¯åœ¨å›½å¤–æœåŠ¡å™¨ä½¿ç”¨ <code class="highlighter-rouge">yumdownloader</code> ä¸‹è½½ï¼Œç„¶å <code class="highlighter-rouge">scp</code> åˆ°æœ¬åœ°ï¼Œè™½ç„¶èƒ½è§£å†³é—®é¢˜ï¼Œä½†æ˜¯è›‹ç¢ä¸€åœ°â€¦æœ€åæ‰¾åˆ°äº†æºå¤´ï¼Œå¦‚ä¸‹</p>

<p><strong>Kubernetes ç¼–è¯‘çš„å„ç§å‘è¡Œç‰ˆå®‰è£…åŒ…æ¥æºäº Github ä¸Šçš„å¦ä¸€ä¸ªå« release çš„é¡¹ç›®ï¼Œåœ°å€ <a href="https://github.com/kubernetes/release">ç‚¹è¿™é‡Œ</a>ï¼ŒæŠŠè¿™ä¸ªé¡¹ç›® <code class="highlighter-rouge">clone</code> ä¸‹æ¥ï¼Œç”±äºæœ¬äººæ˜¯ Centos ç”¨æˆ·ï¼Œæ‰€ä»¥è¿›å…¥ rpm ç›®å½•ï¼Œåœ¨å®‰è£…å¥½ docker çš„æœºå™¨ä¸Šæ‰§è¡Œé‚£ä¸ª <code class="highlighter-rouge">docker-build.sh</code> è„šæœ¬å³å¯ç¼–è¯‘ rpm åŒ…ï¼Œæœ€åä¼šç”Ÿæˆåˆ°å½“å‰ç›®å½•çš„ <code class="highlighter-rouge">output</code> ç›®å½•ä¸‹,æˆªå›¾å¦‚ä¸‹</strong></p>

<p><img src="https://cdn.oss.link/markdown/3zs7u.jpg" alt="release" /></p>

<p><img src="https://cdn.oss.link/markdown/8b3a4.jpg" alt="rpmç›®å½•" /></p>

<h4 id="22é•œåƒä»å“ªæ¥">2.2ã€é•œåƒä»å“ªæ¥</h4>

<p>å¯¹çš„ï¼Œæ²¡é”™ï¼Œgcr.io å°±æ˜¯ Google çš„åŸŸåï¼ŒæœåŠ¡å™¨æ›´ä¸ç”¨æï¼Œæ‰€ä»¥åœ¨è¿›è¡Œ <code class="highlighter-rouge">kubeadm init</code> æ“ä½œæ—¶å¦‚æœä¸å…ˆæŠŠè¿™äº›é•œåƒ load è¿›å»ç»å¯¹ä¼šå¡æ­»ä¸åŠ¨ï¼Œä»¥ä¸‹åˆ—å‡ºäº†æ‰€éœ€é•œåƒï¼Œä½†æ˜¯ç‰ˆæœ¬å·æ ¹æ® rpm ç‰ˆæœ¬ä¸åŒå¯èƒ½ç•¥æœ‰ä¸åŒï¼Œå…·ä½“æ€ä¹ˆçœ‹ä¸‹é¢ä»‹ç»</p>

<table>
  <thead>
    <tr>
      <th>é•œåƒåç§°</th>
      <th>ç‰ˆæœ¬å·</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>gcr.io/google_containers/kube-discovery-amd64</td>
      <td>1.0</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/kubedns-amd64</td>
      <td>1.7</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/kube-proxy-amd64</td>
      <td>v1.4.1</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/kube-scheduler-amd64</td>
      <td>v1.4.1</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/kube-controller-manager-amd64</td>
      <td>v1.4.1</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/kube-apiserver-amd64</td>
      <td>v1.4.1</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/etcd-amd64</td>
      <td>2.2.5</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/kube-dnsmasq-amd64</td>
      <td>1.3</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/exechealthz-amd64</td>
      <td>1.1</td>
    </tr>
    <tr>
      <td>gcr.io/google_containers/pause-amd64</td>
      <td>3.0</td>
    </tr>
  </tbody>
</table>

<p><strong>è¿™äº›é•œåƒæœ‰ä¸¤ç§åŠæ³•å¯ä»¥è·å–ï¼Œç¬¬ä¸€ç§æ˜¯åˆ©ç”¨ä¸€å°å›½å¤–çš„æœåŠ¡å™¨ï¼Œåœ¨ä¸Šé¢ pull ä¸‹æ¥ï¼Œç„¶åå† save æˆ tar æ–‡ä»¶ï¼Œæœ€å scp åˆ°æœ¬åœ° load è¿›å»ï¼›ç›¸å¯¹äºç¬¬ä¸€ç§æ–¹å¼æ¯”è¾ƒå‘çš„æ˜¯å–å†³äºæœåŠ¡å™¨é€Ÿåº¦ï¼Œæ¯æ¬¡æèµ·æ¥ä¹Ÿå¾ˆè›‹ç–¼ï¼Œç¬¬äºŒç§æ–¹å¼å°±æ˜¯åˆ©ç”¨ docker hub åšä¸­è½¬ï¼Œç®€å•çš„è¯´å°±æ˜¯åˆ©ç”¨ docker hub çš„è‡ªåŠ¨æ„å»ºåŠŸèƒ½ï¼Œåœ¨ Github ä¸­åˆ›å»ºä¸€ä¸ª Dockerfileï¼Œé‡Œé¢åªéœ€è¦ <code class="highlighter-rouge">FROM xxxx</code> è¿™äº› gcr.io çš„é•œåƒå³å¯ï¼Œæœ€å pull åˆ°æœ¬åœ°ï¼Œç„¶åå† tag ä¸€ä¸‹</strong></p>

<p><strong>é¦–å…ˆåˆ›å»ºä¸€ä¸ª github é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥ fork æˆ‘çš„å³å¯</strong></p>

<p><img src="https://cdn.oss.link/markdown/2eo34.jpg" alt="docker-libray" /></p>

<p>å…¶ä¸­æ¯ä¸ª Dockerfile åªéœ€è¦ <code class="highlighter-rouge">FROM</code> ä¸€ä¸‹å³å¯</p>

<p><img src="https://cdn.oss.link/markdown/cxva2.jpg" alt="Dockerfile" /></p>

<p><strong>æœ€ååœ¨ Docker Hub ä¸Šåˆ›å»ºè‡ªåŠ¨æ„å»ºé¡¹ç›®</strong></p>

<p><img src="https://cdn.oss.link/markdown/p5khs.jpg" alt="createproject" /></p>

<p><img src="https://cdn.oss.link/markdown/gc8vl.jpg" alt="from github" /></p>

<p><img src="https://cdn.oss.link/markdown/9ufnd.jpg" alt="selectproject" /></p>

<p><img src="https://cdn.oss.link/markdown/ud42y.jpg" alt="details" /></p>

<p><strong>æœ€åè¦æ‰‹åŠ¨è§¦å‘ä¸€ä¸‹ï¼Œç„¶å Docker Hub æ‰ä¼šå¼€å§‹ç»™ä½ ç¼–è¯‘</strong></p>

<p><img src="https://cdn.oss.link/markdown/phgsg.jpg" alt="Tigger" /></p>

<p><strong>ç­‰å¾…å®Œæˆå³å¯ç›´æ¥ pull äº†</strong></p>

<p><img src="https://cdn.oss.link/markdown/itnw3.jpg" alt="success" /></p>

<h4 id="23é•œåƒç‰ˆæœ¬æ€ä¹ˆæ•´">2.3ã€é•œåƒç‰ˆæœ¬æ€ä¹ˆæ•´</h4>

<p>ä¸Šé¢å·²ç»è§£å†³äº†é•œåƒè·å–é—®é¢˜ï¼Œä½†æ˜¯ä¸€å¤§å¿ƒç—…å°±æ˜¯ â€œæˆ‘ç‰¹ä¹ˆæ€ä¹ˆçŸ¥é“æ˜¯å“ªä¸ªç‰ˆæœ¬çš„â€ï¼Œä¸ºäº†å‘æ‰¬ â€œåˆ¨æ ¹é—®åº•â€ çš„ç²¾ç¥ï¼Œ<strong>å…ˆè¿›è¡Œä¸€é <code class="highlighter-rouge">kubeadm init</code>ï¼Œè¿™æ—¶å€™ç»å¯¹å¡æ­»ï¼Œæ­¤æ—¶è¿›å…¥ <code class="highlighter-rouge">/etc/kubernetes/manifests</code> å¯ä»¥çœ‹åˆ°è®¸å¤š json æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸­å®šä¹‰äº†éœ€è¦å“ªäº›åŸºç¡€é•œåƒ</strong></p>

<p><img src="https://cdn.oss.link/markdown/3ovg8.jpg" alt="all json" /></p>

<p><img src="https://cdn.oss.link/markdown/uitnd.jpg" alt="image version" /></p>

<p>ä»ä¸Šå›¾ä¸­åŸºæœ¬å¯ä»¥çœ‹åˆ° <code class="highlighter-rouge">kubeadm init</code> çš„æ—¶å€™ä¼šæ‹‰å–å“ªäº›åŸºç¡€é•œåƒäº†ï¼Œ<strong>ä½†æ˜¯è¿˜æœ‰ä¸€äº›é•œåƒï¼Œä»ç„¶æ— æ³•æ‰¾åˆ°ï¼Œæ¯”å¦‚<code class="highlighter-rouge">kubedns</code>ã€<code class="highlighter-rouge">pause</code> ç­‰ï¼Œè‡³äºå…¶ä»–çš„é•œåƒç‰ˆæœ¬ï¼Œå¯ä»¥ä»æºç ä¸­æ‰¾åˆ°ï¼Œæºç ä½ç½®æ˜¯ <code class="highlighter-rouge">kubernetes/cmd/kubeadm/app/images/images.go</code> è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤º:</strong></p>

<p><img src="https://cdn.oss.link/markdown/ocgu4.jpg" alt="image version" /></p>

<p>å‰©ä½™çš„ä¸€äº›é•œåƒï¼Œæ¯”å¦‚ <code class="highlighter-rouge">kube-proxy-amd64</code>ã€<code class="highlighter-rouge">kube-discovery-amd64</code> ä¸¤ä¸ªé•œåƒï¼Œå…¶ä¸­ <code class="highlighter-rouge">kube-discovery-amd64</code> ç°åœ¨ä¸€ç›´æ˜¯ 1.0 ç‰ˆæœ¬ï¼Œæºç å¦‚ä¸‹æ‰€ç¤º</p>

<p><img src="https://cdn.oss.link/markdown/mp3qo.jpg" alt="discovery version" /></p>

<p><code class="highlighter-rouge">kube-proxy-amd64</code> åˆ™æ˜¯ä¸€ç›´è·ŸéšåŸºç¡€ç»„ä»¶çš„ä¸»ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä» <code class="highlighter-rouge">manifests</code> ä¸­çœ‹åˆ° controller ç­‰ç‰ˆæœ¬æ˜¯ <code class="highlighter-rouge">v.1.4.4</code>ï¼Œé‚£ä¹ˆ <code class="highlighter-rouge">kube-proxy-amd64</code> ä¹Ÿæ˜¯è¿™ä¸ªç‰ˆæœ¬ï¼Œæºç å¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/tienu.jpg" alt="proxy version" /></p>

<p>æœ€åæ ¹æ®è¿™äº›ç‰ˆæœ¬å» github ä¸Šå‡†å¤‡ç›¸åº”çš„ Dockerfileï¼Œåœ¨åˆ©ç”¨ Docker Hub çš„è‡ªåŠ¨æ„å»º build ä¸€ä¸‹ï¼Œå† pull ä¸‹æ¥ tag æˆå¯¹åº”çš„é•œåƒåç§°å³å¯</p>

<h3 id="ä¸‰æ­å»ºé›†ç¾¤">ä¸‰ã€æ­å»ºé›†ç¾¤</h3>

<h4 id="31ä¸»æœºåå¤„ç†">3.1ã€ä¸»æœºåå¤„ç†</h4>

<p><strong>ç»è¿‡äº²æµ‹ï¼ŒèŠ‚ç‚¹ä¸»æœºåæœ€å¥½ä¸º <code class="highlighter-rouge">xxx.xxx</code> è¿™ç§åŸŸåæ ¼å¼ï¼Œå¦åˆ™åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒPOD ä¸­è·‘çš„ç¨‹åºä½¿ç”¨åŸŸåè§£ææ—¶å¯èƒ½å‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥å…ˆè¦å¤„ç†ä¸€ä¸‹ä¸»æœºå</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å†™å…¥ hostname(node èŠ‚ç‚¹åç¼€æ”¹æˆ .node)</span>
<span class="nb">echo</span> <span class="s2">"192-168-1-167.master"</span> <span class="o">&gt;</span> /etc/hostname 
<span class="c"># åŠ å…¥ hosts</span>
<span class="nb">echo</span> <span class="s2">"127.0.0.1   192-168-1-167.master"</span> <span class="o">&gt;&gt;</span> /etc/hosts
<span class="c"># ä¸é‡å¯æƒ…å†µä¸‹ä½¿å†…æ ¸ç”Ÿæ•ˆ</span>
sysctl kernel.hostname<span class="o">=</span>192-168-1-167.master
<span class="c"># éªŒè¯æ˜¯å¦ä¿®æ”¹æˆåŠŸ</span>
âœ  ~ <span class="nb">hostname
</span>192-168-1-167.master
</code></pre></div></div>

<h4 id="32load-é•œåƒ">3.2ã€load é•œåƒ</h4>

<p>ç”±äºæœ¬äººå·²ç»åœ¨ Docker Hub ä¸Šå¤„ç†å¥½äº†ç›¸å…³é•œåƒï¼Œæ‰€ä»¥ç›´æ¥ pull ä¸‹æ¥ tag ä¸€ä¸‹å³å¯ï¼Œ</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">images</span><span class="o">=(</span>kube-proxy-amd64:v1.4.4 kube-discovery-amd64:1.0 kubedns-amd64:1.7 kube-scheduler-amd64:v1.4.4 kube-controller-manager-amd64:v1.4.4 kube-apiserver-amd64:v1.4.4 etcd-amd64:2.2.5 kube-dnsmasq-amd64:1.3 exechealthz-amd64:1.1 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.4.1<span class="o">)</span>
<span class="k">for </span>imageName <span class="k">in</span> <span class="k">${</span><span class="nv">images</span><span class="p">[@]</span><span class="k">}</span> <span class="p">;</span> <span class="k">do
  </span>docker pull mritd/<span class="nv">$imageName</span>
  docker tag mritd/<span class="nv">$imageName</span> gcr.io/google_containers/<span class="nv">$imageName</span>
  docker rmi mritd/<span class="nv">$imageName</span>
<span class="k">done</span>
</code></pre></div></div>

<h4 id="33å®‰è£…-rpm">3.3ã€å®‰è£… rpm</h4>

<p>rpm è·å–åŠæ³•ä¸Šæ–‡å·²ç»æåˆ°ï¼Œå¯ä»¥è‡ªå·±ç¼–è¯‘ï¼Œè¿™é‡Œæˆ‘å·²ç»ç¼–è¯‘å¥½å¹¶ç»´æŠ¤äº†ä¸€ä¸ª yum æºï¼Œç›´æ¥yum install å³å¯(æ‡’)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æ·»åŠ  yum æº</span>
<span class="nb">tee</span> /etc/yum.repos.d/mritd.repo <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
[mritdrepo]
name=Mritd Repository
baseurl=https://rpm.mritd.me/centos/7/x86_64
enabled=1
gpgcheck=1
gpgkey=https://cdn.oss.link/keys/rpm.public.key
</span><span class="no">EOF
</span><span class="c"># åˆ·æ–°cache</span>
yum makecache
<span class="c"># å®‰è£…</span>
yum <span class="nb">install</span> <span class="nt">-y</span> kubelet kubectl kubernetes-cni kubeadm
</code></pre></div></div>

<h4 id="34åˆå§‹åŒ–-master">3.4ã€åˆå§‹åŒ– master</h4>

<p><strong>ç­‰ä¼šæœ‰ä¸ªå‘ï¼Œkubeadm ç­‰ç›¸å…³ rpm å®‰è£…åä¼šç”Ÿæˆ <code class="highlighter-rouge">/etc/kubernetes</code> ç›®å½•ï¼Œè€Œ kubeadm init æ—¶å€™åˆä¼šæ£€æµ‹è¿™äº›ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™åœæ­¢åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¦å…ˆæ¸…ç†ä¸€ä¸‹ï¼Œä»¥ä¸‹æ¸…ç†è„šæœ¬æ¥æºäº <a href="http://kubernetes.io/docs/getting-started-guides/kubeadm/">å®˜æ–¹æ–‡æ¡£ Tear down éƒ¨åˆ†</a>ï¼Œè¯¥è„šæœ¬åŒæ ·é€‚ç”¨äºåˆå§‹åŒ–å¤±è´¥è¿›è¡Œé‡ç½®</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl stop kubelet<span class="p">;</span>
<span class="c"># æ³¨æ„: ä¸‹é¢è¿™æ¡å‘½ä»¤ä¼šå¹²æ‰æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ docker å®¹å™¨ï¼Œ</span>
<span class="c"># å¦‚æœè¦è¿›è¡Œé‡ç½®æ“ä½œï¼Œæœ€å¥½å…ˆç¡®å®šå½“å‰è¿è¡Œçš„æ‰€æœ‰å®¹å™¨éƒ½èƒ½å¹²æ‰(å¹²æ‰ä¸å½±å“ä¸šåŠ¡)ï¼Œ</span>
<span class="c"># å¦åˆ™çš„è¯æœ€å¥½æ‰‹åŠ¨åˆ é™¤ kubeadm åˆ›å»ºçš„ç›¸å…³å®¹å™¨(gcr.io ç›¸å…³çš„)</span>
docker <span class="nb">rm</span> <span class="nt">-f</span> <span class="nt">-v</span> <span class="si">$(</span>docker ps <span class="nt">-q</span><span class="si">)</span><span class="p">;</span>
find /var/lib/kubelet | xargs <span class="nt">-n</span> 1 findmnt <span class="nt">-n</span> <span class="nt">-t</span> tmpfs <span class="nt">-o</span> TARGET <span class="nt">-T</span> | <span class="nb">uniq</span> | xargs <span class="nt">-r</span> umount <span class="nt">-v</span><span class="p">;</span>
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nt">-f</span> /etc/kubernetes /var/lib/kubelet /var/lib/etcd<span class="p">;</span>
</code></pre></div></div>

<p><strong>è¿˜æœ‰ä¸ªå‘ï¼Œåˆå§‹åŒ–ä»¥å‰è®°å¾—ä¸€å®šè¦å¯åŠ¨ kubeletï¼Œè™½ç„¶ä½  <code class="highlighter-rouge">systemctl status kubelet</code> çœ‹ç€ä»–æ˜¯å¯åŠ¨å¤±è´¥ï¼Œä½†æ˜¯ä¹Ÿå¾—å¯åŠ¨ï¼Œå¦åˆ™ç»å£å¡æ­»</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>kubelet
systemctl start kubelet
</code></pre></div></div>

<p><strong>ç­‰ä¼šç­‰ä¼šï¼Œè¿˜æœ‰å‘ï¼Œæ–°ç‰ˆæœ¬ç›´æ¥ init ä¼šæç¤º <code class="highlighter-rouge">ebtables not found in system path</code> é”™è¯¯ï¼Œæ‰€ä»¥è¿˜å¾—å…ˆå®‰è£…ä¸€ä¸‹è¿™ä¸ªåŒ…åœ¨åˆå§‹åŒ–</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å®‰è£… ebtables</span>
yum <span class="nb">install</span> <span class="nt">-y</span> ebtables
</code></pre></div></div>

<p><strong>æœ€åè§è¯å¥‡è¿¹çš„æ—¶åˆ»</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆå§‹åŒ–å¹¶æŒ‡å®š apiserver ç›‘å¬åœ°å€</span>
kubeadm init <span class="nt">--api-advertise-addresses</span> 192.168.1.167
</code></pre></div></div>

<p><strong>å®Œç¾æˆªå›¾å¦‚ä¸‹</strong></p>

<p><img src="https://cdn.oss.link/markdown/rs2mw.jpg" alt="init master" /></p>

<p><strong>è¿™é‡Œå†çˆ†æ–™ä¸€ä¸ªå‘ï¼Œåº•ä¸‹çš„ <code class="highlighter-rouge">kubeadm join --token=b17964.5d8a3c14e99cf6aa 192.168.1.167</code> è¿™æ¡å‘½ä»¤ä¸€å®šä¿å­˜å¥½ï¼Œå› ä¸ºåæœŸæ²¡æ³•é‡ç°çš„ï¼Œä½ ä»¬è€å¤§å†è®©ä½ æ·»åŠ æœºå™¨çš„æ—¶å€™å¦‚æœæ²¡è¿™ä¸ªä½ ä¼šå“­çš„</strong></p>

<h4 id="35åŠ å…¥-node">3.5ã€åŠ å…¥ node</h4>

<p>ä¸Šé¢æ‰€æœ‰å‘å¤§çº¦è¯´çš„å·®ä¸å¤šäº†ï¼Œç›´æ¥ä¸Šå‘½ä»¤äº†</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å¤„ç†ä¸»æœºå</span>
<span class="nb">echo</span> <span class="s2">"192-168-1-189.node"</span> <span class="o">&gt;</span> /etc/hostname 
<span class="nb">echo</span> <span class="s2">"127.0.0.1   192-168-1-189.node"</span> <span class="o">&gt;&gt;</span> /etc/hosts
sysctl kernel.hostname<span class="o">=</span>192-168-1-189.node
<span class="c"># æ‹‰å–é•œåƒ</span>
<span class="nv">images</span><span class="o">=(</span>kube-proxy-amd64:v1.4.4 kube-discovery-amd64:1.0 kubedns-amd64:1.7 kube-scheduler-amd64:v1.4.4 kube-controller-manager-amd64:v1.4.4 kube-apiserver-amd64:v1.4.4 etcd-amd64:2.2.5 kube-dnsmasq-amd64:1.3 exechealthz-amd64:1.1 pause-amd64:3.0 kubernetes-dashboard-amd64:v1.4.1<span class="o">)</span>
<span class="k">for </span>imageName <span class="k">in</span> <span class="k">${</span><span class="nv">images</span><span class="p">[@]</span><span class="k">}</span> <span class="p">;</span> <span class="k">do
  </span>docker pull mritd/<span class="nv">$imageName</span>
  docker tag mritd/<span class="nv">$imageName</span> gcr.io/google_containers/<span class="nv">$imageName</span>
  docker rmi mritd/<span class="nv">$imageName</span>
<span class="k">done</span>
<span class="c"># è£… rpm</span>
<span class="nb">tee</span> /etc/yum.repos.d/mritd.repo <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
[mritdrepo]
name=Mritd Repository
baseurl=https://rpm.mritd.me/centos/7/x86_64
enabled=1
gpgcheck=1
gpgkey=https://cdn.oss.link/keys/rpm.public.key
</span><span class="no">EOF
</span>yum makecache
yum <span class="nb">install</span> <span class="nt">-y</span> kubelet kubectl kubernetes-cni kubeadm ebtables
<span class="c"># æ¸…ç†ç›®å½•(æ²¡åˆå§‹åŒ–è¿‡åªéœ€è¦åˆ ç›®å½•)</span>
<span class="nb">rm</span> <span class="nt">-r</span> <span class="nt">-f</span> /etc/kubernetes /var/lib/kubelet /var/lib/etcd<span class="p">;</span>
<span class="c"># å¯åŠ¨ kubelet</span>
systemctl <span class="nb">enable </span>kubelet
systemctl start kubelet
<span class="c"># åˆå§‹åŒ–åŠ å…¥é›†ç¾¤</span>
kubeadm <span class="nb">join</span> <span class="nt">--token</span><span class="o">=</span>b17964.5d8a3c14e99cf6aa 192.168.1.167
</code></pre></div></div>

<p><strong>åŒæ ·å®Œç¾æˆªå›¾</strong></p>

<p><img src="https://cdn.oss.link/markdown/9c8eu.jpg" alt="join master" /></p>

<p><img src="https://cdn.oss.link/markdown/ri4q9.jpg" alt="get node" /></p>

<h4 id="36éƒ¨ç½²-weave-ç½‘ç»œ">3.6ã€éƒ¨ç½² weave ç½‘ç»œ</h4>

<p>å†æ²¡éƒ¨ç½² weave æ—¶ï¼Œdns æ˜¯å¯åŠ¨ä¸äº†çš„ï¼Œå¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/fqjsg.jpg" alt="dns not work" /></p>

<p><strong>å®˜æ–¹ç»™å‡ºçš„å‘½ä»¤æ˜¯è¿™æ ·çš„</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://git.io/weave-kube
</code></pre></div></div>

<p>æœ¬ç€ â€œåˆ¨æ ¹é—®åº•æŒ–ç¥–åŸâ€ çš„ç²¾ç¥ï¼Œå…ˆæŠŠè¿™ä¸ª yaml æä¸‹æ¥</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://git.io/weave-kube <span class="nt">-O</span> weave-kube.yaml
</code></pre></div></div>

<p>ç„¶ååŒæ ·çš„å¥—è·¯ï¼Œæ‰“å¼€çœ‹ä¸€ä¸‹é•œåƒï¼Œåˆ©ç”¨ Docker Hub åšä¸­è½¬ï¼Œæä¸‹æ¥å† load è¿›å»ï¼Œç„¶å <code class="highlighter-rouge">create -f</code> å°±è¡Œäº†</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull mritd/weave-kube:1.7.2
docker tag mritd/weave-kube:1.7.2 weaveworks/weave-kube:1.7.2
docker rmi mritd/weave-kube:1.7.2
kubectl create <span class="nt">-f</span> weave-kube.yaml
</code></pre></div></div>

<p><strong>å®Œç¾æˆªå›¾</strong></p>

<p><img src="https://cdn.oss.link/markdown/0ja5f.jpg" alt="create weave" /></p>

<h4 id="37éƒ¨ç½²-dashboard">3.7ã€éƒ¨ç½² dashboard</h4>

<p><strong>dashboard çš„å‘½ä»¤ä¹Ÿè·Ÿ weave çš„ä¸€æ ·ï¼Œä¸è¿‡æœ‰ä¸ªå¤§å‘ï¼Œé»˜è®¤çš„ yaml æ–‡ä»¶ä¸­å¯¹äº image æ‹‰å–ç­–ç•¥çš„å®šä¹‰æ˜¯ æ— è®ºä½•æ—¶éƒ½ä¼šå»æ‹‰å–é•œåƒï¼Œå¯¼è‡´å³ä½¿ä½  load è¿›å»ä¹Ÿæ— åµç”¨ï¼Œæ‰€ä»¥è¿˜å¾—å…ˆæŠŠ yaml æä¸‹æ¥ç„¶åæ”¹ä¸€ä¸‹é•œåƒæ‹‰å–ç­–ç•¥ï¼Œæœ€åå† <code class="highlighter-rouge">create -f</code> å³å¯</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://rawgit.com/kubernetes/dashboard/master/src/deploy/kubernetes-dashboard.yaml <span class="nt">-O</span> kubernetes-dashboard.yaml
</code></pre></div></div>

<p><strong>ç¼–è¾‘ yaml æ”¹ä¸€ä¸‹ <code class="highlighter-rouge">imagePullPolicy</code>ï¼ŒæŠŠ <code class="highlighter-rouge">Always</code> æ”¹æˆ <code class="highlighter-rouge">IfNotPresent</code>(æœ¬åœ°æ²¡æœ‰å†å»æ‹‰å–) æˆ–è€… <code class="highlighter-rouge">Never</code>(ä»ä¸å»æ‹‰å–) å³å¯</strong></p>

<p><img src="https://cdn.oss.link/markdown/lqvh1.jpg" alt="IfNotPresent" /></p>

<p>æœ€åå†åˆ©ç”¨ Dokcer Hub ä¸­è½¬ï¼Œç„¶ååˆ›å»º(å®é™…ä¸Š dashboard å·²ç»æœ‰äº† v1.4.1ï¼Œæˆ‘è¿™é‡Œå·²ç»æ”¹äº†)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> kubernetes-dashboard.yaml
</code></pre></div></div>

<p><strong>æˆªå›¾å¦‚ä¸‹</strong></p>

<p><img src="https://cdn.oss.link/markdown/xsn9u.jpg" alt="create dashboard" /></p>

<p><strong>é€šè¿‡ describe å‘½ä»¤æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹å…¶æš´éœ²å‡ºçš„ <code class="highlighter-rouge">NodePoint</code>,ç„¶åä¾¿å¯è®¿é—®</strong></p>

<p><img src="https://cdn.oss.link/markdown/5a94q.jpg" alt="describe dashboard" /></p>

<p><img src="https://cdn.oss.link/markdown/xwjvs.jpg" alt="show dashboard" /></p>

<h3 id="å››å…¶ä»–çš„ä¸€äº›å‘">å››ã€å…¶ä»–çš„ä¸€äº›å‘</h3>

<p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å‘ç­‰ç€å¤§å®¶å»æ‘¸ç´¢ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯ DNS è§£æé”™è¯¯ï¼Œè¡¨ç°å½¢å¼ä¸º <strong>POD å†…çš„ç¨‹åºé€šè¿‡åŸŸåè®¿é—®è§£æä¸äº†ï¼Œcat ä¸€ä¸‹å®¹å™¨çš„ <code class="highlighter-rouge">/etc/resolv.conf</code>å‘ç°æŒ‡å‘çš„ dns æœåŠ¡å™¨ä¸ <code class="highlighter-rouge">kubectl get svc --namespace=kube-system</code> ä¸­çš„ kube-dsn åœ°å€ä¸ç¬¦</strong>ï¼›è§£å†³åŠæ³•å°±æ˜¯ <strong>ç¼–è¾‘èŠ‚ç‚¹çš„ <code class="highlighter-rouge">/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> æ–‡ä»¶ï¼Œæ›´æ”¹ <code class="highlighter-rouge">KUBELET_DNS_ARGS</code> åœ°å€ä¸º <code class="highlighter-rouge">get svc</code> ä¸­çš„ kube-dns åœ°å€ï¼Œç„¶åé‡å¯ kubelet æœåŠ¡ï¼Œé‡æ–°æ€æ‰ POD è®© kubernetes é‡å»ºå³å¯</strong></p>

<p><img src="https://cdn.oss.link/markdown/hhozt.jpg" alt="modify kube-dns" /></p>

<p><strong>å…¶ä»–å‘æ¬¢è¿å¤§å®¶è¡¥å……</strong></p>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET