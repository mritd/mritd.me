I"¥<blockquote>
  <p>å‰æ®µæ—¶é—´æ’¸äº†ä¸€ä¼š Kubernetes å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨æŸ¥çœ‹ TLS bootstrapping è¿™å—æ˜¯å‘ç°å·²ç»è·Ÿ 1.4 çš„æ—¶å€™å®Œå…¨ä¸ä¸€æ ·äº†ï¼›ç›®å‰æ‰€æœ‰æ­å»ºæ–‡æ¡£ä¹Ÿéƒ½ä¿ç•™ç€ 1.4 æ—¶ä»£çš„é…ç½®ï¼Œåœ¨çœ‹å®Œæ–‡æ¡£åå‘ç°ç›®å‰é…ç½®æœ‰å¾ˆå¤šé—®é¢˜ï¼ŒåŒæ—¶ä¹ŸåŸ‹ä¸‹äº† <strong>éšè—ç‚¸å¼¹</strong>ï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½ä¼šåœ¨ä¸€å¹´åçˆ†å‘â€¦..åæœå°±æ˜¯é›†ç¾¤ node å…¨éƒ¨æ‰çº¿ï¼›æ‰€ä»¥ä»”ç»†çš„æ’¸äº†ä¸€ä¸‹è¿™ä¸ªæ–‡æ¡£ï¼Œä»å…ƒæ—¦åˆ°å†™æ­¤æ–‡ç« çš„æ—¶é—´éƒ½åœ¨æµ‹è¯•è¿™ä¸ª TLS bootstrappingï¼Œä»¥ä¸‹è®°å½•ä¸€ä¸‹è¿™æ¬¡çš„æˆæœ</p>
</blockquote>

<p>é˜…è¯»æœ¬æ–‡ç« å‰ï¼Œè¯·å…ˆé˜…è¯»ä¸€ä¸‹æœ¬æ–‡å‚è€ƒçš„ç›¸å…³æ–‡æ¡£:</p>

<ul>
  <li><a href="https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/">TLS bootstrapping</a></li>
  <li><a href="https://github.com/jcbsmpsn/community/blob/a843295a4f7594d41e66a8342e174f48d06b4f9f/contributors/design-proposals/kubelet-server-certificate-bootstrap-rotation.md">Kubelet Server Certificate Bootstrap &amp; Rotation</a></li>
  <li><a href="https://kubernetes.io/docs/admin/authorization/rbac/">Using RBAC Authorization</a></li>
</ul>

<h3 id="ä¸€tls-bootstrapping-ç®€ä»‹">ä¸€ã€TLS bootstrapping ç®€ä»‹</h3>

<p>Kubernetes åœ¨ 1.4 ç‰ˆæœ¬(æˆ‘è®°ç€æ˜¯)æ¨å‡ºäº† TLS bootstrapping åŠŸèƒ½ï¼›è¿™ä¸ªåŠŸèƒ½ä¸»è¦è§£å†³äº†ä»¥ä¸‹é—®é¢˜:</p>

<p>å½“é›†ç¾¤å¼€å¯äº† TLS è®¤è¯åï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„ kubelet ç»„ä»¶éƒ½è¦ä½¿ç”¨ç”± apiserver ä½¿ç”¨çš„ CA ç­¾å‘çš„æœ‰æ•ˆè¯ä¹¦æ‰èƒ½ä¸ apiserver é€šè®¯ï¼›æ­¤æ—¶å¦‚æœèŠ‚ç‚¹å¤šèµ·æ¥ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹å•ç‹¬ç­¾ç½²è¯ä¹¦å°†æ˜¯ä¸€ä»¶éå¸¸ç¹ççš„äº‹æƒ…ï¼›TLS bootstrapping åŠŸèƒ½å°±æ˜¯è®© kubelet å…ˆä½¿ç”¨ä¸€ä¸ªé¢„å®šçš„ä½æƒé™ç”¨æˆ·è¿æ¥åˆ° apiserverï¼Œç„¶åå‘ apiserver ç”³è¯·è¯ä¹¦ï¼Œkubelet çš„è¯ä¹¦ç”± apiserver åŠ¨æ€ç­¾ç½²ï¼›åœ¨é…åˆ RBAC æˆæƒæ¨¡å‹ä¸‹çš„å·¥ä½œæµç¨‹å¤§è‡´å¦‚ä¸‹æ‰€ç¤º(ä¸å®Œæ•´ï¼Œä¸‹é¢ç»†è¯´)</p>

<p><img src="https://cdn.oss.link/markdown/ixtwd.png" alt="tls_bootstrapping" /></p>

<h3 id="äºŒtls-bootstrapping-ç›¸å…³æœ¯è¯­">äºŒã€TLS bootstrapping ç›¸å…³æœ¯è¯­</h3>

<h4 id="21kubelet-server">2.1ã€kubelet server</h4>

<p>åœ¨å®˜æ–¹ TLS bootstrapping æ–‡æ¡£ä¸­å¤šæ¬¡æåˆ°è¿‡ <code class="highlighter-rouge">kubelet server</code> è¿™ä¸ªä¸œè¥¿ï¼›åœ¨ç»è¿‡ç¿»é˜…å¤§é‡æ–‡æ¡£ä»¥åŠ TLS bootstrapping è®¾è®¡æ–‡æ¡£åå¾—å‡ºï¼Œ<strong><code class="highlighter-rouge">kubelet server</code> æŒ‡çš„åº”è¯¥æ˜¯ kubelet çš„ 10250 ç«¯å£ï¼›</strong></p>

<p><strong>kubelet ç»„ä»¶åœ¨å·¥ä½œæ—¶ï¼Œé‡‡ç”¨ä¸»åŠ¨çš„æŸ¥è¯¢æœºåˆ¶ï¼Œå³å®šæœŸè¯·æ±‚ apiserver è·å–è‡ªå·±æ‰€åº”å½“å¤„ç†çš„ä»»åŠ¡ï¼Œå¦‚å“ªäº› pod åˆ†é…åˆ°äº†è‡ªå·±èº«ä¸Šï¼Œä»è€Œå»å¤„ç†è¿™äº›ä»»åŠ¡ï¼›åŒæ—¶ kubelet è‡ªå·±è¿˜ä¼šæš´éœ²å‡ºä¸¤ä¸ªæœ¬èº« api çš„ç«¯å£ï¼Œç”¨äºå°†è‡ªå·±æœ¬èº«çš„ç§æœ‰ api æš´éœ²å‡ºå»ï¼Œè¿™ä¸¤ä¸ªç«¯å£åˆ†åˆ«æ˜¯ 10250 ä¸ 10255ï¼›å¯¹äº 10250 ç«¯å£ï¼Œkubelet ä¼šåœ¨å…¶ä¸Šé‡‡ç”¨ TLS åŠ å¯†ä»¥æä¾›é€‚å½“çš„é‰´æƒåŠŸèƒ½ï¼›å¯¹äº 10255 ç«¯å£ï¼Œkubelet ä¼šä»¥åªè¯»å½¢å¼æš´éœ²ç»„ä»¶æœ¬èº«çš„ç§æœ‰ apiï¼Œå¹¶ä¸”ä¸åšé‰´æƒå¤„ç†</strong></p>

<p><strong>æ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯è¯´ kubelet ä¸Šå®é™…ä¸Šæœ‰ä¸¤ä¸ªåœ°æ–¹ç”¨åˆ°è¯ä¹¦ï¼Œä¸€ä¸ªæ˜¯ç”¨äºä¸ API server é€šè®¯æ‰€ç”¨åˆ°çš„è¯ä¹¦ï¼Œå¦ä¸€ä¸ªæ˜¯ kubelet çš„ 10250 ç§æœ‰ api ç«¯å£éœ€è¦ç”¨åˆ°çš„è¯ä¹¦</strong></p>

<h4 id="22csr-è¯·æ±‚ç±»å‹">2.2ã€CSR è¯·æ±‚ç±»å‹</h4>

<p>kubelet å‘èµ·çš„ CSR è¯·æ±‚éƒ½æ˜¯ç”± controller manager æ¥åšå®é™…ç­¾ç½²çš„ï¼Œå¯¹äº controller manager æ¥è¯´ï¼ŒTLS bootstrapping ä¸‹ kubelet å‘èµ·çš„ CSR è¯·æ±‚å¤§è‡´åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§</p>

<ul>
  <li>nodeclient: kubelet ä»¥ <code class="highlighter-rouge">O=system:nodes</code> å’Œ <code class="highlighter-rouge">CN=system:node:(node name)</code> å½¢å¼å‘èµ·çš„ CSR è¯·æ±‚</li>
  <li>selfnodeclient: kubelet client renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚(ä¸ä¸Šä¸€ä¸ªè¯ä¹¦å°±æœ‰ç›¸åŒçš„ O å’Œ CN)</li>
  <li>selfnodeserver: kubelet server renew è‡ªå·±çš„è¯ä¹¦å‘èµ·çš„ CSR è¯·æ±‚</li>
</ul>

<p><strong>å¤§ç™½è¯åŠ è‡ªå·±æµ‹è¯•å¾—å‡ºçš„ç»“æœ: nodeclient ç±»å‹çš„ CSR ä»…åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶ä¼šäº§ç”Ÿï¼Œselfnodeclient ç±»å‹çš„ CSR è¯·æ±‚å®é™…ä¸Šå°±æ˜¯ kubelet renew è‡ªå·±ä½œä¸º client è·Ÿ apiserver é€šè®¯æ—¶ä½¿ç”¨çš„è¯ä¹¦äº§ç”Ÿçš„ï¼Œselfnodeserver ç±»å‹çš„ CSR è¯·æ±‚åˆ™æ˜¯ kubelet é¦–æ¬¡ç”³è¯·æˆ–åç»­ renew è‡ªå·±çš„ 10250 api ç«¯å£è¯ä¹¦æ—¶äº§ç”Ÿçš„</strong></p>

<h3 id="ä¸‰tls-bootstrapping-å…·ä½“å¼•å¯¼è¿‡ç¨‹">ä¸‰ã€TLS bootstrapping å…·ä½“å¼•å¯¼è¿‡ç¨‹</h3>

<h4 id="31kubernetes-tls-ä¸-rbac-è®¤è¯">3.1ã€Kubernetes TLS ä¸ RBAC è®¤è¯</h4>

<p>åœ¨è¯´å…·ä½“çš„å¼•å¯¼è¿‡ç¨‹ä¹‹å‰å…ˆè°ˆä¸€ä¸‹ TLS å’Œ RBACï¼Œå› ä¸ºè¿™ä¸¤ä¸ªäº‹ä¸æ•´æ˜ç™½ä¸‹é¢çš„éƒ½ä¸ç”¨è°ˆï¼›</p>

<ul>
  <li>TLS ä½œç”¨</li>
</ul>

<p>ä¼—æ‰€å‘¨çŸ¥ TLS çš„ä½œç”¨å°±æ˜¯å¯¹é€šè®¯åŠ å¯†ï¼Œé˜²æ­¢ä¸­é—´äººçªƒå¬ï¼›åŒæ—¶å¦‚æœè¯ä¹¦ä¸ä¿¡ä»»çš„è¯æ ¹æœ¬å°±æ— æ³•ä¸ apiserver å»ºç«‹è¿æ¥ï¼Œæ›´ä¸ç”¨ææœ‰æ²¡æœ‰æƒé™å‘ apiserver è¯·æ±‚æŒ‡å®šå†…å®¹</p>

<ul>
  <li>RBAC ä½œç”¨</li>
</ul>

<p>å½“ TLS è§£å†³äº†é€šè®¯é—®é¢˜åï¼Œé‚£ä¹ˆæƒé™é—®é¢˜å°±åº”ç”± RBAC è§£å†³(å¯ä»¥ä½¿ç”¨å…¶ä»–æƒé™æ¨¡å‹ï¼Œå¦‚ ABAC)ï¼›RBAC ä¸­è§„å®šäº†ä¸€ä¸ªç”¨æˆ·æˆ–è€…ç”¨æˆ·ç»„(subject)å…·æœ‰è¯·æ±‚å“ªäº› api çš„æƒé™ï¼›<strong>åœ¨é…åˆ TLS åŠ å¯†çš„æ—¶å€™ï¼Œå®é™…ä¸Š apiserver è¯»å–å®¢æˆ·ç«¯è¯ä¹¦çš„ CN å­—æ®µä½œä¸ºç”¨æˆ·åï¼Œè¯»å– O å­—æ®µä½œä¸ºç”¨æˆ·ç»„</strong></p>

<p>ä»ä»¥ä¸Šä¸¤ç‚¹ä¸Šå¯ä»¥æ€»ç»“å‡ºä¸¤ç‚¹: ç¬¬ä¸€ï¼Œæƒ³è¦ä¸ apiserver é€šè®¯å°±å¿…é¡»é‡‡ç”¨ç”± apiserver CA ç­¾å‘çš„è¯ä¹¦ï¼Œè¿™æ ·æ‰èƒ½å½¢æˆä¿¡ä»»å…³ç³»ï¼Œå»ºç«‹ TLS è¿æ¥ï¼›ç¬¬äºŒï¼Œå¯ä»¥é€šè¿‡è¯ä¹¦çš„ CNã€O å­—æ®µæ¥æä¾› RBAC æ‰€éœ€çš„ç”¨æˆ·ä¸ç”¨æˆ·ç»„</p>

<h4 id="32kubelet-é¦–æ¬¡å¯åŠ¨æµç¨‹">3.2ã€kubelet é¦–æ¬¡å¯åŠ¨æµç¨‹</h4>

<p>çœ‹å®Œä¸Šé¢çš„ä»‹ç»ï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰äººæƒ³è¿‡ï¼Œæ—¢ç„¶ TLS bootstrapping åŠŸèƒ½æ˜¯è®© kubelet ç»„ä»¶å» apiserver ç”³è¯·è¯ä¹¦ï¼Œç„¶åç”¨äºè¿æ¥ apiserverï¼›<strong>é‚£ä¹ˆç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶æ²¡æœ‰è¯ä¹¦å¦‚ä½•è¿æ¥ apiserver ?</strong></p>

<p>è¿™ä¸ªé—®é¢˜å®é™…ä¸Šå¯ä»¥å»æŸ¥çœ‹ä¸€ä¸‹ <code class="highlighter-rouge">bootstrap.kubeconfig</code> å’Œ <code class="highlighter-rouge">token.csv</code> å¾—åˆ°ç­”æ¡ˆ: <strong>åœ¨ apiserver é…ç½®ä¸­æŒ‡å®šäº†ä¸€ä¸ª <code class="highlighter-rouge">token.csv</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸­æ˜¯ä¸€ä¸ªé¢„è®¾çš„ç”¨æˆ·é…ç½®ï¼›åŒæ—¶è¯¥ç”¨æˆ·çš„ Token å’Œ apiserver çš„ CA è¯ä¹¦è¢«å†™å…¥äº† kubelet æ‰€ä½¿ç”¨çš„ <code class="highlighter-rouge">bootstrap.kubeconfig</code> é…ç½®æ–‡ä»¶ä¸­ï¼›è¿™æ ·åœ¨é¦–æ¬¡è¯·æ±‚æ—¶ï¼Œkubelet ä½¿ç”¨ <code class="highlighter-rouge">bootstrap.kubeconfig</code> ä¸­çš„ apiserver CA è¯ä¹¦æ¥ä¸ apiserver å»ºç«‹ TLS é€šè®¯ï¼Œä½¿ç”¨ <code class="highlighter-rouge">bootstrap.kubeconfig</code> ä¸­çš„ç”¨æˆ· Token æ¥å‘ apiserver å£°æ˜è‡ªå·±çš„ RBAC æˆæƒèº«ä»½</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>

<p><img src="https://cdn.oss.link/markdown/ji5ug.png" alt="first_request" /></p>

<p>åœ¨æœ‰äº›ç”¨æˆ·é¦–æ¬¡å¯åŠ¨æ—¶ï¼Œå¯èƒ½ä¸é‡åˆ° kubelet æŠ¥ 401 æ— æƒè®¿é—® apiserver çš„é”™è¯¯ï¼›<strong>è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œkubelet é€šè¿‡ <code class="highlighter-rouge">bootstrap.kubeconfig</code> ä¸­çš„é¢„è®¾ç”¨æˆ· Token å£°æ˜äº†è‡ªå·±çš„èº«ä»½ï¼Œç„¶ååˆ›å»º CSR è¯·æ±‚ï¼›ä½†æ˜¯ä¸è¦å¿˜è®°è¿™ä¸ªç”¨æˆ·åœ¨æˆ‘ä»¬ä¸å¤„ç†çš„æƒ…å†µä¸‹ä»–æ²¡ä»»ä½•æƒé™çš„ï¼ŒåŒ…æ‹¬åˆ›å»º CSR è¯·æ±‚ï¼›æ‰€ä»¥éœ€è¦å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª ClusterRoleBindingï¼Œå°†é¢„è®¾ç”¨æˆ· <code class="highlighter-rouge">kubelet-bootstrap</code> ä¸å†…ç½®çš„ ClusterRole <code class="highlighter-rouge">system:node-bootstrapper</code> ç»‘å®šåˆ°ä¸€èµ·ï¼Œä½¿å…¶èƒ½å¤Ÿå‘èµ· CSR è¯·æ±‚</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding kubelet-bootstrap <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>kubelet-bootstrap
</code></pre></div></div>

<h4 id="33æ‰‹åŠ¨ç­¾å‘è¯ä¹¦">3.3ã€æ‰‹åŠ¨ç­¾å‘è¯ä¹¦</h4>

<p>åœ¨ kubelet é¦–æ¬¡å¯åŠ¨åï¼Œå¦‚æœç”¨æˆ· Token æ²¡é—®é¢˜ï¼Œå¹¶ä¸” RBAC ä¹Ÿåšäº†ç›¸åº”çš„è®¾ç½®ï¼Œé‚£ä¹ˆæ­¤æ—¶åœ¨é›†ç¾¤å†…åº”è¯¥èƒ½çœ‹åˆ° kubelet å‘èµ·çš„ CSR è¯·æ±‚</p>

<p><img src="https://cdn.oss.link/markdown/n9bbw.png" alt="bootstrap_csr" /></p>

<p>å‡ºç° CSR è¯·æ±‚åï¼Œå¯ä»¥ä½¿ç”¨ kubectl æ‰‹åŠ¨ç­¾å‘(å…è®¸) kubelet çš„è¯ä¹¦</p>

<p><img src="https://cdn.oss.link/markdown/5ssf8.png" alt="bootstrap_approve_crt" /></p>

<p><strong>å½“æˆåŠŸç­¾å‘è¯ä¹¦åï¼Œç›®æ ‡èŠ‚ç‚¹çš„ kubelet ä¼šå°†è¯ä¹¦å†™å…¥åˆ° <code class="highlighter-rouge">--cert-dir=</code> é€‰é¡¹æŒ‡å®šçš„ç›®å½•ä¸­ï¼›æ³¨æ„æ­¤æ—¶å¦‚æœä¸åšå…¶ä»–è®¾ç½®åº”å½“ç”Ÿæˆå››ä¸ªæ–‡ä»¶</strong></p>

<p><img src="https://cdn.oss.link/markdown/a25ip.png" alt="bootstrap_crt" /></p>

<p><strong>è€Œ kubelet ä¸ apiserver é€šè®¯æ‰€ä½¿ç”¨çš„è¯ä¹¦ä¸º <code class="highlighter-rouge">kubelet-client.crt</code>ï¼Œå‰©ä¸‹çš„ <code class="highlighter-rouge">kubelet.crt</code> å°†ä¼šè¢«ç”¨äº <code class="highlighter-rouge">kubelet server</code>(10250) åšé‰´æƒä½¿ç”¨ï¼›æ³¨æ„ï¼Œæ­¤æ—¶ <code class="highlighter-rouge">kubelet.crt</code> è¿™ä¸ªè¯ä¹¦æ˜¯ä¸ªç‹¬ç«‹äº apiserver CA çš„è‡ªç­¾ CAï¼Œå¹¶ä¸”åˆ é™¤å kubelet ç»„ä»¶ä¼šé‡æ–°ç”Ÿæˆå®ƒ</strong></p>

<h3 id="å››tls-bootstrapping-è¯ä¹¦è‡ªåŠ¨ç»­æœŸ">å››ã€TLS bootstrapping è¯ä¹¦è‡ªåŠ¨ç»­æœŸ</h3>

<blockquote>
  <p>å•ç‹¬æŠŠè¿™éƒ¨åˆ†æ‹¿å‡ºæ¥å†™ï¼Œæ˜¯å› ä¸ºä¸ªäººè§‰å¾—ä¸Šé¢å·²ç»æœ‰ç‚¹ä¹±äº†ï¼›è¿™éƒ¨åˆ†å®é™…ä¸Šæ›´å¤æ‚ï¼Œåªå¥½å•ç‹¬å†™ä¸€ä¸‹äº†ï¼Œå› ä¸ºè¿™éƒ¨åˆ†æ¶‰åŠçš„ä¸œè¥¿æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä¹Ÿä¸æƒ³è‰ç‡çš„å‡ ç¬”å¸¦è¿‡</p>
</blockquote>

<h4 id="41rbac-æˆæƒ">4.1ã€RBAC æˆæƒ</h4>

<p>é¦–å…ˆâ€¦é¦–å…ˆå¥½å‡ æ¬¡äº†â€¦å—¯ï¼Œå°±æ˜¯è¯´ kubelet æ‰€å‘èµ·çš„ CSR è¯·æ±‚æ˜¯ç”± controller manager ç­¾ç½²çš„ï¼›å¦‚æœæƒ³è¦æ˜¯å®ç°è‡ªåŠ¨ç»­æœŸï¼Œå°±éœ€è¦è®© controller manager èƒ½å¤Ÿåœ¨ kubelet å‘èµ·è¯ä¹¦è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨å¸®åŠ©å…¶ç­¾ç½²è¯ä¹¦ï¼›é‚£ä¹ˆ controller manager ä¸å¯èƒ½å¯¹æ‰€æœ‰çš„ CSR è¯ä¹¦ç”³è¯·éƒ½è‡ªåŠ¨ç­¾ç½²ï¼Œè¿™æ—¶å€™å°±éœ€è¦é…ç½® RBAC è§„åˆ™ï¼Œ<strong>ä¿è¯ controller manager åªå¯¹ kubelet å‘èµ·çš„ç‰¹å®š CSR è¯·æ±‚è‡ªåŠ¨æ‰¹å‡†å³å¯</strong>ï¼›åœ¨ TLS bootstrapping å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œé’ˆå¯¹ä¸Šé¢ 2.2 ç« èŠ‚æå‡ºçš„ 3 ç§ CSR è¯·æ±‚åˆ†åˆ«ç»™å‡ºäº† 3 ç§å¯¹åº”çš„ ClusterRoleï¼Œå¦‚ä¸‹æ‰€ç¤º</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A ClusterRole which instructs the CSR approver to approve a user requesting</span>
<span class="c1"># node client credentials.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">approve-node-client-csr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/nodeclient"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="c1"># A ClusterRole which instructs the CSR approver to approve a node renewing its</span>
<span class="c1"># own client credentials.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">approve-node-client-renewal-csr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeclient"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="c1"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span>
<span class="c1"># serving cert matching its client cert.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">approve-node-server-renewal-csr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeserver"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
</code></pre></div></div>

<p>RBAC ä¸­ ClusterRole åªæ˜¯æè¿°æˆ–è€…è¯´å®šä¹‰ä¸€ç§é›†ç¾¤èŒƒå›´å†…çš„èƒ½åŠ›ï¼Œè¿™ä¸‰ä¸ª ClusterRole åœ¨ 1.7 ä¹‹å‰éœ€è¦è‡ªå·±æ‰‹åŠ¨åˆ›å»ºï¼Œåœ¨ 1.8 å apiserver ä¼šè‡ªåŠ¨åˆ›å»ºå‰ä¸¤ä¸ª(1.8 ä»¥ååç§°æœ‰æ”¹å˜ï¼Œè‡ªå·±æŸ¥çœ‹æ–‡æ¡£)ï¼›ä»¥ä¸Šä¸‰ä¸ª ClusterRole å«ä¹‰å¦‚ä¸‹</p>

<ul>
  <li>approve-node-client-csr: å…·æœ‰è‡ªåŠ¨æ‰¹å‡† nodeclient ç±»å‹ CSR è¯·æ±‚çš„èƒ½åŠ›</li>
  <li>approve-node-client-renewal-csr: å…·æœ‰è‡ªåŠ¨æ‰¹å‡† selfnodeclient ç±»å‹ CSR è¯·æ±‚çš„èƒ½åŠ›</li>
  <li>approve-node-server-renewal-csr: å…·æœ‰è‡ªåŠ¨æ‰¹å‡† selfnodeserver ç±»å‹ CSR è¯·æ±‚çš„èƒ½åŠ›</li>
</ul>

<p><strong>æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦ kubelet èƒ½å¤Ÿè‡ªåŠ¨ç»­æœŸï¼Œé‚£ä¹ˆå°±åº”å½“å°†é€‚å½“çš„ ClusterRole ç»‘å®šåˆ° kubelet è‡ªåŠ¨ç»­æœŸæ—¶æ‰€æ‰€é‡‡ç”¨çš„ç”¨æˆ·æˆ–è€…ç”¨æˆ·ç»„èº«ä¸Š</strong></p>

<h4 id="42è‡ªåŠ¨ç»­æœŸä¸‹çš„å¼•å¯¼è¿‡ç¨‹">4.2ã€è‡ªåŠ¨ç»­æœŸä¸‹çš„å¼•å¯¼è¿‡ç¨‹</h4>

<p>åœ¨è‡ªåŠ¨ç»­æœŸä¸‹å¼•å¯¼è¿‡ç¨‹ä¸å•çº¯çš„æ‰‹åŠ¨æ‰¹å‡† CSR æœ‰ç‚¹å·®å¼‚ï¼Œå…·ä½“çš„å¼•å¯¼æµç¨‹åœ°å€å¦‚ä¸‹</p>

<ul>
  <li>kubelet è¯»å– bootstrap.kubeconfigï¼Œä½¿ç”¨å…¶ CA ä¸ Token å‘ apiserver å‘èµ·ç¬¬ä¸€æ¬¡ CSR è¯·æ±‚(nodeclient)</li>
  <li>apiserver æ ¹æ® RBAC è§„åˆ™è‡ªåŠ¨æ‰¹å‡†é¦–æ¬¡ CSR è¯·æ±‚(approve-node-client-csr)ï¼Œå¹¶ä¸‹å‘è¯ä¹¦(kubelet-client.crt)</li>
  <li>kubelet <strong>ä½¿ç”¨åˆšåˆšç­¾å‘çš„è¯ä¹¦(O=system:nodes, CN=system:node:NODE_NAME)</strong>ä¸ apiserver é€šè®¯ï¼Œå¹¶å‘èµ·ç”³è¯· 10250 server æ‰€ä½¿ç”¨è¯ä¹¦çš„ CSR è¯·æ±‚</li>
  <li>apiserver æ ¹æ® RBAC è§„åˆ™è‡ªåŠ¨æ‰¹å‡† kubelet ä¸ºå…¶ 10250 ç«¯å£ç”³è¯·çš„è¯ä¹¦(kubelet-server-current.crt)</li>
  <li>è¯ä¹¦å³å°†åˆ°æœŸæ—¶ï¼Œkubelet è‡ªåŠ¨å‘ apiserver å‘èµ·ç”¨äºä¸ apiserver é€šè®¯æ‰€ç”¨è¯ä¹¦çš„ renew CSR è¯·æ±‚å’Œ renew æœ¬èº« 10250 ç«¯å£æ‰€ç”¨è¯ä¹¦çš„ CSR è¯·æ±‚</li>
  <li>apiserver æ ¹æ® RBAC è§„åˆ™è‡ªåŠ¨æ‰¹å‡†ä¸¤ä¸ªè¯ä¹¦</li>
  <li>kubelet æ‹¿åˆ°æ–°è¯ä¹¦åå…³é—­æ‰€æœ‰è¿æ¥ï¼Œreload æ–°è¯ä¹¦ï¼Œä»¥åä¾¿ä¸€ç›´å¦‚æ­¤</li>
</ul>

<p><strong>ä»ä»¥ä¸Šæµç¨‹æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬å¦‚æœè¦åˆ›å»º RBAC è§„åˆ™ï¼Œåˆ™è‡³å°‘èƒ½æ»¡è¶³å››ç§æƒ…å†µ:</strong></p>

<ul>
  <li>è‡ªåŠ¨æ‰¹å‡† kubelet é¦–æ¬¡ç”¨äºä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚(nodeclient)</li>
  <li>è‡ªåŠ¨æ‰¹å‡† kubelet é¦–æ¬¡ç”¨äº 10250 ç«¯å£é‰´æƒçš„ CSR è¯·æ±‚(å®é™…ä¸Šè¿™ä¸ªè¯·æ±‚èµ°çš„ä¹Ÿæ˜¯ selfnodeserver ç±»å‹ CSR)</li>
  <li>è‡ªåŠ¨æ‰¹å‡† kubelet åç»­ renew ç”¨äºä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚(selfnodeclient)</li>
  <li>è‡ªåŠ¨æ‰¹å‡† kubelet åç»­ renew ç”¨äº 10250 ç«¯å£é‰´æƒçš„ CSR è¯·æ±‚(selfnodeserver)</li>
</ul>

<p>åŸºäºä»¥ä¸Šå››ç§æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º 3 ä¸ª ClusterRoleBindingï¼Œåˆ›å»ºå¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è‡ªåŠ¨æ‰¹å‡† kubelet çš„é¦–æ¬¡ CSR è¯·æ±‚(ç”¨äºä¸ apiserver é€šè®¯çš„è¯ä¹¦)</span>
kubectl create clusterrolebinding node-client-auto-approve-csr <span class="nt">--clusterrole</span><span class="o">=</span>approve-node-client-csr <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† kubelet åç»­ renew ç”¨äºä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>approve-node-client-renewal-csr <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># è‡ªåŠ¨æ‰¹å‡† kubelet å‘èµ·çš„ç”¨äº 10250 ç«¯å£é‰´æƒè¯ä¹¦çš„ CSR è¯·æ±‚(åŒ…æ‹¬åç»­ renew)</span>
kubectl create clusterrolebinding node-server-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>approve-node-server-renewal-csr <span class="nt">--group</span><span class="o">=</span>system:nodes
</code></pre></div></div>

<h4 id="43å¼€å¯è‡ªåŠ¨ç»­æœŸ">4.3ã€å¼€å¯è‡ªåŠ¨ç»­æœŸ</h4>

<p>åœ¨ 1.7 åï¼Œkubelet å¯åŠ¨æ—¶å¢åŠ  <code class="highlighter-rouge">--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true</code> é€‰é¡¹ï¼Œåˆ™ kubelet åœ¨è¯ä¹¦å³å°†åˆ°æœŸæ—¶ä¼šè‡ªåŠ¨å‘èµ·ä¸€ä¸ª renew è‡ªå·±è¯ä¹¦çš„ CSR è¯·æ±‚ï¼›åŒæ—¶ controller manager éœ€è¦åœ¨å¯åŠ¨æ—¶å¢åŠ  <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> å‚æ•°ï¼Œå†é…åˆä¸Šé¢åˆ›å»ºå¥½çš„ ClusterRoleBindingï¼Œkubelet client å’Œ kubelet server è¯æ‰ä¹¦ä¼šè¢«è‡ªåŠ¨ç­¾ç½²ï¼›</p>

<p><strong>æ³¨æ„ï¼Œ1.7 ç‰ˆæœ¬è®¾ç½®è‡ªåŠ¨ç»­æœŸå‚æ•°åï¼Œæ–°çš„ renew è¯·æ±‚ä¸ä¼šç«‹å³å¼€å§‹ï¼Œè€Œæ˜¯åœ¨è¯ä¹¦æ€»æœ‰æ•ˆæœŸçš„ <code class="highlighter-rouge">70%~90%</code> çš„æ—¶é—´æ—¶å‘èµ·ï¼›è€Œä¸”ç»æµ‹è¯• 1.7 ç‰ˆæœ¬å³ä½¿è‡ªåŠ¨ç­¾å‘äº†è¯ä¹¦ï¼Œkubelet åœ¨ä¸é‡å¯çš„æƒ…å†µä¸‹ä¸ä¼šé‡æ–°åº”ç”¨æ–°è¯ä¹¦ï¼›åœ¨ 1.8 å kubelet ç»„ä»¶åœ¨å¢åŠ ä¸€ä¸ª <code class="highlighter-rouge">--rotate-certificates</code> å‚æ•°åï¼Œkubelet æ‰ä¼šè‡ªåŠ¨é‡è½½æ–°è¯ä¹¦</strong></p>

<h4 id="43è¯ä¹¦è¿‡æœŸé—®é¢˜">4.3ã€è¯ä¹¦è¿‡æœŸé—®é¢˜</h4>

<p>éœ€è¦é‡å¤å¼ºè°ƒä¸€ä¸ªé—®é¢˜æ˜¯: <strong>TLS bootstrapping æ—¶çš„è¯ä¹¦å®é™…æ˜¯ç”± kube-controller-manager ç»„ä»¶æ¥ç­¾ç½²çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¯ä¹¦æœ‰æ•ˆæœŸæ˜¯ kube-controller-manager ç»„ä»¶æ§åˆ¶çš„</strong>ï¼›æ‰€ä»¥åœ¨ 1.7 ç‰ˆæœ¬ä»¥å(æˆ‘æŸ¥æ–‡æ¡£å‘ç°çš„ä»1.7å¼€å§‹æœ‰) kube-controller-manager ç»„ä»¶æä¾›äº†ä¸€ä¸ª <code class="highlighter-rouge">--experimental-cluster-signing-duration</code> å‚æ•°æ¥è®¾ç½®ç­¾ç½²çš„è¯ä¹¦æœ‰æ•ˆæ—¶é—´ï¼›é»˜è®¤ä¸º <code class="highlighter-rouge">8760h0m0s</code>ï¼Œå°†å…¶æ”¹ä¸º <code class="highlighter-rouge">87600h0m0s</code> å³ 10 å¹´åå†è¿›è¡Œ TLS bootstrapping ç­¾ç½²è¯ä¹¦å³å¯ã€‚</p>

<h3 id="äº”tls-bootstrapping-æ€»ç»“ä»¥åŠè¯¦ç»†æ“ä½œ">äº”ã€TLS bootstrapping æ€»ç»“ä»¥åŠè¯¦ç»†æ“ä½œ</h3>

<h4 id="51ä¸»è¦æµç¨‹ç»†èŠ‚">5.1ã€ä¸»è¦æµç¨‹ç»†èŠ‚</h4>

<p>kubelet é¦–æ¬¡å¯åŠ¨é€šè¿‡åŠ è½½ <code class="highlighter-rouge">bootstrap.kubeconfig</code> ä¸­çš„ç”¨æˆ· Token å’Œ apiserver CA è¯ä¹¦å‘èµ·é¦–æ¬¡ CSR è¯·æ±‚ï¼Œè¿™ä¸ª Token è¢«é¢„å…ˆå†…ç½®åœ¨ apiserver èŠ‚ç‚¹çš„ token.csv ä¸­ï¼Œå…¶èº«ä»½ä¸º <code class="highlighter-rouge">kubelet-bootstrap</code> ç”¨æˆ·å’Œ <code class="highlighter-rouge">system:bootstrappers</code> ç”¨æˆ·ç»„ï¼›æƒ³è¦é¦–æ¬¡ CSR è¯·æ±‚èƒ½æˆåŠŸ(æˆåŠŸæŒ‡çš„æ˜¯ä¸ä¼šè¢« apiserver 401 æ‹’ç»)ï¼Œåˆ™éœ€è¦å…ˆå°† <code class="highlighter-rouge">kubelet-bootstrap</code> ç”¨æˆ·å’Œ <code class="highlighter-rouge">system:node-bootstrapper</code> å†…ç½® ClusterRole ç»‘å®šï¼›</p>

<p>å¯¹äºé¦–æ¬¡ CSR è¯·æ±‚å¯ä»¥æ‰‹åŠ¨æ‰¹å‡†ï¼Œä¹Ÿå¯ä»¥å°† <code class="highlighter-rouge">system:bootstrappers</code> ç”¨æˆ·ç»„ä¸ <code class="highlighter-rouge">approve-node-client-csr</code> ClusterRole ç»‘å®šå®ç°è‡ªåŠ¨æ‰¹å‡†(1.8 ä¹‹å‰è¿™ä¸ª ClusterRole éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œ1.8 å apiserver è‡ªåŠ¨åˆ›å»ºï¼Œå¹¶æ›´åä¸º <code class="highlighter-rouge">system:certificates.k8s.io:certificatesigningrequests:nodeclient</code>)</p>

<p>é»˜è®¤ç­¾ç½²çš„çš„è¯ä¹¦åªæœ‰ 1 å¹´æœ‰æ•ˆæœŸï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è¯ä¹¦æœ‰æ•ˆæœŸå¯ä»¥é€šè¿‡è®¾ç½® kube-controller-manager çš„ <code class="highlighter-rouge">--experimental-cluster-signing-duration</code> å‚æ•°å®ç°ï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º <code class="highlighter-rouge">8760h0m0s</code></p>

<p>å¯¹äºè¯ä¹¦è‡ªåŠ¨ç»­ç­¾ï¼Œéœ€è¦é€šè¿‡åè°ƒä¸¤ä¸ªæ–¹é¢å®ç°ï¼›ç¬¬ä¸€ï¼Œæƒ³è¦ kubelet åœ¨è¯ä¹¦åˆ°æœŸåè‡ªåŠ¨å‘èµ·ç»­æœŸè¯·æ±‚ï¼Œåˆ™éœ€è¦åœ¨ kubelet å¯åŠ¨æ—¶å¢åŠ  <code class="highlighter-rouge">--feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true</code> æ¥å®ç°ï¼›ç¬¬äºŒï¼Œæƒ³è¦è®© controller manager è‡ªåŠ¨æ‰¹å‡†ç»­ç­¾çš„ CSR è¯·æ±‚éœ€è¦åœ¨ controller manager å¯åŠ¨æ—¶å¢åŠ  <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> å‚æ•°ï¼Œå¹¶ç»‘å®šå¯¹åº”çš„ RBAC è§„åˆ™ï¼›<strong>åŒæ—¶éœ€è¦æ³¨æ„çš„æ˜¯ 1.7 ç‰ˆæœ¬çš„ kubelet è‡ªåŠ¨ç»­ç­¾åéœ€è¦æ‰‹åŠ¨é‡å¯ kubelet ä»¥ä½¿å…¶é‡æ–°åŠ è½½æ–°è¯ä¹¦ï¼Œè€Œ 1.8 ååªéœ€è¦åœ¨ kublet å¯åŠ¨æ—¶é™„å¸¦ <code class="highlighter-rouge">--rotate-certificates</code> é€‰é¡¹å°±ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½æ–°è¯ä¹¦</strong></p>

<h4 id="52è¯ä¹¦åŠé…ç½®æ–‡ä»¶ä½œç”¨">5.2ã€è¯ä¹¦åŠé…ç½®æ–‡ä»¶ä½œç”¨</h4>

<ul>
  <li>token.csv</li>
</ul>

<p>è¯¥æ–‡ä»¶ä¸ºä¸€ä¸ªç”¨æˆ·çš„æè¿°æ–‡ä»¶ï¼ŒåŸºæœ¬æ ¼å¼ä¸º <code class="highlighter-rouge">Token,ç”¨æˆ·å,UID,ç”¨æˆ·ç»„</code>ï¼›è¿™ä¸ªæ–‡ä»¶åœ¨ apiserver å¯åŠ¨æ—¶è¢« apiserver åŠ è½½ï¼Œç„¶åå°±ç›¸å½“äºåœ¨é›†ç¾¤å†…åˆ›å»ºäº†ä¸€ä¸ªè¿™ä¸ªç”¨æˆ·ï¼›æ¥ä¸‹æ¥å°±å¯ä»¥ç”¨ RBAC ç»™ä»–æˆæƒï¼›æŒæœ‰è¿™ä¸ªç”¨æˆ· Token çš„ç»„ä»¶è®¿é—® apiserver çš„æ—¶å€™ï¼Œapiserver æ ¹æ® RBAC å®šä¹‰çš„è¯¥ç”¨æˆ·åº”å½“å…·æœ‰çš„æƒé™æ¥å¤„ç†ç›¸åº”è¯·æ±‚</p>

<ul>
  <li>bootstarp.kubeconfig</li>
</ul>

<p>è¯¥æ–‡ä»¶ä¸­å†…ç½®äº† token.csv ä¸­ç”¨æˆ·çš„ Tokenï¼Œä»¥åŠ apiserver CA è¯ä¹¦ï¼›kubelet é¦–æ¬¡å¯åŠ¨ä¼šåŠ è½½æ­¤æ–‡ä»¶ï¼Œä½¿ç”¨ apiserver CA è¯ä¹¦å»ºç«‹ä¸ apiserver çš„ TLS é€šè®¯ï¼Œä½¿ç”¨å…¶ä¸­çš„ç”¨æˆ· Token ä½œä¸ºèº«ä»½æ ‡è¯†åƒ apiserver å‘èµ· CSR è¯·æ±‚</p>

<ul>
  <li>kubelet-client.crt</li>
</ul>

<p>è¯¥æ–‡ä»¶åœ¨ kubelet å®Œæˆ TLS bootstrapping åç”Ÿæˆï¼Œæ­¤è¯ä¹¦æ˜¯ç”± controller manager ç­¾ç½²çš„ï¼Œæ­¤å kubelet å°†ä¼šåŠ è½½è¯¥è¯ä¹¦ï¼Œç”¨äºä¸ apiserver å»ºç«‹ TLS é€šè®¯ï¼ŒåŒæ—¶ä½¿ç”¨è¯¥è¯ä¹¦çš„ CN å­—æ®µä½œä¸ºç”¨æˆ·åï¼ŒO å­—æ®µä½œä¸ºç”¨æˆ·ç»„å‘ apiserver å‘èµ·å…¶ä»–è¯·æ±‚</p>

<ul>
  <li>kubelet.crt</li>
</ul>

<p>è¯¥æ–‡ä»¶åœ¨ kubelet å®Œæˆ TLS bootstrapping åå¹¶ä¸”<strong>æ²¡æœ‰é…ç½® <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> æ—¶æ‰ä¼šç”Ÿæˆ</strong>ï¼›è¿™ç§æƒ…å†µä¸‹è¯¥æ–‡ä»¶ä¸ºä¸€ä¸ªç‹¬ç«‹äº apiserver CA çš„è‡ªç­¾ CA è¯ä¹¦ï¼Œæœ‰æ•ˆæœŸä¸º 1 å¹´ï¼›è¢«ç”¨ä½œ kubelet 10250 api ç«¯å£</p>

<ul>
  <li>kubelet-server.crt</li>
</ul>

<p>è¯¥æ–‡ä»¶åœ¨ kubelet å®Œæˆ TLS bootstrapping åå¹¶ä¸”<strong>é…ç½®äº† <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> æ—¶æ‰ä¼šç”Ÿæˆ</strong>ï¼›è¿™ç§æƒ…å†µä¸‹è¯¥è¯ä¹¦ç”± apiserver CA ç­¾ç½²ï¼Œé»˜è®¤æœ‰æ•ˆæœŸåŒæ ·æ˜¯ 1 å¹´ï¼Œè¢«ç”¨ä½œ kubelet 10250 api ç«¯å£é‰´æƒ</p>

<ul>
  <li>kubelet-client-current.pem</li>
</ul>

<p>è¿™æ˜¯ä¸€ä¸ªè½¯è¿æ¥æ–‡ä»¶ï¼Œå½“ kubelet é…ç½®äº† <code class="highlighter-rouge">--feature-gates=RotateKubeletClientCertificate=true</code> é€‰é¡¹åï¼Œä¼šåœ¨è¯ä¹¦æ€»æœ‰æ•ˆæœŸçš„ <code class="highlighter-rouge">70%~90%</code> çš„æ—¶é—´å†…å‘èµ·ç»­æœŸè¯·æ±‚ï¼Œè¯·æ±‚è¢«æ‰¹å‡†åä¼šç”Ÿæˆä¸€ä¸ª <code class="highlighter-rouge">kubelet-client-æ—¶é—´æˆ³.pem</code>ï¼›<code class="highlighter-rouge">kubelet-client-current.pem</code> æ–‡ä»¶åˆ™å§‹ç»ˆè½¯è¿æ¥åˆ°æœ€æ–°çš„çœŸå®è¯ä¹¦æ–‡ä»¶ï¼Œé™¤é¦–æ¬¡å¯åŠ¨å¤–ï¼Œkubelet ä¸€ç›´ä¼šä½¿ç”¨è¿™ä¸ªè¯ä¹¦åŒ  apiserver é€šè®¯</p>

<ul>
  <li>kubelet-server-current.pem</li>
</ul>

<p>åŒæ ·æ˜¯ä¸€ä¸ªè½¯è¿æ¥æ–‡ä»¶ï¼Œå½“ kubelet é…ç½®äº† <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> é€‰é¡¹åï¼Œä¼šåœ¨è¯ä¹¦æ€»æœ‰æ•ˆæœŸçš„ <code class="highlighter-rouge">70%~90%</code> çš„æ—¶é—´å†…å‘èµ·ç»­æœŸè¯·æ±‚ï¼Œè¯·æ±‚è¢«æ‰¹å‡†åä¼šç”Ÿæˆä¸€ä¸ª <code class="highlighter-rouge">kubelet-server-æ—¶é—´æˆ³.pem</code>ï¼›<code class="highlighter-rouge">kubelet-server-current.pem</code> æ–‡ä»¶åˆ™å§‹ç»ˆè½¯è¿æ¥åˆ°æœ€æ–°çš„çœŸå®è¯ä¹¦æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†ä¼šä¸€ç›´è¢«ç”¨äº kubelet 10250 api ç«¯å£é‰´æƒ</p>

<h4 id="5317-tls-bootstrapping-é…ç½®">5.3ã€1.7 TLS bootstrapping é…ç½®</h4>

<p>apiserver é¢„å…ˆæ”¾ç½® token.csvï¼Œå†…å®¹æ ·ä¾‹å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6df3c701f979cee17732c30958745947,kubelet-bootstrap,10001,<span class="s2">"system:bootstrappers"</span>
</code></pre></div></div>

<p>å…è®¸ kubelet-bootstrap ç”¨æˆ·åˆ›å»ºé¦–æ¬¡å¯åŠ¨çš„ CSR è¯·æ±‚</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding kubelet-bootstrap <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>kubelet-bootstrap
</code></pre></div></div>

<p>é…ç½® kubelet è‡ªåŠ¨ç»­æœŸï¼Œ<strong>RotateKubeletClientCertificate ç”¨äºè‡ªåŠ¨ç»­æœŸ kubelet è¿æ¥ apiserver æ‰€ç”¨çš„è¯ä¹¦(kubelet-client-xxxx.pem)ï¼ŒRotateKubeletServerCertificate ç”¨äºè‡ªåŠ¨ç»­æœŸ kubelet 10250 api ç«¯å£æ‰€ä½¿ç”¨çš„è¯ä¹¦(kubelet-server-xxxx.pem)</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"--cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
              --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
              --resolv-conf=/etc/resolv.conf </span><span class="se">\</span><span class="s2">
              --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
              --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
              --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
              --fail-swap-on=false </span><span class="se">\</span><span class="s2">
              --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
              --cluster-domain=cluster.local. </span><span class="se">\</span><span class="s2">
              --hairpin-mode=promiscuous-bridge </span><span class="se">\</span><span class="s2">
              --serialize-image-pulls=false </span><span class="se">\</span><span class="s2">
              --pod-infra-container-image=gcr.io/google_containers/pause-amd64:3.0"</span>
</code></pre></div></div>

<p>é…ç½® controller manager è‡ªåŠ¨æ‰¹å‡†ç›¸å…³ CSR è¯·æ±‚ï¼Œ<strong>å¦‚æœä¸é…ç½® <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> å‚æ•°ï¼Œåˆ™å³ä½¿é…ç½®äº†ç›¸å…³çš„ RBAC è§„åˆ™ï¼Œä¹Ÿåªä¼šè‡ªåŠ¨æ‰¹å‡† kubelet client çš„ renew è¯·æ±‚</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBE_CONTROLLER_MANAGER_ARGS</span><span class="o">=</span><span class="s2">"--address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                              --service-cluster-ip-range=10.254.0.0/16 </span><span class="se">\</span><span class="s2">
                              --feature-gates=RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
                              --cluster-name=kubernetes </span><span class="se">\</span><span class="s2">
                              --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                              --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                              --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                              --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                              --leader-elect=true </span><span class="se">\</span><span class="s2">
                              --node-monitor-grace-period=40s </span><span class="se">\</span><span class="s2">
                              --node-monitor-period=5s </span><span class="se">\</span><span class="s2">
                              --pod-eviction-timeout=5m0s"</span>
</code></pre></div></div>

<p>åˆ›å»ºè‡ªåŠ¨æ‰¹å‡†ç›¸å…³ CSR è¯·æ±‚çš„ ClusterRole</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A ClusterRole which instructs the CSR approver to approve a user requesting</span>
<span class="c1"># node client credentials.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">approve-node-client-csr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/nodeclient"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="c1"># A ClusterRole which instructs the CSR approver to approve a node renewing its</span>
<span class="c1"># own client credentials.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">approve-node-client-renewal-csr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeclient"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="c1"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span>
<span class="c1"># serving cert matching its client cert.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">approve-node-server-renewal-csr</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeserver"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å°† ClusterRole ç»‘å®šåˆ°é€‚å½“çš„ç”¨æˆ·ç»„ï¼Œä»¥å®Œæˆè‡ªåŠ¨æ‰¹å‡†ç›¸å…³ CSR è¯·æ±‚</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-approve-csr <span class="nt">--clusterrole</span><span class="o">=</span>approve-node-client-csr <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>approve-node-client-renewal-csr <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-server-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>approve-node-server-renewal-csr <span class="nt">--group</span><span class="o">=</span>system:nodes
</code></pre></div></div>

<p><strong>ä¸€åˆ‡å°±ç»ªåå¯åŠ¨ kubelet ç»„ä»¶å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ 1.7 ç‰ˆæœ¬ kubelet ä¸ä¼šè‡ªåŠ¨é‡è½½ renew çš„è¯ä¹¦ï¼Œéœ€è¦è‡ªå·±æ‰‹åŠ¨é‡å¯</strong></p>

<h4 id="5418-tls-bootstrapping-é…ç½®">5.4ã€1.8 TLS bootstrapping é…ç½®</h4>

<p>apiserver é¢„å…ˆæ”¾ç½® token.csvï¼Œå†…å®¹æ ·ä¾‹å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>6df3c701f979cee17732c30958745947,kubelet-bootstrap,10001,<span class="s2">"system:bootstrappers"</span>
</code></pre></div></div>

<p>å…è®¸ kubelet-bootstrap ç”¨æˆ·åˆ›å»ºé¦–æ¬¡å¯åŠ¨çš„ CSR è¯·æ±‚</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding kubelet-bootstrap <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>kubelet-bootstrap
</code></pre></div></div>

<p>é…ç½® kubelet è‡ªåŠ¨ç»­æœŸï¼Œ<strong>RotateKubeletClientCertificate ç”¨äºè‡ªåŠ¨ç»­æœŸ kubelet è¿æ¥ apiserver æ‰€ç”¨çš„è¯ä¹¦(kubelet-client-xxxx.pem)ï¼ŒRotateKubeletServerCertificate ç”¨äºè‡ªåŠ¨ç»­æœŸ kubelet 10250 api ç«¯å£æ‰€ä½¿ç”¨çš„è¯ä¹¦(kubelet-server-xxxx.pem)ï¼Œ<code class="highlighter-rouge">--rotate-certificates</code> é€‰é¡¹ä½¿å¾— kubelet èƒ½å¤Ÿè‡ªåŠ¨é‡è½½æ–°è¯ä¹¦</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"--cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
              --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
              --resolv-conf=/etc/resolv.conf </span><span class="se">\</span><span class="s2">
              --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
              --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
              --rotate-certificates </span><span class="se">\</span><span class="s2">
              --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
              --fail-swap-on=false </span><span class="se">\</span><span class="s2">
              --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
              --cluster-domain=cluster.local. </span><span class="se">\</span><span class="s2">
              --hairpin-mode=promiscuous-bridge </span><span class="se">\</span><span class="s2">
              --serialize-image-pulls=false </span><span class="se">\</span><span class="s2">
              --pod-infra-container-image=gcr.io/google_containers/pause-amd64:3.0"</span>
</code></pre></div></div>

<p>é…ç½® controller manager è‡ªåŠ¨æ‰¹å‡†ç›¸å…³ CSR è¯·æ±‚ï¼Œ<strong>å¦‚æœä¸é…ç½® <code class="highlighter-rouge">--feature-gates=RotateKubeletServerCertificate=true</code> å‚æ•°ï¼Œåˆ™å³ä½¿é…ç½®äº†ç›¸å…³çš„ RBAC è§„åˆ™ï¼Œä¹Ÿåªä¼šè‡ªåŠ¨æ‰¹å‡† kubelet client çš„ renew è¯·æ±‚</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBE_CONTROLLER_MANAGER_ARGS</span><span class="o">=</span><span class="s2">"--address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                              --service-cluster-ip-range=10.254.0.0/16 </span><span class="se">\</span><span class="s2">
                              --cluster-name=kubernetes </span><span class="se">\</span><span class="s2">
                              --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                              --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                              --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                              --feature-gates=RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
                              --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                              --leader-elect=true </span><span class="se">\</span><span class="s2">
                              --experimental-cluster-signing-duration 10m0s </span><span class="se">\</span><span class="s2">
                              --node-monitor-grace-period=40s </span><span class="se">\</span><span class="s2">
                              --node-monitor-period=5s </span><span class="se">\</span><span class="s2">
                              --pod-eviction-timeout=5m0s"</span>
</code></pre></div></div>

<p>åˆ›å»ºè‡ªåŠ¨æ‰¹å‡†ç›¸å…³ CSR è¯·æ±‚çš„ ClusterRoleï¼Œç›¸å¯¹äº 1.7 ç‰ˆæœ¬ï¼Œ1.8 çš„ apiserver è‡ªåŠ¨åˆ›å»ºäº†å‰ä¸¤æ¡ ClusterRoleï¼Œæ‰€ä»¥åªéœ€è¦åˆ›å»ºä¸€æ¡å°±è¡Œäº†</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span>
<span class="c1"># serving cert matching its client cert.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeserver"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å°† ClusterRole ç»‘å®šåˆ°é€‚å½“çš„ç”¨æˆ·ç»„ï¼Œä»¥å®Œæˆè‡ªåŠ¨æ‰¹å‡†ç›¸å…³ CSR è¯·æ±‚</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-approve-csr <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-server-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeserver <span class="nt">--group</span><span class="o">=</span>system:nodes
</code></pre></div></div>

<p><strong>ä¸€åˆ‡å°±ç»ªåå¯åŠ¨ kubelet ç»„ä»¶å³å¯ï¼Œ1.8 ç‰ˆæœ¬ kubelet ä¼šè‡ªåŠ¨é‡è½½è¯ä¹¦ï¼Œä»¥ä¸‹ä¸º 1.8 ç‰ˆæœ¬åœ¨è¿è¡Œä¸€æ®µæ—¶é—´åçš„ç›¸å…³è¯ä¹¦æˆªå›¾</strong></p>

<p><img src="https://cdn.oss.link/markdown/570wk.png" alt="tls_bootstrapping_crts" /></p>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET