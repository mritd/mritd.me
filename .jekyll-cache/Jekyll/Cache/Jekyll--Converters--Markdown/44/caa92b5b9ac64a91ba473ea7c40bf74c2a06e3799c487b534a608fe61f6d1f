I"<blockquote>
  <p>æœ€è¿‘åœ¨å†™ä¸€ä¸ªè·³æ¿æœºç™»å½•çš„å°å·¥å…·ï¼Œå…¶ä¸­æ¶‰åŠåˆ°äº†ç”¨ Go æ¥è¿›è¡Œäº¤äº’å¼æ‰§è¡Œå‘½ä»¤ï¼Œç®€å•åœ°è¯´å°±æ˜¯å¼„ä¸ªç»ˆç«¯å‡ºæ¥ï¼›ä¸€å¼€å§‹éšä¾¿ Google äº†ä¸€ä¸‹ï¼Œcopy ä¸‹æ¥åŸºæœ¬ä¸Šå°±æ˜¯èƒ½è·‘äº†â€¦ä½†æ˜¯åæ¥å‘ç°äº†ä¸€äº›å„ç§å„æ ·çš„å°é—®é¢˜ï¼Œå¼ºè¿«ç—‡çš„æˆ‘å®åœ¨å—ä¸äº†ï¼Œæœ€åç¿»äº†ä¸€ä¸‹ Teleport çš„æºç ï¼Œä»ä¸­å­¦åˆ°äº†ä¸å°‘æœ‰ç”¨çš„çŸ¥è¯†ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹</p>
</blockquote>

<h2 id="ä¸€åŸå§‹ç‰ˆæœ¬">ä¸€ã€åŸå§‹ç‰ˆæœ¬</h2>

<blockquote>
  <p>ä¸æƒ³çœ‹å¤ªå¤šå¯ä»¥ç›´æ¥è·³è½¬åˆ° <a href="#ä¸‰å®Œæ•´ä»£ç ">ç¬¬ä¸‰éƒ¨åˆ†</a> æ‹¿ä»£ç </p>
</blockquote>

<h3 id="11æ ·ä¾‹ä»£ç ">1.1ã€æ ·ä¾‹ä»£ç </h3>

<p>ä¸€å¼€å§‹éšä¾¿ Google å‡ºæ¥çš„ä»£ç ï¼Œcopy ä¸Šå°±ç›´æ¥è·‘ï¼›ä»£ç åŸºæœ¬å¦‚ä¸‹:</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="c">// åˆ›å»º ssh é…ç½®</span>
	<span class="n">sshConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">ssh</span><span class="o">.</span><span class="n">ClientConfig</span><span class="p">{</span>
		<span class="n">User</span><span class="o">:</span> <span class="s">"root"</span><span class="p">,</span>
		<span class="n">Auth</span><span class="o">:</span> <span class="p">[]</span><span class="n">ssh</span><span class="o">.</span><span class="n">AuthMethod</span><span class="p">{</span>
			<span class="n">ssh</span><span class="o">.</span><span class="n">Password</span><span class="p">(</span><span class="s">"password"</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="n">HostKeyCallback</span><span class="o">:</span> <span class="n">ssh</span><span class="o">.</span><span class="n">InsecureIgnoreHostKey</span><span class="p">(),</span>
		<span class="n">Timeout</span><span class="o">:</span>         <span class="m">5</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c">// åˆ›å»º client</span>
	<span class="n">client</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="s">"192.168.1.20:22"</span><span class="p">,</span> <span class="n">sshConfig</span><span class="p">)</span>
	<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="k">defer</span> <span class="n">client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="c">// è·å– session</span>
	<span class="n">session</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">NewSession</span><span class="p">()</span>
	<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="k">defer</span> <span class="n">session</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="c">// æ‹¿åˆ°å½“å‰ç»ˆç«¯æ–‡ä»¶æè¿°ç¬¦</span>
	<span class="n">fd</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Fd</span><span class="p">())</span>
	<span class="n">termWidth</span><span class="p">,</span> <span class="n">termHeight</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GetSize</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

	<span class="c">// request pty</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">RequestPty</span><span class="p">(</span><span class="s">"xterm-256color"</span><span class="p">,</span> <span class="n">termHeight</span><span class="p">,</span> <span class="n">termWidth</span><span class="p">,</span> <span class="n">ssh</span><span class="o">.</span><span class="n">TerminalModes</span><span class="p">{})</span>
	<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

	<span class="c">// å¯¹æ¥ std</span>
	<span class="n">session</span><span class="o">.</span><span class="n">Stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stdout</span>
	<span class="n">session</span><span class="o">.</span><span class="n">Stderr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stderr</span>
	<span class="n">session</span><span class="o">.</span><span class="n">Stdin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stdin</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">Shell</span><span class="p">()</span>
	<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
	<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<span class="p">}</span>

<span class="k">func</span> <span class="n">checkErr</span><span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="12é‡åˆ°çš„é—®é¢˜">1.2ã€é‡åˆ°çš„é—®é¢˜</h3>

<p>ä»¥ä¸Šä»£ç è·‘èµ·æ¥åï¼ŒåŸºæœ¬ä¸Šé‡åˆ°äº†ä»¥ä¸‹é—®é¢˜:</p>

<ul>
  <li>æ‰§è¡Œå‘½ä»¤æœ‰å›æ˜¾ï¼Œè¡¨ç°ä¸ºæ•²ä¸€ä¸ª <code class="highlighter-rouge">ls</code> å‡ºç°ä¸¤è¡Œ</li>
  <li>æœ¬åœ°ç»ˆç«¯å¤§å°è°ƒæ•´ï¼Œè¿œç«¯å®Œå…¨æ— ååº”ï¼Œå¯¼è‡´æ˜¾ç¤ºä¸å…¨</li>
  <li>Tmux ä¸‹ç»ˆç«¯è¿æ¥åçª—å£æ ‡é¢˜æ˜¾ç¤ºçš„æ˜¯åŸå§‹å‘½ä»¤ï¼Œè€Œä¸æ˜¯ç›®æ ‡æœºå™¨ shell ç¯å¢ƒçš„ç›®å½•ä½ç½®</li>
  <li>é¦–æ¬¡è¿æ¥ä¸€äº›åˆšè£…å®Œç³»ç»Ÿçš„æœºå™¨å¯èƒ½å‡ºç°æ‰§è¡Œå‘½ä»¤åå›æ˜¾ä¸æ¢è¡Œ</li>
</ul>

<h2 id="äºŒæ”¹è¿›ä»£ç ">äºŒã€æ”¹è¿›ä»£ç </h2>

<h3 id="21å›æ˜¾é—®é¢˜">2.1ã€å›æ˜¾é—®é¢˜</h3>

<p>å…³äºå›æ˜¾é—®é¢˜ï¼Œå®é™…ä¸Šè§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼Œè®¾ç½®å½“å‰ç»ˆç«¯è¿›å…¥ <code class="highlighter-rouge">raw</code> æ¨¡å¼å³å¯ï¼›ä»£ç å¦‚ä¸‹:</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// æ‹¿åˆ°å½“å‰ç»ˆç«¯æ–‡ä»¶æè¿°ç¬¦</span>
<span class="n">fd</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Fd</span><span class="p">())</span>
<span class="c">// make raw</span>
<span class="n">state</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">MakeRaw</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="k">defer</span> <span class="n">terminal</span><span class="o">.</span><span class="n">Restore</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</code></pre></div></div>

<p>ä»£ç å¾ˆç®€å•ï¼Œç½‘ä¸Šä¸€å¤§å †ï¼ŒButâ€¦åŸºæœ¬æ²¡æœ‰æ–‡ç« è¯¦ç»†è¯´è¿™ä¸ª <code class="highlighter-rouge">raw</code> æ¨¡å¼åˆ°åº•æ˜¯ä¸ªå•¥ç©æ„ï¼›å¥½åœ¨ä¸‡èƒ½çš„ StackOverflow å¯¹äºä¸ç†Ÿæ‚‰ Linux çš„äººç»™å‡ºäº†ä¸€ä¸ªå¾ˆæ¸…æ™°çš„è§£é‡Š: <a href="https://unix.stackexchange.com/questions/21752/what-s-the-difference-between-a-raw-and-a-cooked-device-driver">Whatâ€™s the difference between a â€œrawâ€ and a â€œcookedâ€ device driver?</a></p>

<p>å¤§è‡´æ„æ€å°±æ˜¯è¯´ <strong>åœ¨ç»ˆç«¯å¤„äº <code class="highlighter-rouge">Cooked</code> æ¨¡å¼æ—¶ï¼Œå½“ä½ è¾“å…¥ä¸€äº›å­—ç¬¦åï¼Œé»˜è®¤æ˜¯è¢«å½“å‰ç»ˆç«¯ cache ä½çš„ï¼Œåœ¨ä½ æ•²äº†å›è½¦ä¹‹å‰è¿™äº›æ–‡æœ¬éƒ½åœ¨ cache ä¸­ï¼Œè¿™æ ·å…è®¸åº”ç”¨ç¨‹åºåšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚æ•è· <code class="highlighter-rouge">Cntl-D</code> ç­‰æŒ‰é”®ï¼Œè¿™æ—¶å€™å°±ä¼šå‡ºç°æ•²å›è½¦åæœ¬åœ°ç»ˆç«¯å¸®ä½ æ‰“å°äº†ä¸€ä¸‹ï¼Œå¯¼è‡´å‡ºç°ç±»ä¼¼å›æ˜¾çš„æ•ˆæœï¼›å½“è®¾ç½®ç»ˆç«¯ä¸º <code class="highlighter-rouge">raw</code> æ¨¡å¼åï¼Œæ‰€æœ‰çš„è¾“å…¥å°†ä¸è¢« cacheï¼Œè€Œæ˜¯å‘é€åˆ°åº”ç”¨ç¨‹åºï¼Œåœ¨æˆ‘ä»¬çš„ä»£ç ä¸­è¡¨ç°ä¸ºé€šè¿‡ <code class="highlighter-rouge">io.Copy</code> ç›´æ¥å‘é€åˆ°äº†è¿œç«¯ shell ç¨‹åº</strong></p>

<h3 id="22ç»ˆç«¯å¤§å°é—®é¢˜">2.2ã€ç»ˆç«¯å¤§å°é—®é¢˜</h3>

<p>å½“æœ¬åœ°è°ƒæ•´äº†ç»ˆç«¯å¤§å°åï¼Œè¿œç¨‹ç»ˆç«¯æ¯«æ— ååº”ï¼›åæ¥å‘ç°åœ¨ <code class="highlighter-rouge">*ssh.Session</code> ä¸Šæœ‰ä¸€ä¸ª <code class="highlighter-rouge">WindowChange</code> æ–¹æ³•ï¼Œç”¨äºå‘è¿œç«¯å‘é€çª—å£è°ƒæ•´äº‹ä»¶ï¼›è§£å†³æ–¹æ¡ˆå°±æ˜¯å¯åŠ¨ä¸€ä¸ª <code class="highlighter-rouge">goroutine</code> åœ¨åå°ä¸æ–­ç›‘å¬çª—å£æ”¹å˜äº‹ä»¶ï¼Œç„¶åè°ƒç”¨ <code class="highlighter-rouge">WindowChange</code> å³å¯ï¼›ä»£ç å¦‚ä¸‹:</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="c">// ç›‘å¬çª—å£å˜æ›´äº‹ä»¶</span>
	<span class="n">sigwinchCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">os</span><span class="o">.</span><span class="n">Signal</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
	<span class="n">signal</span><span class="o">.</span><span class="n">Notify</span><span class="p">(</span><span class="n">sigwinchCh</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGWINCH</span><span class="p">)</span>

	<span class="n">fd</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Fd</span><span class="p">())</span>
	<span class="n">termWidth</span><span class="p">,</span> <span class="n">termHeight</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GetSize</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="c">// é˜»å¡è¯»å–</span>
		<span class="k">case</span> <span class="n">sigwinch</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">sigwinchCh</span><span class="o">:</span>
			<span class="k">if</span> <span class="n">sigwinch</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="n">currTermWidth</span><span class="p">,</span> <span class="n">currTermHeight</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GetSize</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

			<span class="c">// åˆ¤æ–­ä¸€ä¸‹çª—å£å°ºå¯¸æ˜¯å¦æœ‰æ”¹å˜</span>
			<span class="k">if</span> <span class="n">currTermHeight</span> <span class="o">==</span> <span class="n">termHeight</span> <span class="o">&amp;&amp;</span> <span class="n">currTermWidth</span> <span class="o">==</span> <span class="n">termWidth</span> <span class="p">{</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="c">// æ›´æ–°è¿œç«¯å¤§å°</span>
			<span class="n">session</span><span class="o">.</span><span class="n">WindowChange</span><span class="p">(</span><span class="n">currTermHeight</span><span class="p">,</span> <span class="n">currTermWidth</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Unable to send window-change reqest: %s."</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
				<span class="k">continue</span>
			<span class="p">}</span>

			<span class="n">termWidth</span><span class="p">,</span> <span class="n">termHeight</span> <span class="o">=</span> <span class="n">currTermWidth</span><span class="p">,</span> <span class="n">currTermHeight</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}()</span>
</code></pre></div></div>

<h3 id="23tmux-æ ‡é¢˜ä»¥åŠå›æ˜¾ä¸æ¢è¡Œ">2.3ã€Tmux æ ‡é¢˜ä»¥åŠå›æ˜¾ä¸æ¢è¡Œ</h3>

<p>è¿™ä¸¤ä¸ªé—®é¢˜å®é™…ä¸Šéƒ½æ˜¯ç”±äºæˆ‘ä»¬ç›´æ¥å¯¹æ¥äº† <code class="highlighter-rouge">stderr</code>ã€<code class="highlighter-rouge">stdout</code> å’Œ <code class="highlighter-rouge">stdin</code> é€ æˆçš„ï¼Œå®é™…ä¸Šæˆ‘ä»¬åº”å½“å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥çš„ç®¡é“å¼å¤åˆ¶è¡Œä¸ºï¼Œå¹¶ä¸”æœ€å¥½å¸¦æœ‰ buf çš„å‘é€ï¼›ä»£ç å¦‚ä¸‹:</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">stdin</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">session</span><span class="o">.</span><span class="n">StdinPipe</span><span class="p">()</span>
<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="n">stdout</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">session</span><span class="o">.</span><span class="n">StdoutPipe</span><span class="p">()</span>
<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="n">stderr</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">session</span><span class="o">.</span><span class="n">StderrPipe</span><span class="p">()</span>
<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

<span class="k">go</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
<span class="k">go</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>
<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="m">128</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
			<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">stdin</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="o">:</span><span class="n">n</span><span class="p">])</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">checkErr</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}()</span>
</code></pre></div></div>

<h2 id="ä¸‰å®Œæ•´ä»£ç ">ä¸‰ã€å®Œæ•´ä»£ç </h2>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">SSHTerminal</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Session</span> <span class="o">*</span><span class="n">ssh</span><span class="o">.</span><span class="n">Session</span>
	<span class="n">exitMsg</span> <span class="kt">string</span>
	<span class="n">stdout</span>  <span class="n">io</span><span class="o">.</span><span class="n">Reader</span>
	<span class="n">stdin</span>   <span class="n">io</span><span class="o">.</span><span class="n">Writer</span>
	<span class="n">stderr</span>  <span class="n">io</span><span class="o">.</span><span class="n">Reader</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">sshConfig</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">ssh</span><span class="o">.</span><span class="n">ClientConfig</span><span class="p">{</span>
		<span class="n">User</span><span class="o">:</span> <span class="s">"root"</span><span class="p">,</span>
		<span class="n">Auth</span><span class="o">:</span> <span class="p">[]</span><span class="n">ssh</span><span class="o">.</span><span class="n">AuthMethod</span><span class="p">{</span>
			<span class="n">ssh</span><span class="o">.</span><span class="n">Password</span><span class="p">(</span><span class="s">"password"</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="n">HostKeyCallback</span><span class="o">:</span> <span class="n">ssh</span><span class="o">.</span><span class="n">InsecureIgnoreHostKey</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="n">client</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="s">"192.168.1.20:22"</span><span class="p">,</span> <span class="n">sshConfig</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
	
	<span class="n">err</span> <span class="o">=</span> <span class="n">New</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">SSHTerminal</span><span class="p">)</span> <span class="n">updateTerminalSize</span><span class="p">()</span> <span class="p">{</span>

	<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="c">// SIGWINCH is sent to the process when the window size of the terminal has</span>
		<span class="c">// changed.</span>
		<span class="n">sigwinchCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="n">os</span><span class="o">.</span><span class="n">Signal</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
		<span class="n">signal</span><span class="o">.</span><span class="n">Notify</span><span class="p">(</span><span class="n">sigwinchCh</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGWINCH</span><span class="p">)</span>

		<span class="n">fd</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Fd</span><span class="p">())</span>
		<span class="n">termWidth</span><span class="p">,</span> <span class="n">termHeight</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GetSize</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="c">// The client updated the size of the local PTY. This change needs to occur</span>
			<span class="c">// on the server side PTY as well.</span>
			<span class="k">case</span> <span class="n">sigwinch</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">sigwinchCh</span><span class="o">:</span>
				<span class="k">if</span> <span class="n">sigwinch</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
					<span class="k">return</span>
				<span class="p">}</span>
				<span class="n">currTermWidth</span><span class="p">,</span> <span class="n">currTermHeight</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GetSize</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

				<span class="c">// Terminal size has not changed, don't do anything.</span>
				<span class="k">if</span> <span class="n">currTermHeight</span> <span class="o">==</span> <span class="n">termHeight</span> <span class="o">&amp;&amp;</span> <span class="n">currTermWidth</span> <span class="o">==</span> <span class="n">termWidth</span> <span class="p">{</span>
					<span class="k">continue</span>
				<span class="p">}</span>

				<span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">WindowChange</span><span class="p">(</span><span class="n">currTermHeight</span><span class="p">,</span> <span class="n">currTermWidth</span><span class="p">)</span>
				<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
					<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Unable to send window-change reqest: %s."</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
					<span class="k">continue</span>
				<span class="p">}</span>

				<span class="n">termWidth</span><span class="p">,</span> <span class="n">termHeight</span> <span class="o">=</span> <span class="n">currTermWidth</span><span class="p">,</span> <span class="n">currTermHeight</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}()</span>

<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">SSHTerminal</span><span class="p">)</span> <span class="n">interactiveSession</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>

	<span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">exitMsg</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintln</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="s">"the connection was closed on the remote side on "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC822</span><span class="p">))</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Fprintln</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">exitMsg</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="n">fd</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Fd</span><span class="p">())</span>
	<span class="n">state</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">MakeRaw</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">terminal</span><span class="o">.</span><span class="n">Restore</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

	<span class="n">termWidth</span><span class="p">,</span> <span class="n">termHeight</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">terminal</span><span class="o">.</span><span class="n">GetSize</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">termType</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"TERM"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">termType</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
		<span class="n">termType</span> <span class="o">=</span> <span class="s">"xterm-256color"</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">RequestPty</span><span class="p">(</span><span class="n">termType</span><span class="p">,</span> <span class="n">termHeight</span><span class="p">,</span> <span class="n">termWidth</span><span class="p">,</span> <span class="n">ssh</span><span class="o">.</span><span class="n">TerminalModes</span><span class="p">{})</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">t</span><span class="o">.</span><span class="n">updateTerminalSize</span><span class="p">()</span>

	<span class="n">t</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">StdinPipe</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">t</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">StdoutPipe</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">t</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">StderrPipe</span><span class="p">()</span>

	<span class="k">go</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stderr</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
	<span class="k">go</span> <span class="n">io</span><span class="o">.</span><span class="n">Copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
	<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="m">128</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stdin</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
				<span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="o">:</span><span class="n">n</span><span class="p">])</span>
				<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
					<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
					<span class="n">t</span><span class="o">.</span><span class="n">exitMsg</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">()</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">Shell</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">Session</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">ssh</span><span class="o">.</span><span class="n">Client</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>

	<span class="n">session</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">NewSession</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">session</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="n">s</span> <span class="o">:=</span> <span class="n">SSHTerminal</span><span class="p">{</span>
		<span class="n">Session</span><span class="o">:</span> <span class="n">session</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">interactiveSession</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET