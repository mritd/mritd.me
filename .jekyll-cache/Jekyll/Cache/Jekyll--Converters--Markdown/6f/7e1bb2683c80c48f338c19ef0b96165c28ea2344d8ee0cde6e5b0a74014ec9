I"½E<blockquote>
  <p>æœ€è¿‘åœ¨è°ƒæ•´å…¬å¸é¡¹ç›®çš„ CIï¼Œç›®å‰ä¸»è¦ä½¿ç”¨ GitLab CIï¼Œåœ¨å°è¯•å¤šé˜¶æ®µæ„å»ºä¸­è¸©äº†ç‚¹å‘ï¼Œç„¶åå‘ç°äº†ä¸€äº›æœ‰æ„æ€çš„ç©æ„</p>
</blockquote>

<p>æœ¬æ–‡å‚è€ƒ:</p>

<ul>
  <li><a href="https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/experimental.md">Dockerfile frontend experimental syntaxes</a></li>
  <li><a href="https://medium.com/@tonistiigi/advanced-multi-stage-build-patterns-6f741b852fae">Advanced multi-stage build patterns</a></li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/build/">docker build Document</a></li>
</ul>

<h2 id="ä¸€èµ·å› ">ä¸€ã€èµ·å› </h2>

<p>å…¬å¸ç›®å‰ä¸»è¦ä½¿ç”¨ GitLab CI ä½œä¸ºä¸»åŠ› CI æ„å»ºå·¥å…·ï¼Œè€Œä¸”ç”±äºæœºå™¨æœ‰é™ï¼Œæˆ‘ä»¬å¯¹ä¸€äº›åŒ…ç®¡ç†å™¨çš„æœ¬åœ° cache ç›´æ¥æŒä¹…åŒ–åˆ°äº†æœ¬æœºï¼›æ¯”å¦‚ maven çš„ <code class="highlighter-rouge">.m2</code> ç›®å½•ï¼Œnodejs çš„ <code class="highlighter-rouge">.npm</code> ç›®å½•ç­‰ï¼›è™½ç„¶æˆ‘ä»¬åˆ›å»ºäº†å¯¹åº”çš„ç§æœï¼Œä½†æ˜¯åœ¨ build æ—¶æ¯•ç«Ÿä¼šä¸‹è½½ï¼Œæ‰€ä»¥å½“æ—¶ç´¢æ€§è°ƒæ•´ GitLab Runner åœ¨æ¯ä¸ªç”± GitLab Runner å¯åŠ¨çš„å®¹å™¨ä¸­æŒ‚è½½è¿™äº›ç¼“å­˜ç›®å½•(GitLab CI åœ¨ build æ—¶ä¼šæ–°å¯åŠ¨å®¹å™¨è¿è¡Œ build ä»»åŠ¡)ï¼›ä»Šå¤©è°ƒæ•´ nodejs é¡¹ç›®æµªäº†ä¸€ä¸‹ï¼Œç›´æ¥é‡‡ç”¨ Dockerfile çš„ multi-stage build åŠŸèƒ½è¿›è¡Œ â€œBuild =&gt; Package(docker image)â€ çš„å®ç°ï¼ŒåŸºæœ¬ Dockerfile å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM gozap/build as builder

COPY <span class="nb">.</span> /xxxx

WORKDIR /xxxx

RUN <span class="nb">source</span> ~/.bashrc <span class="se">\</span>
    <span class="o">&amp;&amp;</span> cnpm <span class="nb">install</span> <span class="se">\</span>
    <span class="o">&amp;&amp;</span> cnpm run build

FROM gozap/nginx-react:v1.0.0

LABEL <span class="nv">maintainer</span><span class="o">=</span><span class="s2">"mritd &lt;mritd@linux.com&gt;"</span>

COPY <span class="nt">--from</span><span class="o">=</span>builder /xxxx/public /usr/share/nginx/html

EXPOSE 80

STOPSIGNAL SIGTERM

CMD <span class="o">[</span><span class="s2">"nginx"</span>, <span class="s2">"-g"</span>, <span class="s2">"daemon off;"</span><span class="o">]</span>
</code></pre></div></div>

<p>æœ¬æ¥è¿™ä¸ª <code class="highlighter-rouge">cnpm</code> å‘½ä»¤æ˜¯å¸¦æœ‰ cache çš„(<a href="https://github.com/Gozap/dockerfile/blob/master/build/cnpm">è§è¿™é‡Œ</a>)ï¼Œä¸è¿‡è¿è¡Œå®Œ build ä»¥åå‘ç°å¾ˆæ…¢ï¼Œæ£€æŸ¥å®¿ä¸»æœº cache ç›®å½•å‘ç°æ ¹æœ¬æ²¡æœ‰ cacheâ€¦ç„¶åçªç„¶æ„Ÿè§‰</p>

<p><img src="https://cdn.oss.link/markdown/6ieh4.jpg" alt="äº‹æƒ…å¹¶æ²¡æœ‰è¿™ä¹ˆç®€å•" /></p>

<p>ä»”ç»†æƒ³æƒ³ï¼Œæƒ…å†µåº”è¯¥æ˜¯è¿™æ ·äº‹å„¿çš„â€¦</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+------------+                +-------------+            +----------------+
|            |                |             |            |                |
|            |                |    build    |            |   Multi-stage  |
|   Runner   +---------------&gt;+  conatiner  +-----------&gt;+     Build      |
|            |                |             |            |                |
|            |                |             |            |                |
+------------+                +------+------+            +----------------+
                                     ^
                                     |
                                     |
                                     |
                                     |
                              +------+------+
                              |             |
                              |    Cache    |
                              |             |
                              +-------------+

</code></pre></div></div>

<p><img src="https://cdn.oss.link/markdown/9ov8m.jpg" alt="æŒ‚è½½ä¸ç®¡ç”¨" /></p>

<p>åæ¥ç»è¿‡æŸ¥é˜…æ–‡æ¡£ï¼Œå‘ç° Dockerfile æ˜¯æœ‰æ‰©å±•è¯­æ³•çš„(å½“ç„¶æœ€ç»ˆæˆ‘è¿˜æ˜¯æ²¡ç”¨)ï¼Œå…·ä½“è¯·è§<del>ä¸‹ç¯‡æ–‡ç« </del>(æˆ‘æ€•è¢«æ‰“æ­»)ä¸‹é¢ï¼Œ<strong>å…ˆè¯´å¥½ï¼Œä¸‹é¢çš„å†…å®¹æ— æ³•å®Œç¾çš„è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œç›®å‰åªæ˜¯æ”¯æŒäº†ä¸€éƒ¨åˆ†åŠŸèƒ½ï¼Œå½“ç„¶æœªæ¥å¾ˆå¯èƒ½æ”¯æŒç±»ä¼¼ <code class="highlighter-rouge">IF ELSE</code> è¯­æ³•ã€ç›´æ¥æŒ‚è½½å®¿ä¸»æœºç›®å½•ç­‰åŠŸèƒ½</strong></p>

<h2 id="äºŒå¼€å¯-dockerfile-æ‰©å±•è¯­æ³•">äºŒã€å¼€å¯ Dockerfile æ‰©å±•è¯­æ³•</h2>

<h3 id="21å¼€å¯å®éªŒæ€§åŠŸèƒ½">2.1ã€å¼€å¯å®éªŒæ€§åŠŸèƒ½</h3>

<p>ç›®å‰è¿™ä¸ªæ‰©å±•è¯­æ³•è¿˜å¤„äºå®éªŒæ€§åŠŸèƒ½ï¼Œæ‰€ä»¥éœ€è¦é…ç½® dockerd å®ˆæŠ¤è¿›ç¨‹ï¼Œä¿®æ”¹å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd  <span class="nt">-H</span> unix:// <span class="se">\</span>
                            <span class="nt">--init</span> <span class="se">\</span>
                            <span class="nt">--live-restore</span> <span class="se">\</span>
                            <span class="nt">--data-root</span><span class="o">=</span>/data/docker <span class="se">\</span>
                            <span class="nt">--experimental</span> <span class="se">\</span>
                            <span class="nt">--log-driver</span> json-file <span class="se">\</span>
                            <span class="nt">--log-opt</span> max-size<span class="o">=</span>30m <span class="se">\</span>
                            <span class="nt">--log-opt</span> max-file<span class="o">=</span>3
</code></pre></div></div>

<p>ä¸»è¦æ˜¯ <code class="highlighter-rouge">--experimental</code> å‚æ•°ï¼Œå‚è€ƒ<a href="https://docs.docker.com/engine/reference/commandline/dockerd/#description">å®˜æ–¹æ–‡æ¡£</a>ï¼›<strong>åŒæ—¶åœ¨ build å‰å£°æ˜ <code class="highlighter-rouge">export DOCKER_BUILDKIT=1</code> å˜é‡</strong></p>

<h3 id="22ä¿®æ”¹-dockerfile">2.2ã€ä¿®æ”¹ Dockerfile</h3>

<p>å¼€å¯å®éªŒæ€§åŠŸèƒ½åï¼Œåªéœ€è¦åœ¨ Dockerfile å¤´éƒ¨å¢åŠ  <code class="highlighter-rouge"># syntax=docker/dockerfile:experimental</code> æ—¢å¯ï¼›ä¸ºäº†ä¿è¯ç¨³å®šæ€§ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šå…·ä½“çš„ç‰ˆæœ¬å·ï¼Œç±»ä¼¼è¿™æ ·</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax=docker/dockerfile:1.1.1-experimental</span>
FROM tomcat
</code></pre></div></div>

<h3 id="23å¯ç”¨çš„æ‰©å±•è¯­æ³•">2.3ã€å¯ç”¨çš„æ‰©å±•è¯­æ³•</h3>

<ul>
  <li><code class="highlighter-rouge">RUN --mount=type=bind</code></li>
</ul>

<p>è¿™ä¸ªæ˜¯é»˜è®¤çš„æŒ‚è½½æ¨¡å¼ï¼Œè¿™ä¸ªå…è®¸å°†ä¸Šä¸‹æ–‡æˆ–è€…é•œåƒä»¥å¯éƒ½å¯å†™/åªè¯»æ¨¡å¼æŒ‚è½½åˆ° build å®¹å™¨ä¸­ï¼Œå¯é€‰å‚æ•°å¦‚ä¸‹(ä¸ç¿»è¯‘äº†)</p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">target</code> (required)</td>
      <td>Mount path.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">source</code></td>
      <td>Source path in the <code class="highlighter-rouge">from</code>. Defaults to the root of the <code class="highlighter-rouge">from</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">from</code></td>
      <td>Build stage or image name for the root of the source. Defaults to the build context.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">rw</code>,<code class="highlighter-rouge">readwrite</code></td>
      <td>Allow writes on the mount. Written data will be discarded.</td>
    </tr>
  </tbody>
</table>

<ul>
  <li><code class="highlighter-rouge">RUN --mount=type=cache</code></li>
</ul>

<p>ä¸“ç”¨äºä½œä¸º cache çš„æŒ‚è½½ä½ç½®ï¼Œä¸€èˆ¬ç”¨äº cache åŒ…ç®¡ç†å™¨çš„ä¸‹è½½ç­‰</p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">id</code></td>
      <td>Optional ID to identify separate/different caches</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">target</code> (required)</td>
      <td>Mount path.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">ro</code>,<code class="highlighter-rouge">readonly</code></td>
      <td>Read-only if set.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">sharing</code></td>
      <td>One of <code class="highlighter-rouge">shared</code>, <code class="highlighter-rouge">private</code>, or <code class="highlighter-rouge">locked</code>. Defaults to <code class="highlighter-rouge">shared</code>. A <code class="highlighter-rouge">shared</code> cache mount can be used concurrently by multiple writers. <code class="highlighter-rouge">private</code> creates a new mount if there are multiple writers. <code class="highlighter-rouge">locked</code> pauses the second writer until the first one releases the mount.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">from</code></td>
      <td>Build stage to use as a base of the cache mount. Defaults to empty directory.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">source</code></td>
      <td>Subpath in the <code class="highlighter-rouge">from</code> to mount. Defaults to the root of the <code class="highlighter-rouge">from</code>.</td>
    </tr>
  </tbody>
</table>

<p><strong>Example: cache Go packages</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax = docker/dockerfile:experimental</span>
FROM golang
...
RUN <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>cache,target<span class="o">=</span>/root/.cache/go-build go build ...
</code></pre></div></div>

<p><strong>Example: cache apt packages</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax = docker/dockerfile:experimental</span>
FROM ubuntu
RUN <span class="nb">rm</span> <span class="nt">-f</span> /etc/apt/apt.conf.d/docker-clean<span class="p">;</span> <span class="nb">echo</span> <span class="s1">'Binary::apt::APT::Keep-Downloaded-Packages "true";'</span> <span class="o">&gt;</span> /etc/apt/apt.conf.d/keep-cache
RUN <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>cache,target<span class="o">=</span>/var/cache/apt <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>cache,target<span class="o">=</span>/var/lib/apt <span class="se">\</span>
  apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> gcc
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">RUN --mount=type=tmpfs</code></li>
</ul>

<p>ä¸“ç”¨äºæŒ‚è½½ tmpfs çš„é€‰é¡¹</p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">target</code> (required)</td>
      <td>Mount path.</td>
    </tr>
  </tbody>
</table>

<ul>
  <li><code class="highlighter-rouge">RUN --mount=type=secret</code></li>
</ul>

<p>è¿™ä¸ªç±»ä¼¼ k8s çš„ secretï¼Œç”¨æ¥æŒ‚è½½ä¸€äº›ä¸æƒ³æ‰“å…¥é•œåƒï¼Œä½†æ˜¯æ„å»ºæ—¶æƒ³ä½¿ç”¨çš„å¯†é’¥ç­‰ï¼Œä¾‹å¦‚ docker çš„ <code class="highlighter-rouge">config.json</code>ï¼ŒS3 çš„ <code class="highlighter-rouge">credentials</code></p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">id</code></td>
      <td>ID of the secret. Defaults to basename of the target path.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">target</code></td>
      <td>Mount path. Defaults to <code class="highlighter-rouge">/run/secrets/</code> + <code class="highlighter-rouge">id</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">required</code></td>
      <td>If set to <code class="highlighter-rouge">true</code>, the instruction errors out when the secret is unavailable. Defaults to <code class="highlighter-rouge">false</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">mode</code></td>
      <td>File mode for secret file in octal. Default 0400.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">uid</code></td>
      <td>User ID for secret file. Default 0.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">gid</code></td>
      <td>Group ID for secret file. Default 0.</td>
    </tr>
  </tbody>
</table>

<p><strong>Example: access to S3</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax = docker/dockerfile:experimental</span>
FROM python:3
RUN pip <span class="nb">install </span>awscli
RUN <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>secret,id<span class="o">=</span>aws,target<span class="o">=</span>/root/.aws/credentials aws s3 <span class="nb">cp </span>s3://... ...
</code></pre></div></div>

<p><strong>æ³¨æ„: <code class="highlighter-rouge">buildctl</code> æ˜¯ BuildKit çš„å‘½ä»¤ï¼Œä½ è¦æµ‹è¯•çš„è¯è‡ªå·±æ¢æˆ <code class="highlighter-rouge">docker build</code> ç›¸å…³å‚æ•°</strong></p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>buildctl build <span class="nt">--frontend</span><span class="o">=</span>dockerfile.v0 <span class="nt">--local</span> <span class="nv">context</span><span class="o">=</span><span class="nb">.</span> <span class="nt">--local</span> <span class="nv">dockerfile</span><span class="o">=</span><span class="nb">.</span> <span class="se">\</span>
  <span class="nt">--secret</span> <span class="nb">id</span><span class="o">=</span>aws,src<span class="o">=</span><span class="nv">$HOME</span>/.aws/credentials
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">RUN --mount=type=ssh</code></li>
</ul>

<p>å…è®¸ build å®¹å™¨é€šè¿‡ SSH agent è®¿é—® SSH keyï¼Œå¹¶ä¸”æ”¯æŒ <code class="highlighter-rouge">passphrases</code></p>

<table>
  <thead>
    <tr>
      <th>Option</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">id</code></td>
      <td>ID of SSH agent socket or key. Defaults to â€œdefaultâ€.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">target</code></td>
      <td>SSH agent socket path. Defaults to <code class="highlighter-rouge">/run/buildkit/ssh_agent.${N}</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">required</code></td>
      <td>If set to <code class="highlighter-rouge">true</code>, the instruction errors out when the key is unavailable. Defaults to <code class="highlighter-rouge">false</code>.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">mode</code></td>
      <td>File mode for socket in octal. Default 0600.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">uid</code></td>
      <td>User ID for socket. Default 0.</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">gid</code></td>
      <td>Group ID for socket. Default 0.</td>
    </tr>
  </tbody>
</table>

<p><strong>Example: access to Gitlab</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># syntax = docker/dockerfile:experimental</span>
FROM alpine
RUN apk add <span class="nt">--no-cache</span> openssh-client
RUN <span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nt">-m</span> 0700 ~/.ssh <span class="o">&amp;&amp;</span> ssh-keyscan gitlab.com <span class="o">&gt;&gt;</span> ~/.ssh/known_hosts
RUN <span class="nt">--mount</span><span class="o">=</span><span class="nb">type</span><span class="o">=</span>ssh ssh <span class="nt">-q</span> <span class="nt">-T</span> git@gitlab.com 2&gt;&amp;1 | <span class="nb">tee</span> /hello
<span class="c"># "Welcome to GitLab, @GITLAB_USERNAME_ASSOCIATED_WITH_SSHKEY" should be printed here</span>
<span class="c"># with the type of build progress is defined as `plain`.</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">eval</span> <span class="si">$(</span>ssh-agent<span class="si">)</span>
<span class="nv">$ </span>ssh-add ~/.ssh/id_rsa
<span class="o">(</span>Input your passphrase here<span class="o">)</span>
<span class="nv">$ </span>buildctl build <span class="nt">--frontend</span><span class="o">=</span>dockerfile.v0 <span class="nt">--local</span> <span class="nv">context</span><span class="o">=</span><span class="nb">.</span> <span class="nt">--local</span> <span class="nv">dockerfile</span><span class="o">=</span><span class="nb">.</span> <span class="se">\</span>
  <span class="nt">--ssh</span> <span class="nv">default</span><span class="o">=</span><span class="nv">$SSH_AUTH_SOCK</span>
</code></pre></div></div>

<p>ä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç›®å½•çš„ pem æ–‡ä»¶ï¼Œä½†æ˜¯å¸¦æœ‰å¯†ç çš„ pem ç›®å‰ä¸æ”¯æŒ</p>

<p><strong>ç›®å‰æ ¹æ®æ–‡æ¡£æµ‹è¯•ï¼Œå½“å‰çš„æŒ‚è½½ç±»å‹æ¯”å¦‚ <code class="highlighter-rouge">cache</code> ç±»å‹ï¼Œä»…ç”¨äº multi-stage å†…çš„æŒ‚è½½ï¼Œæ¯”å¦‚ä½ æœ‰ 2+ ä¸ªæ„å»ºæ­¥éª¤ï¼Œ<code class="highlighter-rouge">cache</code> æŒ‚è½½ç±»å‹èƒ½å¸®ä½ åœ¨å„ä¸ªé˜¶æ®µå†…å…±äº«æ–‡ä»¶ï¼›ä½†æ˜¯å®ƒç›®å‰æ— æ³•è§£å†³ç›´æ¥å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ° multi-stage çš„é—®é¢˜(å¯ä»¥é‡‡å–äº›æ›²çº¿æ•‘å›½æ–¹æ¡ˆï¼Œä½†æ˜¯å¾ˆä¸ä¼˜é›…)ï¼›ä½†æ˜¯æœªæ¥è¿˜æ˜¯å¾ˆæœ‰å±•æœ›çš„ï¼Œå¯ä»¥å…³æ³¨ä¸€ä¸‹</strong></p>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET