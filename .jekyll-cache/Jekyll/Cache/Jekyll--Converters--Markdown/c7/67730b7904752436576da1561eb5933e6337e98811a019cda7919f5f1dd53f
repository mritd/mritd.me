I"4<h2 id="ä¸€ä»‹ç»">ä¸€ã€ä»‹ç»</h2>

<blockquote>
  <p>Project Harbor is an enterprise-class registry server, which extends the open source Docker Registry server by adding the functionality usually required by an enterprise, such as security, control, and management. Harbor is primarily designed to be a private registry - providing the needed security and control that enterprises require. It also helps minimize bandwidth usage, which is helpful to both improve productivity (local network access) as well as performance (for those with poor internet connectivity).</p>
</blockquote>

<p>ç®€å•çš„è¯´ï¼ŒHarbor æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„ Docker Registryï¼Œå¯ä»¥å®ç° images çš„ç§æœ‰å­˜å‚¨å’Œæ—¥å¿—ç»Ÿè®¡æƒé™æ§åˆ¶ç­‰åŠŸèƒ½ï¼Œå¹¶æ”¯æŒåˆ›å»ºå¤šé¡¹ç›®(Harbor æå‡ºçš„æ¦‚å¿µ)ï¼ŒåŸºäºå®˜æ–¹ Registry V2 å®ç°ã€‚</p>

<!--more-->

<h2 id="äºŒç¯å¢ƒå‡†å¤‡">äºŒã€ç¯å¢ƒå‡†å¤‡</h2>

<p>æœ¬æ–‡æ‰€ä½¿ç”¨çš„ç¯å¢ƒå¦‚ä¸‹ :</p>

<ul>
  <li>Ubuntu 14.04</li>
  <li>Docker 1.11.2</li>
  <li>docker-compose 1.6.2</li>
</ul>

<h3 id="21å®‰è£…-docker">2.1ã€å®‰è£… Docker</h3>

<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… Docker</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-fsSL</span> https://get.docker.io | bash
</code></pre></div></div>

<h3 id="22å®‰è£…-docker-compose">2.2ã€å®‰è£… docker-compose</h3>

<p>é»˜è®¤çš„ <a href="https://docs.docker.com/compose/install/">å®˜æ–¹æ–‡æ¡£</a> å®‰è£…å‘½ä»¤å¦‚ä¸‹ :</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-L</span> https://github.com/docker/compose/releases/download/1.6.2/docker-compose-<span class="sb">`</span><span class="nb">uname</span> <span class="nt">-s</span><span class="sb">`</span>-<span class="sb">`</span><span class="nb">uname</span> <span class="nt">-m</span><span class="sb">`</span> <span class="o">&gt;</span> /usr/local/bin/docker-compose
</code></pre></div></div>

<p><strong>ç»è¿‡æœ¬äººæµ‹è¯•ï¼Œå…¶æ–‡ä»¶æ‰˜ç®¡åœ¨äºšé©¬é€Šä¸Šï¼Œä¼Ÿå¤§çš„é˜²ç«å¢™æˆåŠŸé˜»æ­¢ä¸‹è½½â€¦â€¦</strong></p>

<p><strong>æœ‰èƒ½åŠ›çš„ç«¥é‹å¯ä»¥ä½¿ç”¨æ¢¯å­ï¼Œæˆ‘å·²ç»ä¸‹è½½å¥½äº†ä¸€ä¸ª <a href="https://cdn.oss.link/files/docker-compose">ç‚¹å‡»ä¸‹è½½</a></strong>ï¼›ä¸‹è½½åç›´æ¥ cp åˆ° <code class="highlighter-rouge">/usr/local/bin</code> ä¸‹å¹¶ç»™ä¸å¯æ‰§è¡Œæƒé™å³å¯ã€‚</p>

<h2 id="ä¸‰æ­å»º-harbor">ä¸‰ã€æ­å»º Harbor</h2>

<h3 id="31å…‹éš†æºç ">3.1ã€å…‹éš†æºç </h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/vmware/harbor
</code></pre></div></div>

<h3 id="32ä¿®æ”¹é…ç½®">3.2ã€ä¿®æ”¹é…ç½®</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>harbor/Deploy/
vim harbor.cfg
</code></pre></div></div>

<p>é…ç½®æ ·ä¾‹å¦‚ä¸‹ :</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## Configuration file of Harbor</span>

<span class="c">#The IP address or hostname to access admin UI and registry service.</span>
<span class="c">#DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.</span>
<span class="c"># æŒ‡å®š hostnameï¼Œä¸€èˆ¬ä¸ºIPï¼Œæˆ–è€…åŸŸåï¼Œç”¨äºç™»å½• Web UI ç•Œé¢</span>
<span class="nb">hostname</span> <span class="o">=</span> 10.211.55.17

<span class="c">#The protocol for accessing the UI and token/notification service, by default it is http.</span>
<span class="c">#It can be set to https if ssl is enabled on nginx.</span>
<span class="c"># URL è®¿é—®æ–¹å¼ï¼ŒSSL éœ€è¦é…ç½® nginx</span>
ui_url_protocol <span class="o">=</span> http

<span class="c">#Email account settings for sending out password resetting emails.</span>
<span class="c"># é‚®ä»¶ç›¸å…³ä¿¡æ¯é…ç½®ï¼Œå¦‚å¿˜è®°å¯†ç å‘é€é‚®ä»¶</span>
email_server <span class="o">=</span> smtp.xxxxxx.com
email_server_port <span class="o">=</span> 465
email_username <span class="o">=</span> reg@mritd.me
email_password <span class="o">=</span> xxxxxx
email_from <span class="o">=</span> docker &lt;reg@mritd.me&gt;
email_ssl <span class="o">=</span> <span class="nb">true</span>

<span class="c">##The password of Harbor admin, change this before any production use.</span>
<span class="c"># é»˜è®¤çš„ Harbor çš„ç®¡ç†å‘˜å¯†ç ï¼Œç®¡ç†å‘˜ç”¨æˆ·åé»˜è®¤ admin</span>
harbor_admin_password <span class="o">=</span> Harbor12345

<span class="c">##By default the auth mode is db_auth, i.e. the credentials are stored in a local database.</span>
<span class="c">#Set it to ldap_auth if you want to verify a user's credentials against an LDAP server.</span>
<span class="c"># æŒ‡å®š Harbor çš„æƒé™éªŒè¯æ–¹å¼ï¼ŒHarbor æ”¯æŒæœ¬åœ°çš„ mysql æ•°æ®å­˜å‚¨å¯†ç ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒ LDAP</span>
auth_mode <span class="o">=</span> db_auth

<span class="c">#The url for an ldap endpoint.</span>
<span class="c"># å¦‚æœé‡‡ç”¨äº† LDAPï¼Œæ­¤å¤„å¡«å†™ LDAP åœ°å€</span>
ldap_url <span class="o">=</span> ldaps://ldap.mydomain.com

<span class="c">#The basedn template to look up a user in LDAP and verify the user's password.</span>
<span class="c"># LADP éªŒè¯å¯†ç çš„æ–¹å¼(æˆ‘ç‰¹ä¹ˆæ²¡ç”¨è¿‡è¿™ä¹ˆé«˜çº§çš„ç©æ„)</span>
ldap_basedn <span class="o">=</span> <span class="nv">uid</span><span class="o">=</span>%s,ou<span class="o">=</span>people,dc<span class="o">=</span>mydomain,dc<span class="o">=</span>com

<span class="c">#The password for the root user of mysql db, change this before any production use.</span>
<span class="c"># mysql æ•°æ®åº“ root è´¦æˆ·å¯†ç </span>
db_password <span class="o">=</span> root123

<span class="c">#Turn on or off the self-registration feature</span>
<span class="c"># æ˜¯å¦å…è®¸å¼€æ”¾æ³¨å†Œ</span>
self_registration <span class="o">=</span> on

<span class="c">#Turn on or off the customize your certicate</span>
<span class="c"># å…è®¸è‡ªç­¾åè¯ä¹¦</span>
customize_crt <span class="o">=</span> on

<span class="c">#fill in your certicate message</span>
<span class="c"># è‡ªç­¾åè¯ä¹¦ä¿¡æ¯</span>
crt_country <span class="o">=</span> CN
crt_state <span class="o">=</span> State
crt_location <span class="o">=</span> CN
crt_organization <span class="o">=</span> mritd
crt_organizationalunit <span class="o">=</span> mritd
crt_commonname <span class="o">=</span> mritd.me
crt_email <span class="o">=</span> reg.mritd.me
<span class="c">#####</span>
</code></pre></div></div>

<h3 id="33ç”Ÿæˆç›¸å…³é…ç½®">3.3ã€ç”Ÿæˆç›¸å…³é…ç½®</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>harbor/Deploy/
./prepare
</code></pre></div></div>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_prepare.png" alt="hexo_docker_harbor_prepare" /></p>

<h3 id="34ç¼–è¯‘-image-å¹¶å¯åŠ¨">3.4ã€ç¼–è¯‘ image å¹¶å¯åŠ¨</h3>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>harbor/Deploy/
docker-compose up <span class="nt">-d</span>
</code></pre></div></div>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_up.png" alt="hexo_docker_harbor_up" /></p>

<h3 id="35å¯åŠ¨åç›¸å…³å®¹å™¨">3.5ã€å¯åŠ¨åç›¸å…³å®¹å™¨</h3>

<p><strong>æ­£å¸¸å¯åŠ¨æˆåŠŸåä¼šæœ‰ 5 ä¸ª Contianer :</strong></p>

<ul>
  <li>Proxy : ç”±Nginx æœåŠ¡å™¨æ„æˆçš„åå‘ä»£ç†</li>
  <li>Registry : ç”±Dockerå®˜æ–¹çš„å¼€æºregistry é•œåƒæ„æˆçš„å®¹å™¨å®ä¾‹</li>
  <li>UI : å³æ¶æ„ä¸­çš„core services, æ„æˆæ­¤å®¹å™¨çš„ä»£ç æ˜¯Harboré¡¹ç›®çš„ä¸»ä½“</li>
  <li>Mysql : ç”±å®˜æ–¹MySqlé•œåƒæ„æˆçš„æ•°æ®åº“å®¹å™¨</li>
  <li>Log : è¿è¡Œç€rsyslogdçš„å®¹å™¨ï¼Œé€šè¿‡log-driverçš„å½¢å¼æ”¶é›†å…¶ä»–å®¹å™¨çš„æ—¥å¿—</li>
</ul>

<p><strong>è¿™å‡ ä¸ª Contianer é€šè¿‡ Docker link çš„å½¢å¼è¿æ¥åœ¨ä¸€èµ·ï¼Œåœ¨å®¹å™¨ä¹‹é—´é€šè¿‡å®¹å™¨åå­—äº’ç›¸è®¿é—®ã€‚å¯¹ç»ˆç«¯ç”¨æˆ·è€Œè¨€ï¼Œåªéœ€è¦æš´éœ² proxyï¼ˆå³Nginxï¼‰çš„æœåŠ¡ç«¯å£</strong></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_contianer.png" alt="hexo_docker_harbor_contianer" /></p>

<h2 id="å››è®¿é—®-web-ui-å¹¶æµ‹è¯•">å››ã€è®¿é—® Web UI å¹¶æµ‹è¯•</h2>

<h3 id="41ä¸»é¡µ">4.1ã€ä¸»é¡µ</h3>

<p><strong>é»˜è®¤çš„è®¿é—®åœ°å€å³ä¸º <code class="highlighter-rouge">harbor.cfg</code> ä¸­ <code class="highlighter-rouge">hostname</code> åœ°å€ï¼Œç›´æ¥è®¿é—®å³å¯ï¼Œå¦‚ä¸‹</strong></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_homepage.png" alt="hexo_docker_harbor_homepage" /></p>

<p><strong>å¦‚æœ <code class="highlighter-rouge">harbor.cfg</code> ä¸­ <code class="highlighter-rouge">self_registration</code> å±æ€§è®¾ç½®ä¸º <code class="highlighter-rouge">off</code>ï¼Œé‚£ä¹ˆæ™®é€šç”¨æˆ·å°†æ— æ³•è‡ªå·±å®ç°æ³¨å†Œï¼Œåªèƒ½ç”±ç®¡ç†å‘˜åˆ›å»ºç”¨æˆ·ï¼Œä¸»é¡µå³ä¸Šè§’çš„æ³¨å†ŒæŒ‰é’®ä¹Ÿä¼šæ¶ˆå¤±ã€‚</strong></p>

<h3 id="42ç™»å½•">4.2ã€ç™»å½•</h3>

<p><strong>Harbor é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·ä¸º <code class="highlighter-rouge">admin</code>ï¼Œå¯†ç åœ¨ <code class="highlighter-rouge">harbor.cfg</code> ä¸­è®¾ç½®è¿‡ï¼Œé»˜è®¤çš„æ˜¯ <code class="highlighter-rouge">Harbor12345</code>ï¼Œå¯ç›´æ¥ç™»é™†</strong></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_userspace.png" alt="hexo_docker_harbor_userspace" /></p>

<h3 id="43åˆ›å»ºç§æœ‰é¡¹ç›®">4.3ã€åˆ›å»ºç§æœ‰é¡¹ç›®</h3>

<p><strong>Harbor æœ‰ä¸€ä¸ªé¡¹ç›®çš„æ¦‚å¿µï¼Œé¡¹ç›®åå¯ä»¥ç†è§£ä¸º Docker Hub çš„ç”¨æˆ·åï¼Œå…¶ä¸‹å¯ä»¥åå¾ˆå¤š imagesï¼ŒHarbor çš„é¡¹ç›®å¿…é¡»ç™»å½•åæ–¹å¯ pushï¼Œå…¬æœ‰é¡¹ç›®å’Œç§æœ‰é¡¹ç›®çš„åŒºåˆ«æ˜¯å¯¹å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯è§</strong></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_createproject.png" alt="hexo_docker_harbor_createproject" /></p>

<h3 id="44push-é•œåƒ">4.4ã€push é•œåƒ</h3>

<h4 id="441è®¾ç½®-http-ä»“åº“åœ°å€">4.4.1ã€è®¾ç½® http ä»“åº“åœ°å€</h4>

<p>ç”±äºé‡‡ç”¨äº†é»˜è®¤çš„ http æ–¹å¼è¿æ¥ï¼Œè€Œ Docker è®¤ä¸ºè¿™æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥åœ¨ push ä¹‹å‰éœ€è¦è°ƒæ•´ä¸€ä¸‹ docker é…ç½®ï¼Œç¼–è¾‘ <code class="highlighter-rouge">/etc/default/docker</code> å¢åŠ å¦‚ä¸‹å†…å®¹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">DOCKER_OPTS</span><span class="o">=</span><span class="s2">"</span><span class="nv">$DOCKER_OPTS</span><span class="s2"> --insecure-registry 10.211.55.17"</span>
</code></pre></div></div>

<p><strong>å…¶ä¸­ IP åœ°å€è¦æŒ‡å‘ <code class="highlighter-rouge">harbor.cfg</code> ä¸­çš„ <code class="highlighter-rouge">hostname</code></strong>ï¼Œç„¶åæ‰§è¡Œ <code class="highlighter-rouge">docker-compose stop</code> åœæ‰æ‰€æœ‰ Contianerï¼Œå†æ‰§è¡Œ <code class="highlighter-rouge">service docker restart</code> é‡å¯ Dokcer æœåŠ¡ï¼Œæœ€åæ‰§è¡Œ <code class="highlighter-rouge">docker-compose start</code> å³å¯ã€‚</p>

<p><strong>æ³¨æ„ : Docker æœåŠ¡é‡å¯åï¼Œæ‰§è¡Œ <code class="highlighter-rouge">docker-compose start</code> æ—¶æœ‰ä¸€å®šå‡ ç‡å‡ºç°å¦‚ä¸‹é”™è¯¯(æˆ–è€…ç›®å½•å·²å­˜åœ¨ç­‰é”™è¯¯)ï¼Œæ­¤æ—¶åœ¨ <code class="highlighter-rouge">docker-compose stop</code> ä¸€ä¸‹ç„¶ååœ¨å¯åŠ¨å³å¯ï¼Œå®åœ¨ä¸è¡Œå†æ¬¡é‡å¯ Dokcer æœåŠ¡ï¼Œåƒä¸‡ä¸è¦æ‰‹è´±çš„å»åˆ æ–‡ä»¶(åˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„)</strong></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_composeerror.jpeg" alt="hexo_docker_harbor_composeerror" /></p>

<h4 id="442harbor-é¡¹ç›®å’Œæƒé™è§’è‰²">4.4.2ã€Harbor é¡¹ç›®å’Œæƒé™(è§’è‰²)</h4>

<p><strong>ç”¨æˆ·æœ¬èº«æ‹¥æœ‰çš„é¡¹ç›®ï¼Œç™»é™†åå¯ç›´æ¥ pushï¼Œå…¶ä»–çš„ç”¨æˆ·åˆ›å»ºçš„é¡¹ç›®å–å†³äºé¡¹ç›®æ˜¯å¦æ·»åŠ äº†å¯¹åº”ç”¨æˆ·å’Œæƒé™ï¼Œ</strong></p>

<p><strong>ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·æ˜¯å¦å¯ä»¥å‘ä¸€ä¸ªé¡¹ç›® push é•œåƒï¼Œå–å†³äºæƒé™(è§’è‰²)è®¾ç½®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œåœ¨é¡¹ç›®ä¸­å¯ä»¥è®¾ç½®æˆå‘˜å’Œå…¶æƒé™</strong></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_projectuser.png" alt="hexo_docker_harbor_projectuser" /></p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_projectuserrole.png" alt="hexo_docker_harbor_projectuserrole" /></p>

<p><strong>å¯¹äºæƒé™(è§’è‰²)ï¼Œ<code class="highlighter-rouge">Project Admin</code> å’Œ <code class="highlighter-rouge">Developer</code> å¯ä»¥æœ‰ push çš„æƒé™ï¼Œè€Œ <code class="highlighter-rouge">Guest</code> åªèƒ½æŸ¥çœ‹å’Œ pull</strong></p>

<h4 id="443push-é•œåƒ">4.4.3ã€push é•œåƒ</h4>

<p>é¦–å…ˆä½¿ç”¨ä¸€ä¸ªå¯¹ç›®æ ‡é¡¹ç›®å…·æœ‰ push æƒé™çš„ç”¨æˆ·ç™»å½•ï¼Œä»¥ä¸‹ push çš„ç›®æ ‡æ˜¯ mritd é¡¹ç›®ï¼Œtest1 ç”¨æˆ·åœ¨é¡¹ç›®é‡Œå®šä¹‰ä¸º <code class="highlighter-rouge">Developer</code>ï¼Œæ‰€ä»¥ç™»å½•å push å³å¯</p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_loginmritd.png" alt="hexo_docker_harbor_loginmritd" /></p>

<p>ç„¶å <code class="highlighter-rouge">tag</code> ä¸€ä¸ª imageï¼Œåç§°ä¸€å®šè¦æ ‡å‡†( <code class="highlighter-rouge">registryAddress[:ç«¯å£]/é¡¹ç›®/imageName[:tag]</code> )ï¼Œæœ€åå°†å…¶ push å³å¯</p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_pushmritdimages.png" alt="hexo_docker_harbor_pushmritdimages" /></p>

<p>æœ€åå¯åœ¨ Web UI ä¸­æŸ¥çœ‹åˆšåˆš push çš„ image</p>

<p><img src="https://cdn.oss.link/markdown/hexo_docker_harbor_mritdshow.png" alt="hexo_docker_harbor_mritdshow" /></p>

<p><strong>åˆ°æ­¤ç»“æŸ Thanks</strong>
è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET