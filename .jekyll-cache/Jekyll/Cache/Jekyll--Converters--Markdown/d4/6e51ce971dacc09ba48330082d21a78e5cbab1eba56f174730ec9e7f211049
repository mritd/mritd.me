I"^Ş<blockquote>
  <p>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ä½¿ç”¨ <code class="highlighter-rouge">rbac.authorization.k8s.io</code> API ç»„æ¥å®ç°æƒé™æ§åˆ¶ï¼ŒRBAC å…è®¸ç®¡ç†å‘˜é€šè¿‡ Kubernetes API åŠ¨æ€çš„é…ç½®æƒé™ç­–ç•¥ã€‚<strong>åœ¨ 1.6 ç‰ˆæœ¬ä¸­ RBAC è¿˜å¤„äº Beat é˜¶æ®µ</strong>ï¼Œå¦‚æœæƒ³è¦å¼€å¯ RBAC æˆæƒæ¨¡å¼éœ€è¦åœ¨ apiserver ç»„ä»¶ä¸­æŒ‡å®š <code class="highlighter-rouge">--authorization-mode=RBAC</code> é€‰é¡¹ã€‚</p>
</blockquote>

<h3 id="ä¸€api-overview">ä¸€ã€API Overview</h3>

<p>æœ¬èŠ‚ä»‹ç»äº† RBAC çš„å››ä¸ªé¡¶çº§ç±»å‹ï¼Œç”¨æˆ·å¯ä»¥åƒä¸å…¶ä»– Kubernetes API èµ„æºä¸€æ ·é€šè¿‡ kubectlã€API è°ƒç”¨æ–¹å¼ä¸å…¶äº¤äº’ï¼›ä¾‹å¦‚ä½¿ç”¨ <code class="highlighter-rouge">kubectl create -f (resource).yml</code> å‘½ä»¤åˆ›å»ºèµ„æºå¯¹è±¡ï¼Œè·Ÿéšæœ¬æ–‡æ¡£æ“ä½œå‰æœ€å¥½å…ˆé˜…è¯»å¼•å¯¼éƒ¨åˆ†ã€‚</p>

<h4 id="11role-and-clusterrole">1.1ã€Role and ClusterRole</h4>

<p>åœ¨ RBAC API ä¸­ï¼ŒRole è¡¨ç¤ºä¸€ç»„è§„åˆ™æƒé™ï¼Œæƒé™åªä¼šå¢åŠ (ç´¯åŠ æƒé™)ï¼Œä¸å­˜åœ¨ä¸€ä¸ªèµ„æºä¸€å¼€å§‹å°±æœ‰å¾ˆå¤šæƒé™è€Œé€šè¿‡ RBAC å¯¹å…¶è¿›è¡Œå‡å°‘çš„æ“ä½œï¼›Role å¯ä»¥å®šä¹‰åœ¨ä¸€ä¸ª namespace ä¸­ï¼Œå¦‚æœæƒ³è¦è·¨ namespace åˆ™å¯ä»¥åˆ›å»º ClusterRoleã€‚</p>

<p><strong>Role åªèƒ½ç”¨äºæˆäºˆå¯¹å•ä¸ªå‘½åç©ºé—´ä¸­çš„èµ„æºè®¿é—®æƒé™ï¼Œ</strong> ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¯¹é»˜è®¤å‘½åç©ºé—´ä¸­ Pods å…·æœ‰è®¿é—®æƒé™çš„æ ·ä¾‹:</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod-reader</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span> <span class="c1"># "" indicates the core API group</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
</code></pre></div></div>

<p>ClusterRole å…·æœ‰ä¸ Role ç›¸åŒçš„æƒé™è§’è‰²æ§åˆ¶èƒ½åŠ›ï¼Œä¸åŒçš„æ˜¯ ClusterRole æ˜¯é›†ç¾¤çº§åˆ«çš„ï¼ŒClusterRole å¯ä»¥ç”¨äº:</p>

<ul>
  <li>é›†ç¾¤çº§åˆ«çš„èµ„æºæ§åˆ¶(ä¾‹å¦‚ node è®¿é—®æƒé™)</li>
  <li>éèµ„æºå‹ endpoints(ä¾‹å¦‚ <code class="highlighter-rouge">/healthz</code> è®¿é—®)</li>
  <li>æ‰€æœ‰å‘½åç©ºé—´èµ„æºæ§åˆ¶(ä¾‹å¦‚ pods)</li>
</ul>

<p>ä»¥ä¸‹æ˜¯ ClusterRole æˆæƒæŸä¸ªç‰¹å®šå‘½åç©ºé—´æˆ–å…¨éƒ¨å‘½åç©ºé—´(å–å†³äº<a href="https://kubernetes.io/docs/admin/authorization/rbac/#rolebinding-and-clusterrolebinding">ç»‘å®šæ–¹å¼</a>)è®¿é—® secrets çš„æ ·ä¾‹</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="c1"># "namespace" omitted since ClusterRoles are not namespaced</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">secret-reader</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">secrets"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
</code></pre></div></div>

<h4 id="12rolebinding-and-clusterrolebinding">1.2ã€RoleBinding and ClusterRoleBinding</h4>

<p>RoloBinding å¯ä»¥å°†è§’è‰²ä¸­å®šä¹‰çš„æƒé™æˆäºˆç”¨æˆ·æˆ–ç”¨æˆ·ç»„ï¼ŒRoleBinding åŒ…å«ä¸€ç»„æƒé™åˆ—è¡¨(subjects)ï¼Œæƒé™åˆ—è¡¨ä¸­åŒ…å«æœ‰ä¸åŒå½¢å¼çš„å¾…æˆäºˆæƒé™èµ„æºç±»å‹(users, groups, or service accounts)ï¼›RoloBinding åŒæ ·åŒ…å«å¯¹è¢« Bind çš„ Role å¼•ç”¨ï¼›RoleBinding é€‚ç”¨äºæŸä¸ªå‘½åç©ºé—´å†…æˆæƒï¼Œè€Œ ClusterRoleBinding é€‚ç”¨äºé›†ç¾¤èŒƒå›´å†…çš„æˆæƒã€‚</p>

<p>RoleBinding å¯ä»¥åœ¨åŒä¸€å‘½åç©ºé—´ä¸­å¼•ç”¨å¯¹åº”çš„ Roleï¼Œä»¥ä¸‹ RoleBinding æ ·ä¾‹å°† default å‘½åç©ºé—´çš„ <code class="highlighter-rouge">pod-reader</code> Role æˆäºˆ jane ç”¨æˆ·ï¼Œæ­¤å jane ç”¨æˆ·åœ¨ default å‘½åç©ºé—´ä¸­å°†å…·æœ‰ <code class="highlighter-rouge">pod-reader</code> çš„æƒé™</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This role binding allows "jane" to read pods in the "default" namespace.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">read-pods</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">jane</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod-reader</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p><strong>RoleBinding åŒæ ·å¯ä»¥å¼•ç”¨ ClusterRole æ¥å¯¹å½“å‰ namespace å†…ç”¨æˆ·ã€ç”¨æˆ·ç»„æˆ– ServiceAccount è¿›è¡Œæˆæƒï¼Œè¿™ç§æ“ä½œå…è®¸é›†ç¾¤ç®¡ç†å‘˜åœ¨æ•´ä¸ªé›†ç¾¤å†…å®šä¹‰ä¸€äº›é€šç”¨çš„ ClusterRoleï¼Œç„¶ååœ¨ä¸åŒçš„ namespace ä¸­ä½¿ç”¨ RoleBinding æ¥å¼•ç”¨</strong></p>

<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹ RoleBinding å¼•ç”¨äº†ä¸€ä¸ª ClusterRoleï¼Œè¿™ä¸ª ClusterRole å…·æœ‰æ•´ä¸ªé›†ç¾¤å†…å¯¹ secrets çš„è®¿é—®æƒé™ï¼›ä½†æ˜¯å…¶æˆæƒç”¨æˆ· <code class="highlighter-rouge">dave</code> åªèƒ½è®¿é—® development ç©ºé—´ä¸­çš„ secrets(å› ä¸º RoleBinding å®šä¹‰åœ¨ development å‘½åç©ºé—´)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This role binding allows "dave" to read secrets in the "development" namespace.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">read-secrets</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">development</span> <span class="c1"># This only grants permissions within the "development" namespace.</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dave</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">secret-reader</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æœ€åï¼Œä½¿ç”¨ ClusterRoleBinding å¯ä»¥å¯¹æ•´ä¸ªé›†ç¾¤ä¸­çš„æ‰€æœ‰å‘½åç©ºé—´èµ„æºæƒé™è¿›è¡Œæˆæƒï¼›ä»¥ä¸‹ ClusterRoleBinding æ ·ä¾‹å±•ç¤ºäº†æˆæƒ manager ç»„å†…æ‰€æœ‰ç”¨æˆ·åœ¨å…¨éƒ¨å‘½åç©ºé—´ä¸­å¯¹ secrets è¿›è¡Œè®¿é—®</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This cluster role binding allows anyone in the "manager" group to read secrets in any namespace.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">read-secrets-global</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">manager</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">secret-reader</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<h4 id="13referring-to-resources">1.3ã€Referring to Resources</h4>

<p>Kubernetes é›†ç¾¤å†…ä¸€äº›èµ„æºä¸€èˆ¬ä»¥å…¶åç§°å­—ç¬¦ä¸²æ¥è¡¨ç¤ºï¼Œè¿™äº›å­—ç¬¦ä¸²ä¸€èˆ¬ä¼šåœ¨ API çš„ URL åœ°å€ä¸­å‡ºç°ï¼›åŒæ—¶æŸäº›èµ„æºä¹Ÿä¼šåŒ…å«å­èµ„æºï¼Œä¾‹å¦‚ logs èµ„æºå°±å±äº pods çš„å­èµ„æºï¼ŒAPI ä¸­ URL æ ·ä¾‹å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /api/v1/namespaces/<span class="o">{</span>namespace<span class="o">}</span>/pods/<span class="o">{</span>name<span class="o">}</span>/log
</code></pre></div></div>

<p><strong>å¦‚æœè¦åœ¨ RBAC æˆæƒæ¨¡å‹ä¸­æ§åˆ¶è¿™äº›å­èµ„æºçš„è®¿é—®æƒé™ï¼Œå¯ä»¥é€šè¿‡ <code class="highlighter-rouge">/</code> åˆ†éš”ç¬¦æ¥å®ç°</strong>ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªå®šä¹‰ pods èµ„èµ„æº logs è®¿é—®æƒé™çš„ Role å®šä¹‰æ ·ä¾‹</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">pod-and-pod-logs-reader</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">pods/log"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å…·ä½“çš„èµ„æºå¼•ç”¨å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">resourceNames</code> æ¥å®šä¹‰ï¼Œå½“æŒ‡å®š <code class="highlighter-rouge">get</code>ã€<code class="highlighter-rouge">delete</code>ã€<code class="highlighter-rouge">update</code>ã€<code class="highlighter-rouge">patch</code> å››ä¸ªåŠ¨è¯æ—¶ï¼Œå¯ä»¥æ§åˆ¶å¯¹å…¶ç›®æ ‡èµ„æºçš„ç›¸åº”åŠ¨ä½œï¼›ä»¥ä¸‹ä¸ºé™åˆ¶ä¸€ä¸ª subject å¯¹åç§°ä¸º my-configmap çš„ configmap åªèƒ½å…·æœ‰ <code class="highlighter-rouge">get</code> å’Œ <code class="highlighter-rouge">update</code> æƒé™çš„æ ·ä¾‹</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">configmap-updater</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">configmap"</span><span class="pi">]</span>
  <span class="na">resourceNames</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">my-configmap"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">update"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">get"</span><span class="pi">]</span>
</code></pre></div></div>

<p><strong>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“è®¾å®šäº† resourceNames åï¼Œverbs åŠ¨è¯ä¸èƒ½æŒ‡å®šä¸º <code class="highlighter-rouge">list</code>ã€<code class="highlighter-rouge">watch</code>ã€<code class="highlighter-rouge">create</code> å’Œ <code class="highlighter-rouge">deletecollection</code>ï¼›å› ä¸ºè¿™ä¸ªå…·ä½“çš„èµ„æºåç§°ä¸åœ¨ä¸Šé¢å››ä¸ªåŠ¨è¯é™å®šçš„è¯·æ±‚ URL åœ°å€ä¸­åŒ¹é…åˆ°ï¼Œæœ€ç»ˆä¼šå› ä¸º URL åœ°å€ä¸åŒ¹é…å¯¼è‡´ Role æ— æ³•åˆ›å»ºæˆåŠŸ</strong></p>

<h5 id="131role-examples">1.3.1ã€Role Examples</h5>

<p>ä»¥ä¸‹æ ·ä¾‹åªç»™å‡ºäº† role éƒ¨åˆ†</p>

<p>åœ¨æ ¸å¿ƒ API ç»„ä¸­å…è®¸è¯»å– <code class="highlighter-rouge">pods</code> èµ„æº</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
</code></pre></div></div>

<p>åœ¨ <code class="highlighter-rouge">extensions</code> å’Œ <code class="highlighter-rouge">apps</code> API ç»„ä¸­å…è®¸è¯»å–/å†™å…¥ <code class="highlighter-rouge">deployments</code></p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">extensions"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">apps"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">deployments"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">patch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">delete"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å…è®¸è¯»å– <code class="highlighter-rouge">pods</code> èµ„æºï¼Œå…è®¸è¯»å–/å†™å…¥ <code class="highlighter-rouge">jobs</code> èµ„æº</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">batch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">extensions"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">jobs"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">patch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">delete"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å…è®¸è¯»å–åç§°ä¸º <code class="highlighter-rouge">my-config</code> çš„ ConfigMap(éœ€è¦ä¸ RoleBinding ç»‘å®šæ¥é™åˆ¶æŸä¸ªç‰¹å®šå‘½åç©ºé—´å’ŒæŒ‡å®šåå­—çš„ ConfigMap)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">configmaps"</span><span class="pi">]</span>
  <span class="na">resourceNames</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">my-config"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å…è®¸åœ¨æ ¸å¿ƒç»„ä¸­è¯»å– <code class="highlighter-rouge">nodes</code> èµ„æº( Node æ˜¯é›†ç¾¤èŒƒå›´å†…çš„èµ„æºï¼Œéœ€è¦ä½¿ç”¨ ClusterRole å¹¶ä¸”ä¸ ClusterRoleBinding ç»‘å®šæ‰èƒ½è¿›è¡Œé™åˆ¶)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">nodes"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span>
</code></pre></div></div>

<p>å…è®¸å¯¹éèµ„æºå‹ endpoint <code class="highlighter-rouge">/healthz</code> å’Œå…¶å­è·¯å¾„ <code class="highlighter-rouge">/healthz/*</code> è¿›è¡Œ <code class="highlighter-rouge">GET</code> å’Œ <code class="highlighter-rouge">POST</code> è¯·æ±‚(åŒæ ·éœ€è¦ä½¿ç”¨ ClusterRole å’Œ ClusterRoleBinding æ‰èƒ½ç”Ÿæ•ˆ)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">nonResourceURLs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/healthz"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/healthz/*"</span><span class="pi">]</span> <span class="c1"># '*' in a nonResourceURL is a suffix glob match</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">post"</span><span class="pi">]</span>
</code></pre></div></div>

<h4 id="14referring-to-subjects">1.4ã€Referring to Subjects</h4>

<p>RoleBinding å’Œ ClusterRoleBinding å¯ä»¥å°† Role ç»‘å®šåˆ° Subjectsï¼›Subjects å¯ä»¥æ˜¯ groupsã€users æˆ–è€… service accountsã€‚</p>

<p>Subjects ä¸­ Users ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šçš„åå­—å­—ç¬¦ä¸²ï¼Œå¦‚ â€œaliceâ€ï¼›ä¹Ÿå¯ä»¥æ˜¯ email æ ¼å¼çš„é‚®ç®±åœ°å€ï¼Œå¦‚ â€œbob@example.comâ€ï¼›ç”šè‡³æ˜¯ä¸€ç»„å­—ç¬¦ä¸²å½¢å¼çš„æ•°å­— IDã€‚Users çš„æ ¼å¼å¿…é¡»æ»¡è¶³é›†ç¾¤ç®¡ç†å‘˜é…ç½®çš„<a href="https://kubernetes.io/docs/admin/authentication/">éªŒè¯æ¨¡å—</a>ï¼ŒRBAC æˆæƒç³»ç»Ÿä¸­æ²¡æœ‰å¯¹å…¶åšä»»ä½•æ ¼å¼é™å®šï¼›<strong>ä½†æ˜¯ Users çš„å‰ç¼€ <code class="highlighter-rouge">system:</code> æ˜¯ç³»ç»Ÿä¿ç•™çš„ï¼Œé›†ç¾¤ç®¡ç†å‘˜åº”è¯¥ç¡®ä¿æ™®é€šç”¨æˆ·ä¸ä¼šä½¿ç”¨è¿™ä¸ªå‰ç¼€æ ¼å¼</strong></p>

<p>Kubernetes çš„ Group ä¿¡æ¯ç›®å‰ç”± Authenticator æ¨¡å—æä¾›ï¼ŒGroups ä¹¦å†™æ ¼å¼ä¸ Users ç›¸åŒï¼Œéƒ½ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æ²¡æœ‰ç‰¹å®šçš„æ ¼å¼è¦æ±‚ï¼›<strong>åŒæ · <code class="highlighter-rouge">system:</code> å‰ç¼€ä¸ºç³»ç»Ÿä¿ç•™</strong></p>

<p>å…·æœ‰ <code class="highlighter-rouge">system:serviceaccount:</code> å‰ç¼€çš„ç”¨æˆ·åå’Œ <code class="highlighter-rouge">system:serviceaccounts:</code> å‰ç¼€çš„ç»„ä¸º <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/">Service Accounts</a></p>

<h5 id="141role-binding-examples">1.4.1ã€Role Binding Examples</h5>

<p>ä»¥ä¸‹ç¤ºä¾‹ä»…å±•ç¤º RoleBinding çš„ subjects éƒ¨åˆ†</p>

<p>æŒ‡å®šä¸€ä¸ªåå­—ä¸º <code class="highlighter-rouge">alice@example.com</code> çš„ç”¨æˆ·</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">alice@example.com"</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æŒ‡å®šä¸€ä¸ªåå­—ä¸º <code class="highlighter-rouge">frontend-admins</code> çš„ç»„</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">frontend-admins"</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æŒ‡å®š kube-system namespace ä¸­é»˜è®¤çš„ Service Account</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">default</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
</code></pre></div></div>

<p>æŒ‡å®šåœ¨ qa namespace ä¸­å…¨éƒ¨çš„ Service Account</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:serviceaccounts:qa</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æŒ‡å®šå…¨éƒ¨ namspace ä¸­çš„å…¨éƒ¨ Service Account</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:serviceaccounts</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æŒ‡å®šå…¨éƒ¨çš„ authenticated ç”¨æˆ·(1.5+)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:authenticated</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æŒ‡å®šå…¨éƒ¨çš„ unauthenticated ç”¨æˆ·(1.5+)</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:unauthenticated</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<p>æŒ‡å®šå…¨éƒ¨ç”¨æˆ·</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:authenticated</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:unauthenticated</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
</code></pre></div></div>

<h3 id="äºŒdefault-roles-and-role-bindings">äºŒã€Default Roles and Role Bindings</h3>

<p>é›†ç¾¤åˆ›å»ºå API Server é»˜è®¤ä¼šåˆ›å»ºä¸€äº› ClusterRole å’Œ ClusterRoleBinding å¯¹è±¡ï¼›è¿™äº›å¯¹è±¡ä»¥ <code class="highlighter-rouge">system:</code> ä¸ºå‰ç¼€ï¼Œè¿™è¡¨æ˜è¿™äº›èµ„æºå¯¹è±¡ç”±é›†ç¾¤åŸºç¡€è®¾æ–½æ‹¥æœ‰ï¼›<strong>ä¿®æ”¹è¿™äº›é›†ç¾¤åŸºç¡€è®¾æ–½æ‹¥æœ‰çš„å¯¹è±¡å¯èƒ½å¯¼è‡´é›†ç¾¤ä¸å¯ç”¨ã€‚</strong> ä¸€ä¸ªç®€å•çš„ä¾‹å­æ˜¯ <code class="highlighter-rouge">system:node</code> ClusterRoleï¼Œè¿™ä¸ª ClusterRole å®šä¹‰äº† kubelet çš„ç›¸å…³æƒé™ï¼Œå¦‚æœè¯¥ ClusterRole è¢«ä¿®æ”¹å¯èƒ½å¯¼è‡´ ClusterRole ä¸å¯ç”¨ã€‚</p>

<p><strong>æ‰€æœ‰çš„é»˜è®¤ ClusterRole å’Œ RoleBinding éƒ½å…·æœ‰ <code class="highlighter-rouge">kubernetes.io/bootstrapping=rbac-defaults</code> lable</strong></p>

<h4 id="21auto-reconciliation">2.1ã€Auto-reconciliation</h4>

<p>API Server åœ¨æ¯æ¬¡å¯åŠ¨åéƒ½ä¼šæ›´æ–°å·²ç»ä¸¢å¤±çš„é»˜è®¤ ClusterRole å’Œ å…¶ç»‘å®šçš„ç›¸å…³ Subjectsï¼›è¿™å°†å…è®¸é›†ç¾¤è‡ªåŠ¨ä¿®å¤å› ä¸ºæ„å¤–æ›´æ”¹å¯¼è‡´çš„ RBAC æˆæƒé”™è¯¯ï¼ŒåŒæ—¶èƒ½å¤Ÿä½¿åœ¨å‡çº§é›†ç¾¤ååŸºç¡€è®¾æ–½çš„ RBAC æˆæƒå¾—ä»¥è‡ªåŠ¨æ›´æ–°ã€‚</p>

<p><strong>å¦‚æœæƒ³è¦å…³é—­ API Server çš„è‡ªåŠ¨ä¿®å¤åŠŸèƒ½ï¼Œåªéœ€è¦å°†é»˜è®¤åˆ›å»ºçš„ ClusterRole å’Œå…¶ RoleBind çš„ <code class="highlighter-rouge">rbac.authorization.kubernetes.io/autoupdate</code> æ³¨è§£è®¾ç½®ä¸º false å³å¯ï¼Œè¿™æ ·åšä¼šæœ‰å¾ˆå¤§é£é™©å¯¼è‡´é›†ç¾¤å› ä¸ºæ„å¤–ä¿®æ”¹ RBAC è€Œæ— æ³•å·¥ä½œ</strong></p>

<p><strong>Auto-reconciliation åœ¨ 1.6+ ç‰ˆæœ¬è¢«é»˜è®¤å¯ç”¨(å½“ RBAC æˆæƒè¢«æ¿€æ´»æ—¶)</strong></p>

<h4 id="22discovery-roles">2.2ã€Discovery Roles</h4>

<table>
  <thead>
    <tr>
      <th>Default ClusterRole</th>
      <th>Default ClusterRoleBinding</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>system:basic-user</td>
      <td>system:authenticated and system:unauthenticated groups</td>
      <td>å…è®¸ç”¨æˆ·ä»¥åªè¯»çš„æ–¹å¼è¯»å–å…¶åŸºç¡€ä¿¡æ¯</td>
    </tr>
    <tr>
      <td>system:discovery</td>
      <td>system:authenticated and system:unauthenticated groups</td>
      <td>å…è®¸ä»¥åªè¯»çš„å½¢å¼è®¿é—® å‘ç°å’Œåå•† API Level æ‰€éœ€çš„ API discovery endpoints</td>
    </tr>
  </tbody>
</table>

<h4 id="23user-facing-roles">2.3ã€User-facing Roles</h4>

<p>ä¸€äº›é»˜è®¤çš„ Role å¹¶æœªä»¥ <code class="highlighter-rouge">system:</code> å‰ç¼€å¼€å¤´ï¼Œè¿™è¡¨æ˜è¿™äº›é»˜è®¤çš„ Role æ˜¯é¢å‘ç”¨æˆ·çº§åˆ«çš„ã€‚è¿™å…¶ä¸­åŒ…æ‹¬è¶…çº§ç”¨æˆ·çš„ä¸€äº› Role( <code class="highlighter-rouge">cluster-admin</code> )ï¼Œå’Œä¸ºé¢å‘é›†ç¾¤èŒƒå›´æˆæƒçš„ RoleBinding( <code class="highlighter-rouge">cluster-status</code> )ï¼Œä»¥åŠåœ¨ç‰¹å®šå‘½åç©ºé—´ä¸­æˆæƒçš„ RoleBinding( <code class="highlighter-rouge">admin</code>ï¼Œ<code class="highlighter-rouge">edit</code>ï¼Œ<code class="highlighter-rouge">view</code> )</p>

<table>
  <thead>
    <tr>
      <th>Default ClusterRole</th>
      <th>Default ClusterRoleBinding</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cluster-admin</td>
      <td>system:masters group</td>
      <td>å…è®¸è¶…çº§ç”¨æˆ·å¯¹é›†ç¾¤å†…ä»»æ„èµ„æºæ‰§è¡Œä»»ä½•åŠ¨ä½œã€‚å½“è¯¥ Role ç»‘å®šåˆ° ClusterRoleBinding æ—¶ï¼Œå°†æˆäºˆç›®æ ‡ subject åœ¨ä»»æ„ namespace å†…å¯¹ä»»ä½• resource æ‰§è¡Œä»»ä½•åŠ¨ä½œçš„æƒé™ï¼›å½“ç»‘å®šåˆ° RoleBinding æ—¶ï¼Œå°†æˆäºˆç›®æ ‡ subject åœ¨å½“å‰ namespace å†…å¯¹ä»»æ„ resource æ‰§è¡Œä»»ä½•åŠ¨ä½œçš„æƒé™ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ namespace è‡ªå·±</td>
    </tr>
    <tr>
      <td>admin</td>
      <td>None</td>
      <td>ç®¡ç†å‘˜æƒé™ï¼Œç”¨äºåœ¨å•ä¸ª namespace å†…æˆæƒï¼›åœ¨ä¸æŸä¸ª RoleBinding ç»‘å®šåæä¾›åœ¨å•ä¸ª namesapce ä¸­å¯¹èµ„æºçš„è¯»å†™æƒé™ï¼ŒåŒ…æ‹¬åœ¨å•ä¸ª namesapce å†…åˆ›å»º Role å’Œè¿›è¡Œ RoleBinding çš„æƒé™ã€‚<strong>è¯¥ ClusterRole ä¸å…è®¸å¯¹èµ„æºé…é¢å’Œ namespace æœ¬èº«è¿›è¡Œä¿®æ”¹</strong></td>
    </tr>
    <tr>
      <td>edit</td>
      <td>None</td>
      <td>å…è®¸è¯»å†™æŒ‡å®š namespace ä¸­çš„å¤§å¤šæ•°èµ„æºå¯¹è±¡ï¼›<strong>è¯¥ ClusterRole ä¸å…è®¸æŸ¥çœ‹æˆ–ä¿®æ”¹ Role å’Œ RoleBinding</strong></td>
    </tr>
    <tr>
      <td>view</td>
      <td>None</td>
      <td>å…è®¸ä»¥åªè¯»æ–¹å¼è®¿é—®ç‰¹å®š namespace ä¸­çš„å¤§å¤šæ•°èµ„æºå¯¹è±¡ï¼›<strong>è¯¥ ClusterRole ä¸å…è®¸æŸ¥çœ‹ Role æˆ– RoleBindingï¼ŒåŒæ—¶ä¸å…è®¸æŸ¥çœ‹ secretsï¼Œå› ä¸ºä»–ä»¬ä¼šä¸æ–­æ›´æ–°</strong></td>
    </tr>
  </tbody>
</table>

<h4 id="24core-component-roles">2.4ã€Core Component Roles</h4>

<table>
  <thead>
    <tr>
      <th>Default ClusterRole</th>
      <th>Default ClusterRoleBinding</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>system:kube-scheduler</td>
      <td>system:kube-scheduler user</td>
      <td>å…è®¸è®¿é—® kube-scheduler æ‰€éœ€èµ„æº</td>
    </tr>
    <tr>
      <td>system:kube-controller-manager</td>
      <td>system:kube-controller-manager user</td>
      <td>å…è®¸è®¿é—® kube-controller-manager æ‰€éœ€èµ„æºï¼›<a href="https://kubernetes.io/docs/admin/authorization/rbac/#controller-roles">è¯¥ ClusterRole</a> åŒ…å«æ¯ä¸ªæ§åˆ¶å¾ªç¯æ‰€éœ€è¦çš„æƒé™</td>
    </tr>
    <tr>
      <td>system:node</td>
      <td>system:nodes group (deprecated in 1.7)</td>
      <td>å…è®¸è®¿é—® kubelet æ‰€éœ€èµ„æºï¼›åŒ…æ‹¬å¯¹æ‰€æœ‰çš„ secrets è¯»è®¿é—®æƒé™å’Œå¯¹æ‰€æœ‰ pod çš„å†™æƒé™ï¼›åœ¨ 1.7 ä¸­æ›´æ¨èä½¿ç”¨ <a href="/docs/admin/authorization/node/">Node authorizer</a> å’Œ <a href="/docs/admin/admission-controllers#NodeRestriction">NodeRestriction admission plugin</a> è€Œéæœ¬ ClusterRoleï¼›Node authorizer å’Œ NodeRestriction admission plugin å¯ä»¥æˆæƒå½“å‰ node ä¸Šè¿è¡Œçš„å…·ä½“ pod å¯¹ kubelet API çš„è®¿é—®æƒé™ï¼Œ<strong>åœ¨ 1.7 ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœå¼€å¯äº† <code class="highlighter-rouge">Node authorization mode</code>ï¼Œé‚£ä¹ˆ <code class="highlighter-rouge">system:nodes</code> groupå°†ä¸ä¼šè¢«åˆ›å»ºå’Œè‡ªåŠ¨ç»‘å®š</strong></td>
    </tr>
    <tr>
      <td>system:node-proxier</td>
      <td>system:kube-proxy user</td>
      <td>å…è®¸è®¿é—® kube-proxy æ‰€éœ€èµ„æº</td>
    </tr>
  </tbody>
</table>

<h4 id="25other-component-roles">2.5ã€Other Component Roles</h4>

<table>
  <thead>
    <tr>
      <th>Default ClusterRole</th>
      <th>Default ClusterRoleBinding</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>system:auth-delegator</td>
      <td>None</td>
      <td>å…è®¸å§”æ‰˜è®¤è¯å’Œæˆæƒæ£€æŸ¥ï¼›æ­¤æƒ…å†µä¸‹é€šå¸¸ç”±é™„åŠ çš„ API Server æ¥è¿›è¡Œç»Ÿä¸€è®¤è¯å’Œæˆæƒ</td>
    </tr>
    <tr>
      <td>system:heapster</td>
      <td>None</td>
      <td><a href="https://github.com/kubernetes/heapster">Heapster</a> ç»„ä»¶ç›¸å…³æƒé™</td>
    </tr>
    <tr>
      <td>system:kube-aggregator</td>
      <td>None</td>
      <td><a href="https://github.com/kubernetes/kube-aggregator">kube-aggregator</a> ç›¸å…³æƒé™</td>
    </tr>
    <tr>
      <td>system:kube-dns</td>
      <td>kube-dns service account in the kube-system namespace</td>
      <td><a href="https://kubernetes.io/docs/admin/dns/">kube-dns</a> ç›¸å…³æƒé™</td>
    </tr>
    <tr>
      <td>system:node-bootstrapper</td>
      <td>None</td>
      <td>å…è®¸è®¿é—® <a href="https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/">Kubelet TLS bootstrapping</a> ç›¸å…³èµ„æºæƒé™</td>
    </tr>
    <tr>
      <td>system:node-problem-detector</td>
      <td>None</td>
      <td><a href="https://github.com/kubernetes/node-problem-detector">node-problem-detector</a> ç›¸å…³æƒé™</td>
    </tr>
    <tr>
      <td>system:persistent-volume-provisioner</td>
      <td>Node</td>
      <td>å…è®¸è®¿é—® <a href="https://kubernetes.io/docs/user-guide/persistent-volumes/#provisioner">dynamic volume provisioners</a> ç›¸å…³èµ„æºæƒé™</td>
    </tr>
  </tbody>
</table>

<h4 id="26controller-roles">2.6ã€Controller Roles</h4>

<p><a href="https://kubernetes.io/docs/admin/kube-controller-manager/">Kubernetes controller manager</a> è¿è¡Œç€ä¸€äº›æ ¸å¿ƒçš„ <code class="highlighter-rouge">control loops</code>ï¼Œ<strong>å½“ä½¿ç”¨ <code class="highlighter-rouge">--use-service-account-credentials</code> å‚æ•°å¯åŠ¨æ—¶ï¼Œæ¯ä¸ª <code class="highlighter-rouge">control loop</code> éƒ½ä¼šä½¿ç”¨ç‹¬ç«‹çš„ <code class="highlighter-rouge">Service Account</code> å¯åŠ¨ï¼›ç›¸åº”çš„ roles ä¼šä»¥ <code class="highlighter-rouge">system:controller</code> å‰ç¼€å­˜åœ¨äºæ¯ä¸ª control loop ä¸­ï¼›å¦‚æœä¸æŒ‡å®šè¯¥é€‰é¡¹ï¼Œé‚£ä¹ˆ Kubernetes controller manager å°†ä¼šä½¿ç”¨è‡ªå·±çš„å‡­æ®æ¥è¿è¡Œæ‰€æœ‰ <code class="highlighter-rouge">control loops</code>ï¼Œæ­¤æ—¶å¿…é¡»ä¿è¯ RBAC æˆæƒæ¨¡å‹ä¸­æˆäºˆäº†å…¶æ‰€æœ‰ç›¸å…³ Roleï¼Œå¦‚ä¸‹:</strong></p>

<ul>
  <li>system:controller:attachdetach-controller</li>
  <li>system:controller:certificate-controller</li>
  <li>system:controller:cronjob-controller</li>
  <li>system:controller:daemon-set-controller</li>
  <li>system:controller:deployment-controller</li>
  <li>system:controller:disruption-controller</li>
  <li>system:controller:endpoint-controller</li>
  <li>system:controller:generic-garbage-collector</li>
  <li>system:controller:horizontal-pod-autoscaler</li>
  <li>system:controller:job-controller</li>
  <li>system:controller:namespace-controller</li>
  <li>system:controller:node-controller</li>
  <li>system:controller:persistent-volume-binder</li>
  <li>system:controller:pod-garbage-collector</li>
  <li>system:controller:replicaset-controller</li>
  <li>system:controller:replication-controller</li>
  <li>system:controller:resourcequota-controller</li>
  <li>system:controller:route-controller</li>
  <li>system:controller:service-account-controller</li>
  <li>system:controller:service-controller</li>
  <li>system:controller:statefulset-controller</li>
  <li>system:controller:ttl-controller</li>
</ul>

<h3 id="ä¸‰privilege-escalation-prevention-and-bootstrapping">ä¸‰ã€Privilege Escalation Prevention and Bootstrapping</h3>

<p>RBAC API ä¼šé€šè¿‡é˜»æ­¢ç”¨æˆ·ç¼–è¾‘ Role æˆ– RoleBinding æ¥è¿›è¡Œç‰¹æƒå‡çº§ï¼ŒRBAC åœ¨ API çº§åˆ«å®ç°äº†è¿™ä¸€æœºåˆ¶ï¼Œæ‰€ä»¥å³ä½¿ RBAC authorizer ä¸è¢«ä½¿ç”¨ä¹Ÿé€‚ç”¨ã€‚</p>

<p><strong>ç”¨æˆ·å³ä½¿åœ¨å¯¹æŸä¸ª Role æ‹¥æœ‰å…¨éƒ¨æƒé™çš„æƒ…å†µä¸‹ä¹Ÿä»…èƒ½åœ¨å…¶ä½œç”¨èŒƒå›´å†…(ClusterRole -&gt; é›†ç¾¤èŒƒå›´å†…ï¼ŒRole -&gt; å½“å‰ namespace æˆ– é›†ç¾¤èŒƒå›´)å¯¹å…¶è¿›è¡Œ create å’Œ update æ“ä½œï¼›</strong> ä¾‹å¦‚ â€œuser-1â€ ç”¨æˆ·ä¸å…·æœ‰åœ¨é›†ç¾¤èŒƒå›´å†…åˆ—å‡º secrets çš„æƒé™ï¼Œé‚£ä¹ˆä»–ä¹Ÿæ— æ³•åœ¨é›†ç¾¤èŒƒå›´å†…åˆ›å»ºå…·æœ‰è¯¥æƒé™çš„ ClusterRoleï¼Œä¹Ÿå°±æ˜¯è¯´æƒ³ä¼ é€’æƒé™å¿…é¡»å…ˆè·å¾—è¯¥æƒé™ï¼›æƒ³è¦å…è®¸ç”¨æˆ· cretae/update Role æœ‰ä¸¤ç§æ–¹å¼:</p>

<ul>
  <li>1ã€æˆäºˆä¸€ä¸ªè¯¥ç”¨æˆ·æœŸæœ› create/update çš„ Role æˆ–è€… ClusterRole</li>
  <li>2ã€æˆäºˆä¸€ä¸ªåŒ…å«è¯¥ç”¨æˆ·æœŸæœ› create/update çš„ Role æˆ–è€… ClusterRole çš„ Role æˆ–è€… ClusterRole(æœ‰ç‚¹ç»•â€¦)ï¼›å¦‚æœç”¨æˆ·å°è¯• crate/update ä¸€ä¸ªå…¶ä¸æ‹¥æœ‰çš„ Role æˆ–è€… ClusterRoleï¼Œåˆ™ API ä¼šç¦æ­¢</li>
</ul>

<p><strong>ç”¨æˆ·åªæœ‰æ‹¥æœ‰äº†ä¸€ä¸ª RoleBind å¼•ç”¨çš„ Role å…¨éƒ¨æƒé™ï¼Œæˆ–è€…è¢«æ˜¾ç¤ºæˆäºˆäº†å¯¹å…¶å…·æœ‰ bind çš„æƒé™ä¸‹ï¼Œæ‰èƒ½åœ¨å…¶ä½œç”¨èŒƒå›´(èŒƒå›´åŒä¸Š)å†…å¯¹å…¶è¿›è¡Œ create/update æ“ä½œï¼›</strong> ä¾‹å¦‚ â€œuser-1â€ åœ¨ä¸å…·æœ‰åˆ—å‡ºé›†ç¾¤å†… secrets æƒé™çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¸å¯èƒ½ä¸ºå…·æœ‰è¯¥æƒé™çš„ Role åˆ›å»º ClusterRoleBindingï¼›å¦‚æœæƒ³è¦ç”¨æˆ·å…·æœ‰ create/update ClusterRoleBinding çš„æƒé™æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼:</p>

<ul>
  <li>1ã€æˆäºˆä¸€ä¸ªè¯¥ç”¨æˆ·æœŸæœ› create/update çš„ RoleBinding æˆ–è€… ClusterRoleBinding çš„ Role æˆ– ClusterRole çš„ Role æˆ– ClusterRole(æ±‰è¯­ä¸“8)</li>
  <li>2ã€é€šè¿‡å…¶ä»–æ–¹å¼æˆäºˆä¸€ä¸ªè¯¥ç”¨æˆ· æœŸæœ› create/update çš„ RoleBinding æˆ–è€… ClusterRoleBinding çš„æƒé™:
    <ul>
      <li>2.1ã€æˆäºˆä¸€ä¸ªåŒ…å«ç”¨æˆ·æœŸæœ› create/update çš„ RoleBinding æˆ–è€… ClusterRoleBinding çš„ Role æˆ– ClusterRole çš„ Role æˆ– ClusterRole(æˆ‘æ±‰è¯­10çº§)</li>
      <li>2.2ã€æ˜ç¡®çš„æˆäºˆç”¨æˆ·ä¸€ä¸ªåœ¨å¯¹ç‰¹å®š Role æˆ– ClusterRole è¿›è¡Œ bind çš„æƒé™</li>
    </ul>
  </li>
</ul>

<p>ä»¥ä¸‹æ ·ä¾‹ä¸­ï¼ŒClusterRole å’Œ RoleBinding å°†å…è®¸ â€œuser-1â€ ç”¨æˆ·å…·æœ‰æˆäºˆå…¶ä»–ç”¨æˆ·åœ¨ â€œuser-1-namespaceâ€ namespace ä¸‹å…·æœ‰ adminã€edit å’Œ view roles çš„æƒé™</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">role-grantor</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">rbac.authorization.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">rolebindings"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">rbac.authorization.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">clusterroles"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">bind"</span><span class="pi">]</span>
  <span class="na">resourceNames</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">admin"</span><span class="pi">,</span><span class="s2">"</span><span class="s">edit"</span><span class="pi">,</span><span class="s2">"</span><span class="s">view"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">role-grantor-binding</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">user-1-namespace</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">role-grantor</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">user-1</span>
</code></pre></div></div>

<p>å½“ä½¿ç”¨ bootstrapping æ—¶ï¼Œåˆå§‹ç”¨æˆ·å°šæ²¡æœ‰è®¿é—® API çš„æƒé™ï¼Œæ­¤æ—¶æƒ³è¦æˆäºˆä»–ä»¬ä¸€äº›å°šæœªæ‹¥æœ‰çš„æƒé™æ˜¯ä¸å¯èƒ½çš„ï¼Œæ­¤æ—¶å¯ä»¥æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ:</p>

<ul>
  <li>1ã€é€šè¿‡ä½¿ç”¨ç³»ç»Ÿçº§çš„ <code class="highlighter-rouge">system:masters</code> ç»„ä»è€Œé€šè¿‡é»˜è®¤ç»‘å®šç»‘å®šåˆ° <code class="highlighter-rouge">cluster-admin</code> è¶…çº§ç”¨æˆ·ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ²Ÿé€š API Server</li>
  <li>2ã€å¦‚æœ API Server å¼€å¯äº† <code class="highlighter-rouge">--insecure-port</code> ç«¯å£ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æ­¤ç«¯å£è°ƒç”¨å®Œæˆç¬¬ä¸€æ¬¡æˆæƒåŠ¨ä½œ</li>
</ul>

<h3 id="å››command-line-utilities">å››ã€Command-line Utilities</h3>

<p>é€šè¿‡ä¸¤ä¸ª <code class="highlighter-rouge">kubectl</code> çš„å­å‘½ä»¤å®Œæˆåœ¨ç‰¹å®šå‘½åç©ºé—´æˆ–é›†ç¾¤å†…çš„æˆæƒç®¡ç†</p>

<h4 id="41kubectl-create-rolebinding">4.1ã€kubectl create rolebinding</h4>

<p>åœ¨ç‰¹å®š namespae ä¸­åˆ›å»º Role æˆ–è€… ClusterRole çš„ RoleBinding æ ·ä¾‹</p>

<p><strong>åœ¨ acme namespace ä¸­æˆæƒç”¨æˆ· bob å…·æœ‰ admin ClusterRole çš„ RoleBinding</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create rolebinding bob-admin-binding <span class="nt">--clusterrole</span><span class="o">=</span>admin <span class="nt">--user</span><span class="o">=</span>bob <span class="nt">--namespace</span><span class="o">=</span>acme
</code></pre></div></div>

<p><strong>åœ¨ acme namespace ä¸­æˆæƒåç§°ä¸º acme:myapp çš„ service account å…·æœ‰ view ClusterRole çš„ RoleBinding</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create rolebinding myapp-view-binding <span class="nt">--clusterrole</span><span class="o">=</span>view <span class="nt">--serviceaccount</span><span class="o">=</span>acme:myapp <span class="nt">--namespace</span><span class="o">=</span>acme
</code></pre></div></div>

<h4 id="42kubectl-create-clusterrolebinding">4.2ã€kubectl create clusterrolebinding</h4>

<p>åœ¨å…¨éƒ¨å‘½åç©ºé—´ä¸­åˆ›å»º Role æˆ–è€… ClusterRole çš„ ClusterRoleBinding æ ·ä¾‹</p>

<p><strong>åœ¨æ•´ä¸ªé›†ç¾¤å†…æˆæƒ â€œrootâ€ ç”¨æˆ·å…·æœ‰ cluster-admin ClusterRole çš„ ClusterRoleBinding</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding root-cluster-admin-binding <span class="nt">--clusterrole</span><span class="o">=</span>cluster-admin <span class="nt">--user</span><span class="o">=</span>root
</code></pre></div></div>

<p><strong>åœ¨æ•´ä¸ªé›†ç¾¤å†…æˆæƒ â€œkubeletâ€ ç”¨æˆ·å…·æœ‰ system:node ClusterRole çš„ ClusterRoleBinding</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding kubelet-node-binding <span class="nt">--clusterrole</span><span class="o">=</span>system:node <span class="nt">--user</span><span class="o">=</span>kubelet
</code></pre></div></div>

<p><strong>åœ¨ â€œacmeâ€ å‘½åç©ºé—´ä¸­æˆæƒåç§°ä¸º acme:myapp çš„ service account å…·æœ‰ view ClusterRole çš„ ClusterRoleBinding</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding myapp-view-binding <span class="nt">--clusterrole</span><span class="o">=</span>view <span class="nt">--serviceaccount</span><span class="o">=</span>acme:myapp
</code></pre></div></div>

<p>æ›´è¯¦ç»†ä½¿ç”¨è¯·å‚è€ƒå‘½ä»¤è¡Œå¸®åŠ©æ–‡æ¡£</p>

<h3 id="äº”service-account-permissions">äº”ã€Service Account Permissions</h3>

<p>é»˜è®¤çš„ RBAC æƒé™ç­–ç•¥ä»…å‘ control-plane ç»„ä»¶ã€nodes å’Œ controllers è¿›è¡Œæˆæƒï¼Œä¸åŒ…æ‹¬ <code class="highlighter-rouge">kube-system</code> namespace ä»¥å¤–çš„ Service Account è¿›è¡Œæˆæƒ(é™¤äº†å‘å·²ç»è¢«éªŒè¯è¿‡çš„ç”¨æˆ·æˆäºˆçš„ discovery æƒé™ä¹‹å¤–)</p>

<p>è¿™å…è®¸ä½ æ ¹æ®éœ€è¦å‘ç‰¹å®šçš„æœåŠ¡è´¦æˆ·æˆäºˆç‰¹å®šçš„æƒé™ï¼›ç»†ç²’åº¦çš„æƒé™è§’è‰²ç»‘å®šæ§åˆ¶ä¼šæ›´åŠ å®‰å…¨ï¼Œä½†æ˜¯éœ€è¦æ›´å¤§çš„ç²¾åŠ›æ¥è¿›è¡Œæƒé™ç®¡ç†ï¼›æ›´åŠ å®½æ¾çš„æƒé™è§’è‰²ç»‘å®šæ§åˆ¶ä¹Ÿè®¸ä¼šç»™ä¸€äº›ç”¨æˆ·åˆ†é…å…¶ä¸éœ€è¦çš„æƒé™ï¼Œä½†æ˜¯ç›¸å¯¹æ¥è¯´ç®¡ç†ç›¸å¯¹æ›´åŠ å®½æ¾</p>

<p>ä»æœ€å®‰å…¨åˆ°æœ€ä¸å®‰å…¨çš„æƒé™ç®¡ç†å¦‚ä¸‹:</p>

<h4 id="51ä¸ºç‰¹å®šåº”ç”¨ç¨‹åºæŒ‡å®šçš„æœåŠ¡è´¦æˆ·æˆäºˆç‰¹å®šçš„-roleæœ€ä½³å®è·µ">5.1ã€ä¸ºç‰¹å®šåº”ç”¨ç¨‹åºæŒ‡å®šçš„æœåŠ¡è´¦æˆ·æˆäºˆç‰¹å®šçš„ Role(æœ€ä½³å®è·µ)</h4>

<p><strong>è¿™ç§æ–¹å¼éœ€è¦åº”ç”¨åœ¨ spec ä¸­è®¾ç½® serviceAccountNameï¼ŒåŒæ—¶è¿™ä¸ª SserviceAccount å¿…é¡»å·²ç»è¢«åˆ›å»º(å¯ä»¥é€šè¿‡ APIã€manifest æ–‡ä»¶æˆ–è€… é€šè¿‡å‘½ä»¤ <code class="highlighter-rouge">kubectl create serviceaccount</code> ç­‰)</strong>ã€‚ä¾‹å¦‚åœ¨ â€œmy-namespaceâ€ namespace ä¸‹æˆäºˆ â€œmy-saâ€ ServiceAccount view ClusterRole å¦‚ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create rolebinding my-sa-view <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>view <span class="se">\</span>
  <span class="nt">--serviceaccount</span><span class="o">=</span>my-namespace:my-sa <span class="se">\</span>
  <span class="nt">--namespace</span><span class="o">=</span>my-namespace
</code></pre></div></div>

<h4 id="52ä¸ºç‰¹å®šåº”ç”¨ç¨‹åºé»˜è®¤çš„æœåŠ¡è´¦æˆ·æˆäºˆç‰¹å®šçš„-role">5.2ã€ä¸ºç‰¹å®šåº”ç”¨ç¨‹åºé»˜è®¤çš„æœåŠ¡è´¦æˆ·æˆäºˆç‰¹å®šçš„ Role</h4>

<p><strong>å¦‚æœåº”ç”¨ç¨‹åºåœ¨ spec ä¸­æ²¡æœ‰è®¾ç½® serviceAccountNameï¼Œé‚£ä¹ˆå°†ä¼šä½¿ç”¨ â€œdefaultâ€ ServiceAccountã€‚</strong></p>

<p><strong>æ³¨æ„: å¦‚æœå¯¹ default ServiceAccount è¿›è¡Œ RoleBinding(æˆæƒ)ï¼Œé‚£ä¹ˆåœ¨å½“å‰å‘½åç©ºé—´å†…æ‰€æœ‰æ²¡æœ‰æŒ‡å®š serviceAccountName çš„ pod éƒ½å°†è·å¾—è¯¥æƒé™ã€‚</strong> ä¾‹å¦‚åœ¨ â€œmy-namespaceâ€ namespace ä¸‹æˆäºˆ â€œdefaultâ€ ServiceAccount view ClusterRole å¦‚ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create rolebinding default-view <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>view <span class="se">\</span>
  <span class="nt">--serviceaccount</span><span class="o">=</span>my-namespace:default <span class="se">\</span>
  <span class="nt">--namespace</span><span class="o">=</span>my-namespace
</code></pre></div></div>

<p>ç›®å‰å¤§å¤šæ•° <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/">add-ons</a> è¿è¡Œåœ¨ â€œkube-systemâ€ namespace çš„ â€œdefaultâ€ ServiceAccount ä¸‹ï¼Œå¦‚æœæƒ³è¦ add-ons ä½¿ç”¨è¶…çº§ç”¨æˆ·çš„æƒé™åªéœ€è¦å¯¹ â€œkube-systemâ€ namespace ä¸‹çš„ â€œdefaultâ€ ServiceAccount æˆäºˆè¶…çº§ç”¨æˆ·æƒé™å³å¯ï¼Œ<strong>éœ€è¦æ³¨æ„çš„æ˜¯è¶…çº§ç”¨æˆ·å¯¹ API secrets å…·æœ‰è¯»å†™æƒé™ï¼Œè¿™å°†å¯¼è‡´æ‰€æœ‰ add-ons ç»„ä»¶å…·æœ‰è¯¥æƒé™</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding add-on-cluster-admin <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>cluster-admin <span class="se">\</span>
  <span class="nt">--serviceaccount</span><span class="o">=</span>kube-system:default
</code></pre></div></div>

<h4 id="53ä¸ºç‰¹å®šå‘½åç©ºé—´çš„æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆæƒ">5.3ã€ä¸ºç‰¹å®šå‘½åç©ºé—´çš„æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆæƒ</h4>

<p>å¦‚æœå¸Œæœ› namespace ä¸­æ‰€æœ‰åº”ç”¨ç¨‹åº(æ— è®ºå±äºå“ªä¸ª ServiceAccount)éƒ½å…·æœ‰æŸä¸€ä¸ª Roleï¼Œåˆ™å¯ä»¥é€šè¿‡å°†è¯¥ Role æˆäºˆè¯¥ namespace çš„ ServiceAccount ç»„æ¥å®ç°ï¼›ä¾‹å¦‚æˆäºˆ â€œmy-namespaceâ€ namespace ä¸‹æ‰€æœ‰ ServiceAccount view ClusterRole å¦‚ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create rolebinding serviceaccounts-view <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>view <span class="se">\</span>
  <span class="nt">--group</span><span class="o">=</span>system:serviceaccounts:my-namespace <span class="se">\</span>
  <span class="nt">--namespace</span><span class="o">=</span>my-namespace
</code></pre></div></div>

<h4 id="54ä¸ºé›†ç¾¤èŒƒå›´å†…æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆæƒä¸å»ºè®®">5.4ã€ä¸ºé›†ç¾¤èŒƒå›´å†…æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆæƒ(ä¸å»ºè®®)</h4>

<p>å¦‚æœä½ æ‡’å¾—ç®¡ç†æ¯ä¸ª namespace çš„æƒé™ï¼Œé‚£ä¹ˆå¯ä»¥å°†æˆæƒæ‰©æ•£åˆ°æ•´ä¸ªé›†ç¾¤ï¼Œå°†æƒé™æˆäºˆé›†ç¾¤å†…æ¯ä¸ª ServiceAccountï¼›ä¾‹å¦‚æˆäºˆå…¨éƒ¨ namespace ä¸­æ‰€æœ‰ ServiceAccount view ClusterRole:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding serviceaccounts-view <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>view <span class="se">\</span>
  <span class="nt">--group</span><span class="o">=</span>system:serviceaccounts
</code></pre></div></div>

<h4 id="55ä¸ºé›†ç¾¤èŒƒå›´å†…æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆäºˆè¶…çº§ç”¨æˆ·æƒé™no-zuo-no-die">5.5ã€ä¸ºé›†ç¾¤èŒƒå›´å†…æ‰€æœ‰æœåŠ¡è´¦æˆ·æˆäºˆè¶…çº§ç”¨æˆ·æƒé™(no zuo no die)</h4>

<p>å¦‚æœä½ æ ¹æœ¬ä¸å…³å¿ƒæƒé™åˆ†é…ï¼Œé‚£ä¹ˆå¯ä»¥å‘é›†ç¾¤å†…æ‰€æœ‰ namespace ä¸‹æ‰€æœ‰ ServiceAccount æˆäºˆè¶…çº§ç”¨æˆ·æƒé™ï¼›<strong>æ³¨æ„: è¿™å°†å…è®¸å…·æœ‰è¯»å–æƒé™çš„ç”¨æˆ·åˆ›å»ºä¸€ä¸ªå®¹å™¨ä»è€Œé—´æ¥è¯»å–åˆ°è¶…çº§ç”¨æˆ·å‡­æ®</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding serviceaccounts-cluster-admin <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>cluster-admin <span class="se">\</span>
  <span class="nt">--group</span><span class="o">=</span>system:serviceaccounts
</code></pre></div></div>

<h3 id="å…­upgrading-from-15">å…­ã€Upgrading from 1.5</h3>

<p>åœ¨ Kubernetes 1.6 ç‰ˆæœ¬ä¹‹å‰ï¼Œè®¸å¤šéƒ¨ç½²ä½¿ç”¨äº†éå¸¸å®½æ³›çš„ ABAC æˆæƒç­–ç•¥ï¼ŒåŒ…æ‹¬æˆäºˆå¯¹æ‰€æœ‰æœåŠ¡å¸æˆ·çš„å®Œæ•´APIè®¿é—®æƒé™ï¼›é»˜è®¤çš„ RBAC æƒé™ç­–ç•¥ä»…å‘ control-plane ç»„ä»¶ã€nodes å’Œ controllers è¿›è¡Œæˆæƒï¼Œä¸åŒ…æ‹¬ <code class="highlighter-rouge">kube-system</code> namespace ä»¥å¤–çš„ Service Account è¿›è¡Œæˆæƒ(é™¤äº†å‘å·²ç»è¢«éªŒè¯è¿‡çš„ç”¨æˆ·æˆäºˆçš„ discovery æƒé™ä¹‹å¤–)</p>

<p>è¿™ç§æ–¹å¼è™½ç„¶å®‰å…¨æ€§æ›´é«˜ï¼Œä½†æ˜¯ RBAC æˆæƒæ–¹å¼å¯èƒ½å½±å“åˆ°å·²ç»å­˜åœ¨çš„æœŸæœ›è‡ªåŠ¨è·å¾— API æƒé™çš„ workloadsï¼Œä»¥ä¸‹æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ:</p>

<h4 id="61parallel-authorizers">6.1ã€Parallel Authorizers</h4>

<p>å¹¶è¡Œæˆæƒç­–ç•¥å…è®¸åŒæ—¶è¿è¡Œ RBAC å’Œ ABACï¼Œå¹¶ä¸”åŒ…å«æ—§çš„ ABAC æˆæƒç­–ç•¥</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--authorization-mode</span><span class="o">=</span>RBAC,ABAC <span class="nt">--authorization-policy-file</span><span class="o">=</span>mypolicy.jsonl
</code></pre></div></div>

<p><strong>æ­¤æ—¶ RBAC æˆæƒæ§åˆ¶å™¨å°†é¦–å…ˆå¤„ç†æˆæƒï¼Œå¦‚æœè¯·æ±‚è¢«æ‹’ç»åˆ™è½¬äº¤ç»™ ABAC æˆæƒæ§åˆ¶å™¨å¤„ç†ï¼›è¿™ç§æˆæƒæ–¹å¼å°†ä¼šå…è®¸ RBAC å’Œ ABAC åŒæ—¶å¤„ç†æˆæƒè¯·æ±‚ï¼Œåªè¦ç›®æ ‡ Subjects åœ¨ RBAC æˆ– ABAC ä¸­ä»»æ„ä¸€ä¸ªæˆæƒå™¨æˆæƒæˆåŠŸå³å¯</strong></p>

<p>å½“æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º 2(â€“v=2) æˆ–è€…æ›´é«˜æ—¶ï¼Œå¯ä»¥åœ¨ API Server æ—¥å¿—ä¸­çœ‹åˆ° RBAC æ‹’ç»çš„æ—¥å¿—(ä»¥ <code class="highlighter-rouge">RBAC DENY:</code> å¼€å¤´)ï¼Œä½ å¯ä»¥é€šè¿‡æ—¥å¿—ä¸­è¯¥ä¿¡æ¯æ¥ç¡®å®šå“ªäº› Role åº”è¯¥æˆäºˆå“ªäº› Subjectsã€‚ä¸€æ—¦å®Œæˆæ‰€æœ‰çš„æˆæƒå¤„ç†ï¼Œå¹¶ä¸”åœ¨æ—¥å¿—ä¸­æ²¡æœ‰å†å‡ºç° RBAC æˆæƒæ‹’ç»çš„æ—¥å¿—æ—¶ï¼Œå°±å¯ä»¥åˆ é™¤æ‰ ABAC æˆæƒ</p>

<h4 id="62permissive-rbac-permissions">6.2ã€Permissive RBAC Permissions</h4>

<p>æ‚¨å¯ä»¥ä½¿ç”¨ RBAC RoleBinding æ¥å¤åˆ¶ä¸€ä¸ªå…è®¸çš„ç­–ç•¥ã€‚</p>

<p><strong>æ³¨æ„: ä»¥ä¸‹ç­–ç•¥å…è®¸æ‰€æœ‰æœåŠ¡å¸æˆ·å……å½“é›†ç¾¤ç®¡ç†å‘˜ã€‚åœ¨å®¹å™¨ä¸­è¿è¡Œçš„ä»»ä½•åº”ç”¨ç¨‹åºéƒ½ä¼šè‡ªåŠ¨æ¥æ”¶æœåŠ¡å¸æˆ·å‡­æ®ï¼Œå¹¶å¯ä»¥é’ˆå¯¹ API æ‰§è¡Œä»»ä½•æ“ä½œï¼ŒåŒ…æ‹¬æŸ¥çœ‹å’Œä¿®æ”¹ secrets æƒé™ï¼›æ‰€ä»¥è¿™ç§æ–¹æ³•å¹¶ä¸æ¨èã€‚</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create clusterrolebinding permissive-binding <span class="se">\</span>
  <span class="nt">--clusterrole</span><span class="o">=</span>cluster-admin <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>admin <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>kubelet <span class="se">\</span>
  <span class="nt">--group</span><span class="o">=</span>system:serviceaccounts
</code></pre></div></div>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET