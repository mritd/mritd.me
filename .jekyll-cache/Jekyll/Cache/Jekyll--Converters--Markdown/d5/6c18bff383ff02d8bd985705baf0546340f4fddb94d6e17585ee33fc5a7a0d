I"šÏ<blockquote>
  <p>å¹´åæ¯”è¾ƒå¿™ï¼Œæ‰€ä»¥ 1.9 ä¹Ÿæ²¡å»æŠ˜è…¾(å…¶å®å°±æ˜¯æ‡’)ï¼Œæœ€è¿‘åˆšæœ‰ç‚¹æ—¶é—´å‡‘å·§ 1.10 å‘å¸ƒï¼›æ‰€ä»¥å°±æŠ˜è…¾ä¸€ä¸‹ 1.10ï¼Œæ„Ÿè§‰æ­å»ºé…ç½®æ²¡æœ‰å¤ªå¤§å˜åŒ–ï¼ŒæŠ˜è…¾äº† 2 å¤©åŸºæœ¬ç®—æ˜¯æå®šäº†ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹æ­å»ºè¿‡ç¨‹ï¼›æœ¬æ–‡ç”¨åˆ°çš„è¢« block é•œåƒå·²ç»ä¸Šä¼ è‡³ <a href="https://pan.baidu.com/s/14W86QQ4qi8qn8JqaDMcC3g">ç™¾åº¦äº‘</a> å¯†ç : dy5p</p>
</blockquote>

<h3 id="ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</h3>

<p>ç›®å‰æ­å»ºä»ç„¶é‡‡ç”¨ 5 å°è™šæ‹Ÿæœºæµ‹è¯•ï¼ŒåŸºæœ¬ç¯å¢ƒå¦‚ä¸‹</p>

<table>
  <thead>
    <tr>
      <th>IP</th>
      <th>Type</th>
      <th>Docker</th>
      <th>OS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>192.168.1.61</td>
      <td>masterã€nodeã€etcd</td>
      <td>18.03.0-ce</td>
      <td>ubuntu 16.04</td>
    </tr>
    <tr>
      <td>192.168.1.62</td>
      <td>masterã€nodeã€etcd</td>
      <td>18.03.0-ce</td>
      <td>ubuntu 16.04</td>
    </tr>
    <tr>
      <td>192.168.1.63</td>
      <td>masterã€nodeã€etcd</td>
      <td>18.03.0-ce</td>
      <td>ubuntu 16.04</td>
    </tr>
    <tr>
      <td>192.168.1.64</td>
      <td>node</td>
      <td>18.03.0-ce</td>
      <td>ubuntu 16.04</td>
    </tr>
    <tr>
      <td>192.168.1.65</td>
      <td>node</td>
      <td>18.03.0-ce</td>
      <td>ubuntu 16.04</td>
    </tr>
  </tbody>
</table>

<p><strong>æ­å»ºå‰è¯·çœ‹å®Œæ•´ç¯‡æ–‡ç« åå†æ“ä½œï¼Œä¸€äº›å˜æ›´è¯´æ˜æˆ‘æ”¾åˆ°åé¢äº†ï¼›è¿˜æœ‰ä¸ºäº†å°½å¯èƒ½çš„æ‡’ï¼Œä¹Ÿä¸ç”¨ä»€ä¹ˆ rpmã€deb äº†ï¼Œç›´æ¥ <code class="highlighter-rouge">hyperkube</code> + <code class="highlighter-rouge">service</code> é…ç½®ï¼Œå¸ƒå‰å²› <code class="highlighter-rouge">hyperkube</code> çš„è¯·çœ‹ <a href="https://github.com/kubernetes/kubernetes/blob/master/cluster/images/hyperkube/README.md">GitHub</a>ï¼›æœ¬ç¯‡æ–‡ç« åŸºäºä¸€äº›å°è„šæœ¬æ­å»º(æ‡’)ï¼Œæ‰€ä»¥ä¸ä¼šå†™å¤ªè¯¦ç»†çš„æ­¥éª¤ï¼Œå…·ä½“è¯·å‚è€ƒ <a href="https://github.com/mritd/ktool">ä»“åº“è„šæœ¬</a>ï¼Œå¦‚æœæƒ³çœ‹æ›´è¯¦ç»†çš„æ¯ä¸€æ­¥çš„ä½œç”¨å¯ä»¥å‚è€ƒä»¥å‰çš„ 1.7ã€1.8 çš„æ­å»ºæ–‡æ¡£</strong></p>

<h3 id="äºŒæ­å»º-etcd-é›†ç¾¤">äºŒã€æ­å»º Etcd é›†ç¾¤</h3>

<h4 id="21å®‰è£…-cfssl">2.1ã€å®‰è£… cfssl</h4>

<p>è¯´å®è¯è¿™ä¸ªç« èŠ‚æˆ‘ä¸æƒ³å†™ï¼Œä½†æ˜¯è€ƒè™‘å¯èƒ½æœ‰äººçœŸçš„éœ€è¦ï¼Œæ‰€ä»¥è¿˜æ˜¯å†™äº†ä¸€ä¸‹ï¼›<strong>è¿™ä¸ªå®‰è£…è„šæœ¬ä½¿ç”¨çš„æ˜¯æˆ‘ç§äººçš„ cdnï¼Œæ–‡ä»¶å¯èƒ½éšæ—¶åˆ é™¤ï¼Œæƒ³ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬è¯·è‡ªè¡Œä» <a href="https://github.com/cloudflare/cfssl">Github</a> clone å¹¶ç¼–è¯‘</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://mritdftp.b0.upaiyun.com/cfssl/cfssl.tar.gz
<span class="nb">tar</span> <span class="nt">-zxvf</span> cfssl.tar.gz
<span class="nb">mv </span>cfssl cfssljson /usr/local/bin
<span class="nb">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
<span class="nb">rm</span> <span class="nt">-f</span> cfssl.tar.gz
</code></pre></div></div>

<h4 id="22ç”Ÿæˆ-etcd-è¯ä¹¦">2.2ã€ç”Ÿæˆ Etcd è¯ä¹¦</h4>

<h5 id="etcd-csrjson">etcd-csr.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd Security"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"192.168.1.61"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"192.168.1.62"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"192.168.1.63"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="etcd-gencertjson">etcd-gencert.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"client auth"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="etcd-root-ca-csrjson">etcd-root-ca-csr.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd Security"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd-root-ca"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="ç”Ÿæˆè¯ä¹¦">ç”Ÿæˆè¯ä¹¦</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">--initca</span><span class="o">=</span><span class="nb">true </span>etcd-root-ca-csr.json | cfssljson <span class="nt">--bare</span> etcd-root-ca
cfssl gencert <span class="nt">--ca</span> etcd-root-ca.pem <span class="nt">--ca-key</span> etcd-root-ca-key.pem <span class="nt">--config</span> etcd-gencert.json etcd-csr.json | cfssljson <span class="nt">--bare</span> etcd
</code></pre></div></div>

<p>ç”Ÿæˆåå¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/81203.png" alt="gen etcd certs" /></p>

<h4 id="23å®‰è£…-etcd">2.3ã€å®‰è£… Etcd</h4>

<p>Etcd è¿™é‡Œé‡‡ç”¨æœ€æ–°çš„ 3.2.18 ç‰ˆæœ¬ï¼Œå®‰è£…æ–¹å¼ç›´æ¥å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶ã€systemd service é…ç½®å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„ç›¸å…³ç”¨æˆ·æƒé™é—®é¢˜ï¼Œä»¥ä¸‹è„šæœ¬é…ç½®ç­‰å‚è€ƒäº† etcd rpm å®‰è£…åŒ…</p>

<h5 id="etcdservice">etcd.service</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/etcd/
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span><span class="s2"> /usr/local/bin/etcd --name=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_NAME</span><span class="k">}</span><span class="se">\"</span><span class="s2"> --data-dir=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_DATA_DIR</span><span class="k">}</span><span class="se">\"</span><span class="s2"> --listen-client-urls=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="k">}</span><span class="se">\"</span><span class="s2">"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h5 id="etcdconf">etcd.conf</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [member]</span>
<span class="nv">ETCD_NAME</span><span class="o">=</span>etcd1
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/etcd1.etcd"</span>
<span class="nv">ETCD_WAL_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/wal"</span>
<span class="nv">ETCD_SNAPSHOT_COUNT</span><span class="o">=</span><span class="s2">"100"</span>
<span class="nv">ETCD_HEARTBEAT_INTERVAL</span><span class="o">=</span><span class="s2">"100"</span>
<span class="nv">ETCD_ELECTION_TIMEOUT</span><span class="o">=</span><span class="s2">"1000"</span>
<span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.61:2380"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.61:2379,http://127.0.0.1:2379"</span>
<span class="nv">ETCD_MAX_SNAPSHOTS</span><span class="o">=</span><span class="s2">"5"</span>
<span class="nv">ETCD_MAX_WALS</span><span class="o">=</span><span class="s2">"5"</span>
<span class="c">#ETCD_CORS=""</span>

<span class="c"># [cluster]</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.61:2380"</span>
<span class="c"># if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. "test=http://..."</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"etcd1=https://192.168.1.61:2380,etcd2=https://192.168.1.62:2380,etcd3=https://192.168.1.63:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">"etcd-cluster"</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.61:2379"</span>
<span class="c">#ETCD_DISCOVERY=""</span>
<span class="c">#ETCD_DISCOVERY_SRV=""</span>
<span class="c">#ETCD_DISCOVERY_FALLBACK="proxy"</span>
<span class="c">#ETCD_DISCOVERY_PROXY=""</span>
<span class="c">#ETCD_STRICT_RECONFIG_CHECK="false"</span>
<span class="c">#ETCD_AUTO_COMPACTION_RETENTION="0"</span>

<span class="c"># [proxy]</span>
<span class="c">#ETCD_PROXY="off"</span>
<span class="c">#ETCD_PROXY_FAILURE_WAIT="5000"</span>
<span class="c">#ETCD_PROXY_REFRESH_INTERVAL="30000"</span>
<span class="c">#ETCD_PROXY_DIAL_TIMEOUT="1000"</span>
<span class="c">#ETCD_PROXY_WRITE_TIMEOUT="5000"</span>
<span class="c">#ETCD_PROXY_READ_TIMEOUT="0"</span>

<span class="c"># [security]</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd.pem"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-key.pem"</span>
<span class="nv">ETCD_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-root-ca.pem"</span>
<span class="nv">ETCD_AUTO_TLS</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd.pem"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-key.pem"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-root-ca.pem"</span>
<span class="nv">ETCD_PEER_AUTO_TLS</span><span class="o">=</span><span class="s2">"true"</span>

<span class="c"># [logging]</span>
<span class="c">#ETCD_DEBUG="false"</span>
<span class="c"># examples for -log-package-levels etcdserver=WARNING,security=DEBUG</span>
<span class="c">#ETCD_LOG_PACKAGE_LEVELS=""</span>
</code></pre></div></div>

<h5 id="installsh">install.sh</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">ETCD_VERSION</span><span class="o">=</span><span class="s2">"3.2.18"</span>

<span class="k">function </span>download<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"etcd-v</span><span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="s2">-linux-amd64.tar.gz"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>wget https://github.com/coreos/etcd/releases/download/v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span>/etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
        <span class="nb">tar</span> <span class="nt">-zxvf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>preinstall<span class="o">(){</span>
    getent group etcd <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="nt">-r</span> etcd
    getent passwd etcd <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> etcd <span class="nt">-d</span> /var/lib/etcd <span class="nt">-s</span> /sbin/nologin <span class="nt">-c</span> <span class="s2">"etcd user"</span> etcd
<span class="o">}</span>

<span class="k">function </span><span class="nb">install</span><span class="o">(){</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">tar</span> <span class="nt">-zxvf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
    <span class="nb">cp </span>etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>/etcd<span class="k">*</span> /usr/local/bin
    <span class="nb">rm</span> <span class="nt">-rf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp</span> <span class="nt">-r</span> conf /etc/etcd
    <span class="nb">chown</span> <span class="nt">-R</span> etcd:etcd /etc/etcd
    <span class="nb">chmod</span> <span class="nt">-R</span> 755 /etc/etcd/ssl

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd systemd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>systemd/<span class="k">*</span>.service /lib/systemd/system
    systemctl daemon-reload
<span class="o">}</span>

<span class="k">function </span>postinstall<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/lib/etcd"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/lib/etcd
        <span class="nb">chown</span> <span class="nt">-R</span> etcd:etcd /var/lib/etcd
    <span class="k">fi</span>
<span class="o">}</span>


download
preinstall
<span class="nb">install
</span>postinstall
</code></pre></div></div>

<p><strong>è„šæœ¬è§£é‡Šå¦‚ä¸‹:</strong></p>

<ul>
  <li>download: ä» Github ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶å¹¶è§£å‹</li>
  <li>preinstall: ä¸º Etcd å®‰è£…åšå‡†å¤‡ï¼Œåˆ›å»º etcd ç”¨æˆ·ï¼Œå¹¶æŒ‡å®šå®¶ç›®å½•ç™»å½• shell ç­‰</li>
  <li>install: å°† etcd äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°å®‰è£…ç›®å½•(<code class="highlighter-rouge">/usr/local/bin</code>)ï¼Œå¤åˆ¶ conf ç›®å½•åˆ° <code class="highlighter-rouge">/etc/etcd</code></li>
  <li>postinstall: å®‰è£…åæ”¶å°¾å·¥ä½œï¼Œæ¯”å¦‚æ£€æµ‹ <code class="highlighter-rouge">/var/lib/etcd</code> æ˜¯å¦å­˜åœ¨ï¼Œçº æ­£æƒé™ç­‰</li>
</ul>

<p>æ•´ä½“ç›®å½•ç»“æ„å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>etcd
â”œâ”€â”€ conf
â”‚Â Â  â”œâ”€â”€ etcd.conf
â”‚Â Â  â””â”€â”€ ssl
â”‚Â Â      â”œâ”€â”€ etcd.csr
â”‚Â Â      â”œâ”€â”€ etcd-csr.json
â”‚Â Â      â”œâ”€â”€ etcd-gencert.json
â”‚Â Â      â”œâ”€â”€ etcd-key.pem
â”‚Â Â      â”œâ”€â”€ etcd.pem
â”‚Â Â      â”œâ”€â”€ etcd-root-ca.csr
â”‚Â Â      â”œâ”€â”€ etcd-root-ca-csr.json
â”‚Â Â      â”œâ”€â”€ etcd-root-ca-key.pem
â”‚Â Â      â””â”€â”€ etcd-root-ca.pem
â”œâ”€â”€ etcd.service
â””â”€â”€ install.sh
</code></pre></div></div>

<p><strong>è¯·è‡ªè¡Œåˆ›å»º conf ç›®å½•ç­‰ï¼Œå¹¶æ”¾ç½®å¥½ç›¸å…³æ–‡ä»¶ï¼Œä¿å­˜ä¸Šé¢è„šæœ¬ä¸º <code class="highlighter-rouge">install.sh</code>ï¼Œç›´æ¥æ‰§è¡Œå³å¯ï¼›åœ¨æ¯å°æœºå™¨ä¸Šæ›´æ”¹å¥½å¯¹åº”çš„é…ç½®ï¼Œå¦‚ etcd åç§°ç­‰ï¼Œetcd ä¼°è®¡éƒ½æ˜¯è½»è½¦ç†Ÿè·¯äº†ï¼Œè¿™é‡Œä¸åšè¿‡å¤šé˜è¿°ï¼›å®‰è£…åå¯åŠ¨å³å¯</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start etcd
systemctl <span class="nb">enable </span>etcd
</code></pre></div></div>

<p><strong>æ³¨æ„: é›†ç¾¤ etcd è¦ 3 ä¸ªä¸€èµ·å¯åŠ¨ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹å•ä¸ªå¯åŠ¨ä¼šå¡åŠå¤©æœ€åå¤±è´¥ï¼Œä¸è¦å‚»ç­‰ï¼›å¯åŠ¨æˆåŠŸåæµ‹è¯•å¦‚ä¸‹</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">ETCDCTL_API</span><span class="o">=</span>3
etcdctl <span class="nt">--cacert</span><span class="o">=</span>/etc/etcd/ssl/etcd-root-ca.pem <span class="nt">--cert</span><span class="o">=</span>/etc/etcd/ssl/etcd.pem <span class="nt">--key</span><span class="o">=</span>/etc/etcd/ssl/etcd-key.pem <span class="nt">--endpoints</span><span class="o">=</span>https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379 endpoint health
</code></pre></div></div>

<p><img src="https://cdn.oss.link/markdown/ji94m.png" alt="check etcd" /></p>

<h3 id="ä¸‰å®‰è£…-kubernets-é›†ç¾¤ç»„ä»¶">ä¸‰ã€å®‰è£… Kubernets é›†ç¾¤ç»„ä»¶</h3>

<blockquote>
  <p><strong>æ³¨æ„ï¼šä¸ä»¥å‰æ–‡æ¡£ä¸åŒçš„æ˜¯ï¼Œè¿™æ¬¡ä¸ä¾èµ– rpm ç­‰ç‰¹å®šå®‰è£…åŒ…ï¼Œè€Œæ˜¯åŸºäº hyperkube äºŒè¿›åˆ¶æ‰‹åŠ¨å®‰è£…ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šåŒæ—¶å®‰è£… Master ä¸ Node é…ç½®æ–‡ä»¶ï¼Œå…·ä½“ä½œä¸º Master è¿˜æ˜¯ Node å–å†³äºæœåŠ¡å¼€å¯æƒ…å†µ</strong></p>
</blockquote>

<h4 id="31ç”Ÿæˆ-kubernetes-è¯ä¹¦">3.1ã€ç”Ÿæˆ Kubernetes è¯ä¹¦</h4>

<p>ç”±äº kubelet å’Œ kube-proxy ç”¨åˆ°çš„ kubeconfig é…ç½®æ–‡ä»¶éœ€è¦å€ŸåŠ© kubectl æ¥ç”Ÿæˆï¼Œæ‰€ä»¥éœ€è¦å…ˆå®‰è£…ä¸€ä¸‹ kubectl</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://storage.googleapis.com/kubernetes-release/release/v1.10.1/bin/linux/amd64/hyperkube <span class="nt">-O</span> hyperkube_1.10.1
<span class="nb">chmod</span> +x hyperkube_1.10.1
<span class="nb">cp </span>hyperkube_1.10.1 /usr/local/bin/hyperkube
<span class="nb">ln</span> <span class="nt">-s</span> /usr/local/bin/hyperkube /usr/local/bin/kubectl
</code></pre></div></div>

<h5 id="admin-csrjson">admin-csr.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:masters"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="k8s-gencertjson">k8s-gencert.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"kubernetes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"client auth"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="k8s-root-ca-csrjson">k8s-root-ca-csr.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k8s"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="kube-apiserver-csrjson">kube-apiserver-csr.json</h5>

<p><strong>æ³¨æ„: åœ¨ä»¥å‰çš„æ–‡æ¡£ä¸­è¿™ä¸ªé…ç½®å« <code class="highlighter-rouge">kubernetes-csr.json</code>ï¼Œä¸ºäº†æ˜ç¡®åˆ’åˆ†èŒè´£ï¼Œè¿™ä¸ªè¯ä¹¦ç›®å‰è¢«é‡å‘½åä»¥è¡¨ç¤ºå…¶ä¸“å±äº <code class="highlighter-rouge">apiserver</code> ä½¿ç”¨ï¼›åŠ äº†ä¸€ä¸ª <code class="highlighter-rouge">*.kubernetes.master</code> åŸŸåä»¥ä¾¿å†…éƒ¨ç§æœ‰ DNS è§£æä½¿ç”¨(å¯åˆ é™¤)ï¼›è‡³äºå¾ˆå¤šäººé—®è¿‡ <code class="highlighter-rouge">kubernetes</code> è¿™å‡ ä¸ªèƒ½ä¸èƒ½åˆ æ‰ï¼Œç­”æ¡ˆæ˜¯ä¸å¯ä»¥çš„ï¼›å› ä¸ºå½“é›†ç¾¤åˆ›å»ºå¥½åï¼Œdefault namespace ä¸‹ä¼šåˆ›å»ºä¸€ä¸ªå« <code class="highlighter-rouge">kubenretes</code> çš„ svcï¼Œæœ‰ä¸€äº›ç»„ä»¶ä¼šç›´æ¥è¿æ¥è¿™ä¸ª svc æ¥è·Ÿ api é€šè®¯çš„ï¼Œè¯ä¹¦å¦‚æœä¸åŒ…å«å¯èƒ½ä¼šå‡ºç°æ— æ³•è¿æ¥çš„æƒ…å†µï¼›å…¶ä»–å‡ ä¸ª <code class="highlighter-rouge">kubernetes</code> å¼€å¤´çš„åŸŸåä½œç”¨ç›¸åŒ</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.254.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.61"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.62"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.63"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.64"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.65"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"*.kubernetes.master"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc.cluster"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc.cluster.local"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k8s"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="kube-proxy-csrjson">kube-proxy-csr.json</h5>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-proxy"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"k8s"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h5 id="ç”Ÿæˆè¯ä¹¦åŠé…ç½®">ç”Ÿæˆè¯ä¹¦åŠé…ç½®</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ç”Ÿæˆ CA</span>
cfssl gencert <span class="nt">--initca</span><span class="o">=</span><span class="nb">true </span>k8s-root-ca-csr.json | cfssljson <span class="nt">--bare</span> k8s-root-ca

<span class="c"># ä¾æ¬¡ç”Ÿæˆå…¶ä»–ç»„ä»¶è¯ä¹¦</span>
<span class="k">for </span>targetName <span class="k">in </span>kube-apiserver admin kube-proxy<span class="p">;</span> <span class="k">do
    </span>cfssl gencert <span class="nt">--ca</span> k8s-root-ca.pem <span class="nt">--ca-key</span> k8s-root-ca-key.pem <span class="nt">--config</span> k8s-gencert.json <span class="nt">--profile</span> kubernetes <span class="nv">$targetName</span><span class="nt">-csr</span>.json | cfssljson <span class="nt">--bare</span> <span class="nv">$targetName</span>
<span class="k">done</span>

<span class="c"># åœ°å€é»˜è®¤ä¸º 127.0.0.1:6443</span>
<span class="c"># å¦‚æœåœ¨ master ä¸Šå¯ç”¨ kubelet è¯·åœ¨ç”Ÿæˆåçš„ kubeconfig ä¸­</span>
<span class="c"># ä¿®æ”¹è¯¥åœ°å€ä¸º å½“å‰MASTER_IP:6443</span>
<span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="s2">"https://127.0.0.1:6443"</span>
<span class="nv">BOOTSTRAP_TOKEN</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 16 /dev/urandom | <span class="nb">od</span> <span class="nt">-An</span> <span class="nt">-t</span> x | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">' '</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s2">"Tokne: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># ä¸è¦è´¨ç–‘ system:bootstrappers ç”¨æˆ·ç»„æ˜¯å¦å†™é”™äº†ï¼Œæœ‰ç–‘é—®è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£</span>
<span class="c"># https://kubernetes.io/docs/admin/kubelet-tls-bootstrapping/</span>
<span class="nb">cat</span> <span class="o">&gt;</span> token.csv <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span><span class="sh">,kubelet-bootstrap,10001,"system:bootstrappers"
</span><span class="no">EOF

</span><span class="nb">echo</span> <span class="s2">"Create kubelet bootstrapping kubeconfig..."</span>
<span class="c"># è®¾ç½®é›†ç¾¤å‚æ•°</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
<span class="c"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span>
kubectl config set-credentials kubelet-bootstrap <span class="se">\</span>
  <span class="nt">--token</span><span class="o">=</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
<span class="c"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span>
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>kubelet-bootstrap <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
<span class="c"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span>
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig

<span class="nb">echo</span> <span class="s2">"Create kube-proxy kubeconfig..."</span>
<span class="c"># è®¾ç½®é›†ç¾¤å‚æ•°</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
<span class="c"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span>
kubectl config set-credentials kube-proxy <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-proxy.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-proxy-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
<span class="c"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span>
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>kube-proxy <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
<span class="c"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span>
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig

<span class="c"># åˆ›å»ºé«˜çº§å®¡è®¡é…ç½®</span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> audit-policy.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
# Log all requests at the Metadata level.
apiVersion: audit.k8s.io/v1beta1
kind: Policy
rules:
- level: Metadata
</span><span class="no">EOF
</span></code></pre></div></div>

<p>ç”Ÿæˆåæ–‡ä»¶å¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/xk8uj.png" alt="k8s certs" /></p>

<h4 id="32å‡†å¤‡-systemd-é…ç½®">3.2ã€å‡†å¤‡ systemd é…ç½®</h4>

<p>æ‰€æœ‰ç»„ä»¶çš„ <code class="highlighter-rouge">systemd</code> é…ç½®å¦‚ä¸‹</p>

<h5 id="kube-apiserverservice">kube-apiserver.service</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes API Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>etcd.service

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/config
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/apiserver
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/hyperkube apiserver <span class="se">\</span>
            <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
            <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
            <span class="nv">$KUBE_ETCD_SERVERS</span> <span class="se">\</span>
            <span class="nv">$KUBE_API_ADDRESS</span> <span class="se">\</span>
            <span class="nv">$KUBE_API_PORT</span> <span class="se">\</span>
            <span class="nv">$KUBELET_PORT</span> <span class="se">\</span>
            <span class="nv">$KUBE_ALLOW_PRIV</span> <span class="se">\</span>
            <span class="nv">$KUBE_SERVICE_ADDRESSES</span> <span class="se">\</span>
            <span class="nv">$KUBE_ADMISSION_CONTROL</span> <span class="se">\</span>
            <span class="nv">$KUBE_API_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h5 id="kube-controller-managerservice">kube-controller-manager.service</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Controller Manager
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/config
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/controller-manager
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/hyperkube controller-manager <span class="se">\</span>
            <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
            <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
            <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
            <span class="nv">$KUBE_CONTROLLER_MANAGER_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h5 id="kubeletservice">kubelet.service</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kubelet Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>docker.service
<span class="nv">Requires</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/kubelet
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/config
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/kubelet
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/hyperkube kubelet <span class="se">\</span>
            <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
            <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
            <span class="nv">$KUBELET_API_SERVER</span> <span class="se">\</span>
            <span class="nv">$KUBELET_ADDRESS</span> <span class="se">\</span>
            <span class="nv">$KUBELET_PORT</span> <span class="se">\</span>
            <span class="nv">$KUBELET_HOSTNAME</span> <span class="se">\</span>
            <span class="nv">$KUBE_ALLOW_PRIV</span> <span class="se">\</span>
            <span class="nv">$KUBELET_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">KillMode</span><span class="o">=</span>process

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h5 id="kube-proxyservice">kube-proxy.service</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kube-Proxy Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/config
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/proxy
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/hyperkube proxy <span class="se">\</span>
            <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
            <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
            <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
            <span class="nv">$KUBE_PROXY_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h5 id="kube-schedulerservice">kube-scheduler.service</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Scheduler Plugin
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/config
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/scheduler
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/local/bin/hyperkube scheduler <span class="se">\</span>
            <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
            <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
            <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
            <span class="nv">$KUBE_SCHEDULER_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<h4 id="33master-èŠ‚ç‚¹é…ç½®">3.3ã€Master èŠ‚ç‚¹é…ç½®</h4>

<p>Master èŠ‚ç‚¹ä¸»è¦ä¼šè¿è¡Œ 3 å„ç»„ä»¶: <code class="highlighter-rouge">kube-apiserver</code>ã€<code class="highlighter-rouge">kube-controller-manager</code>ã€<code class="highlighter-rouge">kube-scheduler</code>ï¼Œå…¶ä¸­ç”¨åˆ°çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹</p>

<h5 id="config">config</h5>

<p><strong>config æ˜¯ä¸€ä¸ªé€šç”¨é…ç½®æ–‡ä»¶ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ç”±äºå®‰è£…æ—¶å¯¹äº Nodeã€Master èŠ‚ç‚¹éƒ½ä¼šåŒ…å«è¯¥æ–‡ä»¶ï¼Œåœ¨ Node èŠ‚ç‚¹ä¸Šè¯·æ³¨é‡Šæ‰ <code class="highlighter-rouge">KUBE_MASTER</code> å˜é‡ï¼Œå› ä¸º Node èŠ‚ç‚¹éœ€è¦åš HAï¼Œè¦è¿æ¥æœ¬åœ°çš„ 6443 åŠ å¯†ç«¯å£ï¼›è€Œè¿™ä¸ªå˜é‡å°†ä¼šè¦†ç›– <code class="highlighter-rouge">kubeconfig</code> ä¸­æŒ‡å®šçš„ <code class="highlighter-rouge">127.0.0.1:6443</code> åœ°å€</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes system config</span>
<span class="c">#</span>
<span class="c"># The following values are used to configure various aspects of all</span>
<span class="c"># kubernetes services, including</span>
<span class="c">#</span>
<span class="c">#   kube-apiserver.service</span>
<span class="c">#   kube-controller-manager.service</span>
<span class="c">#   kube-scheduler.service</span>
<span class="c">#   kubelet.service</span>
<span class="c">#   kube-proxy.service</span>
<span class="c"># logging to stderr means we get it in the systemd journal</span>
<span class="nv">KUBE_LOGTOSTDERR</span><span class="o">=</span><span class="s2">"--logtostderr=true"</span>

<span class="c"># journal message level, 0 is debug</span>
<span class="nv">KUBE_LOG_LEVEL</span><span class="o">=</span><span class="s2">"--v=2"</span>

<span class="c"># Should this cluster be allowed to run privileged docker containers</span>
<span class="nv">KUBE_ALLOW_PRIV</span><span class="o">=</span><span class="s2">"--allow-privileged=true"</span>

<span class="c"># How the controller-manager, scheduler, and proxy find the apiserver</span>
<span class="nv">KUBE_MASTER</span><span class="o">=</span><span class="s2">"--master=http://127.0.0.1:8080"</span>
</code></pre></div></div>

<h5 id="apiserver">apiserver</h5>

<p>apiserver é…ç½®ç›¸å¯¹äº 1.8 ç•¥æœ‰å˜åŠ¨ï¼Œå…¶ä¸­å‡†å…¥æ§åˆ¶å™¨(<code class="highlighter-rouge">admission control</code>)é€‰é¡¹åç§°å˜ä¸ºäº† <code class="highlighter-rouge">--enable-admission-plugins</code>ï¼Œæ§åˆ¶å™¨åˆ—è¡¨ä¹Ÿæœ‰ç›¸åº”å˜åŒ–ï¼Œè¿™é‡Œé‡‡ç”¨å®˜æ–¹æ¨èé…ç½®ï¼Œå…·ä½“è¯·å‚è€ƒ <a href="https://kubernetes.io/docs/admin/admission-controllers/#is-there-a-recommended-set-of-admission-controllers-to-use">å®˜æ–¹æ–‡æ¡£</a></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes system config</span>
<span class="c">#</span>
<span class="c"># The following values are used to configure the kube-apiserver</span>
<span class="c">#</span>

<span class="c"># The address on the local server to listen to.</span>
<span class="nv">KUBE_API_ADDRESS</span><span class="o">=</span><span class="s2">"--advertise-address=192.168.1.61 --bind-address=192.168.1.61"</span>

<span class="c"># The port on the local server to listen on.</span>
<span class="nv">KUBE_API_PORT</span><span class="o">=</span><span class="s2">"--secure-port=6443"</span>

<span class="c"># Port minions listen on</span>
<span class="c"># KUBELET_PORT="--kubelet-port=10250"</span>

<span class="c"># Comma separated list of nodes in the etcd cluster</span>
<span class="nv">KUBE_ETCD_SERVERS</span><span class="o">=</span><span class="s2">"--etcd-servers=https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379"</span>

<span class="c"># Address range to use for services</span>
<span class="nv">KUBE_SERVICE_ADDRESSES</span><span class="o">=</span><span class="s2">"--service-cluster-ip-range=10.254.0.0/16"</span>

<span class="c"># default admission control policies</span>
<span class="nv">KUBE_ADMISSION_CONTROL</span><span class="o">=</span><span class="s2">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota,NodeRestriction"</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_API_ARGS</span><span class="o">=</span><span class="s2">" --anonymous-auth=false </span><span class="se">\</span><span class="s2">
                --apiserver-count=3 </span><span class="se">\</span><span class="s2">
                --audit-log-maxage=30 </span><span class="se">\</span><span class="s2">
                --audit-log-maxbackup=3 </span><span class="se">\</span><span class="s2">
                --audit-log-maxsize=100 </span><span class="se">\</span><span class="s2">
                --audit-log-path=/var/log/kube-audit/audit.log </span><span class="se">\</span><span class="s2">
                --audit-policy-file=/etc/kubernetes/audit-policy.yaml </span><span class="se">\</span><span class="s2">
                --authorization-mode=Node,RBAC </span><span class="se">\</span><span class="s2">
                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --enable-bootstrap-token-auth </span><span class="se">\</span><span class="s2">
                --enable-garbage-collector </span><span class="se">\</span><span class="s2">
                --enable-logs-handler </span><span class="se">\</span><span class="s2">
                --enable-swagger-ui </span><span class="se">\</span><span class="s2">
                --etcd-cafile=/etc/etcd/ssl/etcd-root-ca.pem </span><span class="se">\</span><span class="s2">
                --etcd-certfile=/etc/etcd/ssl/etcd.pem </span><span class="se">\</span><span class="s2">
                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem </span><span class="se">\</span><span class="s2">
                --etcd-compaction-interval=5m0s </span><span class="se">\</span><span class="s2">
                --etcd-count-metric-poll-period=1m0s </span><span class="se">\</span><span class="s2">
                --event-ttl=48h0m0s </span><span class="se">\</span><span class="s2">
                --kubelet-https=true </span><span class="se">\</span><span class="s2">
                --kubelet-timeout=3s </span><span class="se">\</span><span class="s2">
                --log-flush-frequency=5s </span><span class="se">\</span><span class="s2">
                --token-auth-file=/etc/kubernetes/token.csv </span><span class="se">\</span><span class="s2">
                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem </span><span class="se">\</span><span class="s2">
                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem </span><span class="se">\</span><span class="s2">
                --service-node-port-range=30000-50000 </span><span class="se">\</span><span class="s2">
                --service-account-key-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --storage-backend=etcd3 </span><span class="se">\</span><span class="s2">
                --enable-swagger-ui=true"</span>
</code></pre></div></div>

<h5 id="controller-manager">controller-manager</h5>

<p>controller manager é…ç½®é»˜è®¤å¼€å¯äº†è¯ä¹¦è½®æ¢èƒ½åŠ›ç”¨äºè‡ªåŠ¨ç­¾ç½² kueblet è¯ä¹¦ï¼Œå¹¶ä¸”è¯ä¹¦æ—¶é—´ä¹Ÿè®¾ç½®äº† 10 å¹´ï¼Œå¯è‡ªè¡Œè°ƒæ•´ï¼›å¢åŠ äº† <code class="highlighter-rouge">--controllers</code> é€‰é¡¹ä»¥æŒ‡å®šå¼€å¯å…¨éƒ¨æ§åˆ¶å™¨</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># The following values are used to configure the kubernetes controller-manager</span>

<span class="c"># defaults from config and apiserver should be adequate</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_CONTROLLER_MANAGER_ARGS</span><span class="o">=</span><span class="s2">"  --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                                --cluster-name=kubernetes </span><span class="se">\</span><span class="s2">
                                --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --controllers=*,bootstrapsigner,tokencleaner </span><span class="se">\</span><span class="s2">
                                --deployment-controller-sync-period=10s </span><span class="se">\</span><span class="s2">
                                --experimental-cluster-signing-duration=86700h0m0s </span><span class="se">\</span><span class="s2">
                                --leader-elect=true </span><span class="se">\</span><span class="s2">
                                --node-monitor-grace-period=40s </span><span class="se">\</span><span class="s2">
                                --node-monitor-period=5s </span><span class="se">\</span><span class="s2">
                                --pod-eviction-timeout=5m0s </span><span class="se">\</span><span class="s2">
                                --terminated-pod-gc-threshold=50 </span><span class="se">\</span><span class="s2">
                                --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --feature-gates=RotateKubeletServerCertificate=true"</span>
</code></pre></div></div>

<h5 id="scheduler">scheduler</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes scheduler config</span>

<span class="c"># default config should be adequate</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_SCHEDULER_ARGS</span><span class="o">=</span><span class="s2">"   --address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                        --leader-elect=true </span><span class="se">\</span><span class="s2">
                        --algorithm-provider=DefaultProvider"</span>
</code></pre></div></div>

<h4 id="34node-èŠ‚ç‚¹é…ç½®">3.4ã€Node èŠ‚ç‚¹é…ç½®</h4>

<p>Node èŠ‚ç‚¹ä¸Šä¸»è¦æœ‰ <code class="highlighter-rouge">kubelet</code>ã€<code class="highlighter-rouge">kube-proxy</code> ç»„ä»¶ï¼Œç”¨åˆ°çš„é…ç½®å¦‚ä¸‹</p>

<h5 id="kubelet">kubelet</h5>

<p>kubeket é»˜è®¤ä¹Ÿå¼€å¯äº†è¯ä¹¦è½®æ¢èƒ½åŠ›ä»¥ä¿è¯è‡ªåŠ¨ç»­ç­¾ç›¸å…³è¯ä¹¦ï¼ŒåŒæ—¶å¢åŠ äº† <code class="highlighter-rouge">--node-labels</code> é€‰é¡¹ä¸º node æ‰“ä¸€ä¸ªæ ‡ç­¾ï¼Œå…³äºè¿™ä¸ªæ ‡ç­¾æœ€åéƒ¨åˆ†ä¼šæœ‰è®¨è®ºï¼Œ<strong>å¦‚æœåœ¨ master ä¸Šå¯åŠ¨ kubeletï¼Œè¯·å°† <code class="highlighter-rouge">node-role.kubernetes.io/k8s-node=true</code> ä¿®æ”¹ä¸º <code class="highlighter-rouge">node-role.kubernetes.io/k8s-master=true</code></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes kubelet (minion) config</span>

<span class="c"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span>
<span class="nv">KUBELET_ADDRESS</span><span class="o">=</span><span class="s2">"--node-ip=192.168.1.61"</span>

<span class="c"># The port for the info server to serve on</span>
<span class="c"># KUBELET_PORT="--port=10250"</span>

<span class="c"># You may leave this blank to use the actual hostname</span>
<span class="nv">KUBELET_HOSTNAME</span><span class="o">=</span><span class="s2">"--hostname-override=k1.node"</span>

<span class="c"># location of the api-server</span>
<span class="c"># KUBELET_API_SERVER=""</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
                --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
                --cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
                --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
                --cluster-domain=cluster.local. </span><span class="se">\</span><span class="s2">
                --fail-swap-on=false </span><span class="se">\</span><span class="s2">
                --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
                --node-labels=node-role.kubernetes.io/k8s-node=true </span><span class="se">\</span><span class="s2">
                --image-gc-high-threshold=70 </span><span class="se">\</span><span class="s2">
                --image-gc-low-threshold=50 </span><span class="se">\</span><span class="s2">
                --kube-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
                --system-reserved=cpu=1000m,memory=1024Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --serialize-image-pulls=false </span><span class="se">\</span><span class="s2">
                --sync-frequency=30s </span><span class="se">\</span><span class="s2">
                --pod-infra-container-image=k8s.gcr.io/pause-amd64:3.0 </span><span class="se">\</span><span class="s2">
                --resolv-conf=/etc/resolv.conf </span><span class="se">\</span><span class="s2">
                --rotate-certificates"</span>
</code></pre></div></div>

<h5 id="proxy">proxy</h5>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes proxy config</span>
<span class="c"># default config should be adequate</span>
<span class="c"># Add your own!</span>
<span class="nv">KUBE_PROXY_ARGS</span><span class="o">=</span><span class="s2">"--bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                 --hostname-override=k1.node </span><span class="se">\</span><span class="s2">
                 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig </span><span class="se">\</span><span class="s2">
                 --cluster-cidr=10.254.0.0/16"</span>
</code></pre></div></div>

<h4 id="35å®‰è£…é›†ç¾¤ç»„ä»¶">3.5ã€å®‰è£…é›†ç¾¤ç»„ä»¶</h4>

<p>ä¸Šé¢å·²ç»å‡†å¤‡å¥½äº†ç›¸å…³é…ç½®æ–‡ä»¶ï¼Œæ¥ä¸‹æ¥å°†è¿™äº›é…ç½®æ–‡ä»¶ç»„ç»‡æˆå¦‚ä¸‹ç›®å½•ç»“æ„ä»¥ä¾¿åç»­è„šæœ¬å®‰è£…</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>k8s
â”œâ”€â”€ conf
â”‚Â Â  â”œâ”€â”€ apiserver
â”‚Â Â  â”œâ”€â”€ audit-policy.yaml
â”‚Â Â  â”œâ”€â”€ bootstrap.kubeconfig
â”‚Â Â  â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ controller-manager
â”‚Â Â  â”œâ”€â”€ kubelet
â”‚Â Â  â”œâ”€â”€ kube-proxy.kubeconfig
â”‚Â Â  â”œâ”€â”€ proxy
â”‚Â Â  â”œâ”€â”€ scheduler
â”‚Â Â  â”œâ”€â”€ ssl
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ admin.csr
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ admin-csr.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ admin-key.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ admin.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ k8s-gencert.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ k8s-root-ca.csr
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ k8s-root-ca-csr.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ k8s-root-ca-key.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ k8s-root-ca.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-apiserver.csr
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-apiserver-csr.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-apiserver-key.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-apiserver.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-proxy.csr
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-proxy-csr.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kube-proxy-key.pem
â”‚Â Â  â”‚Â Â  â””â”€â”€ kube-proxy.pem
â”‚Â Â  â””â”€â”€ token.csv
â”œâ”€â”€ hyperkube_1.10.1
â”œâ”€â”€ install.sh
â””â”€â”€ systemd
    â”œâ”€â”€ kube-apiserver.service
    â”œâ”€â”€ kube-controller-manager.service
    â”œâ”€â”€ kubelet.service
    â”œâ”€â”€ kube-proxy.service
    â””â”€â”€ kube-scheduler.service
</code></pre></div></div>

<p>å…¶ä¸­ <code class="highlighter-rouge">install.sh</code> å†…å®¹å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">KUBE_VERSION</span><span class="o">=</span><span class="s2">"1.10.1"</span>

<span class="k">function </span>download_k8s<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"hyperkube_</span><span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>wget https://storage.googleapis.com/kubernetes-release/release/v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>/bin/linux/amd64/hyperkube <span class="nt">-O</span> hyperkube_<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>
        <span class="nb">chmod</span> +x hyperkube_<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="k">function </span>preinstall<span class="o">(){</span>
    getent group kube <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="nt">-r</span> kube
    getent passwd kube <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> kube <span class="nt">-d</span> / <span class="nt">-s</span> /sbin/nologin <span class="nt">-c</span> <span class="s2">"Kubernetes user"</span> kube
<span class="o">}</span>

<span class="k">function </span>install_k8s<span class="o">(){</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy hyperkube...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>hyperkube_<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span> /usr/local/bin/hyperkube

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Create symbolic link...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">ln</span> <span class="nt">-sf</span> /usr/local/bin/hyperkube /usr/local/bin/kubectl

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy kubernetes config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp</span> <span class="nt">-r</span> conf /etc/kubernetes
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"/etc/kubernetes/ssl"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">chown</span> <span class="nt">-R</span> kube:kube /etc/kubernetes/ssl
    <span class="k">fi

    </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy kubernetes systemd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>systemd/<span class="k">*</span>.service /lib/systemd/system
    systemctl daemon-reload
<span class="o">}</span>

<span class="k">function </span>postinstall<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/log/kube-audit"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/log/kube-audit
    <span class="k">fi

    if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/lib/kubelet"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/lib/kubelet
    <span class="k">fi

    if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/usr/libexec"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /usr/libexec
    <span class="k">fi
    </span><span class="nb">chown</span> <span class="nt">-R</span> kube:kube /var/log/kube-audit /var/lib/kubelet /usr/libexec
<span class="o">}</span>


download_k8s
preinstall
install_k8s
postinstall
</code></pre></div></div>

<p><strong>è„šæœ¬è§£é‡Šå¦‚ä¸‹:</strong></p>

<ul>
  <li>download_k8s: ä¸‹è½½ hyperkube äºŒè¿›åˆ¶æ–‡ä»¶</li>
  <li>preinstall: å®‰è£…å‰å¤„ç†ï¼ŒåŒ etcd ä¸€æ ·åˆ›å»º kube æ™®é€šç”¨æˆ·æŒ‡å®šå®¶ç›®å½•ã€shell ç­‰</li>
  <li>install_k8s: å¤åˆ¶ hyperkube åˆ°å®‰è£…ç›®å½•ï¼Œä¸º kubectl åˆ›å»ºè½¯è¿æ¥(ä¸ºå•¥åˆ›å»ºè½¯è¿æ¥å°±èƒ½æ‰§è¡Œè¯·è‡ªè¡Œé˜…è¯» <a href="https://github.com/kubernetes/kubernetes/blob/cce67ed8e7d461657d350a1cdd55791d1637fc43/cmd/hyperkube/main.go#L69">æºç </a>)ï¼Œå¤åˆ¶ç›¸å…³é…ç½®åˆ°å¯¹åº”ç›®å½•ï¼Œå¹¶å¤„ç†æƒé™</li>
  <li>postinstall: æ”¶å°¾å·¥ä½œï¼Œåˆ›å»ºæ—¥å¿—ç›®å½•ç­‰ï¼Œå¹¶å¤„ç†æƒé™</li>
</ul>

<p>æœ€åæ‰§è¡Œæ­¤è„šæœ¬å®‰è£…å³å¯ï¼Œ<strong>æ­¤å¤–ï¼Œåº”ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹å®‰è£…äº† <code class="highlighter-rouge">ipset</code>ã€<code class="highlighter-rouge">conntrack</code> ä¸¤ä¸ªåŒ…ï¼Œå› ä¸º kube-proxy ç»„ä»¶ä¼šä½¿ç”¨å…¶å¤„ç† iptables è§„åˆ™ç­‰</strong></p>

<h3 id="å››å¯åŠ¨-kubernetes-master-èŠ‚ç‚¹">å››ã€å¯åŠ¨ Kubernetes Master èŠ‚ç‚¹</h3>

<p>å¯¹äº <code class="highlighter-rouge">master</code> èŠ‚ç‚¹å¯åŠ¨æ— éœ€åšè¿‡å¤šå¤„ç†ï¼Œå¤šä¸ª <code class="highlighter-rouge">master</code> åªè¦ä¿è¯ <code class="highlighter-rouge">apiserver</code> ç­‰é…ç½®ä¸­çš„ ip åœ°å€ç›‘å¬æ²¡é—®é¢˜åç›´æ¥å¯åŠ¨å³å¯</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl start kube-apiserver
systemctl start kube-controller-manager
systemctl start kube-scheduler
systemctl <span class="nb">enable </span>kube-apiserver
systemctl <span class="nb">enable </span>kube-controller-manager
systemctl <span class="nb">enable </span>kube-scheduler
</code></pre></div></div>

<p>æˆåŠŸåæˆªå›¾å¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/lqur1.png" alt="Master success" /></p>

<h3 id="äº”å¯åŠ¨-kubernetes-node-èŠ‚ç‚¹">äº”ã€å¯åŠ¨ Kubernetes Node èŠ‚ç‚¹</h3>

<p>ç”±äº HA ç­‰åŠŸèƒ½éœ€è¦ï¼Œå¯¹äº Node éœ€è¦åšä¸€äº›å¤„ç†æ‰èƒ½å¯åŠ¨ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªåœ°æ–¹éœ€è¦å¤„ç†</p>

<h4 id="51nginx-proxy">5.1ã€nginx-proxy</h4>

<p>åœ¨å¯åŠ¨ <code class="highlighter-rouge">kubelet</code>ã€<code class="highlighter-rouge">kube-proxy</code> æœåŠ¡ä¹‹å‰ï¼Œéœ€è¦åœ¨æœ¬åœ°å¯åŠ¨ <code class="highlighter-rouge">nginx</code> æ¥ tcp è´Ÿè½½å‡è¡¡ <code class="highlighter-rouge">apiserver</code> 6443 ç«¯å£ï¼Œ<code class="highlighter-rouge">nginx-proxy</code> ä½¿ç”¨ <code class="highlighter-rouge">docker</code> + <code class="highlighter-rouge">systemd</code> å¯åŠ¨ï¼Œé…ç½®å¦‚ä¸‹</p>

<p><strong>æ³¨æ„: å¯¹äºåœ¨ master èŠ‚ç‚¹å¯åŠ¨ kubelet æ¥è¯´ï¼Œä¸éœ€è¦ nginx åšè´Ÿè½½å‡è¡¡ï¼›å¯ä»¥è·³è¿‡æ­¤æ­¥éª¤ï¼Œå¹¶ä¿®æ”¹ <code class="highlighter-rouge">kubelet.kubeconfig</code>ã€<code class="highlighter-rouge">kube-proxy.kubeconfig</code> ä¸­çš„ apiserver åœ°å€ä¸ºå½“å‰ master ip 6443 ç«¯å£å³å¯</strong></p>

<ul>
  <li>nginx-proxy.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>kubernetes apiserver docker wrapper
<span class="nv">Wants</span><span class="o">=</span>docker.socket
<span class="nv">After</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">PermissionsStartOnly</span><span class="o">=</span><span class="nb">true
</span><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker run <span class="nt">-p</span> 127.0.0.1:6443:6443 <span class="se">\</span>
                              <span class="nt">-v</span> /etc/nginx:/etc/nginx <span class="se">\</span>
                              <span class="nt">--name</span> nginx-proxy <span class="se">\</span>
                              <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
                              <span class="nt">--restart</span><span class="o">=</span>on-failure:5 <span class="se">\</span>
                              <span class="nt">--memory</span><span class="o">=</span>512M <span class="se">\</span>
                              nginx:1.13.12-alpine
<span class="nv">ExecStartPre</span><span class="o">=</span>-/usr/bin/docker <span class="nb">rm</span> <span class="nt">-f</span> nginx-proxy
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop nginx-proxy
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>15s
<span class="nv">TimeoutStartSec</span><span class="o">=</span>30s

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>nginx.conf</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error_log stderr notice<span class="p">;</span>

worker_processes auto<span class="p">;</span>
events <span class="o">{</span>
        multi_accept on<span class="p">;</span>
        use epoll<span class="p">;</span>
        worker_connections 1024<span class="p">;</span>
<span class="o">}</span>

stream <span class="o">{</span>
    upstream kube_apiserver <span class="o">{</span>
        least_conn<span class="p">;</span>
        server 192.168.1.61:6443<span class="p">;</span>
        server 192.168.1.62:6443<span class="p">;</span>
        server 192.168.1.63:6443<span class="p">;</span>
    <span class="o">}</span>

    server <span class="o">{</span>
        listen        0.0.0.0:6443<span class="p">;</span>
        proxy_pass    kube_apiserver<span class="p">;</span>
        proxy_timeout 10m<span class="p">;</span>
        proxy_connect_timeout 1s<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>å¯åŠ¨ apiserver çš„æœ¬åœ°è´Ÿè½½å‡è¡¡</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> /etc/nginx
<span class="nb">cp </span>nginx.conf /etc/nginx
<span class="nb">cp </span>nginx-proxy.service /lib/systemd/system

systemctl daemon-reload
systemctl start nginx-proxy
systemctl <span class="nb">enable </span>nginx-proxy
</code></pre></div></div>

<h4 id="52tls-bootstrapping">5.2ã€TLS bootstrapping</h4>

<p>åˆ›å»ºå¥½ <code class="highlighter-rouge">nginx-proxy</code> åä¸è¦å¿˜è®°ä¸º <code class="highlighter-rouge">TLS Bootstrap</code> åˆ›å»ºç›¸åº”çš„ <code class="highlighter-rouge">RBAC</code> è§„åˆ™ï¼Œè¿™äº›è§„åˆ™èƒ½å®ç°è¯è‡ªåŠ¨ç­¾ç½² <code class="highlighter-rouge">TLS Bootstrap</code> å‘å‡ºçš„ <code class="highlighter-rouge">CSR</code> è¯·æ±‚ï¼Œä»è€Œå®ç°è¯ä¹¦è½®æ¢(åˆ›å»ºä¸€æ¬¡å³å¯)ï¼›è¯¦æƒ…è¯·å‚è€ƒ <a href="https://mritd.me/2018/01/07/kubernetes-tls-bootstrapping-note/">Kubernetes TLS bootstrapping é‚£ç‚¹äº‹</a></p>

<ul>
  <li>tls-bootstrapping-clusterrole.yaml(ä¸ 1.8 ä¸€æ ·)</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span>
<span class="c1"># serving cert matching its client cert.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeserver"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
</code></pre></div></div>

<p><strong>åœ¨ master æ‰§è¡Œåˆ›å»º</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ç»™ä¸ kubelet-bootstrap ç”¨æˆ·è¿›è¡Œ node-bootstrapper çš„æƒé™</span>
kubectl create clusterrolebinding kubelet-bootstrap <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="se">\</span>
    <span class="nt">--user</span><span class="o">=</span>kubelet-bootstrap

kubectl create <span class="nt">-f</span> tls-bootstrapping-clusterrole.yaml

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-approve-csr <span class="se">\</span>
        <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="se">\</span>
        <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-renew-crt <span class="se">\</span>
        <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="se">\</span>
        <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-server-auto-renew-crt <span class="se">\</span>
        <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeserver <span class="se">\</span>
        <span class="nt">--group</span><span class="o">=</span>system:nodes
</code></pre></div></div>

<h4 id="53æ‰§è¡Œå¯åŠ¨">5.3ã€æ‰§è¡Œå¯åŠ¨</h4>

<p>å¤šèŠ‚ç‚¹éƒ¨ç½²æ—¶å…ˆå¯åŠ¨å¥½ <code class="highlighter-rouge">nginx-proxy</code>ï¼Œç„¶åä¿®æ”¹å¥½ç›¸åº”é…ç½®çš„ ip åœ°å€ç­‰é…ç½®ï¼Œæœ€ç»ˆç›´æ¥å¯åŠ¨å³å¯(master ä¸Šå¯åŠ¨ kubelet ä¸è¦å¿˜äº†ä¿®æ”¹ kubeconfig ä¸­çš„ apiserver åœ°å€ï¼Œè¿˜æœ‰å¯¹åº”çš„ kubelet çš„ node label)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl start kubelet
systemctl start kube-proxy
systemctl <span class="nb">enable </span>kubelet
systemctl <span class="nb">enable </span>kube-proxy
</code></pre></div></div>

<p>æœ€åå¯åŠ¨æˆåŠŸåå¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/r4s34.png" alt="cluster started" /></p>

<h3 id="äº”å®‰è£…-calico">äº”ã€å®‰è£… Calico</h3>

<p>Calico å®‰è£…ä»ç„¶å»¶ç»­ä»¥å‰çš„æ–¹æ¡ˆï¼Œä½¿ç”¨ Daemonset å®‰è£… cni ç»„ä»¶ï¼Œä½¿ç”¨ systemd æ§åˆ¶ calico-node ä»¥ç¡®ä¿ calico-node èƒ½æ­£ç¡®çš„æ‹¿åˆ°ä¸»æœºåç­‰</p>

<h4 id="51ä¿®æ”¹-calico-é…ç½®">5.1ã€ä¿®æ”¹ Calico é…ç½®</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/calico.yaml <span class="nt">-O</span> calico.example.yaml

<span class="nv">ETCD_CERT</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> /etc/etcd/ssl/etcd.pem | <span class="nb">base64</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="sb">`</span>
<span class="nv">ETCD_KEY</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> /etc/etcd/ssl/etcd-key.pem | <span class="nb">base64</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="sb">`</span>
<span class="nv">ETCD_CA</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> /etc/etcd/ssl/etcd-root-ca.pem | <span class="nb">base64</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span><span class="sb">`</span>
<span class="nv">ETCD_ENDPOINTS</span><span class="o">=</span><span class="s2">"https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379"</span>

<span class="nb">cp </span>calico.example.yaml calico.yaml

<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s@.*etcd_endpoints:.*@</span><span class="se">\ \ </span><span class="s2">etcd_endpoints:</span><span class="se">\ \"</span><span class="k">${</span><span class="nv">ETCD_ENDPOINTS</span><span class="k">}</span><span class="se">\"</span><span class="s2">@gi"</span> calico.yaml

<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s@.*etcd-cert:.*@</span><span class="se">\ \ </span><span class="s2">etcd-cert:</span><span class="se">\ </span><span class="k">${</span><span class="nv">ETCD_CERT</span><span class="k">}</span><span class="s2">@gi"</span> calico.yaml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s@.*etcd-key:.*@</span><span class="se">\ \ </span><span class="s2">etcd-key:</span><span class="se">\ </span><span class="k">${</span><span class="nv">ETCD_KEY</span><span class="k">}</span><span class="s2">@gi"</span> calico.yaml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s@.*etcd-ca:.*@</span><span class="se">\ \ </span><span class="s2">etcd-ca:</span><span class="se">\ </span><span class="k">${</span><span class="nv">ETCD_CA</span><span class="k">}</span><span class="s2">@gi"</span> calico.yaml

<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s@.*etcd_ca:.*@\ \ etcd_ca:\ "/calico-secrets/etcd-ca"@gi'</span> calico.yaml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s@.*etcd_cert:.*@\ \ etcd_cert:\ "/calico-secrets/etcd-cert"@gi'</span> calico.yaml
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s@.*etcd_key:.*@\ \ etcd_key:\ "/calico-secrets/etcd-key"@gi'</span> calico.yaml

<span class="c"># æ³¨é‡Šæ‰ calico-node éƒ¨åˆ†(ç”± Systemd æ¥ç®¡)</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'123,219s@.*@#&amp;@gi'</span> calico.yaml
</code></pre></div></div>

<h4 id="52åˆ›å»º-systemd-æ–‡ä»¶">5.2ã€åˆ›å»º Systemd æ–‡ä»¶</h4>

<p><strong>æ³¨æ„: åˆ›å»º systemd service é…ç½®æ–‡ä»¶è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æ‰§è¡Œ</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">K8S_MASTER_IP</span><span class="o">=</span><span class="s2">"192.168.1.61"</span>
<span class="nv">HOSTNAME</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> /etc/hostname<span class="sb">`</span>
<span class="nv">ETCD_ENDPOINTS</span><span class="o">=</span><span class="s2">"https://192.168.1.61:2379,https://192.168.1.62:2379,https://192.168.1.63:2379"</span>

<span class="nb">cat</span> <span class="o">&gt;</span> /lib/systemd/system/calico-node.service <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
[Unit]
Description=calico node
After=docker.service
Requires=docker.service

[Service]
User=root
Environment=ETCD_ENDPOINTS=</span><span class="k">${</span><span class="nv">ETCD_ENDPOINTS</span><span class="k">}</span><span class="sh">
PermissionsStartOnly=true
ExecStart=/usr/bin/docker run   --net=host --privileged --name=calico-node </span><span class="se">\\</span><span class="sh">
                                -e ETCD_ENDPOINTS=</span><span class="se">\$</span><span class="sh">{ETCD_ENDPOINTS} </span><span class="se">\\</span><span class="sh">
                                -e ETCD_CA_CERT_FILE=/etc/etcd/ssl/etcd-root-ca.pem </span><span class="se">\\</span><span class="sh">
                                -e ETCD_CERT_FILE=/etc/etcd/ssl/etcd.pem </span><span class="se">\\</span><span class="sh">
                                -e ETCD_KEY_FILE=/etc/etcd/ssl/etcd-key.pem </span><span class="se">\\</span><span class="sh">
                                -e NODENAME=</span><span class="k">${</span><span class="nv">HOSTNAME</span><span class="k">}</span><span class="sh"> </span><span class="se">\\</span><span class="sh">
                                -e IP= </span><span class="se">\\</span><span class="sh">
                                -e IP_AUTODETECTION_METHOD=can-reach=</span><span class="k">${</span><span class="nv">K8S_MASTER_IP</span><span class="k">}</span><span class="sh"> </span><span class="se">\\</span><span class="sh">
                                -e AS=64512 </span><span class="se">\\</span><span class="sh">
                                -e CLUSTER_TYPE=k8s,bgp </span><span class="se">\\</span><span class="sh">
                                -e CALICO_IPV4POOL_CIDR=10.20.0.0/16 </span><span class="se">\\</span><span class="sh">
                                -e CALICO_IPV4POOL_IPIP=always </span><span class="se">\\</span><span class="sh">
                                -e CALICO_LIBNETWORK_ENABLED=true </span><span class="se">\\</span><span class="sh">
                                -e CALICO_NETWORKING_BACKEND=bird </span><span class="se">\\</span><span class="sh">
                                -e CALICO_DISABLE_FILE_LOGGING=true </span><span class="se">\\</span><span class="sh">
                                -e FELIX_IPV6SUPPORT=false </span><span class="se">\\</span><span class="sh">
                                -e FELIX_DEFAULTENDPOINTTOHOSTACTION=ACCEPT </span><span class="se">\\</span><span class="sh">
                                -e FELIX_LOGSEVERITYSCREEN=info </span><span class="se">\\</span><span class="sh">
                                -e FELIX_IPINIPMTU=1440 </span><span class="se">\\</span><span class="sh">
                                -e FELIX_HEALTHENABLED=true </span><span class="se">\\</span><span class="sh">
                                -e CALICO_K8S_NODE_REF=</span><span class="k">${</span><span class="nv">HOSTNAME</span><span class="k">}</span><span class="sh"> </span><span class="se">\\</span><span class="sh">
                                -v /etc/calico/etcd-root-ca.pem:/etc/etcd/ssl/etcd-root-ca.pem </span><span class="se">\\</span><span class="sh">
                                -v /etc/calico/etcd.pem:/etc/etcd/ssl/etcd.pem </span><span class="se">\\</span><span class="sh">
                                -v /etc/calico/etcd-key.pem:/etc/etcd/ssl/etcd-key.pem </span><span class="se">\\</span><span class="sh">
                                -v /lib/modules:/lib/modules </span><span class="se">\\</span><span class="sh">
                                -v /var/lib/calico:/var/lib/calico </span><span class="se">\\</span><span class="sh">
                                -v /var/run/calico:/var/run/calico </span><span class="se">\\</span><span class="sh">
                                quay.io/calico/node:v3.1.0
ExecStop=/usr/bin/docker rm -f calico-node
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
</span><span class="no">EOF
</span></code></pre></div></div>
<p><strong>å¯¹äºä»¥ä¸Šè„šæœ¬ä¸­çš„ <code class="highlighter-rouge">K8S_MASTER_IP</code> å˜é‡ï¼Œåªéœ€è¦å¡«å†™ä¸€ä¸ª master ip å³å¯ï¼Œè¿™ä¸ªå˜é‡ç”¨äº calico è‡ªåŠ¨é€‰æ‹© IP ä½¿ç”¨ï¼›åœ¨å®¿ä¸»æœºæœ‰å¤šå¼ ç½‘å¡çš„æƒ…å†µä¸‹ï¼Œcalcio node ä¼šè‡ªåŠ¨è·å–ä¸€ä¸ª IPï¼Œè·å–åŸåˆ™å°±æ˜¯å°è¯•æ˜¯å¦èƒ½å¤Ÿè”é€šè¿™ä¸ª master ip</strong></p>

<p>ç”±äº calico éœ€è¦ä½¿ç”¨ etcd å­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦å¤åˆ¶ etcd è¯ä¹¦åˆ°ç›¸å…³ç›®å½•ï¼Œ<strong><code class="highlighter-rouge">/etc/calico</code> éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-r</span> /etc/etcd/ssl /etc/calico
</code></pre></div></div>

<h4 id="53ä¿®æ”¹-kubelet-é…ç½®">5.3ã€ä¿®æ”¹ kubelet é…ç½®</h4>

<p>ä½¿ç”¨ Calico åéœ€è¦ä¿®æ”¹ kubelet é…ç½®å¢åŠ  CNI è®¾ç½®(<code class="highlighter-rouge">--network-plugin=cni</code>)ï¼Œä¿®æ”¹åé…ç½®å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes kubelet (minion) config</span>

<span class="c"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span>
<span class="nv">KUBELET_ADDRESS</span><span class="o">=</span><span class="s2">"--node-ip=192.168.1.61"</span>

<span class="c"># The port for the info server to serve on</span>
<span class="c"># KUBELET_PORT="--port=10250"</span>

<span class="c"># You may leave this blank to use the actual hostname</span>
<span class="nv">KUBELET_HOSTNAME</span><span class="o">=</span><span class="s2">"--hostname-override=k1.node"</span>

<span class="c"># location of the api-server</span>
<span class="c"># KUBELET_API_SERVER=""</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
                --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
                --cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
                --network-plugin=cni </span><span class="se">\</span><span class="s2">
                --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
                --cluster-domain=cluster.local. </span><span class="se">\</span><span class="s2">
                --fail-swap-on=false </span><span class="se">\</span><span class="s2">
                --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
                --node-labels=node-role.kubernetes.io/k8s-master=true </span><span class="se">\</span><span class="s2">
                --image-gc-high-threshold=70 </span><span class="se">\</span><span class="s2">
                --image-gc-low-threshold=50 </span><span class="se">\</span><span class="s2">
                --kube-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
                --system-reserved=cpu=1000m,memory=1024Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --serialize-image-pulls=false </span><span class="se">\</span><span class="s2">
                --sync-frequency=30s </span><span class="se">\</span><span class="s2">
                --pod-infra-container-image=k8s.gcr.io/pause-amd64:3.0 </span><span class="se">\</span><span class="s2">
                --resolv-conf=/etc/resolv.conf </span><span class="se">\</span><span class="s2">
                --rotate-certificates"</span>
</code></pre></div></div>

<h4 id="54åˆ›å»º-calico-daemonset">5.4ã€åˆ›å»º Calico Daemonset</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å…ˆåˆ›å»º RBAC</span>
kubectl apply <span class="nt">-f</span> <span class="se">\</span>
https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/rbac.yaml

<span class="c"># å†åˆ›å»º Calico Daemonset</span>
kubectl create <span class="nt">-f</span> calico.yaml
</code></pre></div></div>

<h4 id="55å¯åŠ¨-calico-node">5.5ã€å¯åŠ¨ Calico Node</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl daemon-reload
systemctl restart calico-node
systemctl <span class="nb">enable </span>calico-node

<span class="c"># ç­‰å¾… 20s æ‹‰å–é•œåƒ</span>
<span class="nb">sleep </span>20
systemctl restart kubelet
</code></pre></div></div>

<h4 id="56æµ‹è¯•ç½‘ç»œ">5.6ã€æµ‹è¯•ç½‘ç»œ</h4>

<p>ç½‘ç»œæµ‹è¯•ä¸å…¶ä»–å‡ ç¯‡æ–‡ç« ä¸€æ ·ï¼Œåˆ›å»ºå‡ ä¸ª pod æµ‹è¯•å³å¯</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ›å»º deployment</span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> &gt;&gt; demo.deploy.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-deployment
spec:
  replicas: 5
  selector:
    matchLabels:
      app: demo
  template:
    metadata:
      labels:
        app: demo
    spec:
      containers:
      - name: demo
        image: mritd/demo
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
</span><span class="no">EOF
</span>kubectl create <span class="nt">-f</span> demo.deploy.yml
</code></pre></div></div>

<p>æµ‹è¯•ç»“æœå¦‚å›¾æ‰€ç¤º</p>

<p><img src="https://cdn.oss.link/markdown/u9j3v.png" alt="test calico" /></p>

<h3 id="å…­éƒ¨ç½²é›†ç¾¤-dns">å…­ã€éƒ¨ç½²é›†ç¾¤ DNS</h3>

<h4 id="61éƒ¨ç½²-coredns">6.1ã€éƒ¨ç½² CoreDNS</h4>

<p>CoreDNS ç»™å‡ºäº†æ ‡å‡†çš„ deployment é…ç½®ï¼Œå¦‚ä¸‹</p>

<ul>
  <li>coredns.yaml.sed</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: ServiceAccount
metadata:
  name: coredns
  namespace: kube-system
<span class="nt">---</span>
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
rules:
- apiGroups:
  - <span class="s2">""</span>
  resources:
  - endpoints
  - services
  - pods
  - namespaces
  verbs:
  - list
  - watch
<span class="nt">---</span>
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="s2">"true"</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:coredns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:coredns
subjects:
- kind: ServiceAccount
  name: coredns
  namespace: kube-system
<span class="nt">---</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns
  namespace: kube-system
data:
  Corefile: |
    .:53 <span class="o">{</span>
        errors
        health
        kubernetes CLUSTER_DOMAIN REVERSE_CIDRS <span class="o">{</span>
          pods insecure
          upstream
          fallthrough <span class="k">in</span><span class="nt">-addr</span>.arpa ip6.arpa
        <span class="o">}</span>
        prometheus :9153
        proxy <span class="nb">.</span> /etc/resolv.conf
        cache 30
    <span class="o">}</span>
<span class="nt">---</span>
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: coredns
  namespace: kube-system
  labels:
    k8s-app: kube-dns
    kubernetes.io/name: <span class="s2">"CoreDNS"</span>
spec:
  replicas: 2
  strategy:
    <span class="nb">type</span>: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      k8s-app: kube-dns
  template:
    metadata:
      labels:
        k8s-app: kube-dns
    spec:
      serviceAccountName: coredns
      tolerations:
        - key: <span class="s2">"CriticalAddonsOnly"</span>
          operator: <span class="s2">"Exists"</span>
      containers:
      - name: coredns
        image: coredns/coredns:1.1.1
        imagePullPolicy: IfNotPresent
        args: <span class="o">[</span> <span class="s2">"-conf"</span>, <span class="s2">"/etc/coredns/Corefile"</span> <span class="o">]</span>
        volumeMounts:
        - name: config-volume
          mountPath: /etc/coredns
        ports:
        - containerPort: 53
          name: dns
          protocol: UDP
        - containerPort: 53
          name: dns-tcp
          protocol: TCP
        - containerPort: 9153
          name: metrics
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 60
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 5
      dnsPolicy: Default
      volumes:
        - name: config-volume
          configMap:
            name: coredns
            items:
            - key: Corefile
              path: Corefile
<span class="nt">---</span>
apiVersion: v1
kind: Service
metadata:
  name: kube-dns
  namespace: kube-system
  annotations:
    prometheus.io/scrape: <span class="s2">"true"</span>
  labels:
    k8s-app: kube-dns
    kubernetes.io/cluster-service: <span class="s2">"true"</span>
    kubernetes.io/name: <span class="s2">"CoreDNS"</span>
spec:
  selector:
    k8s-app: kube-dns
  clusterIP: CLUSTER_DNS_IP
  ports:
  - name: dns
    port: 53
    protocol: UDP
  - name: dns-tcp
    port: 53
    protocol: TCP
</code></pre></div></div>

<p>ç„¶åç›´æ¥ä½¿ç”¨è„šæœ¬æ›¿æ¢å³å¯(è„šæœ¬å˜é‡æˆ‘å·²ç»ä¿®æ”¹äº†)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Deploys CoreDNS to a cluster currently running Kube-DNS.</span>

<span class="nv">SERVICE_CIDR</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">10</span><span class="p">.254.0.0/16</span><span class="k">}</span>
<span class="nv">POD_CIDR</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">10</span><span class="p">.20.0.0/16</span><span class="k">}</span>
<span class="nv">CLUSTER_DNS_IP</span><span class="o">=</span><span class="k">${</span><span class="nv">3</span><span class="k">:-</span><span class="nv">10</span><span class="p">.254.0.2</span><span class="k">}</span>
<span class="nv">CLUSTER_DOMAIN</span><span class="o">=</span><span class="k">${</span><span class="nv">4</span><span class="k">:-</span><span class="nv">cluster</span><span class="p">.local</span><span class="k">}</span>
<span class="nv">YAML_TEMPLATE</span><span class="o">=</span><span class="k">${</span><span class="nv">5</span><span class="k">:-</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span><span class="p">/coredns.yaml.sed</span><span class="k">}</span>

<span class="nb">sed</span> <span class="nt">-e</span> s/CLUSTER_DNS_IP/<span class="nv">$CLUSTER_DNS_IP</span>/g <span class="nt">-e</span> s/CLUSTER_DOMAIN/<span class="nv">$CLUSTER_DOMAIN</span>/g <span class="nt">-e</span> s?SERVICE_CIDR?<span class="nv">$SERVICE_CIDR</span>?g <span class="nt">-e</span> s?POD_CIDR?<span class="nv">$POD_CIDR</span>?g <span class="nv">$YAML_TEMPLATE</span> <span class="o">&gt;</span> coredns.yaml
</code></pre></div></div>

<p>æœ€åä½¿ç”¨ <code class="highlighter-rouge">kubectl</code> åˆ›å»ºä¸€ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æ‰§è¡Œä¸Šé¢çš„æ›¿æ¢è„šæœ¬</span>
./deploy.sh

<span class="c"># åˆ›å»º CoreDNS</span>
kubectl create <span class="nt">-f</span> coredns.yaml
</code></pre></div></div>

<p>æµ‹è¯•æˆªå›¾å¦‚ä¸‹</p>

<p><img src="https://cdn.oss.link/markdown/v1jdc.png" alt="test dns" /></p>

<h4 id="62éƒ¨ç½²-dns-è‡ªåŠ¨æ‰©å®¹">6.2ã€éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹</h4>

<p>è‡ªåŠ¨æ‰©å®¹è·Ÿä»¥å¾€ä¸€æ ·ï¼Œyaml åˆ›å»ºä¸€ä¸‹å°±è¡Œ</p>

<ul>
  <li>dns-horizontal-autoscaler.yaml</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Copyright 2016 The Kubernetes Authors.</span>
<span class="c">#</span>
<span class="c"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c"># you may not use this file except in compliance with the License.</span>
<span class="c"># You may obtain a copy of the License at</span>
<span class="c">#</span>
<span class="c">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c"># See the License for the specific language governing permissions and</span>
<span class="c"># limitations under the License.</span>

kind: ServiceAccount
apiVersion: v1
metadata:
  name: kube-dns-autoscaler
  namespace: kube-system
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
<span class="nt">---</span>
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: system:kube-dns-autoscaler
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
rules:
  - apiGroups: <span class="o">[</span><span class="s2">""</span><span class="o">]</span>
    resources: <span class="o">[</span><span class="s2">"nodes"</span><span class="o">]</span>
    verbs: <span class="o">[</span><span class="s2">"list"</span><span class="o">]</span>
  - apiGroups: <span class="o">[</span><span class="s2">""</span><span class="o">]</span>
    resources: <span class="o">[</span><span class="s2">"replicationcontrollers/scale"</span><span class="o">]</span>
    verbs: <span class="o">[</span><span class="s2">"get"</span>, <span class="s2">"update"</span><span class="o">]</span>
  - apiGroups: <span class="o">[</span><span class="s2">"extensions"</span><span class="o">]</span>
    resources: <span class="o">[</span><span class="s2">"deployments/scale"</span>, <span class="s2">"replicasets/scale"</span><span class="o">]</span>
    verbs: <span class="o">[</span><span class="s2">"get"</span>, <span class="s2">"update"</span><span class="o">]</span>
<span class="c"># Remove the configmaps rule once below issue is fixed:</span>
<span class="c"># kubernetes-incubator/cluster-proportional-autoscaler#16</span>
  - apiGroups: <span class="o">[</span><span class="s2">""</span><span class="o">]</span>
    resources: <span class="o">[</span><span class="s2">"configmaps"</span><span class="o">]</span>
    verbs: <span class="o">[</span><span class="s2">"get"</span>, <span class="s2">"create"</span><span class="o">]</span>
<span class="nt">---</span>
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: system:kube-dns-autoscaler
  labels:
    addonmanager.kubernetes.io/mode: Reconcile
subjects:
  - kind: ServiceAccount
    name: kube-dns-autoscaler
    namespace: kube-system
roleRef:
  kind: ClusterRole
  name: system:kube-dns-autoscaler
  apiGroup: rbac.authorization.k8s.io

<span class="nt">---</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-dns-autoscaler
  namespace: kube-system
  labels:
    k8s-app: kube-dns-autoscaler
    kubernetes.io/cluster-service: <span class="s2">"true"</span>
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  selector:
    matchLabels:
      k8s-app: kube-dns-autoscaler
  template:
    metadata:
      labels:
        k8s-app: kube-dns-autoscaler
      annotations:
        scheduler.alpha.kubernetes.io/critical-pod: <span class="s1">''</span>
    spec:
      priorityClassName: system-cluster-critical
      containers:
      - name: autoscaler
        image: k8s.gcr.io/cluster-proportional-autoscaler-amd64:1.1.2-r2
        resources:
            requests:
                cpu: <span class="s2">"20m"</span>
                memory: <span class="s2">"10Mi"</span>
        <span class="nb">command</span>:
          - /cluster-proportional-autoscaler
          - <span class="nt">--namespace</span><span class="o">=</span>kube-system
          - <span class="nt">--configmap</span><span class="o">=</span>kube-dns-autoscaler
          <span class="c"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span>
          - <span class="nt">--target</span><span class="o">=</span>Deployment/kube-dns
          <span class="c"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span>
          <span class="c"># If using small nodes, "nodesPerReplica" should dominate.</span>
          - <span class="nt">--default-params</span><span class="o">={</span><span class="s2">"linear"</span>:<span class="o">{</span><span class="s2">"coresPerReplica"</span>:256,<span class="s2">"nodesPerReplica"</span>:16,<span class="s2">"preventSinglePointFailure"</span>:true<span class="o">}}</span>
          - <span class="nt">--logtostderr</span><span class="o">=</span><span class="nb">true</span>
          - <span class="nt">--v</span><span class="o">=</span>2
      tolerations:
      - key: <span class="s2">"CriticalAddonsOnly"</span>
        operator: <span class="s2">"Exists"</span>
      serviceAccountName: kube-dns-autoscaler
</code></pre></div></div>

<h3 id="ä¸ƒéƒ¨ç½²-heapster">ä¸ƒã€éƒ¨ç½² heapster</h3>

<p>heapster éƒ¨ç½²ç›¸å¯¹ç®€å•çš„å¤šï¼Œyaml åˆ›å»ºä¸€ä¸‹å°±å¯ä»¥äº†</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/grafana.yaml
kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/heapster.yaml
kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/influxdb/influxdb.yaml
kubectl create <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/heapster/master/deploy/kube-config/rbac/heapster-rbac.yaml
</code></pre></div></div>

<h3 id="å…«éƒ¨ç½²-dashboard">å…«ã€éƒ¨ç½² Dashboard</h3>

<h4 id="81éƒ¨ç½²-dashboard">8.1ã€éƒ¨ç½² Dashboard</h4>

<p>Dashboard éƒ¨ç½²åŒ heapster ä¸€æ ·ï¼Œä¸è¿‡ä¸ºäº†æ–¹ä¾¿è®¿é—®ï¼Œæˆ‘è®¾ç½®äº† NodePortï¼Œè¿˜æ³¨æ„åˆ°ä¸€ç‚¹æ˜¯ yaml æ‹‰å–ç­–ç•¥å·²ç»æ²¡æœ‰æ¯”è¾ƒå‚»çš„ <code class="highlighter-rouge">Always</code> äº†</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml <span class="nt">-O</span> kubernetes-dashboard.yaml
</code></pre></div></div>

<p>å°†æœ€åéƒ¨åˆ†çš„ç«¯å£æš´éœ²ä¿®æ”¹å¦‚ä¸‹</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ------------------- Dashboard Service ------------------- #</span>

<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dashboard-tls</span>
      <span class="na">port</span><span class="pi">:</span> <span class="m">443</span>
      <span class="na">targetPort</span><span class="pi">:</span> <span class="m">8443</span>
      <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30000</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
</code></pre></div></div>

<p>ç„¶åæ‰§è¡Œ <code class="highlighter-rouge">kubectl create -f kubernetes-dashboard.yaml</code> å³å¯</p>

<h4 id="82åˆ›å»º-admin-è´¦æˆ·">8.2ã€åˆ›å»º admin è´¦æˆ·</h4>

<p>é»˜è®¤æƒ…å†µä¸‹éƒ¨ç½²æˆåŠŸåå¯ä»¥ç›´æ¥è®¿é—® <code class="highlighter-rouge">https://NODE_IP:30000</code> è®¿é—®ï¼Œä½†æ˜¯æƒ³è¦ç™»å½•è¿›å»æŸ¥çœ‹çš„è¯éœ€è¦ä½¿ç”¨ kubeconfig æˆ–è€… access token çš„æ–¹å¼ï¼›å®é™…ä¸Šè¿™ä¸ªå°±æ˜¯ RBAC æˆæƒæ§åˆ¶ï¼Œä»¥ä¸‹æä¾›ä¸€ä¸ªåˆ›å»º admin access token çš„è„šæœ¬ï¼Œæ›´ç»†èŠ‚çš„æƒé™æ§åˆ¶æ¯”å¦‚åªè¯»ç”¨æˆ·å¯ä»¥å‚è€ƒ <a href="https://mritd.me/2018/03/20/use-rbac-to-control-kubectl-permissions/">ä½¿ç”¨ RBAC æ§åˆ¶ kubectl æƒé™</a>ï¼ŒRBAC æƒé™æ§åˆ¶åŸç†æ˜¯ä¸€æ ·çš„</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="k">if </span>kubectl get sa dashboard-admin <span class="nt">-n</span> kube-system &amp;&gt; /dev/null<span class="p">;</span><span class="k">then
    </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[33mWARNING: ServiceAccount dashboard-admin exist!</span><span class="se">\0</span><span class="s2">33[0m"</span>
<span class="k">else
    </span>kubectl create sa dashboard-admin <span class="nt">-n</span> kube-system
    kubectl create clusterrolebinding dashboard-admin <span class="nt">--clusterrole</span><span class="o">=</span>cluster-admin <span class="nt">--serviceaccount</span><span class="o">=</span>kube-system:dashboard-admin
<span class="k">fi

</span>kubectl describe secret <span class="nt">-n</span> kube-system <span class="si">$(</span>kubectl get secrets <span class="nt">-n</span> kube-system | <span class="nb">grep </span>dashboard-admin | <span class="nb">cut</span> <span class="nt">-f1</span> <span class="nt">-d</span> <span class="s1">' '</span><span class="si">)</span> | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s1">'^token'</span>
</code></pre></div></div>

<p>å°†ä»¥ä¸Šè„šæœ¬ä¿å­˜ä¸º <code class="highlighter-rouge">create_dashboard_sa.sh</code> æ‰§è¡Œå³å¯ï¼ŒæˆåŠŸåè®¿é—®æˆªå›¾å¦‚ä¸‹(<strong>å¦‚æœè®¿é—®ä¸äº†çš„è¯è¯·æ£€æŸ¥ä¸‹ iptable FORWARD é»˜è®¤è§„åˆ™æ˜¯å¦ä¸º DROPï¼Œå¦‚æœæ˜¯å°†å…¶æ”¹ä¸º ACCEPT å³å¯</strong>)</p>

<p><img src="https://cdn.oss.link/markdown/oxmms.png" alt="create_dashboard_sa" /></p>

<p><img src="https://cdn.oss.link/markdown/pyplb.png" alt="dashboard" /></p>

<h3 id="ä¹å…¶ä»–è¯´æ˜">ä¹ã€å…¶ä»–è¯´æ˜</h3>

<h4 id="91é€‰é¡¹-label-ç­‰è¯´æ˜">9.1ã€é€‰é¡¹ label ç­‰è¯´æ˜</h4>

<p>éƒ¨ç½²è¿‡ç¨‹ä¸­æ³¨æ„åˆ°ä¸€äº›é€‰é¡¹å·²ç»åšäº†åç§°æ›´æ”¹ï¼Œæ¯”å¦‚ <code class="highlighter-rouge">--network-plugin-dir</code> å˜æ›´ä¸º <code class="highlighter-rouge">--cni-bin-dir</code> ç­‰ï¼Œå…·ä½“çš„é‚£äº›é€‰é¡¹åšäº†å˜æ›´è¯·è‡ªè¡Œå¯¹æ¯”é…ç½®ï¼Œä»¥åŠæŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼›</p>

<p>å¯¹äº Node label <code class="highlighter-rouge">--node-labels=node-role.kubernetes.io/k8s-node=true</code> è¿™ä¸ªé€‰é¡¹ï¼Œå®ƒçš„ä½œç”¨åªæ˜¯åœ¨ <code class="highlighter-rouge">kubectl get node</code> æ—¶ ROLES æ æ˜¾ç¤ºæ˜¯ä»€ä¹ˆèŠ‚ç‚¹ï¼›ä¸è¿‡éœ€è¦æ³¨æ„ <strong>master ä¸Šçš„ kubelet ä¸è¦å°† <code class="highlighter-rouge">node-role.kubernetes.io/k8s-master=true</code> æ›´æ”¹æˆ <code class="highlighter-rouge">node-role.kubernetes.io/master=xxxx</code>ï¼›åé¢è¿™ä¸ª <code class="highlighter-rouge">node-role.kubernetes.io/master</code> æ˜¯ kubeadm ç”¨çš„ï¼Œè¿™ä¸ª label ä¼šå‘Šè¯‰ k8s è°ƒåº¦å™¨å½“å‰èŠ‚ç‚¹ä¸º masterï¼Œä»è€Œæ‰§è¡Œä¸€äº›ç‰¹å®šåŠ¨ä½œï¼Œæ¯”å¦‚ <code class="highlighter-rouge">node-role.kubernetes.io/master:NoSchedule</code> æ­¤èŠ‚ç‚¹å°†ä¸ä¼šè¢«åˆ†é… podï¼›å…·ä½“å‚è§ <a href="https://github.com/kubernetes-incubator/kubespray/issues/2108">kubespray issue</a> ä»¥åŠ <a href="https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.9.md#mark-master">å®˜æ–¹è®¾è®¡æ–‡æ¡£</a></strong></p>

<p>å¾ˆå¤šäººå¯èƒ½ä¼šå‘ç°å¤§çº¦ 1 å°æ—¶å€™ <code class="highlighter-rouge">kubectl get csr</code> çœ‹ä¸åˆ°ä»»ä½• csr äº†ï¼Œè¿™æ˜¯å› ä¸ºæœ€æ–°ç‰ˆæœ¬å¢åŠ äº† csr æ¸…ç†åŠŸèƒ½ï¼Œ<strong>é»˜è®¤å¯¹äº <code class="highlighter-rouge">approved</code> å’Œ <code class="highlighter-rouge">denied</code> çŠ¶æ€çš„ csr ä¸€å°æ—¶åä¼šè¢«æ¸…ç†ï¼Œå¯¹äº <code class="highlighter-rouge">pending</code> çŠ¶æ€çš„ csr 24 å°æ—¶åä¼šè¢«æ¸…ç†ï¼Œæƒ³é—®æ—¶é—´ä»å“ªæ¥çš„è¯·çœ‹ <a href="https://github.com/kubernetes/kubernetes/blob/fa85bf7094a8a503fede964b7038eed51360ffc7/pkg/controller/certificates/cleaner/cleaner.go#L47">ä»£ç </a>ï¼›PR issue æˆ‘å¿˜è®°äº†ï¼Œå¢åŠ è¿™ä¸ªåŠŸèƒ½çš„èµ·å› å¤§è‡´å°±æ˜¯å› ä¸ºå½“å¼€å¯äº†è¯ä¹¦è½®æ¢åï¼Œcsr ä¼šä¸æ–­å¢åŠ ï¼Œæ‰€ä»¥éœ€è¦å¢åŠ ä¸€ä¸ªæ¸…ç†åŠŸèƒ½</strong></p>

<h4 id="92å¼‚å¸¸åŠè­¦å‘Šè¯´æ˜">9.2ã€å¼‚å¸¸åŠè­¦å‘Šè¯´æ˜</h4>

<p>åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­æˆ‘è®°å½•äº†ä¸€äº›å¼‚å¸¸è­¦å‘Šç­‰ï¼Œä»¥ä¸‹åšä¸€ä¸‹ç»Ÿä¸€è¯´æ˜</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># https://github.com/kubernetes/kubernetes/issues/42158</span>
<span class="c"># è¿™ä¸ªé—®é¢˜è¿˜æ²¡è§£å†³ï¼ŒPR æ²¡æœ‰åˆå¹¶è¢«å…³é—­äº†ï¼Œå¯ä»¥å…³æ³¨ä¸€ä¸‹ä¸Šé¢è¿™ä¸ª issueï¼Œè¢«å…³é—­çš„ PR åœ¨ä¸‹é¢</span>
<span class="c"># https://github.com/kubernetes/kubernetes/pull/49567</span>
Failed to update statusUpdateNeeded field <span class="k">in </span>actual state of world: Failed to <span class="nb">set </span>statusUpdateNeeded to needed <span class="nb">true</span>, because <span class="nv">nodeName</span><span class="o">=</span>...

<span class="c"># https://github.com/kubernetes/kubernetes/issues/59993</span>
<span class="c"># è¿™ä¸ªä¼¼ä¹å·²ç»è§£å†³äº†ï¼Œæ²¡æ—¶é—´æµ‹è¯•ï¼ŒPR åœ°å€åœ¨ä¸‹é¢ï¼Œæˆ‘å¤§è‡´ debug ä¸€ä¸‹ å¥½åƒæ˜¯ cAdvisor çš„é—®é¢˜</span>
<span class="c"># https://github.com/opencontainers/runc/pull/1722</span>
Failed to get system container stats <span class="k">for</span> <span class="s2">"/kubepods"</span>: failed to get cgroup stats <span class="k">for</span> <span class="s2">"/kubepods"</span>: failed to get container info <span class="k">for</span> <span class="s2">"/kubepods"</span>: unknown containe <span class="s2">"/kubepods"</span>

<span class="c"># https://github.com/kubernetes/kubernetes/issues/58217</span>
<span class="c"># æ³¨æ„: è¿™ä¸ªé—®é¢˜ç°åœ¨ä»æœªè§£å†³ï¼Œå¯å…³æ³¨ä¸Šé¢çš„ issueï¼Œè¿™ä¸ªé—®é¢˜å¯èƒ½å½±å“ node image gc</span>
<span class="c"># å¼ºçƒˆä¾èµ–äº kubelet åš å®¿ä¸»æœº image gc çš„éœ€è¦æ³¨æ„ä¸€ä¸‹</span>
Image garbage collection failed once. Stats initialization may not have completed yet: failed to get imageFs info: unable to find data <span class="k">for </span>container /

<span class="c"># æ²¡æ‰¾åˆ°å¤ªå¤šèµ„æ–™ï¼Œä¸è¿‡æ„Ÿè§‰è·Ÿä¸Šé¢é—®é¢˜ç±»ä¼¼</span>
failed to construct signal: <span class="s2">"allocatableMemory.available"</span> error: system container <span class="s2">"pods"</span> not found <span class="k">in </span>metrics
</code></pre></div></div>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET