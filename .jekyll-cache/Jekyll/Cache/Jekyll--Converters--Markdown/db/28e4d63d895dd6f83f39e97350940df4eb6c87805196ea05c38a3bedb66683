I".Â<blockquote>
  <p>å¹´åå›æ¥æœ‰ç‚¹æ‡’ï¼Œä¹Ÿæœ‰ç‚¹å¿™ï¼›1.13 å‡ºæ¥å¥½ä¹…äº†ï¼Œå‘¨æœ«è¿˜æ˜¯å†³å®šæŠ˜è…¾ä¸€ä¸‹å§</p>
</blockquote>

<h2 id="ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</h2>

<p>è€æ ·å­ï¼Œå®‰è£…ç¯å¢ƒä¸º 5 å° Ubuntu 18.04.2 LTS è™šæ‹Ÿæœºï¼Œå…¶ä»–è¯¦ç»†ä¿¡æ¯å¦‚ä¸‹</p>

<table>
  <thead>
    <tr>
      <th>System OS</th>
      <th>IP Address</th>
      <th>Docker</th>
      <th>Kernel</th>
      <th>Application</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.51</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-masterã€etcd</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.52</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-masterã€etcd</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.53</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-masterã€etcd</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.54</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-node</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.55</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-node</td>
    </tr>
  </tbody>
</table>

<p><strong>æ‰€æœ‰é…ç½®ç”Ÿæˆå°†åœ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå®Œæˆï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸å…¶ä»–èŠ‚ç‚¹ root ç”¨æˆ·å…å¯†ç ç™»å½•ï¼Œç”¨äºåˆ†å‘æ–‡ä»¶ï¼›ä¸ºäº†æ–¹ä¾¿æ­å»ºå¼„äº†ä¸€ç‚¹å°è„šæœ¬ï¼Œä»“åº“åœ°å€ <a href="https://github.com/mritd/ktool">ktool</a>ï¼Œæœ¬æ–‡åç»­æ‰€æœ‰è„šæœ¬ã€é…ç½®éƒ½å¯ä»¥åœ¨æ­¤ä»“åº“æ‰¾åˆ°ï¼›å…³äº <a href="https://github.com/cloudflare/cfssl">cfssl</a> ç­‰åŸºæœ¬å·¥å…·ä½¿ç”¨ï¼Œæœ¬æ–‡ä¸å†é˜è¿°</strong></p>

<h2 id="äºŒå®‰è£…-etcd">äºŒã€å®‰è£… Etcd</h2>

<h3 id="21ç”Ÿæˆè¯ä¹¦">2.1ã€ç”Ÿæˆè¯ä¹¦</h3>

<p>Etcd ä»ç„¶å¼€å¯ TLS è®¤è¯ï¼Œæ‰€ä»¥å…ˆä½¿ç”¨ cfssl ç”Ÿæˆç›¸å…³è¯ä¹¦</p>

<ul>
  <li>etcd-root-ca-csr.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd-root-ca"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd Security"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ca"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>etcd-gencert.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"client auth"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>etcd-csr.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd Security"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.51"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.52"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.53"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>æ¥ä¸‹æ¥æ‰§è¡Œç”Ÿæˆå³å¯ï¼›<strong>æˆ‘å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒåœ¨è¯ä¹¦å†…é¢„ç•™å‡ ä¸ª IPï¼Œå·²é˜²æ­¢æ„å¤–æ•…éšœè¿ç§»æ—¶è¿˜éœ€è¦é‡æ–°ç”Ÿæˆè¯ä¹¦ï¼›è¯ä¹¦é»˜è®¤æœŸé™ä¸º 10 å¹´(åŒ…æ‹¬ CA è¯ä¹¦)ï¼Œæœ‰éœ€è¦åŠ å¼ºå®‰å…¨æ€§çš„å¯ä»¥é€‚å½“å‡å°</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">--initca</span><span class="o">=</span><span class="nb">true </span>etcd-root-ca-csr.json | cfssljson <span class="nt">--bare</span> etcd-root-ca
cfssl gencert <span class="nt">--ca</span> etcd-root-ca.pem <span class="nt">--ca-key</span> etcd-root-ca-key.pem <span class="nt">--config</span> etcd-gencert.json etcd-csr.json | cfssljson <span class="nt">--bare</span> etcd
</code></pre></div></div>

<h3 id="22å®‰è£…-etcd">2.2ã€å®‰è£… Etcd</h3>

<h4 id="221å®‰è£…è„šæœ¬">2.2.1ã€å®‰è£…è„šæœ¬</h4>

<p>å®‰è£… Etcd åªéœ€è¦å°†äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åœ¨å¯æ‰§è¡Œç›®å½•ä¸‹ï¼Œç„¶åä¿®æ”¹é…ç½®å¢åŠ  systemd service é…ç½®æ–‡ä»¶å³å¯ï¼›ä¸ºäº†å®‰å…¨æ€§èµ·è§æœ€å¥½ä½¿ç”¨å•ç‹¬çš„ç”¨æˆ·å¯åŠ¨ Etcd</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">ETCD_DEFAULT_VERSION</span><span class="o">=</span><span class="s2">"3.3.12"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">ETCD_VERSION</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[33mWARNING: ETCD_VERSION is blank,use default version: </span><span class="k">${</span><span class="nv">ETCD_DEFAULT_VERSION</span><span class="k">}</span><span class="se">\0</span><span class="s2">33[0m"</span>
  <span class="nv">ETCD_VERSION</span><span class="o">=</span><span class="k">${</span><span class="nv">ETCD_DEFAULT_VERSION</span><span class="k">}</span>
<span class="k">fi</span>

<span class="c"># ä¸‹è½½ Etcd äºŒè¿›åˆ¶æ–‡ä»¶</span>
<span class="k">function </span>download<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"etcd-v</span><span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="s2">-linux-amd64.tar.gz"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>wget https://github.com/coreos/etcd/releases/download/v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span>/etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
        <span class="nb">tar</span> <span class="nt">-zxvf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># ä¸º Etcd åˆ›å»ºå•ç‹¬çš„ç”¨æˆ·</span>
<span class="k">function </span>preinstall<span class="o">(){</span>
	getent group etcd <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="nt">-r</span> etcd
	getent passwd etcd <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> etcd <span class="nt">-d</span> /var/lib/etcd <span class="nt">-s</span> /sbin/nologin <span class="nt">-c</span> <span class="s2">"etcd user"</span> etcd
<span class="o">}</span>

<span class="c"># å®‰è£…(å¤åˆ¶æ–‡ä»¶)</span>
<span class="k">function </span><span class="nb">install</span><span class="o">(){</span>

    <span class="c"># é‡Šæ”¾ Etcd äºŒè¿›åˆ¶æ–‡ä»¶</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">tar</span> <span class="nt">-zxvf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
    <span class="nb">cp </span>etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>/etcd<span class="k">*</span> /usr/local/bin
    <span class="nb">rm</span> <span class="nt">-rf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>

    <span class="c"># å¤åˆ¶ é…ç½®æ–‡ä»¶ åˆ° /etc/etcd(ç›®å½•å†…æ–‡ä»¶ç»“æ„åœ¨ä¸‹é¢)</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp</span> <span class="nt">-r</span> conf /etc/etcd
    <span class="nb">chown</span> <span class="nt">-R</span> etcd:etcd /etc/etcd
    <span class="nb">chmod</span> <span class="nt">-R</span> 755 /etc/etcd/ssl

    <span class="c"># å¤åˆ¶ systemd service é…ç½®</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd systemd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>systemd/<span class="k">*</span>.service /lib/systemd/system
    systemctl daemon-reload
<span class="o">}</span>

<span class="c"># åˆ›å»º Etcd å­˜å‚¨ç›®å½•(å¦‚éœ€è¦æ›´æ”¹ï¼Œè¯·æ±‚æ”¹ /etc/etcd/etcd.conf é…ç½®æ–‡ä»¶)</span>
<span class="k">function </span>postinstall<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/lib/etcd"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/lib/etcd
        <span class="nb">chown</span> <span class="nt">-R</span> etcd:etcd /var/lib/etcd
    <span class="k">fi</span>

<span class="o">}</span>

<span class="c"># ä¾æ¬¡æ‰§è¡Œ</span>
download
preinstall
<span class="nb">install
</span>postinstall
</code></pre></div></div>

<h4 id="222é…ç½®æ–‡ä»¶">2.2.2ã€é…ç½®æ–‡ä»¶</h4>

<p><strong>å…³äºé…ç½®æ–‡ä»¶ç›®å½•ç»“æ„å¦‚ä¸‹(è¯·è‡ªè¡Œå¤åˆ¶è¯ä¹¦)</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conf
â”œâ”€â”€ etcd.conf
â”œâ”€â”€ etcd.conf.cluster.example
â”œâ”€â”€ etcd.conf.single.example
â””â”€â”€ ssl
    â”œâ”€â”€ etcd-key.pem
    â”œâ”€â”€ etcd.pem
    â”œâ”€â”€ etcd-root-ca-key.pem
    â””â”€â”€ etcd-root-ca.pem

1 directory, 7 files
</code></pre></div></div>

<ul>
  <li>etcd.conf</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [member]</span>
<span class="nv">ETCD_NAME</span><span class="o">=</span>etcd1
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/data"</span>
<span class="nv">ETCD_WAL_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/wal"</span>
<span class="nv">ETCD_SNAPSHOT_COUNT</span><span class="o">=</span><span class="s2">"100"</span>
<span class="nv">ETCD_HEARTBEAT_INTERVAL</span><span class="o">=</span><span class="s2">"100"</span>
<span class="nv">ETCD_ELECTION_TIMEOUT</span><span class="o">=</span><span class="s2">"1000"</span>
<span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2380"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2379,http://127.0.0.1:2379"</span>
<span class="nv">ETCD_MAX_SNAPSHOTS</span><span class="o">=</span><span class="s2">"5"</span>
<span class="nv">ETCD_MAX_WALS</span><span class="o">=</span><span class="s2">"5"</span>
<span class="c">#ETCD_CORS=""</span>

<span class="c"># [cluster]</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2380"</span>
<span class="c"># if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. "test=http://..."</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"etcd1=https://192.168.1.51:2380,etcd2=https://192.168.1.52:2380,etcd3=https://192.168.1.53:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">"etcd-cluster"</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2379"</span>
<span class="c">#ETCD_DISCOVERY=""</span>
<span class="c">#ETCD_DISCOVERY_SRV=""</span>
<span class="c">#ETCD_DISCOVERY_FALLBACK="proxy"</span>
<span class="c">#ETCD_DISCOVERY_PROXY=""</span>
<span class="c">#ETCD_STRICT_RECONFIG_CHECK="false"</span>
<span class="c">#ETCD_AUTO_COMPACTION_RETENTION="0"</span>

<span class="c"># [proxy]</span>
<span class="c">#ETCD_PROXY="off"</span>
<span class="c">#ETCD_PROXY_FAILURE_WAIT="5000"</span>
<span class="c">#ETCD_PROXY_REFRESH_INTERVAL="30000"</span>
<span class="c">#ETCD_PROXY_DIAL_TIMEOUT="1000"</span>
<span class="c">#ETCD_PROXY_WRITE_TIMEOUT="5000"</span>
<span class="c">#ETCD_PROXY_READ_TIMEOUT="0"</span>

<span class="c"># [security]</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd.pem"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-key.pem"</span>
<span class="nv">ETCD_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-root-ca.pem"</span>
<span class="nv">ETCD_AUTO_TLS</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd.pem"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-key.pem"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-root-ca.pem"</span>
<span class="nv">ETCD_PEER_AUTO_TLS</span><span class="o">=</span><span class="s2">"true"</span>

<span class="c"># [logging]</span>
<span class="c">#ETCD_DEBUG="false"</span>
<span class="c"># examples for -log-package-levels etcdserver=WARNING,security=DEBUG</span>
<span class="c">#ETCD_LOG_PACKAGE_LEVELS=""</span>
</code></pre></div></div>

<ul>
  <li>etcd.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/etcd/
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span><span class="s2"> /usr/local/bin/etcd --name=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_NAME</span><span class="k">}</span><span class="se">\"</span><span class="s2"> --data-dir=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_DATA_DIR</span><span class="k">}</span><span class="se">\"</span><span class="s2"> --listen-client-urls=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="k">}</span><span class="se">\"</span><span class="s2">"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>æœ€åä¸‰å°æœºå™¨ä¾æ¬¡ä¿®æ”¹ <code class="highlighter-rouge">IP</code>ã€<code class="highlighter-rouge">ETCD_NAME</code> ç„¶åå¯åŠ¨å³å¯ï¼Œ<strong>ç”Ÿäº§ç¯å¢ƒè¯·ä¸è¦å¿˜è®°ä¿®æ”¹é›†ç¾¤ Token ä¸ºçœŸå®éšæœºå­—ç¬¦ä¸² (<code class="highlighter-rouge">ETCD_INITIAL_CLUSTER_TOKEN</code> å˜é‡)</strong>å¯åŠ¨åå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æµ‹è¯•é›†ç¾¤è”é€šæ€§</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node âœ  ~ <span class="nb">export </span><span class="nv">ETCDCTL_API</span><span class="o">=</span>3
docker1.node âœ  ~ etcdctl member list
238b72cdd26e304f, started, etcd2, https://192.168.1.52:2380, https://192.168.1.52:2379
8034142cf01c5d1c, started, etcd3, https://192.168.1.53:2380, https://192.168.1.53:2379
8da171dbef9ded69, started, etcd1, https://192.168.1.51:2380, https://192.168.1.51:2379
</code></pre></div></div>

<h2 id="ä¸‰å®‰è£…-kubernetes">ä¸‰ã€å®‰è£… Kubernetes</h2>

<h3 id="31ç”Ÿæˆè¯ä¹¦åŠé…ç½®">3.1ã€ç”Ÿæˆè¯ä¹¦åŠé…ç½®</h3>

<h4 id="311ç”Ÿæˆè¯ä¹¦">3.1.1ã€ç”Ÿæˆè¯ä¹¦</h4>

<p>æ–°ç‰ˆæœ¬å·²ç»è¶Šæ¥è¶Šè¶‹è¿‘å…¨é¢ TLS + RBAC é…ç½®ï¼Œ<strong>æ‰€ä»¥æœ¬æ¬¡å®‰è£…å°†ä¼šå¯åŠ¨å¤§éƒ¨åˆ† TLS + RBAC é…ç½®ï¼ŒåŒ…æ‹¬ <code class="highlighter-rouge">kube-controler-manager</code>ã€<code class="highlighter-rouge">kube-scheduler</code> ç»„ä»¶ä¸å†è¿æ¥æœ¬åœ° <code class="highlighter-rouge">kube-apiserver</code> çš„ 8080 éè®¤è¯ç«¯å£ï¼Œ<code class="highlighter-rouge">kubelet</code> ç­‰ç»„ä»¶ API ç«¯ç‚¹å…³é—­åŒ¿åè®¿é—®ï¼Œå¯åŠ¨ RBAC è®¤è¯ç­‰</strong>ï¼›ä¸ºäº†æ»¡è¶³è¿™äº›è®¤è¯ï¼Œéœ€è¦ç­¾ç½²ä»¥ä¸‹è¯ä¹¦</p>

<ul>
  <li>k8s-root-ca-csr.json é›†ç¾¤ CA æ ¹è¯ä¹¦</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ca"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>k8s-gencert.json ç”¨äºç”Ÿæˆå…¶ä»–è¯ä¹¦çš„æ ‡å‡†é…ç½®</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"kubernetes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"client auth"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-apiserver-csr.json apiserver TLS è®¤è¯ç«¯å£éœ€è¦çš„è¯ä¹¦</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.254.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"*.master.kubernetes.node"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc.cluster"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc.cluster.local"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-controller-manager-csr.json controller manager è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« <code class="highlighter-rouge">10257</code> ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-controller-manager"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"*.master.kubernetes.node"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-controller-manager"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-scheduler-csr.json scheduler è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦ï¼ŒåŒæ—¶æœ¬èº« <code class="highlighter-rouge">10259</code> ç«¯å£ä¹Ÿä¼šä½¿ç”¨æ­¤è¯ä¹¦</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-scheduler"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"*.master.kubernetes.node"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-scheduler"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-proxy-csr.json proxy ç»„ä»¶è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-proxy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-proxy"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kubelet-api-admin-csr.json apiserver åå‘è¿æ¥ kubelet ç»„ä»¶ <code class="highlighter-rouge">10250</code> ç«¯å£éœ€è¦ä½¿ç”¨çš„è¯ä¹¦(ä¾‹å¦‚æ‰§è¡Œ <code class="highlighter-rouge">kubectl logs</code>)</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kubelet-api-admin"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kubelet-api-admin"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>admin-csr.json é›†ç¾¤ç®¡ç†å‘˜(kubectl)è¿æ¥ apiserver éœ€è¦ä½¿ç”¨çš„è¯ä¹¦</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:masters"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:masters"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>æ³¨æ„: è¯·ä¸è¦ä¿®æ”¹è¯ä¹¦é…ç½®çš„ <code class="highlighter-rouge">CN</code>ã€<code class="highlighter-rouge">O</code> å­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µåç§°æ¯”è¾ƒç‰¹æ®Šï¼Œå¤§å¤šæ•°ä¸º <code class="highlighter-rouge">system:</code> å¼€å¤´ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†åŒ¹é… RBAC è§„åˆ™ï¼Œå…·ä½“è¯·å‚è€ƒ <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings">Default Roles and Role Bindings</a></strong></p>

<p>æœ€åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆå³å¯:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">--initca</span><span class="o">=</span><span class="nb">true </span>k8s-root-ca-csr.json | cfssljson <span class="nt">--bare</span> k8s-root-ca

<span class="k">for </span>targetName <span class="k">in </span>kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet-api-admin admin<span class="p">;</span> <span class="k">do
    </span>cfssl gencert <span class="nt">--ca</span> k8s-root-ca.pem <span class="nt">--ca-key</span> k8s-root-ca-key.pem <span class="nt">--config</span> k8s-gencert.json <span class="nt">--profile</span> kubernetes <span class="nv">$targetName</span><span class="nt">-csr</span>.json | cfssljson <span class="nt">--</span>
bare <span class="nv">$targetName</span>
<span class="k">done</span>
</code></pre></div></div>

<h4 id="312ç”Ÿæˆé…ç½®æ–‡ä»¶">3.1.2ã€ç”Ÿæˆé…ç½®æ–‡ä»¶</h4>

<p>é›†ç¾¤æ­å»ºéœ€è¦é¢„å…ˆç”Ÿæˆä¸€ç³»åˆ—é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆé…ç½®éœ€è¦é¢„å…ˆå®‰è£… <code class="highlighter-rouge">kubectl</code> å‘½ä»¤ï¼Œè¯·è‡ªè¡Œæ ¹æ®æ–‡æ¡£å®‰è£… <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-using-curl">Install kubectl binary using curl</a>ï¼›å…¶ä¸­é…ç½®æ–‡ä»¶åŠå…¶ä½œç”¨å¦‚ä¸‹:</p>

<ul>
  <li><code class="highlighter-rouge">bootstrap.kubeconfig</code> kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µéœ€è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶</li>
  <li><code class="highlighter-rouge">kube-controller-manager.kubeconfig</code> controller manager ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li>
  <li><code class="highlighter-rouge">kube-scheduler.kubeconfig</code> scheduler ç»„ä»¶å¼€å¯å®‰å…¨ç«¯å£åŠ RBAC è®¤è¯æ‰€éœ€é…ç½®</li>
  <li><code class="highlighter-rouge">kube-proxy.kubeconfig</code> proxy ç»„ä»¶è¿æ¥ apiserver æ‰€éœ€é…ç½®æ–‡ä»¶</li>
  <li><code class="highlighter-rouge">audit-policy.yaml</code> apiserver RBAC å®¡è®¡æ—¥å¿—é…ç½®æ–‡ä»¶</li>
  <li><code class="highlighter-rouge">bootstrap.secret.yaml</code> kubelet TLS Bootstarp å¼•å¯¼é˜¶æ®µä½¿ç”¨ Bootstrap Token æ–¹å¼å¼•å¯¼ï¼Œéœ€è¦é¢„å…ˆåˆ›å»ºæ­¤ Token</li>
</ul>

<p>ç”Ÿæˆè¿™äº›é…ç½®æ–‡ä»¶çš„è„šæœ¬å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æŒ‡å®š apiserver åœ°å€</span>
<span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="s2">"https://127.0.0.1:6443"</span>

<span class="c"># ç”Ÿæˆ Bootstrap Token</span>
<span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 6 /dev/urandom | <span class="nb">md5sum</span> | <span class="nb">head</span> <span class="nt">-c</span> 6<span class="si">)</span>
<span class="nv">BOOTSTRAP_TOKEN_SECRET</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 16 /dev/urandom | <span class="nb">md5sum</span> | <span class="nb">head</span> <span class="nt">-c</span> 16<span class="si">)</span>
<span class="nv">BOOTSTRAP_TOKEN</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="s2">.</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_SECRET</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Bootstrap Tokne: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># ç”Ÿæˆ kubelet tls bootstrap é…ç½®</span>
<span class="nb">echo</span> <span class="s2">"Create kubelet bootstrapping kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
kubectl config set-credentials <span class="s2">"system:bootstrap:</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--token</span><span class="o">=</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span><span class="s2">"system:bootstrap:</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig

<span class="c"># ç”Ÿæˆ kube-controller-manager é…ç½®æ–‡ä»¶</span>
<span class="nb">echo</span> <span class="s2">"Create kube-controller-manager kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig
kubectl config set-credentials <span class="s2">"system:kube-controller-manager"</span> <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-controller-manager.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-controller-manager-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:kube-controller-manager <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig 

<span class="c"># ç”Ÿæˆ kube-scheduler é…ç½®æ–‡ä»¶</span>
<span class="nb">echo</span> <span class="s2">"Create kube-scheduler kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig
kubectl config set-credentials <span class="s2">"system:kube-scheduler"</span> <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-scheduler.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-scheduler-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:kube-scheduler <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig 

<span class="c"># ç”Ÿæˆ kube-proxy é…ç½®æ–‡ä»¶</span>
<span class="nb">echo</span> <span class="s2">"Create kube-proxy kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
kubectl config set-credentials <span class="s2">"system:kube-proxy"</span> <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-proxy.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-proxy-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:kube-proxy <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig 

<span class="c"># ç”Ÿæˆ apiserver RBAC å®¡è®¡é…ç½®æ–‡ä»¶ </span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> audit-policy.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
# Log all requests at the Metadata level.
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
</span><span class="no">EOF

</span><span class="c"># ç”Ÿæˆ tls bootstrap token secret é…ç½®æ–‡ä»¶</span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> bootstrap.secret.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-&lt;token id&gt;"
  name: bootstrap-token-</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="sh">
  namespace: kube-system
# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token."
  # Token ID and secret. Required.
  token-id: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="sh">
  token-secret: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_SECRET</span><span class="k">}</span><span class="sh">
  # Expiration. Optional.
  expiration: </span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-d</span><span class="s1">'+2 day'</span> <span class="nt">-u</span> +<span class="s2">"%Y-%m-%dT%H:%M:%SZ"</span><span class="si">)</span><span class="sh">
  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
#  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
</span><span class="no">EOF
</span></code></pre></div></div>

<h3 id="32å¤„ç†-ipvs-åŠä¾èµ–">3.2ã€å¤„ç† ipvs åŠä¾èµ–</h3>

<p>æ–°ç‰ˆæœ¬ç›®å‰ <code class="highlighter-rouge">kube-proxy</code> ç»„ä»¶å…¨éƒ¨é‡‡ç”¨ ipvs æ–¹å¼è´Ÿè½½ï¼Œæ‰€ä»¥ä¸ºäº† <code class="highlighter-rouge">kube-proxy</code> èƒ½æ­£å¸¸å·¥ä½œéœ€è¦é¢„å…ˆå¤„ç†ä¸€ä¸‹ ipvs é…ç½®ä»¥åŠç›¸å…³ä¾èµ–(æ¯å° node éƒ½è¦å¤„ç†)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/sysctl.conf <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
</span><span class="no">EOF

</span>sysctl <span class="nt">-p</span>

<span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/modules <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
</span><span class="no">EOF

</span>apt <span class="nb">install</span> <span class="nt">-y</span> conntrack ipvsadm
</code></pre></div></div>

<h3 id="33éƒ¨ç½²-master">3.3ã€éƒ¨ç½² Master</h3>

<h4 id="331å®‰è£…è„šæœ¬">3.3.1ã€å®‰è£…è„šæœ¬</h4>

<p>master èŠ‚ç‚¹ä¸Šéœ€è¦ä¸‰ä¸ªç»„ä»¶: <code class="highlighter-rouge">kube-apiserver</code>ã€<code class="highlighter-rouge">kube-controller-manager</code>ã€<code class="highlighter-rouge">kube-scheduler</code></p>

<p><strong>å®‰è£…æµç¨‹æ•´ä½“ä¸ºä»¥ä¸‹å‡ æ­¥</strong></p>

<ul>
  <li><strong>åˆ›å»ºå•ç‹¬çš„ <code class="highlighter-rouge">kube</code> ç”¨æˆ·</strong></li>
  <li><strong>å¤åˆ¶ç›¸å…³äºŒè¿›åˆ¶æ–‡ä»¶åˆ° <code class="highlighter-rouge">/usr/bin</code>ï¼Œå¯ä»¥é‡‡ç”¨ <code class="highlighter-rouge">all in one</code> çš„ <code class="highlighter-rouge">hyperkube</code></strong></li>
  <li><strong>å¤åˆ¶é…ç½®æ–‡ä»¶åˆ° <code class="highlighter-rouge">/etc/kubernetes</code></strong></li>
  <li><strong>å¤åˆ¶è¯ä¹¦æ–‡ä»¶åˆ° <code class="highlighter-rouge">/etc/kubernetes/ssl</code></strong></li>
  <li><strong>ä¿®æ”¹é…ç½®å¹¶å¯åŠ¨</strong></li>
</ul>

<p>å®‰è£…è„šæœ¬å¦‚ä¸‹æ‰€ç¤º:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBE_DEFAULT_VERSION</span><span class="o">=</span><span class="s2">"1.13.4"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">KUBE_VERSION</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[33mWARNING: KUBE_VERSION is blank,use default version: </span><span class="k">${</span><span class="nv">KUBE_DEFAULT_VERSION</span><span class="k">}</span><span class="se">\0</span><span class="s2">33[0m"</span>
  <span class="nv">KUBE_VERSION</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_DEFAULT_VERSION</span><span class="k">}</span>
<span class="k">fi</span>

<span class="c"># ä¸‹è½½ hyperkube</span>
<span class="k">function </span>download_k8s<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"hyperkube_v</span><span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>wget https://storage.googleapis.com/kubernetes-release/release/v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>/bin/linux/amd64/hyperkube <span class="nt">-O</span> hyperkube_v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>
        <span class="nb">chmod</span> +x hyperkube_v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># åˆ›å»ºä¸“ç”¨ç”¨æˆ· kube</span>
<span class="k">function </span>preinstall<span class="o">(){</span>
    getent group kube <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="nt">-r</span> kube
    getent passwd kube <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> kube <span class="nt">-d</span> / <span class="nt">-s</span> /sbin/nologin <span class="nt">-c</span> <span class="s2">"Kubernetes user"</span> kube
<span class="o">}</span>

<span class="c"># å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å’Œé…ç½®ä»¥åŠè¯ä¹¦</span>
<span class="k">function </span>install_k8s<span class="o">(){</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy hyperkube...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>hyperkube_v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span> /usr/bin/hyperkube

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Create symbolic link...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="o">(</span><span class="nb">cd</span> /usr/bin <span class="o">&amp;&amp;</span> hyperkube <span class="nt">--make-symlinks</span><span class="o">)</span>

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy kubernetes config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp</span> <span class="nt">-r</span> conf /etc/kubernetes
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"/etc/kubernetes/ssl"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">chown</span> <span class="nt">-R</span> kube:kube /etc/kubernetes/ssl
    <span class="k">fi

    </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy kubernetes systemd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>systemd/<span class="k">*</span>.service /lib/systemd/system
    systemctl daemon-reload
<span class="o">}</span>

<span class="c"># åˆ›å»ºå¿…è¦çš„ç›®å½•å¹¶ä¿®æ”¹æƒé™</span>
<span class="k">function </span>postinstall<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/log/kube-audit"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/log/kube-audit
    <span class="k">fi
    
    if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/lib/kubelet"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/lib/kubelet
    <span class="k">fi
    if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/usr/libexec"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /usr/libexec
    <span class="k">fi
    </span><span class="nb">chown</span> <span class="nt">-R</span> kube:kube /etc/kubernetes /var/log/kube-audit /var/lib/kubelet /usr/libexec
<span class="o">}</span>

<span class="c"># æ‰§è¡Œ</span>
download_k8s
preinstall
install_k8s
postinstall
</code></pre></div></div>

<p><strong>hyperkube æ˜¯ä¸€ä¸ªå¤šåˆä¸€çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé€šè¿‡ <code class="highlighter-rouge">--make-symlinks</code> ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆ kubernetes å„ä¸ªç»„ä»¶çš„è½¯è¿æ¥</strong></p>

<p>è¢«å¤åˆ¶çš„ conf ç›®å½•ç»“æ„å¦‚ä¸‹(æœ€ç»ˆè¢«å¤åˆ¶åˆ° <code class="highlighter-rouge">/etc/kubernetes</code>)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
â”œâ”€â”€ apiserver
â”œâ”€â”€ audit-policy.yaml
â”œâ”€â”€ bootstrap.kubeconfig
â”œâ”€â”€ bootstrap.secret.yaml
â”œâ”€â”€ controller-manager
â”œâ”€â”€ kube-controller-manager.kubeconfig
â”œâ”€â”€ kubelet
â”œâ”€â”€ kube-proxy.kubeconfig
â”œâ”€â”€ kube-scheduler.kubeconfig
â”œâ”€â”€ proxy
â”œâ”€â”€ scheduler
â””â”€â”€ ssl
    â”œâ”€â”€ admin-key.pem
    â”œâ”€â”€ admin.pem
    â”œâ”€â”€ k8s-root-ca-key.pem
    â”œâ”€â”€ k8s-root-ca.pem
    â”œâ”€â”€ kube-apiserver-key.pem
    â”œâ”€â”€ kube-apiserver.pem
    â”œâ”€â”€ kube-controller-manager-key.pem
    â”œâ”€â”€ kube-controller-manager.pem
    â”œâ”€â”€ kubelet-api-admin-key.pem
    â”œâ”€â”€ kubelet-api-admin.pem
    â”œâ”€â”€ kube-proxy-key.pem
    â”œâ”€â”€ kube-proxy.pem
    â”œâ”€â”€ kube-scheduler-key.pem
    â””â”€â”€ kube-scheduler.pem

1 directory, 25 files
</code></pre></div></div>

<h4 id="332é…ç½®æ–‡ä»¶">3.3.2ã€é…ç½®æ–‡ä»¶</h4>

<p>ä»¥ä¸‹ä¸ºç›¸å…³é…ç½®æ–‡ä»¶å†…å®¹</p>

<p><strong>systemd é…ç½®å¦‚ä¸‹</strong></p>

<ul>
  <li>kube-apiserver.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes API Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>etcd.service

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/apiserver
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-apiserver <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ETCD_SERVERS</span> <span class="se">\</span>
	    <span class="nv">$KUBE_API_ADDRESS</span> <span class="se">\</span>
	    <span class="nv">$KUBE_API_PORT</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_PORT</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ALLOW_PRIV</span> <span class="se">\</span>
	    <span class="nv">$KUBE_SERVICE_ADDRESSES</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ADMISSION_CONTROL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_API_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>kube-controller-manager.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Controller Manager
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/controller-manager
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-controller-manager <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
	    <span class="nv">$KUBE_CONTROLLER_MANAGER_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>kube-scheduler.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Scheduler Plugin
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/scheduler
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-scheduler <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
	    <span class="nv">$KUBE_SCHEDULER_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p><strong>æ ¸å¿ƒé…ç½®æ–‡ä»¶</strong></p>

<ul>
  <li>apiserver</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes system config</span>
<span class="c">#</span>
<span class="c"># The following values are used to configure the kube-apiserver</span>
<span class="c">#</span>

<span class="c"># The address on the local server to listen to.</span>
<span class="nv">KUBE_API_ADDRESS</span><span class="o">=</span><span class="s2">"--advertise-address=192.168.1.51 --bind-address=0.0.0.0"</span>

<span class="c"># The port on the local server to listen on.</span>
<span class="nv">KUBE_API_PORT</span><span class="o">=</span><span class="s2">"--secure-port=6443"</span>

<span class="c"># Port minions listen on</span>
<span class="c"># KUBELET_PORT="--kubelet-port=10250"</span>

<span class="c"># Comma separated list of nodes in the etcd cluster</span>
<span class="nv">KUBE_ETCD_SERVERS</span><span class="o">=</span><span class="s2">"--etcd-servers=https://192.168.1.51:2379,https://192.168.1.52:2379,https://192.168.1.53:2379"</span>

<span class="c"># Address range to use for services</span>
<span class="nv">KUBE_SERVICE_ADDRESSES</span><span class="o">=</span><span class="s2">"--service-cluster-ip-range=10.254.0.0/16"</span>

<span class="c"># default admission control policies</span>
<span class="nv">KUBE_ADMISSION_CONTROL</span><span class="o">=</span><span class="s2">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota"</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_API_ARGS</span><span class="o">=</span><span class="s2">" --allow-privileged=true </span><span class="se">\</span><span class="s2">
                --anonymous-auth=false </span><span class="se">\</span><span class="s2">
                --alsologtostderr </span><span class="se">\</span><span class="s2">
                --apiserver-count=3 </span><span class="se">\</span><span class="s2">
                --audit-log-maxage=30 </span><span class="se">\</span><span class="s2">
                --audit-log-maxbackup=3 </span><span class="se">\</span><span class="s2">
                --audit-log-maxsize=100 </span><span class="se">\</span><span class="s2">
                --audit-log-path=/var/log/kube-audit/audit.log </span><span class="se">\</span><span class="s2">
                --audit-policy-file=/etc/kubernetes/audit-policy.yaml </span><span class="se">\</span><span class="s2">
                --authorization-mode=Node,RBAC </span><span class="se">\</span><span class="s2">
                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --enable-bootstrap-token-auth </span><span class="se">\</span><span class="s2">
                --enable-garbage-collector </span><span class="se">\</span><span class="s2">
                --enable-logs-handler </span><span class="se">\</span><span class="s2">
                --endpoint-reconciler-type=lease </span><span class="se">\</span><span class="s2">
                --etcd-cafile=/etc/etcd/ssl/etcd-root-ca.pem </span><span class="se">\</span><span class="s2">
                --etcd-certfile=/etc/etcd/ssl/etcd.pem </span><span class="se">\</span><span class="s2">
                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem </span><span class="se">\</span><span class="s2">
                --etcd-compaction-interval=0s </span><span class="se">\</span><span class="s2">
                --event-ttl=168h0m0s </span><span class="se">\</span><span class="s2">
                --kubelet-https=true </span><span class="se">\</span><span class="s2">
                --kubelet-certificate-authority=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem </span><span class="se">\</span><span class="s2">
                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem </span><span class="se">\</span><span class="s2">
                --kubelet-timeout=3s </span><span class="se">\</span><span class="s2">
                --runtime-config=api/all=true </span><span class="se">\</span><span class="s2">
                --service-node-port-range=30000-50000 </span><span class="se">\</span><span class="s2">
                --service-account-key-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem </span><span class="se">\</span><span class="s2">
                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem </span><span class="se">\</span><span class="s2">
                --v=2"</span>
</code></pre></div></div>

<p>é…ç½®è§£é‡Š:</p>

<table>
  <thead>
    <tr>
      <th>é€‰é¡¹</th>
      <th>ä½œç”¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">--client-ca-file</code></td>
      <td>å®šä¹‰å®¢æˆ·ç«¯ CA</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--endpoint-reconciler-type</code></td>
      <td>master endpoint ç­–ç•¥</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--kubelet-client-certificate</code>ã€<code class="highlighter-rouge">--kubelet-client-key</code></td>
      <td>master åå‘è¿æ¥ kubelet ä½¿ç”¨çš„è¯ä¹¦</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--service-account-key-file</code></td>
      <td>service account ç­¾å key(ç”¨äºæœ‰æ•ˆæ€§éªŒè¯)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--tls-cert-file</code>ã€<code class="highlighter-rouge">--tls-private-key-file</code></td>
      <td>master apiserver <code class="highlighter-rouge">6443</code> ç«¯å£è¯ä¹¦</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>controller-manager</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># The following values are used to configure the kubernetes controller-manager</span>

<span class="c"># defaults from config and apiserver should be adequate</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_CONTROLLER_MANAGER_ARGS</span><span class="o">=</span><span class="s2">"  --address=127.0.0.1 </span><span class="se">\</span><span class="s2">
                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\</span><span class="s2">
                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\</span><span class="s2">
                                --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                                --cluster-name=kubernetes </span><span class="se">\</span><span class="s2">
                                --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --controllers=*,bootstrapsigner,tokencleaner </span><span class="se">\</span><span class="s2">
                                --deployment-controller-sync-period=10s </span><span class="se">\</span><span class="s2">
                                --experimental-cluster-signing-duration=87600h0m0s </span><span class="se">\</span><span class="s2">
                                --enable-garbage-collector=true </span><span class="se">\</span><span class="s2">
                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\</span><span class="s2">
                                --leader-elect=true </span><span class="se">\</span><span class="s2">
                                --node-monitor-grace-period=20s </span><span class="se">\</span><span class="s2">
                                --node-monitor-period=5s </span><span class="se">\</span><span class="s2">
                                --port=10252 </span><span class="se">\</span><span class="s2">
                                --pod-eviction-timeout=2m0s </span><span class="se">\</span><span class="s2">
                                --requestheader-client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --terminated-pod-gc-threshold=50 </span><span class="se">\</span><span class="s2">
                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem </span><span class="se">\</span><span class="s2">
                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem </span><span class="se">\</span><span class="s2">
                                --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --secure-port=10257 </span><span class="se">\</span><span class="s2">
                                --service-cluster-ip-range=10.254.0.0/16 </span><span class="se">\</span><span class="s2">
                                --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --use-service-account-credentials=true </span><span class="se">\</span><span class="s2">
                                --v=2"</span>
</code></pre></div></div>

<p>controller manager å°†ä¸å®‰å…¨ç«¯å£ <code class="highlighter-rouge">10252</code> ç»‘å®šåˆ° 127.0.0.1 ç¡®ä¿ <code class="highlighter-rouge">kuebctl get cs</code> æœ‰æ­£ç¡®è¿”å›ï¼›å°†å®‰å…¨ç«¯å£ <code class="highlighter-rouge">10257</code> ç»‘å®šåˆ° 0.0.0.0 å…¬å¼€ï¼Œæä¾›æœåŠ¡è°ƒç”¨ï¼›<strong>ç”±äº controller manager å¼€å§‹è¿æ¥ apiserver çš„ <code class="highlighter-rouge">6443</code> è®¤è¯ç«¯å£ï¼Œæ‰€ä»¥éœ€è¦ <code class="highlighter-rouge">--use-service-account-credentials</code> é€‰é¡¹æ¥è®© controller manager åˆ›å»ºå•ç‹¬çš„ service account(é»˜è®¤ <code class="highlighter-rouge">system:kube-controller-manager</code> ç”¨æˆ·æ²¡æœ‰é‚£ä¹ˆé«˜æƒé™)</strong></p>

<ul>
  <li>scheduler</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes scheduler config</span>

<span class="c"># default config should be adequate</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_SCHEDULER_ARGS</span><span class="o">=</span><span class="s2">"   --address=127.0.0.1 </span><span class="se">\</span><span class="s2">
                        --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig </span><span class="se">\</span><span class="s2">
                        --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig </span><span class="se">\</span><span class="s2">
                        --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                        --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                        --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig </span><span class="se">\</span><span class="s2">
                        --requestheader-client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                        --secure-port=10259 </span><span class="se">\</span><span class="s2">
                        --leader-elect=true </span><span class="se">\</span><span class="s2">
                        --port=10251 </span><span class="se">\</span><span class="s2">
                        --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem </span><span class="se">\</span><span class="s2">
                        --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem </span><span class="se">\</span><span class="s2">
                        --v=2"</span>
</code></pre></div></div>

<p>shceduler åŒ  controller manager ä¸€æ ·å°†ä¸å®‰å…¨ç«¯å£ç»‘å®šåœ¨æœ¬åœ°ï¼Œå®‰å…¨ç«¯å£å¯¹å¤–å…¬å¼€</p>

<p><strong>æœ€ååœ¨ä¸‰å°èŠ‚ç‚¹ä¸Šè°ƒæ•´ä¸€ä¸‹ IP é…ç½®ï¼Œå¯åŠ¨å³å¯</strong></p>

<h3 id="34éƒ¨ç½²-node">3.4ã€éƒ¨ç½² Node</h3>

<h4 id="341å®‰è£…è„šæœ¬">3.4.1ã€å®‰è£…è„šæœ¬</h4>

<p>node å®‰è£…ä¸ master å®‰è£…è¿‡ç¨‹ä¸€è‡´ï¼Œè¿™é‡Œä¸å†é˜è¿°</p>

<h4 id="342é…ç½®æ–‡ä»¶">3.4.2ã€é…ç½®æ–‡ä»¶</h4>

<p><strong>systemd é…ç½®æ–‡ä»¶</strong></p>

<ul>
  <li>kubelet.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kubelet Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>docker.service
<span class="nv">Requires</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/kubelet
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/kubelet
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kubelet <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_API_SERVER</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_ADDRESS</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_PORT</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_HOSTNAME</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ALLOW_PRIV</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">KillMode</span><span class="o">=</span>process

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>kube-proxy.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kube-Proxy Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/proxy
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-proxy <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
	    <span class="nv">$KUBE_PROXY_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p><strong>æ ¸å¿ƒé…ç½®æ–‡ä»¶</strong></p>

<ul>
  <li>kubelet</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes kubelet (minion) config</span>

<span class="c"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span>
<span class="nv">KUBELET_ADDRESS</span><span class="o">=</span><span class="s2">"--node-ip=192.168.1.54"</span>

<span class="c"># The port for the info server to serve on</span>
<span class="c"># KUBELET_PORT="--port=10250"</span>

<span class="c"># You may leave this blank to use the actual hostname</span>
<span class="nv">KUBELET_HOSTNAME</span><span class="o">=</span><span class="s2">"--hostname-override=docker4.node"</span>

<span class="c"># location of the api-server</span>
<span class="c"># KUBELET_API_SERVER=""</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"  --address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                --allow-privileged </span><span class="se">\</span><span class="s2">
                --anonymous-auth=false </span><span class="se">\</span><span class="s2">
                --authorization-mode=Webhook </span><span class="se">\</span><span class="s2">
                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --network-plugin=cni </span><span class="se">\</span><span class="s2">
                --cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
                --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
                --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
                --cluster-domain=cluster.local </span><span class="se">\</span><span class="s2">
                --cni-conf-dir=/etc/cni/net.d </span><span class="se">\</span><span class="s2">
                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% </span><span class="se">\</span><span class="s2">
                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m </span><span class="se">\</span><span class="s2">
                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% </span><span class="se">\</span><span class="s2">
                --eviction-max-pod-grace-period=30 </span><span class="se">\</span><span class="s2">
                --image-gc-high-threshold=80 </span><span class="se">\</span><span class="s2">
                --image-gc-low-threshold=70 </span><span class="se">\</span><span class="s2">
                --image-pull-progress-deadline=30s </span><span class="se">\</span><span class="s2">
                --kube-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
                --max-pods=100 </span><span class="se">\</span><span class="s2">
                --minimum-image-ttl-duration=720h0m0s </span><span class="se">\</span><span class="s2">
                --node-labels=node.kubernetes.io/k8s-node=true </span><span class="se">\</span><span class="s2">
                --pod-infra-container-image=gcr.azk8s.cn/google_containers/pause-amd64:3.1 </span><span class="se">\</span><span class="s2">
                --port=10250 </span><span class="se">\</span><span class="s2">
                --read-only-port=0 </span><span class="se">\</span><span class="s2">
                --rotate-certificates </span><span class="se">\</span><span class="s2">
                --rotate-server-certificates </span><span class="se">\</span><span class="s2">
                --resolv-conf=/run/systemd/resolve/resolv.conf </span><span class="se">\</span><span class="s2">
                --system-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --fail-swap-on=false </span><span class="se">\</span><span class="s2">
                --v=2"</span>
</code></pre></div></div>

<p><strong>å½“ kubelet ç»„ä»¶è®¾ç½®äº† <code class="highlighter-rouge">--rotate-certificates</code>ï¼Œ<code class="highlighter-rouge">--rotate-server-certificates</code> åä¼šè‡ªåŠ¨æ›´æ–°å…¶ä½¿ç”¨çš„ç›¸å…³è¯ä¹¦ï¼ŒåŒæ—¶æŒ‡å®š <code class="highlighter-rouge">--authorization-mode=Webhook</code> å <code class="highlighter-rouge">10250</code> ç«¯å£ RBAC æˆæƒå°†ä¼šå§”æ‰˜ç»™ apiserver</strong></p>

<ul>
  <li>proxy</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes proxy config</span>
<span class="c"># default config should be adequate</span>
<span class="c"># Add your own!</span>
<span class="nv">KUBE_PROXY_ARGS</span><span class="o">=</span><span class="s2">"   --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                    --cleanup-ipvs=true </span><span class="se">\</span><span class="s2">
                    --cluster-cidr=10.254.0.0/16 </span><span class="se">\</span><span class="s2">
                    --hostname-override=docker4.node </span><span class="se">\</span><span class="s2">
                    --healthz-bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                    --healthz-port=10256 </span><span class="se">\</span><span class="s2">
                    --masquerade-all=true </span><span class="se">\</span><span class="s2">
                    --proxy-mode=ipvs </span><span class="se">\</span><span class="s2">
                    --ipvs-min-sync-period=5s </span><span class="se">\</span><span class="s2">
                    --ipvs-sync-period=5s </span><span class="se">\</span><span class="s2">
                    --ipvs-scheduler=wrr </span><span class="se">\</span><span class="s2">
                    --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig </span><span class="se">\</span><span class="s2">
                    --logtostderr=true </span><span class="se">\</span><span class="s2">
                    --v=2"</span>
</code></pre></div></div>

<p>ç”±äº <code class="highlighter-rouge">kubelet</code> ç»„ä»¶æ˜¯é‡‡ç”¨ TLS Bootstrap å¯åŠ¨ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆåˆ›å»ºç›¸å…³é…ç½®</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ›å»ºç”¨äº tls bootstrap çš„ token secret</span>
kubectl create <span class="nt">-f</span> bootstrap.secret.yaml

<span class="c"># ä¸ºäº†èƒ½è®© kubelet å®ç°è‡ªåŠ¨æ›´æ–°è¯ä¹¦ï¼Œéœ€è¦é…ç½®ç›¸å…³ clusterrolebinding</span>

<span class="c"># å…è®¸ kubelet tls bootstrap åˆ›å»º csr è¯·æ±‚</span>
kubectl create clusterrolebinding create-csrs-for-bootstrapping <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="se">\</span>
    <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding auto-approve-csrs-for-group <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="se">\</span>
    <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding auto-approve-renewals-for-nodes <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="se">\</span>
    <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># åœ¨ kubelet server å¼€å¯ api è®¤è¯çš„æƒ…å†µä¸‹ï¼Œapiserver åå‘è®¿é—® kubelet 10250 éœ€è¦æ­¤æˆæƒ(eg: kubectl logs)</span>
kubectl create clusterrolebinding system:kubelet-api-admin <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:kubelet-api-admin <span class="se">\</span>
    <span class="nt">--user</span><span class="o">=</span>system:kubelet-api-admin
</code></pre></div></div>

<h4 id="343nginx-ä»£ç†">3.4.3ã€Nginx ä»£ç†</h4>

<p>ä¸ºäº†ä¿è¯ apiserver çš„ HAï¼Œéœ€è¦åœ¨æ¯ä¸ª node ä¸Šéƒ¨ç½² nginx æ¥åå‘ä»£ç†(tcp)æ‰€æœ‰ apiserverï¼›ç„¶å kubeletã€kube-proxy ç»„ä»¶è¿æ¥æœ¬åœ° <code class="highlighter-rouge">127.0.0.1:6443</code> è®¿é—® apiserverï¼Œä»¥ç¡®ä¿ä»»ä½• master æŒ‚æ‰ä»¥å node éƒ½ä¸ä¼šå—åˆ°å½±å“</p>

<ul>
  <li>nginx.conf</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error_log stderr notice<span class="p">;</span>

worker_processes auto<span class="p">;</span>
events <span class="o">{</span>
  	multi_accept on<span class="p">;</span>
  	use epoll<span class="p">;</span>
  	worker_connections 1024<span class="p">;</span>
<span class="o">}</span>

stream <span class="o">{</span>
    upstream kube_apiserver <span class="o">{</span>
        least_conn<span class="p">;</span>
        server 192.168.1.51:6443<span class="p">;</span>
        server 192.168.1.52:6443<span class="p">;</span>
        server 192.168.1.53:6443<span class="p">;</span>
    <span class="o">}</span>

    server <span class="o">{</span>
        listen        0.0.0.0:6443<span class="p">;</span>
        proxy_pass    kube_apiserver<span class="p">;</span>
        proxy_timeout 10m<span class="p">;</span>
        proxy_connect_timeout 1s<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>nginx-proxy.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>kubernetes apiserver docker wrapper
<span class="nv">Wants</span><span class="o">=</span>docker.socket
<span class="nv">After</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">PermissionsStartOnly</span><span class="o">=</span><span class="nb">true
</span><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker run <span class="nt">-p</span> 127.0.0.1:6443:6443 <span class="se">\</span>
                              <span class="nt">-v</span> /etc/nginx:/etc/nginx <span class="se">\</span>
                              <span class="nt">--name</span> nginx-proxy <span class="se">\</span>
                              <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
                              <span class="nt">--restart</span><span class="o">=</span>on-failure:5 <span class="se">\</span>
                              <span class="nt">--memory</span><span class="o">=</span>512M <span class="se">\</span>
                              nginx:1.14.2-alpine
<span class="nv">ExecStartPre</span><span class="o">=</span>-/usr/bin/docker <span class="nb">rm</span> <span class="nt">-f</span> nginx-proxy
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop nginx-proxy
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>15s
<span class="nv">TimeoutStartSec</span><span class="o">=</span>30s

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>ç„¶ååœ¨æ¯ä¸ª node ä¸Šå…ˆå¯åŠ¨ nginx-proxyï¼Œæ¥ç€å¯åŠ¨ kubelet ä¸ kube-proxy å³å¯(master ä¸Šçš„ kubeletã€kube-proxy åªéœ€è¦ä¿®æ”¹ ip å’Œ node name)</p>

<h4 id="344kubelet-server-è¯ä¹¦">3.4.4ã€kubelet server è¯ä¹¦</h4>

<p><strong>æ³¨æ„: æ–°ç‰ˆæœ¬ kubelet server çš„è¯ä¹¦è‡ªåŠ¨ç­¾å‘å·²ç»è¢«å…³é—­(çœ‹ issue å¥½åƒæ˜¯ç”±äºå®‰å…¨åŸå› )ï¼Œæ‰€ä»¥å¯¹äº kubelet server çš„è¯ä¹¦ä»éœ€è¦æ‰‹åŠ¨ç­¾ç½²</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node âœ  ~ kubectl get csr
NAME                                                   AGE   REQUESTOR                  CONDITION
csr-99l77                                              10s   system:node:docker4.node   Pending
node-csr-aGwaNKorMc0MZBYOuJsJGCB8Bg8ds97rmE3oKBTV-_E   11s   system:bootstrap:5d820b    Approved,Issued
docker1.node âœ  ~ kubectl certificate approve csr-99l77
certificatesigningrequest.certificates.k8s.io/csr-99l77 approved
</code></pre></div></div>

<h3 id="35éƒ¨ç½²-calico">3.5ã€éƒ¨ç½² Calico</h3>

<p>å½“ node å…¨éƒ¨å¯åŠ¨åï¼Œç”±äºç½‘ç»œç»„ä»¶(CNI)æœªå®‰è£…ä¼šæ˜¾ç¤ºä¸º NotReady çŠ¶æ€ï¼›ä¸‹é¢å°†éƒ¨ç½² Calico ä½œä¸ºç½‘ç»œç»„ä»¶ï¼Œå®Œæˆè·¨èŠ‚ç‚¹ç½‘ç»œé€šè®¯ï¼›å…·ä½“å®‰è£…æ–‡æ¡£å¯ä»¥å‚è€ƒ <a href="https://docs.projectcalico.org/v3.6/getting-started/kubernetes/installation/calico#installing-with-the-etcd-datastore">Installing with the etcd datastore</a></p>

<p>ä»¥ä¸‹ä¸º calico çš„é…ç½®æ–‡ä»¶</p>

<ul>
  <li>calico.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-etcd-secrets.yaml</span>
<span class="c1"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span>
<span class="c1"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-etcd-secrets</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="c1"># Populate the following with etcd TLS configuration if desired, but leave blank if</span>
  <span class="c1"># not using TLS for etcd.</span>
  <span class="c1"># The keys below should be uncommented and the values populated with the base64</span>
  <span class="c1"># encoded contents of each file that would be associated with the TLS data.</span>
  <span class="c1"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span>
  <span class="na">etcd-key</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdGtOVlV5QWtOOWxDKy9EbzlCRkt0em5IZlFJKzJMK2crclkwLzNoOExJTEFoWUtXCm1XdVNNQUFjbyt4clVtaTFlUGIzcmRKR0p1NEhmRXFmalYvakhvN0haOGxteXd0S29Ed254aU9jZDRlRXltcXEKTEFVYzZ5RWU4dXFGZ2pLVHE4SjV2Z1F1cGp0ZlZnZXRPdVVsWWtWbUNKMWtpUW0yVk5WRnRWZ0Fqck1xSy9POApJTXN6RWRYU3BDc1Zwb0kzaUpoVHJSRng4ZzRXc2hwNG1XMzhMWDVJYVVoMWZaSGVMWm1sRURpclBWMGRTNmFWCmJscUk2aUFwanVBc3hYWjFlVTdmOVZWK01PVmNVc3A4cDAxNmJzS3R6VTJGSnB6ZlM3c1BlbGpKZGgzZmVOdk8KRVl1aDlsU0c1VGNKUHBuTTZ0R0ppaHpEWCt4dnNGa3d5MVJSVlFJREFRQUJBb0lCQUYwRXVqd2xVRGFzakJJVwpubDFKb2U4bTd0ZXUyTEk0QW9sUmluVERZZVE1aXRYWWt0R1Q0OVRaaWNSak9WYWlsOU0zZjZwWGdYUUcwUTB1CjdJVHpaZTlIZ1I5SDIwMU80dlFxSDBaeEVENjBqQ0hlRkNGSkxyd1ZlRDBUVWJYajZCZWx0Z296Q2pmT1gxYUIKcm5nN1VEdjZIUnZTYitlOGJEQ1pjKzBjRDVURG4vUWV0R1dtUmpJZ1FhMmlUT2MzSzFiaHo2RTl5Nk9qWkFTMQpiai9NL1dOd20yNHRxQTJEeWdjcGVmUGFnTWtFNm9uYXBFVHhZdi83QmNqcUhtdVd6WE1wMzd6VGpPckwxVDdmClhrbHdFMUYrMDRhRDR6dDZycEdmN0lqSUdvRkEvT2ZrRGZiYkRjN2NsaDJ1SkNMTVE5MGpuSkxMTGRSV3dQRW4KMkkyY3IvVUNnWUVBN3BjT29VV3RwdDJjWGIzSnl3Tkh4aXl1bEc4V1JENjBlQ1MrUXFnQUZndU5JWFJlMEREUwovSWY0M1BhaVB3TjhBS216ZTRKbGsxM3Rnd29qdi9RWVFVblJzZi9PbnpUUlFoWVJXT2lxSE5lSmFvOUxFU0VDClcxNXNmUjhnYzd0dFdPZ0loZkhudmdCR0QvYmUzS1NWVjdUY0lndVVjV3RzeHhLdjZ4LzJNdHNDZ1lFQXc1QVIKWk9HNUp4UGVNV3FVRUR3QjJuQmt6WEtGblpNSEJXV2FOeHpEaTI0NmZEVWM2T1hSTTJJanh2cmVkc3JKQjBXMwovelNDeFdUbkRmL3RJY1lKMjRuTmNsMUNDS2hTNVE5bVZxanZ3dE1SaEF1Uk5VSFJSVjZLNS91V1hHQzAzekR3CkEvMUFSd3lZSHNHTlJVOFRNNnpNRFcxL0x5djZNZ2pnOFBIamk0OENnWUVBa3JwelZOcjFJRm5KZ0J6bnJPSW4Ka2NpSTFPQThZVnZ1d0xSWURjWWp4MnJ6TUUvUXYxaEhhT1oyTmUyM2VlazZxVzJ6NDVFZHhyTk5EZmwrWXQ1Swp6RndKaWQ0M3c5RkhuOHpTZmtzWDB3VDZqWDN5UEdhQWZKQmxSODJNdDUvY2I0RERQUnkzMkRGeTVQNTlzRlBIClJGa0Z5Q28yOEVtUWJCMGg4d2VFOFdFQ2dZQm1IeUptS3RWVUNiVDYyeXZzZWxtQlp6WE1ieVJGRDlVWHhXSE4KcTlDVlMvOXdndy9Rc3NvVzZnWEN6NWhDTWt6ZDVsTmFDbUxMajVCMHFCTjlrbnZ0VDcyZ0hnRHdvbTEvUGhaego1STRuajY3UzVITjBleVU3ODAzWUxISHRWWGErSWtFRDVFaWZrWDBTZW9JNkVqdjF2U05sVTZ1WngzNUVpSXhtClpmb3NFd0tCZ0dQMmpsK0lPcFV5Y2NEL25EbUJWa05CWHoydWhncU8yYjE4d0hSOGdiSXoyVTRBZnpreXVkWUcKZzQvRjJZZVdCSEdNeTc5N0I2c0hjQTdQUWNNdUFuRk11MG9UNkMvanpDSHpoK2VaaS8wdHJRTHJGeWFFaGVuWgpnazduUTdHNHhROWZLZmVTeFcyUlNNUUR0MTZULzNOTitTOEZCTjJmZEliY3V4QWs0WjVHCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span>
  <span class="na">etcd-cert</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZFekNDQXZ1Z0F3SUJBZ0lVRGJqcTdVc2ViY2toZXRZb1RPNnRsc1N1c1k0d0RRWUpLb1pJaHZjTkFRRU4KQlFBd2J6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeERUQUxCZ05WQkFvVEJHVjBZMlF4RmpBVUJnTlZCQXNURFdWMFkyUWdVMlZqZFhKcGRIa3hGVEFUCkJnTlZCQU1UREdWMFkyUXRjbTl2ZEMxallUQWVGdzB4T1RBek1UWXdNelV4TURCYUZ3MHlPVEF6TVRNd016VXgKTURCYU1HY3hDekFKQmdOVkJBWVRBa05PTVJBd0RnWURWUVFJRXdkQ1pXbHFhVzVuTVJBd0RnWURWUVFIRXdkQwpaV2xxYVc1bk1RMHdDd1lEVlFRS0V3UmxkR05rTVJZd0ZBWURWUVFMRXcxbGRHTmtJRk5sWTNWeWFYUjVNUTB3CkN3WURWUVFERXdSbGRHTmtNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXRrTlYKVXlBa045bEMrL0RvOUJGS3R6bkhmUUkrMkwrZytyWTAvM2g4TElMQWhZS1dtV3VTTUFBY28reHJVbWkxZVBiMwpyZEpHSnU0SGZFcWZqVi9qSG83SFo4bG15d3RLb0R3bnhpT2NkNGVFeW1xcUxBVWM2eUVlOHVxRmdqS1RxOEo1CnZnUXVwanRmVmdldE91VWxZa1ZtQ0oxa2lRbTJWTlZGdFZnQWpyTXFLL084SU1zekVkWFNwQ3NWcG9JM2lKaFQKclJGeDhnNFdzaHA0bVczOExYNUlhVWgxZlpIZUxabWxFRGlyUFYwZFM2YVZibHFJNmlBcGp1QXN4WFoxZVU3Zgo5VlYrTU9WY1VzcDhwMDE2YnNLdHpVMkZKcHpmUzdzUGVsakpkaDNmZU52T0VZdWg5bFNHNVRjSlBwbk02dEdKCmloekRYK3h2c0Zrd3kxUlJWUUlEQVFBQm80R3VNSUdyTUE0R0ExVWREd0VCL3dRRUF3SUZvREFkQmdOVkhTVUUKRmpBVUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SXdEQVlEVlIwVEFRSC9CQUl3QURBZEJnTlZIUTRFRmdRVQpFKzVsWWN1LzhieHJ2WjNvUnRSMmEvOVBJRkF3SHdZRFZSMGpCQmd3Rm9BVTJaVWM3R2hGaG1PQXhzRlZ3VEEyCm5lZFJIdmN3TEFZRFZSMFJCQ1V3STRJSmJHOWpZV3hvYjNOMGh3Ui9BQUFCaHdUQXFBRXpod1RBcUFFMGh3VEEKcUFFMU1BMEdDU3FHU0liM0RRRUJEUVVBQTRJQ0FRQUx3Vkc2QW93cklwZzQvYlRwWndWL0pBUWNLSnJGdm52VApabDVDdzIzNDI4UzJLLzIwaXphaStEWUR1SXIwQ0ZCa2xGOXVsK05ROXZMZ1lqcE0rOTNOY3I0dXhUTVZsRUdZCjloc3NyT1FZZVBGUHhBS1k3RGd0K2RWUGwrWlg4MXNWRzJkU3ZBbm9Kd3dEVWt5U0VUY0g5NkszSlNKS2dXZGsKaTYxN21GYnMrTlcxdngrL0JNN2pVU3ZRUzhRb3JGQVE3SlcwYzZ3R2V4RFEzZExvTXJuR3Vocjd0V0E0WjhwawpPaE12cWdhWUZYSThNUm4yemlLV0R6QXNsa0hGd1RZdWhCNURMSEt0RUVwcWhxbGh1RThwTkZMaVVSV2xQWWhlCmpDNnVKZ0hBZDltcSswd2pyTmxqKzlWaDJoZUJWNldXZEROVTZaR2tpR003RW9YbDM1OWdUTzJPUkNLUk5vZ0YKRVplR25HcjJQNDhKbnZjTnFmZzNPdUtYd24wRDVYYllSWjFuYnR5WG9mMFByUUhEU21wUFVPMWNiZUJjSWVtcQpEVWozK0MrRzBRS1FLQlZDTXJzNXJIVlVWVkJZZzk5ZW1sRE1zUE5TZm9JWDQwTVFCeTdKMnpxRVV5M0sxcGlaCkhwT0lZT1RrWDRhczhqcGYxMnkxSXoxRVZydE1xek83d294VmMwdHRZYWN5NzUrVzZuS1hlWjBaand5aTVYSzUKZGduSVhmZW51RUNlWFNDdWZCSmUxVklzaXVWZ3cyRjlUNk5zRDhnQ3A5SlhTamJ1SXpiM3ArNU9uZzM2ZnBRdQpXZVBCY0dQVXE5cGEwZUtOUGJXNjlDUHdtUTQ2cjg0T3hTTURHWC9CMElqNUtNUnZUMmhPUXBqTVpSblc5OUxFCjRMbUJuUTg1Wmc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span>
  <span class="na">etcd-ca</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZyakNDQTVhZ0F3SUJBZ0lVWXVIKzIxYlNaU2hncVYxWkx3a2o4RmpZbUl3d0RRWUpLb1pJaHZjTkFRRU4KQlFBd2J6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeERUQUxCZ05WQkFvVEJHVjBZMlF4RmpBVUJnTlZCQXNURFdWMFkyUWdVMlZqZFhKcGRIa3hGVEFUCkJnTlZCQU1UREdWMFkyUXRjbTl2ZEMxallUQWVGdzB4T1RBek1UWXdNelV4TURCYUZ3MHlPVEF6TVRNd016VXgKTURCYU1HOHhDekFKQmdOVkJBWVRBa05PTVJBd0RnWURWUVFJRXdkQ1pXbHFhVzVuTVJBd0RnWURWUVFIRXdkQwpaV2xxYVc1bk1RMHdDd1lEVlFRS0V3UmxkR05rTVJZd0ZBWURWUVFMRXcxbGRHTmtJRk5sWTNWeWFYUjVNUlV3CkV3WURWUVFERXd4bGRHTmtMWEp2YjNRdFkyRXdnZ0lpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElDRHdBd2dnSUsKQW9JQ0FRRGFLK0s4WStqZkdOY2pOeUloeUhXSE5adWxVZzVKZFpOVU9GOHFXbXJMa0NuY2ZWdVF3dmI4cDFwLwpSSjBFOWo0OFBhZ1RJT3U2TU81R24zejFrZGpHRk9jOVZwMlZjYWJEQzJLWWJvRzdVQ0RmTWkzR1MzUnhUejVkCnh0MG1Ya2liVkMvc01NU2RrRm1mU2FCSXBoKzAyTnMwZURyMzNtUWxTdURlTWozNHJaTkVwMzRnUUk0eElTejAKbXhXR0dWNzcwUE9ScVgrZUthTEpiclp3anFFcnpHMEtEVUlBM0ZuTFdRMnp4b0VwN3JZby9LaGRiOHdETE1kbQp6VXNOZHI0T1F4MFBVRXA4akRUU2lFODkydDQ4KytsOHJ0MW4vTHFRc1FhVncrQlQrMTRvRHdIVkFaRXZ2ZnMwCmZkZ0QvU2RINGJRdHNhT21BdFByQldseU5aMUxIZkR2djMraXFzNk83UXpWUTFCK1c5cFRxdUZ2YUxWN3R1S3UKSXNlUFlseFdjV2E2M0hGbFkxVVJ6M0owaGtrZEZ1dkhUc0dhZDVpaWVrb0dUcFdTN2dVdCtTeWVJT2FhMldHLwp4Y1NiUWE0Y2xiZThuUHV2c1ZFVDhqZ0d0NGVLT25yRVJId0hMb2VleEpsSjdUdnhHNHpOTHZsc2FOL29iRzFDClUzMXczZ2d1SXpzRk5yallsUFdSZ0hSdXdPTlE5anlkM2dqVmNYUFdHTFJISUdYbjNhUDluT3A0OE9WWDhzbXoKOGIwS0V4UVpEQWUyS0tjWEg5a1ZiUFJQSWlLeGpXelV5aDMzQlRNejlPczZHcWM0Zk05c1hxbGRhVzBGd3g4MQpJaklScWx5a3VOSXNDWGhMUzhlNmVtdUNYMTVDZGNKb0ZmdXRuTENvV1B4Umg5OEF4UUlEQVFBQm8wSXdRREFPCkJnTlZIUThCQWY4RUJBTUNBUVl3RHdZRFZSMFRBUUgvQkFVd0F3RUIvekFkQmdOVkhRNEVGZ1FVMlpVYzdHaEYKaG1PQXhzRlZ3VEEybmVkUkh2Y3dEUVlKS29aSWh2Y05BUUVOQlFBRGdnSUJBSjh3bVNJMVBsQm8zcE1RWC9DOQpRS1RrR0xvVUhGdWprdFoxM1FYeXQ1LzFSeVB2WG1lLy90N3FHR2I5RmJZSm9BYTRTd3JSZkYzZmh3UDZaS0FnCnNYSEliR2gwc014UTdqVmQwMUNMWkoxQmZFNGZtTVlaQUlEWGpTcTNqbHJXZWcxL2hWTFN2dXRuUEFWSXc1SWwKZUdXRTMyOVJ2b2d2dXV6dUsxY2xwZFpIL2p3UlZjUUFUK0xvT2xFZ3Rkd293c0xpaWx3WE95eEZLZDd1UDk3bgozTFZUekFNN3Flell4SUVMQVlUUUN5eTdpeEIxNXlJV1UrUWhreUFtWXJoNEN6VUNNUjQreDlpaGZ6UnlOQkxLCmRBRTdwcjdyUEM4WFQ0YWh2SkJCZTg1THViTVdVRmprcEF5cklQODYyYkFCOCtKSXNFdXNZVGdQakUrMGhteTkKT0NIU2x4Q25GQVdPUXcwQ05Kb3AxWGpHU0RZOXlXL1NNWS83T3B0QlBhT3VWTzVwZTg3VmVXRFFtYmlpdnc3MQo4cFhDQnN6ZWNsdjJZKzdscTRnL0FaQkViVXRvLzV4UXJCbmZGKy9hZFFOQzY4aG4yYzZWa3czYTVDR0ZMN0p2CjhWdFNmeFEzZnFUci9TdzlJbkVKVWpuc0Y3R0xINzZMWXZIU05WeldhMkhiVFNlTnQ0RUlpdlEwb2d0b2hzY0kKSHlrZlpRQ3Z6ZnBSZi9TODFiRDNnU29jQ3NzR2crdVpVU0FMdVhBRDE4RkRXNzg2LzRCckcrMzVLOVBLNktUZwpoWGN4WmRHd3V1RWx0aTRBNWx4OHNrZExPSkZ6TUJPWFJNU2Jsc0dna3pGK2JNRkMrMHV3WW1WK0VTRUdwdy9NCm93WUN1dHh2a3ltL2NOcEk1bjFhanpEcQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span>
<span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-config.yaml</span>
<span class="c1"># This ConfigMap is used to configure a self-hosted Calico installation.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="c1"># Configure this with the location of your etcd cluster.</span>
  <span class="na">etcd_endpoints</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://192.168.1.51:2379,https://192.168.1.52:2379,https://192.168.1.53:2379"</span>

  <span class="c1"># If you're using TLS enabled etcd uncomment the following.</span>
  <span class="c1"># You must also populate the Secret below with these files.</span>
  <span class="na">etcd_ca</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/calico-secrets/etcd-ca"</span>
  <span class="na">etcd_cert</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/calico-secrets/etcd-cert"</span>
  <span class="na">etcd_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/calico-secrets/etcd-key"</span>
  <span class="c1"># Typha is disabled.</span>
  <span class="na">typha_service_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">none"</span>
  <span class="c1"># Configure the Calico backend to use.</span>
  <span class="na">calico_backend</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bird"</span>

  <span class="c1"># Configure the MTU to use</span>
  <span class="na">veth_mtu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1440"</span>

  <span class="c1"># The CNI network configuration to install on each node.  The special</span>
  <span class="c1"># values in this config will be automatically populated.</span>
  <span class="na">cni_network_config</span><span class="pi">:</span> <span class="pi">|-</span>
    <span class="s">{</span>
      <span class="s">"name": "k8s-pod-network",</span>
      <span class="s">"cniVersion": "0.3.0",</span>
      <span class="s">"plugins": [</span>
        <span class="s">{</span>
          <span class="s">"type": "calico",</span>
          <span class="s">"log_level": "info",</span>
          <span class="s">"etcd_endpoints": "__ETCD_ENDPOINTS__",</span>
          <span class="s">"etcd_key_file": "__ETCD_KEY_FILE__",</span>
          <span class="s">"etcd_cert_file": "__ETCD_CERT_FILE__",</span>
          <span class="s">"etcd_ca_cert_file": "__ETCD_CA_CERT_FILE__",</span>
          <span class="s">"mtu": __CNI_MTU__,</span>
          <span class="s">"ipam": {</span>
              <span class="s">"type": "calico-ipam"</span>
          <span class="s">},</span>
          <span class="s">"policy": {</span>
              <span class="s">"type": "k8s"</span>
          <span class="s">},</span>
          <span class="s">"kubernetes": {</span>
              <span class="s">"kubeconfig": "__KUBECONFIG_FILEPATH__"</span>
          <span class="s">}</span>
        <span class="s">},</span>
        <span class="s">{</span>
          <span class="s">"type": "portmap",</span>
          <span class="s">"snat": true,</span>
          <span class="s">"capabilities": {"portMappings": true}</span>
        <span class="s">}</span>
      <span class="s">]</span>
    <span class="s">}</span>

<span class="s">---</span>
<span class="c1"># Source: calico/templates/rbac.yaml</span>

<span class="c1"># Include a clusterrole for the kube-controllers component,</span>
<span class="c1"># and bind it to the calico-kube-controllers serviceaccount.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="c1"># Pods are monitored for changing labels.</span>
  <span class="c1"># The node controller monitors Kubernetes nodes.</span>
  <span class="c1"># Namespace and serviceaccount labels are used for policy.</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pods</span>
      <span class="pi">-</span> <span class="s">nodes</span>
      <span class="pi">-</span> <span class="s">namespaces</span>
      <span class="pi">-</span> <span class="s">serviceaccounts</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">list</span>
  <span class="c1"># Watch for changes to Kubernetes NetworkPolicies.</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">networking.k8s.io"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">networkpolicies</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">list</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="c1"># Include a clusterrole for the calico-node DaemonSet,</span>
<span class="c1"># and bind it to the calico-node serviceaccount.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="c1"># The CNI plugin needs to get pods, nodes, and namespaces.</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pods</span>
      <span class="pi">-</span> <span class="s">nodes</span>
      <span class="pi">-</span> <span class="s">namespaces</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">endpoints</span>
      <span class="pi">-</span> <span class="s">services</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="c1"># Used to discover service IPs for advertisement.</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nodes/status</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="c1"># Needed for clearing NodeNetworkUnavailable flag.</span>
      <span class="pi">-</span> <span class="s">patch</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>

<span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-node.yaml</span>
<span class="c1"># This manifest installs the calico/node container, as well</span>
<span class="c1"># as the Calico CNI plugins and network config on</span>
<span class="c1"># each master and worker node in a Kubernetes cluster.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">updateStrategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-node</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="c1"># This, along with the CriticalAddonsOnly toleration below,</span>
        <span class="c1"># marks the pod as a critical add-on, ensuring it gets</span>
        <span class="c1"># priority scheduling and that its resources are reserved</span>
        <span class="c1"># if it ever gets evicted.</span>
        <span class="s">scheduler.alpha.kubernetes.io/critical-pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="c1"># Make sure calico-node gets scheduled on all nodes.</span>
        <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="c1"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">CriticalAddonsOnly</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoExecute</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">calico-node</span>
      <span class="c1"># Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a "force</span>
      <span class="c1"># deletion": https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">initContainers</span><span class="pi">:</span>
        <span class="c1"># This container installs the Calico CNI binaries</span>
        <span class="c1"># and CNI network config file on each node.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install-cni</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">calico/cni:v3.6.0</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/install-cni.sh"</span><span class="pi">]</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># Name of the CNI config file to create.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CNI_CONF_NAME</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10-calico.conflist"</span>
            <span class="c1"># The CNI network config to install on each node.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CNI_NETWORK_CONFIG</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">cni_network_config</span>
            <span class="c1"># The location of the Calico etcd cluster.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_ENDPOINTS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_endpoints</span>
            <span class="c1"># CNI MTU Config variable</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CNI_MTU</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">veth_mtu</span>
            <span class="c1"># Prevents the container from sleeping forever.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SLEEP</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/opt/cni/bin</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">cni-bin-dir</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/etc/cni/net.d</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">cni-net-dir</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/calico-secrets</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="c1"># Runs calico/node container on each Kubernetes node.  This</span>
        <span class="c1"># container programs network policy and routes on each</span>
        <span class="c1"># host.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">calico/node:v3.6.0</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># The location of the Calico etcd cluster.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_ENDPOINTS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_endpoints</span>
            <span class="c1"># Location of the CA certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CA_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_ca</span>
            <span class="c1"># Location of the client key for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_KEY_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_key</span>
            <span class="c1"># Location of the client certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_cert</span>
            <span class="c1"># Set noderef for node controller.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_K8S_NODE_REF</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">fieldRef</span><span class="pi">:</span>
                  <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.nodeName</span>
            <span class="c1"># Choose the backend to use.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_NETWORKING_BACKEND</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">calico_backend</span>
            <span class="c1"># Cluster type to identify the deployment type</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CLUSTER_TYPE</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">k8s,bgp"</span>
            <span class="c1"># Auto-detect the BGP IP address.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">IP</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">autodetect"</span>
            <span class="c1"># Enable IPIP</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_IPIP</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
            <span class="c1"># Set MTU for tunnel device used if ipip is enabled</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_IPINIPMTU</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">veth_mtu</span>
            <span class="c1"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span>
            <span class="c1"># chosen from this range. Changing this value after installation will have</span>
            <span class="c1"># no effect. This should fall within `--cluster-cidr`.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_CIDR</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.20.0.0/16"</span>
            <span class="c1"># Disable file logging so `kubectl logs` works.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_DISABLE_FILE_LOGGING</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
            <span class="c1"># Set Felix endpoint to host default action to ACCEPT.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_DEFAULTENDPOINTTOHOSTACTION</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ACCEPT"</span>
            <span class="c1"># Disable IPv6 on Kubernetes.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_IPV6SUPPORT</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
            <span class="c1"># Set Felix logging to "info"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_LOGSEVERITYSCREEN</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">info"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_HEALTHENABLED</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">IP_AUTODETECTION_METHOD</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">can-reach=192.168.1.51</span>
          <span class="na">securityContext</span><span class="pi">:</span>
            <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
              <span class="na">cpu</span><span class="pi">:</span> <span class="s">250m</span>
          <span class="na">livenessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/liveness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">9099</span>
              <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>
            <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
            <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">6</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">/bin/calico-node</span>
              <span class="pi">-</span> <span class="s">-bird-ready</span>
              <span class="pi">-</span> <span class="s">-felix-ready</span>
            <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/lib/modules</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">lib-modules</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/run/xtables.lock</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">xtables-lock</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/calico</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">var-run-calico</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/calico</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">var-lib-calico</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/calico-secrets</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="c1"># Used by calico/node.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">lib-modules</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/lib/modules</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-run-calico</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/var/run/calico</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-lib-calico</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/var/lib/calico</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">xtables-lock</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/run/xtables.lock</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">FileOrCreate</span>
        <span class="c1"># Used to install CNI.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni-bin-dir</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/opt/cni/bin</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni-net-dir</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/cni/net.d</span>
        <span class="c1"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="c1"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
          <span class="na">secret</span><span class="pi">:</span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">calico-etcd-secrets</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0400</span>
<span class="nn">---</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>

<span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-kube-controllers.yaml</span>
<span class="c1"># This manifest deploys the Calico Kubernetes controllers.</span>
<span class="c1"># See https://github.com/projectcalico/kube-controllers</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">scheduler.alpha.kubernetes.io/critical-pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># The controllers can only have a single active instance.</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="c1"># The controllers must run in the host network namespace so that</span>
      <span class="c1"># it isn't governed by policy that would prevent it from working.</span>
      <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="c1"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">CriticalAddonsOnly</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/master</span>
          <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">calico/kube-controllers:v3.6.0</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># The location of the Calico etcd cluster.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_ENDPOINTS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_endpoints</span>
            <span class="c1"># Location of the CA certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CA_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_ca</span>
            <span class="c1"># Location of the client key for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_KEY_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_key</span>
            <span class="c1"># Location of the client certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_cert</span>
            <span class="c1"># Choose which controllers to run.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ENABLED_CONTROLLERS</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">policy,namespace,serviceaccount,workloadendpoint,node</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="c1"># Mount in the etcd TLS secrets.</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/calico-secrets</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">/usr/bin/check-status</span>
              <span class="pi">-</span> <span class="s">-r</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="c1"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="c1"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
          <span class="na">secret</span><span class="pi">:</span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">calico-etcd-secrets</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0400</span>

<span class="nn">---</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
</code></pre></div></div>

<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬æ·»åŠ äº† <code class="highlighter-rouge">IP_AUTODETECTION_METHOD</code> å˜é‡ï¼Œè¿™ä¸ªå˜é‡ä¼šè®¾ç½® calcio è·å– node ip çš„æ–¹å¼ï¼›é»˜è®¤æƒ…å†µä¸‹é‡‡ç”¨ <a href="https://docs.projectcalico.org/v3.6/reference/node/configuration#ip-autodetection-methods">first-found</a> æ–¹å¼è·å–ï¼Œå³è·å–ç¬¬ä¸€ä¸ªæœ‰æ•ˆç½‘å¡çš„ IP ä½œä¸º node ipï¼›åœ¨æŸäº›å¤šç½‘å¡æœºå™¨ä¸Šå¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼›è¿™é‡Œå°†å€¼è®¾ç½®ä¸º <code class="highlighter-rouge">can-reach=192.168.1.51</code>ï¼Œå³ä½¿ç”¨ç¬¬ä¸€ä¸ªèƒ½å¤Ÿè®¿é—® master <code class="highlighter-rouge">192.168.1.51</code> çš„ç½‘å¡åœ°å€ä½œä¸º node ip</strong></p>

<p>æœ€åæ‰§è¡Œåˆ›å»ºå³å¯ï¼Œåˆ›å»ºæˆåŠŸåå¦‚ä¸‹æ‰€ç¤º</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node âœ  ~ kubectl get pod <span class="nt">-o</span> wide <span class="nt">-n</span> kube-system
NAME                                      READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-65bc6b9f9-cn27f   1/1     Running   0          85s   192.168.1.53   docker3.node   &lt;none&gt;           &lt;none&gt;
calico-node-c5nl8                         1/1     Running   0          85s   192.168.1.53   docker3.node   &lt;none&gt;           &lt;none&gt;
calico-node-fqknv                         1/1     Running   0          85s   192.168.1.51   docker1.node   &lt;none&gt;           &lt;none&gt;
calico-node-ldfzs                         1/1     Running   0          85s   192.168.1.55   docker5.node   &lt;none&gt;           &lt;none&gt;
calico-node-ngjxc                         1/1     Running   0          85s   192.168.1.52   docker2.node   &lt;none&gt;           &lt;none&gt;
calico-node-vj8np                         1/1     Running   0          85s   192.168.1.54   docker4.node   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>æ­¤æ—¶æ‰€æœ‰ node åº”å½“å˜ä¸º Ready çŠ¶æ€</p>

<h3 id="35éƒ¨ç½²-dns">3.5ã€éƒ¨ç½² DNS</h3>

<p>å…¶ä»–ç»„ä»¶å…¨éƒ¨å®Œæˆåæˆ‘ä»¬åº”å½“éƒ¨ç½²é›†ç¾¤ DNS ä½¿ service ç­‰èƒ½å¤Ÿæ­£å¸¸è§£æï¼›é›†ç¾¤ DNS è¿™é‡Œé‡‡ç”¨ corednsï¼Œå…·ä½“å®‰è£…æ–‡æ¡£å‚è€ƒ <a href="https://github.com/coredns/deployment/tree/master/kubernetes">coredns/deployment</a>ï¼›coredns å®Œæ•´é…ç½®å¦‚ä¸‹</p>

<ul>
  <li>coredns.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">kubernetes.io/bootstrapping</span><span class="pi">:</span> <span class="s">rbac-defaults</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:coredns</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">rbac.authorization.kubernetes.io/autoupdate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">kubernetes.io/bootstrapping</span><span class="pi">:</span> <span class="s">rbac-defaults</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:coredns</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:coredns</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">Corefile</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">.:53 {</span>
        <span class="s">errors</span>
        <span class="s">health</span>
        <span class="s">kubernetes cluster.local in-addr.arpa ip6.arpa {</span>
          <span class="s">pods insecure</span>
          <span class="s">upstream</span>
          <span class="s">fallthrough in-addr.arpa ip6.arpa</span>
        <span class="s">}</span>
        <span class="s">prometheus :9153</span>
        <span class="s">forward . /etc/resolv.conf</span>
        <span class="s">cache 30</span>
        <span class="s">loop</span>
        <span class="s">reload</span>
        <span class="s">loadbalance</span>
    <span class="s">}</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
    <span class="s">kubernetes.io/name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CoreDNS"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">priorityClassName</span><span class="pi">:</span> <span class="s">system-cluster-critical</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">coredns</span>
      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CriticalAddonsOnly"</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">coredns/coredns:1.3.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">170Mi</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">70Mi</span>
        <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">-conf"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/etc/coredns/Corefile"</span> <span class="pi">]</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/coredns</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">53</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">dns</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">53</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">dns-tcp</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9153</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">metrics</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">add</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NET_BIND_SERVICE</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">all</span>
          <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">60</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">5</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
      <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">Default</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
            <span class="na">items</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">Corefile</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">Corefile</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">prometheus.io/port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">9153"</span>
    <span class="s">prometheus.io/scrape</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
    <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="s">kubernetes.io/name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CoreDNS"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">10.254.0.2</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dns</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dns-tcp</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">metrics</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">9153</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</code></pre></div></div>

<h3 id="35éƒ¨ç½²-dns-è‡ªåŠ¨æ‰©å®¹">3.5ã€éƒ¨ç½² DNS è‡ªåŠ¨æ‰©å®¹</h3>

<p>åœ¨å¤§è§„æ¨¡é›†ç¾¤çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦é›†ç¾¤ DNS è‡ªåŠ¨æ‰©å®¹ï¼Œå…·ä½“æ–‡æ¡£è¯·å‚è€ƒ <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns-horizontal-autoscaler">DNS Horizontal Autoscaler</a>ï¼ŒDNS æ‰©å®¹ç®—æ³•å¯å‚è€ƒ <a href="https://github.com/kubernetes-incubator/cluster-proportional-autoscaler/">Github</a>ï¼Œå¦‚æœ‰éœ€è¦è¯·è‡ªè¡Œä¿®æ”¹ï¼›ä»¥ä¸‹ä¸ºå…·ä½“é…ç½®</p>

<ul>
  <li>dns-horizontal-autoscaler.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Copyright 2016 The Kubernetes Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:kube-dns-autoscaler</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">nodes"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">replicationcontrollers/scale"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">extensions"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">deployments/scale"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">replicasets/scale"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">]</span>
<span class="c1"># Remove the configmaps rule once below issue is fixed:</span>
<span class="c1"># kubernetes-incubator/cluster-proportional-autoscaler#16</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">configmaps"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:kube-dns-autoscaler</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:kube-dns-autoscaler</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
    <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">scheduler.alpha.kubernetes.io/critical-pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">priorityClassName</span><span class="pi">:</span> <span class="s">system-cluster-critical</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">autoscaler</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.azk8s.cn/google_containers/cluster-proportional-autoscaler-amd64:1.1.2-r2</span>
        <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
                <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">20m"</span>
                <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10Mi"</span>
        <span class="na">command</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">/cluster-proportional-autoscaler</span>
          <span class="pi">-</span> <span class="s">--namespace=kube-system</span>
          <span class="pi">-</span> <span class="s">--configmap=kube-dns-autoscaler</span>
          <span class="c1"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span>
          <span class="pi">-</span> <span class="s">--target=Deployment/coredns</span>
          <span class="c1"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span>
          <span class="c1"># If using small nodes, "nodesPerReplica" should dominate.</span>
          <span class="pi">-</span> <span class="s">--default-params={"linear":{"coresPerReplica":256,"nodesPerReplica":16,"preventSinglePointFailure":true}}</span>
          <span class="pi">-</span> <span class="s">--logtostderr=true</span>
          <span class="pi">-</span> <span class="s">--v=2</span>
      <span class="na">tolerations</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CriticalAddonsOnly"</span>
        <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
</code></pre></div></div>

<h2 id="å››å…¶ä»–">å››ã€å…¶ä»–</h2>

<h3 id="41é›†ç¾¤æµ‹è¯•">4.1ã€é›†ç¾¤æµ‹è¯•</h3>

<p>ä¸ºæµ‹è¯•é›†ç¾¤å·¥ä½œæ­£å¸¸ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª deployment å’Œä¸€ä¸ª serviceï¼Œç”¨äºæµ‹è¯•è”é€šæ€§å’Œ DNS å·¥ä½œæ˜¯å¦æ­£å¸¸ï¼›æµ‹è¯•é…ç½®å¦‚ä¸‹</p>

<ul>
  <li>test.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">test</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.14.2-alpine</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30001</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</code></pre></div></div>

<p>æµ‹è¯•æ–¹å¼å¾ˆç®€å•ï¼Œè¿›å…¥æŸä¸€ä¸ª pod ping å…¶ä»– pod ip ç¡®è®¤ç½‘ç»œæ˜¯å¦æ­£å¸¸ï¼Œç›´æ¥è®¿é—® service åç§°æµ‹è¯• DNS æ˜¯å¦å·¥ä½œæ­£å¸¸ï¼Œè¿™é‡Œä¸å†æ¼”ç¤º</p>

<h3 id="42å…¶ä»–è¯´æ˜">4.2ã€å…¶ä»–è¯´æ˜</h3>

<p>æ­¤æ¬¡æ­å»ºå¼€å¯äº†å¤§éƒ¨åˆ†è®¤è¯ï¼Œé™äºç¯‡å¹…åŸå› æ²¡æœ‰å°†æ¯ä¸ªé€‰é¡¹ä½œç”¨åšå®Œæ•´è§£é‡Šï¼Œæ¨èæ­å»ºå®Œæˆåä»”ç»†é˜…è¯»ä»¥ä¸‹ <code class="highlighter-rouge">--help</code> ä¸­çš„æè¿°(å®˜æ–¹æ–‡æ¡£é¡µé¢æœ‰æ—¶å€™æ›´æ–°ä¸å®Œæ•´)ï¼›ç›®å‰ apiserver ä»ç„¶ä¿ç•™äº† 8080 ç«¯å£(å› ä¸ºç›´æ¥ä½¿ç”¨ kubectl æ–¹ä¾¿)ï¼Œä½†æ˜¯åœ¨é«˜å®‰å…¨æ€§ç¯å¢ƒè¯·å…³é—­ 8080 ç«¯å£ï¼Œå› ä¸ºå³ä½¿ç»‘å®šåœ¨ 127.0.0.1 ä¸Šï¼Œå¯¹äºä»»ä½•èƒ½å¤Ÿç™»å½• master æœºå™¨çš„ç”¨æˆ·ä»ç„¶èƒ½å¤Ÿä¸ç»éªŒè¯æ“ä½œæ•´ä¸ªé›†ç¾¤</p>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET