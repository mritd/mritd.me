I"èh<blockquote>
  <p>æœ€è¿‘åœ¨æµ‹è¯• Kubernetes 1.11.2 æ–°ç‰ˆæœ¬çš„ç›¸å…³ä¸œè¥¿ï¼Œå‘ç°æ–°ç‰ˆæœ¬çš„ Bootstrap Token åŠŸèƒ½å·²ç»è¿›å…¥ Beta é˜¶æ®µï¼Œç´¢æ€§ä¾¿å°è¯•äº†ä¸€ä¸‹ï¼›è™½è¯´ç›®å‰æ˜¯ä¸º kubeadm è®¾è®¡çš„ï¼Œä¸è¿‡æ‰‹åŠ¨æŒ¡ç”¨èµ·æ¥ä¹Ÿä¸é”™ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹ä½¿ç”¨æ–¹å¼</p>
</blockquote>

<h2 id="ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</h2>

<p>é¦–å…ˆéœ€è¦æœ‰ä¸€ä¸ªè¿è¡ŒçŠ¶æ€æ­£å¸¸çš„ Master èŠ‚ç‚¹ï¼Œç›®å‰æˆ‘æµ‹è¯•çš„æ˜¯ç‰ˆæœ¬æ˜¯ 1.11.2ï¼Œä½ç‰ˆæœ¬æˆ‘æ²¡æµ‹è¯•ï¼›å…¶æ¬¡æœ¬æ–‡é»˜è®¤ Node èŠ‚ç‚¹ Dockerã€kubelet äºŒè¿›åˆ¶æ–‡ä»¶ã€systemd service é…ç½®ç­‰éƒ½å·²ç»å¤„ç†å¥½ï¼Œæ›´å…·ä½“çš„ç¯å¢ƒå¦‚ä¸‹:</p>

<p><strong>Master èŠ‚ç‚¹ IP ä¸º <code class="highlighter-rouge">192.168.1.61</code>ï¼ŒNode èŠ‚ç‚¹ IP ä¸º <code class="highlighter-rouge">192.168.1.64</code></strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node âœ  ~ kubectl version
Client Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"11"</span>, GitVersion:<span class="s2">"v1.11.2"</span>, GitCommit:<span class="s2">"bb9ffb1654d4a729bb4cec18ff088eacc153c239"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2018-08-07T23:08:19Z"</span>, GoVersion:<span class="s2">"go1.10.3"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>
Server Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"11"</span>, GitVersion:<span class="s2">"v1.11.2"</span>, GitCommit:<span class="s2">"bb9ffb1654d4a729bb4cec18ff088eacc153c239"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2018-08-07T23:08:19Z"</span>, GoVersion:<span class="s2">"go1.10.3"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>

docker1.node âœ  ~ docker info
Containers: 0
 Running: 0
 Paused: 0
 Stopped: 0
Images: 0
Server Version: 18.06.1-ce
Storage Driver: overlay2
 Backing Filesystem: xfs
 Supports d_type: <span class="nb">true
 </span>Native Overlay Diff: <span class="nb">true
</span>Logging Driver: json-file
Cgroup Driver: cgroupfs
Plugins:
 Volume: <span class="nb">local
 </span>Network: bridge host macvlan null overlay
 Log: awslogs fluentd gcplogs gelf journald json-file logentries splunk syslog
Swarm: inactive
Runtimes: runc
Default Runtime: runc
Init Binary: docker-init
containerd version: 468a545b9edcd5932818eb9de8e72413e616e86e
runc version: 69663f0bd4b60df09991c08812a60108003fa340
init version: fec3683
Security Options:
 apparmor
 seccomp
  Profile: default
Kernel Version: 4.15.0-33-generic
Operating System: Ubuntu 18.04.1 LTS
OSType: linux
Architecture: x86_64
CPUs: 2
Total Memory: 3.847GiB
Name: docker1.node
ID: AJOD:RBJZ:YP3G:HCGV:KT4R:D4AF:SBDN:5B76:JM4M:OCJA:YJMJ:OCYQ
Docker Root Dir: /data/docker
Debug Mode <span class="o">(</span>client<span class="o">)</span>: <span class="nb">false
</span>Debug Mode <span class="o">(</span>server<span class="o">)</span>: <span class="nb">false
</span>Registry: https://index.docker.io/v1/
Labels:
Experimental: <span class="nb">false
</span>Insecure Registries:
 127.0.0.0/8
Live Restore Enabled: <span class="nb">false</span>
</code></pre></div></div>

<h2 id="äºŒtls-bootstrapping-å›é¡¾">äºŒã€TLS Bootstrapping å›é¡¾</h2>

<p>åœ¨æ­£å¼è¿›è¡Œ TLS Bootstrapping æ“ä½œä¹‹å‰ï¼Œ<strong>å¦‚æœå¯¹ TLS Bootstrapping å®Œå…¨æ²¡æ¥è§¦è¿‡çš„è¯·å…ˆé˜…è¯» <a href="https://mritd.me/2018/01/07/kubernetes-tls-bootstrapping-note">Kubernetes TLS bootstrapping é‚£ç‚¹äº‹</a></strong>ï¼›æˆ‘æƒ³è¿™é‡Œæœ‰å¿…è¦ç®€å•è¯´æ˜ä¸‹ä½¿ç”¨ Token æ—¶æ•´ä¸ªå¯åŠ¨å¼•å¯¼è¿‡ç¨‹:</p>

<ul>
  <li>åœ¨é›†ç¾¤å†…åˆ›å»ºç‰¹å®šçš„ <code class="highlighter-rouge">Bootstrap Token Secret</code>ï¼Œè¯¥ Secret å°†æ›¿ä»£ä»¥å‰çš„ <code class="highlighter-rouge">token.csv</code> å†…ç½®ç”¨æˆ·å£°æ˜æ–‡ä»¶</li>
  <li>åœ¨é›†ç¾¤å†…åˆ›å»ºé¦–æ¬¡ TLS Bootstrap ç”³è¯·è¯ä¹¦çš„ ClusterRoleã€åç»­ renew Kubelet client/server çš„ ClusterRoleï¼Œä»¥åŠå…¶ç›¸å…³å¯¹åº”çš„ ClusterRoleBindingï¼›å¹¶ç»‘å®šåˆ°å¯¹åº”çš„ç»„æˆ–ç”¨æˆ·</li>
  <li>è°ƒæ•´ Controller Manager é…ç½®ï¼Œä»¥ä½¿å…¶èƒ½è‡ªåŠ¨ç­¾ç½²ç›¸å…³è¯ä¹¦å’Œè‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ TLS Bootstrapping Token</li>
  <li>ç”Ÿæˆç‰¹å®šçš„åŒ…å« TLS Bootstrapping Token çš„ <code class="highlighter-rouge">bootstrap.kubeconfig</code> ä»¥ä¾› kubelet å¯åŠ¨æ—¶ä½¿ç”¨</li>
  <li>è°ƒæ•´ Kubelet é…ç½®ï¼Œä½¿å…¶é¦–æ¬¡å¯åŠ¨åŠ è½½ <code class="highlighter-rouge">bootstrap.kubeconfig</code> å¹¶ä½¿ç”¨å…¶ä¸­çš„ TLS Bootstrapping Token å®Œæˆé¦–æ¬¡è¯ä¹¦ç”³è¯·</li>
  <li>è¯ä¹¦è¢« Controller Manager ç­¾ç½²ï¼ŒæˆåŠŸä¸‹å‘ï¼ŒKubelet è‡ªåŠ¨é‡è½½å®Œæˆå¼•å¯¼æµç¨‹</li>
  <li>åç»­ Kubelet è‡ªåŠ¨ renew ç›¸å…³è¯ä¹¦</li>
  <li>å¯é€‰çš„: é›†ç¾¤æ­å»ºæˆåŠŸåç«‹å³æ¸…é™¤ <code class="highlighter-rouge">Bootstrap Token Secret</code>ï¼Œæˆ–ç­‰å¾… Controller Manager å¾…å…¶è¿‡æœŸååˆ é™¤ï¼Œä»¥é˜²æ­¢è¢«æ¶æ„åˆ©ç”¨</li>
</ul>

<h2 id="ä¸‰ä½¿ç”¨-bootstrap-token">ä¸‰ã€ä½¿ç”¨ Bootstrap Token</h2>

<p>ç¬¬äºŒéƒ¨åˆ†ç®—ä½œå¤§çº²äº†ï¼Œè¿™éƒ¨åˆ†å°†ä¼šæŒ‰ç…§ç¬¬äºŒéƒ¨åˆ†çš„æ€»ä½“æµç¨‹æ¥èµ°ï¼ŒåŒæ—¶ä¼šå¯¹ä¸€äº›ç»†èŠ‚è¿›è¡Œè¯¦ç»†è¯´æ˜</p>

<h3 id="31åˆ›å»º-bootstrap-token">3.1ã€åˆ›å»º Bootstrap Token</h3>

<p>æ—¢ç„¶æ•´ä¸ªåŠŸèƒ½éƒ½æ—¶åˆ»å¼ºè°ƒè¿™ä¸ª Tokenï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥è‚¯å®šæ˜¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œç”Ÿæˆæ–¹å¼å¦‚ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ  ~ <span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 6 /dev/urandom | <span class="nb">md5sum</span> | <span class="nb">head</span> <span class="nt">-c</span> 6<span class="si">)</span><span class="s2">"</span>.<span class="s2">"</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 16 /dev/urandom | <span class="nb">md5sum</span> | <span class="nb">head</span> <span class="nt">-c</span> 16<span class="si">)</span><span class="s2">"</span>
47f392.d22d04e89a65eb22
</code></pre></div></div>

<p>è¿™ä¸ª <code class="highlighter-rouge">47f392.d22d04e89a65eb22</code> å°±æ˜¯ç”Ÿæˆçš„ Bootstrap Tokenï¼Œä¿å­˜å¥½ tokenï¼Œå› ä¸ºåç»­è¦ç”¨ï¼›å…³äºè¿™ä¸ª token è§£é‡Šå¦‚ä¸‹:</p>

<p>Token å¿…é¡»æ»¡è¶³ <code class="highlighter-rouge">[a-z0-9]{6}\.[a-z0-9]{16}</code> æ ¼å¼ï¼›ä»¥ <code class="highlighter-rouge">.</code> åˆ†å‰²ï¼Œå‰é¢çš„éƒ¨åˆ†è¢«ç§°ä½œ  <code class="highlighter-rouge">Token ID</code>ï¼Œ<code class="highlighter-rouge">Token ID</code> å¹¶ä¸æ˜¯ â€œæœºå¯†ä¿¡æ¯â€ï¼Œå®ƒå¯ä»¥æš´éœ²å‡ºå»ï¼›ç›¸å¯¹çš„åé¢çš„éƒ¨åˆ†ç§°ä¸º <code class="highlighter-rouge">Token Secret</code>ï¼Œå®ƒåº”è¯¥æ˜¯ä¿å¯†çš„</p>

<p>æœ¬éƒ¨åˆ†å®˜æ–¹æ–‡æ¡£åœ°å€ <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#token-format">Token Format</a></p>

<h3 id="32åˆ›å»º-bootstrap-token-secret">3.2ã€åˆ›å»º Bootstrap Token Secret</h3>

<p>å¯¹äº Kubernetes æ¥è¯´ <code class="highlighter-rouge">Bootstrap Token Secret</code> ä¹Ÿä»…ä»…æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ <code class="highlighter-rouge">Secret</code> è€Œå·²ï¼›å¯¹äºè¿™ä¸ªç‰¹æ®Šçš„ <code class="highlighter-rouge">Secret</code> æ ·ä¾‹ yaml é…ç½®å¦‚ä¸‹:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="c1"># Name MUST be of form "bootstrap-token-&lt;token id&gt;"</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">bootstrap-token-07401b</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>

<span class="c1"># Type MUST be 'bootstrap.kubernetes.io/token'</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">bootstrap.kubernetes.io/token</span>
<span class="na">stringData</span><span class="pi">:</span>
  <span class="c1"># Human readable description. Optional.</span>
  <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">The</span><span class="nv"> </span><span class="s">default</span><span class="nv"> </span><span class="s">bootstrap</span><span class="nv"> </span><span class="s">token</span><span class="nv"> </span><span class="s">generated</span><span class="nv"> </span><span class="s">by</span><span class="nv"> </span><span class="s">'kubeadm</span><span class="nv"> </span><span class="s">init'."</span>

  <span class="c1"># Token ID and secret. Required.</span>
  <span class="na">token-id</span><span class="pi">:</span> <span class="s">47f392</span>
  <span class="na">token-secret</span><span class="pi">:</span> <span class="s">d22d04e89a65eb22</span>

  <span class="c1"># Expiration. Optional.</span>
  <span class="na">expiration</span><span class="pi">:</span> <span class="s">2018-09-10T00:00:11Z</span>

  <span class="c1"># Allowed usages.</span>
  <span class="na">usage-bootstrap-authentication</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">usage-bootstrap-signing</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>

  <span class="c1"># Extra groups to authenticate the token as. Must start with "system:bootstrappers:"</span>
  <span class="na">auth-extra-groups</span><span class="pi">:</span> <span class="s">system:bootstrappers:worker,system:bootstrappers:ingress</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„å‡ ç‚¹:</p>

<ul>
  <li>ä½œä¸º <code class="highlighter-rouge">Bootstrap Token Secret</code> çš„ type å¿…é¡»ä¸º <code class="highlighter-rouge">bootstrap.kubernetes.io/token</code>ï¼Œname å¿…é¡»ä¸º <code class="highlighter-rouge">bootstrap-token-&lt;token id&gt;</code> (Token ID å°±æ˜¯ä¸Šä¸€æ­¥åˆ›å»ºçš„ Token å‰ä¸€éƒ¨åˆ†)</li>
  <li><code class="highlighter-rouge">usage-bootstrap-authentication</code>ã€<code class="highlighter-rouge">usage-bootstrap-signing</code> å¿…é¡»å­˜æ‰ä¸”è®¾ç½®ä¸º <code class="highlighter-rouge">true</code> (æˆ‘ä¸ªäººæ„Ÿè§‰ <code class="highlighter-rouge">usage-bootstrap-signing</code> å¯ä»¥æ²¡æœ‰ï¼Œå…·ä½“è§æ–‡ç« æœ€åéƒ¨åˆ†)</li>
  <li><code class="highlighter-rouge">expiration</code> å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå¦‚æœè®¾ç½®åˆ™ <code class="highlighter-rouge">Secret</code> åˆ°æœŸåå°†ç”± Controller Manager ä¸­çš„ <code class="highlighter-rouge">tokencleaner</code> è‡ªåŠ¨æ¸…ç†</li>
  <li><code class="highlighter-rouge">auth-extra-groups</code> ä¹Ÿæ˜¯å¯é€‰çš„ï¼Œä»¤ç‰Œçš„æ‰©å±•è®¤è¯ç»„ï¼Œç»„å¿…é¡»ä»¥ <code class="highlighter-rouge">system:bootstrappers:</code> å¼€å¤´</li>
</ul>

<p>æœ€åä½¿ç”¨ <code class="highlighter-rouge">kubectl create -f bootstrap.secret.yaml</code> åˆ›å»ºå³å¯</p>

<p>æœ¬éƒ¨åˆ†å®˜æ–¹æ–‡æ¡£åœ°å€ <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#bootstrap-token-secret-format">Bootstrap Token Secret Format</a></p>

<h3 id="33åˆ›å»º-clusterrole-å’Œ-clusterrolebinding">3.3ã€åˆ›å»º ClusterRole å’Œ ClusterRoleBinding</h3>

<p>å…·ä½“éƒ½æœ‰å“ªäº› <code class="highlighter-rouge">ClusterRole</code> å’Œ <code class="highlighter-rouge">ClusterRoleBinding</code>ï¼Œä»¥åŠå…¶ä½œç”¨è¯·å‚è€ƒä¸Šä¸€ç¯‡çš„ <a href="https://mritd.me/2018/01/07/kubernetes-tls-bootstrapping-note">Kubernetes TLS bootstrapping é‚£ç‚¹äº‹</a>ï¼Œä¸æƒ³åœ¨è¿™é‡Œé‡å¤äº†</p>

<p>åœ¨ 1.8 ä»¥åä¸‰ä¸ª <code class="highlighter-rouge">ClusterRole</code> ä¸­æœ‰ä¸¤ä¸ªå·²ç»æœ‰äº†ï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºå‰©ä¸‹çš„ä¸€ä¸ªå³å¯:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># A ClusterRole which instructs the CSR approver to approve a node requesting a</span>
<span class="c1"># serving cert matching its client cert.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificates.k8s.io"</span><span class="pi">]</span>
  <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">certificatesigningrequests/selfnodeserver"</span><span class="pi">]</span>
  <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
</code></pre></div></div>

<p>ç„¶åæ˜¯ä¸‰ä¸ª <code class="highlighter-rouge">ClusterRole</code> å¯¹åº”çš„ <code class="highlighter-rouge">ClusterRoleBinding</code>ï¼›éœ€è¦æ³¨æ„çš„æ˜¯ <strong>åœ¨ä½¿ç”¨ <code class="highlighter-rouge">Bootstrap Token</code> è¿›è¡Œå¼•å¯¼æ—¶ï¼ŒKubelet ç»„ä»¶ä½¿ç”¨ Token å‘èµ·çš„è¯·æ±‚å…¶ç”¨æˆ·åä¸º <code class="highlighter-rouge">system:bootstrap:&lt;token id&gt;</code>ï¼Œç”¨æˆ·ç»„ä¸º <code class="highlighter-rouge">system:bootstrappers</code>ï¼›so æˆ‘ä»¬åœ¨åˆ›å»º <code class="highlighter-rouge">ClusterRoleBinding</code> æ—¶è¦ç»‘å®šåˆ°è¿™ä¸ªç”¨æˆ·æˆ–è€…ç»„ä¸Š</strong>ï¼›å½“ç„¶æˆ‘é€‰æ‹©æ‡’ä¸€ç‚¹ï¼Œå…¨éƒ¨ç»‘å®šåˆ°ç»„ä¸Š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å…è®¸ system:bootstrappers ç»„ç”¨æˆ·åˆ›å»º CSR è¯·æ±‚</span>
kubectl create clusterrolebinding kubelet-bootstrap <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:bootstrappers ç»„ç”¨æˆ· TLS bootstrapping é¦–æ¬¡ç”³è¯·è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-approve-csr <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet è‡ªèº«ä¸ apiserver é€šè®¯è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-client-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># è‡ªåŠ¨æ‰¹å‡† system:nodes ç»„ç”¨æˆ·æ›´æ–° kubelet 10250 api ç«¯å£è¯ä¹¦çš„ CSR è¯·æ±‚</span>
kubectl create clusterrolebinding node-server-auto-renew-crt <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeserver <span class="nt">--group</span><span class="o">=</span>system:nodes
</code></pre></div></div>

<p>å…³äºæœ¬éƒ¨åˆ†é¦–æ¬¡è¯·æ±‚ç”¨æˆ·åå˜ä¸º <code class="highlighter-rouge">system:bootstrap:&lt;token id&gt;</code> å®˜æ–¹æ–‡æ¡£åŸæ–‡å¦‚ä¸‹:</p>

<blockquote>
  <p>Tokens authenticate as the username system:bootstrap:<token> and are members of the group system:bootstrappers. Additional groups may be specified in the tokenâ€™s Secret.</token></p>
</blockquote>

<h3 id="34è°ƒæ•´-controller-manager">3.4ã€è°ƒæ•´ Controller Manager</h3>

<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£æè¿°ï¼ŒController Manager éœ€è¦å¯ç”¨ <code class="highlighter-rouge">tokencleaner</code> å’Œ <code class="highlighter-rouge">bootstrapsigner</code> (ç›®æµ‹è¿™ä¸ª <code class="highlighter-rouge">bootstrapsigner</code> å®é™…ä¸Šå¹¶ä¸éœ€è¦ï¼Œé¡ºä¾¿åŠ ç€å§)ï¼Œå®Œæ•´é…ç½®å¦‚ä¸‹(ä¸ºä»€ä¹ˆè´´å®Œæ•´é…ç½®? æ–‡ç« å‡‘æ•°å•Šâ€¦):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBE_CONTROLLER_MANAGER_ARGS</span><span class="o">=</span><span class="s2">"  --address=127.0.0.1 </span><span class="se">\</span><span class="s2">
                                --bind-address=192.168.1.61 </span><span class="se">\</span><span class="s2">
                                --port=10252 </span><span class="se">\</span><span class="s2">
                                --secure-port=10258 </span><span class="se">\</span><span class="s2">
                                --cluster-name=kubernetes </span><span class="se">\</span><span class="s2">
                                --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --controllers=*,bootstrapsigner,tokencleaner </span><span class="se">\</span><span class="s2">
                                --deployment-controller-sync-period=10s </span><span class="se">\</span><span class="s2">
                                --experimental-cluster-signing-duration=86700h0m0s </span><span class="se">\</span><span class="s2">
                                --enable-garbage-collector=true </span><span class="se">\</span><span class="s2">
                                --leader-elect=true </span><span class="se">\</span><span class="s2">
                                --master=http://127.0.0.1:8080 </span><span class="se">\</span><span class="s2">
                                --node-monitor-grace-period=40s </span><span class="se">\</span><span class="s2">
                                --node-monitor-period=5s </span><span class="se">\</span><span class="s2">
                                --pod-eviction-timeout=5m0s </span><span class="se">\</span><span class="s2">
                                --terminated-pod-gc-threshold=50 </span><span class="se">\</span><span class="s2">
                                --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --feature-gates=RotateKubeletServerCertificate=true"</span>
</code></pre></div></div>

<h3 id="35ç”Ÿæˆ-bootstrapkubeconfig">3.5ã€ç”Ÿæˆ bootstrap.kubeconfig</h3>

<p>å‰é¢æ‰€æœ‰æ­¥éª¤å®é™…ä¸Šéƒ½æ˜¯åœ¨å¤„ç† Api Serverã€Controller Manager è¿™ä¸€å—ï¼Œä¸ºçš„å°±æ˜¯ â€œè€å­å¯åŠ¨å TLS Bootstarpping å‘è¯ä¹¦ç”³è¯·ä½ ä¸¤ä¸ªè¦ç«‹é©¬å…è®¸ï¼Œä¸èƒ½æ‹’ç»è€å­â€ï¼›æ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒé‡è¦çš„ <code class="highlighter-rouge">bootstrap.kubeconfig</code> é…ç½®ç”Ÿæˆï¼Œè¿™ä¸ª <code class="highlighter-rouge">bootstrap.kubeconfig</code> æ˜¯æœ€ç»ˆè¢« Kubelet ä½¿ç”¨çš„ï¼Œé‡Œé¢åŒ…å«äº†ç›¸å…³çš„ Tokenï¼Œä»¥å¸®åŠ© Kubelet åœ¨ç¬¬ä¸€æ¬¡é€šè®¯æ—¶èƒ½æˆåŠŸæ²Ÿé€š Api Serverï¼›ç”Ÿæˆæ–¹å¼å¦‚ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># è®¾ç½®é›†ç¾¤å‚æ•°</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>/etc/kubernetes/ssl/k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span>https://127.0.0.1:6443 <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
<span class="c"># è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°</span>
kubectl config set-credentials system:bootstrap:47f392 <span class="se">\</span>
  <span class="nt">--token</span><span class="o">=</span>47f392.d22d04e89a65eb22 <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
<span class="c"># è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°</span>
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:bootstrap:47f392 <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
<span class="c"># è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡</span>
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
</code></pre></div></div>

<h3 id="36è°ƒæ•´-kubelet">3.6ã€è°ƒæ•´ Kubelet</h3>

<p>Kubelet å¯åŠ¨å‚æ•°éœ€è¦åšä¸€äº›ç›¸åº”è°ƒæ•´ï¼Œä»¥ä½¿å…¶èƒ½æ­£ç¡®çš„ä½¿ç”¨ <code class="highlighter-rouge">Bootstartp Token</code>ï¼Œå®Œæ•´é…ç½®å¦‚ä¸‹(ä¸ä½¿ç”¨ token.csv é…ç½®æ²¡ä»€ä¹ˆå˜åŒ–ï¼Œå› ä¸ºä¸»è¦å˜æ›´åœ¨ bootstrap.kubeconfig ä¸­):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"  --address=192.168.1.64 </span><span class="se">\</span><span class="s2">
                --allow-privileged=true </span><span class="se">\</span><span class="s2">
                --alsologtostderr </span><span class="se">\</span><span class="s2">
                --anonymous-auth=true </span><span class="se">\</span><span class="s2">
                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
                --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
                --cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
                --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
                --cluster-domain=cluster.local. </span><span class="se">\</span><span class="s2">
                --fail-swap-on=false </span><span class="se">\</span><span class="s2">
                --healthz-port=10248 </span><span class="se">\</span><span class="s2">
                --healthz-bind-address=192.168.1.64 </span><span class="se">\</span><span class="s2">
                --feature-gates=RotateKubeletClientCertificate=true,RotateKubeletServerCertificate=true </span><span class="se">\</span><span class="s2">
                --node-labels=node-role.kubernetes.io/k8s-master=true </span><span class="se">\</span><span class="s2">
                --image-gc-high-threshold=70 </span><span class="se">\</span><span class="s2">
                --image-gc-low-threshold=50 </span><span class="se">\</span><span class="s2">
                --kube-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
                --system-reserved=cpu=1000m,memory=1024Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --serialize-image-pulls=false </span><span class="se">\</span><span class="s2">
                --sync-frequency=30s </span><span class="se">\</span><span class="s2">
                --pod-infra-container-image=k8s.gcr.io/pause:3.1 </span><span class="se">\</span><span class="s2">
                --resolv-conf=/etc/resolv.conf </span><span class="se">\</span><span class="s2">
                --rotate-certificates"</span>
</code></pre></div></div>

<p><strong>ä¸€åˆ‡å‡†å¤‡å°±ç»ªåï¼Œæ‰§è¡Œ <code class="highlighter-rouge">systemctl daemon-reload &amp;&amp; systemctl start kubelet</code> å¯åŠ¨å³å¯</strong></p>

<h2 id="å››å…¶ä»–è¯´æ˜">å››ã€å…¶ä»–è¯´æ˜</h2>

<p>å¯èƒ½æœ‰äººå·²ç»æ³¨æ„åˆ°ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æœ€åéƒ¨åˆ†æœ‰å…³äº <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#configmap-signing">ConfigMap Signing</a> çš„ç›¸å…³æè¿°ï¼ŒåŒæ—¶è¦æ±‚äº†å¯ç”¨ <code class="highlighter-rouge">bootstrapsigner</code> è¿™ä¸ª controllerï¼Œè€Œä¸”åœ¨ä¸Šæ–‡åˆ›å»º <code class="highlighter-rouge">Bootstrap Token Secret</code> ä¸­æˆ‘ä¹Ÿè¯´ <code class="highlighter-rouge">usage-bootstrap-signing</code> è¿™ä¸ªå¯ä»¥ä¸è®¾ç½®ï¼›å…¶ä¸­å®˜æ–¹æ–‡æ¡£ä¸Šçš„æè¿°æˆ‘ä»¬èƒ½çœ‹åˆ°çš„å¤§è‡´åªè¯´äº†è¿™ä¹ˆä¸¤æ®µç¨å¾®æœ‰ç‚¹ç”¨çš„è¯:</p>

<blockquote>
  <p>In addition to authentication, the tokens can be used to sign a ConfigMap. This is used early in a cluster bootstrap process before the client trusts the API server. The signed ConfigMap can be authenticated by the shared token.</p>
</blockquote>

<blockquote>
  <p>The ConfigMap that is signed is cluster-info in the kube-public namespace. The typical flow is that a client reads this ConfigMap while unauthenticated and ignoring TLS errors. It then validates the payload of the ConfigMap by looking at a signature embedded in the ConfigMap.</p>
</blockquote>

<p>ä»è¿™ä¸¤æ®µè¯ä¸­æˆ‘ä»¬åªèƒ½å¾—å‡ºä¸¤ä¸ªç»“è®º:</p>

<ul>
  <li>Bootstrap Token èƒ½å¯¹ ConfigMap ç­¾å</li>
  <li>å¯ä»¥ç­¾åä¸€ä¸ª <code class="highlighter-rouge">kube-public</code> NameSpace ä¸‹çš„åå­—å« <code class="highlighter-rouge">cluster-info</code> çš„ ConfigMapï¼Œå¹¶ä¸”è¿™ä¸ª ConfigMap å¯ä»¥åœ¨æ²¡è¿›è¡Œå¼•å¯¼ä¹‹å‰å¼ºè¡Œè¯»å–</li>
</ul>

<p>è¯´å®è¯è¿™ä¸¤æ®µè¯æå¾—æˆ‘ç™¾æ€ä¸å¾—<del>éª‘å§</del>å…¶è§£ï¼Œæœ€ç»ˆæˆ‘åœ¨ kubeadm çš„ç›¸å…³æ–‡æ¡£ä¸­æ‰¾åˆ°äº†çœŸæ­£çš„è¯´æ˜åŠä½œç”¨:</p>

<ul>
  <li>åœ¨ä½¿ç”¨ <code class="highlighter-rouge">kubeadm init</code> æ—¶åˆ›å»º <code class="highlighter-rouge">cluster-info</code> è¿™ä¸ª ConfigMapï¼ŒConfigMap ä¸­åŒ…å«äº†é›†ç¾¤åŸºæœ¬ä¿¡æ¯</li>
  <li>åœ¨ä½¿ç”¨ <code class="highlighter-rouge">kubeadm join</code> æ—¶ç›®æ ‡èŠ‚ç‚¹å¼ºè¡Œè¯»å– ConfigMap ä»¥å¾—çŸ¥é›†ç¾¤åŸºæœ¬ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œ <code class="highlighter-rouge">join</code></li>
</ul>

<p><strong>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ‰‹åŠ¨éƒ¨ç½²ä¸‹ï¼Œåœ¨ä»…ä»…ä½¿ç”¨ Bootstrap Token è¿›è¡Œ TLS Bootstrapping æ—¶ï¼Œ<code class="highlighter-rouge">bootstrapsigner</code> è¿™ä¸ª controller å’Œ <code class="highlighter-rouge">Bootstrap Token Secret</code> ä¸­çš„ <code class="highlighter-rouge">usage-bootstrap-signing</code> é€‰é¡¹æ˜¯æ²¡æœ‰å¿…è¦çš„ï¼Œå½“ç„¶æˆ‘è¿˜æ²¡æµ‹è¯•(èƒ¡å¹è°ä¸ä¼š)â€¦</strong></p>

<p>æœ€åé™„ä¸Š <code class="highlighter-rouge">kubeadm</code> çš„æ–‡æ¡£è¯´æ˜: <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/#create-the-public-cluster-info-configmap">Create the public cluster-info ConfigMap</a>ã€<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/#discovery-cluster-info">Discovery cluster-info</a></p>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>
:ET