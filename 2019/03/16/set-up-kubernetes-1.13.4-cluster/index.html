<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Kubernetes 1.13.4 搭建">
    <meta name="keywords"  content="kubernetes,docker,calico">
    <meta name="theme-color" content="#000000">
    
    <title>Kubernetes 1.13.4 搭建 - 漠然的博客 | mritd Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Rouge CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/mritd-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">漠然</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                        
                    </div>
                    <h1>Kubernetes 1.13.4 搭建</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by 漠然 on March 16, 2019</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

                <blockquote>
  <p>年后回来有点懒，也有点忙；1.13 出来好久了，周末还是决定折腾一下吧</p>
</blockquote>

<h2 id="一环境准备">一、环境准备</h2>

<p>老样子，安装环境为 5 台 Ubuntu 18.04.2 LTS 虚拟机，其他详细信息如下</p>

<table>
  <thead>
    <tr>
      <th>System OS</th>
      <th>IP Address</th>
      <th>Docker</th>
      <th>Kernel</th>
      <th>Application</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.51</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-master、etcd</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.52</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-master、etcd</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.53</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-master、etcd</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.54</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-node</td>
    </tr>
    <tr>
      <td>Ubuntu 18.04.2 LTS</td>
      <td>192.168.1.55</td>
      <td>18.09.2</td>
      <td>4.15.0-46-generic</td>
      <td>k8s-node</td>
    </tr>
  </tbody>
</table>

<p><strong>所有配置生成将在第一个节点上完成，第一个节点与其他节点 root 用户免密码登录，用于分发文件；为了方便搭建弄了一点小脚本，仓库地址 <a href="https://github.com/mritd/ktool">ktool</a>，本文后续所有脚本、配置都可以在此仓库找到；关于 <a href="https://github.com/cloudflare/cfssl">cfssl</a> 等基本工具使用，本文不再阐述</strong></p>

<h2 id="二安装-etcd">二、安装 Etcd</h2>

<h3 id="21生成证书">2.1、生成证书</h3>

<p>Etcd 仍然开启 TLS 认证，所以先使用 cfssl 生成相关证书</p>

<ul>
  <li>etcd-root-ca-csr.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd-root-ca"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd Security"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ca"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>etcd-gencert.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"client auth"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>etcd-csr.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd Security"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Beijing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"etcd"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.51"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.52"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"192.168.1.53"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>接下来执行生成即可；<strong>我建议在生产环境在证书内预留几个 IP，已防止意外故障迁移时还需要重新生成证书；证书默认期限为 10 年(包括 CA 证书)，有需要加强安全性的可以适当减小</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">--initca</span><span class="o">=</span><span class="nb">true </span>etcd-root-ca-csr.json | cfssljson <span class="nt">--bare</span> etcd-root-ca
cfssl gencert <span class="nt">--ca</span> etcd-root-ca.pem <span class="nt">--ca-key</span> etcd-root-ca-key.pem <span class="nt">--config</span> etcd-gencert.json etcd-csr.json | cfssljson <span class="nt">--bare</span> etcd
</code></pre></div></div>

<h3 id="22安装-etcd">2.2、安装 Etcd</h3>

<h4 id="221安装脚本">2.2.1、安装脚本</h4>

<p>安装 Etcd 只需要将二进制文件放在可执行目录下，然后修改配置增加 systemd service 配置文件即可；为了安全性起见最好使用单独的用户启动 Etcd</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nv">ETCD_DEFAULT_VERSION</span><span class="o">=</span><span class="s2">"3.3.12"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">ETCD_VERSION</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[33mWARNING: ETCD_VERSION is blank,use default version: </span><span class="k">${</span><span class="nv">ETCD_DEFAULT_VERSION</span><span class="k">}</span><span class="se">\0</span><span class="s2">33[0m"</span>
  <span class="nv">ETCD_VERSION</span><span class="o">=</span><span class="k">${</span><span class="nv">ETCD_DEFAULT_VERSION</span><span class="k">}</span>
<span class="k">fi</span>

<span class="c"># 下载 Etcd 二进制文件</span>
<span class="k">function </span>download<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"etcd-v</span><span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="s2">-linux-amd64.tar.gz"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>wget https://github.com/coreos/etcd/releases/download/v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span>/etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
        <span class="nb">tar</span> <span class="nt">-zxvf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 为 Etcd 创建单独的用户</span>
<span class="k">function </span>preinstall<span class="o">(){</span>
	getent group etcd <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="nt">-r</span> etcd
	getent passwd etcd <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> etcd <span class="nt">-d</span> /var/lib/etcd <span class="nt">-s</span> /sbin/nologin <span class="nt">-c</span> <span class="s2">"etcd user"</span> etcd
<span class="o">}</span>

<span class="c"># 安装(复制文件)</span>
<span class="k">function </span><span class="nb">install</span><span class="o">(){</span>

    <span class="c"># 释放 Etcd 二进制文件</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">tar</span> <span class="nt">-zxvf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>.tar.gz
    <span class="nb">cp </span>etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>/etcd<span class="k">*</span> /usr/local/bin
    <span class="nb">rm</span> <span class="nt">-rf</span> etcd-v<span class="k">${</span><span class="nv">ETCD_VERSION</span><span class="k">}</span><span class="nt">-linux-amd64</span>

    <span class="c"># 复制 配置文件 到 /etc/etcd(目录内文件结构在下面)</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp</span> <span class="nt">-r</span> conf /etc/etcd
    <span class="nb">chown</span> <span class="nt">-R</span> etcd:etcd /etc/etcd
    <span class="nb">chmod</span> <span class="nt">-R</span> 755 /etc/etcd/ssl

    <span class="c"># 复制 systemd service 配置</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy etcd systemd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>systemd/<span class="k">*</span>.service /lib/systemd/system
    systemctl daemon-reload
<span class="o">}</span>

<span class="c"># 创建 Etcd 存储目录(如需要更改，请求改 /etc/etcd/etcd.conf 配置文件)</span>
<span class="k">function </span>postinstall<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/lib/etcd"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/lib/etcd
        <span class="nb">chown</span> <span class="nt">-R</span> etcd:etcd /var/lib/etcd
    <span class="k">fi</span>

<span class="o">}</span>

<span class="c"># 依次执行</span>
download
preinstall
<span class="nb">install
</span>postinstall
</code></pre></div></div>

<h4 id="222配置文件">2.2.2、配置文件</h4>

<p><strong>关于配置文件目录结构如下(请自行复制证书)</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conf
├── etcd.conf
├── etcd.conf.cluster.example
├── etcd.conf.single.example
└── ssl
    ├── etcd-key.pem
    ├── etcd.pem
    ├── etcd-root-ca-key.pem
    └── etcd-root-ca.pem

1 directory, 7 files
</code></pre></div></div>

<ul>
  <li>etcd.conf</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># [member]</span>
<span class="nv">ETCD_NAME</span><span class="o">=</span>etcd1
<span class="nv">ETCD_DATA_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/data"</span>
<span class="nv">ETCD_WAL_DIR</span><span class="o">=</span><span class="s2">"/var/lib/etcd/wal"</span>
<span class="nv">ETCD_SNAPSHOT_COUNT</span><span class="o">=</span><span class="s2">"100"</span>
<span class="nv">ETCD_HEARTBEAT_INTERVAL</span><span class="o">=</span><span class="s2">"100"</span>
<span class="nv">ETCD_ELECTION_TIMEOUT</span><span class="o">=</span><span class="s2">"1000"</span>
<span class="nv">ETCD_LISTEN_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2380"</span>
<span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2379,http://127.0.0.1:2379"</span>
<span class="nv">ETCD_MAX_SNAPSHOTS</span><span class="o">=</span><span class="s2">"5"</span>
<span class="nv">ETCD_MAX_WALS</span><span class="o">=</span><span class="s2">"5"</span>
<span class="c">#ETCD_CORS=""</span>

<span class="c"># [cluster]</span>
<span class="nv">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2380"</span>
<span class="c"># if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. "test=http://..."</span>
<span class="nv">ETCD_INITIAL_CLUSTER</span><span class="o">=</span><span class="s2">"etcd1=https://192.168.1.51:2380,etcd2=https://192.168.1.52:2380,etcd3=https://192.168.1.53:2380"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_STATE</span><span class="o">=</span><span class="s2">"new"</span>
<span class="nv">ETCD_INITIAL_CLUSTER_TOKEN</span><span class="o">=</span><span class="s2">"etcd-cluster"</span>
<span class="nv">ETCD_ADVERTISE_CLIENT_URLS</span><span class="o">=</span><span class="s2">"https://192.168.1.51:2379"</span>
<span class="c">#ETCD_DISCOVERY=""</span>
<span class="c">#ETCD_DISCOVERY_SRV=""</span>
<span class="c">#ETCD_DISCOVERY_FALLBACK="proxy"</span>
<span class="c">#ETCD_DISCOVERY_PROXY=""</span>
<span class="c">#ETCD_STRICT_RECONFIG_CHECK="false"</span>
<span class="c">#ETCD_AUTO_COMPACTION_RETENTION="0"</span>

<span class="c"># [proxy]</span>
<span class="c">#ETCD_PROXY="off"</span>
<span class="c">#ETCD_PROXY_FAILURE_WAIT="5000"</span>
<span class="c">#ETCD_PROXY_REFRESH_INTERVAL="30000"</span>
<span class="c">#ETCD_PROXY_DIAL_TIMEOUT="1000"</span>
<span class="c">#ETCD_PROXY_WRITE_TIMEOUT="5000"</span>
<span class="c">#ETCD_PROXY_READ_TIMEOUT="0"</span>

<span class="c"># [security]</span>
<span class="nv">ETCD_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd.pem"</span>
<span class="nv">ETCD_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-key.pem"</span>
<span class="nv">ETCD_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-root-ca.pem"</span>
<span class="nv">ETCD_AUTO_TLS</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_CERT_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd.pem"</span>
<span class="nv">ETCD_PEER_KEY_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-key.pem"</span>
<span class="nv">ETCD_PEER_CLIENT_CERT_AUTH</span><span class="o">=</span><span class="s2">"true"</span>
<span class="nv">ETCD_PEER_TRUSTED_CA_FILE</span><span class="o">=</span><span class="s2">"/etc/etcd/ssl/etcd-root-ca.pem"</span>
<span class="nv">ETCD_PEER_AUTO_TLS</span><span class="o">=</span><span class="s2">"true"</span>

<span class="c"># [logging]</span>
<span class="c">#ETCD_DEBUG="false"</span>
<span class="c"># examples for -log-package-levels etcdserver=WARNING,security=DEBUG</span>
<span class="c">#ETCD_LOG_PACKAGE_LEVELS=""</span>
</code></pre></div></div>

<ul>
  <li>etcd.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Etcd Server
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/etcd/
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/etcd/etcd.conf
<span class="nv">User</span><span class="o">=</span>etcd
<span class="c"># set GOMAXPROCS to number of processors</span>
<span class="nv">ExecStart</span><span class="o">=</span>/bin/bash <span class="nt">-c</span> <span class="s2">"GOMAXPROCS=</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span><span class="s2"> /usr/local/bin/etcd --name=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_NAME</span><span class="k">}</span><span class="se">\"</span><span class="s2"> --data-dir=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_DATA_DIR</span><span class="k">}</span><span class="se">\"</span><span class="s2"> --listen-client-urls=</span><span class="se">\"</span><span class="k">${</span><span class="nv">ETCD_LISTEN_CLIENT_URLS</span><span class="k">}</span><span class="se">\"</span><span class="s2">"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>最后三台机器依次修改 <code class="highlighter-rouge">IP</code>、<code class="highlighter-rouge">ETCD_NAME</code> 然后启动即可，<strong>生产环境请不要忘记修改集群 Token 为真实随机字符串 (<code class="highlighter-rouge">ETCD_INITIAL_CLUSTER_TOKEN</code> 变量)</strong>启动后可以通过以下命令测试集群联通性</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node ➜  ~ <span class="nb">export </span><span class="nv">ETCDCTL_API</span><span class="o">=</span>3
docker1.node ➜  ~ etcdctl member list
238b72cdd26e304f, started, etcd2, https://192.168.1.52:2380, https://192.168.1.52:2379
8034142cf01c5d1c, started, etcd3, https://192.168.1.53:2380, https://192.168.1.53:2379
8da171dbef9ded69, started, etcd1, https://192.168.1.51:2380, https://192.168.1.51:2379
</code></pre></div></div>

<h2 id="三安装-kubernetes">三、安装 Kubernetes</h2>

<h3 id="31生成证书及配置">3.1、生成证书及配置</h3>

<h4 id="311生成证书">3.1.1、生成证书</h4>

<p>新版本已经越来越趋近全面 TLS + RBAC 配置，<strong>所以本次安装将会启动大部分 TLS + RBAC 配置，包括 <code class="highlighter-rouge">kube-controler-manager</code>、<code class="highlighter-rouge">kube-scheduler</code> 组件不再连接本地 <code class="highlighter-rouge">kube-apiserver</code> 的 8080 非认证端口，<code class="highlighter-rouge">kubelet</code> 等组件 API 端点关闭匿名访问，启动 RBAC 认证等</strong>；为了满足这些认证，需要签署以下证书</p>

<ul>
  <li>k8s-root-ca-csr.json 集群 CA 根证书</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ca"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>k8s-gencert.json 用于生成其他证书的标准配置</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"signing"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"default"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"profiles"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"kubernetes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"usages"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"signing"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"key encipherment"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"server auth"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"client auth"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"expiry"</span><span class="p">:</span><span class="w"> </span><span class="s2">"87600h"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-apiserver-csr.json apiserver TLS 认证端口需要的证书</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"10.254.0.1"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"*.master.kubernetes.node"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc.cluster"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"kubernetes.default.svc.cluster.local"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"kubernetes"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-controller-manager-csr.json controller manager 连接 apiserver 需要使用的证书，同时本身 <code class="highlighter-rouge">10257</code> 端口也会使用此证书</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-controller-manager"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"*.master.kubernetes.node"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-controller-manager"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-scheduler-csr.json scheduler 连接 apiserver 需要使用的证书，同时本身 <code class="highlighter-rouge">10259</code> 端口也会使用此证书</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-scheduler"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"*.master.kubernetes.node"</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-scheduler"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kube-proxy-csr.json proxy 组件连接 apiserver 需要使用的证书</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-proxy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kube-proxy"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>kubelet-api-admin-csr.json apiserver 反向连接 kubelet 组件 <code class="highlighter-rouge">10250</code> 端口需要使用的证书(例如执行 <code class="highlighter-rouge">kubectl logs</code>)</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kubelet-api-admin"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:kubelet-api-admin"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>admin-csr.json 集群管理员(kubectl)连接 apiserver 需要使用的证书</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"CN"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:masters"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hosts"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"algo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rsa"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"names"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CN"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"ST"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"L"</span><span class="p">:</span><span class="w"> </span><span class="s2">"BeiJing"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"O"</span><span class="p">:</span><span class="w"> </span><span class="s2">"system:masters"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"OU"</span><span class="p">:</span><span class="w"> </span><span class="s2">"System"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>注意: 请不要修改证书配置的 <code class="highlighter-rouge">CN</code>、<code class="highlighter-rouge">O</code> 字段，这两个字段名称比较特殊，大多数为 <code class="highlighter-rouge">system:</code> 开头，实际上是为了匹配 RBAC 规则，具体请参考 <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings">Default Roles and Role Bindings</a></strong></p>

<p>最后使用如下命令生成即可:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfssl gencert <span class="nt">--initca</span><span class="o">=</span><span class="nb">true </span>k8s-root-ca-csr.json | cfssljson <span class="nt">--bare</span> k8s-root-ca

<span class="k">for </span>targetName <span class="k">in </span>kube-apiserver kube-controller-manager kube-scheduler kube-proxy kubelet-api-admin admin<span class="p">;</span> <span class="k">do
    </span>cfssl gencert <span class="nt">--ca</span> k8s-root-ca.pem <span class="nt">--ca-key</span> k8s-root-ca-key.pem <span class="nt">--config</span> k8s-gencert.json <span class="nt">--profile</span> kubernetes <span class="nv">$targetName</span><span class="nt">-csr</span>.json | cfssljson <span class="nt">--</span>
bare <span class="nv">$targetName</span>
<span class="k">done</span>
</code></pre></div></div>

<h4 id="312生成配置文件">3.1.2、生成配置文件</h4>

<p>集群搭建需要预先生成一系列配置文件，生成配置需要预先安装 <code class="highlighter-rouge">kubectl</code> 命令，请自行根据文档安装 <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-binary-using-curl">Install kubectl binary using curl</a>；其中配置文件及其作用如下:</p>

<ul>
  <li><code class="highlighter-rouge">bootstrap.kubeconfig</code> kubelet TLS Bootstarp 引导阶段需要使用的配置文件</li>
  <li><code class="highlighter-rouge">kube-controller-manager.kubeconfig</code> controller manager 组件开启安全端口及 RBAC 认证所需配置</li>
  <li><code class="highlighter-rouge">kube-scheduler.kubeconfig</code> scheduler 组件开启安全端口及 RBAC 认证所需配置</li>
  <li><code class="highlighter-rouge">kube-proxy.kubeconfig</code> proxy 组件连接 apiserver 所需配置文件</li>
  <li><code class="highlighter-rouge">audit-policy.yaml</code> apiserver RBAC 审计日志配置文件</li>
  <li><code class="highlighter-rouge">bootstrap.secret.yaml</code> kubelet TLS Bootstarp 引导阶段使用 Bootstrap Token 方式引导，需要预先创建此 Token</li>
</ul>

<p>生成这些配置文件的脚本如下</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 指定 apiserver 地址</span>
<span class="nv">KUBE_APISERVER</span><span class="o">=</span><span class="s2">"https://127.0.0.1:6443"</span>

<span class="c"># 生成 Bootstrap Token</span>
<span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 6 /dev/urandom | <span class="nb">md5sum</span> | <span class="nb">head</span> <span class="nt">-c</span> 6<span class="si">)</span>
<span class="nv">BOOTSTRAP_TOKEN_SECRET</span><span class="o">=</span><span class="si">$(</span><span class="nb">head</span> <span class="nt">-c</span> 16 /dev/urandom | <span class="nb">md5sum</span> | <span class="nb">head</span> <span class="nt">-c</span> 16<span class="si">)</span>
<span class="nv">BOOTSTRAP_TOKEN</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="s2">.</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_SECRET</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Bootstrap Tokne: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span><span class="s2">"</span>

<span class="c"># 生成 kubelet tls bootstrap 配置</span>
<span class="nb">echo</span> <span class="s2">"Create kubelet bootstrapping kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
kubectl config set-credentials <span class="s2">"system:bootstrap:</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--token</span><span class="o">=</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span><span class="s2">"system:bootstrap:</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>bootstrap.kubeconfig

<span class="c"># 生成 kube-controller-manager 配置文件</span>
<span class="nb">echo</span> <span class="s2">"Create kube-controller-manager kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig
kubectl config set-credentials <span class="s2">"system:kube-controller-manager"</span> <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-controller-manager.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-controller-manager-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:kube-controller-manager <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-controller-manager.kubeconfig 

<span class="c"># 生成 kube-scheduler 配置文件</span>
<span class="nb">echo</span> <span class="s2">"Create kube-scheduler kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig
kubectl config set-credentials <span class="s2">"system:kube-scheduler"</span> <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-scheduler.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-scheduler-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:kube-scheduler <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-scheduler.kubeconfig 

<span class="c"># 生成 kube-proxy 配置文件</span>
<span class="nb">echo</span> <span class="s2">"Create kube-proxy kubeconfig..."</span>
kubectl config set-cluster kubernetes <span class="se">\</span>
  <span class="nt">--certificate-authority</span><span class="o">=</span>k8s-root-ca.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--server</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_APISERVER</span><span class="k">}</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
kubectl config set-credentials <span class="s2">"system:kube-proxy"</span> <span class="se">\</span>
  <span class="nt">--client-certificate</span><span class="o">=</span>kube-proxy.pem <span class="se">\</span>
  <span class="nt">--client-key</span><span class="o">=</span>kube-proxy-key.pem <span class="se">\</span>
  <span class="nt">--embed-certs</span><span class="o">=</span><span class="nb">true</span> <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
kubectl config set-context default <span class="se">\</span>
  <span class="nt">--cluster</span><span class="o">=</span>kubernetes <span class="se">\</span>
  <span class="nt">--user</span><span class="o">=</span>system:kube-proxy <span class="se">\</span>
  <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig
kubectl config use-context default <span class="nt">--kubeconfig</span><span class="o">=</span>kube-proxy.kubeconfig 

<span class="c"># 生成 apiserver RBAC 审计配置文件 </span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> audit-policy.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
# Log all requests at the Metadata level.
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
</span><span class="no">EOF

</span><span class="c"># 生成 tls bootstrap token secret 配置文件</span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> bootstrap.secret.yaml <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: Secret
metadata:
  # Name MUST be of form "bootstrap-token-&lt;token id&gt;"
  name: bootstrap-token-</span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="sh">
  namespace: kube-system
# Type MUST be 'bootstrap.kubernetes.io/token'
type: bootstrap.kubernetes.io/token
stringData:
  # Human readable description. Optional.
  description: "The default bootstrap token."
  # Token ID and secret. Required.
  token-id: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_ID</span><span class="k">}</span><span class="sh">
  token-secret: </span><span class="k">${</span><span class="nv">BOOTSTRAP_TOKEN_SECRET</span><span class="k">}</span><span class="sh">
  # Expiration. Optional.
  expiration: </span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-d</span><span class="s1">'+2 day'</span> <span class="nt">-u</span> +<span class="s2">"%Y-%m-%dT%H:%M:%SZ"</span><span class="si">)</span><span class="sh">
  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"
  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
#  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
</span><span class="no">EOF
</span></code></pre></div></div>

<h3 id="32处理-ipvs-及依赖">3.2、处理 ipvs 及依赖</h3>

<p>新版本目前 <code class="highlighter-rouge">kube-proxy</code> 组件全部采用 ipvs 方式负载，所以为了 <code class="highlighter-rouge">kube-proxy</code> 能正常工作需要预先处理一下 ipvs 配置以及相关依赖(每台 node 都要处理)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/sysctl.conf <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
</span><span class="no">EOF

</span>sysctl <span class="nt">-p</span>

<span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/modules <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
</span><span class="no">EOF

</span>apt <span class="nb">install</span> <span class="nt">-y</span> conntrack ipvsadm
</code></pre></div></div>

<h3 id="33部署-master">3.3、部署 Master</h3>

<h4 id="331安装脚本">3.3.1、安装脚本</h4>

<p>master 节点上需要三个组件: <code class="highlighter-rouge">kube-apiserver</code>、<code class="highlighter-rouge">kube-controller-manager</code>、<code class="highlighter-rouge">kube-scheduler</code></p>

<p><strong>安装流程整体为以下几步</strong></p>

<ul>
  <li><strong>创建单独的 <code class="highlighter-rouge">kube</code> 用户</strong></li>
  <li><strong>复制相关二进制文件到 <code class="highlighter-rouge">/usr/bin</code>，可以采用 <code class="highlighter-rouge">all in one</code> 的 <code class="highlighter-rouge">hyperkube</code></strong></li>
  <li><strong>复制配置文件到 <code class="highlighter-rouge">/etc/kubernetes</code></strong></li>
  <li><strong>复制证书文件到 <code class="highlighter-rouge">/etc/kubernetes/ssl</code></strong></li>
  <li><strong>修改配置并启动</strong></li>
</ul>

<p>安装脚本如下所示:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">KUBE_DEFAULT_VERSION</span><span class="o">=</span><span class="s2">"1.13.4"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nv">KUBE_VERSION</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[33mWARNING: KUBE_VERSION is blank,use default version: </span><span class="k">${</span><span class="nv">KUBE_DEFAULT_VERSION</span><span class="k">}</span><span class="se">\0</span><span class="s2">33[0m"</span>
  <span class="nv">KUBE_VERSION</span><span class="o">=</span><span class="k">${</span><span class="nv">KUBE_DEFAULT_VERSION</span><span class="k">}</span>
<span class="k">fi</span>

<span class="c"># 下载 hyperkube</span>
<span class="k">function </span>download_k8s<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"hyperkube_v</span><span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>wget https://storage.googleapis.com/kubernetes-release/release/v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>/bin/linux/amd64/hyperkube <span class="nt">-O</span> hyperkube_v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>
        <span class="nb">chmod</span> +x hyperkube_v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># 创建专用用户 kube</span>
<span class="k">function </span>preinstall<span class="o">(){</span>
    getent group kube <span class="o">&gt;</span>/dev/null <span class="o">||</span> groupadd <span class="nt">-r</span> kube
    getent passwd kube <span class="o">&gt;</span>/dev/null <span class="o">||</span> useradd <span class="nt">-r</span> <span class="nt">-g</span> kube <span class="nt">-d</span> / <span class="nt">-s</span> /sbin/nologin <span class="nt">-c</span> <span class="s2">"Kubernetes user"</span> kube
<span class="o">}</span>

<span class="c"># 复制可执行文件和配置以及证书</span>
<span class="k">function </span>install_k8s<span class="o">(){</span>
    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy hyperkube...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>hyperkube_v<span class="k">${</span><span class="nv">KUBE_VERSION</span><span class="k">}</span> /usr/bin/hyperkube

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Create symbolic link...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="o">(</span><span class="nb">cd</span> /usr/bin <span class="o">&amp;&amp;</span> hyperkube <span class="nt">--make-symlinks</span><span class="o">)</span>

    <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy kubernetes config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp</span> <span class="nt">-r</span> conf /etc/kubernetes
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"/etc/kubernetes/ssl"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">chown</span> <span class="nt">-R</span> kube:kube /etc/kubernetes/ssl
    <span class="k">fi

    </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\0</span><span class="s2">33[32mINFO: Copy kubernetes systemd config...</span><span class="se">\0</span><span class="s2">33[0m"</span>
    <span class="nb">cp </span>systemd/<span class="k">*</span>.service /lib/systemd/system
    systemctl daemon-reload
<span class="o">}</span>

<span class="c"># 创建必要的目录并修改权限</span>
<span class="k">function </span>postinstall<span class="o">(){</span>
    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/log/kube-audit"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/log/kube-audit
    <span class="k">fi
    
    if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/var/lib/kubelet"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /var/lib/kubelet
    <span class="k">fi
    if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-d</span> <span class="s2">"/usr/libexec"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">mkdir</span> /usr/libexec
    <span class="k">fi
    </span><span class="nb">chown</span> <span class="nt">-R</span> kube:kube /etc/kubernetes /var/log/kube-audit /var/lib/kubelet /usr/libexec
<span class="o">}</span>

<span class="c"># 执行</span>
download_k8s
preinstall
install_k8s
postinstall
</code></pre></div></div>

<p><strong>hyperkube 是一个多合一的可执行文件，通过 <code class="highlighter-rouge">--make-symlinks</code> 会在当前目录生成 kubernetes 各个组件的软连接</strong></p>

<p>被复制的 conf 目录结构如下(最终被复制到 <code class="highlighter-rouge">/etc/kubernetes</code>)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── apiserver
├── audit-policy.yaml
├── bootstrap.kubeconfig
├── bootstrap.secret.yaml
├── controller-manager
├── kube-controller-manager.kubeconfig
├── kubelet
├── kube-proxy.kubeconfig
├── kube-scheduler.kubeconfig
├── proxy
├── scheduler
└── ssl
    ├── admin-key.pem
    ├── admin.pem
    ├── k8s-root-ca-key.pem
    ├── k8s-root-ca.pem
    ├── kube-apiserver-key.pem
    ├── kube-apiserver.pem
    ├── kube-controller-manager-key.pem
    ├── kube-controller-manager.pem
    ├── kubelet-api-admin-key.pem
    ├── kubelet-api-admin.pem
    ├── kube-proxy-key.pem
    ├── kube-proxy.pem
    ├── kube-scheduler-key.pem
    └── kube-scheduler.pem

1 directory, 25 files
</code></pre></div></div>

<h4 id="332配置文件">3.3.2、配置文件</h4>

<p>以下为相关配置文件内容</p>

<p><strong>systemd 配置如下</strong></p>

<ul>
  <li>kube-apiserver.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes API Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>network.target
<span class="nv">After</span><span class="o">=</span>etcd.service

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/apiserver
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-apiserver <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ETCD_SERVERS</span> <span class="se">\</span>
	    <span class="nv">$KUBE_API_ADDRESS</span> <span class="se">\</span>
	    <span class="nv">$KUBE_API_PORT</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_PORT</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ALLOW_PRIV</span> <span class="se">\</span>
	    <span class="nv">$KUBE_SERVICE_ADDRESSES</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ADMISSION_CONTROL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_API_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>kube-controller-manager.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Controller Manager
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/controller-manager
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-controller-manager <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
	    <span class="nv">$KUBE_CONTROLLER_MANAGER_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>kube-scheduler.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Scheduler Plugin
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/scheduler
<span class="nv">User</span><span class="o">=</span>kube
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-scheduler <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
	    <span class="nv">$KUBE_SCHEDULER_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p><strong>核心配置文件</strong></p>

<ul>
  <li>apiserver</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes system config</span>
<span class="c">#</span>
<span class="c"># The following values are used to configure the kube-apiserver</span>
<span class="c">#</span>

<span class="c"># The address on the local server to listen to.</span>
<span class="nv">KUBE_API_ADDRESS</span><span class="o">=</span><span class="s2">"--advertise-address=192.168.1.51 --bind-address=0.0.0.0"</span>

<span class="c"># The port on the local server to listen on.</span>
<span class="nv">KUBE_API_PORT</span><span class="o">=</span><span class="s2">"--secure-port=6443"</span>

<span class="c"># Port minions listen on</span>
<span class="c"># KUBELET_PORT="--kubelet-port=10250"</span>

<span class="c"># Comma separated list of nodes in the etcd cluster</span>
<span class="nv">KUBE_ETCD_SERVERS</span><span class="o">=</span><span class="s2">"--etcd-servers=https://192.168.1.51:2379,https://192.168.1.52:2379,https://192.168.1.53:2379"</span>

<span class="c"># Address range to use for services</span>
<span class="nv">KUBE_SERVICE_ADDRESSES</span><span class="o">=</span><span class="s2">"--service-cluster-ip-range=10.254.0.0/16"</span>

<span class="c"># default admission control policies</span>
<span class="nv">KUBE_ADMISSION_CONTROL</span><span class="o">=</span><span class="s2">"--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota"</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_API_ARGS</span><span class="o">=</span><span class="s2">" --allow-privileged=true </span><span class="se">\</span><span class="s2">
                --anonymous-auth=false </span><span class="se">\</span><span class="s2">
                --alsologtostderr </span><span class="se">\</span><span class="s2">
                --apiserver-count=3 </span><span class="se">\</span><span class="s2">
                --audit-log-maxage=30 </span><span class="se">\</span><span class="s2">
                --audit-log-maxbackup=3 </span><span class="se">\</span><span class="s2">
                --audit-log-maxsize=100 </span><span class="se">\</span><span class="s2">
                --audit-log-path=/var/log/kube-audit/audit.log </span><span class="se">\</span><span class="s2">
                --audit-policy-file=/etc/kubernetes/audit-policy.yaml </span><span class="se">\</span><span class="s2">
                --authorization-mode=Node,RBAC </span><span class="se">\</span><span class="s2">
                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --enable-bootstrap-token-auth </span><span class="se">\</span><span class="s2">
                --enable-garbage-collector </span><span class="se">\</span><span class="s2">
                --enable-logs-handler </span><span class="se">\</span><span class="s2">
                --endpoint-reconciler-type=lease </span><span class="se">\</span><span class="s2">
                --etcd-cafile=/etc/etcd/ssl/etcd-root-ca.pem </span><span class="se">\</span><span class="s2">
                --etcd-certfile=/etc/etcd/ssl/etcd.pem </span><span class="se">\</span><span class="s2">
                --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem </span><span class="se">\</span><span class="s2">
                --etcd-compaction-interval=0s </span><span class="se">\</span><span class="s2">
                --event-ttl=168h0m0s </span><span class="se">\</span><span class="s2">
                --kubelet-https=true </span><span class="se">\</span><span class="s2">
                --kubelet-certificate-authority=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --kubelet-client-certificate=/etc/kubernetes/ssl/kubelet-api-admin.pem </span><span class="se">\</span><span class="s2">
                --kubelet-client-key=/etc/kubernetes/ssl/kubelet-api-admin-key.pem </span><span class="se">\</span><span class="s2">
                --kubelet-timeout=3s </span><span class="se">\</span><span class="s2">
                --runtime-config=api/all=true </span><span class="se">\</span><span class="s2">
                --service-node-port-range=30000-50000 </span><span class="se">\</span><span class="s2">
                --service-account-key-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem </span><span class="se">\</span><span class="s2">
                --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem </span><span class="se">\</span><span class="s2">
                --v=2"</span>
</code></pre></div></div>

<p>配置解释:</p>

<table>
  <thead>
    <tr>
      <th>选项</th>
      <th>作用</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">--client-ca-file</code></td>
      <td>定义客户端 CA</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--endpoint-reconciler-type</code></td>
      <td>master endpoint 策略</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--kubelet-client-certificate</code>、<code class="highlighter-rouge">--kubelet-client-key</code></td>
      <td>master 反向连接 kubelet 使用的证书</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--service-account-key-file</code></td>
      <td>service account 签名 key(用于有效性验证)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">--tls-cert-file</code>、<code class="highlighter-rouge">--tls-private-key-file</code></td>
      <td>master apiserver <code class="highlighter-rouge">6443</code> 端口证书</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>controller-manager</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># The following values are used to configure the kubernetes controller-manager</span>

<span class="c"># defaults from config and apiserver should be adequate</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_CONTROLLER_MANAGER_ARGS</span><span class="o">=</span><span class="s2">"  --address=127.0.0.1 </span><span class="se">\</span><span class="s2">
                                --authentication-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\</span><span class="s2">
                                --authorization-kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\</span><span class="s2">
                                --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                                --cluster-name=kubernetes </span><span class="se">\</span><span class="s2">
                                --cluster-signing-cert-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --cluster-signing-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --controllers=*,bootstrapsigner,tokencleaner </span><span class="se">\</span><span class="s2">
                                --deployment-controller-sync-period=10s </span><span class="se">\</span><span class="s2">
                                --experimental-cluster-signing-duration=87600h0m0s </span><span class="se">\</span><span class="s2">
                                --enable-garbage-collector=true </span><span class="se">\</span><span class="s2">
                                --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig </span><span class="se">\</span><span class="s2">
                                --leader-elect=true </span><span class="se">\</span><span class="s2">
                                --node-monitor-grace-period=20s </span><span class="se">\</span><span class="s2">
                                --node-monitor-period=5s </span><span class="se">\</span><span class="s2">
                                --port=10252 </span><span class="se">\</span><span class="s2">
                                --pod-eviction-timeout=2m0s </span><span class="se">\</span><span class="s2">
                                --requestheader-client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --terminated-pod-gc-threshold=50 </span><span class="se">\</span><span class="s2">
                                --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem </span><span class="se">\</span><span class="s2">
                                --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem </span><span class="se">\</span><span class="s2">
                                --root-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                                --secure-port=10257 </span><span class="se">\</span><span class="s2">
                                --service-cluster-ip-range=10.254.0.0/16 </span><span class="se">\</span><span class="s2">
                                --service-account-private-key-file=/etc/kubernetes/ssl/k8s-root-ca-key.pem </span><span class="se">\</span><span class="s2">
                                --use-service-account-credentials=true </span><span class="se">\</span><span class="s2">
                                --v=2"</span>
</code></pre></div></div>

<p>controller manager 将不安全端口 <code class="highlighter-rouge">10252</code> 绑定到 127.0.0.1 确保 <code class="highlighter-rouge">kuebctl get cs</code> 有正确返回；将安全端口 <code class="highlighter-rouge">10257</code> 绑定到 0.0.0.0 公开，提供服务调用；<strong>由于 controller manager 开始连接 apiserver 的 <code class="highlighter-rouge">6443</code> 认证端口，所以需要 <code class="highlighter-rouge">--use-service-account-credentials</code> 选项来让 controller manager 创建单独的 service account(默认 <code class="highlighter-rouge">system:kube-controller-manager</code> 用户没有那么高权限)</strong></p>

<ul>
  <li>scheduler</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes scheduler config</span>

<span class="c"># default config should be adequate</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBE_SCHEDULER_ARGS</span><span class="o">=</span><span class="s2">"   --address=127.0.0.1 </span><span class="se">\</span><span class="s2">
                        --authentication-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig </span><span class="se">\</span><span class="s2">
                        --authorization-kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig </span><span class="se">\</span><span class="s2">
                        --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                        --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                        --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig </span><span class="se">\</span><span class="s2">
                        --requestheader-client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                        --secure-port=10259 </span><span class="se">\</span><span class="s2">
                        --leader-elect=true </span><span class="se">\</span><span class="s2">
                        --port=10251 </span><span class="se">\</span><span class="s2">
                        --tls-cert-file=/etc/kubernetes/ssl/kube-scheduler.pem </span><span class="se">\</span><span class="s2">
                        --tls-private-key-file=/etc/kubernetes/ssl/kube-scheduler-key.pem </span><span class="se">\</span><span class="s2">
                        --v=2"</span>
</code></pre></div></div>

<p>shceduler 同  controller manager 一样将不安全端口绑定在本地，安全端口对外公开</p>

<p><strong>最后在三台节点上调整一下 IP 配置，启动即可</strong></p>

<h3 id="34部署-node">3.4、部署 Node</h3>

<h4 id="341安装脚本">3.4.1、安装脚本</h4>

<p>node 安装与 master 安装过程一致，这里不再阐述</p>

<h4 id="342配置文件">3.4.2、配置文件</h4>

<p><strong>systemd 配置文件</strong></p>

<ul>
  <li>kubelet.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kubelet Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>docker.service
<span class="nv">Requires</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">WorkingDirectory</span><span class="o">=</span>/var/lib/kubelet
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/kubelet
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kubelet <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_API_SERVER</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_ADDRESS</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_PORT</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_HOSTNAME</span> <span class="se">\</span>
	    <span class="nv">$KUBE_ALLOW_PRIV</span> <span class="se">\</span>
	    <span class="nv">$KUBELET_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">KillMode</span><span class="o">=</span>process

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<ul>
  <li>kube-proxy.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Kubernetes Kube-Proxy Server
<span class="nv">Documentation</span><span class="o">=</span>https://github.com/GoogleCloudPlatform/kubernetes
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/kubernetes/proxy
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kube-proxy <span class="se">\</span>
	    <span class="nv">$KUBE_LOGTOSTDERR</span> <span class="se">\</span>
	    <span class="nv">$KUBE_LOG_LEVEL</span> <span class="se">\</span>
	    <span class="nv">$KUBE_MASTER</span> <span class="se">\</span>
	    <span class="nv">$KUBE_PROXY_ARGS</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p><strong>核心配置文件</strong></p>

<ul>
  <li>kubelet</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes kubelet (minion) config</span>

<span class="c"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span>
<span class="nv">KUBELET_ADDRESS</span><span class="o">=</span><span class="s2">"--node-ip=192.168.1.54"</span>

<span class="c"># The port for the info server to serve on</span>
<span class="c"># KUBELET_PORT="--port=10250"</span>

<span class="c"># You may leave this blank to use the actual hostname</span>
<span class="nv">KUBELET_HOSTNAME</span><span class="o">=</span><span class="s2">"--hostname-override=docker4.node"</span>

<span class="c"># location of the api-server</span>
<span class="c"># KUBELET_API_SERVER=""</span>

<span class="c"># Add your own!</span>
<span class="nv">KUBELET_ARGS</span><span class="o">=</span><span class="s2">"  --address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                --allow-privileged </span><span class="se">\</span><span class="s2">
                --anonymous-auth=false </span><span class="se">\</span><span class="s2">
                --authorization-mode=Webhook </span><span class="se">\</span><span class="s2">
                --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig </span><span class="se">\</span><span class="s2">
                --client-ca-file=/etc/kubernetes/ssl/k8s-root-ca.pem </span><span class="se">\</span><span class="s2">
                --network-plugin=cni </span><span class="se">\</span><span class="s2">
                --cgroup-driver=cgroupfs </span><span class="se">\</span><span class="s2">
                --cert-dir=/etc/kubernetes/ssl </span><span class="se">\</span><span class="s2">
                --cluster-dns=10.254.0.2 </span><span class="se">\</span><span class="s2">
                --cluster-domain=cluster.local </span><span class="se">\</span><span class="s2">
                --cni-conf-dir=/etc/cni/net.d </span><span class="se">\</span><span class="s2">
                --eviction-soft=imagefs.available&lt;15%,memory.available&lt;512Mi,nodefs.available&lt;15%,nodefs.inodesFree&lt;10% </span><span class="se">\</span><span class="s2">
                --eviction-soft-grace-period=imagefs.available=3m,memory.available=1m,nodefs.available=3m,nodefs.inodesFree=1m </span><span class="se">\</span><span class="s2">
                --eviction-hard=imagefs.available&lt;10%,memory.available&lt;256Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% </span><span class="se">\</span><span class="s2">
                --eviction-max-pod-grace-period=30 </span><span class="se">\</span><span class="s2">
                --image-gc-high-threshold=80 </span><span class="se">\</span><span class="s2">
                --image-gc-low-threshold=70 </span><span class="se">\</span><span class="s2">
                --image-pull-progress-deadline=30s </span><span class="se">\</span><span class="s2">
                --kube-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --kubeconfig=/etc/kubernetes/kubelet.kubeconfig </span><span class="se">\</span><span class="s2">
                --max-pods=100 </span><span class="se">\</span><span class="s2">
                --minimum-image-ttl-duration=720h0m0s </span><span class="se">\</span><span class="s2">
                --node-labels=node.kubernetes.io/k8s-node=true </span><span class="se">\</span><span class="s2">
                --pod-infra-container-image=gcr.azk8s.cn/google_containers/pause-amd64:3.1 </span><span class="se">\</span><span class="s2">
                --port=10250 </span><span class="se">\</span><span class="s2">
                --read-only-port=0 </span><span class="se">\</span><span class="s2">
                --rotate-certificates </span><span class="se">\</span><span class="s2">
                --rotate-server-certificates </span><span class="se">\</span><span class="s2">
                --resolv-conf=/run/systemd/resolve/resolv.conf </span><span class="se">\</span><span class="s2">
                --system-reserved=cpu=500m,memory=512Mi,ephemeral-storage=1Gi </span><span class="se">\</span><span class="s2">
                --fail-swap-on=false </span><span class="se">\</span><span class="s2">
                --v=2"</span>
</code></pre></div></div>

<p><strong>当 kubelet 组件设置了 <code class="highlighter-rouge">--rotate-certificates</code>，<code class="highlighter-rouge">--rotate-server-certificates</code> 后会自动更新其使用的相关证书，同时指定 <code class="highlighter-rouge">--authorization-mode=Webhook</code> 后 <code class="highlighter-rouge">10250</code> 端口 RBAC 授权将会委托给 apiserver</strong></p>

<ul>
  <li>proxy</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">###</span>
<span class="c"># kubernetes proxy config</span>
<span class="c"># default config should be adequate</span>
<span class="c"># Add your own!</span>
<span class="nv">KUBE_PROXY_ARGS</span><span class="o">=</span><span class="s2">"   --bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                    --cleanup-ipvs=true </span><span class="se">\</span><span class="s2">
                    --cluster-cidr=10.254.0.0/16 </span><span class="se">\</span><span class="s2">
                    --hostname-override=docker4.node </span><span class="se">\</span><span class="s2">
                    --healthz-bind-address=0.0.0.0 </span><span class="se">\</span><span class="s2">
                    --healthz-port=10256 </span><span class="se">\</span><span class="s2">
                    --masquerade-all=true </span><span class="se">\</span><span class="s2">
                    --proxy-mode=ipvs </span><span class="se">\</span><span class="s2">
                    --ipvs-min-sync-period=5s </span><span class="se">\</span><span class="s2">
                    --ipvs-sync-period=5s </span><span class="se">\</span><span class="s2">
                    --ipvs-scheduler=wrr </span><span class="se">\</span><span class="s2">
                    --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig </span><span class="se">\</span><span class="s2">
                    --logtostderr=true </span><span class="se">\</span><span class="s2">
                    --v=2"</span>
</code></pre></div></div>

<p>由于 <code class="highlighter-rouge">kubelet</code> 组件是采用 TLS Bootstrap 启动，所以需要预先创建相关配置</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 创建用于 tls bootstrap 的 token secret</span>
kubectl create <span class="nt">-f</span> bootstrap.secret.yaml

<span class="c"># 为了能让 kubelet 实现自动更新证书，需要配置相关 clusterrolebinding</span>

<span class="c"># 允许 kubelet tls bootstrap 创建 csr 请求</span>
kubectl create clusterrolebinding create-csrs-for-bootstrapping <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:node-bootstrapper <span class="se">\</span>
    <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># 自动批准 system:bootstrappers 组用户 TLS bootstrapping 首次申请证书的 CSR 请求</span>
kubectl create clusterrolebinding auto-approve-csrs-for-group <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient <span class="se">\</span>
    <span class="nt">--group</span><span class="o">=</span>system:bootstrappers

<span class="c"># 自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</span>
kubectl create clusterrolebinding auto-approve-renewals-for-nodes <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span class="se">\</span>
    <span class="nt">--group</span><span class="o">=</span>system:nodes

<span class="c"># 在 kubelet server 开启 api 认证的情况下，apiserver 反向访问 kubelet 10250 需要此授权(eg: kubectl logs)</span>
kubectl create clusterrolebinding system:kubelet-api-admin <span class="se">\</span>
    <span class="nt">--clusterrole</span><span class="o">=</span>system:kubelet-api-admin <span class="se">\</span>
    <span class="nt">--user</span><span class="o">=</span>system:kubelet-api-admin
</code></pre></div></div>

<h4 id="343nginx-代理">3.4.3、Nginx 代理</h4>

<p>为了保证 apiserver 的 HA，需要在每个 node 上部署 nginx 来反向代理(tcp)所有 apiserver；然后 kubelet、kube-proxy 组件连接本地 <code class="highlighter-rouge">127.0.0.1:6443</code> 访问 apiserver，以确保任何 master 挂掉以后 node 都不会受到影响</p>

<ul>
  <li>nginx.conf</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>error_log stderr notice<span class="p">;</span>

worker_processes auto<span class="p">;</span>
events <span class="o">{</span>
  	multi_accept on<span class="p">;</span>
  	use epoll<span class="p">;</span>
  	worker_connections 1024<span class="p">;</span>
<span class="o">}</span>

stream <span class="o">{</span>
    upstream kube_apiserver <span class="o">{</span>
        least_conn<span class="p">;</span>
        server 192.168.1.51:6443<span class="p">;</span>
        server 192.168.1.52:6443<span class="p">;</span>
        server 192.168.1.53:6443<span class="p">;</span>
    <span class="o">}</span>

    server <span class="o">{</span>
        listen        0.0.0.0:6443<span class="p">;</span>
        proxy_pass    kube_apiserver<span class="p">;</span>
        proxy_timeout 10m<span class="p">;</span>
        proxy_connect_timeout 1s<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>nginx-proxy.service</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>kubernetes apiserver docker wrapper
<span class="nv">Wants</span><span class="o">=</span>docker.socket
<span class="nv">After</span><span class="o">=</span>docker.service

<span class="o">[</span>Service]
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">PermissionsStartOnly</span><span class="o">=</span><span class="nb">true
</span><span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker run <span class="nt">-p</span> 127.0.0.1:6443:6443 <span class="se">\</span>
                              <span class="nt">-v</span> /etc/nginx:/etc/nginx <span class="se">\</span>
                              <span class="nt">--name</span> nginx-proxy <span class="se">\</span>
                              <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
                              <span class="nt">--restart</span><span class="o">=</span>on-failure:5 <span class="se">\</span>
                              <span class="nt">--memory</span><span class="o">=</span>512M <span class="se">\</span>
                              nginx:1.14.2-alpine
<span class="nv">ExecStartPre</span><span class="o">=</span>-/usr/bin/docker <span class="nb">rm</span> <span class="nt">-f</span> nginx-proxy
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop nginx-proxy
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">RestartSec</span><span class="o">=</span>15s
<span class="nv">TimeoutStartSec</span><span class="o">=</span>30s

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</code></pre></div></div>

<p>然后在每个 node 上先启动 nginx-proxy，接着启动 kubelet 与 kube-proxy 即可(master 上的 kubelet、kube-proxy 只需要修改 ip 和 node name)</p>

<h4 id="344kubelet-server-证书">3.4.4、kubelet server 证书</h4>

<p><strong>注意: 新版本 kubelet server 的证书自动签发已经被关闭(看 issue 好像是由于安全原因)，所以对于 kubelet server 的证书仍需要手动签署</strong></p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node ➜  ~ kubectl get csr
NAME                                                   AGE   REQUESTOR                  CONDITION
csr-99l77                                              10s   system:node:docker4.node   Pending
node-csr-aGwaNKorMc0MZBYOuJsJGCB8Bg8ds97rmE3oKBTV-_E   11s   system:bootstrap:5d820b    Approved,Issued
docker1.node ➜  ~ kubectl certificate approve csr-99l77
certificatesigningrequest.certificates.k8s.io/csr-99l77 approved
</code></pre></div></div>

<h3 id="35部署-calico">3.5、部署 Calico</h3>

<p>当 node 全部启动后，由于网络组件(CNI)未安装会显示为 NotReady 状态；下面将部署 Calico 作为网络组件，完成跨节点网络通讯；具体安装文档可以参考 <a href="https://docs.projectcalico.org/v3.6/getting-started/kubernetes/installation/calico#installing-with-the-etcd-datastore">Installing with the etcd datastore</a></p>

<p>以下为 calico 的配置文件</p>

<ul>
  <li>calico.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-etcd-secrets.yaml</span>
<span class="c1"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span>
<span class="c1"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-etcd-secrets</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="c1"># Populate the following with etcd TLS configuration if desired, but leave blank if</span>
  <span class="c1"># not using TLS for etcd.</span>
  <span class="c1"># The keys below should be uncommented and the values populated with the base64</span>
  <span class="c1"># encoded contents of each file that would be associated with the TLS data.</span>
  <span class="c1"># Example command for encoding a file contents: cat &lt;file&gt; | base64 -w 0</span>
  <span class="na">etcd-key</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdGtOVlV5QWtOOWxDKy9EbzlCRkt0em5IZlFJKzJMK2crclkwLzNoOExJTEFoWUtXCm1XdVNNQUFjbyt4clVtaTFlUGIzcmRKR0p1NEhmRXFmalYvakhvN0haOGxteXd0S29Ed254aU9jZDRlRXltcXEKTEFVYzZ5RWU4dXFGZ2pLVHE4SjV2Z1F1cGp0ZlZnZXRPdVVsWWtWbUNKMWtpUW0yVk5WRnRWZ0Fqck1xSy9POApJTXN6RWRYU3BDc1Zwb0kzaUpoVHJSRng4ZzRXc2hwNG1XMzhMWDVJYVVoMWZaSGVMWm1sRURpclBWMGRTNmFWCmJscUk2aUFwanVBc3hYWjFlVTdmOVZWK01PVmNVc3A4cDAxNmJzS3R6VTJGSnB6ZlM3c1BlbGpKZGgzZmVOdk8KRVl1aDlsU0c1VGNKUHBuTTZ0R0ppaHpEWCt4dnNGa3d5MVJSVlFJREFRQUJBb0lCQUYwRXVqd2xVRGFzakJJVwpubDFKb2U4bTd0ZXUyTEk0QW9sUmluVERZZVE1aXRYWWt0R1Q0OVRaaWNSak9WYWlsOU0zZjZwWGdYUUcwUTB1CjdJVHpaZTlIZ1I5SDIwMU80dlFxSDBaeEVENjBqQ0hlRkNGSkxyd1ZlRDBUVWJYajZCZWx0Z296Q2pmT1gxYUIKcm5nN1VEdjZIUnZTYitlOGJEQ1pjKzBjRDVURG4vUWV0R1dtUmpJZ1FhMmlUT2MzSzFiaHo2RTl5Nk9qWkFTMQpiai9NL1dOd20yNHRxQTJEeWdjcGVmUGFnTWtFNm9uYXBFVHhZdi83QmNqcUhtdVd6WE1wMzd6VGpPckwxVDdmClhrbHdFMUYrMDRhRDR6dDZycEdmN0lqSUdvRkEvT2ZrRGZiYkRjN2NsaDJ1SkNMTVE5MGpuSkxMTGRSV3dQRW4KMkkyY3IvVUNnWUVBN3BjT29VV3RwdDJjWGIzSnl3Tkh4aXl1bEc4V1JENjBlQ1MrUXFnQUZndU5JWFJlMEREUwovSWY0M1BhaVB3TjhBS216ZTRKbGsxM3Rnd29qdi9RWVFVblJzZi9PbnpUUlFoWVJXT2lxSE5lSmFvOUxFU0VDClcxNXNmUjhnYzd0dFdPZ0loZkhudmdCR0QvYmUzS1NWVjdUY0lndVVjV3RzeHhLdjZ4LzJNdHNDZ1lFQXc1QVIKWk9HNUp4UGVNV3FVRUR3QjJuQmt6WEtGblpNSEJXV2FOeHpEaTI0NmZEVWM2T1hSTTJJanh2cmVkc3JKQjBXMwovelNDeFdUbkRmL3RJY1lKMjRuTmNsMUNDS2hTNVE5bVZxanZ3dE1SaEF1Uk5VSFJSVjZLNS91V1hHQzAzekR3CkEvMUFSd3lZSHNHTlJVOFRNNnpNRFcxL0x5djZNZ2pnOFBIamk0OENnWUVBa3JwelZOcjFJRm5KZ0J6bnJPSW4Ka2NpSTFPQThZVnZ1d0xSWURjWWp4MnJ6TUUvUXYxaEhhT1oyTmUyM2VlazZxVzJ6NDVFZHhyTk5EZmwrWXQ1Swp6RndKaWQ0M3c5RkhuOHpTZmtzWDB3VDZqWDN5UEdhQWZKQmxSODJNdDUvY2I0RERQUnkzMkRGeTVQNTlzRlBIClJGa0Z5Q28yOEVtUWJCMGg4d2VFOFdFQ2dZQm1IeUptS3RWVUNiVDYyeXZzZWxtQlp6WE1ieVJGRDlVWHhXSE4KcTlDVlMvOXdndy9Rc3NvVzZnWEN6NWhDTWt6ZDVsTmFDbUxMajVCMHFCTjlrbnZ0VDcyZ0hnRHdvbTEvUGhaego1STRuajY3UzVITjBleVU3ODAzWUxISHRWWGErSWtFRDVFaWZrWDBTZW9JNkVqdjF2U05sVTZ1WngzNUVpSXhtClpmb3NFd0tCZ0dQMmpsK0lPcFV5Y2NEL25EbUJWa05CWHoydWhncU8yYjE4d0hSOGdiSXoyVTRBZnpreXVkWUcKZzQvRjJZZVdCSEdNeTc5N0I2c0hjQTdQUWNNdUFuRk11MG9UNkMvanpDSHpoK2VaaS8wdHJRTHJGeWFFaGVuWgpnazduUTdHNHhROWZLZmVTeFcyUlNNUUR0MTZULzNOTitTOEZCTjJmZEliY3V4QWs0WjVHCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span>
  <span class="na">etcd-cert</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZFekNDQXZ1Z0F3SUJBZ0lVRGJqcTdVc2ViY2toZXRZb1RPNnRsc1N1c1k0d0RRWUpLb1pJaHZjTkFRRU4KQlFBd2J6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeERUQUxCZ05WQkFvVEJHVjBZMlF4RmpBVUJnTlZCQXNURFdWMFkyUWdVMlZqZFhKcGRIa3hGVEFUCkJnTlZCQU1UREdWMFkyUXRjbTl2ZEMxallUQWVGdzB4T1RBek1UWXdNelV4TURCYUZ3MHlPVEF6TVRNd016VXgKTURCYU1HY3hDekFKQmdOVkJBWVRBa05PTVJBd0RnWURWUVFJRXdkQ1pXbHFhVzVuTVJBd0RnWURWUVFIRXdkQwpaV2xxYVc1bk1RMHdDd1lEVlFRS0V3UmxkR05rTVJZd0ZBWURWUVFMRXcxbGRHTmtJRk5sWTNWeWFYUjVNUTB3CkN3WURWUVFERXdSbGRHTmtNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXRrTlYKVXlBa045bEMrL0RvOUJGS3R6bkhmUUkrMkwrZytyWTAvM2g4TElMQWhZS1dtV3VTTUFBY28reHJVbWkxZVBiMwpyZEpHSnU0SGZFcWZqVi9qSG83SFo4bG15d3RLb0R3bnhpT2NkNGVFeW1xcUxBVWM2eUVlOHVxRmdqS1RxOEo1CnZnUXVwanRmVmdldE91VWxZa1ZtQ0oxa2lRbTJWTlZGdFZnQWpyTXFLL084SU1zekVkWFNwQ3NWcG9JM2lKaFQKclJGeDhnNFdzaHA0bVczOExYNUlhVWgxZlpIZUxabWxFRGlyUFYwZFM2YVZibHFJNmlBcGp1QXN4WFoxZVU3Zgo5VlYrTU9WY1VzcDhwMDE2YnNLdHpVMkZKcHpmUzdzUGVsakpkaDNmZU52T0VZdWg5bFNHNVRjSlBwbk02dEdKCmloekRYK3h2c0Zrd3kxUlJWUUlEQVFBQm80R3VNSUdyTUE0R0ExVWREd0VCL3dRRUF3SUZvREFkQmdOVkhTVUUKRmpBVUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SXdEQVlEVlIwVEFRSC9CQUl3QURBZEJnTlZIUTRFRmdRVQpFKzVsWWN1LzhieHJ2WjNvUnRSMmEvOVBJRkF3SHdZRFZSMGpCQmd3Rm9BVTJaVWM3R2hGaG1PQXhzRlZ3VEEyCm5lZFJIdmN3TEFZRFZSMFJCQ1V3STRJSmJHOWpZV3hvYjNOMGh3Ui9BQUFCaHdUQXFBRXpod1RBcUFFMGh3VEEKcUFFMU1BMEdDU3FHU0liM0RRRUJEUVVBQTRJQ0FRQUx3Vkc2QW93cklwZzQvYlRwWndWL0pBUWNLSnJGdm52VApabDVDdzIzNDI4UzJLLzIwaXphaStEWUR1SXIwQ0ZCa2xGOXVsK05ROXZMZ1lqcE0rOTNOY3I0dXhUTVZsRUdZCjloc3NyT1FZZVBGUHhBS1k3RGd0K2RWUGwrWlg4MXNWRzJkU3ZBbm9Kd3dEVWt5U0VUY0g5NkszSlNKS2dXZGsKaTYxN21GYnMrTlcxdngrL0JNN2pVU3ZRUzhRb3JGQVE3SlcwYzZ3R2V4RFEzZExvTXJuR3Vocjd0V0E0WjhwawpPaE12cWdhWUZYSThNUm4yemlLV0R6QXNsa0hGd1RZdWhCNURMSEt0RUVwcWhxbGh1RThwTkZMaVVSV2xQWWhlCmpDNnVKZ0hBZDltcSswd2pyTmxqKzlWaDJoZUJWNldXZEROVTZaR2tpR003RW9YbDM1OWdUTzJPUkNLUk5vZ0YKRVplR25HcjJQNDhKbnZjTnFmZzNPdUtYd24wRDVYYllSWjFuYnR5WG9mMFByUUhEU21wUFVPMWNiZUJjSWVtcQpEVWozK0MrRzBRS1FLQlZDTXJzNXJIVlVWVkJZZzk5ZW1sRE1zUE5TZm9JWDQwTVFCeTdKMnpxRVV5M0sxcGlaCkhwT0lZT1RrWDRhczhqcGYxMnkxSXoxRVZydE1xek83d294VmMwdHRZYWN5NzUrVzZuS1hlWjBaand5aTVYSzUKZGduSVhmZW51RUNlWFNDdWZCSmUxVklzaXVWZ3cyRjlUNk5zRDhnQ3A5SlhTamJ1SXpiM3ArNU9uZzM2ZnBRdQpXZVBCY0dQVXE5cGEwZUtOUGJXNjlDUHdtUTQ2cjg0T3hTTURHWC9CMElqNUtNUnZUMmhPUXBqTVpSblc5OUxFCjRMbUJuUTg1Wmc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span>
  <span class="na">etcd-ca</span><span class="pi">:</span> <span class="s">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZyakNDQTVhZ0F3SUJBZ0lVWXVIKzIxYlNaU2hncVYxWkx3a2o4RmpZbUl3d0RRWUpLb1pJaHZjTkFRRU4KQlFBd2J6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeERUQUxCZ05WQkFvVEJHVjBZMlF4RmpBVUJnTlZCQXNURFdWMFkyUWdVMlZqZFhKcGRIa3hGVEFUCkJnTlZCQU1UREdWMFkyUXRjbTl2ZEMxallUQWVGdzB4T1RBek1UWXdNelV4TURCYUZ3MHlPVEF6TVRNd016VXgKTURCYU1HOHhDekFKQmdOVkJBWVRBa05PTVJBd0RnWURWUVFJRXdkQ1pXbHFhVzVuTVJBd0RnWURWUVFIRXdkQwpaV2xxYVc1bk1RMHdDd1lEVlFRS0V3UmxkR05rTVJZd0ZBWURWUVFMRXcxbGRHTmtJRk5sWTNWeWFYUjVNUlV3CkV3WURWUVFERXd4bGRHTmtMWEp2YjNRdFkyRXdnZ0lpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElDRHdBd2dnSUsKQW9JQ0FRRGFLK0s4WStqZkdOY2pOeUloeUhXSE5adWxVZzVKZFpOVU9GOHFXbXJMa0NuY2ZWdVF3dmI4cDFwLwpSSjBFOWo0OFBhZ1RJT3U2TU81R24zejFrZGpHRk9jOVZwMlZjYWJEQzJLWWJvRzdVQ0RmTWkzR1MzUnhUejVkCnh0MG1Ya2liVkMvc01NU2RrRm1mU2FCSXBoKzAyTnMwZURyMzNtUWxTdURlTWozNHJaTkVwMzRnUUk0eElTejAKbXhXR0dWNzcwUE9ScVgrZUthTEpiclp3anFFcnpHMEtEVUlBM0ZuTFdRMnp4b0VwN3JZby9LaGRiOHdETE1kbQp6VXNOZHI0T1F4MFBVRXA4akRUU2lFODkydDQ4KytsOHJ0MW4vTHFRc1FhVncrQlQrMTRvRHdIVkFaRXZ2ZnMwCmZkZ0QvU2RINGJRdHNhT21BdFByQldseU5aMUxIZkR2djMraXFzNk83UXpWUTFCK1c5cFRxdUZ2YUxWN3R1S3UKSXNlUFlseFdjV2E2M0hGbFkxVVJ6M0owaGtrZEZ1dkhUc0dhZDVpaWVrb0dUcFdTN2dVdCtTeWVJT2FhMldHLwp4Y1NiUWE0Y2xiZThuUHV2c1ZFVDhqZ0d0NGVLT25yRVJId0hMb2VleEpsSjdUdnhHNHpOTHZsc2FOL29iRzFDClUzMXczZ2d1SXpzRk5yallsUFdSZ0hSdXdPTlE5anlkM2dqVmNYUFdHTFJISUdYbjNhUDluT3A0OE9WWDhzbXoKOGIwS0V4UVpEQWUyS0tjWEg5a1ZiUFJQSWlLeGpXelV5aDMzQlRNejlPczZHcWM0Zk05c1hxbGRhVzBGd3g4MQpJaklScWx5a3VOSXNDWGhMUzhlNmVtdUNYMTVDZGNKb0ZmdXRuTENvV1B4Umg5OEF4UUlEQVFBQm8wSXdRREFPCkJnTlZIUThCQWY4RUJBTUNBUVl3RHdZRFZSMFRBUUgvQkFVd0F3RUIvekFkQmdOVkhRNEVGZ1FVMlpVYzdHaEYKaG1PQXhzRlZ3VEEybmVkUkh2Y3dEUVlKS29aSWh2Y05BUUVOQlFBRGdnSUJBSjh3bVNJMVBsQm8zcE1RWC9DOQpRS1RrR0xvVUhGdWprdFoxM1FYeXQ1LzFSeVB2WG1lLy90N3FHR2I5RmJZSm9BYTRTd3JSZkYzZmh3UDZaS0FnCnNYSEliR2gwc014UTdqVmQwMUNMWkoxQmZFNGZtTVlaQUlEWGpTcTNqbHJXZWcxL2hWTFN2dXRuUEFWSXc1SWwKZUdXRTMyOVJ2b2d2dXV6dUsxY2xwZFpIL2p3UlZjUUFUK0xvT2xFZ3Rkd293c0xpaWx3WE95eEZLZDd1UDk3bgozTFZUekFNN3Flell4SUVMQVlUUUN5eTdpeEIxNXlJV1UrUWhreUFtWXJoNEN6VUNNUjQreDlpaGZ6UnlOQkxLCmRBRTdwcjdyUEM4WFQ0YWh2SkJCZTg1THViTVdVRmprcEF5cklQODYyYkFCOCtKSXNFdXNZVGdQakUrMGhteTkKT0NIU2x4Q25GQVdPUXcwQ05Kb3AxWGpHU0RZOXlXL1NNWS83T3B0QlBhT3VWTzVwZTg3VmVXRFFtYmlpdnc3MQo4cFhDQnN6ZWNsdjJZKzdscTRnL0FaQkViVXRvLzV4UXJCbmZGKy9hZFFOQzY4aG4yYzZWa3czYTVDR0ZMN0p2CjhWdFNmeFEzZnFUci9TdzlJbkVKVWpuc0Y3R0xINzZMWXZIU05WeldhMkhiVFNlTnQ0RUlpdlEwb2d0b2hzY0kKSHlrZlpRQ3Z6ZnBSZi9TODFiRDNnU29jQ3NzR2crdVpVU0FMdVhBRDE4RkRXNzg2LzRCckcrMzVLOVBLNktUZwpoWGN4WmRHd3V1RWx0aTRBNWx4OHNrZExPSkZ6TUJPWFJNU2Jsc0dna3pGK2JNRkMrMHV3WW1WK0VTRUdwdy9NCm93WUN1dHh2a3ltL2NOcEk1bjFhanpEcQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span>
<span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-config.yaml</span>
<span class="c1"># This ConfigMap is used to configure a self-hosted Calico installation.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="c1"># Configure this with the location of your etcd cluster.</span>
  <span class="na">etcd_endpoints</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://192.168.1.51:2379,https://192.168.1.52:2379,https://192.168.1.53:2379"</span>

  <span class="c1"># If you're using TLS enabled etcd uncomment the following.</span>
  <span class="c1"># You must also populate the Secret below with these files.</span>
  <span class="na">etcd_ca</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/calico-secrets/etcd-ca"</span>
  <span class="na">etcd_cert</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/calico-secrets/etcd-cert"</span>
  <span class="na">etcd_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/calico-secrets/etcd-key"</span>
  <span class="c1"># Typha is disabled.</span>
  <span class="na">typha_service_name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">none"</span>
  <span class="c1"># Configure the Calico backend to use.</span>
  <span class="na">calico_backend</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bird"</span>

  <span class="c1"># Configure the MTU to use</span>
  <span class="na">veth_mtu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1440"</span>

  <span class="c1"># The CNI network configuration to install on each node.  The special</span>
  <span class="c1"># values in this config will be automatically populated.</span>
  <span class="na">cni_network_config</span><span class="pi">:</span> <span class="pi">|-</span>
    <span class="s">{</span>
      <span class="s">"name": "k8s-pod-network",</span>
      <span class="s">"cniVersion": "0.3.0",</span>
      <span class="s">"plugins": [</span>
        <span class="s">{</span>
          <span class="s">"type": "calico",</span>
          <span class="s">"log_level": "info",</span>
          <span class="s">"etcd_endpoints": "__ETCD_ENDPOINTS__",</span>
          <span class="s">"etcd_key_file": "__ETCD_KEY_FILE__",</span>
          <span class="s">"etcd_cert_file": "__ETCD_CERT_FILE__",</span>
          <span class="s">"etcd_ca_cert_file": "__ETCD_CA_CERT_FILE__",</span>
          <span class="s">"mtu": __CNI_MTU__,</span>
          <span class="s">"ipam": {</span>
              <span class="s">"type": "calico-ipam"</span>
          <span class="s">},</span>
          <span class="s">"policy": {</span>
              <span class="s">"type": "k8s"</span>
          <span class="s">},</span>
          <span class="s">"kubernetes": {</span>
              <span class="s">"kubeconfig": "__KUBECONFIG_FILEPATH__"</span>
          <span class="s">}</span>
        <span class="s">},</span>
        <span class="s">{</span>
          <span class="s">"type": "portmap",</span>
          <span class="s">"snat": true,</span>
          <span class="s">"capabilities": {"portMappings": true}</span>
        <span class="s">}</span>
      <span class="s">]</span>
    <span class="s">}</span>

<span class="s">---</span>
<span class="c1"># Source: calico/templates/rbac.yaml</span>

<span class="c1"># Include a clusterrole for the kube-controllers component,</span>
<span class="c1"># and bind it to the calico-kube-controllers serviceaccount.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="c1"># Pods are monitored for changing labels.</span>
  <span class="c1"># The node controller monitors Kubernetes nodes.</span>
  <span class="c1"># Namespace and serviceaccount labels are used for policy.</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pods</span>
      <span class="pi">-</span> <span class="s">nodes</span>
      <span class="pi">-</span> <span class="s">namespaces</span>
      <span class="pi">-</span> <span class="s">serviceaccounts</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">list</span>
  <span class="c1"># Watch for changes to Kubernetes NetworkPolicies.</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">networking.k8s.io"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">networkpolicies</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">list</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="c1"># Include a clusterrole for the calico-node DaemonSet,</span>
<span class="c1"># and bind it to the calico-node serviceaccount.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="c1"># The CNI plugin needs to get pods, nodes, and namespaces.</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">pods</span>
      <span class="pi">-</span> <span class="s">nodes</span>
      <span class="pi">-</span> <span class="s">namespaces</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">get</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">endpoints</span>
      <span class="pi">-</span> <span class="s">services</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="c1"># Used to discover service IPs for advertisement.</span>
      <span class="pi">-</span> <span class="s">watch</span>
      <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nodes/status</span>
    <span class="na">verbs</span><span class="pi">:</span>
      <span class="c1"># Needed for clearing NodeNetworkUnavailable flag.</span>
      <span class="pi">-</span> <span class="s">patch</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>

<span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-node.yaml</span>
<span class="c1"># This manifest installs the calico/node container, as well</span>
<span class="c1"># as the Calico CNI plugins and network config on</span>
<span class="c1"># each master and worker node in a Kubernetes cluster.</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DaemonSet</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-node</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">updateStrategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-node</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="c1"># This, along with the CriticalAddonsOnly toleration below,</span>
        <span class="c1"># marks the pod as a critical add-on, ensuring it gets</span>
        <span class="c1"># priority scheduling and that its resources are reserved</span>
        <span class="c1"># if it ever gets evicted.</span>
        <span class="s">scheduler.alpha.kubernetes.io/critical-pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="c1"># Make sure calico-node gets scheduled on all nodes.</span>
        <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="c1"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">CriticalAddonsOnly</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="pi">-</span> <span class="na">effect</span><span class="pi">:</span> <span class="s">NoExecute</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">calico-node</span>
      <span class="c1"># Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a "force</span>
      <span class="c1"># deletion": https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span>
      <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
      <span class="na">initContainers</span><span class="pi">:</span>
        <span class="c1"># This container installs the Calico CNI binaries</span>
        <span class="c1"># and CNI network config file on each node.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">install-cni</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">calico/cni:v3.6.0</span>
          <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/install-cni.sh"</span><span class="pi">]</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># Name of the CNI config file to create.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CNI_CONF_NAME</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10-calico.conflist"</span>
            <span class="c1"># The CNI network config to install on each node.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CNI_NETWORK_CONFIG</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">cni_network_config</span>
            <span class="c1"># The location of the Calico etcd cluster.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_ENDPOINTS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_endpoints</span>
            <span class="c1"># CNI MTU Config variable</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CNI_MTU</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">veth_mtu</span>
            <span class="c1"># Prevents the container from sleeping forever.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">SLEEP</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/opt/cni/bin</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">cni-bin-dir</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/host/etc/cni/net.d</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">cni-net-dir</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/calico-secrets</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="c1"># Runs calico/node container on each Kubernetes node.  This</span>
        <span class="c1"># container programs network policy and routes on each</span>
        <span class="c1"># host.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">calico/node:v3.6.0</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># The location of the Calico etcd cluster.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_ENDPOINTS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_endpoints</span>
            <span class="c1"># Location of the CA certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CA_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_ca</span>
            <span class="c1"># Location of the client key for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_KEY_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_key</span>
            <span class="c1"># Location of the client certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_cert</span>
            <span class="c1"># Set noderef for node controller.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_K8S_NODE_REF</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">fieldRef</span><span class="pi">:</span>
                  <span class="na">fieldPath</span><span class="pi">:</span> <span class="s">spec.nodeName</span>
            <span class="c1"># Choose the backend to use.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_NETWORKING_BACKEND</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">calico_backend</span>
            <span class="c1"># Cluster type to identify the deployment type</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CLUSTER_TYPE</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">k8s,bgp"</span>
            <span class="c1"># Auto-detect the BGP IP address.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">IP</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">autodetect"</span>
            <span class="c1"># Enable IPIP</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_IPIP</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Always"</span>
            <span class="c1"># Set MTU for tunnel device used if ipip is enabled</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_IPINIPMTU</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">veth_mtu</span>
            <span class="c1"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span>
            <span class="c1"># chosen from this range. Changing this value after installation will have</span>
            <span class="c1"># no effect. This should fall within `--cluster-cidr`.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_IPV4POOL_CIDR</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10.20.0.0/16"</span>
            <span class="c1"># Disable file logging so `kubectl logs` works.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">CALICO_DISABLE_FILE_LOGGING</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
            <span class="c1"># Set Felix endpoint to host default action to ACCEPT.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_DEFAULTENDPOINTTOHOSTACTION</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ACCEPT"</span>
            <span class="c1"># Disable IPv6 on Kubernetes.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_IPV6SUPPORT</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
            <span class="c1"># Set Felix logging to "info"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_LOGSEVERITYSCREEN</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">info"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">FELIX_HEALTHENABLED</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">IP_AUTODETECTION_METHOD</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">can-reach=192.168.1.51</span>
          <span class="na">securityContext</span><span class="pi">:</span>
            <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
              <span class="na">cpu</span><span class="pi">:</span> <span class="s">250m</span>
          <span class="na">livenessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/liveness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">9099</span>
              <span class="na">host</span><span class="pi">:</span> <span class="s">localhost</span>
            <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">10</span>
            <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">6</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">/bin/calico-node</span>
              <span class="pi">-</span> <span class="s">-bird-ready</span>
              <span class="pi">-</span> <span class="s">-felix-ready</span>
            <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/lib/modules</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">lib-modules</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/run/xtables.lock</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">xtables-lock</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/run/calico</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">var-run-calico</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/calico</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">var-lib-calico</span>
              <span class="na">readOnly</span><span class="pi">:</span> <span class="no">false</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/calico-secrets</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="c1"># Used by calico/node.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">lib-modules</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/lib/modules</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-run-calico</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/var/run/calico</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">var-lib-calico</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/var/lib/calico</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">xtables-lock</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/run/xtables.lock</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">FileOrCreate</span>
        <span class="c1"># Used to install CNI.</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni-bin-dir</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/opt/cni/bin</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">cni-net-dir</span>
          <span class="na">hostPath</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/etc/cni/net.d</span>
        <span class="c1"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="c1"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
          <span class="na">secret</span><span class="pi">:</span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">calico-etcd-secrets</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0400</span>
<span class="nn">---</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-node</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>

<span class="nn">---</span>
<span class="c1"># Source: calico/templates/calico-kube-controllers.yaml</span>
<span class="c1"># This manifest deploys the Calico Kubernetes controllers.</span>
<span class="c1"># See https://github.com/projectcalico/kube-controllers</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">scheduler.alpha.kubernetes.io/critical-pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="c1"># The controllers can only have a single active instance.</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
      <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="c1"># The controllers must run in the host network namespace so that</span>
      <span class="c1"># it isn't governed by policy that would prevent it from working.</span>
      <span class="na">hostNetwork</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="c1"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">CriticalAddonsOnly</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">node-role.kubernetes.io/master</span>
          <span class="na">effect</span><span class="pi">:</span> <span class="s">NoSchedule</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">calico/kube-controllers:v3.6.0</span>
          <span class="na">env</span><span class="pi">:</span>
            <span class="c1"># The location of the Calico etcd cluster.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_ENDPOINTS</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_endpoints</span>
            <span class="c1"># Location of the CA certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CA_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_ca</span>
            <span class="c1"># Location of the client key for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_KEY_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_key</span>
            <span class="c1"># Location of the client certificate for etcd.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ETCD_CERT_FILE</span>
              <span class="na">valueFrom</span><span class="pi">:</span>
                <span class="na">configMapKeyRef</span><span class="pi">:</span>
                  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-config</span>
                  <span class="na">key</span><span class="pi">:</span> <span class="s">etcd_cert</span>
            <span class="c1"># Choose which controllers to run.</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">ENABLED_CONTROLLERS</span>
              <span class="na">value</span><span class="pi">:</span> <span class="s">policy,namespace,serviceaccount,workloadendpoint,node</span>
          <span class="na">volumeMounts</span><span class="pi">:</span>
            <span class="c1"># Mount in the etcd TLS secrets.</span>
            <span class="pi">-</span> <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/calico-secrets</span>
              <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">exec</span><span class="pi">:</span>
              <span class="na">command</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">/usr/bin/check-status</span>
              <span class="pi">-</span> <span class="s">-r</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="c1"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="c1"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">etcd-certs</span>
          <span class="na">secret</span><span class="pi">:</span>
            <span class="na">secretName</span><span class="pi">:</span> <span class="s">calico-etcd-secrets</span>
            <span class="na">defaultMode</span><span class="pi">:</span> <span class="m">0400</span>

<span class="nn">---</span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">calico-kube-controllers</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
</code></pre></div></div>

<p><strong>需要注意的是我们添加了 <code class="highlighter-rouge">IP_AUTODETECTION_METHOD</code> 变量，这个变量会设置 calcio 获取 node ip 的方式；默认情况下采用 <a href="https://docs.projectcalico.org/v3.6/reference/node/configuration#ip-autodetection-methods">first-found</a> 方式获取，即获取第一个有效网卡的 IP 作为 node ip；在某些多网卡机器上可能会出现问题；这里将值设置为 <code class="highlighter-rouge">can-reach=192.168.1.51</code>，即使用第一个能够访问 master <code class="highlighter-rouge">192.168.1.51</code> 的网卡地址作为 node ip</strong></p>

<p>最后执行创建即可，创建成功后如下所示</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker1.node ➜  ~ kubectl get pod <span class="nt">-o</span> wide <span class="nt">-n</span> kube-system
NAME                                      READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATES
calico-kube-controllers-65bc6b9f9-cn27f   1/1     Running   0          85s   192.168.1.53   docker3.node   &lt;none&gt;           &lt;none&gt;
calico-node-c5nl8                         1/1     Running   0          85s   192.168.1.53   docker3.node   &lt;none&gt;           &lt;none&gt;
calico-node-fqknv                         1/1     Running   0          85s   192.168.1.51   docker1.node   &lt;none&gt;           &lt;none&gt;
calico-node-ldfzs                         1/1     Running   0          85s   192.168.1.55   docker5.node   &lt;none&gt;           &lt;none&gt;
calico-node-ngjxc                         1/1     Running   0          85s   192.168.1.52   docker2.node   &lt;none&gt;           &lt;none&gt;
calico-node-vj8np                         1/1     Running   0          85s   192.168.1.54   docker4.node   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>此时所有 node 应当变为 Ready 状态</p>

<h3 id="35部署-dns">3.5、部署 DNS</h3>

<p>其他组件全部完成后我们应当部署集群 DNS 使 service 等能够正常解析；集群 DNS 这里采用 coredns，具体安装文档参考 <a href="https://github.com/coredns/deployment/tree/master/kubernetes">coredns/deployment</a>；coredns 完整配置如下</p>

<ul>
  <li>coredns.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">kubernetes.io/bootstrapping</span><span class="pi">:</span> <span class="s">rbac-defaults</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:coredns</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">endpoints</span>
  <span class="pi">-</span> <span class="s">services</span>
  <span class="pi">-</span> <span class="s">pods</span>
  <span class="pi">-</span> <span class="s">namespaces</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">list</span>
  <span class="pi">-</span> <span class="s">watch</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">"</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">nodes</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">get</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">rbac.authorization.kubernetes.io/autoupdate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">kubernetes.io/bootstrapping</span><span class="pi">:</span> <span class="s">rbac-defaults</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:coredns</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:coredns</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">Corefile</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">.:53 {</span>
        <span class="s">errors</span>
        <span class="s">health</span>
        <span class="s">kubernetes cluster.local in-addr.arpa ip6.arpa {</span>
          <span class="s">pods insecure</span>
          <span class="s">upstream</span>
          <span class="s">fallthrough in-addr.arpa ip6.arpa</span>
        <span class="s">}</span>
        <span class="s">prometheus :9153</span>
        <span class="s">forward . /etc/resolv.conf</span>
        <span class="s">cache 30</span>
        <span class="s">loop</span>
        <span class="s">reload</span>
        <span class="s">loadbalance</span>
    <span class="s">}</span>
<span class="s">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
    <span class="s">kubernetes.io/name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CoreDNS"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">RollingUpdate</span>
    <span class="na">rollingUpdate</span><span class="pi">:</span>
      <span class="na">maxUnavailable</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">priorityClassName</span><span class="pi">:</span> <span class="s">system-cluster-critical</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">coredns</span>
      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CriticalAddonsOnly"</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
      <span class="na">nodeSelector</span><span class="pi">:</span>
        <span class="s">beta.kubernetes.io/os</span><span class="pi">:</span> <span class="s">linux</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">coredns/coredns:1.3.1</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">resources</span><span class="pi">:</span>
          <span class="na">limits</span><span class="pi">:</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">170Mi</span>
          <span class="na">requests</span><span class="pi">:</span>
            <span class="na">cpu</span><span class="pi">:</span> <span class="s">100m</span>
            <span class="na">memory</span><span class="pi">:</span> <span class="s">70Mi</span>
        <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">-conf"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">/etc/coredns/Corefile"</span> <span class="pi">]</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/coredns</span>
          <span class="na">readOnly</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">53</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">dns</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">53</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">dns-tcp</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">9153</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">metrics</span>
          <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
        <span class="na">securityContext</span><span class="pi">:</span>
          <span class="na">allowPrivilegeEscalation</span><span class="pi">:</span> <span class="no">false</span>
          <span class="na">capabilities</span><span class="pi">:</span>
            <span class="na">add</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">NET_BIND_SERVICE</span>
            <span class="na">drop</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">all</span>
          <span class="na">readOnlyRootFilesystem</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">livenessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
          <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">60</span>
          <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">5</span>
          <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
          <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">5</span>
        <span class="na">readinessProbe</span><span class="pi">:</span>
          <span class="na">httpGet</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s">/health</span>
            <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">scheme</span><span class="pi">:</span> <span class="s">HTTP</span>
      <span class="na">dnsPolicy</span><span class="pi">:</span> <span class="s">Default</span>
      <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">config-volume</span>
          <span class="na">configMap</span><span class="pi">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">coredns</span>
            <span class="na">items</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">Corefile</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">Corefile</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">prometheus.io/port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">9153"</span>
    <span class="s">prometheus.io/scrape</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
    <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="s">kubernetes.io/name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CoreDNS"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">10.254.0.2</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dns</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">UDP</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">dns-tcp</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">53</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">metrics</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">9153</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
</code></pre></div></div>

<h3 id="35部署-dns-自动扩容">3.5、部署 DNS 自动扩容</h3>

<p>在大规模集群的情况下，可能需要集群 DNS 自动扩容，具体文档请参考 <a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns-horizontal-autoscaler">DNS Horizontal Autoscaler</a>，DNS 扩容算法可参考 <a href="https://github.com/kubernetes-incubator/cluster-proportional-autoscaler/">Github</a>，如有需要请自行修改；以下为具体配置</p>

<ul>
  <li>dns-horizontal-autoscaler.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Copyright 2016 The Kubernetes Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:kube-dns-autoscaler</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">nodes"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">replicationcontrollers/scale"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">]</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">extensions"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">deployments/scale"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">replicasets/scale"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">update"</span><span class="pi">]</span>
<span class="c1"># Remove the configmaps rule once below issue is fixed:</span>
<span class="c1"># kubernetes-incubator/cluster-proportional-autoscaler#16</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">configmaps"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">create"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:kube-dns-autoscaler</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
    <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:kube-dns-autoscaler</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>

<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
    <span class="s">kubernetes.io/cluster-service</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
    <span class="s">addonmanager.kubernetes.io/mode</span><span class="pi">:</span> <span class="s">Reconcile</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
      <span class="na">annotations</span><span class="pi">:</span>
        <span class="s">scheduler.alpha.kubernetes.io/critical-pod</span><span class="pi">:</span> <span class="s1">'</span><span class="s">'</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">priorityClassName</span><span class="pi">:</span> <span class="s">system-cluster-critical</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">autoscaler</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.azk8s.cn/google_containers/cluster-proportional-autoscaler-amd64:1.1.2-r2</span>
        <span class="na">resources</span><span class="pi">:</span>
            <span class="na">requests</span><span class="pi">:</span>
                <span class="na">cpu</span><span class="pi">:</span> <span class="s2">"</span><span class="s">20m"</span>
                <span class="na">memory</span><span class="pi">:</span> <span class="s2">"</span><span class="s">10Mi"</span>
        <span class="na">command</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">/cluster-proportional-autoscaler</span>
          <span class="pi">-</span> <span class="s">--namespace=kube-system</span>
          <span class="pi">-</span> <span class="s">--configmap=kube-dns-autoscaler</span>
          <span class="c1"># Should keep target in sync with cluster/addons/dns/kube-dns.yaml.base</span>
          <span class="pi">-</span> <span class="s">--target=Deployment/coredns</span>
          <span class="c1"># When cluster is using large nodes(with more cores), "coresPerReplica" should dominate.</span>
          <span class="c1"># If using small nodes, "nodesPerReplica" should dominate.</span>
          <span class="pi">-</span> <span class="s">--default-params={"linear":{"coresPerReplica":256,"nodesPerReplica":16,"preventSinglePointFailure":true}}</span>
          <span class="pi">-</span> <span class="s">--logtostderr=true</span>
          <span class="pi">-</span> <span class="s">--v=2</span>
      <span class="na">tolerations</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CriticalAddonsOnly"</span>
        <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">kube-dns-autoscaler</span>
</code></pre></div></div>

<h2 id="四其他">四、其他</h2>

<h3 id="41集群测试">4.1、集群测试</h3>

<p>为测试集群工作正常，我们创建一个 deployment 和一个 service，用于测试联通性和 DNS 工作是否正常；测试配置如下</p>

<ul>
  <li>test.yaml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">test</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">nginx:1.14.2-alpine</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">80</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">test-service</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nginx</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">nodePort</span><span class="pi">:</span> <span class="m">30001</span>
    <span class="na">targetPort</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
</code></pre></div></div>

<p>测试方式很简单，进入某一个 pod ping 其他 pod ip 确认网络是否正常，直接访问 service 名称测试 DNS 是否工作正常，这里不再演示</p>

<h3 id="42其他说明">4.2、其他说明</h3>

<p>此次搭建开启了大部分认证，限于篇幅原因没有将每个选项作用做完整解释，推荐搭建完成后仔细阅读以下 <code class="highlighter-rouge">--help</code> 中的描述(官方文档页面有时候更新不完整)；目前 apiserver 仍然保留了 8080 端口(因为直接使用 kubectl 方便)，但是在高安全性环境请关闭 8080 端口，因为即使绑定在 127.0.0.1 上，对于任何能够登录 master 机器的用户仍然能够不经验证操作整个集群</p>

<p>转载请注明出处，本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> 协议授权</p>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2019/01/16/understand-kubernetes-sample-cli-plugin-source-code/" data-toggle="tooltip" data-placement="top" title="Kubernetes sample-cli-plugin 源码分析">
                        Previous<br>
                        <span>Kubernetes sample-cli-plugin 源码分析</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2019/03/19/how-to-set-multiple-apt-mirrors-for-ubuntu/" data-toggle="tooltip" data-placement="top" title="Ubuntu 设置多个源">
                        Next<br>
                        <span>Ubuntu 设置多个源</span>
                        </a>
                    </li>
                    
                </ul>


                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                            
                                <a href="/tags/#Linux" title="Linux" rel="82">
                                    Linux
                                </a>
                            
                        
                            
                                <a href="/tags/#SQL" title="SQL" rel="4">
                                    SQL
                                </a>
                            
                        
                            
                                <a href="/tags/#Java" title="Java" rel="25">
                                    Java
                                </a>
                            
                        
                            
                                <a href="/tags/#随笔" title="随笔" rel="9">
                                    随笔
                                </a>
                            
                        
                            
                                <a href="/tags/#GitHub" title="GitHub" rel="3">
                                    GitHub
                                </a>
                            
                        
                            
                                <a href="/tags/#Docker" title="Docker" rel="43">
                                    Docker
                                </a>
                            
                        
                            
                                <a href="/tags/#Kubernetes" title="Kubernetes" rel="39">
                                    Kubernetes
                                </a>
                            
                        
                            
                                <a href="/tags/#CI/CD" title="CI/CD" rel="4">
                                    CI/CD
                                </a>
                            
                        
                            
                                <a href="/tags/#Golang" title="Golang" rel="6">
                                    Golang
                                </a>
                            
                        
                            
                                <a href="/tags/#Mac" title="Mac" rel="1">
                                    Mac
                                </a>
                            
                        
                            
                                <a href="/tags/#Podman" title="Podman" rel="1">
                                    Podman
                                </a>
                            
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://mdba.cn">DBA的罗浮宫</a></li>
                    
                        <li><a href="http://www.xieyuxuan.cc">谢雨轩</a></li>
                    
                        <li><a href="https://ehlxr.me">Ehlxr's Blog</a></li>
                    
                        <li><a href="http://www.dearzd.com/DBlog">咚门</a></li>
                    
                        <li><a href="http://log.zvz.im">Z</a></li>
                    
                        <li><a href="https://www.4spaces.org">容休博客</a></li>
                    
                        <li><a href="http://www.webank.pw">幽鸿居</a></li>
                    
                        <li><a href="http://ephen.me">Ephen's Blog</a></li>
                    
                        <li><a href="https://www.codesheep.cn">CodeSheep</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "mritd";
    var disqus_identifier = "/2019/03/16/set-up-kubernetes-1.13.4-cluster";
    var disqus_url = "https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/mritd1234">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://t.me/mritd">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-telegram fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/mritd">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 漠然 2020
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/mritd-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-82387173-1';
    var _gaDomain = 'mritd.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {

        // interop with multilangual 
        if (false) {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/avatar.jpg" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
