<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="å¦‚ä½•åœ¨ Filebeat ç«¯è¿›è¡Œæ—¥å¿—å¤„ç†">
    <meta name="keywords"  content="kubernetes,filebeat">
    <meta name="theme-color" content="#000000">
    
    <title>å¦‚ä½•åœ¨ Filebeat ç«¯è¿›è¡Œæ—¥å¿—å¤„ç† - æ¼ ç„¶çš„åšå®¢ | mritd Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mritd.me/2020/06/28/how-to-modify-filebeat-source-code-to-processing-logs/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Rouge CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/mritd-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">æ¼ ç„¶</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg')
    }

    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Kubernetes" title="Kubernetes">Kubernetes</a>
                        
                    </div>
                    <h1>å¦‚ä½•åœ¨ Filebeat ç«¯è¿›è¡Œæ—¥å¿—å¤„ç†</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by æ¼ ç„¶ on June 28, 2020</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

                <blockquote>
  <p>æœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ ELK æ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ—¥å¿—åˆ‡å‰²å¤„ç†ç›´æ¥åœ¨ filebeat ç«¯å®ç°çš„ä¸€äº›æ–¹å¼ï¼›å…¶ä¸­åŒ…æ‹¬ filebeat processor çš„æ‰©å±•ä»¥åŠ module æ‰©å±•ç­‰ã€‚</p>
</blockquote>

<h2 id="ä¸€èµ·å› ">ä¸€ã€èµ·å› </h2>

<p>ç›®å‰æŸé¡¹ç›®ç»„æ—¥å¿—éœ€è¦åšåˆ‡å‰²å¤„ç†ï¼Œé’ˆå¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œåˆ†å‰²å¹¶æå– k/v æ”¾å…¥ es ä¸­æ–¹ä¾¿æŸ¥è¯¢ã€‚è¿™ç§éœ€æ±‚åœ¨ä¼ ç»Ÿ ELK ä¸­åº”å½“ç”± logstash ç»„ä»¶å®Œæˆï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">gork</code> ç­‰æ“ä½œå¯¹æ—¥å¿—è¿›è¡Œè¿‡æ»¤ã€åˆ‡å‰²ç­‰å¤„ç†ã€‚ä¸è¿‡å¾ˆå°´å°¬çš„æ˜¯æˆ‘å¹¶ä¸ä¼š rubyï¼Œlogstash pipeline çš„ä¸€äº›é…ç½®æˆ‘ä¹Ÿæ˜¯æå…¶å¤´ç–¼ï¼Œè€Œä¸”è¿˜ä¸æƒ³å­¦â€¦æ›´ä¸å‡‘å·§çš„æ˜¯æˆ‘ä¼šå†™ç‚¹ goï¼Œ<strong>é‚£ä¹ˆç†æ‰€åº”å½“çš„æ­¤æ—¶çš„æˆ‘å¯¹ filebeat æºç äº§ç”Ÿäº†ä¸€äº›æƒ³æ³•ï¼Œæ¯”å¦‚æˆ‘ç›´æ¥åœ¨ filebeat ç«¯å®Œæˆæ—¥å¿—å¤„ç†ï¼Œç„¶åç›´æ¥å‘ es/logstashï¼Œè¿™æ ·ä¼¼ä¹æ›´æ–¹ä¾¿ï¼Œè€Œä¸”è¿˜èƒ½åˆ†æ‘Š logstash çš„å‹åŠ›ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªæ“ä½œå¹¶ä¸è¿‡åˆ†ğŸ˜‚â€¦</strong></p>

<h2 id="äºŒéœ€æ±‚">äºŒã€éœ€æ±‚</h2>

<p>ç›®å‰æŸé¡¹ç›®ç»„ java æ—¥å¿—æ ¼å¼å¦‚ä¸‹:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2020-04-30 21:56:30.117<span class="nv">$$</span>api-test-65c8c7cf7f-lng7h<span class="nv">$$</span>http-nio-8080-exec-3<span class="nv">$$</span>INFO<span class="nv">$$</span>com.example.api.common.filter.GlobalDataFilter<span class="nv">$$</span>GlobalDataFilter.java<span class="nv">$$</span>95<span class="nv">$$</span><span class="nb">test
</span>build commonData from header :<span class="o">{</span><span class="s2">"romVersion"</span>:<span class="s2">"W_V2.1.4"</span>,<span class="s2">"softwareVersion"</span>:<span class="s2">"15"</span>,<span class="s2">"token"</span>:<span class="s2">"aFxANNM3pnRYpohvLMSmENydgFSfsmFMgCbFWAosIE="</span><span class="o">}</span>
<span class="nv">$$$$</span>
</code></pre></div></div>

<p>ç›®å‰å¼€å‘çº¦å®šæ ¼å¼ä¸ºæ—¥å¿—é€šè¿‡ <code class="language-plaintext highlighter-rouge">$$</code> è¿›è¡Œåˆ†å‰²ï¼Œæ—¥å¿—æ ¼å¼æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ logstash å…±ç”¨(nginx ç­‰å„ç§æ—¥å¿—éƒ½ä¼šå¾€è¿™ä¸ª logstash è¾“å‡º)ï¼Œä¸æƒ³å»æŠ˜è…¾ logstash é…ç½®çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦è®© filebeat èƒ½å¤Ÿç›´æ¥åˆ‡å‰²å¹¶è®¾ç½®å¥½ k/v å¯¹åº”æ—¢å¯ã€‚</p>

<h2 id="ä¸‰filebeat-module">ä¸‰ã€filebeat module</h2>

<blockquote>
  <p>module éƒ¨ä»½åªåšç®€ä»‹ï¼Œä»¥ä¸ºå®é™…ä¸Šä¾æ‰˜ es å®Œæˆï¼Œæ„ä¹‰ä¸å¤§ã€‚</p>
</blockquote>

<p>å½“ç„¶åœ¨è€ƒè™‘ä¿®æ”¹ filebeat æºç åï¼Œæˆ‘ç¬¬ä¸€æƒ³åˆ°çš„æ˜¯ filebeat çš„ moduleï¼Œè¿™ä¸ª module åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯ä¸ªå¾ˆç¥å¥‡çš„ä¸œè¥¿ï¼›é€šè¿‡å¼€å¯ä¸€ä¸ª module å°±å¯ä»¥å¯¹æŸç§æ—¥å¿—ç›´æ¥åšå¤„ç†ï¼Œè¿™ç§ä¸œè¥¿ä¼¼ä¹å°±æ˜¯æˆ‘æƒ³è¦çš„ï¼›æ¯”å¦‚æˆ‘å†™ä¸€ä¸ª â€œé¡¹ç›®åâ€ moduleï¼Œç„¶å filebeat ç›´æ¥å¼€å¯è¿™ä¸ª moduleï¼Œè¿™ä¸ªé¡¹ç›®çš„æ—¥å¿—å°±ç›´æ¥è‡ªåŠ¨å¤„ç†å¥½(å¬èµ·æ¥å°±å¾ˆ â€œä¸Šæµâ€)â€¦</p>

<p>é’ˆå¯¹äºè‡ªå®šä¹‰ moduleï¼Œå®˜æ–¹ç»™å‡ºäº†æ–‡æ¡£: <a href="https://www.elastic.co/guide/en/beats/devguide/current/filebeat-modules-devguide.html">Creating a New Filebeat Module</a></p>

<p>æŒ‰ç…§æ–‡æ¡£æ“ä½œå¦‚ä¸‹(å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®åä¸º cdm):</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å…‹éš†æºç </span>
git clone git@github.com:elastic/beats.git
<span class="c"># åˆ‡æ¢åˆ°ç¨³å®šåˆ†æ”¯</span>
<span class="nb">cd </span>bests <span class="o">&amp;&amp;</span> git checkout <span class="nt">-b</span> v7.6.2 v7.6.2-module
<span class="c"># åˆ›å»º moduleï¼ŒGO111MODULE éœ€è¦è®¾ç½®ä¸º off</span>
<span class="c"># åœ¨ 7.6.2 ç‰ˆæœ¬å®˜æ–¹å°šæœªå¼€å§‹æ”¯æŒ go mod</span>
<span class="nb">cd </span>filebeat
<span class="nv">GO111MODULE</span><span class="o">=</span>off make create-module <span class="nv">MODULE</span><span class="o">=</span>cdm
</code></pre></div></div>

<p>åˆ›å»ºå®Œæˆåç›®å½•ç»“æ„å¦‚ä¸‹</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>âœ  filebeat git:<span class="o">(</span>v7.6.2-module<span class="o">)</span> âœ— tree module/cdm
module/cdm
â”œâ”€â”€ _meta
â”‚Â Â  â”œâ”€â”€ config.yml
â”‚Â Â  â”œâ”€â”€ docs.asciidoc
â”‚Â Â  â””â”€â”€ fields.yml
â””â”€â”€ module.yml

1 directory, 4 files
</code></pre></div></div>

<p>è¿™å‡ ä¸ªæ–‡ä»¶å…·ä½“ä½œç”¨<a href="https://www.elastic.co/guide/en/beats/devguide/current/filebeat-modules-devguide.html">å®˜æ–¹æ–‡æ¡£</a>éƒ½æœ‰è¯¦ç»†çš„æè¿°ï¼›ä½†æ˜¯æ ¹æ®æ–‡æ¡£æè¿°å…‰æœ‰è¿™å‡ ä¸ªæ–‡ä»¶æ˜¯ä¸å¤Ÿçš„ï¼Œ<strong>module åªæ˜¯ä¸€ä¸ªå¤„ç†é›†åˆçš„å®šä¹‰ï¼Œå°šæœªåŒ…å«ä»»ä½•å¤„ç†ï¼Œé’ˆå¯¹çœŸæ­£çš„å¤„ç†éœ€è¦ç»§ç»­åˆ›å»º filesetï¼Œfileset ç®€å•çš„ç†è§£å°±æ˜¯é’ˆå¯¹å…·ä½“çš„ä¸€ç»„æ–‡ä»¶é›†åˆçš„å¤„ç†ï¼›</strong>ä¾‹å¦‚å®˜æ–¹ nginx module ä¸­åŒ…å«ä¸¤ä¸ª fileset: <code class="language-plaintext highlighter-rouge">access</code> å’Œ <code class="language-plaintext highlighter-rouge">error</code>ï¼Œè¿™ä¸¤ä¸ªä¸€ä¸ªé’ˆå¯¹ access æ—¥å¿—å¤„ç†ä¸€ä¸ªé’ˆå¯¹ error æ—¥å¿—è¿›è¡Œå¤„ç†ï¼›åœ¨ fileset ä¸­å¯ä»¥è®¾ç½®é»˜è®¤æ–‡ä»¶ä½ç½®ã€å¤„ç†æ–¹å¼ã€‚</p>

<p><strong>Butâ€¦ æˆ‘ç¿»äº† nginx module çš„æ ·ä¾‹é…ç½®æ‰å‘ç°ï¼Œmodule è¿™ä¸ªä¸œè¥¿å®è´¨ä¸Šåªåšå®šä¹‰å’Œå­˜å‚¨å¤„ç†è¡¨è¾¾å¼ï¼Œå…·ä½“çš„åˆ‡å‰²å¤„ç†å®é™…ä¸Šäº¤ç”± es çš„ <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html">Ingest Node</a> å¤„ç†ï¼›è¡¨è¾¾å¼é‡Œä»éœ€è¦å®šä¹‰ <code class="language-plaintext highlighter-rouge">grok</code> ç­‰æ“ä½œï¼Œè€Œä¸”è¿™ä¸œè¥¿æœ€ç»ˆä¼šç¼–è¯‘åˆ° go é™æ€æ–‡ä»¶é‡Œï¼›</strong>æ­¤æ—¶çš„æˆ‘æƒ³è¯´ä¸€å¥ â€œMMPâ€ï¼Œæœ¬æ¥æˆ‘æ˜¯ä¸åƒå†™ grok å•¥çš„æ‰æ¥æŠ˜è…¾ filebeatï¼Œç»“æœè¿™ä¸ª module æŠ˜è…¾ä¸€åœˆè¿˜æ˜¯è¦å†™ grok å•¥çš„ï¼Œè€Œä¸”è¿™ä¸œè¥¿ç›´æ¥å€ŸåŠ© es å®Œæˆå¯¼è‡´å‹åŠ›å›åˆ°äº† es åŒæ—¶æ¯æ¬¡ä¿®æ”¹è¿˜å¾—é‡æ–°ç¼–è¯‘ filebeatâ€¦ æ‰€ä»¥æŠ˜è…¾åˆ°è¿™æˆ‘å°±æ”¾å¼ƒäº†ï¼Œè¿™å·²ç»è¿èƒŒäº†å½“åˆçš„ç›®çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡æ¡£ç»§ç»­æŠ˜è…¾:</p>

<ul>
  <li><a href="https://www.elastic.co/guide/en/beats/devguide/current/filebeat-modules-devguide.html">Creating a New Filebeat Module</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html">Ingest nodeedit</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-apis.html">Ingest APIs</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-processors.html">Processors</a></li>
</ul>

<h2 id="å››filebeat-processors">å››ã€filebeat processors</h2>

<p>ç»å†äº† module çš„å¤±æœ›ä»¥åï¼Œæˆ‘æŠŠç›®å…‰å¯¹å‡†äº† processorsï¼›processors æ˜¯ filebeat ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œé¡¾åæ€ä¹‰å®ƒå¯ä»¥å¯¹ filbeat æ”¶é›†åˆ°çš„æ—¥å¿—è¿›è¡Œä¸€äº›å¤„ç†ï¼›ä»å®˜æ–¹ <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html">Processors</a> é¡µé¢å¯ä»¥çœ‹åˆ°å…¶å†…ç½®äº†å¤§é‡çš„ processorï¼›è¿™äº› processor å¤§éƒ¨ä»½éƒ½æ˜¯ç›´æ¥å¯¹æ—¥å¿—è¿›è¡Œ â€œå†™â€ æ“ä½œï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª processor å°±å¯ä»¥ â€œä¸ºæ‰€æ¬²ä¸º+ä¸ºæ‰€æ¬²ä¸º=ä¸ºæ‰€æ¬²ä¸ºâ€ã€‚</p>

<p>ä¸è¿‡ä¸å¹¸çš„æ˜¯å…³äº processor çš„å¼€å‘å®˜æ–¹å¹¶æœªç»™å‡ºæ–‡æ¡£ï¼Œå®˜æ–¹è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">high level</code> çš„ä¸œè¥¿ï¼Œä¸è¿‡ä¹Ÿæ‰¾åˆ°äº†ä¸€ä¸ª issue å¯¹å…¶åšäº†ç›¸å…³å›ç­”: <a href="https://github.com/elastic/beats/issues/6760">How do I write a processor plugin by myself</a>ï¼›æ‰€ä»¥æœ€å¥½çš„åŠæ³•å°±æ˜¯ç›´æ¥çœ‹å·²æœ‰ processor çš„æºç æŠ„ä¸€ä¸ªã€‚</p>

<p>ç†æ‰€åº”å½“çš„æ‰¾äº†ä¸€ä¸ªè½¯æŸ¿å­æ: <code class="language-plaintext highlighter-rouge">add_host_metadata</code>ï¼Œadd_host_metadata processor é¡¾åæ€ä¹‰åœ¨æ¯ä¸ªæ—¥å¿—äº‹ä»¶(ä»¥ä¸‹ç®€ç§°ä¸º event)ä¸­åŠ å…¥å®¿ä¸»æœºçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ hostname å•¥çš„ï¼›ä»¥ä¸‹ä¸º add_host_metadata processor çš„æ–‡ä»¶ç»“æ„(processors ä»£ç å­˜å‚¨åœ¨ <code class="language-plaintext highlighter-rouge">libbeat/processors</code> ç›®å½•ä¸‹)ã€‚</p>

<p><img src="https://cdn.oss.link/markdown/axucc.jpg" alt="dir_tree" /></p>

<p>é€šè¿‡é˜…è¯»æºç å’Œ issue çš„å›ç­”å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ processor åªéœ€è¦å®ç° <a href="https://godoc.org/github.com/elastic/beats/libbeat/processors#Processor">Processor interface</a> æ—¢å¯ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰å¦‚ä¸‹:</p>

<p><img src="https://cdn.oss.link/markdown/xuja6.png" alt="Processor interface" /></p>

<p>é€šè¿‡æŸ¥çœ‹ add_host_metadata çš„æºç ï¼Œ<code class="language-plaintext highlighter-rouge">String() string</code> æ–¹æ³•åªéœ€è¦è¿”å›è¿™ä¸ª processor åç§°æ—¢å¯(å¯ä»¥åŒ…å«å¿…è¦çš„é…ç½®ä¿¡æ¯)ï¼›<strong>è€Œ <code class="language-plaintext highlighter-rouge">Run(event *beat.Event) (*beat.Event, error)</code> æ–¹æ³•è¡¨ç¤ºåœ¨æ¯ä¸€æ¡æ—¥å¿—è¢«è¯»å–åéƒ½ä¼šè½¬æ¢ä¸ºä¸€ä¸ª event å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ç„¶åæŠŠ event è¿”å›æ—¢å¯(å…¶ä»– processor å¯èƒ½ä¹Ÿè¦å¤„ç†)ã€‚</strong></p>

<p><img src="https://cdn.oss.link/markdown/jhtnx.png" alt="add_host_metadata source" /></p>

<p>æœ‰äº†è¿™äº›ä¿¡æ¯å°±ç®€å•å¾—å¤šäº†ï¼Œæ¯•ç«Ÿä½œä¸º<strong>ä¸€ååˆæ ¼çš„ CCE(Ctrl C + Ctrl V + Engineer)</strong> æŠ„è¿™ç§æ“ä½œè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œç›´æ¥ç…§çŒ«ç”»è™å†™ä¸€ä¸ªå°±è¡Œäº†</p>

<p>config.go</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">cmd</span>

<span class="c">// Config for cdm processor.</span>
<span class="k">type</span> <span class="n">Config</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Name</span>           <span class="kt">string</span>          <span class="s">`config:"name"`</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">defaultConfig</span><span class="p">()</span> <span class="n">Config</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">Config</span><span class="p">{</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>cdm.go</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">cmd</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"strings"</span>

	<span class="s">"github.com/elastic/beats/libbeat/logp"</span>
	<span class="s">"github.com/pkg/errors"</span>

	<span class="s">"github.com/elastic/beats/libbeat/beat"</span>
	<span class="s">"github.com/elastic/beats/libbeat/common"</span>
	<span class="s">"github.com/elastic/beats/libbeat/processors"</span>
	<span class="n">jsprocessor</span> <span class="s">"github.com/elastic/beats/libbeat/processors/script/javascript/module/processor"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">processors</span><span class="o">.</span><span class="n">RegisterPlugin</span><span class="p">(</span><span class="s">"cdm"</span><span class="p">,</span> <span class="n">New</span><span class="p">)</span>
	<span class="n">jsprocessor</span><span class="o">.</span><span class="n">RegisterPlugin</span><span class="p">(</span><span class="s">"CDM"</span><span class="p">,</span> <span class="n">New</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">cdm</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">config</span> <span class="n">Config</span>
	<span class="n">fields</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="n">log</span>    <span class="o">*</span><span class="n">logp</span><span class="o">.</span><span class="n">Logger</span>
<span class="p">}</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="n">processorName</span> <span class="o">=</span> <span class="s">"cdm"</span>
	<span class="n">logName</span>       <span class="o">=</span> <span class="s">"processor.cdm"</span>
<span class="p">)</span>

<span class="c">// New constructs a new cdm processor.</span>
<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">cfg</span> <span class="o">*</span><span class="n">common</span><span class="o">.</span><span class="n">Config</span><span class="p">)</span> <span class="p">(</span><span class="n">processors</span><span class="o">.</span><span class="n">Processor</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c">// é…ç½®æ–‡ä»¶é‡Œå°±ä¸€ä¸ª Name å­—æ®µï¼Œç»“æ„ä½“ç•™ç€ä»¥åæ–¹ä¾¿æ‰©å±•</span>
	<span class="n">config</span> <span class="o">:=</span> <span class="n">defaultConfig</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">Unpack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">Wrapf</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"fail to unpack the %v configuration"</span><span class="p">,</span> <span class="n">processorName</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">cdm</span><span class="p">{</span>
		<span class="n">config</span><span class="o">:</span> <span class="n">config</span><span class="p">,</span>
		<span class="c">// å¾…åˆ†å‰²çš„æ¯æ®µæ—¥å¿—å¯¹åº”çš„ key</span>
		<span class="n">fields</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"timestamp"</span><span class="p">,</span> <span class="s">"hostname"</span><span class="p">,</span> <span class="s">"thread"</span><span class="p">,</span> <span class="s">"level"</span><span class="p">,</span> <span class="s">"logger"</span><span class="p">,</span> <span class="s">"file"</span><span class="p">,</span> <span class="s">"line"</span><span class="p">,</span> <span class="s">"serviceName"</span><span class="p">,</span> <span class="s">"traceId"</span><span class="p">,</span> <span class="s">"feTraceId"</span><span class="p">,</span> <span class="s">"msg"</span><span class="p">,</span> <span class="s">"exception"</span><span class="p">},</span>
		<span class="n">log</span><span class="o">:</span>    <span class="n">logp</span><span class="o">.</span><span class="n">NewLogger</span><span class="p">(</span><span class="n">logName</span><span class="p">),</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="c">// çœŸæ­£çš„æ—¥å¿—å¤„ç†é€»è¾‘</span>
<span class="c">// ä¸ºäº†ä¿è¯åé¢çš„ processor æ­£å¸¸å¤„ç†ï¼Œè¿™é‡Œé¢æ²¡æœ‰ return ä»»ä½• errorï¼Œåªæ˜¯ç®€å•çš„æ‰“å°</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">cdm</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">event</span> <span class="o">*</span><span class="n">beat</span><span class="o">.</span><span class="n">Event</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">beat</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="c">// å°è¯•è·å– messageï¼Œç†è®ºä¸Šè¿™ä¸€æ­¥ä¸åº”è¯¥å‡ºç°é—®é¢˜</span>
	<span class="n">msg</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="s">"message"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="no">nil</span>
	<span class="p">}</span>

	<span class="n">message</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">msg</span><span class="o">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span>
	<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">"failed to parse message"</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="no">nil</span>
	<span class="p">}</span>

	<span class="c">// åˆ†å‰²æ—¥å¿—</span>
	<span class="n">fieldsValue</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Split</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">"$$"</span><span class="p">)</span>
	<span class="n">p</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Debugf</span><span class="p">(</span><span class="s">"message fields: %v"</span><span class="p">,</span> <span class="n">fieldsVaule</span><span class="p">)</span>
	<span class="c">// ä¸ºäº†ä¿è¯ä¸ä¼šå‡ºç°æ•°ç»„è¶Šç•Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹(ä¸‡ä¸€å¼„å‡ºä¸ªæ ¼å¼ä¸æ­£å¸¸çš„æ—¥å¿—è¿‡æ¥ä¿è¯ä¸å´©)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldsValue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"incorrect field length: %d, expected length: %d"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldsValue</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">fields</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="no">nil</span>
	<span class="p">}</span>

	<span class="c">// è¿™é‡Œéå†ç„¶åèµ›ä¼šåˆ° event æ—¢å¯</span>
	<span class="n">data</span> <span class="o">:=</span> <span class="n">common</span><span class="o">.</span><span class="n">MapStr</span><span class="p">{}</span>
	<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">p</span><span class="o">.</span><span class="n">fields</span> <span class="p">{</span>
		<span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">PutValue</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">strings</span><span class="o">.</span><span class="n">TrimSpace</span><span class="p">(</span><span class="n">fieldsValue</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
	<span class="p">}</span>
	<span class="n">event</span><span class="o">.</span><span class="n">Fields</span><span class="o">.</span><span class="n">DeepUpdate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

	<span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">cdm</span><span class="p">)</span> <span class="n">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">processorName</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å†™å¥½ä»£ç ä»¥åå°±å¯ä»¥ç¼–è¯‘ä¸€ä¸ªè‡ªå·±çš„ filebeat äº†(å¼€å¿ƒing)</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>filebeat
<span class="c"># å¦‚æœæƒ³äº¤å‰ç¼–è¯‘ linux éœ€è¦å¢åŠ  GOOS=linux å˜é‡ </span>
<span class="nv">GO111MODULE</span><span class="o">=</span>off make
</code></pre></div></div>

<p>ç„¶åç¼–å†™é…ç½®æ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼Œæ—¥å¿—ç›¸å…³å­—æ®µå·²ç»æˆåŠŸå¡åˆ°äº† event ä¸­ï¼Œè¿™æ ·æˆ‘ç›´æ¥å‘åˆ° es æˆ–è€… logstash å°±è¡Œäº†ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">filebeat.inputs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">log</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/Users/natural/tmp/cdm.log</span>
  <span class="na">processors</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">cdm</span><span class="pi">:</span> <span class="s">~</span>
  <span class="s">multiline.pattern</span><span class="pi">:</span> <span class="s">^\d{4}-\d{1,2}-\d{1,2}</span>
  <span class="s">multiline.match</span><span class="pi">:</span> <span class="s">after</span>
  <span class="s">multiline.negate</span><span class="pi">:</span> <span class="no">true</span>
  <span class="s">multiline.timeout</span><span class="pi">:</span> <span class="s">5s</span>
</code></pre></div></div>

<h2 id="äº”script-processor">äº”ã€script processor</h2>

<p>åœ¨æˆ‘æŠ˜è…¾å®Œæºç ä»¥åï¼Œåæ€ä¸€ä¸‹å…¶å®è¿™ç§æ–¹å¼éœ€è¦è‡ªå·±ç¼–è¯‘ filebeatï¼Œè€Œä¸”æ¯æ¬¡è§„åˆ™ä¿®æ”¹ä¹Ÿå¾ˆä¸æ–¹ä¾¿ï¼Œå”¯ä¸€çš„å¥½å¤„çœŸçš„å°±æ˜¯ç”¨ä»£ç å¯ä»¥ â€œä¸ºæ‰€æ¬²ä¸ºâ€ï¼›åè¿‡æ¥ä¸€æƒ³ â€œfilebeat æœ‰æ²¡æœ‰ processor çš„æ‰©å±•å‘¢ï¼Ÿè„šæœ¬çƒ­åŠ è½½é‚£ç§ï¼Ÿâ€ ç­”æ¡ˆæ˜¯ä½¿ç”¨ script processorï¼Œ<strong>script processor è™½ç„¶åå­—ä¸Šæ˜¯ä¸ª processorï¼Œå®é™…ä¸Šå…¶åŒ…å«äº†å®Œæ•´çš„ ECMA 5.1 js è§„èŒƒå®ç°ï¼›ç»“è®ºå°±æ˜¯æˆ‘ä»¬å¯ä»¥å†™ä¸€äº› js è„šæœ¬æ¥å¤„ç†æ—¥å¿—ï¼Œç„¶å filebeat æ¯æ¬¡å¯åŠ¨ååŠ è½½è¿™äº›è„šæœ¬æ—¢å¯ã€‚</strong></p>

<p>script processor çš„ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œjs æ–‡ä»¶ä¸­åªéœ€è¦åŒ…å«ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">function process(event)</code> æ–¹æ³•æ—¢å¯ï¼Œä¸è‡ªå·±ç”¨ go å®ç°çš„ processor ç±»ä¼¼ï¼Œæ¯è¡Œæ—¥å¿—ä¹Ÿä¼šå½¢æˆä¸€ä¸ª event å¯¹è±¡ç„¶åè°ƒç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œå¤„ç†ï¼›ç›®å‰ event å¯¹è±¡å¯ç”¨çš„ api éœ€è¦å‚è€ƒ<a href="https://www.elastic.co/guide/en/beats/filebeat/current/processor-script.html#_event_api">å®˜æ–¹æ–‡æ¡£</a>ï¼›<strong>éœ€è¦æ³¨æ„çš„æ˜¯ script processor ç›®å‰åªæ”¯æŒ ECMA 5.1 è¯­æ³•è§„èŒƒï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´çš„è¯­æ³•æ˜¯ä¸è¢«æ”¯æŒï¼›</strong>å®é™…ä¸Šå…¶æ ¹æœ¬æ˜¯å€ŸåŠ©äº† <a href="https://github.com/dop251/goja">https://github.com/dop251/goja</a> è¿™ä¸ªåº“æ¥å®ç°çš„ã€‚åŒæ—¶ä¸ºäº†æ–¹ä¾¿å¼€å‘è°ƒè¯•ï¼Œscript processor ä¹Ÿå¢åŠ äº†ä¸€äº› nodejs çš„å…¼å®¹ moduleï¼Œæ¯”å¦‚ <code class="language-plaintext highlighter-rouge">console.log</code> ç­‰æ–¹æ³•æ˜¯å¯ç”¨çš„ï¼›ä»¥ä¸‹ä¸º js å¤„ç†ä¸Šé¢æ—¥å¿—çš„é€»è¾‘:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">console</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">console</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fileds</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="dl">"</span><span class="s2">timestamp</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">hostname</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">thread</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">level</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">logger</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">file</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">line</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">serviceName</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">traceId</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">feTraceId</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">exception</span><span class="dl">"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">process</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">message</span> <span class="o">==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">message</span> <span class="o">==</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">failed to get message</span><span class="dl">"</span><span class="p">);</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">fieldValues</span> <span class="o">=</span> <span class="nx">message</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="dl">"</span><span class="s2">$$</span><span class="dl">"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fieldValues</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="nx">fileds</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">incorrect field length</span><span class="dl">"</span><span class="p">);</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">fileds</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="nx">fileds</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">fieldValues</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">trim</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å†™å¥½è„šæœ¬åè°ƒæ•´é…ç½®æµ‹è¯•æ—¢å¯ï¼Œå¦‚æœ js ç¼–å†™æœ‰é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ <code class="language-plaintext highlighter-rouge">console.log</code> æ¥æ‰“å°æ—¥å¿—è¿›è¡Œä¸æ–­çš„è°ƒè¯•</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">filebeat.inputs</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">type</span><span class="pi">:</span> <span class="s">log</span>
  <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/Users/natural/tmp/cdm.log</span>
  <span class="na">processors</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">script</span><span class="pi">:</span>
        <span class="na">lang</span><span class="pi">:</span> <span class="s">js</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">cdm</span>
        <span class="na">file</span><span class="pi">:</span> <span class="s">cdm.js</span>
  <span class="s">multiline.pattern</span><span class="pi">:</span> <span class="s">^\d{4}-\d{1,2}-\d{1,2}</span>
  <span class="s">multiline.match</span><span class="pi">:</span> <span class="s">after</span>
  <span class="s">multiline.negate</span><span class="pi">:</span> <span class="no">true</span>
  <span class="s">multiline.timeout</span><span class="pi">:</span> <span class="s">5s</span>
</code></pre></div></div>

<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ç›®å‰ <code class="language-plaintext highlighter-rouge">lang</code> çš„å€¼åªèƒ½ä¸º <code class="language-plaintext highlighter-rouge">javascript</code> å’Œ <code class="language-plaintext highlighter-rouge">js</code>(å®˜æ–¹æ–‡æ¡£å†™çš„åªèƒ½æ˜¯ <code class="language-plaintext highlighter-rouge">javascript</code>)ï¼›æ ¹æ®ä»£ç æ¥çœ‹åç»­ script processor æœ‰å¯èƒ½æ”¯æŒå…¶ä»–è„šæœ¬è¯­è¨€ï¼Œä¸ªäººè®¤ä¸ºä¸»è¦å–å†³äºå…¶ä»–è„šæœ¬è¯­è¨€æœ‰æ²¡æœ‰çº¯ go å®ç°çš„ runtimeï¼Œå¦‚æœæœ‰çš„è¯æœªæ¥å¾ˆæœ‰å¯èƒ½è¢«æ•´åˆåˆ° script processor ä¸­ã€‚</strong></p>

<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gegg80j1gmj31nc0u0wpa.jpg" alt="script processor" /></p>

<h2 id="å…­å…¶ä»–-processor">å…­ã€å…¶ä»– processor</h2>

<p>ç ”ç©¶å®Œ script processor åæˆ‘é¡¿æ—¶å¯¹å…¶ä»– processor ä¹Ÿäº§ç”Ÿäº†å…´è¶£ï¼Œéšç€æ›´å¤šçš„æŸ¥çœ‹processor æ–‡æ¡£ï¼Œæˆ‘å‘ç°å…¶å®å¤§éƒ¨ä»½è¿‡æ»¤åˆ†å‰²èƒ½åŠ›å·²ç»æœ‰å¾ˆå¤š processor è¿›è¡Œäº†å®ç°ï¼Œ<strong>å…¶å®Œå–„ç¨‹åº¦å¤–åŠ å¯æ‰©å±•çš„ script processor å®é™…èƒ½åŠ›å·²ç»è¶³çŸ£æ›¿æ¢æ‰ logstash çš„æ—¥å¿—åˆ†å‰²è¿‡æ»¤å¤„ç†äº†ã€‚</strong>æ¯”å¦‚ä¸Šé¢çš„æ—¥å¿—åˆ‡å‰²å…¶å®ä½¿ç”¨ dissect processor å®ç°æ›´åŠ ç®€å•(è¿™ä¸ªé…ç½®å¹¶ä¸å®Œå–„ï¼Œåªæ˜¯æ ·ä¾‹):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">processors</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">dissect</span><span class="pi">:</span>
        <span class="na">field</span><span class="pi">:</span> <span class="s2">"</span><span class="s">message"</span>
        <span class="na">tokenizer</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%{timestamp}$$%{hostname}$$%{thread}$$%{level}$$%{logger}$$%{file}$$%{line}$$%{serviceName}$$%{traceId}$$%{feTraceId}$$%{msg}$$%{exception}$$"</span>
</code></pre></div></div>

<p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤š processorï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">drop_event</code>ã€<code class="language-plaintext highlighter-rouge">drop_fields</code>ã€<code class="language-plaintext highlighter-rouge">timestamp</code> ç­‰ç­‰ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚</p>

<h2 id="ä¸ƒæ€»ç»“">ä¸ƒã€æ€»ç»“</h2>

<p>åŸºæœ¬ä¸ŠæŠ˜è…¾å®Œä»¥ååšäº†ä¸€ä¸ªæ€»ç»“:</p>

<ul>
  <li><strong>filebeat module</strong>: è¿™å°±æ˜¯ä¸ªåè€Œä¸å®çš„ä¸œè¥¿ï¼Œæ¯æ¬¡ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘ä¸”æ‰©å±•èƒ½åŠ›å‡ è¿‘äºé›¶ï¼Œæœ€è›‹ç–¼çš„æ˜¯å®é™…é€»è¾‘é€šè¿‡ es æ¥å®Œæˆï¼›æˆ‘èƒ½æƒ³åˆ°çš„æ˜¯å”¯ä¸€åº”ç”¨åœºæ™¯å°±æ˜¯å®˜æ–¹ç»™æˆ‘ä»¬å¼„ä¸€äº› demo æ¥ç‚«è€€ç”¨çš„ï¼Œæ¯”å¦‚ nginx moduleï¼›å®é™…ç”Ÿäº§ä¸­ nginx æ—¥å¿—æ ¼å¼ä¿æŒåŸå°ä¸åŠ¨çš„äººæˆ‘ç›¸ä¿¡å°‘ä¹‹åˆå°‘ã€‚</li>
  <li><strong>filebeat custom processor</strong>: æ¯æ¬¡ä¿®æ”¹ä¹Ÿéœ€è¦é‡æ–°ç¼–è¯‘ä¸”éœ€è¦ä¼š go è¯­è¨€è¿˜æœ‰ç›¸å…³å·¥å…·é“¾ï¼Œä½†æ˜¯å¥½å¤„å°±æ˜¯å®Œå…¨é€šè¿‡ä»£ç å®ç°çœŸæ­£çš„ä¸ºæ‰€æ¬²ä¸ºï¼›æ‰©å±•æ€§å–å†³äºå¤–éƒ¨æ˜¯å¦å¯¹ç‰¹å®šä½ç½®åšäº†å¯é…ç½®åŒ–ï¼Œæ¯”å¦‚é¢„ç•™å¯ä»¥é…ç½®åˆ‡å‰²ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„å˜é‡ç­‰ï¼Œæœ€ç»ˆå–å†³äºä»£ç ç¼–å†™è€…(æ€ä¹ˆä¸ºæ‰€æ¬²ä¸ºçš„é—®é¢˜)ã€‚</li>
  <li><strong>filebeat script processor</strong>: å®Œæ•´ ECMA 5.1 js è§„èŒƒæ”¯æŒï¼Œä»£ç åŒ–å¯¹æ—¥å¿—è¿›è¡Œä¸ºæ‰€æ¬²ä¸ºï¼Œä¿®æ”¹ä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼›æ™®é€šç”¨æˆ·æˆ‘ä¸ªäººè§‰å¾—æ˜¯é¦–é€‰ï¼Œå½“ç„¶åŒæ—¶ä¼šå†™ go å’Œ js çš„å°±çœ‹ä½ æƒ³ç”¨å“ªä¸ªäº†ã€‚</li>
  <li><strong>filebeat other processor</strong>: åŸºæœ¬ä¸Šå®ç°äº†å¾ˆå¤š logstash çš„åŠŸèƒ½ï¼Œç®€å•ç”¨ç”¨å¾ˆèˆ’æœï¼Œå¤æ‚åœºæ™¯è¿˜æ˜¯å¾—æ’¸ä»£ç ï¼›ä½†æ˜¯ä¸€äº›ç‰¹å®šçš„ processor å¾ˆå®ç”¨ï¼Œæ¯”å¦‚åŠ å…¥å®¿ä¸»æœºä¿¡æ¯çš„ add_host_metadata processor ç­‰ã€‚</li>
</ul>

<p>è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">CC4.0</a> åè®®æˆæƒ</p>


                <hr style="visibility: hidden;">

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2020/03/31/how-to-download-docker-image-without-docker/" data-toggle="tooltip" data-placement="top" title="å¦‚ä½•ä¸é€šè¿‡ docker ä¸‹è½½ docker image">
                        Previous<br>
                        <span>å¦‚ä½•ä¸é€šè¿‡ docker ä¸‹è½½ docker image</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2020/06/28/make-a-custom-manjaro-image-for-rpi4/" data-toggle="tooltip" data-placement="top" title="æ ‘è“æ´¾4 Manjaro ç³»ç»Ÿå®šåˆ¶">
                        Next<br>
                        <span>æ ‘è“æ´¾4 Manjaro ç³»ç»Ÿå®šåˆ¶</span>
                        </a>
                    </li>
                    
                </ul>


                
                <!-- disqus è¯„è®ºæ¡† start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus è¯„è®ºæ¡† end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                        
                            
                                <a href="/tags/#Linux" title="Linux" rel="84">
                                    Linux
                                </a>
                            
                        
                            
                                <a href="/tags/#SQL" title="SQL" rel="4">
                                    SQL
                                </a>
                            
                        
                            
                                <a href="/tags/#Java" title="Java" rel="25">
                                    Java
                                </a>
                            
                        
                            
                                <a href="/tags/#éšç¬”" title="éšç¬”" rel="9">
                                    éšç¬”
                                </a>
                            
                        
                            
                                <a href="/tags/#GitHub" title="GitHub" rel="3">
                                    GitHub
                                </a>
                            
                        
                            
                                <a href="/tags/#Docker" title="Docker" rel="44">
                                    Docker
                                </a>
                            
                        
                            
                                <a href="/tags/#Kubernetes" title="Kubernetes" rel="45">
                                    Kubernetes
                                </a>
                            
                        
                            
                                <a href="/tags/#CI/CD" title="CI/CD" rel="4">
                                    CI/CD
                                </a>
                            
                        
                            
                                <a href="/tags/#Golang" title="Golang" rel="7">
                                    Golang
                                </a>
                            
                        
                            
                                <a href="/tags/#Mac" title="Mac" rel="1">
                                    Mac
                                </a>
                            
                        
                            
                                <a href="/tags/#Podman" title="Podman" rel="1">
                                    Podman
                                </a>
                            
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://mdba.cn">DBAçš„ç½—æµ®å®«</a></li>
                    
                        <li><a href="http://www.xieyuxuan.cc">è°¢é›¨è½©</a></li>
                    
                        <li><a href="https://ehlxr.me">Ehlxr's Blog</a></li>
                    
                        <li><a href="http://www.dearzd.com/DBlog">å’šé—¨</a></li>
                    
                        <li><a href="http://log.zvz.im">Z</a></li>
                    
                        <li><a href="https://www.4spaces.org">å®¹ä¼‘åšå®¢</a></li>
                    
                        <li><a href="http://www.webank.pw">å¹½é¸¿å±…</a></li>
                    
                        <li><a href="http://ephen.me">Ephen's Blog</a></li>
                    
                        <li><a href="https://www.maoxuner.cn">äºŒæ¬¡å…ƒã®æŠ€æœ¯å®…</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "mritd";
    var disqus_identifier = "/2020/06/28/how-to-modify-filebeat-source-code-to-processing-logs";
    var disqus_url = "https://mritd.me/2020/06/28/how-to-modify-filebeat-source-code-to-processing-logs/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus å…¬å…±JSä»£ç  end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/mritd1234">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    
                    
                    
                    <li>
                        <a target="_blank" href="https://t.me/mritd">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-telegram fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/mritd">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; æ¼ ç„¶ 2020
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/mritd-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-82387173-1';
    var _gaDomain = 'mritd.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {

        // interop with multilangual 
        if (false) {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/avatar.jpg" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
