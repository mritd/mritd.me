---
layout: post
categories: Kubernetes
title: ç¼–å†™ kubectl æ’ä»¶
date: 2018-08-09 22:19:35 +0800
description: ä¸º kubectl ç¼–å†™ä¸€ä¸ªæ’ä»¶
keywords: kubectl,plugin,æ’ä»¶
catalog: true
multilingual: false
tags: Kubernetes
---

> æœ€è¿‘å¿™çš„æ™•å¤´è½¬å‘ï¼Œåšå®¢åœæ›´äº† 1 ä¸ªæœˆï¼Œæ„Ÿè§‰å¯¹ä¸èµ·å…šã€å¯¹ä¸èµ·äººæ°‘ã€å¯¹ä¸èµ· ~~CCAV~~...ä¸è¿‡åœ¨å¿™çš„æ—¶å€™æ“ä½œ Kubernetes é›†ç¾¤è¦é¢‘ç¹çš„ä½¿ç”¨ `kubectl` å‘½ä»¤ï¼Œè€Œåœ¨å¤šä¸ª NameSpace ä¸‹æ¥å›åˆ‡æ¢æ¯æ¬¡éƒ½å¾—åŠ ä¸ª `-n` ç®€ç›´è®©æˆ‘æƒ³æ‰“äººï¼›ç´¢æ€§ç¿»äº†ä¸‹ `kubectl` çš„æ’ä»¶æœºåˆ¶ï¼Œé¡ºä¾¿å†™äº†ä¸€ä¸ªå¿«é€Ÿåˆ‡æ¢ NameSpace çš„å°æ’ä»¶ï¼Œä»¥ä¸‹è®°å½•ä¸€ä¸‹æ’ä»¶ç¼–å†™è¿‡ç¨‹

## ä¸€ã€æ’ä»¶ä»‹ç»

`kubectl` å‘½ä»¤ä» `v1.8.0` ç‰ˆæœ¬å¼€å§‹å¼•å…¥äº† alpha feature çš„æ’ä»¶æœºåˆ¶ï¼›åœ¨æ­¤æœºåˆ¶ä¸‹æˆ‘ä»¬å¯ä»¥å¯¹ `kubectl` å‘½ä»¤è¿›è¡Œæ‰©å±•ï¼Œä»è€Œç¼–å†™ä¸€äº›è‡ªå·±çš„æ’ä»¶é›†æˆè¿› `kubectl` å‘½ä»¤ä¸­ï¼›**`kubectl` æ’ä»¶æœºåˆ¶æ˜¯ä¸è¯­è¨€æ— å…³çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ å¯ä»¥ç”¨ä»»ä½•è¯­è¨€ç¼–å†™æ’ä»¶ï¼Œå¯ä»¥æ˜¯ `bash`ã€`python` è„šæœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯ `go`ã€`java` ç­‰ç¼–è¯‘å‹è¯­è¨€ï¼›æ‰€ä»¥é€‰æ‹©ä½ ç†Ÿæ‚‰çš„è¯­è¨€å³å¯**ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç”¨ `go` ç¼–å†™çš„ç”¨äºå¿«é€Ÿåˆ‡æ¢ NameSpace çš„å°æ’ä»¶ï¼Œè¿è¡Œæˆªå›¾å¦‚ä¸‹:

**æ‰€è°“: å¼€å±€ä¸€å¼ å›¾ï¼ŒåŠŸèƒ½å…¨é ç¼– ğŸ˜‚**
![swns.gif](https://mritd.b0.upaiyun.com/markdown/6t89g.gif)

å½“å‰æ’ä»¶ä»£ç æ”¾åœ¨ [mritd/swns](https://github.com/mritd/swns) è¿™ä¸ªé¡¹ç›®ä¸‹é¢

## äºŒã€æ’ä»¶åŠ è½½

`kubectl` æ’ä»¶æœºåˆ¶ç›®å‰å¹¶ä¸æä¾›åŒ…ç®¡ç†å™¨ä¸€æ ·çš„åŠŸèƒ½ï¼Œæ¯”å¦‚ä½ æƒ³æ‰§è¡Œ `kuebctl plugin install xxx` è¿™ç§æ“ä½œç›®å‰è¿˜æ²¡æœ‰å®ç°(ä¸ªäººæ„Ÿè§‰å·®ä¸ªè§„èŒƒ)ï¼›æ‰€ä»¥ä¸€æ—¦æˆ‘ä»¬ç¼–å†™æˆ–è€…ä¸‹è½½ä¸€ä¸ªæ’ä»¶åï¼Œæˆ‘ä»¬åªæœ‰æ­£ç¡®æ”¾åœ¨ç‰¹å®šç›®å½•æ‰ä¼šç”Ÿæ•ˆï¼›

**ç›®å‰æ’ä»¶æ ¹æ®æ–‡æ¡£æè¿°åªæœ‰ä¸¤éƒ¨åˆ†å†…å®¹: `plugin.yaml` å’Œå…¶ä¾èµ–çš„äºŒè¿›åˆ¶/è„šæœ¬ç­‰å¯æ‰§è¡Œæ–‡ä»¶**ï¼›æ ¹æ®æ–‡æ¡£è¯´æ˜ï¼Œ`kubectl` ä¼šå°è¯•åœ¨å¦‚ä¸‹ä½ç½®æŸ¥æ‰¾å¹¶åŠ è½½æ’ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°† `plugin.yaml` å’Œç›¸å…³äºŒè¿›åˆ¶æ”¾åœ¨åœ¨å¯¹åº”ä½ç½®å³å¯:

- `${KUBECTL_PLUGINS_PATH}`: å¦‚æœè¿™ä¸ªç¯å¢ƒå˜é‡å®šä¹‰äº†ï¼Œé‚£ä¹ˆ `kubectl` **åªä¼š**ä»è¿™é‡ŒæŸ¥æ‰¾ï¼›**æ³¨æ„: è¿™ä¸ªå˜é‡å¯ä»¥æ˜¯å¤šä¸ªç›®å½•ï¼Œç±»ä¼¼ PATH å˜é‡ä¸€æ ·ï¼Œåšå¥½åˆ†å‰²å³å¯**
- `${XDG_DATA_DIRS}/kubectl/plugins`: å…³äºè¿™ä¸ªå˜é‡å…·ä½“è¯·çœ‹ [XDG System Directory Structure](https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html)ï¼Œæˆ‘äº†è§£ä¹Ÿä¸å¤šï¼›**å¦‚æœè¿™ä¸ªå˜é‡æ²¡å®šä¹‰åˆ™é»˜è®¤ä¸º `/usr/local/share:/usr/share`**
- `~/.kube/plugins`: è¿™ä¸ªæ²¡å•¥å¯è¯´çš„ï¼Œæˆ‘æ¨èè¿˜æ˜¯å°†æ’ä»¶æ”¾åœ¨è¿™ä¸ªä½ç½®æ¯”è¾ƒå‹å¥½ä¸€ç‚¹

æ‰€ä»¥æœ€ç»ˆæ’ä»¶ç›®å½•ç»“æ„ç±»ä¼¼è¿™æ ·:

``` sh
âœ  ~ tree .kube
.kube
â”œâ”€â”€ config
â””â”€â”€ plugins
    â””â”€â”€ swns
        â”œâ”€â”€ plugin.yaml
        â””â”€â”€ swns
```

## ä¸‰ã€Plugin.yaml

`plugin.yaml` è¿™ä¸ªæ–‡ä»¶å®é™…ä¸Šæ‰æ˜¯æ’ä»¶çš„æ ¸å¿ƒï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶é‡Œå£°æ˜äº†æ’ä»¶å¦‚ä½•ä½¿ç”¨ã€è°ƒç”¨çš„äºŒè¿›åˆ¶/è„šæœ¬ç­‰é‡è¦é…ç½®ï¼›**ä¸€ä¸ªæ’ä»¶å¯ä»¥æ²¡æœ‰ä»»ä½•è„šæœ¬/äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†è‡³å°‘åº”å½“æœ‰ä¸€ä¸ª `plugin.yaml` æè¿°æ–‡ä»¶**ï¼›ç›®å‰ `plugin.yaml` çš„ç»“æ„å¦‚ä¸‹:

``` yaml
name: "targaryen"                 # å¿…å¡«é¡¹: ç”¨äº kuebctl è°ƒç”¨çš„æ’ä»¶åç§°
shortDesc: "Dragonized plugin"    # å¿…å¡«é¡¹: ç”¨äº help è¯¥æ’ä»¶æ—¶çš„ç®€çŸ­æè¿°
longDesc: ""                      # éå¿…å¡«: æ’ä»¶çš„é•¿æè¿°
example: ""                       # éå¿…å¡«: æ’ä»¶çš„ä½¿ç”¨æ ·ä¾‹
command: "./dracarys"             # å¿…å¡«é¡¹: æ’ä»¶å®é™…æ‰§è¡Œçš„æ–‡ä»¶ä½ç½®ï¼Œå¯ä»¥ç›¸å¯¹è·¯å¾„ or ç»å¯¹è·¯å¾„ï¼Œæˆ–è€…åœ¨ PATH é‡Œä¹Ÿè¡Œ
flags:                            # éå¿…å¡«: æ’ä»¶æ”¯æŒçš„ flag
  - name: "heat"                  # å¿…å¡«é¡¹: å¦‚æœä½ å†™äº†æ”¯æŒçš„ flagï¼Œé‚£ä¹ˆæ­¤é¡¹å¿…å¡«
    shorthand: "h"                # éå¿…å¡«: è¯¥é€‰é¡¹çš„ç¼©çŸ­å½¢å¼
    desc: "Fire heat"             # å¿…å¡«é¡¹: åŒæ ·æ¯ä¸ª flag éƒ½å¿…é¡»ä¹¦å†™æè¿°
    defValue: "extreme"           # éå¿…å¡«: é»˜è®¤å€¼
tree:                             # å…è®¸å®šä¹‰ä¸€äº›å­å‘½ä»¤
  - ...                           # å­å‘½ä»¤æ”¯æŒåŒæ ·çš„è®¾ç½®å±æ€§(æˆ‘æƒ³çŸ¥é“å­å‘½ä»¤çš„å­å‘½ä»¤çš„å­å‘½ä»¤æ”¯ä¸æ”¯æŒ...æˆ‘è¿˜æ²¡å»è¯•è¿‡)
```

## å››ã€æ’ä»¶ç¯å¢ƒå˜é‡

åœ¨ç¼–å†™æ’ä»¶æ—¶ï¼Œ**æœ‰æ—¶æ’ä»¶è¿è¡Œæ—¶éœ€è¦è·å–åˆ°ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚ `kubectl` æ‰§è¡Œæ—¶çš„å…¨å±€ flag ç­‰ï¼Œ**ä¸ºäº†æ–¹ä¾¿æ’ä»¶å¼€å‘è€…ï¼Œ`kuebctl` çš„æ’ä»¶æœºåˆ¶æä¾›ä¸€äº›é¢„ç½®çš„ç¯å¢ƒå˜é‡æ–¹ä¾¿æˆ‘ä»¬è¯»å–ï¼›å³å¦‚æœä½ ç”¨ `bash` å†™æ’ä»¶ï¼Œé‚£ä¹ˆè¿™äº›å˜é‡ä½ åªéœ€è¦ `${xxxx}` å³å¯æ‹¿åˆ°ï¼Œç„¶ååšä¸€äº›ä½ æƒ³åšçš„äº‹æƒ…ï¼›è¿™äº›å˜é‡ç›®å‰æ”¯æŒå¦‚ä¸‹:

- `KUBECTL_PLUGINS_CALLER`: `kubectl` äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨ä½ç½®ï¼›**ä½œä¸ºæ’ä»¶ç¼–å†™è€…ï¼Œæˆ‘ä»¬æ— éœ€å…³ç³» api server æ˜¯å¦èƒ½è”é€šï¼Œå› ä¸ºé…ç½®æ˜¯å¦æ­£ç¡®åº”å½“ç”±ä½¿ç”¨è€…å†³å®šï¼›åœ¨éœ€è¦æ—¶æˆ‘ä»¬åªéœ€è¦ç›´æ¥è°ƒç”¨ `kubectl` å³å¯ï¼›**æ¯”å¦‚åœ¨ `bash` è„šæœ¬ä¸­æ‰§è¡Œ `get pod` ç­‰
- `KUBECTL_PLUGINS_CURRENT_NAMESPACE`: å½“å‰ `kuebctl` å‘½ä»¤æ‰€å¯¹åº”çš„ NameSpaceï¼Œ**æ’ä»¶æœºåˆ¶ç¡®ä¿äº†è¯¥å€¼ä¸€å®šæ­£ç¡®ï¼›å³è¿™æ˜¯ç»è¿‡è§£æäº† `--namespace` é€‰é¡¹æˆ–è€… `kubeconfig` é…ç½®åçš„æœ€ç»ˆç»“æœï¼›ä½œä¸ºæ’ä»¶ç¼–å†™è€…ï¼Œæˆ‘ä»¬æ— éœ€å…³å¿ƒå¤„ç†è¿‡ç¨‹**ï¼›æƒ³è¯¦ç»†äº†è§£çš„çš„å¯ä»¥å»çœ‹æºç ï¼Œä»¥åŠ `Cobra` åº“(Kubernetes ç”¨è¿™ä¸ªåº“è§£æå‘½ä»¤è¡Œå‚æ•°å’Œé…ç½®)
- `KUBECTL_PLUGINS_DESCRIPTOR_*`: æ’ä»¶è‡ªå·±æœ¬èº«ä½äº `plugin.yaml` ä¸­çš„æè¿°ä¿¡æ¯ï¼Œæ¯”å¦‚ `KUBECTL_PLUGINS_DESCRIPTOR_NAME` è¾“å‡º `plugin.yaml` ä¸‹çš„ `name` å±æ€§ï¼›ä¸€èˆ¬å¯ä»¥ç”¨ä½œæ’ä»¶è¾“å‡ºè‡ªå·±çš„å¸®åŠ©æ–‡æ¡£ç­‰
- `KUBECTL_PLUGINS_GLOBAL_FLAG_*`: è·å– `kubectl` æ‰€æœ‰å…¨å±€ flag å€¼çš„å˜é‡ï¼Œæ¯”å¦‚ `KUBECTL_PLUGINS_GLOBAL_FLAG_NAMESPACE` èƒ½æ‹¿åˆ° `--namespace` é€‰é¡¹çš„å€¼
- `KUBECTL_PLUGINS_LOCAL_FLAG_*`: åŒä¸Šé¢ç±»ä¼¼ï¼Œåªä¸è¿‡è¿™ä¸ªæ˜¯è·å–æ’ä»¶è‡ªå·±æœ¬èº« flag çš„å€¼ï¼Œä¸ªäººè®¤ä¸ºåœ¨è„šæœ¬è¯­è¨€ä¸­ï¼Œæ¯”å¦‚ `bash` ç­‰å¤„ç†é€‰é¡¹ä¸æ€ä¹ˆå¥½ç”¨æ—¶ï¼Œå¯ä»¥è€ƒè™‘ç›´æ¥ä»å˜é‡æ‹¿

ä»¥ä¸Šå˜é‡æˆ‘å¹¶æœªéƒ½æµ‹è¯•ï¼Œå…·ä½“ä»¥æµ‹è¯•ä¸ºå‡†ï¼Œ**åˆ åº“è·‘è·¯ç­‰æƒ…å†µæœ¬äººæ¦‚ä¸è´Ÿè´£**

## äº”ã€å†™ä¸€ä¸ªåˆ‡æ¢ NameSpace çš„æ’ä»¶

å‰é¢å¢¨è¿¹ä¸€å¤§å †åªæ˜¯ä¸ºäº†æè¿°æ¸…æ¥š **è¦å†™ä¸€ä¸ªæ’ä»¶åº”è¯¥æ€ä¹ˆå¹²** çš„é—®é¢˜ï¼Œä¸‹é¢å¼€å§‹ **è¿™ä¹ˆå¹²**

### 5.1ã€ç¼–å†™é…ç½®

ä¸Šé¢å·²ç»ä»‹ç»å¥½äº† `plugin.yaml` æ€ä¹ˆå†™ï¼Œé‚£ä¹ˆæ ¹æ®æˆ‘è‡ªå·±çš„éœ€æ±‚ï¼Œæˆ‘å†™çš„è¿™ä¸ªåˆ‡æ¢ NameSpace æ’ä»¶çš„åå­—æš‚ä¸”å«åš `swns`ï¼›æˆ‘å¸Œæœ› `swns` æ‰§è¡Œåæ¥å—ä¸€ä¸ª NameSpace çš„å­—ç¬¦ä¸²ï¼Œç„¶åè°ƒç”¨ `kuebctl config` å»è®¾ç½®å½“å‰é»˜è®¤çš„ NameSpaceï¼Œè¿™æ ·åœ¨åç»­å‘½ä»¤ä¸­æˆ‘å°±ä¸ç”¨å†ä¸€ç›´åŠ ä¸ª `-n xxx` å‚æ•°äº†ï¼›åŒæ—¶æˆ‘å¸Œæœ›ä½¿ç”¨æ›´æ–¹ä¾¿ç‚¹ï¼Œå½“æ‰§è¡Œ `swns` å‘½ä»¤æ—¶ï¼Œå¦‚æœä¸æä¾› NameSpace çš„å­—ç¬¦ä¸²ï¼Œé‚£æˆ‘å°±å¼¹å‡ºä¸‹æ‹‰åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©ï¼›ç»¼ä¸Šéœ€æ±‚è‡ªå·±æƒ³æ˜ç™½åï¼Œå°±å†™ä¸€ä¸ª `plugin.yaml`ï¼Œå¦‚ä¸‹:

``` yaml
name: "swns"
shortDesc: "Switch NameSpace"
longDesc: "Switch Kubernetes current context namespace."
example: "kubectl plugin swns [NAMESPACE]"
command: "./swns"
```

### 5.2ã€ç¼–å†™æ’ä»¶

ä¸Šé¢ `plugin.yaml` å·²ç»å®šä¹‰å¥½äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±ç®€å•äº†ï¼Œæ’¸ä»£ç å®ç°äº†å°±å¥½ï¼›ä»£ç å¦‚ä¸‹:

``` go
// æ³¨æ„: ä¸‹é¢çš„æ¨¡æ¿è¯­æ³•å¤§æ‹¬å·ä¸­é—´æ²¡æœ‰ç©ºæ ¼ï¼Œæ­¤å¤„ç©ºæ ¼æ˜¯ä¸ºäº†é˜²æ­¢åšå®¢æ¸²æŸ“å‡ºé”™

package main

import (
	"fmt"
	"os"
	"os/exec"
	"strings"

	"github.com/mritd/promptx"
)

func main() {

	// å…ˆæ‹¿åˆ°å½“å‰çš„ context
	cmd := exec.Command("kubectl", "config", "current-context")
	cmd.Stdin = os.Stdin
	cmd.Stderr = os.Stderr

	b, err := cmd.Output()
	checkAndExit(err)
	currentContext := strings.TrimSpace(string(b))

	// å¦‚æœæä¾›äº† NameSpace å­—ç¬¦ä¸²ï¼Œæˆ‘ç›´æ¥æ”¹å°±è¡Œäº†
	if len(os.Args) > 1 {
		cmd = exec.Command("kubectl", "config", "set-context", currentContext, "--namespace="+os.Args[1])
		cmd.Stdout = os.Stdout
		checkAndExit(cmd.Run())
		fmt.Printf("Kubernetes namespace switch to %s.\n", os.Args[1])
	} else {
		// æ²¡æä¾›æˆ‘å°±å¾—å…ˆæŠŠæ‰€æœ‰çš„ NameSpace å¼„å‡ºæ¥
		cmd = exec.Command("kubectl", "get", "ns", "-o", "template", "--template", "{ { range .items } }{ { .metadata.name } } { { end } }")
		b, err = cmd.Output()
		checkAndExit(err)
		allNameSpace := strings.Fields(string(b))

		// å¼„åˆ°æ‰€æœ‰çš„ NameSpace åï¼Œæˆ‘åœ¨å¼„ä¸€ä¸ªä¸‹æ‹‰åˆ—è¡¨(è¿™æ˜¯æˆ‘è‡ªå·±é€ çš„ä¸€ä¸ªä¸‹æ‹‰åˆ—è¡¨åº“)
		cfg := &promptx.SelectConfig{
			ActiveTpl:    "Â»  { { . | cyan } }",
			InactiveTpl:  "  { { . | white } }",
			SelectPrompt: "NameSpace",
			SelectedTpl:  "{ { \"Â» \" | green } }{ {\"NameSpace:\" | cyan } } { { . } }",
			DisPlaySize:  9,
			DetailsTpl:   ` `,
		}
		s := &promptx.Select{
			Items:  allNameSpace,
			Config: cfg,
		}

		// ç”¨æˆ·é€‰ä¸­ä¸€ä¸ª NameSpace åæˆ‘å°±æ‹¿åˆ°äº†æƒ³è¦è®¾ç½®çš„ NameSpace å­—ç¬¦ä¸²
		selectNameSpace := allNameSpace[s.Run()]

		// è·Ÿä¸Šé¢å¥—è·¯ä¸€æ ·ï¼Œå†™è¿›å»å°±è¡Œäº†
		cmd = exec.Command("kubectl", "config", "set-context", currentContext, "--namespace="+selectNameSpace)
		cmd.Stdout = os.Stdout
		checkAndExit(cmd.Run())
		fmt.Printf("Kubernetes namespace switch to %s.\n", selectNameSpace)
	}
}

func checkErr(err error) bool {
	if err != nil {
		fmt.Println(err)
		return false
	}
	return true
}

func checkAndExit(err error) {
	if !checkErr(err) {
		os.Exit(1)
	}
}
```

æœ€åç¼–è¯‘åæ”¾åˆ°ä¸Šé¢æ‰€è¯´çš„æ’ä»¶åŠ è½½ç›®å½•å³å¯

åˆ°æ­¤ï¼Œ**"å…¨å±€ä¸€å¼ å›¾ï¼ŒåŠŸèƒ½å…¨é ç¼–"** å›¾ä¸Šé¢ä¹Ÿæœ‰äº†ï¼Œç¼–çš„çš„ä¹Ÿå·®ä¸å¤š ğŸ˜‚

è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ [CC4.0](http://creativecommons.org/licenses/by-nc-nd/4.0/) åè®®æˆæƒ
