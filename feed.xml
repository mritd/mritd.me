<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>æ¼ ç„¶</title>
    <description>Nothing is impossible to a willing heart!</description>
    <link>https://mritd.me/</link>
    <atom:link href="https://mritd.me/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Sun, 28 Jun 2020 22:00:42 +0800</pubDate>
    <lastBuildDate>Sun, 28 Jun 2020 22:00:42 +0800</lastBuildDate>
    <generator>Jekyll v4.1.0</generator>
    
      <item>
        <title>æ ‘è“æ´¾4 Manjaro ç³»ç»Ÿå®šåˆ¶</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;æœ€è¿‘å…¥æ‰‹äº†æ–°ç©å…· â€œå¹ç°æ´¾4â€ï¼Œè¿™ä¸€ä»£æ€§èƒ½æå‡çœŸçš„å¾ˆå¤§ï¼Œæ‰€ä»¥ä¹°å›æ¥æ˜¯çœŸçš„æ²¡åŠæ³• â€œåƒç°â€ äº†ï¼›ä½†æ˜¯ç”±äºç›®å‰ 64bit ç³»ç»Ÿæ¯”è¾ƒéš¾äº§ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±å®šä¹‰ä¸€ä¸‹ Manjaro äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€ç›®å‰çš„ç³»ç»Ÿç°çŠ¶&quot;&gt;ä¸€ã€ç›®å‰çš„ç³»ç»Ÿç°çŠ¶&lt;/h2&gt;

&lt;p&gt;æˆªæ­¢æœ¬æ–‡ç¼–å†™æ—¶é—´ï¼Œæ ‘è“æ´¾4 å®˜æ–¹ç³»ç»Ÿä»ç„¶ä¸æ”¯æŒ 64bitï¼›ä½†æ˜¯å½“æˆ‘åœ¨ 3b+ ä¸Šä½¿ç”¨ arch 64bit ä»¥åæˆ‘å‘ç° 32bit ç³»ç»Ÿå’Œ 64bit ç³»ç»Ÿè£…åœ¨åŒä¸€ä¸ªæ ‘è“æ´¾ä¸Šåœ¨ä½¿ç”¨æ—¶é‚£å°±æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸ä¸€æ ·çš„æ ‘è“æ´¾â€¦æ‰€ä»¥å¯¹äºè¿™ä¸ªæ–°çš„ rpi4 é‚£ä¹ˆå¿…éœ€è¦ç”¨ 64bit çš„ç³»ç»Ÿï¼›è€Œå½“å‰æˆ‘å¤§è‡´æŸ¥çœ‹åˆ°æ”¯æŒ 64bit çš„ç³»ç»Ÿåªæœ‰ Ubuntu20ã€Manjaro ä¸¤ä¸ªï¼ŒUbuntu å¯¹æˆ‘æ¥è¯´å¤ªé‡äº†(è™½ç„¶æœåŠ¡å™¨ä¸Šæˆ‘ä¸€ç›´æ˜¯ Ubuntuï¼Œä½†æ˜¯ rpi ä¸Šæˆ‘é€‰æ‹©è¯´ â€œä¸â€)ï¼ŒManjaro åŸºäº Arch è¿™ç§éå¸¸è½»é‡çš„ç³»ç»Ÿéå¸¸é€‚åˆæ ‘è“æ´¾è¿™ç§å¼€å‘æ¿ï¼Œæ‰€ä»¥æœ€ç»ˆæˆ‘é€‰æ‹©äº† Manjaroã€‚ä½†æ˜¯ä¸‡ä¸‡æ²¡æƒ³åˆ°çš„æ˜¯ Manjaro éƒ½æ˜¯å¸¦ KDE ä»€ä¹ˆçš„å›¾å½¢åŒ–çš„ï¼Œè€Œæˆ‘çš„æ ‘è“æ´¾åªæƒ³ä»åœ¨è§’è½é‡Œè·‘ä¸œè¥¿ï¼Œæ‰€ä»¥è¯´å›¾å½¢åŒ–è¿™ä¸œè¥¿å¯¹æˆ‘æ¥è¯´ä¹Ÿæ²¡å•¥ç”¨ï¼Œæœ€åè¿«äºæ— å¥ˆåªèƒ½è‡ªå·±é€šè¿‡ Manjaro çš„å·¥å…·è‡ªå·±å®šåˆ¶äº†ã€‚&lt;/p&gt;

&lt;h2 id=&quot;äºŒmanjaro-arm-tools&quot;&gt;äºŒã€manjaro-arm-tools&lt;/h2&gt;

&lt;p&gt;ç»è¿‡å‡ ç»æŸ¥æ‰¾å„ç§ Googleï¼Œå‘ç°äº† Manjaro å®˜æ–¹æä¾›äº†è‡ªå®šä¹‰åˆ›å»º arm é•œåƒçš„å·¥å…· &lt;a href=&quot;https://gitlab.manjaro.org/manjaro-arm/applications/manjaro-arm-tools&quot;&gt;manjaro-arm-tools&lt;/a&gt;ï¼Œè¿™ä¸ªå·¥å…·ç®€å•ä½¿ç”¨å¦‚ä¸‹:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;é¦–å…ˆå‡†å¤‡ä¸€ä¸ª Manjaro ç³»ç»Ÿ(è™šæ‹Ÿæœº x86 å³å¯)&lt;/li&gt;
  &lt;li&gt;ç„¶åå®‰è£… manjaro-arm-tool æ‰€éœ€&lt;a href=&quot;https://gitlab.manjaro.org/manjaro-arm/applications/manjaro-arm-tools#dependencies&quot;&gt;ä¾èµ–å·¥å…·&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;æ·»åŠ  Manjaro çš„&lt;a href=&quot;https://gitlab.manjaro.org/manjaro-arm/applications/manjaro-arm-tools#git-version-from-manjaro-strit-repo&quot;&gt;è½¯ä»¶æº&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;å®‰è£… manjaro-arm-tool &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo pacman -Syyu manjaro-strit-keyring &amp;amp;&amp;amp; sudo pacman -S manjaro-arm-tools-git&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å½“å·¥å…·éƒ½å‡†å¤‡å®Œæˆåï¼Œåªéœ€è¦æ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sudo buildarmimg -d rpi4 -e minimal&lt;/code&gt; å³å¯åˆ›å»º manjaro çš„ rpi4 æœ€å°é•œåƒã€‚&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰ç³»ç»Ÿå®šåˆ¶&quot;&gt;ä¸‰ã€ç³»ç»Ÿå®šåˆ¶&lt;/h2&gt;

&lt;p&gt;åœ¨ä½¿ç”¨ manjaro-arm-tool åˆ›å»ºç³»ç»Ÿä»¥åå‘ç°ä¸€äº›ç»†å¾®çš„ä¸œè¥¿éœ€è¦è‡ªå·±è°ƒæ•´ï¼Œæ¯”å¦‚ç½‘ç»œè®¾ç½®å¸¸ç”¨è½¯ä»¶åŒ…ç­‰ï¼Œè€Œ manjaro-arm-tool å·¥å…·åˆæ²¡æœ‰æä¾›å¤ªå¥½çš„è‡ªå®šä¹‰å¤„ç†çš„ä¸€äº› hookï¼Œæ‰€ä»¥æœ€åèŒç”Ÿäº†è‡ªå·±æ ¹æ® manjaro-arm-tool æ¥åˆ›å»ºè‡ªå·±çš„ rpi4 ç³»ç»Ÿå®šåˆ¶å·¥å…·çš„æƒ³æ³•ã€‚&lt;/p&gt;

&lt;h3 id=&quot;31å¸¸ç”¨è½¯ä»¶åŒ…å®‰è£…&quot;&gt;3.1ã€å¸¸ç”¨è½¯ä»¶åŒ…å®‰è£…&lt;/h3&gt;

&lt;p&gt;åœ¨æŸ¥çœ‹äº† manjaro-arm-tool çš„æºç åå¯ä»¥çœ‹åˆ°å®é™…ä¸Šè½¯ä»¶å®‰è£…å°±æ˜¯åˆ©ç”¨ systemd-nspawn è¿›å…¥åˆ° arm ç³»ç»Ÿæ‰§è¡Œ pacman å®‰è£…ï¼Œè‡ªå·±ä¾è‘«èŠ¦ç”»ç“¢å¢åŠ ä¸€äº›å¸¸ç”¨çš„è½¯ä»¶åŒ…å®‰è£…:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemd-nspawn &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--resolv-conf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;copy-host &lt;span class=&quot;nt&quot;&gt;--timezone&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;off &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ROOTFS_DIR&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; pacman &lt;span class=&quot;nt&quot;&gt;-Syyu&lt;/span&gt; zsh htop vim wget which git make net-tools dnsutils inetutils iproute2 sysstat nload lsof &lt;span class=&quot;nt&quot;&gt;--noconfirm&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;32pacman-é•œåƒ&quot;&gt;3.2ã€pacman é•œåƒ&lt;/h3&gt;

&lt;p&gt;åœ¨å®‰è£…è½¯ä»¶åŒ…æ—¶å‘ç°å®‰è£…é€Ÿè¯»å¥‡æ…¢ï¼Œç ”ç©¶ä»¥åå‘ç°æ˜¯æ²¡æœ‰ä½¿ç”¨å›½å†…çš„é•œåƒæºï¼Œæ•…å¢åŠ äº†å›½å†…é•œåƒæºçš„å¤„ç†:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemd-nspawn &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--resolv-conf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;copy-host &lt;span class=&quot;nt&quot;&gt;--timezone&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;off &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ROOTFS_DIR&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; pacman-mirrors &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; China
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;33ç½‘ç»œå¤„ç†&quot;&gt;3.3ã€ç½‘ç»œå¤„ç†&lt;/h3&gt;

&lt;h4 id=&quot;331æœ‰çº¿è¿æ¥&quot;&gt;3.3.1ã€æœ‰çº¿è¿æ¥&lt;/h4&gt;

&lt;p&gt;é»˜è®¤çš„ manjaro-arm-tool åˆ›å»ºçš„ç³»ç»Ÿç½‘ç»œéƒ¨åˆ†é‡‡ç”¨ dhspcd åš dhcp å¤„ç†ï¼Œä½†æ˜¯æˆ‘ä¸ªäººæ„Ÿè§‰ä¸€åˆ‡å°½é‡ç²¾ç®€ç»Ÿä¸€è¿˜æ˜¯æ¯”è¾ƒå¥½çš„ï¼›æ‰€ä»¥å‡†å¤‡ç½‘ç»œéƒ¨åˆ†å®Œå…¨ç”± systemd æ¥ç®¡å¤„ç†ï¼Œå³ç›´æ¥ä½¿ç”¨ systemd-networkd å’Œ systemd-resolvedï¼›systemd-networkd å¤„ç†ç›¸å¯¹ç®€å•ï¼Œç¼–å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ç„¶å enable systemd-networkd æœåŠ¡å³å¯:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;/etc/systemd/network/10-eth-dhcp.network&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Match]
&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;eth&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Network]
&lt;span class=&quot;nv&quot;&gt;DHCP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;yes&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;è®© systemd-networkd å¼€æœºè‡ªå¯åŠ¨&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemd-nspawn &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--resolv-conf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;copy-host &lt;span class=&quot;nt&quot;&gt;--timezone&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;off &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ROOTFS_DIR&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;systemd-networkd.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä¸€å¼€å§‹ä»¥ä¸º systemd-resolved åŒæ · enable ä¸€ä¸‹å°±è¡Œï¼Œåæ¥å‘ç°æ¯æ¬¡å¼€æœºåˆå§‹åŒ–ä»¥å systemd-resolved éƒ½ä¼šè¢«è«æ˜å…¶å¦™çš„ disable æ‰ï¼›ç»è¿‡å‡ ç»å¯»æ‰¾å’Œå¼€ issue é—®ä½œè€…ï¼Œå‘ç°è¿™ä¸ªæ“ä½œæ˜¯è¢« manjaro-arm-oem-install åŒ…ä¸‹çš„è„šæœ¬æ‰§è¡Œçš„ï¼Œä½œè€…çš„å›å¤æ„æ€æ˜¯å¤§éƒ¨åˆ†å¸¦æœ‰å›¾å½¢åŒ–çš„ç‰ˆæœ¬ç½‘ç»œç®¡ç†å·¥å…·éƒ½ä¼šä¸ systemd-resolved å†²çªï¼Œæ‰€ä»¥é»˜è®¤å…³é—­äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦é’ˆå¯¹ manjaro-arm-oem-install å•ç‹¬å¤„ç†ä¸€ä¸‹:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemd-nspawn &lt;span class=&quot;nt&quot;&gt;-q&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--resolv-conf&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;copy-host &lt;span class=&quot;nt&quot;&gt;--timezone&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;off &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ROOTFS_DIR&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;systemd-resolved.service
&lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'s@systemctl disable systemd-resolved.service 1&amp;gt; /dev/null 2&amp;gt;&amp;amp;1@@g'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ROOTFS_DIR&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/usr/share/manjaro-arm-oem-install/manjaro-arm-oem-install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;332æ— é™è¿æ¥&quot;&gt;3.3.2ã€æ— é™è¿æ¥&lt;/h4&gt;

&lt;p&gt;æœ‰çº¿è¿æ¥åªè¦ systemd-networkd å¤„ç†å¥½å°±èƒ½å¾ˆå¥½çš„å·¥ä½œï¼Œè€Œæ— çº¿è¿æ¥ç›®å‰æœ‰å¾ˆå¤šæ–¹æ¡ˆï¼Œæˆ‘ä¸€å¼€å§‹æƒ³ç”¨ &lt;a href=&quot;https://wiki.archlinux.org/index.php/Netctl_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)&quot;&gt;netctl&lt;/a&gt;ï¼Œåæ¥å‘ç°è¿™ä¸œè¥¿è™½ç„¶æ˜¯ Arch äº²å„¿å­ï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿå®šåˆ¶æ—¶é‡‡ç”¨ systemd-nspawn è°ƒç”¨ä¸å…¼å®¹(å› ä¸ºé‡Œé¢è°ƒç”¨äº† systemd çš„ä¸€äº›å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¸€èˆ¬åªæœ‰åœ¨å¼€æœºæ—¶æ‰å¯ç”¨)ï¼Œè€Œä¸”åªç”¨ netctl æ¥ç®¡ç† wifi è¿˜æ„Ÿè§‰æ€ªæ€ªçš„ï¼Œåæ¥æˆ‘çš„æƒ³æ³•æ˜¯è¦ä¹ˆç”¨å°±å…¨éƒ½ç”¨ï¼Œè¦ä¹ˆå°±çº¯æ‰‹åŠ¨ä¸è¦ç”¨è¿™äº›ä¸œè¥¿ï¼Œæ‰€ä»¥æœ€åçš„æ–¹æ¡ˆæ˜¯ wpa_supplicant + systemd-networkd ä¸€æŠŠæ¢­:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;/etc/systemd/network/10-wlan-dhcp.network.example&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# 1. Generate wifi configuration (don't modify the name of wpa_supplicant-wlan0.conf file)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# $ wpa_passphrase MyNetwork SuperSecretPassphrase &amp;gt; /etc/wpa_supplicant/wpa_supplicant-wlan0.conf&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 2. Connect to wifi automatically after booting&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# $ systemctl enable wpa_supplicant@wlan0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# 3.Systemd automatically makes dhcp request&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# $ cp /etc/systemd/network/10-wlan-dhcp.network.example /etc/systemd/network/10-wlan-dhcp.network&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Match]
&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;wlan&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Network]
&lt;span class=&quot;nv&quot;&gt;DHCP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;yes&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;34å†…æ ¸è°ƒæ•´&quot;&gt;3.4ã€å†…æ ¸è°ƒæ•´&lt;/h3&gt;

&lt;p&gt;åœ¨ä¸Šé¢çš„ä¸€äº›è°ƒæ•´å®Œæˆåæˆ‘å°±å¯åŠ¨ç³»ç»Ÿå®ä½“æœºæµ‹è¯•äº†ï¼Œæµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å®‰è£… docker ä»¥åä¼šæœ‰ä¸¤ä¸ªè­¦å‘Šï¼Œå¤§è‡´æ„æ€å°±æ˜¯ä¸æ”¯æŒ swap limit å’Œ cpu limitï¼›æŸ¥è¯¢èµ„æ–™ä»¥åå‘ç°æ˜¯å†…æ ¸æœ‰ä¸¤ä¸ªå‚æ•°æ²¡å¼€å¯(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONFIG_MEMCG_SWAP&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CONFIG_CFS_BANDWIDTH&lt;/code&gt;)â€¦å½“ç„¶æˆ‘è¿™ç§å¼ºè¿«ç—‡æ˜¯ä¸èƒ½å¿çš„ï¼Œæ²¡åŠæ³•å°±è‡ªå·±åœ¨ rpi4 ä¸Šé‡æ–°ç¼–è¯‘äº†å†…æ ¸(åæ¥æˆ‘æƒ³æƒ³è¿˜ä¸å¦‚ç”¨ arch 32bit ç„¶åè‡ªå·±ç¼–è¯‘ 64bit å†…æ ¸äº†):&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/mritd/linux-rpi4.git
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;linux-rpi4
&lt;span class=&quot;nv&quot;&gt;MAKEFLAGS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'-j4'&lt;/span&gt; makepkg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;35å¤–å£³é©±åŠ¨&quot;&gt;3.5ã€å¤–å£³é©±åŠ¨&lt;/h3&gt;

&lt;p&gt;ç”±äºæˆ‘çš„ rpi4 é…çš„æ˜¯ ARGON ONE çš„å¤–å£³ï¼Œæ‰€ä»¥ç”µæºæŒ‰é’®è¿˜æœ‰é£æ‰‡éœ€è¦é©±åŠ¨æ‰èƒ½å®Œç¾å·¥ä½œï¼Œæ²¡åŠæ³•æˆ‘åˆç¼–è¯‘äº† ARGON ONE å¤–å£³çš„é©±åŠ¨:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;git clone https://github.com/mritd/argonone.git
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;argonone
makepkg
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;å››å®šåˆ¶è„šæœ¬&quot;&gt;å››ã€å®šåˆ¶è„šæœ¬&lt;/h2&gt;

&lt;p&gt;ç»¼åˆä»¥ä¸Šçš„å„ç§ä¿®æ”¹ä»¥åï¼Œæˆ‘ä» manjaro-arm-tool æå–å‡ºäº†å®šåˆ¶åŒ–çš„ rpi4 çš„ç¼–è¯‘è„šæœ¬ï¼Œè¯¥è„šæœ¬ç›®å‰å­˜æ”¾åœ¨ &lt;a href=&quot;https://github.com/mritd/manjaro-rpi4&quot;&gt;mritd/manjaro-rpi4&lt;/a&gt; ä»“åº“ä¸­ï¼›ç›®å‰ä½¿ç”¨æ­¤è„šæœ¬ç¼–è¯‘çš„ç³»ç»Ÿé•œåƒé»˜è®¤è¿›è¡Œäº†ä»¥ä¸‹å¤„ç†:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;è°ƒæ•´ pacman mirror ä¸ºä¸­å›½&lt;/li&gt;
  &lt;li&gt;å®‰è£…å¸¸ç”¨è½¯ä»¶åŒ…(zsh htop vim wget whichâ€¦)&lt;/li&gt;
  &lt;li&gt;æœ‰çº¿ç½‘ç»œå®Œå…¨çš„ systemd-networkd æ¥ç®¡ï¼Œresolv.conf ç”± systemd-resolved æ¥ç®¡&lt;/li&gt;
  &lt;li&gt;æ— çº¿ç½‘ç»œç”± wpa_supplicant å’Œ systemd-networkd æ¥ç®¡&lt;/li&gt;
  &lt;li&gt;å®‰è£…è‡ªè¡Œç¼–è¯‘çš„å†…æ ¸ä»¥æ¶ˆé™¤ docker è­¦å‘Š(&lt;strong&gt;è‡ªç¼–è¯‘å†…æ ¸ä¸å½±å“å‡çº§ï¼Œå‡çº§/è¦†ç›–å®‰è£…åè‡ªåŠ¨æ¢å¤&lt;/strong&gt;)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è‡³äº ARGON ONE çš„å¤–å£³é©±åŠ¨åªåœ¨ resources ç›®å½•ä¸‹æä¾›äº†å®‰è£…åŒ…ï¼Œå¹¶æœªé»˜è®¤å®‰è£…åˆ°ç³»ç»Ÿã€‚&lt;/p&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Sun, 28 Jun 2020 21:59:15 +0800</pubDate>
        <link>https://mritd.me/2020/06/28/make-a-custom-manjaro-image-for-rpi4/</link>
        <guid isPermaLink="true">https://mritd.me/2020/06/28/make-a-custom-manjaro-image-for-rpi4/</guid>
        
        <category>Linux</category>
        
        
        <category>Linux</category>
        
      </item>
    
      <item>
        <title>å¦‚ä½•åœ¨ Filebeat ç«¯è¿›è¡Œæ—¥å¿—å¤„ç†</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;æœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨ ELK æ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ—¥å¿—åˆ‡å‰²å¤„ç†ç›´æ¥åœ¨ filebeat ç«¯å®ç°çš„ä¸€äº›æ–¹å¼ï¼›å…¶ä¸­åŒ…æ‹¬ filebeat processor çš„æ‰©å±•ä»¥åŠ module æ‰©å±•ç­‰ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€èµ·å› &quot;&gt;ä¸€ã€èµ·å› &lt;/h2&gt;

&lt;p&gt;ç›®å‰æŸé¡¹ç›®ç»„æ—¥å¿—éœ€è¦åšåˆ‡å‰²å¤„ç†ï¼Œé’ˆå¯¹æ—¥å¿—ä¿¡æ¯è¿›è¡Œåˆ†å‰²å¹¶æå– k/v æ”¾å…¥ es ä¸­æ–¹ä¾¿æŸ¥è¯¢ã€‚è¿™ç§éœ€æ±‚åœ¨ä¼ ç»Ÿ ELK ä¸­åº”å½“ç”± logstash ç»„ä»¶å®Œæˆï¼Œé€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gork&lt;/code&gt; ç­‰æ“ä½œå¯¹æ—¥å¿—è¿›è¡Œè¿‡æ»¤ã€åˆ‡å‰²ç­‰å¤„ç†ã€‚ä¸è¿‡å¾ˆå°´å°¬çš„æ˜¯æˆ‘å¹¶ä¸ä¼š rubyï¼Œlogstash pipeline çš„ä¸€äº›é…ç½®æˆ‘ä¹Ÿæ˜¯æå…¶å¤´ç–¼ï¼Œè€Œä¸”è¿˜ä¸æƒ³å­¦â€¦æ›´ä¸å‡‘å·§çš„æ˜¯æˆ‘ä¼šå†™ç‚¹ goï¼Œ&lt;strong&gt;é‚£ä¹ˆç†æ‰€åº”å½“çš„æ­¤æ—¶çš„æˆ‘å¯¹ filebeat æºç äº§ç”Ÿäº†ä¸€äº›æƒ³æ³•ï¼Œæ¯”å¦‚æˆ‘ç›´æ¥åœ¨ filebeat ç«¯å®Œæˆæ—¥å¿—å¤„ç†ï¼Œç„¶åç›´æ¥å‘ es/logstashï¼Œè¿™æ ·ä¼¼ä¹æ›´æ–¹ä¾¿ï¼Œè€Œä¸”è¿˜èƒ½åˆ†æ‘Š logstash çš„å‹åŠ›ï¼Œæˆ‘æ„Ÿè§‰è¿™ä¸ªæ“ä½œå¹¶ä¸è¿‡åˆ†ğŸ˜‚â€¦&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;äºŒéœ€æ±‚&quot;&gt;äºŒã€éœ€æ±‚&lt;/h2&gt;

&lt;p&gt;ç›®å‰æŸé¡¹ç›®ç»„ java æ—¥å¿—æ ¼å¼å¦‚ä¸‹:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;2020-04-30 21:56:30.117&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;api-test-65c8c7cf7f-lng7h&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;http-nio-8080-exec-3&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;INFO&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;com.example.api.common.filter.GlobalDataFilter&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;GlobalDataFilter.java&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;95&lt;span class=&quot;nv&quot;&gt;$$&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;test
&lt;/span&gt;build commonData from header :&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;romVersion&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;W_V2.1.4&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;softwareVersion&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;15&quot;&lt;/span&gt;,&lt;span class=&quot;s2&quot;&gt;&quot;token&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;aFxANNM3pnRYpohvLMSmENydgFSfsmFMgCbFWAosIE=&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$$$$&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç›®å‰å¼€å‘çº¦å®šæ ¼å¼ä¸ºæ—¥å¿—é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$$&lt;/code&gt; è¿›è¡Œåˆ†å‰²ï¼Œæ—¥å¿—æ ¼å¼æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯ logstash å…±ç”¨(nginx ç­‰å„ç§æ—¥å¿—éƒ½ä¼šå¾€è¿™ä¸ª logstash è¾“å‡º)ï¼Œä¸æƒ³å»æŠ˜è…¾ logstash é…ç½®çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦è®© filebeat èƒ½å¤Ÿç›´æ¥åˆ‡å‰²å¹¶è®¾ç½®å¥½ k/v å¯¹åº”æ—¢å¯ã€‚&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰filebeat-module&quot;&gt;ä¸‰ã€filebeat module&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;module éƒ¨ä»½åªåšç®€ä»‹ï¼Œä»¥ä¸ºå®é™…ä¸Šä¾æ‰˜ es å®Œæˆï¼Œæ„ä¹‰ä¸å¤§ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;å½“ç„¶åœ¨è€ƒè™‘ä¿®æ”¹ filebeat æºç åï¼Œæˆ‘ç¬¬ä¸€æƒ³åˆ°çš„æ˜¯ filebeat çš„ moduleï¼Œè¿™ä¸ª module åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯ä¸ªå¾ˆç¥å¥‡çš„ä¸œè¥¿ï¼›é€šè¿‡å¼€å¯ä¸€ä¸ª module å°±å¯ä»¥å¯¹æŸç§æ—¥å¿—ç›´æ¥åšå¤„ç†ï¼Œè¿™ç§ä¸œè¥¿ä¼¼ä¹å°±æ˜¯æˆ‘æƒ³è¦çš„ï¼›æ¯”å¦‚æˆ‘å†™ä¸€ä¸ª â€œé¡¹ç›®åâ€ moduleï¼Œç„¶å filebeat ç›´æ¥å¼€å¯è¿™ä¸ª moduleï¼Œè¿™ä¸ªé¡¹ç›®çš„æ—¥å¿—å°±ç›´æ¥è‡ªåŠ¨å¤„ç†å¥½(å¬èµ·æ¥å°±å¾ˆ â€œä¸Šæµâ€)â€¦&lt;/p&gt;

&lt;p&gt;é’ˆå¯¹äºè‡ªå®šä¹‰ moduleï¼Œå®˜æ–¹ç»™å‡ºäº†æ–‡æ¡£: &lt;a href=&quot;https://www.elastic.co/guide/en/beats/devguide/current/filebeat-modules-devguide.html&quot;&gt;Creating a New Filebeat Module&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;æŒ‰ç…§æ–‡æ¡£æ“ä½œå¦‚ä¸‹(å‡è®¾æˆ‘ä»¬çš„é¡¹ç›®åä¸º cdm):&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# å…‹éš†æºç &lt;/span&gt;
git clone git@github.com:elastic/beats.git
&lt;span class=&quot;c&quot;&gt;# åˆ‡æ¢åˆ°ç¨³å®šåˆ†æ”¯&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;bests &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git checkout &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; v7.6.2 v7.6.2-module
&lt;span class=&quot;c&quot;&gt;# åˆ›å»º moduleï¼ŒGO111MODULE éœ€è¦è®¾ç½®ä¸º off&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# åœ¨ 7.6.2 ç‰ˆæœ¬å®˜æ–¹å°šæœªå¼€å§‹æ”¯æŒ go mod&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;filebeat
&lt;span class=&quot;nv&quot;&gt;GO111MODULE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;off make create-module &lt;span class=&quot;nv&quot;&gt;MODULE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;cdm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;åˆ›å»ºå®Œæˆåç›®å½•ç»“æ„å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;âœ  filebeat git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;v7.6.2-module&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; âœ— tree module/cdm
module/cdm
â”œâ”€â”€ _meta
â”‚Â Â  â”œâ”€â”€ config.yml
â”‚Â Â  â”œâ”€â”€ docs.asciidoc
â”‚Â Â  â””â”€â”€ fields.yml
â””â”€â”€ module.yml

1 directory, 4 files
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¿™å‡ ä¸ªæ–‡ä»¶å…·ä½“ä½œç”¨&lt;a href=&quot;https://www.elastic.co/guide/en/beats/devguide/current/filebeat-modules-devguide.html&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;éƒ½æœ‰è¯¦ç»†çš„æè¿°ï¼›ä½†æ˜¯æ ¹æ®æ–‡æ¡£æè¿°å…‰æœ‰è¿™å‡ ä¸ªæ–‡ä»¶æ˜¯ä¸å¤Ÿçš„ï¼Œ&lt;strong&gt;module åªæ˜¯ä¸€ä¸ªå¤„ç†é›†åˆçš„å®šä¹‰ï¼Œå°šæœªåŒ…å«ä»»ä½•å¤„ç†ï¼Œé’ˆå¯¹çœŸæ­£çš„å¤„ç†éœ€è¦ç»§ç»­åˆ›å»º filesetï¼Œfileset ç®€å•çš„ç†è§£å°±æ˜¯é’ˆå¯¹å…·ä½“çš„ä¸€ç»„æ–‡ä»¶é›†åˆçš„å¤„ç†ï¼›&lt;/strong&gt;ä¾‹å¦‚å®˜æ–¹ nginx module ä¸­åŒ…å«ä¸¤ä¸ª fileset: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;access&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;error&lt;/code&gt;ï¼Œè¿™ä¸¤ä¸ªä¸€ä¸ªé’ˆå¯¹ access æ—¥å¿—å¤„ç†ä¸€ä¸ªé’ˆå¯¹ error æ—¥å¿—è¿›è¡Œå¤„ç†ï¼›åœ¨ fileset ä¸­å¯ä»¥è®¾ç½®é»˜è®¤æ–‡ä»¶ä½ç½®ã€å¤„ç†æ–¹å¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Butâ€¦ æˆ‘ç¿»äº† nginx module çš„æ ·ä¾‹é…ç½®æ‰å‘ç°ï¼Œmodule è¿™ä¸ªä¸œè¥¿å®è´¨ä¸Šåªåšå®šä¹‰å’Œå­˜å‚¨å¤„ç†è¡¨è¾¾å¼ï¼Œå…·ä½“çš„åˆ‡å‰²å¤„ç†å®é™…ä¸Šäº¤ç”± es çš„ &lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html&quot;&gt;Ingest Node&lt;/a&gt; å¤„ç†ï¼›è¡¨è¾¾å¼é‡Œä»éœ€è¦å®šä¹‰ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;grok&lt;/code&gt; ç­‰æ“ä½œï¼Œè€Œä¸”è¿™ä¸œè¥¿æœ€ç»ˆä¼šç¼–è¯‘åˆ° go é™æ€æ–‡ä»¶é‡Œï¼›&lt;/strong&gt;æ­¤æ—¶çš„æˆ‘æƒ³è¯´ä¸€å¥ â€œMMPâ€ï¼Œæœ¬æ¥æˆ‘æ˜¯ä¸åƒå†™ grok å•¥çš„æ‰æ¥æŠ˜è…¾ filebeatï¼Œç»“æœè¿™ä¸ª module æŠ˜è…¾ä¸€åœˆè¿˜æ˜¯è¦å†™ grok å•¥çš„ï¼Œè€Œä¸”è¿™ä¸œè¥¿ç›´æ¥å€ŸåŠ© es å®Œæˆå¯¼è‡´å‹åŠ›å›åˆ°äº† es åŒæ—¶æ¯æ¬¡ä¿®æ”¹è¿˜å¾—é‡æ–°ç¼–è¯‘ filebeatâ€¦ æ‰€ä»¥æŠ˜è…¾åˆ°è¿™æˆ‘å°±æ”¾å¼ƒäº†ï¼Œè¿™å·²ç»è¿èƒŒäº†å½“åˆçš„ç›®çš„ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒä»¥ä¸‹æ–‡æ¡£ç»§ç»­æŠ˜è…¾:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/beats/devguide/current/filebeat-modules-devguide.html&quot;&gt;Creating a New Filebeat Module&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html&quot;&gt;Ingest nodeedit&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-apis.html&quot;&gt;Ingest APIs&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest-processors.html&quot;&gt;Processors&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;å››filebeat-processors&quot;&gt;å››ã€filebeat processors&lt;/h2&gt;

&lt;p&gt;ç»å†äº† module çš„å¤±æœ›ä»¥åï¼Œæˆ‘æŠŠç›®å…‰å¯¹å‡†äº† processorsï¼›processors æ˜¯ filebeat ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œé¡¾åæ€ä¹‰å®ƒå¯ä»¥å¯¹ filbeat æ”¶é›†åˆ°çš„æ—¥å¿—è¿›è¡Œä¸€äº›å¤„ç†ï¼›ä»å®˜æ–¹ &lt;a href=&quot;https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html&quot;&gt;Processors&lt;/a&gt; é¡µé¢å¯ä»¥çœ‹åˆ°å…¶å†…ç½®äº†å¤§é‡çš„ processorï¼›è¿™äº› processor å¤§éƒ¨ä»½éƒ½æ˜¯ç›´æ¥å¯¹æ—¥å¿—è¿›è¡Œ â€œå†™â€ æ“ä½œï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ª processor å°±å¯ä»¥ â€œä¸ºæ‰€æ¬²ä¸º+ä¸ºæ‰€æ¬²ä¸º=ä¸ºæ‰€æ¬²ä¸ºâ€ã€‚&lt;/p&gt;

&lt;p&gt;ä¸è¿‡ä¸å¹¸çš„æ˜¯å…³äº processor çš„å¼€å‘å®˜æ–¹å¹¶æœªç»™å‡ºæ–‡æ¡£ï¼Œå®˜æ–¹è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;high level&lt;/code&gt; çš„ä¸œè¥¿ï¼Œä¸è¿‡ä¹Ÿæ‰¾åˆ°äº†ä¸€ä¸ª issue å¯¹å…¶åšäº†ç›¸å…³å›ç­”: &lt;a href=&quot;https://github.com/elastic/beats/issues/6760&quot;&gt;How do I write a processor plugin by myself&lt;/a&gt;ï¼›æ‰€ä»¥æœ€å¥½çš„åŠæ³•å°±æ˜¯ç›´æ¥çœ‹å·²æœ‰ processor çš„æºç æŠ„ä¸€ä¸ªã€‚&lt;/p&gt;

&lt;p&gt;ç†æ‰€åº”å½“çš„æ‰¾äº†ä¸€ä¸ªè½¯æŸ¿å­æ: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;add_host_metadata&lt;/code&gt;ï¼Œadd_host_metadata processor é¡¾åæ€ä¹‰åœ¨æ¯ä¸ªæ—¥å¿—äº‹ä»¶(ä»¥ä¸‹ç®€ç§°ä¸º event)ä¸­åŠ å…¥å®¿ä¸»æœºçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ hostname å•¥çš„ï¼›ä»¥ä¸‹ä¸º add_host_metadata processor çš„æ–‡ä»¶ç»“æ„(processors ä»£ç å­˜å‚¨åœ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;libbeat/processors&lt;/code&gt; ç›®å½•ä¸‹)ã€‚&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/axucc.jpg&quot; alt=&quot;dir_tree&quot; /&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡é˜…è¯»æºç å’Œ issue çš„å›ç­”å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ processor åªéœ€è¦å®ç° &lt;a href=&quot;https://godoc.org/github.com/elastic/beats/libbeat/processors#Processor&quot;&gt;Processor interface&lt;/a&gt; æ—¢å¯ï¼Œè¿™ä¸ªæ¥å£å®šä¹‰å¦‚ä¸‹:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/xuja6.png&quot; alt=&quot;Processor interface&quot; /&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡æŸ¥çœ‹ add_host_metadata çš„æºç ï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;String() string&lt;/code&gt; æ–¹æ³•åªéœ€è¦è¿”å›è¿™ä¸ª processor åç§°æ—¢å¯(å¯ä»¥åŒ…å«å¿…è¦çš„é…ç½®ä¿¡æ¯)ï¼›&lt;strong&gt;è€Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Run(event *beat.Event) (*beat.Event, error)&lt;/code&gt; æ–¹æ³•è¡¨ç¤ºåœ¨æ¯ä¸€æ¡æ—¥å¿—è¢«è¯»å–åéƒ½ä¼šè½¬æ¢ä¸ºä¸€ä¸ª event å¯¹è±¡ï¼Œæˆ‘ä»¬åœ¨æ–¹æ³•å†…è¿›è¡Œå¤„ç†ç„¶åæŠŠ event è¿”å›æ—¢å¯(å…¶ä»– processor å¯èƒ½ä¹Ÿè¦å¤„ç†)ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/jhtnx.png&quot; alt=&quot;add_host_metadata source&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æœ‰äº†è¿™äº›ä¿¡æ¯å°±ç®€å•å¾—å¤šäº†ï¼Œæ¯•ç«Ÿä½œä¸º&lt;strong&gt;ä¸€ååˆæ ¼çš„ CCE(Ctrl C + Ctrl V + Engineer)&lt;/strong&gt; æŠ„è¿™ç§æ“ä½œè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œç›´æ¥ç…§çŒ«ç”»è™å†™ä¸€ä¸ªå°±è¡Œäº†&lt;/p&gt;

&lt;p&gt;config.go&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// Config for cdm processor.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;           &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;          &lt;span class=&quot;s&quot;&gt;`config:&quot;name&quot;`&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;defaultConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cdm.go&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cmd&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;strings&quot;&lt;/span&gt;

	&lt;span class=&quot;s&quot;&gt;&quot;github.com/elastic/beats/libbeat/logp&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;github.com/pkg/errors&quot;&lt;/span&gt;

	&lt;span class=&quot;s&quot;&gt;&quot;github.com/elastic/beats/libbeat/beat&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;github.com/elastic/beats/libbeat/common&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;github.com/elastic/beats/libbeat/processors&quot;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;jsprocessor&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;github.com/elastic/beats/libbeat/processors/script/javascript/module/processor&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;processors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RegisterPlugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;cdm&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;jsprocessor&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RegisterPlugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;CDM&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cdm&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Logger&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;processorName&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;cdm&quot;&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;logName&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;processor.cdm&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// New constructs a new cdm processor.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;common&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;processors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Processor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// é…ç½®æ–‡ä»¶é‡Œå°±ä¸€ä¸ª Name å­—æ®µï¼Œç»“æ„ä½“ç•™ç€ä»¥åæ–¹ä¾¿æ‰©å±•&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;defaultConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Unpack&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Wrapf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;fail to unpack the %v configuration&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;processorName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cdm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// å¾…åˆ†å‰²çš„æ¯æ®µæ—¥å¿—å¯¹åº”çš„ key&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;fields&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;timestamp&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;hostname&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;thread&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;level&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;logger&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;file&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;line&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;serviceName&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;traceId&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;feTraceId&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;msg&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;exception&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;logp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewLogger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;// çœŸæ­£çš„æ—¥å¿—å¤„ç†é€»è¾‘&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// ä¸ºäº†ä¿è¯åé¢çš„ processor æ­£å¸¸å¤„ç†ï¼Œè¿™é‡Œé¢æ²¡æœ‰ return ä»»ä½• errorï¼Œåªæ˜¯ç®€å•çš„æ‰“å°&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cdm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;event&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;beat&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// å°è¯•è·å– messageï¼Œç†è®ºä¸Šè¿™ä¸€æ­¥ä¸åº”è¯¥å‡ºç°é—®é¢˜&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;message&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;failed to parse message&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// åˆ†å‰²æ—¥å¿—&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fieldsValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;$$&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Debugf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;message fields: %v&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fieldsVaule&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// ä¸ºäº†ä¿è¯ä¸ä¼šå‡ºç°æ•°ç»„è¶Šç•Œéœ€è¦åˆ¤æ–­ä¸€ä¸‹(ä¸‡ä¸€å¼„å‡ºä¸ªæ ¼å¼ä¸æ­£å¸¸çš„æ—¥å¿—è¿‡æ¥ä¿è¯ä¸å´©)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fieldsValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fields&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Errorf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;incorrect field length: %d, expected length: %d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fieldsValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;len&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fields&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// è¿™é‡Œéå†ç„¶åèµ›ä¼šåˆ° event æ—¢å¯&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;common&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;MapStr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;k&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;p&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fields&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;PutValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;k&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TrimSpace&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fieldsValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fields&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DeepUpdate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cdm&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;String&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;processorName&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å†™å¥½ä»£ç ä»¥åå°±å¯ä»¥ç¼–è¯‘ä¸€ä¸ªè‡ªå·±çš„ filebeat äº†(å¼€å¿ƒing)&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;filebeat
&lt;span class=&quot;c&quot;&gt;# å¦‚æœæƒ³äº¤å‰ç¼–è¯‘ linux éœ€è¦å¢åŠ  GOOS=linux å˜é‡ &lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;GO111MODULE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;off make
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç„¶åç¼–å†™é…ç½®æ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼Œæ—¥å¿—ç›¸å…³å­—æ®µå·²ç»æˆåŠŸå¡åˆ°äº† event ä¸­ï¼Œè¿™æ ·æˆ‘ç›´æ¥å‘åˆ° es æˆ–è€… logstash å°±è¡Œäº†ã€‚&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;filebeat.inputs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;log&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/Users/natural/tmp/cdm.log&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;processors&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;cdm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;~&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.pattern&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;^\d{4}-\d{1,2}-\d{1,2}&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.match&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;after&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.negate&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.timeout&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5s&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;äº”script-processor&quot;&gt;äº”ã€script processor&lt;/h2&gt;

&lt;p&gt;åœ¨æˆ‘æŠ˜è…¾å®Œæºç ä»¥åï¼Œåæ€ä¸€ä¸‹å…¶å®è¿™ç§æ–¹å¼éœ€è¦è‡ªå·±ç¼–è¯‘ filebeatï¼Œè€Œä¸”æ¯æ¬¡è§„åˆ™ä¿®æ”¹ä¹Ÿå¾ˆä¸æ–¹ä¾¿ï¼Œå”¯ä¸€çš„å¥½å¤„çœŸçš„å°±æ˜¯ç”¨ä»£ç å¯ä»¥ â€œä¸ºæ‰€æ¬²ä¸ºâ€ï¼›åè¿‡æ¥ä¸€æƒ³ â€œfilebeat æœ‰æ²¡æœ‰ processor çš„æ‰©å±•å‘¢ï¼Ÿè„šæœ¬çƒ­åŠ è½½é‚£ç§ï¼Ÿâ€ ç­”æ¡ˆæ˜¯ä½¿ç”¨ script processorï¼Œ&lt;strong&gt;script processor è™½ç„¶åå­—ä¸Šæ˜¯ä¸ª processorï¼Œå®é™…ä¸Šå…¶åŒ…å«äº†å®Œæ•´çš„ ECMA 5.1 js è§„èŒƒå®ç°ï¼›ç»“è®ºå°±æ˜¯æˆ‘ä»¬å¯ä»¥å†™ä¸€äº› js è„šæœ¬æ¥å¤„ç†æ—¥å¿—ï¼Œç„¶å filebeat æ¯æ¬¡å¯åŠ¨ååŠ è½½è¿™äº›è„šæœ¬æ—¢å¯ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;script processor çš„ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œjs æ–‡ä»¶ä¸­åªéœ€è¦åŒ…å«ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;function process(event)&lt;/code&gt; æ–¹æ³•æ—¢å¯ï¼Œä¸è‡ªå·±ç”¨ go å®ç°çš„ processor ç±»ä¼¼ï¼Œæ¯è¡Œæ—¥å¿—ä¹Ÿä¼šå½¢æˆä¸€ä¸ª event å¯¹è±¡ç„¶åè°ƒç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œå¤„ç†ï¼›ç›®å‰ event å¯¹è±¡å¯ç”¨çš„ api éœ€è¦å‚è€ƒ&lt;a href=&quot;https://www.elastic.co/guide/en/beats/filebeat/current/processor-script.html#_event_api&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ï¼›&lt;strong&gt;éœ€è¦æ³¨æ„çš„æ˜¯ script processor ç›®å‰åªæ”¯æŒ ECMA 5.1 è¯­æ³•è§„èŒƒï¼Œè¶…è¿‡è¿™ä¸ªèŒƒå›´çš„è¯­æ³•æ˜¯ä¸è¢«æ”¯æŒï¼›&lt;/strong&gt;å®é™…ä¸Šå…¶æ ¹æœ¬æ˜¯å€ŸåŠ©äº† &lt;a href=&quot;https://github.com/dop251/goja&quot;&gt;https://github.com/dop251/goja&lt;/a&gt; è¿™ä¸ªåº“æ¥å®ç°çš„ã€‚åŒæ—¶ä¸ºäº†æ–¹ä¾¿å¼€å‘è°ƒè¯•ï¼Œscript processor ä¹Ÿå¢åŠ äº†ä¸€äº› nodejs çš„å…¼å®¹ moduleï¼Œæ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;console.log&lt;/code&gt; ç­‰æ–¹æ³•æ˜¯å¯ç”¨çš„ï¼›ä»¥ä¸‹ä¸º js å¤„ç†ä¸Šé¢æ—¥å¿—çš„é€»è¾‘:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fileds&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;timestamp&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;hostname&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;thread&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;serviceName&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;traceId&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;feTraceId&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;msg&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;exception&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;process&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;null&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;message&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dl&quot;&gt;''&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;failed to get message&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fieldValues&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;message&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;split&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;$$&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fieldValues&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fileds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;console&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;incorrect field length&lt;/span&gt;&lt;span class=&quot;dl&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fileds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;length&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;event&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;Put&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fileds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;fieldValues&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;trim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å†™å¥½è„šæœ¬åè°ƒæ•´é…ç½®æµ‹è¯•æ—¢å¯ï¼Œå¦‚æœ js ç¼–å†™æœ‰é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;console.log&lt;/code&gt; æ¥æ‰“å°æ—¥å¿—è¿›è¡Œä¸æ–­çš„è°ƒè¯•&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;filebeat.inputs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;log&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;paths&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/Users/natural/tmp/cdm.log&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;processors&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;script&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;lang&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;js&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cdm&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;cdm.js&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.pattern&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;^\d{4}-\d{1,2}-\d{1,2}&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.match&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;after&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.negate&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;multiline.timeout&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5s&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;éœ€è¦æ³¨æ„çš„æ˜¯ç›®å‰ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lang&lt;/code&gt; çš„å€¼åªèƒ½ä¸º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;javascript&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;js&lt;/code&gt;(å®˜æ–¹æ–‡æ¡£å†™çš„åªèƒ½æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;javascript&lt;/code&gt;)ï¼›æ ¹æ®ä»£ç æ¥çœ‹åç»­ script processor æœ‰å¯èƒ½æ”¯æŒå…¶ä»–è„šæœ¬è¯­è¨€ï¼Œä¸ªäººè®¤ä¸ºä¸»è¦å–å†³äºå…¶ä»–è„šæœ¬è¯­è¨€æœ‰æ²¡æœ‰çº¯ go å®ç°çš„ runtimeï¼Œå¦‚æœæœ‰çš„è¯æœªæ¥å¾ˆæœ‰å¯èƒ½è¢«æ•´åˆåˆ° script processor ä¸­ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://tva1.sinaimg.cn/large/007S8ZIlly1gegg80j1gmj31nc0u0wpa.jpg&quot; alt=&quot;script processor&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;å…­å…¶ä»–-processor&quot;&gt;å…­ã€å…¶ä»– processor&lt;/h2&gt;

&lt;p&gt;ç ”ç©¶å®Œ script processor åæˆ‘é¡¿æ—¶å¯¹å…¶ä»– processor ä¹Ÿäº§ç”Ÿäº†å…´è¶£ï¼Œéšç€æ›´å¤šçš„æŸ¥çœ‹processor æ–‡æ¡£ï¼Œæˆ‘å‘ç°å…¶å®å¤§éƒ¨ä»½è¿‡æ»¤åˆ†å‰²èƒ½åŠ›å·²ç»æœ‰å¾ˆå¤š processor è¿›è¡Œäº†å®ç°ï¼Œ&lt;strong&gt;å…¶å®Œå–„ç¨‹åº¦å¤–åŠ å¯æ‰©å±•çš„ script processor å®é™…èƒ½åŠ›å·²ç»è¶³çŸ£æ›¿æ¢æ‰ logstash çš„æ—¥å¿—åˆ†å‰²è¿‡æ»¤å¤„ç†äº†ã€‚&lt;/strong&gt;æ¯”å¦‚ä¸Šé¢çš„æ—¥å¿—åˆ‡å‰²å…¶å®ä½¿ç”¨ dissect processor å®ç°æ›´åŠ ç®€å•(è¿™ä¸ªé…ç½®å¹¶ä¸å®Œå–„ï¼Œåªæ˜¯æ ·ä¾‹):&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;  &lt;span class=&quot;na&quot;&gt;processors&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;dissect&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;field&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;message&quot;&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;tokenizer&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;%{timestamp}$$%{hostname}$$%{thread}$$%{level}$$%{logger}$$%{file}$$%{line}$$%{serviceName}$$%{traceId}$$%{feTraceId}$$%{msg}$$%{exception}$$&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤š processorï¼Œä¾‹å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;drop_event&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;drop_fields&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;timestamp&lt;/code&gt; ç­‰ç­‰ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚&lt;/p&gt;

&lt;h2 id=&quot;ä¸ƒæ€»ç»“&quot;&gt;ä¸ƒã€æ€»ç»“&lt;/h2&gt;

&lt;p&gt;åŸºæœ¬ä¸ŠæŠ˜è…¾å®Œä»¥ååšäº†ä¸€ä¸ªæ€»ç»“:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;filebeat module&lt;/strong&gt;: è¿™å°±æ˜¯ä¸ªåè€Œä¸å®çš„ä¸œè¥¿ï¼Œæ¯æ¬¡ä¿®æ”¹éœ€è¦é‡æ–°ç¼–è¯‘ä¸”æ‰©å±•èƒ½åŠ›å‡ è¿‘äºé›¶ï¼Œæœ€è›‹ç–¼çš„æ˜¯å®é™…é€»è¾‘é€šè¿‡ es æ¥å®Œæˆï¼›æˆ‘èƒ½æƒ³åˆ°çš„æ˜¯å”¯ä¸€åº”ç”¨åœºæ™¯å°±æ˜¯å®˜æ–¹ç»™æˆ‘ä»¬å¼„ä¸€äº› demo æ¥ç‚«è€€ç”¨çš„ï¼Œæ¯”å¦‚ nginx moduleï¼›å®é™…ç”Ÿäº§ä¸­ nginx æ—¥å¿—æ ¼å¼ä¿æŒåŸå°ä¸åŠ¨çš„äººæˆ‘ç›¸ä¿¡å°‘ä¹‹åˆå°‘ã€‚&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;filebeat custom processor&lt;/strong&gt;: æ¯æ¬¡ä¿®æ”¹ä¹Ÿéœ€è¦é‡æ–°ç¼–è¯‘ä¸”éœ€è¦ä¼š go è¯­è¨€è¿˜æœ‰ç›¸å…³å·¥å…·é“¾ï¼Œä½†æ˜¯å¥½å¤„å°±æ˜¯å®Œå…¨é€šè¿‡ä»£ç å®ç°çœŸæ­£çš„ä¸ºæ‰€æ¬²ä¸ºï¼›æ‰©å±•æ€§å–å†³äºå¤–éƒ¨æ˜¯å¦å¯¹ç‰¹å®šä½ç½®åšäº†å¯é…ç½®åŒ–ï¼Œæ¯”å¦‚é¢„ç•™å¯ä»¥é…ç½®åˆ‡å‰²ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„å˜é‡ç­‰ï¼Œæœ€ç»ˆå–å†³äºä»£ç ç¼–å†™è€…(æ€ä¹ˆä¸ºæ‰€æ¬²ä¸ºçš„é—®é¢˜)ã€‚&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;filebeat script processor&lt;/strong&gt;: å®Œæ•´ ECMA 5.1 js è§„èŒƒæ”¯æŒï¼Œä»£ç åŒ–å¯¹æ—¥å¿—è¿›è¡Œä¸ºæ‰€æ¬²ä¸ºï¼Œä¿®æ”¹ä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼›æ™®é€šç”¨æˆ·æˆ‘ä¸ªäººè§‰å¾—æ˜¯é¦–é€‰ï¼Œå½“ç„¶åŒæ—¶ä¼šå†™ go å’Œ js çš„å°±çœ‹ä½ æƒ³ç”¨å“ªä¸ªäº†ã€‚&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;filebeat other processor&lt;/strong&gt;: åŸºæœ¬ä¸Šå®ç°äº†å¾ˆå¤š logstash çš„åŠŸèƒ½ï¼Œç®€å•ç”¨ç”¨å¾ˆèˆ’æœï¼Œå¤æ‚åœºæ™¯è¿˜æ˜¯å¾—æ’¸ä»£ç ï¼›ä½†æ˜¯ä¸€äº›ç‰¹å®šçš„ processor å¾ˆå®ç”¨ï¼Œæ¯”å¦‚åŠ å…¥å®¿ä¸»æœºä¿¡æ¯çš„ add_host_metadata processor ç­‰ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Sun, 28 Jun 2020 21:50:33 +0800</pubDate>
        <link>https://mritd.me/2020/06/28/how-to-modify-filebeat-source-code-to-processing-logs/</link>
        <guid isPermaLink="true">https://mritd.me/2020/06/28/how-to-modify-filebeat-source-code-to-processing-logs/</guid>
        
        <category>Kubernetes</category>
        
        
        <category>Kubernetes</category>
        
      </item>
    
      <item>
        <title>å¦‚ä½•ä¸é€šè¿‡ docker ä¸‹è½½ docker image</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒéªšçš„åŠ¨ä½œï¼Œä½†æ˜¯äº‹å®ä¸Šç¡®å®æœ‰è¿™ä¸ªéœ€æ±‚ï¼ŒæŠ˜è…¾åŠå¤©æ‰¾å·¥å…·çœ‹æºç ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹(ä¸æƒ³çœ‹æºç åˆ†æå•¥çš„è¯·ç›´æ¥è·³è½¬åˆ°ç¬¬äº”éƒ¨ä»½)ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€èµ·å› &quot;&gt;ä¸€ã€èµ·å› &lt;/h2&gt;

&lt;p&gt;ç”±äºæœ€è¿‘æŸä¸ªçˆ¬è™«ä¸šåŠ¡éœ€è¦æŠ“å–å¾®ä¿¡å…¬ä¼—å·çš„ä¸€äº›æ–‡ç« ï¼ŒæŸå¼€å‘å°ä¼™ä¼´æƒ³åˆ°äº†é€šè¿‡å¯åŠ¨å®‰å“è™šæ‹Ÿæœºç„¶åæŠ“åŒ…çš„æ–¹å¼å®ç°ï¼›ç»è¿‡å‡ ç•ªå¯»æ‰¾æœ€ç»ˆæˆ‘ä»¬é€‰æ‹©é‡‡ç”¨ docker çš„æ–¹å¼å¯åŠ¨å®‰å“è™šæ‹Ÿæœºï¼Œdocker é‡Œå®‰å“è™šæ‹Ÿæœºæ¯”è¾ƒæˆç†Ÿçš„é¡¹ç›®æˆ‘ä»¬æ‰¾åˆ°äº† &lt;a href=&quot;https://github.com/budtmo/docker-android&quot;&gt;https://github.com/budtmo/docker-android&lt;/a&gt; è¿™ä¸ªé¡¹ç›®ï¼›ä½†æ˜¯ç”±äºä¼—æ‰€å‘¨çŸ¥çš„åŸå› è¿™ä¸ª 2G+ çš„é•œåƒå›½å†…æ‹‰å–æ˜¯éå¸¸æ…¢çš„ï¼Œäºæ˜¯æˆ‘æƒ³åˆ°äº†é€šè¿‡å›½å¤– VPS æ‹‰å–ç„¶å scp å›æ¥â€¦ ç”±äºè´«ç©·çš„åŸå› ï¼Œå½“æˆ‘å®é™…æ“ä½œçš„æ—¶å€™é‡åˆ°äº†æ¯”è¾ƒå°´å°¬çš„é—®é¢˜: &lt;strong&gt;VPS ç£ç›˜ç©ºé—´ 25Gï¼Œé•œåƒæ‹‰å–åè§£å‹æ¥è¿‘ 10Gï¼Œæˆ‘éœ€è¦ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker save&lt;/code&gt; æˆ tar åŒ…å†è¿›è¡Œæ‰“åŒ…æˆ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tar.gz&lt;/code&gt; æ ¼å¼ scp å›æ¥ï¼Œè¿™ä¸ªæ—¶å€™ç©ºé—´ä¸å¤Ÿç”¨äº†â€¦&lt;/strong&gt;æ‰€ä»¥æˆ‘å½“æ—¶å°±åœ¨æƒ³æœ‰æ²¡æœ‰åŠæ³•è®© docker daemon æ‹‰å–é•œåƒæ—¶ä¸è§£å‹ï¼Ÿæˆ–è€…è¯´è‡ªå·±é€šè¿‡ HTTP ä¸‹è½½é•œåƒç›´æ¥å­˜å‚¨ä¸º tarï¼Ÿ&lt;/p&gt;

&lt;h2 id=&quot;äºŒå°è¯•é€ è½®å­&quot;&gt;äºŒã€å°è¯•é€ è½®å­&lt;/h2&gt;

&lt;p&gt;å½“å‡ºç°äº†ä¸Šé¢çš„é—®é¢˜åï¼Œæˆ‘ç¬¬ä¸€ååº”å°±æ˜¯:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;1ã€docker æ‹†åˆ†ä¸º moby&lt;/li&gt;
  &lt;li&gt;2ã€moby æ¨¡å—åŒ–ï¼Œå¤§éƒ¨ä»½å¼€æºåˆ° &lt;a href=&quot;https://github.com/containers&quot;&gt;containers&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;3ã€&lt;a href=&quot;https://github.com/containers/image&quot;&gt;containers/image&lt;/a&gt; é¡¹ç›®æ˜¯é•œåƒéƒ¨ä»½æºç &lt;/li&gt;
  &lt;li&gt;4ã€çœ‹ &lt;a href=&quot;https://github.com/containers/image&quot;&gt;containers/image&lt;/a&gt; æºç é€ è½®å­&lt;/li&gt;
  &lt;li&gt;5ã€ä¸ç¡®å®šæ˜¯å¦éœ€è¦ &lt;a href=&quot;https://github.com/containers/storage&quot;&gt;containers/storage&lt;/a&gt; åšå­˜å‚¨&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;ä¸‰çŒœæµ‹æºç &quot;&gt;ä¸‰ã€çŒœæµ‹æºç &lt;/h2&gt;

&lt;p&gt;å½“æˆ‘æŸ¥çœ‹ &lt;a href=&quot;https://github.com/containers/image&quot;&gt;containers/image&lt;/a&gt; README æ–‡æ¡£æ—¶å‘ç°å…¶æåˆ°äº† &lt;a href=&quot;https://github.com/containers/skopeo&quot;&gt;skopeo&lt;/a&gt; é¡¹ç›®ï¼Œå¹¶ä¸”å¾ˆæ˜ç¡®çš„è¯´äº†&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The containers/image project is only a library with no user interface; you can either incorporate it into your Go programs, or use the skopeo tool:
The skopeo tool uses the containers/image library and takes advantage of many of its features, e.g. skopeo copy exposes the containers/image/copy.Image functionality.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´é•œåƒä¸‹è½½è¿™å—å¾ˆå¤§å¯èƒ½åº”è¯¥è°ƒç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;containers/image/copy.Image&lt;/code&gt; å®Œæˆï¼Œéšå³å°±çœ‹äº†ä¸‹æºç æ–‡æ¡£&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/tv7iy.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å¾ˆæ˜æ˜¾ï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;types.ImageReference&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Options&lt;/code&gt; é‡Œé¢çš„å±æ€§å•¥çš„æˆ‘å®Œå…¨çœ‹ä¸æ‡‚â€¦ ğŸ˜‚ğŸ˜‚ğŸ˜‚&lt;/p&gt;

&lt;h2 id=&quot;å››çœ‹-skopeo-æºç &quot;&gt;å››ã€çœ‹ skopeo æºç &lt;/h2&gt;

&lt;p&gt;å½“ &lt;a href=&quot;https://github.com/containers/image&quot;&gt;containers/image&lt;/a&gt; æºç çœ‹ä¸æ‡‚æ—¶ï¼Œçªç„¶æƒ³åˆ° &lt;a href=&quot;https://github.com/containers/skopeo&quot;&gt;skopeo&lt;/a&gt; è°ƒç”¨çš„æ˜¯è¿™ä¸ªç©æ„ï¼Œé‚£ä¹ˆä¾è‘«èŠ¦ç”»ç“¢çœ‹ &lt;a href=&quot;https://github.com/containers/skopeo&quot;&gt;skopeo&lt;/a&gt; æºç åº”è¯¥èƒ½è¡Œï¼›æ¥ä¸‹æ¥å¸¸è§„æ“ä½œ clone skopeo æºç ç„¶åç¼–è¯‘è¿è¡Œæµ‹è¯•ï¼›ç¼–è¯‘å skopeo æ”¯æŒå‘½ä»¤å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;NAME:
   skopeo - Various operations with container images and container image registries

USAGE:
   skopeo &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;global options] &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;options] &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;arguments...]

VERSION:
   0.1.42-dev commit: 018a0108b103341526b41289c434b59d65783f6f

COMMANDS:
   copy               Copy an IMAGE-NAME from one location to another
   inspect            Inspect image IMAGE-NAME
   delete             Delete image IMAGE-NAME
   manifest-digest    Compute a manifest digest of a file
   &lt;span class=&quot;nb&quot;&gt;sync               &lt;/span&gt;Synchronize one or more images from one location to another
   standalone-sign    Create a signature using &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;files
   standalone-verify  Verify a signature using &lt;span class=&quot;nb&quot;&gt;local &lt;/span&gt;files
   list-tags          List tags &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the transport/repository specified by the REPOSITORY-NAME
   &lt;span class=&quot;nb&quot;&gt;help&lt;/span&gt;, h            Shows a list of commands or &lt;span class=&quot;nb&quot;&gt;help &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;one &lt;span class=&quot;nb&quot;&gt;command

&lt;/span&gt;GLOBAL OPTIONS:
   &lt;span class=&quot;nt&quot;&gt;--debug&lt;/span&gt;                     &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;debug output
   &lt;span class=&quot;nt&quot;&gt;--policy&lt;/span&gt; value              Path to a trust policy file
   &lt;span class=&quot;nt&quot;&gt;--insecure-policy&lt;/span&gt;           run the tool without any policy check
   &lt;span class=&quot;nt&quot;&gt;--registries&lt;/span&gt;.d DIR          use registry configuration files &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;DIR &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;e.g. &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;container signature storage&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;nt&quot;&gt;--override-arch&lt;/span&gt; ARCH        use ARCH instead of the architecture of the machine &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;choosing images
   &lt;span class=&quot;nt&quot;&gt;--override-os&lt;/span&gt; OS            use OS instead of the running OS &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;choosing images
   &lt;span class=&quot;nt&quot;&gt;--override-variant&lt;/span&gt; VARIANT  use VARIANT instead of the running architecture variant &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;choosing images
   &lt;span class=&quot;nt&quot;&gt;--command-timeout&lt;/span&gt; value     &lt;span class=&quot;nb&quot;&gt;timeout &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;execution &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;default: 0s&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
   &lt;span class=&quot;nt&quot;&gt;--help&lt;/span&gt;, &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt;                  show &lt;span class=&quot;nb&quot;&gt;help&lt;/span&gt;
   &lt;span class=&quot;nt&quot;&gt;--version&lt;/span&gt;, &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt;               print the version
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;æˆ‘ææŒ‡ä¸€ç®—è°ƒç”¨ copy å‘½ä»¤åº”è¯¥æ˜¯æˆ‘è¦æ‰¾çš„é‚£ä¸ªå®ƒ&lt;/strong&gt;ï¼Œæ‰€ä»¥å¸¸è§„æ“ä½œæ‰“å¼€æºç ç›´æ¥çœ‹&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/urn3l.png&quot; alt=&quot;copy_cmd&quot; /&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡ç»§ç»­è¿½è¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alltransports.ParseImageName&lt;/code&gt; æ–¹æ³•æœ€ç»ˆå¯ä»¥å¾—çŸ¥ copy å‘½ä»¤çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SOURCE-IMAGE&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DESTINATION-IMAGE&lt;/code&gt; éƒ½æ”¯æŒå“ªäº›å†™æ³•&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/ush4t.png&quot; alt=&quot;tp_register&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;æ¯ä¸€ä¸ª Transport çš„å®ç°éƒ½æä¾›äº† Name æ–¹æ³•ï¼Œå…¶åç§°å³ä¸º src æˆ– dest é•œåƒåç§°çš„å‰ç¼€ï¼Œä¾‹å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker://nginx:1.17.6&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/7fpap.png&quot; alt=&quot;tp_docker&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç»è¿‡æµ‹è¯•ä¸åŒçš„ Transport æ ¼å¼å¹¶ä¸å®Œå…¨ä¸€è‡´(å…·ä½“çœ‹æºç )ï¼Œæ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker://nginx:1.17.6&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dir:/tmp/nginx&lt;/code&gt;ï¼›åŒæ—¶è¿™äº› Transport å¹¶éå®Œå…¨éƒ½é€‚ç”¨ä¸ src ä¸ destï¼Œæ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tarball:/tmp/nginx.tar&lt;/code&gt; æ”¯æŒ src è€Œä¸æ”¯æŒ destï¼›&lt;/strong&gt;å…¶åˆ¤æ–­æ ¸å¿ƒä¾æ®ä¸º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ImageReference.NewImageSource&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ImageReference.NewImageDestination&lt;/code&gt; æ–¹æ³•å®ç°æ˜¯å¦è¿”å› error&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/jb087.png&quot; alt=&quot;NewImageDestination&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å½“æˆ‘çœ‹äº†ä¸€ä¼šå„ç§ Transport æºç åæˆ‘å‘ç°ä¸€ä»¶äº‹: &lt;strong&gt;è¿™ç‰¹ä¹ˆä¸å°±æ˜¯æˆ‘è¦é€ çš„è½®å­ä¹ˆï¼ğŸ˜±ğŸ˜±ğŸ˜±&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;äº”skopeo-copy-ä½¿ç”¨&quot;&gt;äº”ã€skopeo copy ä½¿ç”¨&lt;/h2&gt;

&lt;h3 id=&quot;51ä¸å€ŸåŠ©-docker-ä¸‹è½½é•œåƒ&quot;&gt;5.1ã€ä¸å€ŸåŠ© docker ä¸‹è½½é•œåƒ&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;skopeo &lt;span class=&quot;nt&quot;&gt;--insecure-policy&lt;/span&gt; copy docker://nginx:1.17.6 docker-archive:/tmp/nginx.tar
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--insecure-policy&lt;/code&gt; é€‰é¡¹ç”¨äºå¿½ç•¥å®‰å…¨ç­–ç•¥é…ç½®æ–‡ä»¶ï¼Œè¯¥å‘½ä»¤å°†ä¼šç›´æ¥é€šè¿‡ http ä¸‹è½½ç›®æ ‡é•œåƒå¹¶å­˜å‚¨ä¸º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/tmp/nginx.tar&lt;/code&gt;ï¼Œæ­¤æ–‡ä»¶å¯ä»¥ç›´æ¥é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker load&lt;/code&gt; å‘½ä»¤å¯¼å…¥&lt;/p&gt;

&lt;h3 id=&quot;52ä»-docker-daemon-å¯¼å‡ºé•œåƒ&quot;&gt;5.2ã€ä» docker daemon å¯¼å‡ºé•œåƒ&lt;/h3&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;skopeo &lt;span class=&quot;nt&quot;&gt;--insecure-policy&lt;/span&gt; copy docker-daemon:nginx:1.17.6 docker-archive:/tmp/nginx.tar
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è¯¥å‘½ä»¤å°†ä¼šä» docker daemon å¯¼å‡ºé•œåƒåˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/tmp/nginx.tar&lt;/code&gt;ï¼›ä¸ºä»€ä¹ˆä¸ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;docker save&lt;/code&gt;ï¼Ÿå› ä¸ºæˆ‘æ˜¯å·æ‡’ dest ä¹Ÿæ˜¯ docker-archiveï¼Œå®é™…ä¸Š skopeo å¯ä»¥å¯¼å‡ºä¸ºå…¶ä»–æ ¼å¼æ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;oci&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;oci-archive&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ostree&lt;/code&gt; ç­‰&lt;/p&gt;

&lt;h3 id=&quot;53å…¶ä»–å‘½ä»¤&quot;&gt;5.3ã€å…¶ä»–å‘½ä»¤&lt;/h3&gt;

&lt;p&gt;skopeo è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å®ç”¨å‘½ä»¤ï¼Œæ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sync&lt;/code&gt; å¯ä»¥åœ¨ä¸¤ä¸ªä½ç½®ä¹‹é—´åŒæ­¥é•œåƒ(ğŸ˜‚æ—©çŸ¥é“æˆ‘è¿˜å†™ä¸ªé¸¡å„¿ gcrsync)ï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inspect&lt;/code&gt; å¯ä»¥æŸ¥çœ‹é•œåƒä¿¡æ¯ç­‰ï¼Œè¿«äºæœ¬äººå¤ªæ‡’ï¼Œå‰©ä¸‹çš„è¯·è‡ªè¡ŒæŸ¥é˜…æ–‡æ¡£ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--help&lt;/code&gt; ä»¥åŠæºç (æ²¡é”™ï¼Œæ•´ç¯‡æ–‡ç« éƒ½æ²¡å†™ skopeo æ€ä¹ˆå®‰è£…)ã€‚&lt;/p&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 31 Mar 2020 23:07:34 +0800</pubDate>
        <link>https://mritd.me/2020/03/31/how-to-download-docker-image-without-docker/</link>
        <guid isPermaLink="true">https://mritd.me/2020/03/31/how-to-download-docker-image-without-docker/</guid>
        
        <category>Docker</category>
        
        
        <category>Docker</category>
        
      </item>
    
      <item>
        <title>kubeadm è¯ä¹¦æœŸé™è°ƒæ•´</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;æœ€è¿‘ kubeadm HA çš„é›†ç¾¤æŠ˜è…¾å®Œäº†ï¼Œå‘ç°é›†ç¾¤è¯ä¹¦å§‹ç»ˆæ˜¯ 1 å¹´æœ‰æ•ˆæœŸï¼Œç„¶åè‡ªå·±è¿˜æœ‰ç‚¹å­æ‹…å¿ƒï¼›æ— å¥ˆåªèƒ½ç ”ç©¶ä¸€ä¸‹æºç ä¸€æ¢ç©¶ç«Ÿäº†â€¦&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€è¯ä¹¦ç®¡ç†&quot;&gt;ä¸€ã€è¯ä¹¦ç®¡ç†&lt;/h2&gt;

&lt;p&gt;kubeadm é›†ç¾¤å®‰è£…å®Œæˆåï¼Œè¯ä¹¦ç®¡ç†ä¸Šå®é™…ä¸Šå¤§è‡´æ˜¯ä¸¤å¤§ç±»å‹:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;è‡ªåŠ¨æ»šåŠ¨ç»­æœŸ&lt;/li&gt;
  &lt;li&gt;æ‰‹åŠ¨å®šæœŸç»­æœŸ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è‡ªåŠ¨æ»šåŠ¨ç»­æœŸç±»å‹çš„è¯ä¹¦ç›®å‰ä»æˆ‘æ‰€é˜…è¯»æ–‡æ¡£å’Œå®é™…æµ‹è¯•ä¸­ç›®å‰åªæœ‰ kubelet çš„ client è¯ä¹¦ï¼›kubelet client è¯ä¹¦è‡ªåŠ¨æ»šåŠ¨æ¶‰åŠåˆ°äº† &lt;a href=&quot;https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping/&quot;&gt;TLS bootstrapping&lt;/a&gt; éƒ¨ä»½ï¼Œ&lt;strong&gt;å…¶æ ¸å¿ƒç”±ä¸¤ä¸ª ClusterRole å®Œæˆ(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;system:certificates.k8s.io:certificatesigningrequests:nodeclient&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;system:certificates.k8s.io:certificatesigningrequests:selfnodeclient&lt;/code&gt;)ï¼Œé’ˆå¯¹è¿™ä¸¤ä¸ª ClusterRole kubeadm åœ¨å¼•å¯¼æœŸé—´åˆ›å»ºäº† &lt;a href=&quot;https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/#create-a-bootstrap-token&quot;&gt;bootstrap token&lt;/a&gt; æ¥å®Œæˆå¼•å¯¼æœŸé—´è¯ä¹¦ç­¾å‘(è¯¥ Token 24h å¤±æ•ˆ)ï¼Œåç»­é€šè¿‡é¢„å…ˆåˆ›å»ºçš„ ClusterRoleBinding(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm:node-autoapprove-bootstrap&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm:node-autoapprove-certificate-rotation&lt;/code&gt;) å®Œæˆè‡ªåŠ¨çš„ node è¯ä¹¦ç»­æœŸï¼›&lt;/strong&gt;kubelet client è¯ä¹¦ç»­æœŸéƒ¨ä»½æ¶‰åŠåˆ° TLS bootstrapping å¤ªå¤šäº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ä»”ç»†æŸ¥çœ‹(æœ€åè¿˜æ˜¯å‹æƒ…æé†’: &lt;strong&gt;ç”¨ kubeadm ä¸€å®šè¦çœ‹çœ‹ &lt;a href=&quot;https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details&quot;&gt;Implementation details&lt;/a&gt;&lt;/strong&gt;)ã€‚&lt;/p&gt;

&lt;p&gt;æ‰‹åŠ¨ç»­æœŸçš„è¯ä¹¦ç›®å‰éœ€è¦åœ¨åˆ°æœŸå‰ä½¿ç”¨ kubeadm å‘½ä»¤è‡ªè¡Œç»­æœŸï¼Œè¿™äº›è¯ä¹¦ç›®å‰å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ—å‡º&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ä¸è¦åœ¨æ„æˆ‘çš„è¯ä¹¦è¿‡æœŸæ—¶é—´æ˜¯ 10 å¹´ï¼Œä¸‹é¢ä¼šè¯´&lt;/span&gt;
k1.node âœ kubeadm alpha certs check-expiration
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;check-expiration] Reading configuration from the cluster...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;check-expiration] FYI: You can look at this config file with &lt;span class=&quot;s1&quot;&gt;'kubectl -n kube-system get cm kubeadm-config -oyaml'&lt;/span&gt;

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Dec 06, 2029 20:58 UTC   9y                                      no
apiserver                  Dec 06, 2029 20:59 UTC   9y              ca                      no
apiserver-kubelet-client   Dec 06, 2029 20:59 UTC   9y              ca                      no
controller-manager.conf    Dec 06, 2029 20:59 UTC   9y                                      no
front-proxy-client         Dec 06, 2029 20:59 UTC   9y              front-proxy-ca          no
scheduler.conf             Dec 06, 2029 20:59 UTC   9y                                      no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Jan 13, 2030 08:45 UTC   9y              no
front-proxy-ca          Jan 13, 2030 08:45 UTC   9y              no
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;äºŒè¯ä¹¦æœŸé™è°ƒæ•´&quot;&gt;äºŒã€è¯ä¹¦æœŸé™è°ƒæ•´&lt;/h2&gt;

&lt;p&gt;ä¸Šé¢å·²ç»æåˆ°äº†ï¼Œæ‰‹åŠ¨ç®¡ç†éƒ¨ä»½çš„è¯ä¹¦éœ€è¦è‡ªå·±ç”¨å‘½ä»¤ç»­ç­¾(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm alpha certs renew all&lt;/code&gt;)ï¼Œè€Œä¸”ä½ ä¼šå‘ç°ç»­ç­¾ä»¥åæœ‰æ•ˆæœŸè¿˜æ˜¯ 1 å¹´ï¼›kubeadm çš„åˆè¡·æ˜¯ &lt;strong&gt;â€œä¸ºå¿«é€Ÿåˆ›å»º kubernetes é›†ç¾¤çš„æœ€ä½³å®è·µâ€&lt;/strong&gt;ï¼Œå½“ç„¶æœ€ä½³å®è·µåŒ…å«ç¡®ä¿è¯ä¹¦å®‰å…¨æ€§ï¼Œæ¯•ç«Ÿ Letâ€™s Encrypt çš„è¯ä¹¦æœ‰æ•ˆæœŸåªæœ‰ 3 ä¸ªæœˆçš„æƒ…å†µä¸‹ kubeadm æœ‰æ•ˆæœŸæœ‰ 1 å¹´å·²ç»å¾ˆä¸é”™äº†ï¼›ä½†æ˜¯å¯¹äºæœ€ä½³å®è·µæ¥è¯´ï¼Œæˆ‘ä»¬å…¬å¸çš„é›†ç¾¤å®‰å…¨æ€§å¹¶ä¸éœ€è¦é‚£ä¹ˆé«˜ï¼Œä¸€å¹´ç»­æœŸä¸€æ¬¡æ— ç–‘åœ¨å¢åŠ è¿ç»´äººå‘˜å¿ƒæ™ºè´Ÿæ‹…(å®ƒå¹¶ä¸æœ€ä½³)ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿«åˆ‡éœ€è¦ä¸€ç§ â€œä¸€åŠ³æ°¸é€¸â€ çš„è§£å†³æ–¹æ¡ˆï¼›å½“ç„¶æˆ‘ç›®å‰èƒ½æƒ³åˆ°çš„å°±æ˜¯æ‰¾åˆ°è¯ä¹¦ç­¾å‘æ—¶åœ¨å“ªè®¾ç½®çš„æœ‰æ•ˆæœŸï¼Œç„¶åæƒ³åŠæ³•æ”¹æ‰å®ƒã€‚&lt;/p&gt;

&lt;h3 id=&quot;21æºç åˆ†æ&quot;&gt;2.1ã€æºç åˆ†æ&lt;/h3&gt;

&lt;p&gt;ç›®å‰é€šè¿‡å®è§‚è§’åº¦çœ‹æ•´ä¸ª kubeadm é›†ç¾¤æ­å»ºè¿‡ç¨‹ï¼Œå…¶ä¸­æ¶‰åŠåˆ°è¯ä¹¦ç­¾ç½²å¤§è‡´æœ‰ä¸¤å¤§éƒ¨ä»½: init  é˜¶æ®µå’ŒåæœŸ renewï¼Œä¸‹é¢å¼€å§‹åˆ†æä¸¤ä¸ªé˜¶æ®µçš„æºç &lt;/p&gt;

&lt;h4 id=&quot;211init-é˜¶æ®µ&quot;&gt;2.1.1ã€init é˜¶æ®µ&lt;/h4&gt;

&lt;p&gt;ç”±äº kubernetes æ•´ä¸ªå‘½ä»¤è¡Œéƒ½æ˜¯é€šè¿‡ cobra åº“æ„å»ºçš„ï¼Œé‚£ä¹ˆæ ¹æ®è¿™ä¸ªåº“çš„ä¹ æƒ¯é¦–å…ˆç›´æ¥ä» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cmd&lt;/code&gt; åŒ…å¼€å§‹ç¿»ï¼Œè€Œ kubernetes æºç ç»„ç»‡çš„åˆæ¯”è¾ƒæ¸…æ™°è¿›è€Œç›´æ¥å®šä½åˆ° kubeadm å‘½ä»¤åŒ…ä¸‹é¢ï¼›æ¥ç€æ‰“å¼€ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;app&lt;/code&gt; ç›®å½•ä¸€çœ¼å°±çœ‹åˆ°äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;phases&lt;/code&gt;â€¦ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;phases&lt;/code&gt; é¡¾åæ€ä¹‰å•Šï¼Œæ•´ä¸ª init éƒ½æ˜¯é€šè¿‡ä¸åŒçš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;phases&lt;/code&gt; å®Œæˆçš„ï¼Œé‚£ä¹ˆç›´æ¥å» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;phases&lt;/code&gt; åŒ…ä¸‹é¢æ‰¾è¯ä¹¦é˜¶æ®µçš„æºç æ—¢å¯&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/ssdo7.jpg&quot; alt=&quot;init_source&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿›å…¥åˆ°è¿™ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;certs.go&lt;/code&gt; é‡Œé¢ï¼Œç›´æ¥åˆ—å‡ºæ‰€æœ‰æ–¹æ³•ï¼Œgo çš„è§„èŒƒé‡Œåªæœ‰é¦–å­—æ¯å¤§å†™æ‰ä¼šè¢«æš´éœ²å‡ºå»ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥æŸ¥çœ‹è¿™äº›æ–¹æ³•åæ—¢å¯ï¼›ä»åå­—ä¸Šå¾ˆè½»æ¾çš„çœ‹åˆ°äº†è¿™ä¸ªæ–¹æ³•â€¦åŸºæœ¬ä¸Šå°±æ˜¯å®ƒäº†&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/uoqx4.jpg&quot; alt=&quot;certs.go&quot; /&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡è¿™ä¸ªæ–¹æ³•çš„ä»£ç ä¼šå‘ç°æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;certSpec.CreateFromCA(cfg, caCert, caKey)&lt;/code&gt;ï¼Œé‚£ä¹ˆæ¥ç€çœ‹çœ‹è¿™ä¸ªæ–¹æ³•&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/psrho.jpg&quot; alt=&quot;pkiutil.NewCertAndKey&quot; /&gt;&lt;/p&gt;

&lt;p&gt;é€šè¿‡è¿™ä¸ªæ–¹æ³•ç»§ç»­å¾€ä¸‹ç¿»å‘ç°è°ƒç”¨äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pkiutil.NewCertAndKey(caCert, caKey, cfg)&lt;/code&gt;ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œæœ€ç»ˆè°ƒç”¨äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NewSignedCert(config, key, caCert, caKey)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/nel5u.jpg&quot; alt=&quot;NewSignedCert&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ä» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;NewSignedCert&lt;/code&gt; æ–¹æ³•é‡Œçœ‹åˆ°è¯ä¹¦æœ‰æ•ˆæœŸå®é™…ä¸Šæ˜¯ä¸ªå¸¸é‡ï¼Œ&lt;strong&gt;é‚£ä¹Ÿå°±æ„å‘³ç€æˆ‘æ”¹äº†è¿™ä¸ªå¸¸é‡ init é˜¶æ®µçš„è¯ä¹¦æœ‰æ•ˆæœŸå…«ä¹ä¸ç¦»åçš„å°±å˜äº†ï¼Œå†é€šè¿‡åŒ…åçœ‹è¿™ä¸ªæ˜¯ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pkiutil&lt;/code&gt;â€¦ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xxxxxutil&lt;/code&gt; æ˜æ˜¾æ˜¯å…¬å…±çš„ï¼Œæ‰€ä»¥æ¨æµ‹æ”¹äº†å®ƒ renew é˜¶æ®µåº”è¯¥ä¹Ÿä¼šå˜&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/t3amy.jpg&quot; alt=&quot;CertificateValidity&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;212renew-é˜¶æ®µ&quot;&gt;2.1.2ã€renew é˜¶æ®µ&lt;/h4&gt;

&lt;p&gt;renew é˜¶æ®µä¹Ÿæ˜¯è€å¥—è·¯ï¼Œä¸è¿‡ç¨³å¦¥ç‚¹å…ˆä» cmd æ‰¾èµ·æ¥ï¼Œæ‰€ä»¥å…ˆçœ‹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;alpha&lt;/code&gt; åŒ…ä¸‹çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;certs.go&lt;/code&gt;ï¼›è¿™æ—¶å€™æ–¹æ³•åè¯­ä¹‰æ¸…æ™°å°±å¾ˆæœ‰å¥½å¤„ï¼Œä¸€ä¸‹å°±èƒ½æ‰¾åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;newCmdCertsRenewal&lt;/code&gt; æ–¹æ³•&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/amupo.jpg&quot; alt=&quot;alpha_certs.go&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è€Œè¿™ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;newCmdCertsRenewal&lt;/code&gt; æ–¹æ³•å®é™…ä¸Šæ²¡å•¥å®ç°ï¼Œæ‰€ä»¥ç›®æµ‹å®ç°æ˜¯ä» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;getRenewSubCommands&lt;/code&gt; å®ç°çš„&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/8c38y.jpg&quot; alt=&quot;getRenewSubCommands&quot; /&gt;&lt;/p&gt;

&lt;p&gt;çœ‹äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;getRenewSubCommands&lt;/code&gt; ä»¥åå‘ç°ä¸Šé¢å…¨æ˜¯å‘½ä»¤è¡Œåº“ã€é…ç½®æ–‡ä»¶å‚æ•°å•¥çš„å¤„ç†ï¼Œæ ¸å¿ƒåœ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;renewCert&lt;/code&gt; ä¸Šï¼Œä»è¿™ä¸ªæ–¹æ³•é‡Œå‘ç°è¿˜æœ‰æ„å¤–æ”¶è·: &lt;strong&gt;renew æ—¶å®é™…ä¸Šåˆ†ä¸¤ç§æƒ…å†µå¤„ç†ï¼Œä¸€ç§æ˜¯ä½¿ç”¨äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--use-api&lt;/code&gt; é€‰é¡¹ï¼Œå¦ä¸€ç§æ˜¯æœªä½¿ç”¨&lt;/strong&gt;ï¼›å½“ç„¶æ ¹æ®ä¸Šé¢çš„å‘½ä»¤æ¥è¯´æˆ‘ä»¬æ²¡ä½¿ç”¨ï¼Œé‚£ä¹ˆçœ‹ else éƒ¨ä»½å°±è¡Œäº†(æ²¡çœ‹æºç ä¹‹å‰æˆ‘ç‰¹ä¹ˆå±…ç„¶æ²¡çœ‹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--help&lt;/code&gt; ä¸çŸ¥é“æœ‰è¿™ä¸ªé€‰é¡¹)&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/9zsgp.jpg&quot; alt=&quot;renewCert&quot; /&gt;&lt;/p&gt;

&lt;p&gt;else éƒ¨ä»½æºç æœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RenewUsingLocalCA&lt;/code&gt; æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸€ç›´å¾€ä¸‹è·Ÿä¼šæœ‰ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Renew&lt;/code&gt; æ–¹æ³•&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/s3a5c.jpg&quot; alt=&quot;Renew&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™ä¸ªæ–¹æ³•ä¸€ç‚¹è¿›å»â€¦ &lt;strong&gt;æˆ‘ä¸Šé¢çš„æƒ³æ³•æ˜¯å¯¹çš„&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/08cnb.jpg&quot; alt=&quot;FileRenewer_Renew&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;213å…¶ä»–æ¨æµ‹&quot;&gt;2.1.3ã€å…¶ä»–æ¨æµ‹&lt;/h4&gt;

&lt;p&gt;æ ¹æ®åˆšåˆšæŸ¥çœ‹ä»£ç å¯ä»¥çœ‹åˆ°åœ¨ renew é˜¶æ®µåˆ¤æ–­äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--use-api&lt;/code&gt; é€‰é¡¹æ˜¯å¦ä½¿ç”¨ï¼Œé€šè¿‡è·Ÿè¸ªæºç å‘ç°æœ€ç»ˆä¼šè°ƒç”¨åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RenewUsingCSRAPI&lt;/code&gt; æ–¹æ³•ä¸Šï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RenewUsingCSRAPI&lt;/code&gt; ä¼šè°ƒç”¨é›†ç¾¤ CSR Api æ‰§è¡Œè¯ä¹¦ç­¾ç½²&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/xivs9.png&quot; alt=&quot;RenewUsingCSRAPI&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æœ‰äº†è¿™ä¸ªå‘ç°ååŸºæœ¬ä¸Šå¯ä»¥æ¨æµ‹å‡ºè¿™ä¸€æ­¥é€šè¿‡é›†ç¾¤å®Œæˆï¼Œé‚£ä¹ˆæŒ‰ç†è¯´æ˜¯åº”è¯¥å—åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-controller-manager&lt;/code&gt; ç»„ä»¶çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--experimental-cluster-signing-duration&lt;/code&gt; å½±å“ã€‚&lt;/p&gt;

&lt;h3 id=&quot;22æµ‹è¯•éªŒè¯&quot;&gt;2.2ã€æµ‹è¯•éªŒè¯&lt;/h3&gt;

&lt;h4 id=&quot;221éªŒè¯ä¿®æ”¹æºç &quot;&gt;2.2.1ã€éªŒè¯ä¿®æ”¹æºç &lt;/h4&gt;

&lt;p&gt;æƒ³éªŒè¯ä¿®æ”¹æºç æ˜¯å¦æœ‰æ•ˆåªéœ€è¦ä¿®æ”¹æºç é‡æ–° build å‡º kubeadm å‘½ä»¤ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªç‰¹å®šç‰ˆæœ¬çš„ kubeadm renew è¯ä¹¦æµ‹è¯•æ—¢å¯ï¼Œæºç è°ƒæ•´çš„ä½ç½®å¦‚ä¸‹&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/qaavr.png&quot; alt=&quot;update_source&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ç„¶åå‘½ä»¤è¡Œä¸‹æ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make cross&lt;/code&gt; è¿›è¡Œè·¨å¹³å°äº¤å‰ç¼–è¯‘(å¦‚æœè¿‡ä½ åœ¨ linux amd64 å¹³å°ä¸‹åˆ™ç›´æ¥ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; æ—¢å¯)&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;âœ  kubernetes git:&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;v1.17.4&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; âœ— make cross
&lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt;: /proc/meminfo: No such file or directory
&lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt;: /proc/meminfo: No such file or directory
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] Multiple platforms requested and available 64G &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; threshold 40G, building platforms &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;parallel
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] Building go targets &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;linux/amd64 linux/arm linux/arm64 linux/s390x linux/ppc64le&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;parallel &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;output will appear &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;a burst when &lt;span class=&quot;nb&quot;&gt;complete&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;:
    cmd/kube-proxy
    cmd/kube-apiserver
    cmd/kube-controller-manager
    cmd/kubelet
    cmd/kubeadm
    cmd/kube-scheduler
    vendor/k8s.io/apiextensions-apiserver
    cluster/gce/gci/mounter
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] linux/amd64: build started
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:24] linux/amd64: build finished
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] linux/arm: build started
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:23] linux/arm: build finished
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] linux/arm64: build started
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:23] linux/arm64: build finished
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] linux/s390x: build started
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:24] linux/s390x: build finished
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:43:19] linux/ppc64le: build started
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:24] linux/ppc64le: build finished
&lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt;: /proc/meminfo: No such file or directory
&lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt;: /proc/meminfo: No such file or directory
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:52] Multiple platforms requested and available 64G &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; threshold 40G, building platforms &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;parallel
+++ &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;0116 23:47:52] Building go targets &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;linux/amd64 linux/arm
&lt;span class=&quot;c&quot;&gt;# ... çœç•¥ç¼–è¯‘æ—¥å¿—&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç¼–è¯‘å®Œæˆåèƒ½å¤Ÿåœ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;_output/local/bin/linux/amd64&lt;/code&gt; ä¸‹æ‰¾åˆ°åˆšåˆšç¼–è¯‘æˆåŠŸçš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt; æ–‡ä»¶ï¼Œå°†ç¼–è¯‘å¥½çš„ kubeadm scp åˆ°å·²ç»å­˜åœ¨é›†ç¾¤ä¸Šæ‰§è¡Œ renewï¼Œç„¶åæŸ¥çœ‹è¯ä¹¦æ—¶é—´&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/i3laa.png&quot; alt=&quot;kubeadm_renew&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;ç»è¿‡æµ‹è¯•åç¡®è®¤æºç ä¿®æ”¹æ–¹å¼æœ‰æ•ˆ&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;222éªŒè¯è°ƒæ•´-csr-api&quot;&gt;2.2.2ã€éªŒè¯è°ƒæ•´ CSR API&lt;/h4&gt;

&lt;p&gt;æ ¹æ®æ¨æµ‹å½“ä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--use-api&lt;/code&gt; ä¼šå—åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-controller-manager&lt;/code&gt; ç»„ä»¶çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--experimental-cluster-signing-duration&lt;/code&gt; å½±å“ï¼Œä»è€Œä»é›†ç¾¤ä¸­ä¸‹å‘è¯ä¹¦ï¼›æ‰€ä»¥é¦–å…ˆåœ¨å¯åŠ¨é›†ç¾¤æ—¶éœ€è¦å°† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--experimental-cluster-signing-duration&lt;/code&gt; è°ƒæ•´ä¸º 10 å¹´ï¼Œç„¶åå†è¿›è¡Œæµ‹è¯•&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;controllerManager&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;extraArgs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;node-cidr-mask-size&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;19&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;deployment-controller-sync-period&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10s&quot;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# åœ¨ kubeadm é…ç½®æ–‡ä»¶ä¸­è®¾ç½®è¯ä¹¦æœ‰æ•ˆæœŸä¸º 10 å¹´&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;experimental-cluster-signing-duration&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;86700h&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;node-monitor-grace-period&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;20s&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;pod-eviction-timeout&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2m&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;terminated-pod-gc-threshold&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;30&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç„¶åä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--use-api&lt;/code&gt; é€‰é¡¹è¿›è¡Œ renew&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm alpha certs renew all &lt;span class=&quot;nt&quot;&gt;--use-api&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ­¤æ—¶ä¼šå‘ç°æ—¥å¿—ä¸­æ‰“å°å‡º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;[certs] Certificate request &quot;kubeadm-cert-kubernetes-admin-648w4&quot; created&lt;/code&gt; å­—æ ·ï¼Œæ¥ä¸‹æ¥ä» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-system&lt;/code&gt; çš„ namespace ä¸­èƒ½å¤Ÿçœ‹åˆ°ç›¸å…³ csr&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/54awl.png&quot; alt=&quot;list_csr&quot; /&gt;&lt;/p&gt;

&lt;p&gt;è¿™æ—¶æˆ‘ä»¬å¼€å§‹æ‰‹åŠ¨æ‰¹å‡†è¯ä¹¦ï¼Œæ¯æ¬¡æ‰¹å‡†å®Œæˆä¸€ä¸ª csrï¼Œç´§æ¥ç€ kubeadm ä¼šåˆ›å»ºå¦ä¸€ä¸ª csr&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/tdde7.png&quot; alt=&quot;approve_csr&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å½“æ‰€æœ‰ csr è¢«æ‰¹å‡†åï¼Œå†æ¬¡æŸ¥çœ‹é›†ç¾¤è¯ä¹¦å‘ç°è¯ä¹¦æœŸé™ç¡®å®è¢«è°ƒæ•´äº†&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/081qe.png&quot; alt=&quot;success&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰æ€»ç»“&quot;&gt;ä¸‰ã€æ€»ç»“&lt;/h2&gt;

&lt;p&gt;æ€»ç»“ä¸€ä¸‹ï¼Œè°ƒæ•´ kubeadm è¯ä¹¦æœŸé™æœ‰ä¸¤ç§æ–¹æ¡ˆï¼›ç¬¬ä¸€ç§ç›´æ¥ä¿®æ”¹æºç ï¼Œè€—æ—¶è€—åŠ›è¿˜å¾—ä¼š goï¼Œæœ€åè¿˜è¦è·‘è·¨å¹³å°ç¼–è¯‘(å¾ˆè€—æ—¶)ï¼›ç¬¬äºŒç§åœ¨å¯åŠ¨é›†ç¾¤æ—¶è°ƒæ•´ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-controller-manager&lt;/code&gt; ç»„ä»¶çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--experimental-cluster-signing-duration&lt;/code&gt; å‚æ•°ï¼Œé›†ç¾¤åˆ›å»ºå¥½åæ‰‹åŠ¨ renew ä¸€ä¸‹å¹¶æ‰¹å‡†ç›¸å…³ csrã€‚&lt;/p&gt;

&lt;p&gt;ä¸¤ç§æ–¹æ¡ˆå„æœ‰åˆ©å¼Šï¼Œä¿®æ”¹æºç æ–¹å¼æ„å‘³ç€åœ¨ client ç«¯ç­¾å‘å¤„ç†ï¼Œä¸ä¼šå¯¹é›†ç¾¤äº§ç”Ÿæ°¸ä¹…æ€§å½±å“ï¼Œä¹Ÿå°±æ˜¯è¯´å“ªå¤©ä½ æƒ³ â€œåæ‚”äº†â€ ä½ ä¸éœ€è¦ä¿®æ”¹é›†ç¾¤ä»€ä¹ˆé…ç½®ï¼Œç›´æ¥ç”¨å®˜æ–¹ kubeadm renew ä¸€ä¸‹å°±ä¼šå˜å›ä¸€å¹´æœŸé™çš„è¯ä¹¦ï¼›æ”¹é›†ç¾¤å‚æ•°å®ç°çš„æ–¹å¼æ„å‘³ç€ä½ ä¸éœ€è¦æ‡‚ go ä»£ç ï¼Œåªéœ€è¦å¸¸è§„çš„é›†ç¾¤é…ç½®æ—¢å¯å®ç°ï¼ŒåŒæ—¶ä½ ä¹Ÿä¸éœ€è¦è·‘å‡ ååˆ†é’Ÿçš„äº¤å‰ç¼–è¯‘ï¼Œä¸éœ€è¦ä¸ºç¼–è¯‘è¿‡ç¨‹ä¸­çš„ç½‘ç»œé—®é¢˜è€Œçƒ¦æ¼ï¼›æ‰€ä»¥æœ€åä½¿ç”¨å“ªç§æ–¹æ¡ˆå› äººå› æƒ…å†µè€Œå®šå§ã€‚&lt;/p&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 21 Jan 2020 21:38:01 +0800</pubDate>
        <link>https://mritd.me/2020/01/21/how-to-extend-the-validity-of-your-kubeadm-certificate/</link>
        <guid isPermaLink="true">https://mritd.me/2020/01/21/how-to-extend-the-validity-of-your-kubeadm-certificate/</guid>
        
        <category>Kubernetes</category>
        
        
        <category>Kubernetes</category>
        
      </item>
    
      <item>
        <title>kubeadm é›†ç¾¤å‡çº§</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;çœŸæ˜¯ä¸å·§ï¼ŒåˆšæŠ˜è…¾å®Œ kubeadm æ­å»ºé›†ç¾¤(v1.17.0)ï¼Œç¬¬äºŒå¤©æ—©ä¸Šé†’æ¥ç‰¹ä¹ˆçš„ v1.17.1 å‘å¸ƒäº†ï¼›è¿™æˆ‘èƒ½å¿ä¹ˆï¼Œè‚¯å®šä¸èƒ½å¿ï¼Œç„¶åå°±å¼€å§‹äº†é›†ç¾¤å‡çº§ä¹‹è·¯â€¦&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€å‡çº§å‰å‡†å¤‡&quot;&gt;ä¸€ã€å‡çº§å‰å‡†å¤‡&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;ç¡®ä¿ä½ çš„é›†ç¾¤æ˜¯ kubeadm æ­å»ºçš„(ç­‰åŒäºåºŸè¯)&lt;/li&gt;
  &lt;li&gt;ç¡®ä¿å½“å‰é›†ç¾¤å·²ç»å®Œæˆ HA(å¤šä¸ª master èŠ‚ç‚¹)&lt;/li&gt;
  &lt;li&gt;ç¡®ä¿åœ¨å¤œæ·±äººé™çš„æ—¶å€™(æ— å¤§é‡ä¸šåŠ¡æµé‡)&lt;/li&gt;
  &lt;li&gt;ç¡®ä¿é›†ç¾¤ç‰ˆæœ¬å¤§äº v1.16.0&lt;/li&gt;
  &lt;li&gt;ç¡®ä¿å·²ç»ä»”ç»†é˜…è¯»äº†ç›®æ ‡ç‰ˆæœ¬ CHANGELOG&lt;/li&gt;
  &lt;li&gt;ç¡®ä¿åšå¥½äº†å®Œæ•´åœ°é›†ç¾¤å¤‡ä»½&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;äºŒå‡çº§æ³¨æ„äº‹é¡¹&quot;&gt;äºŒã€å‡çº§æ³¨æ„äº‹é¡¹&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;å‡çº§åæ‰€æœ‰é›†ç¾¤ç»„ä»¶ Pod ä¼šé‡å¯(hash å˜æ›´)&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;å‡çº§æ—¶ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt; ç‰ˆæœ¬å¿…é¡»å¤§äºæˆ–ç­‰äºç›®æ ‡ç‰ˆæœ¬&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;å‡çº§æœŸé—´æ‰€æœ‰ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-proxy&lt;/code&gt; ç»„ä»¶ä¼šæœ‰ä¸€æ¬¡å…¨èŠ‚ç‚¹æ»šåŠ¨æ›´æ–°&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;å‡çº§åªæ”¯æŒé¡ºæ¬¡è¿›è¡Œï¼Œä¸æ”¯æŒè·¨ç‰ˆæœ¬å‡çº§(You only can upgrade from one MINOR version to the next MINOR version, or between PATCH versions of the same MINOR. That is, you cannot skip MINOR versions when you upgrade. For example, you can upgrade from 1.y to 1.y+1, but not from 1.y to 1.y+2.)&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å…³äºå‡çº§ç‰ˆæœ¬é—®é¢˜â€¦è™½ç„¶æ˜¯è¿™ä¹ˆè¯´çš„ï¼Œä½†æ˜¯å®˜æ–¹æ–‡æ¡£æ ·ä¾‹ä»£ç é‡Œæ˜¯ä» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;v1.16.0&lt;/code&gt; å‡çº§åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;v1.17.0&lt;/code&gt;ï¼›å¯èƒ½æ˜¯æˆ‘ç†è§£æœ‰è¯¯ï¼Œè·¨å¤§ç‰ˆæœ¬å‡çº§å¥½åƒå®˜æ–¹æ²¡æï¼Œå…·ä½“å•¥åæœä¸æ¸…æ¥šâ€¦&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰å‡çº§-master&quot;&gt;ä¸‰ã€å‡çº§ Master&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;äº‹å®ä¸Šæ‰€æœ‰å‡çº§å·¥ä½œä¸»è¦æ˜¯é’ˆå¯¹ master èŠ‚ç‚¹åšçš„ï¼Œæ‰€ä»¥æ•´ä¸ªå‡çº§æµç¨‹ä¸­æœ€é‡è¦çš„æ˜¯å¦‚ä½•æŠŠ master å‡çº§å¥½ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;31å‡çº§-kubeadmkubectl&quot;&gt;3.1ã€å‡çº§ kubeadmã€kubectl&lt;/h3&gt;

&lt;p&gt;é¦–å…ˆç”±äºå‡çº§é™åˆ¶ï¼Œå¿…é¡»å…ˆå°† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl&lt;/code&gt; å‡çº§åˆ°å¤§äºç­‰äºç›®æ ‡ç‰ˆæœ¬&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# replace x in 1.17.x-00 with the latest patch version&lt;/span&gt;
apt-mark unhold kubeadm kubectl
apt-get update
apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;kubeadm&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1.17.x-00 &lt;span class=&quot;nv&quot;&gt;kubectl&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1.17.x-00
apt-mark hold kubeadm kubectl
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å½“ç„¶å¦‚æœä½ ä¹‹å‰æ²¡æœ‰ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hold&lt;/code&gt; ä½è¿™å‡ ä¸ªè½¯ä»¶åŒ…çš„ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;unhold&lt;/code&gt;ï¼›æˆ‘çš„åšæ³•å¯èƒ½æ¯”è¾ƒæç«¯â€¦ä¸€èˆ¬ä¸ºäº†é˜²æ­¢åé¢çš„è¯¯å‡çº§å®‰è£…å®Œæˆåæˆ‘ä¼šç›´æ¥ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rename&lt;/code&gt; æ‰ç›¸å…³è½¯ä»¶åŒ…çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apt source&lt;/code&gt; é…ç½®(ä»æ ¹æœ¬ä¸Šé˜²æ­¢æ‰‹è´±)ã€‚&lt;/p&gt;

&lt;h3 id=&quot;32å‡çº§å‰å‡†å¤‡&quot;&gt;3.2ã€å‡çº§å‰å‡†å¤‡&lt;/h3&gt;

&lt;h4 id=&quot;321é…ç½®ä¿®æ”¹&quot;&gt;3.2.1ã€é…ç½®ä¿®æ”¹&lt;/h4&gt;

&lt;p&gt;å¯¹äºé«˜çº§ç©å®¶ä¸€èˆ¬å®‰è£…é›†ç¾¤æ—¶éƒ½ä¼šè‡ªå®šä¹‰å¾ˆå¤šç»„ä»¶å‚æ•°ï¼Œæ­¤æ—¶ä¸å¯é¿å…çš„ä¼šé‡‡ç”¨é…ç½®æ–‡ä»¶ï¼›æ‰€ä»¥å®‰è£…å®Œæ–°ç‰ˆæœ¬çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt; åå°±è¦ç€æ‰‹ä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubernetesVersion&lt;/code&gt; å­—æ®µä¸ºç›®æ ‡é›†ç¾¤ç‰ˆæœ¬ï¼Œå½“ç„¶æœ‰å…¶ä»–å˜æ›´ä¹Ÿå¯ä»¥ä¸€èµ·ä¿®æ”¹ã€‚&lt;/p&gt;

&lt;h4 id=&quot;322èŠ‚ç‚¹é©±é€&quot;&gt;3.2.2ã€èŠ‚ç‚¹é©±é€&lt;/h4&gt;

&lt;p&gt;å¦‚æœä½ çš„ master èŠ‚ç‚¹ä¹Ÿå½“ä½œ node åœ¨è·‘ä¸€äº›å·¥ä½œè´Ÿè½½ï¼Œåˆ™éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤é©±é€è¿™äº› pod å¹¶ä½¿èŠ‚ç‚¹è¿›å…¥ç»´æŠ¤æ¨¡å¼(ç¦æ­¢è°ƒåº¦)ã€‚&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# å°† NODE_NAME æ¢æˆ Master èŠ‚ç‚¹åç§°&lt;/span&gt;
kubectl drain NODE_NAME &lt;span class=&quot;nt&quot;&gt;--ignore-daemonsets&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;323æŸ¥çœ‹å‡çº§è®¡åˆ’&quot;&gt;3.2.3ã€æŸ¥çœ‹å‡çº§è®¡åˆ’&lt;/h4&gt;

&lt;p&gt;å®ŒæˆèŠ‚ç‚¹é©±é€ä»¥åï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å‡çº§è®¡åˆ’ï¼›&lt;strong&gt;å‡çº§è®¡åˆ’ä¸­åˆ—å‡ºäº†å‡çº§æœŸé—´è¦æ‰§è¡Œçš„æ‰€æœ‰æ­¥éª¤ä»¥åŠç›¸å…³è­¦å‘Šï¼Œä¸€å®šè¦ä»”ç»†æŸ¥çœ‹ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;k8s16.node âœ  ~ kubeadm upgrade plan &lt;span class=&quot;nt&quot;&gt;--config&lt;/span&gt; /etc/kubernetes/kubeadm.yaml
W0115 10:59:52.586204     983 validation.go:28] Cannot validate kube-proxy config - no validator is available
W0115 10:59:52.586241     983 validation.go:28] Cannot validate kubelet config - no validator is available
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upgrade/config] Making sure the configuration is correct:
W0115 10:59:52.605458     983 common.go:94] WARNING: Usage of the &lt;span class=&quot;nt&quot;&gt;--config&lt;/span&gt; flag &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;reconfiguring the cluster during upgrade is not recommended!
W0115 10:59:52.607258     983 validation.go:28] Cannot validate kube-proxy config - no validator is available
W0115 10:59:52.607274     983 validation.go:28] Cannot validate kubelet config - no validator is available
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;preflight] Running pre-flight checks.
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upgrade] Making sure the cluster is healthy:
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upgrade] Fetching available versions to upgrade to
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upgrade/versions] Cluster version: v1.17.0
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upgrade/versions] kubeadm version: v1.17.1

External components that should be upgraded manually before you upgrade the control plane with &lt;span class=&quot;s1&quot;&gt;'kubeadm upgrade apply'&lt;/span&gt;:
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.18    3.4.3-0

Components that must be upgraded manually after you have upgraded the control plane with &lt;span class=&quot;s1&quot;&gt;'kubeadm upgrade apply'&lt;/span&gt;:
COMPONENT   CURRENT       AVAILABLE
Kubelet     5 x v1.17.0   v1.17.1

Upgrade to the latest version &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the v1.17 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.17.0   v1.17.1
Controller Manager   v1.17.0   v1.17.1
Scheduler            v1.17.0   v1.17.1
Kube Proxy           v1.17.0   v1.17.1
CoreDNS              1.6.5     1.6.5

You can now apply the upgrade by executing the following &lt;span class=&quot;nb&quot;&gt;command&lt;/span&gt;:

        kubeadm upgrade apply v1.17.1

_____________________________________________________________________
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;33æ‰§è¡Œå‡çº§&quot;&gt;3.3ã€æ‰§è¡Œå‡çº§&lt;/h3&gt;

&lt;p&gt;ç¡®è®¤å¥½å‡çº§è®¡åˆ’ä»¥åï¼Œåªéœ€è¦ä¸€æ¡å‘½ä»¤æ—¢å¯å°†å½“å‰ master èŠ‚ç‚¹å‡çº§åˆ°ç›®æ ‡ç‰ˆæœ¬&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm upgrade apply v1.17.1 &lt;span class=&quot;nt&quot;&gt;--config&lt;/span&gt; /etc/kubernetes/kubeadm.yaml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å‡çº§æœŸé—´ä¼šæ‰“å°å¾ˆè¯¦ç»†çš„æ—¥å¿—ï¼Œåœ¨æ—¥å¿—ä¸­å¯ä»¥å®æ—¶è§‚å¯Ÿåˆ°å‡çº§æµç¨‹ï¼Œå»ºè®®ä»”ç»†å…³æ³¨å‡çº§æµç¨‹ï¼›&lt;strong&gt;åœ¨æœ€åä¸€æ­¥ä¼šæœ‰ä¸€æ¡æ—¥å¿— &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;[addons] Applied essential addon: kube-proxy&lt;/code&gt;ï¼Œè¿™æ„å‘³ç€é›†ç¾¤å¼€å§‹æ›´æ–° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-proxy&lt;/code&gt; ç»„ä»¶ï¼Œè¯¥ç»„ä»¶ç›®å‰æ˜¯é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;daemonset&lt;/code&gt; æ–¹å¼å¯åŠ¨çš„ï¼›è¿™ä¼šæ„å‘³ç€æ­¤æ—¶ä¼šé€ æˆå…¨èŠ‚ç‚¹çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-proxy&lt;/code&gt; æ›´æ–°ï¼›&lt;/strong&gt;ç†è®ºä¸Šä¸ä¼šæœ‰å¾ˆå¤§å½±å“ï¼Œä½†æ˜¯å‡çº§æ˜¯è¿˜æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸‹è¿™ä¸€æ­¥æ“ä½œï¼Œåœ¨æˆ‘çš„è§‚å¯Ÿä¸­ä¼¼ä¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-proxy&lt;/code&gt; ä¹Ÿæ˜¯é€šè¿‡æ»šåŠ¨æ›´æ–°å®Œæˆçš„ï¼Œæ‰€ä»¥é—®é¢˜åº”è¯¥ä¸å¤§ã€‚&lt;/p&gt;

&lt;h3 id=&quot;34å‡çº§-kubelet&quot;&gt;3.4ã€å‡çº§ kubelet&lt;/h3&gt;

&lt;p&gt;åœ¨å•ä¸ª master ä¸Šå‡çº§å®Œæˆåï¼Œ&lt;strong&gt;åªä¼šå‡çº§æœ¬èŠ‚ç‚¹çš„ master ç›¸å…³ç»„ä»¶å’Œå…¨èŠ‚ç‚¹çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kube-proxy&lt;/code&gt; ç»„ä»¶ï¼›&lt;/strong&gt;ç”±äº kubelet æ˜¯åœ¨å®¿ä¸»æœºå®‰è£…çš„ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡åŒ…ç®¡ç†å™¨æ‰‹åŠ¨å‡çº§ kubelet&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# replace x in 1.17.x-00 with the latest patch version&lt;/span&gt;
apt-mark unhold kubelet
apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;kubelet&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1.17.x-00
apt-mark hold kubelet
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ›´æ–°å®Œæˆåæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemctl restart kubelet&lt;/code&gt; é‡å¯ï¼Œå¹¶ç­‰å¾…å¯åŠ¨æˆåŠŸæ—¢å¯ï¼›æœ€åä¸è¦å¿˜è®°è§£é™¤å½“å‰èŠ‚ç‚¹çš„ç»´æŠ¤æ¨¡å¼(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;uncordon&lt;/code&gt;)ã€‚&lt;/p&gt;

&lt;h3 id=&quot;35å‡çº§å…¶ä»–-master&quot;&gt;3.5ã€å‡çº§å…¶ä»– Master&lt;/h3&gt;

&lt;p&gt;å½“å…¶ä¸­ä¸€ä¸ª master èŠ‚ç‚¹å‡çº§å®Œæˆåï¼Œå…¶ä»–çš„ master å‡çº§å°±ä¼šç›¸å¯¹ç®€å•çš„å¤šï¼›&lt;strong&gt;é¦–å…ˆå›½é™…æƒ¯ä¾‹å‡çº§ä¸€ä¸‹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl&lt;/code&gt; è½¯ä»¶åŒ…ï¼Œç„¶åç›´æ¥åœ¨å…¶ä»– master èŠ‚ç‚¹æ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm upgrade node&lt;/code&gt; æ—¢å¯ã€‚&lt;/strong&gt;ç”±äº apiserver ç­‰ç»„ä»¶é…ç½®å·²ç»åœ¨å‡çº§ç¬¬ä¸€ä¸ª master æ—¶ä¸Šä¼ åˆ°äº†é›†ç¾¤çš„ configMap ä¸­ï¼Œæ‰€ä»¥äº‹å®ä¸Šå…¶ä»– master èŠ‚ç‚¹åªæ˜¯æ­£å¸¸æ‹‰å–ç„¶åé‡å¯ç›¸å…³ç»„ä»¶æ—¢å¯ï¼›è¿™ä¸€æ­¥åŒæ ·ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œå¯ä»¥ä»”ç»†è§‚å¯Ÿè¿›åº¦ï¼Œ&lt;strong&gt;æœ€åä¸è¦å¿˜è®°å‡çº§ä¹‹å‰å…ˆè¿›å…¥ç»´æŠ¤æ¨¡å¼ï¼Œå‡çº§å®Œæˆåé‡æ–°å®‰è£… &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; å¹¶å…³é—­èŠ‚ç‚¹ç»´æŠ¤æ¨¡å¼ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;h2 id=&quot;å››å‡çº§-node&quot;&gt;å››ã€å‡çº§ Node&lt;/h2&gt;

&lt;p&gt;node èŠ‚ç‚¹çš„å‡çº§å®é™…ä¸Šåœ¨å‡çº§å®Œ master èŠ‚ç‚¹ä»¥åä¸éœ€è¦ä»€ä¹ˆç‰¹æ®Šæ“ä½œï¼Œnode èŠ‚ç‚¹å”¯ä¸€éœ€è¦å‡çº§çš„å°±æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; ç»„ä»¶ï¼›&lt;strong&gt;é¦–å…ˆåœ¨ node èŠ‚ç‚¹æ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm upgrade node&lt;/code&gt; å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ä¼šæ‹‰å–é›†ç¾¤å†…çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡æ–°å®‰è£… &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; é‡å¯æ—¢å¯ï¼›&lt;/strong&gt;åŒæ ·å‡çº§ node èŠ‚ç‚¹æ—¶ä¸è¦å¿˜è®°å¼€å¯ç»´æŠ¤æ¨¡å¼ã€‚é’ˆå¯¹äº CNI ç»„ä»¶è¯·æŒ‰éœ€æ‰‹åŠ¨å‡çº§ï¼Œå¹¶ä¸”ç¡®è®¤å¥½ CNI ç»„ä»¶çš„å…¼å®¹ç‰ˆæœ¬ã€‚&lt;/p&gt;

&lt;h2 id=&quot;äº”éªŒè¯é›†ç¾¤&quot;&gt;äº”ã€éªŒè¯é›†ç¾¤&lt;/h2&gt;

&lt;p&gt;æ‰€æœ‰ç»„ä»¶å‡çº§å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl describe POD_NAME&lt;/code&gt; çš„æ–¹å¼éªŒè¯ master ç»„ä»¶æ˜¯å¦éƒ½å‡çº§åˆ°äº†æœ€æ–°ç‰ˆæœ¬ï¼›é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kuebctl version&lt;/code&gt; å‘½ä»¤éªŒè¯ api ç›¸å…³ä¿¡æ¯(HA rr è½®è®­æ¨¡å¼ä¸‹å¯ä»¥å¤šæ‰§è¡Œå‡ é)ï¼›è¿˜æœ‰å°±æ˜¯é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl get node -o wide&lt;/code&gt; æŸ¥çœ‹ç›¸å…³ node çš„ä¿¡æ¯ï¼Œç¡®ä¿ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; éƒ½å‡çº§æˆåŠŸï¼ŒåŒæ—¶å…¨éƒ¨èŠ‚ç‚¹ç»´æŠ¤æ¨¡å¼éƒ½å·²ç»å…³é—­ï¼Œå…¶ä»–ç»†èŠ‚å¯ä»¥å‚è€ƒ&lt;a href=&quot;https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;ã€‚&lt;/p&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 21 Jan 2020 21:34:38 +0800</pubDate>
        <link>https://mritd.me/2020/01/21/how-to-upgrade-kubeadm-cluster/</link>
        <guid isPermaLink="true">https://mritd.me/2020/01/21/how-to-upgrade-kubeadm-cluster/</guid>
        
        <category>Kubernetes</category>
        
        
        <category>Kubernetes</category>
        
      </item>
    
      <item>
        <title>kubeadm æ­å»º HA kubernetes é›†ç¾¤</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;è·ç¦»ä¸Šä¸€æ¬¡æŠ˜è…¾ kubeadm å¤§çº¦å·²ç»ä¸€ä¸¤å¹´äº†(è®°ä¸å¤ªæ¸…äº†)ï¼Œåœ¨å¾ˆä¹…ä¸€æ®µæ—¶é—´å†…ä¸€ç›´é‡‡ç”¨äºŒè¿›åˆ¶éƒ¨ç½²çš„æ–¹å¼æ¥éƒ¨ç½² kubernetes é›†ç¾¤ï¼Œéšç€ kubeadm çš„ä¸æ–­ç¨³å®šï¼Œç›®å‰ç»ˆäºå¯ä»¥é‡æ–°è¯•è¯•è¿™ä¸ªä¸é”™çš„å·¥å…·äº†&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€ç¯å¢ƒå‡†å¤‡&quot;&gt;ä¸€ã€ç¯å¢ƒå‡†å¤‡&lt;/h2&gt;

&lt;p&gt;æ­å»ºç¯å¢ƒä¸º 5 å°è™šæ‹Ÿæœºï¼Œæ¯å°è™šæ‹Ÿæœºé…ç½®ä¸º 4 æ ¸å¿ƒ 8G å†…å­˜ï¼Œè™šæ‹Ÿæœº IP èŒƒå›´ä¸º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;172.16.10.21~25&lt;/code&gt;ï¼Œå…¶ä»–è½¯ä»¶é…ç½®å¦‚ä¸‹&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;os version: ubuntu 18.04&lt;/li&gt;
  &lt;li&gt;kubeadm version: 1.17.0&lt;/li&gt;
  &lt;li&gt;kubernetes version: 1.17.0&lt;/li&gt;
  &lt;li&gt;etcd version: 3.3.18&lt;/li&gt;
  &lt;li&gt;docker version: 19.03.5&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;äºŒha-æ–¹æ¡ˆ&quot;&gt;äºŒã€HA æ–¹æ¡ˆ&lt;/h2&gt;

&lt;p&gt;ç›®å‰çš„ HA æ–¹æ¡ˆä¸å®˜æ–¹çš„ä¸åŒï¼Œå®˜æ–¹ HA æ–¹æ¡ˆæ¨èä½¿ç”¨ç±»ä¼¼ haproxy ç­‰å·¥å…·è¿›è¡Œ 4 å±‚ä»£ç† apiserverï¼Œä½†æ˜¯åŒæ ·ä¼šæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬è¿˜éœ€è¦å¯¹è¿™ä¸ª haproxy åš HAï¼›ç”±äºç›®å‰æˆ‘ä»¬å®é™…ç”Ÿäº§ç¯å¢ƒéƒ½æ˜¯å¤šä¸ªç‹¬ç«‹çš„å°é›†ç¾¤ï¼Œæ‰€ä»¥å•ç‹¬å¼„ 2 å° haproxy + keeplived å»ç»´æŒè¿™ä¸ª apiserver LB çš„ HA æœ‰ç‚¹ä¸åˆ’ç®—ï¼›æ‰€ä»¥è¿˜æ˜¯å‡†å¤‡å»¶ç»­è€çš„ HA æ–¹æ¡ˆï¼Œå°†å¤–éƒ¨ apiserver çš„ 4 å±‚ LB å‰ç½®åˆ°æ¯ä¸ª node èŠ‚ç‚¹ä¸Šï¼›&lt;strong&gt;ç›®å‰æ˜¯é‡‡ç”¨åœ¨æ¯ä¸ª node èŠ‚ç‚¹ä¸Šéƒ¨ç½² nginx 4 å±‚ä»£ç†æ‰€æœ‰ apiserverï¼Œnginx æœ¬èº«èµ„æºæ¶ˆè€—ä½è€Œä¸”è¯·æ±‚é‡ä¸å¤§ï¼Œç»¼åˆæ¥è¯´å¯¹å®¿ä¸»æœºå½±å“å¾ˆå°ï¼›&lt;/strong&gt;ä»¥ä¸‹ä¸º HA çš„å¤§è‡´æ–¹æ¡ˆå›¾&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/mktld.png&quot; alt=&quot;ha&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰ç¯å¢ƒåˆå§‹åŒ–&quot;&gt;ä¸‰ã€ç¯å¢ƒåˆå§‹åŒ–&lt;/h2&gt;

&lt;h3 id=&quot;31ç³»ç»Ÿç¯å¢ƒ&quot;&gt;3.1ã€ç³»ç»Ÿç¯å¢ƒ&lt;/h3&gt;

&lt;p&gt;ç”±äºä¸ªäººæ“ä½œä¹ æƒ¯åŸå› ï¼Œç›®å‰å·²ç»å°†å¸¸ç”¨çš„åˆå§‹åŒ–ç¯å¢ƒæ•´ç†åˆ°ä¸€ä¸ªå°è„šæœ¬é‡Œäº†ï¼Œè„šæœ¬å…·ä½“å‚è§ &lt;a href=&quot;https://github.com/mritd/shell_scripts/blob/master/init_ubuntu.sh&quot;&gt;mritd/shell_scripts&lt;/a&gt; ä»“åº“ï¼ŒåŸºæœ¬ä¸Šå¸¸ç”¨çš„åˆå§‹åŒ–å†…å®¹ä¸º:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;è®¾ç½® locale(en_US.UTF-8)&lt;/li&gt;
  &lt;li&gt;è®¾ç½®æ—¶åŒº(Asia/Shanghai)&lt;/li&gt;
  &lt;li&gt;æ›´æ–°æ‰€æœ‰ç³»ç»Ÿè½¯ä»¶åŒ…(system update)&lt;/li&gt;
  &lt;li&gt;é…ç½® vim(vim8 + å¸¸ç”¨æ’ä»¶ã€é…è‰²)&lt;/li&gt;
  &lt;li&gt;ohmyzsh(åˆ«è·Ÿæˆ‘è¯´ä¸å…¼å®¹ bash è„šæœ¬ï¼Œæˆ‘å°±æ˜¯å–œæ¬¢)&lt;/li&gt;
  &lt;li&gt;docker&lt;/li&gt;
  &lt;li&gt;ctop(ä¸€ä¸ª docker çš„è¾…åŠ©å·¥å…·)&lt;/li&gt;
  &lt;li&gt;docker-compose&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;åœ¨ä»¥ä¸Šåˆå§‹åŒ–ä¸­ï¼Œå®é™…å¯¹ kubernetes å®‰è£…äº§ç”Ÿå½±å“çš„ä¸»è¦æœ‰ä¸‰ä¸ªåœ°æ–¹:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;docker çš„ cgroup driver è°ƒæ•´ä¸º systemdï¼Œå…·ä½“å‚è€ƒ &lt;a href=&quot;https://github.com/mritd/config/blob/master/docker/docker.service&quot;&gt;docker.service&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;docker ä¸€å®šè¦é™åˆ¶ conatiner æ—¥å¿—å¤§å°ï¼Œé˜²æ­¢ apiserver ç­‰æ—¥å¿—å¤§é‡è¾“å‡ºå¯¼è‡´ç£ç›˜å ç”¨è¿‡å¤§&lt;/strong&gt;&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;å®‰è£… &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;conntrack&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ipvsadm&lt;/code&gt;ï¼Œåé¢å¯èƒ½éœ€è¦å€ŸåŠ©å…¶æ’æŸ¥é—®é¢˜&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;32é…ç½®-ipvs&quot;&gt;3.2ã€é…ç½® ipvs&lt;/h3&gt;

&lt;p&gt;ç”±äºåé¢ kube-proxy éœ€è¦ä½¿ç”¨ ipvs æ¨¡å¼ï¼Œæ‰€ä»¥éœ€è¦å¯¹å†…æ ¸å‚æ•°ã€æ¨¡å—åšä¸€äº›è°ƒæ•´ï¼Œè°ƒæ•´å‘½ä»¤å¦‚ä¸‹:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/sysctl.conf &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF

&lt;/span&gt;sysctl &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/modules &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt;
ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;é…ç½®å®Œæˆååˆ‡è®°éœ€è¦é‡å¯ï¼Œé‡å¯å®Œæˆåä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lsmod | grep ip_vs&lt;/code&gt; éªŒè¯ç›¸å…³ ipvs æ¨¡å—åŠ è½½æ˜¯å¦æ­£å¸¸ï¼Œæœ¬æ–‡å°†ä¸»è¦ä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ip_vs_wrr&lt;/code&gt;ï¼Œæ‰€ä»¥ç›®å‰åªå…³æ³¨è¿™ä¸ªæ¨¡å—æ—¢å¯ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/4irz1.png&quot; alt=&quot;ipvs_mode&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;å››å®‰è£…-etcd&quot;&gt;å››ã€å®‰è£… Etcd&lt;/h2&gt;

&lt;h3 id=&quot;41æ–¹æ¡ˆé€‰æ‹©&quot;&gt;4.1ã€æ–¹æ¡ˆé€‰æ‹©&lt;/h3&gt;

&lt;p&gt;å®˜æ–¹å¯¹äºé›†ç¾¤ HA ç»™å‡ºäº†ä¸¤ç§æœ‰å…³äº Etcd çš„éƒ¨ç½²æ–¹æ¡ˆ:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;ä¸€ç§æ˜¯æ·±åº¦è€¦åˆåˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; ä¸Šï¼Œå³æ¯ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; ä¸€ä¸ª etcd&lt;/li&gt;
  &lt;li&gt;å¦ä¸€ç§æ˜¯ä½¿ç”¨å¤–éƒ¨çš„ Etcd é›†ç¾¤ï¼Œé€šè¿‡åœ¨é…ç½®ä¸­æŒ‡å®šå¤–éƒ¨é›†ç¾¤è®© apiserver ç­‰ç»„ä»¶è¿æ¥&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;åœ¨æµ‹è¯•æ·±åº¦è€¦åˆ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; æ–¹æ¡ˆåï¼Œå‘ç°ä¸€äº›æ¯”è¾ƒæ¶å¿ƒçš„é—®é¢˜ï¼›æ¯”å¦‚è¯´å¼€å§‹åˆ›å»ºç¬¬äºŒä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; æ—¶é…ç½®å†™é”™äº†éœ€è¦é‡å»ºï¼Œæ­¤æ—¶ä½ ä¸€æ—¦åˆ é™¤ç¬¬äºŒä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; ä¼šå¯¼è‡´ç¬¬ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; ä¹Ÿä¼šå¤±è´¥ï¼ŒåŸå› æ˜¯&lt;strong&gt;åˆ›å»ºç¬¬äºŒä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; æ—¶ kubeadm å·²ç»è‡ªåŠ¨å®Œæˆäº† etcd çš„é›†ç¾¤æ¨¡å¼ï¼Œå½“åˆ é™¤ç¬¬äºŒä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; çš„æ—¶å€™ç”±äºé›†ç¾¤å¯ç”¨åŸå› ä¼šå¯¼è‡´ç¬¬ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;control plane&lt;/code&gt; ä¸‹çš„ etcd å‘ç°èŠ‚ç‚¹å¤±è”ä»è€Œä¹Ÿä¸æä¾›æœåŠ¡ï¼›&lt;/strong&gt;æ‰€ä»¥ç»¼åˆè€ƒè™‘åˆ°åç»­è¿ç§»ã€ç¾å¤‡ç­‰å› ç´ ï¼Œè¿™é‡Œé€‰æ‹©äº†å°† etcd æ”¾ç½®åœ¨å¤–éƒ¨é›†ç¾¤ä¸­ï¼›åŒæ ·ä¹Ÿæ–¹ä¾¿æˆ‘ä»¥åå„ç§æŠ˜è…¾åº”å¯¹ä¸€äº›æç«¯æƒ…å†µå•¥çš„ã€‚&lt;/p&gt;

&lt;h3 id=&quot;42éƒ¨ç½²-etcd&quot;&gt;4.2ã€éƒ¨ç½² Etcd&lt;/h3&gt;

&lt;p&gt;ç¡®å®šäº†éœ€è¦åœ¨å¤–éƒ¨éƒ¨ç½² etcd é›†ç¾¤åï¼Œåªéœ€è¦å¼€å¹²å°±å®Œäº‹äº†ï¼›æŸ¥äº†ä¸€ä¸‹ ubuntu å®˜æ–¹æºå·²ç»æœ‰äº† etcd å®‰è£…åŒ…ï¼Œä½†æ˜¯ç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œæµ‹è¯•äº†ä¸€ä¸‹ golang çš„ build ç‰ˆæœ¬æ˜¯ 1.10ï¼›æ‰€ä»¥æˆ‘è¿˜æ˜¯é€‰æ‹©äº†ä»å®˜æ–¹ release ä¸‹è½½æœ€æ–°çš„ç‰ˆæœ¬å®‰è£…ï¼›å½“ç„¶æœ€åè¿˜æ˜¯å› ä¸ºæ‡’ï¼Œæˆ‘è‡ªå·±æ‰“äº†ä¸€ä¸ª deb åŒ…â€¦ deb åŒ…å¯ä»¥ä»è¿™ä¸ªé¡¹ç›® &lt;a href=&quot;https://github.com/mritd/etcd-deb/releases&quot;&gt;mritd/etcd-deb&lt;/a&gt; ä¸‹è½½ï¼Œæ‹…å¿ƒå®‰å…¨æ€§çš„å¯ä»¥åˆ©ç”¨é¡¹ç›®è„šæœ¬è‡ªå·±æ‰“åŒ…ï¼Œä»¥ä¸‹æ˜¯å®‰è£…è¿‡ç¨‹:&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ä¸‹è½½è½¯ä»¶åŒ…&lt;/span&gt;
wget https://github.com/mritd/etcd-deb/releases/download/v3.3.18/etcd_3.3.18_amd64.deb
wget https://github.com/mritd/etcd-deb/releases/download/v3.3.18/cfssl_1.4.1_amd64.deb
&lt;span class=&quot;c&quot;&gt;# å®‰è£… etcd(è‡³å°‘åœ¨ 3 å°èŠ‚ç‚¹ä¸Šæ‰§è¡Œ)&lt;/span&gt;
dpkg &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; etcd_3.3.18_amd64.deb cfssl_1.4.1_amd64.deb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;æ—¢ç„¶è‡ªå·±éƒ¨ç½² etcdï¼Œé‚£ä¹ˆè¯ä¹¦ç­¾ç½²å•¥çš„è¿˜å¾—è‡ªå·±æ¥äº†ï¼Œè¯ä¹¦ç­¾ç½²è¿™é‡Œå€ŸåŠ© cfssl å·¥å…·ï¼Œcfssl ç›®å‰æä¾›äº† deb çš„ make targetï¼Œä½†æ˜¯æ²¡æ‰¾åˆ° deb åŒ…ï¼Œæ‰€ä»¥ä¹Ÿè‡ªå·± build äº†(æ‹…å¿ƒå®‰å…¨æ€§çš„å¯è‡ªè¡Œå»å®˜æ–¹ä¸‹è½½)ï¼›&lt;/strong&gt;æ¥ç€ç¼–è¾‘ä¸€ä¸‹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/etcd/cfssl/etcd-csr.json&lt;/code&gt; æ–‡ä»¶ï¼Œç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/etcd/cfssl/create.sh&lt;/code&gt; è„šæœ¬åˆ›å»ºè¯ä¹¦ï¼Œå¹¶å°†è¯ä¹¦å¤åˆ¶åˆ°æŒ‡å®šç›®å½•&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# åˆ›å»ºè¯ä¹¦&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /etc/etcd/cfssl &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ./create.sh
&lt;span class=&quot;c&quot;&gt;# å¤åˆ¶è¯ä¹¦&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mv&lt;/span&gt; /etc/etcd/cfssl/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.pem /etc/etcd/ssl
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æœ€ååœ¨ 3 å°èŠ‚ç‚¹ä¸Šä¿®æ”¹é…ç½®ï¼Œå¹¶å°†åˆšåˆšåˆ›å»ºçš„è¯ä¹¦åŒæ­¥åˆ°å…¶ä»–ä¸¤å°èŠ‚ç‚¹å¯åŠ¨æ—¢å¯ï¼›ä¸‹é¢æ˜¯å•å°èŠ‚ç‚¹çš„é…ç½®æ ·ä¾‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# /etc/etcd/etcd.conf&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# [member]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;etcd1
&lt;span class=&quot;nv&quot;&gt;ETCD_DATA_DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/var/lib/etcd/data&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_WAL_DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/var/lib/etcd/wal&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_SNAPSHOT_COUNT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;100&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_HEARTBEAT_INTERVAL&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;100&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_ELECTION_TIMEOUT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;1000&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_LISTEN_PEER_URLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://172.16.10.21:2380&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_LISTEN_CLIENT_URLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://172.16.10.21:2379,http://127.0.0.1:2379&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_MAX_SNAPSHOTS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_MAX_WALS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_CORS=&quot;&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# [cluster]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_ADVERTISE_PEER_URLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://172.16.10.21:2380&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. &quot;test=http://...&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;etcd1=https://172.16.10.21:2380,etcd2=https://172.16.10.22:2380,etcd3=https://172.16.10.23:2380&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER_STATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;new&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_INITIAL_CLUSTER_TOKEN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;etcd-cluster&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_ADVERTISE_CLIENT_URLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;https://172.16.10.21:2379&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_DISCOVERY=&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_DISCOVERY_SRV=&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_DISCOVERY_FALLBACK=&quot;proxy&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_DISCOVERY_PROXY=&quot;&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_STRICT_RECONFIG_CHECK=&quot;false&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_AUTO_COMPACTION_RETENTION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;24&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# [proxy]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_PROXY=&quot;off&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_PROXY_FAILURE_WAIT=&quot;5000&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_PROXY_REFRESH_INTERVAL=&quot;30000&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_PROXY_DIAL_TIMEOUT=&quot;1000&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_PROXY_WRITE_TIMEOUT=&quot;5000&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_PROXY_READ_TIMEOUT=&quot;0&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# [security]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_CERT_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_KEY_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_CLIENT_CERT_AUTH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_TRUSTED_CA_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/etcd/ssl/etcd-root-ca.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_AUTO_TLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_PEER_CERT_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_PEER_KEY_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_PEER_CLIENT_CERT_AUTH&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_PEER_TRUSTED_CA_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/etc/etcd/ssl/etcd-root-ca.pem&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_PEER_AUTO_TLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# [logging]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_DEBUG=&quot;false&quot;&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# examples for -log-package-levels etcdserver=WARNING,security=DEBUG&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#ETCD_LOG_PACKAGE_LEVELS=&quot;&quot;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# [performance]&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_QUOTA_BACKEND_BYTES&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;5368709120&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ETCD_AUTO_COMPACTION_RETENTION&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;3&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;æ³¨æ„: å…¶ä»–ä¸¤å°èŠ‚ç‚¹è¯·è°ƒæ•´ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ETCD_NAME&lt;/code&gt; ä¸ºä¸é‡å¤çš„å…¶ä»–åç§°ï¼Œè°ƒæ•´ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ETCD_LISTEN_PEER_URLS&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ETCD_LISTEN_CLIENT_URLS&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ETCD_INITIAL_ADVERTISE_PEER_URLS&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ETCD_ADVERTISE_CLIENT_URLS&lt;/code&gt; ä¸ºå…¶ä»–èŠ‚ç‚¹å¯¹åº”çš„ IPï¼›åŒæ—¶ç”Ÿäº§ç¯å¢ƒè¯·å°† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ETCD_INITIAL_CLUSTER_TOKEN&lt;/code&gt; æ›¿æ¢ä¸ºå¤æ‚çš„ token&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# åŒæ­¥è¯ä¹¦&lt;/span&gt;
scp &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; /etc/etcd/ssl 172.16.10.22:/etc/etcd/ssl
scp &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt; /etc/etcd/ssl 172.16.10.23:/etc/etcd/ssl
&lt;span class=&quot;c&quot;&gt;# ä¿®å¤æƒé™(3å°èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; etcd:etcd /etc/etcd
&lt;span class=&quot;c&quot;&gt;# æœ€åæ¯ä¸ªèŠ‚ç‚¹ä¾æ¬¡å¯åŠ¨æ—¢å¯&lt;/span&gt;
systemctl start etcd
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¯åŠ¨å®Œæˆåå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æµ‹è¯•æ˜¯å¦æ­£å¸¸&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# æŸ¥çœ‹é›†ç¾¤æˆå‘˜&lt;/span&gt;
k1.node âœ etcdctl member list

3cbbaf77904c6153, started, etcd2, https://172.16.10.22:2380, https://172.16.10.22:2379
8eb7652b6bd99c30, started, etcd1, https://172.16.10.21:2380, https://172.16.10.21:2379
91f4e10726460d8c, started, etcd3, https://172.16.10.23:2380, https://172.16.10.23:2379

&lt;span class=&quot;c&quot;&gt;# æ£€æµ‹é›†ç¾¤å¥åº·çŠ¶æ€&lt;/span&gt;
k1.node âœ etcdctl endpoint health &lt;span class=&quot;nt&quot;&gt;--cacert&lt;/span&gt; /etc/etcd/ssl/etcd-root-ca.pem &lt;span class=&quot;nt&quot;&gt;--cert&lt;/span&gt; /etc/etcd/ssl/etcd.pem &lt;span class=&quot;nt&quot;&gt;--key&lt;/span&gt; /etc/etcd/ssl/etcd-key.pem &lt;span class=&quot;nt&quot;&gt;--endpoints&lt;/span&gt; https://172.16.10.21:2379,https://172.16.10.22:2379,https://172.16.10.23:2379

https://172.16.10.21:2379 is healthy: successfully committed proposal: took &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 16.632246ms
https://172.16.10.23:2379 is healthy: successfully committed proposal: took &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 21.122603ms
https://172.16.10.22:2379 is healthy: successfully committed proposal: took &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 22.592005ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;äº”éƒ¨ç½²-kubernetes&quot;&gt;äº”ã€éƒ¨ç½² Kubernetes&lt;/h2&gt;

&lt;h3 id=&quot;51å®‰è£…-kueadm&quot;&gt;5.1ã€å®‰è£… kueadm&lt;/h3&gt;

&lt;p&gt;å®‰è£… kubeadm æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå›½å†…è¢«å¢™ç”¨é˜¿é‡Œçš„æºæ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;apt-get &lt;span class=&quot;nb&quot;&gt;install&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt; apt-transport-https
curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF&lt;/span&gt;&lt;span class=&quot;sh&quot;&gt; &amp;gt;/etc/apt/sources.list.d/kubernetes.list
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;EOF
&lt;/span&gt;apt update

&lt;span class=&quot;c&quot;&gt;# ebtablesã€ethtool kubelet å¯èƒ½ä¼šç”¨ï¼Œå…·ä½“å¿˜äº†ï¼Œåæ­£ä»å®˜æ–¹æ–‡æ¡£ä¸Šçœ‹åˆ°çš„&lt;/span&gt;
apt &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;kubelet kubeadm kubectl ebtables ethtool &lt;span class=&quot;nt&quot;&gt;-y&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;52éƒ¨ç½²-nginx&quot;&gt;5.2ã€éƒ¨ç½² Nginx&lt;/h3&gt;

&lt;p&gt;ä»ä¸Šé¢çš„ HA æ¶æ„å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†ç»´æŒ apiserver çš„ HAï¼Œéœ€è¦åœ¨æ¯ä¸ªæœºå™¨ä¸Šéƒ¨ç½²ä¸€ä¸ª nginx åš 4 å±‚çš„ LBï¼›ä¸ºä¿è¯åç»­çš„ node èŠ‚ç‚¹æ­£å¸¸åŠ å…¥ï¼Œéœ€è¦é¦–å…ˆè¡Œéƒ¨ç½² nginxï¼›nginx å®‰è£…åŒæ ·å–œæ¬¢å·æ‡’ï¼Œç›´æ¥ docker è·‘äº†â€¦æ¯•ç«Ÿéƒ½å¼€å§‹ kubeadm äº†ï¼Œé‚£ä¹ˆä¹Ÿæ²¡å¿…è¦å»çº ç»“ docker æ˜¯å¦ç¨³å®šçš„é—®é¢˜äº†ï¼›ä»¥ä¸‹ä¸º nginx ç›¸å…³é…ç½®&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;apiserver-proxy.conf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;error_log stderr notice&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

worker_processes auto&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
events &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
	multi_accept on&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	use epoll&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
	worker_connections 1024&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

stream &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    upstream kube_apiserver &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        least_conn&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;c&quot;&gt;# åç«¯ä¸ºä¸‰å° master èŠ‚ç‚¹çš„ apiserver åœ°å€&lt;/span&gt;
        server 172.16.10.21:5443&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        server 172.16.10.22:5443&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        server 172.16.10.23:5443&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    
    server &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        listen        0.0.0.0:6443&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        proxy_pass    kube_apiserver&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        proxy_timeout 10m&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        proxy_connect_timeout 1s&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;kube-apiserver-proxy.service&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;kubernetes apiserver docker wrapper
&lt;span class=&quot;nv&quot;&gt;Wants&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;docker.socket
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;docker.service

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;root
&lt;span class=&quot;nv&quot;&gt;PermissionsStartOnly&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/docker run &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; 6443:6443 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                          &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; /etc/kubernetes/apiserver-proxy.conf:/etc/nginx/nginx.conf &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                          &lt;span class=&quot;nt&quot;&gt;--name&lt;/span&gt; kube-apiserver-proxy &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                          &lt;span class=&quot;nt&quot;&gt;--net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;host &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                          &lt;span class=&quot;nt&quot;&gt;--restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure:5 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                          &lt;span class=&quot;nt&quot;&gt;--memory&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512M &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
                          nginx:1.17.6-alpine
&lt;span class=&quot;nv&quot;&gt;ExecStartPre&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;-/usr/bin/docker &lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; kube-apiserver-proxy
&lt;span class=&quot;nv&quot;&gt;ExecStop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/bin/docker &lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; kube-apiserver-proxy
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;always
&lt;span class=&quot;nv&quot;&gt;RestartSec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;15s
&lt;span class=&quot;nv&quot;&gt;TimeoutStartSec&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;30s

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¯åŠ¨ nginx ä»£ç†(æ¯å°æœºå™¨éƒ½è¦å¯åŠ¨ï¼ŒåŒ…æ‹¬ master èŠ‚ç‚¹)&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;apiserver-proxy.conf /etc/kubernetes
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;kube-apiserver-proxy.service /lib/systemd/system
systemctl daemon-reload
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;kube-apiserver-proxy.service &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; systemctl start kube-apiserver-proxy.service
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;53å¯åŠ¨-control-plane&quot;&gt;5.3ã€å¯åŠ¨ control plane&lt;/h3&gt;

&lt;h4 id=&quot;531å…³äº-swap&quot;&gt;5.3.1ã€å…³äº Swap&lt;/h4&gt;

&lt;p&gt;ç›®å‰ kubelet ä¸ºäº†ä¿è¯å†…å­˜ limitï¼Œéœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå…³é—­ swapï¼›ä½†æ˜¯è¯´å®è¯æˆ‘çœ‹äº†è¿™ç¯‡æ–‡ç«  &lt;a href=&quot;https://chrisdown.name/2018/01/02/in-defence-of-swap.html&quot;&gt;In defence of swap: common misconceptions&lt;/a&gt; ä»¥åè¿˜æ˜¯ä¸æƒ³å…³é—­ swapï¼›æ›´ç¡®åˆ‡çš„è¯´å…¶å®æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒæ¯”è¾ƒ â€œå¯Œâ€ï¼Œpod éƒ½ä¸ limit å†…å­˜ï¼Œæ‰€ä»¥ä¸‹é¢çš„éƒ¨ç½²æˆ‘å¿½ç•¥äº† swap é”™è¯¯æ£€æµ‹&lt;/p&gt;

&lt;h4 id=&quot;532kubeadm-é…ç½®&quot;&gt;5.3.2ã€kubeadm é…ç½®&lt;/h4&gt;

&lt;p&gt;å½“å‰ç‰ˆæœ¬çš„ kubeadm å·²ç»æ”¯æŒäº†å®Œå–„çš„é…ç½®ç®¡ç†(å½“ç„¶ç»†èŠ‚éƒ¨åˆ†è¿˜æœ‰å¾…æ”¯æŒ)ï¼Œä»¥ä¸‹ä¸ºæˆ‘ç›®å‰ä½¿ç”¨çš„é…ç½®ï¼Œç›¸å…³ä½ç½®å·²ç»åšäº†æ³¨é‡Šï¼Œæ›´å…·ä½“çš„é…ç½®è‡ªè¡ŒæŸ¥é˜…å®˜æ–¹æ–‡æ¡£&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;kubeadm.yaml&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeadm.k8s.io/v1beta2&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;InitConfiguration&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;localAPIEndpoint&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ IP&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;advertiseAddress&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;172.16.10.21&quot;&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# 6443 ç•™ç»™äº† nginxï¼Œapiserver æ¢åˆ° 5443&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;bindPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5443&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# è¿™ä¸ª token ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# kubeadm alpha certs certificate-key&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;certificateKey&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;7373f829c733b46fb78f0069f90185e0f00254381641d8d5a7c5984b2cf17cd3&lt;/span&gt; 
&lt;span class=&quot;nn&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeadm.k8s.io/v1beta2&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;ClusterConfiguration&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ä½¿ç”¨å¤–éƒ¨ etcd é…ç½®&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;etcd&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;external&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;endpoints&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;https://172.16.10.21:2379&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;https://172.16.10.22:2379&quot;&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;https://172.16.10.23:2379&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;caFile&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/etcd/ssl/etcd-root-ca.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;certFile&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/etcd/ssl/etcd.pem&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;keyFile&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/etcd/ssl/etcd-key.pem&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ç½‘ç»œé…ç½®&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;networking&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;serviceSubnet&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10.25.0.0/16&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;podSubnet&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10.30.0.1/16&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;dnsDomain&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;cluster.local&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kubernetesVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;v1.17.0&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# å…¨å±€ apiserver LB åœ°å€ï¼Œç”±äºé‡‡ç”¨äº† nginx è´Ÿè½½ï¼Œæ‰€ä»¥ç›´æ¥æŒ‡å‘æœ¬åœ°æ—¢å¯&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;controlPlaneEndpoint&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;127.0.0.1:6443&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;apiServer&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# apiserver çš„è‡ªå®šä¹‰æ‰©å±•å‚æ•°&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;extraArgs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;alsologtostderr&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;true&quot;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# å®¡è®¡æ—¥å¿—ç›¸å…³é…ç½®&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;audit-log-maxage&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;20&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;audit-log-maxbackup&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;audit-log-maxsize&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;100&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;audit-log-path&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/kube-audit/audit.log&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;audit-policy-file&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/kubernetes/audit-policy.yaml&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;authorization-mode&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;Node,RBAC&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;event-ttl&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;720h&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;runtime-config&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;api/all=true&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;service-node-port-range&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;30000-50000&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;service-cluster-ip-range&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10.25.0.0/16&quot;&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# ç”±äºè‡ªè¡Œå®šä¹‰äº†å®¡è®¡æ—¥å¿—é…ç½®ï¼Œæ‰€ä»¥éœ€è¦å°†å®¿ä¸»æœºä¸Šçš„å®¡è®¡é…ç½®&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# æŒ‚è½½åˆ° kube-apiserver çš„ pod å®¹å™¨ä¸­&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;extraVolumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;audit-config&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;hostPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/kubernetes/audit-policy.yaml&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/kubernetes/audit-policy.yaml&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;readOnly&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;pathType&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;File&quot;&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;audit-log&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;hostPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/kube-audit&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;mountPath&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/kube-audit&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;pathType&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;DirectoryOrCreate&quot;&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# è¿™é‡Œæ˜¯ apiserver çš„è¯ä¹¦åœ°å€é…ç½®&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# ä¸ºäº†é˜²æ­¢ä»¥åå‡ºç‰¹æ®Šæƒ…å†µï¼Œæˆ‘å¢åŠ äº†ä¸€ä¸ªæ³›åŸŸå&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;certSANs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;*.kubernetes.node&quot;&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;172.16.10.21&quot;&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;172.16.10.22&quot;&lt;/span&gt;
  &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;172.16.10.23&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;timeoutForControlPlane&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5m&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;controllerManager&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;extraArgs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&quot;&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# å®¿ä¸»æœº ip æ©ç &lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;node-cidr-mask-size&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;19&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;deployment-controller-sync-period&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10s&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;experimental-cluster-signing-duration&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;87600h&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;node-monitor-grace-period&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;20s&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;pod-eviction-timeout&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2m&quot;&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;terminated-pod-gc-threshold&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;30&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;scheduler&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;extraArgs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;v&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;certificatesDir&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/etc/kubernetes/pki&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# gcr.io è¢«å¢™ï¼Œæ¢æˆå¾®è½¯çš„é•œåƒåœ°å€&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;imageRepository&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;gcr.azk8s.cn/google_containers&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;clusterName&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;kuberentes&quot;&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubelet.config.k8s.io/v1beta1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;KubeletConfiguration&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# kubelet specific options here&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# æ­¤é…ç½®ä¿è¯äº† kubelet èƒ½åœ¨ swap å¼€å¯çš„æƒ…å†µä¸‹å¯åŠ¨&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;failSwapOn&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;nodeStatusUpdateFrequency&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5s&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# ä¸€äº›é©±é€é˜€å€¼ï¼Œå…·ä½“è‡ªè¡ŒæŸ¥æ–‡æ¡£ä¿®æ”¹&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;evictionSoft&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;imagefs.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;15%&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;memory.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;512Mi&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nodefs.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;15%&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nodefs.inodesFree&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10%&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;evictionSoftGracePeriod&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;imagefs.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3m&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;memory.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1m&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nodefs.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3m&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nodefs.inodesFree&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1m&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;evictionHard&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;imagefs.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10%&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;memory.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256Mi&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nodefs.available&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10%&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;nodefs.inodesFree&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;5%&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;evictionMaxPodGracePeriod&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;30&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;imageGCLowThresholdPercent&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;70&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;imageGCHighThresholdPercent&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kubeReserved&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;cpu&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;500m&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;memory&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;512Mi&quot;&lt;/span&gt;
  &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;ephemeral-storage&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1Gi&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rotateCertificates&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;---&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;kubeproxy.config.k8s.io/v1alpha1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;KubeProxyConfiguration&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# kube-proxy specific options here&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;clusterCIDR&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10.30.0.1/16&quot;&lt;/span&gt;
&lt;span class=&quot;c1&quot;&gt;# å¯ç”¨ ipvs æ¨¡å¼&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;mode&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;ipvs&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;ipvs&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;minSyncPeriod&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5s&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;syncPeriod&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5s&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# ipvs è´Ÿè½½ç­–ç•¥&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;scheduler&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;wrr&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;å…³äºè¿™ä¸ªé…ç½®é…ç½®æ–‡ä»¶çš„æ–‡æ¡£è¿˜æ˜¯å¾ˆä¸å®Œå–„ï¼Œå¯¹äºä¸æ‡‚ golang çš„äººæ¥è¯´å¾ˆéš¾çŸ¥é“å…·ä½“æ€ä¹ˆé…ç½®ï¼Œä»¥ä¸‹åšä¸€ä¸‹ç®€è¦è¯´æ˜(è¯·ç¡®ä¿ä½ å·²ç»æ‹‰å–äº† kubernetes æºç å’Œå®‰è£…äº† Goland)&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;kubeadm é…ç½®ä¸­æ¯ä¸ªé…ç½®æ®µéƒ½ä¼šæœ‰ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kind&lt;/code&gt; å­—æ®µï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kind&lt;/code&gt; å®é™…ä¸Šå¯¹åº”äº† go ä»£ç ä¸­çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;struct&lt;/code&gt; ç»“æ„ä½“ï¼›åŒæ—¶ä» &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;apiVersion&lt;/code&gt; å­—æ®µä¸­èƒ½å¤Ÿçœ‹åˆ°å…·ä½“çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;v1alpha1&lt;/code&gt; ç­‰ï¼›æœ‰äº†è¿™ä¸¤ä¸ªä¿¡æ¯äº‹å®ä¸Šä½ å°±å¯ä»¥ç›´æ¥åœ¨æºç ä¸­å»æ‰¾åˆ°å¯¹åº”çš„ç»“æ„ä½“&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/dwo5h.png&quot; alt=&quot;struct_search&quot; /&gt;&lt;/p&gt;

&lt;p&gt;åœ¨ç»“æ„ä½“ä¸­æ‰€æœ‰çš„é…ç½®ä¾¿å¯ä»¥ä¸€ç›®äº†ç„¶&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://cdn.oss.link/markdown/0jc9b.png&quot; alt=&quot;struct_detail&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å…³äºæ•°æ®ç±»å‹ï¼Œå¦‚æœæ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;string&lt;/code&gt; çš„ç±»å‹ï¼Œé‚£ä¹ˆæ„å‘³ç€ä½ è¦åœ¨ yaml é‡Œå†™ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&quot;xxxx&quot;&lt;/code&gt; å¸¦å¼•å·è¿™ç§ï¼Œå½“ç„¶æœ‰äº›æ—¶å€™ä¸å†™èƒ½å…¼å®¹ï¼Œæœ‰äº›æ—¶å€™ä¸è¡Œæ¯”å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;extraArgs&lt;/code&gt; å­—æ®µæ˜¯ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;map[string]string&lt;/code&gt; å¦‚æœ value ä¸å¸¦å¼•å·å°±æŠ¥é”™ï¼›&lt;strong&gt;å¦‚æœæ•°æ®ç±»å‹ä¸º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;metav1.Duration&lt;/code&gt;(å®é™…ä¸Šå°±æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;time.Duration&lt;/code&gt;)ï¼Œé‚£ä¹ˆä½ çœ‹ç€å®ƒæ˜¯ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;int64&lt;/code&gt; ä½†å®é™…ä¸Šä½ è¦å†™ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;1h2m3s&lt;/code&gt; è¿™ç§äººç±»å¯è¯»çš„æ ¼å¼ï¼Œè¿™æ˜¯ go çš„ç‰¹è‰²â€¦&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;audit-policy.yaml&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# Log all requests at the Metadata level.&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;audit.k8s.io/v1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Policy&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;rules&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;level&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Metadata&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¯èƒ½ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Metadata&lt;/code&gt; çº§åˆ«çš„å®¡è®¡æ—¥å¿—æ¯”è¾ƒå¤šï¼Œæƒ³è‡ªè¡Œè°ƒæ•´å®¡è®¡æ—¥å¿—çº§åˆ«çš„å¯ä»¥å‚è€ƒ&lt;a href=&quot;https://kubernetes.io/docs/tasks/debug-application-cluster/audit/#audit-policy&quot;&gt;å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;533æ‹‰èµ·-control-plane&quot;&gt;5.3.3ã€æ‹‰èµ· control plane&lt;/h4&gt;

&lt;p&gt;æœ‰äº†å®Œæ•´çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm.yaml&lt;/code&gt; å’Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;audit-policy.yaml&lt;/code&gt; é…ç½®åï¼Œç›´æ¥ä¸€æ¡å‘½ä»¤æ‹‰èµ· control plane æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# å…ˆå°†å®¡è®¡é…ç½®æ”¾åˆ°ç›®æ ‡ä½ç½®(3 å° master éƒ½è¦æ‰§è¡Œ)&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;audit-policy.yaml /etc/kubernetes
&lt;span class=&quot;c&quot;&gt;# æ‹‰èµ· control plane&lt;/span&gt;
kubeadm init &lt;span class=&quot;nt&quot;&gt;--config&lt;/span&gt; kubeadm.yaml &lt;span class=&quot;nt&quot;&gt;--upload-certs&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--ignore-preflight-errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Swap
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;control plane æ‹‰èµ·ä»¥åæ³¨æ„è¦ä¿å­˜å±å¹•è¾“å‡ºï¼Œæ–¹ä¾¿åç»­æ·»åŠ å…¶ä»–é›†ç¾¤èŠ‚ç‚¹&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  &lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube
  &lt;span class=&quot;nb&quot;&gt;sudo cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
  &lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;:&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config

You should now deploy a pod network to the cluster.
Run &lt;span class=&quot;s2&quot;&gt;&quot;kubectl apply -f [podnetwork].yaml&quot;&lt;/span&gt; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;any number of the control-plane node running the following &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;on each as root:

  kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;127.0.0.1:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; r4t3l3.14mmuivm7xbtaeoj &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:06f49f1f29d08b797fbf04d87b9b0fd6095a4693e9b1d59c429745cfa082b31d &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--control-plane&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--certificate-key&lt;/span&gt; 7373f829c733b46fb78f0069f90185e0f00254381641d8d5a7c5984b2cf17cd3

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;two hours&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; If necessary, you can use
&lt;span class=&quot;s2&quot;&gt;&quot;kubeadm init phase upload-certs --upload-certs&quot;&lt;/span&gt; to reload certs afterward.

Then you can &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;any number of worker nodes by running the following on each as root:

kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;127.0.0.1:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; r4t3l3.14mmuivm7xbtaeoj &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:06f49f1f29d08b797fbf04d87b9b0fd6095a4693e9b1d59c429745cfa082b31d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;æ ¹æ®å±å¹•æç¤ºé…ç½® kubectl&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube
&lt;span class=&quot;nb&quot;&gt;sudo cp&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; /etc/kubernetes/admin.conf &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;span class=&quot;nb&quot;&gt;sudo chown&lt;/span&gt; &lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;:&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-g&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$HOME&lt;/span&gt;/.kube/config
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;54éƒ¨ç½²-cni&quot;&gt;5.4ã€éƒ¨ç½² CNI&lt;/h3&gt;

&lt;p&gt;å…³äºç½‘ç»œæ’ä»¶çš„é€‰æ‹©ï¼Œä»¥å‰ä¸€ç›´å–œæ¬¢ Calicoï¼Œå› ä¸ºå…¶æ€§èƒ½ç¡®å®å¥½ï¼›åˆ°åæ¥ flannel å‡ºäº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;host-gw&lt;/code&gt; ä»¥åç°åœ¨ä¸¤è€…æ€§èƒ½ä¹Ÿå·®ä¸å¤šäº†ï¼›ä½†æ˜¯ &lt;strong&gt;flannel å¥½å¤„æ˜¯ä¸€ä¸ªå·¥å…·é€šåƒæ‰€æœ‰ç¯å¢ƒ(äº‘ç¯å¢ƒ+è£¸æœº2å±‚ç›´é€š)ï¼Œåå¤„æ˜¯ flannel ç¼ºä¹æ¯”è¾ƒå¥½çš„ç­–ç•¥ç®¡ç†(å½“ç„¶å¯ä»¥ä½¿ç”¨ä¸¤è€…ç»“åˆçš„ Canal)ï¼›&lt;/strong&gt;åæ¥æ€æ¥æƒ³å»å…¶å®æˆ‘ä»¬ç”Ÿäº§å€’æ˜¯å¾ˆå°‘éœ€è¦ç­–ç•¥ç®¡ç†ï¼Œæ‰€ä»¥è¿™å›æ€‚å›åˆ° flannel äº†(é€ƒâ€¦)&lt;/p&gt;

&lt;p&gt;Flannel éƒ¨ç½²éå¸¸ç®€å•ï¼Œæ ¹æ®å®˜æ–¹æ–‡æ¡£ä¸‹è½½é…ç½®ï¼Œæ ¹æ®æƒ…å†µè°ƒæ•´ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backend&lt;/code&gt; å’Œ pod çš„ CIDRï¼Œç„¶å apply ä¸€ä¸‹æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ä¸‹è½½é…ç½®æ–‡ä»¶&lt;/span&gt;
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

&lt;span class=&quot;c&quot;&gt;# è°ƒæ•´ backend ä¸º host-gw(æµ‹è¯•ç¯å¢ƒ 2 å±‚ç›´è¿)&lt;/span&gt;
k1.node âœ  &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; 35 ConfigMap kube-flannel.yml
kind: ConfigMap
apiVersion: v1
metadata:
  name: kube-flannel-cfg
  namespace: kube-system
  labels:
    tier: node
    app: flannel
data:
  cni-conf.json: |
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;name&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;cbr0&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;cniVersion&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;0.3.1&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;plugins&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;flannel&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;delegate&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;hairpinMode&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;,
            &lt;span class=&quot;s2&quot;&gt;&quot;isDefaultGateway&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
        &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;s2&quot;&gt;&quot;type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;portmap&quot;&lt;/span&gt;,
          &lt;span class=&quot;s2&quot;&gt;&quot;capabilities&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;s2&quot;&gt;&quot;portMappings&quot;&lt;/span&gt;: &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
  net-conf.json: |
    &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;s2&quot;&gt;&quot;Network&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;10.30.0.0/16&quot;&lt;/span&gt;,
      &lt;span class=&quot;s2&quot;&gt;&quot;Backend&quot;&lt;/span&gt;: &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;s2&quot;&gt;&quot;Type&quot;&lt;/span&gt;: &lt;span class=&quot;s2&quot;&gt;&quot;host-gw&quot;&lt;/span&gt;
      &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# è°ƒæ•´å®Œæˆå apply ä¸€ä¸‹&lt;/span&gt;
kubectl apply &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt; kube-flannel.yml
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;55å¯åŠ¨å…¶ä»–-control-plane&quot;&gt;5.5ã€å¯åŠ¨å…¶ä»– control plane&lt;/h3&gt;

&lt;p&gt;ä¸ºäº†ä¿è¯ HA æ¶æ„ï¼Œè¿˜éœ€è¦åœ¨å¦å¤–ä¸¤å° master ä¸Šå¯åŠ¨ control planeï¼›&lt;strong&gt;åœ¨å¯åŠ¨ä¹‹å‰è¯·ç¡®ä¿å¦å¤–ä¸¤å° master èŠ‚ç‚¹èŠ‚ç‚¹ä¸Š &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/kubernetes/audit-policy.yaml&lt;/code&gt; å®¡è®¡é…ç½®å·²ç»åˆ†å‘å®Œæˆï¼Œç¡®ä¿ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;127.0.0.1:6443&lt;/code&gt; ä¸Šç›‘å¬çš„ 4 å±‚ LB å·¥ä½œæ­£å¸¸(å¯å°è¯•ä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;curl -k https://127.0.0.1:6443&lt;/code&gt; æµ‹è¯•)ï¼›&lt;/strong&gt;æ ¹æ®ç¬¬ä¸€ä¸ª control plane ç»ˆç«¯è¾“å‡ºï¼Œå…¶ä»– control plane åŠ å…¥å‘½ä»¤å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;127.0.0.1:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; r4t3l3.14mmuivm7xbtaeoj &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:06f49f1f29d08b797fbf04d87b9b0fd6095a4693e9b1d59c429745cfa082b31d &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--control-plane&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--certificate-key&lt;/span&gt; 7373f829c733b46fb78f0069f90185e0f00254381641d8d5a7c5984b2cf17cd3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;ç”±äºåœ¨ä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm join&lt;/code&gt; æ—¶ç›¸å…³é€‰é¡¹(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--discovery-token-ca-cert-hash&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--control-plane&lt;/code&gt;)æ— æ³•ä¸ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--config&lt;/code&gt; ä¸€èµ·ä½¿ç”¨ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¿…é¡»å¢åŠ ä¸€äº›é™„åŠ æŒ‡ä»¤æ¥æä¾› &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm.yaml&lt;/code&gt; é…ç½®æ–‡ä»¶ä¸­çš„ä¸€äº›å±æ€§&lt;/strong&gt;ï¼›æœ€ç»ˆå®Œæ•´çš„ control plane åŠ å…¥å‘½ä»¤å¦‚ä¸‹ï¼Œåœ¨å…¶ä»– master ç›´æ¥æ‰§è¡Œæ—¢å¯(&lt;strong&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--apiserver-advertise-address&lt;/code&gt; çš„ IP åœ°å€æ˜¯ç›®æ ‡ master çš„ IP&lt;/strong&gt;)&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;127.0.0.1:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; r4t3l3.14mmuivm7xbtaeoj &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:06f49f1f29d08b797fbf04d87b9b0fd6095a4693e9b1d59c429745cfa082b31d &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--control-plane&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--certificate-key&lt;/span&gt; 7373f829c733b46fb78f0069f90185e0f00254381641d8d5a7c5984b2cf17cd3 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--apiserver-advertise-address&lt;/span&gt; 172.16.10.22 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--apiserver-bind-port&lt;/span&gt; 5443 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--ignore-preflight-errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Swap 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;æ‰€æœ‰ control plane å¯åŠ¨å®Œæˆååº”å½“é€šè¿‡åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubectl get cs&lt;/code&gt; éªŒè¯å„ä¸ªç»„ä»¶è¿è¡ŒçŠ¶æ€&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;k2.node âœ kubectl get cs
NAME                 STATUS    MESSAGE             ERROR
scheduler            Healthy   ok
controller-manager   Healthy   ok
etcd-1               Healthy   &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;health&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
etcd-0               Healthy   &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;health&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
etcd-2               Healthy   &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;health&quot;&lt;/span&gt;:&lt;span class=&quot;s2&quot;&gt;&quot;true&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

k2.node âœ kubectl get node &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; wide
NAME      STATUS   ROLES    AGE   VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
k1.node   Ready    master   28m   v1.17.0   172.16.10.21   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
k2.node   Ready    master   10m   v1.17.0   172.16.10.22   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
k3.node   Ready    master   3m    v1.17.0   172.16.10.23   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;56å¯åŠ¨-node&quot;&gt;5.6ã€å¯åŠ¨ Node&lt;/h3&gt;

&lt;p&gt;node èŠ‚ç‚¹çš„å¯åŠ¨ç›¸è¾ƒäº master æ¥è¯´è¦ç®€å•å¾—å¤šï¼Œåªéœ€è¦å¢åŠ ä¸€ä¸ªé˜²æ­¢ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;swap&lt;/code&gt; å¼€å¯æ‹’ç»å¯åŠ¨çš„å‚æ•°æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;127.0.0.1:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; r4t3l3.14mmuivm7xbtaeoj &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:06f49f1f29d08b797fbf04d87b9b0fd6095a4693e9b1d59c429745cfa082b31d &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;--ignore-preflight-errors&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Swap
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¯åŠ¨æˆåŠŸååœ¨ master ä¸Šå¯ä»¥çœ‹åˆ°æ‰€æœ‰ node ä¿¡æ¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;k1.node âœ kubectl get node &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; wide
NAME      STATUS   ROLES    AGE     VERSION   INTERNAL-IP    EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
k1.node   Ready    master   32m     v1.17.0   172.16.10.21   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
k2.node   Ready    master   14m     v1.17.0   172.16.10.22   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
k3.node   Ready    master   6m35s   v1.17.0   172.16.10.23   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
k4.node   Ready    &amp;lt;none&amp;gt;   72s     v1.17.0   172.16.10.24   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
k5.node   Ready    &amp;lt;none&amp;gt;   66s     v1.17.0   172.16.10.25   &amp;lt;none&amp;gt;        Ubuntu 18.04.3 LTS   4.15.0-74-generic   docker://19.3.5
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;57è°ƒæ•´åŠæµ‹è¯•&quot;&gt;5.7ã€è°ƒæ•´åŠæµ‹è¯•&lt;/h3&gt;

&lt;p&gt;é›†ç¾¤æ­å»ºå¥½ä»¥åï¼Œå¦‚æœæƒ³è®© master èŠ‚ç‚¹ä¹Ÿå‚ä¸è°ƒåº¦ä»»åŠ¡ï¼Œéœ€è¦åœ¨ä»»æ„ä¸€å° master èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# node èŠ‚ç‚¹æŠ¥é”™å±äºæ­£å¸¸æƒ…å†µ&lt;/span&gt;
k1.node âœ kubectl taint nodes &lt;span class=&quot;nt&quot;&gt;--all&lt;/span&gt; node-role.kubernetes.io/master-
node/k1.node untainted
node/k2.node untainted
node/k3.node untainted
taint &lt;span class=&quot;s2&quot;&gt;&quot;node-role.kubernetes.io/master&quot;&lt;/span&gt; not found
taint &lt;span class=&quot;s2&quot;&gt;&quot;node-role.kubernetes.io/master&quot;&lt;/span&gt; not found
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æœ€ååˆ›å»ºä¸€ä¸ª deployment å’Œä¸€ä¸ª serviceï¼Œå¹¶åœ¨ä¸åŒä¸»æœºä¸Š ping pod IP æµ‹è¯•ç½‘ç»œè”é€šæ€§ï¼Œåœ¨ pod å†…ç›´æ¥ curl service åç§°æµ‹è¯• dns è§£ææ—¢å¯&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;test-nginx.deploy.yaml&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;apps/v1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Deployment&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;replicas&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;matchLabels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;template&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;labels&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;containers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;nginx:1.17.6-alpine&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;containerPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;test-nginx.svc.yaml&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;apiVersion&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;v1&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;kind&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;Service&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;metadata&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;spec&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;selector&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;test-nginx&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;protocol&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;TCP&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;targetPort&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;80&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;å…­åç»­å¤„ç†&quot;&gt;å…­ã€åç»­å¤„ç†&lt;/h2&gt;

&lt;blockquote&gt;
  &lt;p&gt;è¯´å®è¯ä½¿ç”¨ kubeadm åï¼Œæˆ‘æ›´å…³æ³¨çš„æ˜¯é›†ç¾¤åç»­çš„æ‰©å±•æ€§è°ƒæ•´æ˜¯å¦èƒ½è¾¾åˆ°ç›®æ ‡ï¼›æ­å»ºå…¶å®å¾ˆç®€å•ï¼Œå¤§éƒ¨ä»½æ—¶é—´éƒ½åœ¨æµ‹è¯•åç»­è°ƒæ•´ä¸Š&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;61etcd-è¿ç§»&quot;&gt;6.1ã€Etcd è¿ç§»&lt;/h3&gt;

&lt;p&gt;ç”±äºæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯å¤–éƒ¨çš„ Etcdï¼Œæ‰€ä»¥è¿ç§»èµ·æ¥æ¯”è¾ƒç®€å•æ€ä¹ˆæŠ˜è…¾éƒ½è¡Œï¼›éœ€è¦æ³¨æ„çš„æ˜¯æ¢ IP çš„æ—¶å€™æ³¨æ„ä¿è¯è€çš„ 3 ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªå¯ç”¨ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´é›†ç¾¤å´©æºƒï¼›è°ƒæ•´å®Œæˆåè®°å¾—åˆ†å‘ç›¸å…³ Etcd èŠ‚ç‚¹çš„è¯ä¹¦ï¼Œé‡å¯æ—¶é¡ºåºä¸€ä¸ªä¸€ä¸ªé‡å¯ï¼Œä¸è¦å¹¶è¡Œæ“ä½œ&lt;/p&gt;

&lt;h3 id=&quot;62master-é…ç½®ä¿®æ”¹&quot;&gt;6.2ã€Master é…ç½®ä¿®æ”¹&lt;/h3&gt;

&lt;p&gt;å¦‚æœéœ€è¦ä¿®æ”¹ conrol plane ä¸Š apiserverã€scheduler ç­‰é…ç½®ï¼Œç›´æ¥ä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm.yaml&lt;/code&gt; é…ç½®æ–‡ä»¶(&lt;strong&gt;æ‰€ä»¥é›†ç¾¤æ­å»ºå¥½ååŠ¡å¿…ä¿å­˜å¥½&lt;/strong&gt;)ï¼Œç„¶åæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubeadm upgrade apply --config kubeadm.yaml&lt;/code&gt; å‡çº§é›†ç¾¤æ—¢å¯ï¼Œå‡çº§å‰ä¸€å®šä½œå¥½ç›¸å…³å¤‡ä»½å·¥ä½œï¼›æˆ‘åªåœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•è¿™ä¸ªå‘½ä»¤å·¥ä½œè¿˜å¯ä»¥ï¼Œç”Ÿäº§ç¯å¢ƒè¿˜æ˜¯éœ€è¦è°¨æ…&lt;/p&gt;

&lt;h3 id=&quot;63è¯ä¹¦ç»­æœŸ&quot;&gt;6.3ã€è¯ä¹¦ç»­æœŸ&lt;/h3&gt;

&lt;p&gt;ç›®å‰æ ¹æ®æˆ‘æµ‹è¯•çš„ç»“æœï¼Œcontroller manager çš„ &lt;strong&gt;experimental-cluster-signing-duration&lt;/strong&gt; å‚æ•°åœ¨ init çš„ç­¾å‘è¯ä¹¦é˜¶æ®µä¼¼ä¹å¹¶æœªç”Ÿæ•ˆï¼›&lt;strong&gt;ç›®å‰æ ¹æ®æ–‡æ¡£æè¿° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kubelet&lt;/code&gt; client çš„è¯ä¹¦ä¼šè‡ªåŠ¨æ»šåŠ¨ï¼Œå…¶ä»–è¯ä¹¦é»˜è®¤ 1 å¹´æœ‰æ•ˆæœŸï¼Œéœ€è¦è‡ªå·±ä½¿ç”¨å‘½ä»¤ç»­ç­¾ï¼›&lt;/strong&gt;ç»­ç­¾å‘½ä»¤å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# æŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´&lt;/span&gt;
k1.node âœ kubeadm alpha certs check-expiration
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;check-expiration] Reading configuration from the cluster...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;check-expiration] FYI: You can look at this config file with &lt;span class=&quot;s1&quot;&gt;'kubectl -n kube-system get cm kubeadm-config -oyaml'&lt;/span&gt;

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Jan 11, 2021 10:06 UTC   364d                                    no
apiserver                  Jan 11, 2021 10:06 UTC   364d            ca                      no
apiserver-kubelet-client   Jan 11, 2021 10:06 UTC   364d            ca                      no
controller-manager.conf    Jan 11, 2021 10:06 UTC   364d                                    no
front-proxy-client         Jan 11, 2021 10:06 UTC   364d            front-proxy-ca          no
scheduler.conf             Jan 11, 2021 10:06 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Jan 09, 2030 10:06 UTC   9y              no
front-proxy-ca          Jan 09, 2030 10:06 UTC   9y              no

&lt;span class=&quot;c&quot;&gt;# ç»­ç­¾è¯ä¹¦&lt;/span&gt;
k1.node âœ kubeadm alpha certs renew all
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;renew] Reading configuration from the cluster...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;renew] FYI: You can look at this config file with &lt;span class=&quot;s1&quot;&gt;'kubectl -n kube-system get cm kubeadm-config -oyaml'&lt;/span&gt;

certificate embedded &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the kubeconfig file &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the admin to use and &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;kubeadm itself renewed
certificate &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;serving the Kubernetes API renewed
certificate &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the API server to connect to kubelet renewed
certificate embedded &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the kubeconfig file &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the controller manager to use renewed
certificate &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the front proxy client renewed
certificate embedded &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the kubeconfig file &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the scheduler manager to use renewed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;64node-é‡åŠ å…¥&quot;&gt;6.4ã€Node é‡åŠ å…¥&lt;/h3&gt;

&lt;p&gt;é»˜è®¤çš„ bootstrap token ä¼šåœ¨ 24h åå¤±æ•ˆï¼Œæ‰€ä»¥åç»­å¢åŠ æ–°èŠ‚ç‚¹éœ€è¦é‡æ–°åˆ›å»º tokenï¼Œé‡æ–°åˆ›å»º token å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®Œæˆ&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# åˆ—å‡º token&lt;/span&gt;
k1.node âœ kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
r4t3l3.14mmuivm7xbtaeoj   22h         2020-01-13T18:06:54+08:00   authentication,signing   &amp;lt;none&amp;gt;                                                     system:bootstrappers:kubeadm:default-node-token
zady4i.57f9i2o6zl9vf9hy   45m         2020-01-12T20:06:53+08:00   &amp;lt;none&amp;gt;                   Proxy &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;managing TTL &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;the kubeadm-certs secret        &amp;lt;none&amp;gt;

&lt;span class=&quot;c&quot;&gt;# åˆ›å»ºæ–° token&lt;/span&gt;
k1.node âœ kubeadm token create &lt;span class=&quot;nt&quot;&gt;--print-join-command&lt;/span&gt;
W0112 19:21:15.174765   26626 validation.go:28] Cannot validate kube-proxy config - no validator is available
W0112 19:21:15.174836   26626 validation.go:28] Cannot validate kubelet config - no validator is available
kubeadm &lt;span class=&quot;nb&quot;&gt;join &lt;/span&gt;127.0.0.1:6443 &lt;span class=&quot;nt&quot;&gt;--token&lt;/span&gt; 2dz4dc.mobzgjbvu0bkxz7j     &lt;span class=&quot;nt&quot;&gt;--discovery-token-ca-cert-hash&lt;/span&gt; sha256:06f49f1f29d08b797fbf04d87b9b0fd6095a4693e9b1d59c429745cfa082b31d
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¦‚æœå¿˜è®°äº† certificate-key å¯ä»¥é€šè¿‡ä¸€ä¸‹å‘½ä»¤é‡æ–° upload å¹¶æŸ¥çœ‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;k1.node âœ kubeadm init &lt;span class=&quot;nt&quot;&gt;--config&lt;/span&gt; kubeadm.yaml phase upload-certs &lt;span class=&quot;nt&quot;&gt;--upload-certs&lt;/span&gt;
W0112 19:23:06.466711   28637 validation.go:28] Cannot validate kubelet config - no validator is available
W0112 19:23:06.466778   28637 validation.go:28] Cannot validate kube-proxy config - no validator is available
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upload-certs] Storing the certificates &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;Secret &lt;span class=&quot;s2&quot;&gt;&quot;kubeadm-certs&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;the &lt;span class=&quot;s2&quot;&gt;&quot;kube-system&quot;&lt;/span&gt; Namespace
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;upload-certs] Using certificate key:
7373f829c733b46fb78f0069f90185e0f00254381641d8d5a7c5984b2cf17cd3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;65è°ƒæ•´-kubelet&quot;&gt;6.5ã€è°ƒæ•´ kubelet&lt;/h3&gt;

&lt;p&gt;node èŠ‚ç‚¹ä¸€æ—¦å¯åŠ¨å®Œæˆåï¼Œkubelet é…ç½®ä¾¿ä¸å¯å†ä¿®æ”¹ï¼›å¦‚æœæƒ³è¦ä¿®æ”¹ kubelet é…ç½®ï¼Œå¯ä»¥é€šè¿‡è°ƒæ•´ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/systemd/system/kubelet.service.d/10-kubeadm.conf&lt;/code&gt; é…ç½®æ–‡ä»¶å®Œæˆ&lt;/p&gt;

&lt;h2 id=&quot;ä¸ƒå…¶ä»–&quot;&gt;ä¸ƒã€å…¶ä»–&lt;/h2&gt;

&lt;p&gt;æœ¬æ–‡å‚è€ƒäº†è®¸å¤šå®˜æ–¹æ–‡æ¡£ï¼Œä»¥ä¸‹æ˜¯ä¸€äº›ä¸ªäººè®¤ä¸ºæ¯”è¾ƒæœ‰ä»·å€¼å¹¶ä¸”åœ¨ä½¿ç”¨ kubeadm ååº”è¯¥é˜…è¯»çš„æ–‡æ¡£&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details&quot;&gt;Implementation details&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/kubelet-integration/&quot;&gt;Configuring each kubelet in your cluster using kubeadm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/control-plane-flags/&quot;&gt;Customizing control plane configuration with kubeadm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/&quot;&gt;Creating Highly Available clusters with kubeadm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/&quot;&gt;Certificate Management with kubeadm&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/&quot;&gt;Upgrading kubeadm clusters&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/&quot;&gt;Reconfigure a Nodeâ€™s Kubelet in a Live Cluster&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 21 Jan 2020 21:31:39 +0800</pubDate>
        <link>https://mritd.me/2020/01/21/set-up-kuberntes-ha-cluster-by-kubeadm/</link>
        <guid isPermaLink="true">https://mritd.me/2020/01/21/set-up-kuberntes-ha-cluster-by-kubeadm/</guid>
        
        <category>Kubernetes</category>
        
        
        <category>Kubernetes</category>
        
      </item>
    
      <item>
        <title>äº‘æœåŠ¡å™¨ä¸‹ Ubuntu 18 æ­£ç¡®çš„ DNS ä¿®æ”¹</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;æœ€è¿‘åšå®¢æœåŠ¡å™¨æ¢æˆäº†é˜¿é‡Œäº‘é¦™æ¸¯ï¼Œä¸ªäººè¿˜å¶å°”çœ‹ç¾å‰§ï¼Œæ‰€ä»¥åšäº†ä¸€ä¸‹ Netflix åˆ†æµï¼›åˆ†æµè¿‡ç¨‹ä¸»è¦æ˜¯åš DNS è§£æ SNI ä»£ç†ï¼Œè°ƒäº†åŠå¤©è®°å½•ä¸€ä¸‹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€èµ·å› &quot;&gt;ä¸€ã€èµ·å› &lt;/h2&gt;

&lt;p&gt;Netflix DNS åˆ†æµå®é™…ä¸Šæˆ‘ç›®å‰çš„æ–¹æ¡ˆæ˜¯é€šè¿‡ CoreDNS ä½œä¸ºä¸» DNS Serverï¼Œç„¶ååœ¨ CoreDNS ä¸Šé’ˆå¯¹ Netflix å…¨éƒ¨åŸŸåè§£æ forward åˆ°ä¸€å°å›½å¤–å¯ä»¥è§£é” Netflix æœºå™¨ä¸Šï¼›å¦‚æœç›´æ¥å°† CoreDNS æš´éœ²åœ¨å…¬ç½‘ï¼Œé‚£ä¹ˆæ— ç–‘æ˜¯åœ¨ä½œæ­»ï¼Œä¸º DNS åå°„ DDos æä¾›è‚‰é¸¡ï¼›æ‰€ä»¥æƒ³åˆ°çš„æ–¹æ¡ˆæ˜¯è‡ªå·±ç¼–å†™ä¸€ä¸ªä¸å¯æè¿°çš„å·¥å…·ï¼Œæœ¬åœ° Client åˆ° Server ç«¯ä»¥åï¼ŒServer ç«¯å†å»è®¾ç½®åˆ° CoreDNS åšåˆ†æµï¼›å…¶ä¸­ä¸å¯é¿å…çš„éœ€è¦è°ƒæ•´ Server ç«¯é»˜è®¤ DNSã€‚&lt;/p&gt;

&lt;h2 id=&quot;äºŒå·²åºŸå¼ƒä¿®æ”¹æ–¹å¼&quot;&gt;äºŒã€å·²åºŸå¼ƒä¿®æ”¹æ–¹å¼&lt;/h2&gt;

&lt;p&gt;ç›®å‰å¤§éƒ¨ä»½äººè¿˜æ˜¯ä¹ æƒ¯ä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/resolv.conf&lt;/code&gt; é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªé…ç½®æ–‡ä»¶ä¸Šé¢å·²ç»æ˜ç¡®æ ‡æ³¨äº†ä¸è¦å»ä¿®æ”¹å®ƒï¼›&lt;strong&gt;å› ä¸ºè‡ª Systemd ä¸€ç»Ÿæ±Ÿå±±ä»¥åï¼Œç³»ç»Ÿ DNS å·²ç»è¢« &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemd-resolved&lt;/code&gt; æœåŠ¡æ¥ç®¡ï¼›ä¸€ä½†ä¿®æ”¹äº† &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/resolv.conf&lt;/code&gt;ï¼Œæœºå™¨é‡å¯åå°±ä¼šè¢«æ¢å¤ï¼›&lt;/strong&gt;æ‰€ä»¥æ ¹æºè§£å†³æ–¹æ¡ˆè¿˜æ˜¯éœ€è¦ä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemd-resolved&lt;/code&gt; çš„é…ç½®ã€‚&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰netplan-çš„è°ƒæ•´&quot;&gt;ä¸‰ã€netplan çš„è°ƒæ•´&lt;/h2&gt;

&lt;p&gt;åœ¨è°ƒæ•´å®Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemd-resolved&lt;/code&gt; é…ç½®åå…¶å®æœ‰äº›åœ°æ–¹ä»ç„¶æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼›&lt;strong&gt;åŸå› æ˜¯ Ubuntu 18 å¼€å§‹ç½‘ç»œå·²ç»è¢« netplan æ¥ç®¡ï¼Œæ‰€ä»¥é—®é¢˜åˆå›åˆ°äº†å¦‚ä½•ä¿®æ”¹ netplanï¼›&lt;/strong&gt;ç”±äºäº‘æœåŠ¡å™¨åˆå§‹åŒ–å…¨éƒ¨æ˜¯ç”± cloud-init å®Œæˆçš„ï¼Œnetplan é…ç½®é‡Œ IP å…¨éƒ¨æ˜¯ç”± DHCP å®Œæˆï¼›é‚£ä¹ˆç›´æ¥ä¿®æ”¹ netplan ä¸º static IP ç†è®ºä¸Šå¯è¡Œï¼Œä½†æ˜¯äº‹å®ä¸Šè¿˜æ˜¯ä¸å¤Ÿä¼˜é›…ï¼›åæ¥ç ”ç©¶äº†ä¸€ä¸‹å…¶å®æ›´ä¼˜é›…çš„æ–¹å¼æ˜¯è¦†ç›–æ‰ DHCP çš„æŸäº›é…ç½®ï¼Œæ¯”å¦‚ DNS é…ç½®ï¼›åœ¨é˜¿é‡Œäº‘ä¸Šé…ç½®å¦‚ä¸‹(&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/netplan/99-netcfg.yaml&lt;/code&gt;)&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;network&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;renderer&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;networkd&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;ethernets&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;eth0&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;dhcp4&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;yes&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;dhcp4-overrides&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;use-dns&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;no&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;dhcp6&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;no&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;nameservers&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;search&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;local&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;node&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;# æˆ‘è‡ªå·±çš„ CoreDNS æœåŠ¡å™¨&lt;/span&gt;
        &lt;span class=&quot;na&quot;&gt;addresses&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;172.17.3.17&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ä¿®æ”¹å®Œæˆåæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netplan try&lt;/code&gt; ç­‰å¾…å‡ ç§’é’Ÿï¼Œå¦‚æœå±å¹•çš„è¯»ç§’å€’è®¡æ—¶ä¸€ç›´åœ¨åŠ¨ï¼Œè¯´æ˜ä¿®æ”¹æ²¡é—®é¢˜ï¼Œæ¥ç€å›è½¦æ—¢å¯(å°½é‡ä¸è¦ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netplan apply&lt;/code&gt;ï¼Œä¸€æ—¦ä¿®æ”¹é”™è¯¯ä½ å°±å†ä¹Ÿè¿ä¸ä¸Šäº†â€¦)&lt;/p&gt;

&lt;h2 id=&quot;å››dns-åˆ†æµ&quot;&gt;å››ã€DNS åˆ†æµ&lt;/h2&gt;

&lt;p&gt;é¡ºä¾¿è´´ä¸€ä¸‹ CoreDNS é…ç½®å§ï¼Œå¯èƒ½æœ‰äº›äººä¹Ÿéœ€è¦ï¼›ç¬¬ä¸€éƒ¨åˆ†çš„åŸŸåæ˜¯ç›®å‰æˆ‘æ•´ç†çš„ Netflix å…¨éƒ¨è®¿é—®åŸŸåï¼Œé’ˆå¯¹è¿™äº›åŸŸåçš„æµé‡è½¬å‘åˆ°è‡ªå·±å…¶ä»–å¯è§£é” Netflix çš„æœºå™¨æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;netflix.com nflxext.com nflximg.net nflxso.net nflxvideo.net &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;bind &lt;/span&gt;172.17.3.17

    cache 30 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        success 4096
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    forward &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; 158.1.1.1 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        max_fails 2
        prefer_udp
        expire 20s
        policy random
        health_check 0.2s
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    errors
    log &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;{remote}:{port} - {&amp;gt;id} &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{type} {class} {name} {proto} {size} {&amp;gt;do} {&amp;gt;bufsize}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; {rcode} {&amp;gt;rflags} {rsize} {duration}&quot;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

.:53 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;bind &lt;/span&gt;172.17.3.17

    cache 30 &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        success 4096
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    forward &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; 8.8.8.8 1.1.1.1 &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
        except netflix.com nflxext.com nflximg.net nflxso.net nflxvideo.net
        max_fails 2
        expire 20s
        policy random
        health_check 0.2s
    &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;

    errors
    log &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;{remote}:{port} - {&amp;gt;id} &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;{type} {class} {name} {proto} {size} {&amp;gt;do} {&amp;gt;bufsize}&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; {rcode} {&amp;gt;rflags} {rsize} {duration}&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;äº”å…³äº-docker&quot;&gt;äº”ã€å…³äº docker&lt;/h2&gt;

&lt;p&gt;å½“ netplan ä¿®æ”¹å®Œæˆåï¼Œåªéœ€è¦é‡å¯ docker æ—¢å¯ä¿è¯ docker å†…æ‰€æœ‰å®¹å™¨ DNS è¯·æ±‚å…¨éƒ¨å‘é€åˆ°è‡ªå·±å®šä¹‰çš„ DNS æœåŠ¡å™¨ä¸Šï¼›&lt;strong&gt;è¯·ä¸è¦å°è¯•å°†è‡ªå·±çš„ CoreDNS ç›‘å¬åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;127.*&lt;/code&gt; æˆ–è€… &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;::1&lt;/code&gt; ä¸Šï¼Œè¿™ä¸¤ä¸ªåœ°å€ä¼šå¯¼è‡´ docker ä¸­çš„ DNS æ— æ•ˆ&lt;/strong&gt;ï¼Œå› ä¸ºåœ¨ &lt;a href=&quot;https://github.com/docker/libnetwork/blob/fec6476dfa21380bf8ee4d74048515d968c1ee63/resolvconf/resolvconf.go#L148&quot;&gt;libnetwork&lt;/a&gt; ä¸­é’ˆå¯¹è¿™ä¸¤ä¸ªåœ°å€åšäº†è¿‡æ»¤ï¼Œå¹¶ä¸” &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FilterResolvDNS&lt;/code&gt; æ–¹æ³•åœ¨å‰”é™¤è¿™ä¸¤ç§åœ°å€æ—¶ä¸ä¼šç»™äºˆä»»ä½•è­¦å‘Šæ—¥å¿—&lt;/p&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 21 Jan 2020 21:20:08 +0800</pubDate>
        <link>https://mritd.me/2020/01/21/how-to-modify-dns-on-ubuntu18-server/</link>
        <guid isPermaLink="true">https://mritd.me/2020/01/21/how-to-modify-dns-on-ubuntu18-server/</guid>
        
        <category>Linux</category>
        
        
        <category>Linux</category>
        
      </item>
    
      <item>
        <title>Percona MySQL æ­å»º</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;æœ€è¿‘è¢«æ‹‰å»æŠ˜è…¾ MySQL äº†ï¼ŒKuberntes ç›¸å…³çš„æ–‡ç« åœæ›´äº†å¥½ä¹…â€¦ MySQL æŠ˜è…¾å®Œäº†é¡ºä¾¿è®°å½•ä¸€ä¸‹æŠ˜è…¾è¿‡ç¨‹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æœ¬ç¯‡æ–‡ç« ä»å®é™…ç”Ÿäº§ç¯å¢ƒæ–‡æ¡£ä¸­æ‘˜å½•ï¼Œéƒ¨åˆ†æ—¥å¿—å’Œæ•°æ®åº“æ•æ„Ÿä¿¡æ¯å·²è¢«èƒ¡ä¹±æ›¿æ¢ï¼Œæ‰€ä»¥ä¸è¦ç›²ç›®å¤åˆ¶ç²˜è´´ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€ç‰ˆæœ¬ä¿¡æ¯&quot;&gt;ä¸€ã€ç‰ˆæœ¬ä¿¡æ¯&lt;/h2&gt;

&lt;p&gt;ç›®å‰é‡‡ç”¨ MySQL fork ç‰ˆæœ¬ Percona Server 5.7.28ï¼Œç›‘æ§æ–¹é¢é€‰æ‹© Percona Monitoring and Management 2.1.0ï¼Œå¯¹åº”ç›‘æ§ Client ç‰ˆæœ¬ä¸º 2.1.0&lt;/p&gt;

&lt;h2 id=&quot;äºŒpercona-server-å®‰è£…&quot;&gt;äºŒã€Percona Server å®‰è£…&lt;/h2&gt;

&lt;p&gt;ä¸ºä¿è¯å…¼å®¹ä»¥åŠç¨³å®šæ€§ï¼ŒMySQL å®¿ä¸»æœºç³»ç»Ÿé€‰æ‹© CentOS 7ï¼ŒPercona Server å®‰è£…æ–¹å¼ä¸º rpm åŒ…ï¼Œå®‰è£…åç”± Systemd å®ˆæŠ¤&lt;/p&gt;

&lt;h3 id=&quot;21ä¸‹è½½å®‰è£…åŒ…&quot;&gt;2.1ã€ä¸‹è½½å®‰è£…åŒ…&lt;/h3&gt;

&lt;p&gt;å®‰è£…åŒ…ä¸‹è½½åœ°å€ä¸º &lt;a href=&quot;https://www.percona.com/downloads/Percona-Server-5.7/LATEST/&quot;&gt;https://www.percona.com/downloads/Percona-Server-5.7/LATEST/&lt;/a&gt;ï¼Œä¸‹è½½æ—¶é€‰æ‹© &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Download All Packages Together&lt;/code&gt;ï¼Œä¸‹è½½åæ˜¯æ‰€æœ‰ç»„ä»¶å…¨é‡çš„å‹ç¼© tar åŒ…ã€‚&lt;/p&gt;

&lt;h3 id=&quot;22å®‰è£…å‰å‡†å¤‡&quot;&gt;2.2ã€å®‰è£…å‰å‡†å¤‡&lt;/h3&gt;

&lt;p&gt;é’ˆå¯¹ CentOS 7 ç³»ç»Ÿï¼Œå®‰è£…å‰å‡çº§æ‰€æœ‰ç³»ç»Ÿç»„ä»¶åº“ï¼Œæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yum update&lt;/code&gt; æ—¢å¯ï¼›å¤§éƒ¨ä»½ &lt;strong&gt;CentOS 7 å®‰è£…åå¯èƒ½ä¼šé™„å¸¦ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mariadb-libs&lt;/code&gt; åŒ…ï¼Œè¿™ä¸ªåŒ…ä¼šé»˜è®¤åˆ›å»ºä¸€äº›é…ç½®æ–‡ä»¶ï¼Œå¯¼è‡´åé¢çš„ Percona Server æ— æ³•è¦†ç›–å®ƒ(ä¾‹å¦‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/my.cnf&lt;/code&gt;)ï¼Œæ‰€ä»¥å®‰è£… Percona Server ä¹‹å‰éœ€è¦å¸è½½å®ƒ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yum remove mariadb-libs&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;é’ˆå¯¹äºæ•°æ®å­˜å‚¨ç¡¬ç›˜ï¼Œç›®å‰ç»Ÿä¸€ä¸º SSD ç¡¬ç›˜ï¼ŒæŒ‚è½½ç‚¹ä¸º &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data&lt;/code&gt;ï¼ŒæŒ‚è½½æ–¹å¼å¯ä»¥é‡‡ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;fstab&lt;/code&gt;ã€&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemd-mount&lt;/code&gt;ï¼Œåˆ†åŒºæ ¼å¼ç›®å‰é‡‡ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xfs&lt;/code&gt; æ ¼å¼ã€‚&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;SSD ä¼˜åŒ–æœ‰å¾…è¡¥å……â€¦&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;23å®‰è£…-percona-server&quot;&gt;2.3ã€å®‰è£… Percona Server&lt;/h3&gt;

&lt;p&gt;Percona Server tar åŒ…è§£å‹åä¼šæœ‰ 9 ä¸ª rpm åŒ…ï¼Œå®é™…å®‰è£…æ—¶åªéœ€è¦å®‰è£…å…¶ä¸­ 4 ä¸ªæ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;yum &lt;span class=&quot;nb&quot;&gt;install &lt;/span&gt;Percona-Server-client-57-5.7.28-31.1.el7.x86_64.rpm Percona-Server-server-57-5.7.28-31.1.el7.x86_64.rpm Percona-Server-shared-57-5.7.28-31.1.el7.x86_64.rpm Percona-Server-shared-compat-57-5.7.28-31.1.el7.x86_64.rpm
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;24å®‰è£…åè°ƒæ•´&quot;&gt;2.4ã€å®‰è£…åè°ƒæ•´&lt;/h3&gt;

&lt;h4 id=&quot;241ç¡¬ç›˜è°ƒæ•´&quot;&gt;2.4.1ã€ç¡¬ç›˜è°ƒæ•´&lt;/h4&gt;

&lt;p&gt;ç›®å‰ MySQL æ•°æ®ä¼šç»Ÿä¸€å­˜æ”¾åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data&lt;/code&gt; ç›®å½•ä¸‹ï¼Œæ‰€ä»¥éœ€è¦å°†å•ç‹¬çš„æ•°æ®ç›˜æŒ‚è½½åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data&lt;/code&gt; ç›®å½•ï¼›&lt;strong&gt;å¦‚æœæ˜¯ SSD ç¡¬ç›˜è¿˜éœ€è¦è°ƒæ•´ç³»ç»Ÿ I/O è°ƒåº¦å™¨ç­‰å…¶ä»–ä¼˜åŒ–ã€‚&lt;/strong&gt;&lt;/p&gt;

&lt;h4 id=&quot;242ç›®å½•é¢„åˆ›å»º&quot;&gt;2.4.2ã€ç›®å½•é¢„åˆ›å»º&lt;/h4&gt;

&lt;p&gt;Percona Server å®‰è£…å®Œæˆåï¼Œç”±äºé…ç½®è°ƒæ•´åŸå› ï¼Œè¿˜ä¼šç”¨åˆ°ä¸€äº›å…¶ä»–çš„æ•°æ®ç›®å½•ï¼Œè¿™äº›ç›®å½•å¯ä»¥é¢„å…ˆåˆ›å»ºå¹¶æˆæƒ&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /var/log/mysql /data/mysql_tmp
&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mysql:mysql /var/log/mysql /data/mysql_tmp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/log/mysql&lt;/code&gt; ç›®å½•ç”¨æ¥å­˜æ”¾ MySQL ç›¸å…³çš„æ—¥å¿—(ä¸åŒ…æ‹¬ binlog)ï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/data/mysql_tmp&lt;/code&gt; ç”¨æ¥å­˜æ”¾ MySQL è¿è¡Œæ—¶äº§ç”Ÿçš„ç¼“å­˜æ–‡ä»¶ã€‚&lt;/p&gt;

&lt;h4 id=&quot;243æ–‡ä»¶æè¿°ç¬¦è°ƒæ•´&quot;&gt;2.4.3ã€æ–‡ä»¶æè¿°ç¬¦è°ƒæ•´&lt;/h4&gt;

&lt;p&gt;ç”±äº rpm å®‰è£…çš„ Percona Server ä¼šé‡‡ç”¨ Systemd å®ˆæŠ¤ï¼Œæ‰€ä»¥å¦‚æœæƒ³ä¿®æ”¹æ–‡ä»¶æè¿°ç¬¦é…ç½®åº”å½“è°ƒæ•´ Systemd é…ç½®æ–‡ä»¶&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vim /usr/lib/systemd/system/mysqld.service

&lt;span class=&quot;c&quot;&gt;# Sets open_files_limit&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ³¨æ„ infinity = 65536&lt;/span&gt;
LimitCORE &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; infinity
LimitNOFILE &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; infinity
LimitNPROC &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; infinity
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;ç„¶åæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;systemctl daemon-reload&lt;/code&gt; é‡è½½æ—¢å¯ã€‚&lt;/p&gt;

&lt;h4 id=&quot;244é…ç½®æ–‡ä»¶è°ƒæ•´&quot;&gt;2.4.4ã€é…ç½®æ–‡ä»¶è°ƒæ•´&lt;/h4&gt;

&lt;p&gt;Percona Server å®‰è£…å®Œæˆåä¹Ÿä¼šç”Ÿæˆ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/my.cnf&lt;/code&gt; é…ç½®æ–‡ä»¶ï¼Œä¸è¿‡ä¸å»ºè®®ç›´æ¥ä¿®æ”¹è¯¥æ–‡ä»¶ï¼›ä¿®æ”¹é…ç½®æ–‡ä»¶éœ€è¦è¿›å…¥åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/percona-server.conf.d/&lt;/code&gt; ç›®å½•è°ƒæ•´ç›¸åº”é…ç½®ï¼›ä»¥ä¸‹ä¸ºé…ç½®æ ·ä¾‹(&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒ mysqld é…ç½®éœ€è¦ä¼˜åŒ–è°ƒæ•´&lt;/strong&gt;)&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;mysql.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[mysql]&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;auto-rehash&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;default_character_set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysqld.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Percona Server template configuration
&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;[mysqld]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3306&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;datadir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/data/mysql&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/data/mysql/mysql.sock&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;pid_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/data/mysql/mysqld.pid&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# æœåŠ¡ç«¯ç¼–ç 
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;character_set_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æœåŠ¡ç«¯æ’åº
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;collation_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4_general_ci&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼ºåˆ¶ä½¿ç”¨ utf8mb4 ç¼–ç é›†ï¼Œå¿½ç•¥å®¢æˆ·ç«¯è®¾ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;skip_character_set_client_handshake&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;FILE&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼€å¯å¸¸è§„æ—¥å¿—è¾“å‡º
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;general_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¸¸è§„æ—¥å¿—è¾“å‡ºæ–‡ä»¶ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;general_log_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/mysql/mysqld.log&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# é”™è¯¯æ—¥å¿—ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/mysql/mysqld-error.log&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è®°å½•æ…¢æŸ¥è¯¢
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;slow_query_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ…¢æŸ¥è¯¢æ—¶é—´(å¤§äº 1s è¢«è§†ä¸ºæ…¢æŸ¥è¯¢)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;long_query_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;slow_query_log_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/mysql/mysqld-slow.log&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ä¸´æ—¶æ–‡ä»¶ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;tmpdir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/data/mysql_tmp&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# çº¿ç¨‹æ± ç¼“å­˜(refs https://my.oschina.net/realfighter/blog/363853)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;thread_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;30&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# The number of open tables for all threads.(refs https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_table_open_cache)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;table_open_cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16384&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ–‡ä»¶æè¿°ç¬¦(æ­¤å¤„ä¿®æ”¹ä¸ç”Ÿæ•ˆï¼Œè¯·ä¿®æ”¹ systemd service é…ç½®) 
# refs https://www.percona.com/blog/2017/10/12/open_files_limit-mystery/
# refs https://www.cnblogs.com/wxxjianchi/p/10370419.html
#open_files_limit=65535
# è¡¨å®šä¹‰ç¼“å­˜(5.7 ä»¥åè‡ªåŠ¨è°ƒæ•´)
# refs https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_table_definition_cache
# refs http://mysql.taobao.org/monthly/2015/08/10/
#table_definition_cache=16384
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;sort_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;join_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MyiSAM å¼•æ“ä¸“ç”¨(å†…éƒ¨ä¸´æ—¶ç£ç›˜è¡¨å¯èƒ½ä¼šç”¨)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;read_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;read_rnd_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MyiSAM å¼•æ“ä¸“ç”¨(å†…éƒ¨ä¸´æ—¶ç£ç›˜è¡¨å¯èƒ½ä¼šç”¨)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;key_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MyiSAM å¼•æ“ä¸“ç”¨(å†…éƒ¨ä¸´æ—¶ç£ç›˜è¡¨å¯èƒ½ä¼šç”¨)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;bulk_insert_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# myisam_sort_buffer_size ä¸ sort_buffer_size åŒºåˆ«è¯·å‚è€ƒ(https://stackoverflow.com/questions/7871027/myisam-sort-buffer-size-vs-sort-buffer-size)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;myisam_sort_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;64M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å†…éƒ¨å†…å­˜ä¸´æ—¶è¡¨å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;tmp_table_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç”¨æˆ·åˆ›å»ºçš„ MEMORY è¡¨æœ€å¤§å¤§å°(tmp_table_size å—æ­¤å€¼å½±å“)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_heap_table_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼€å¯æŸ¥è¯¢ç¼“å­˜
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;query_cache_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æŸ¥è¯¢ç¼“å­˜å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;query_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# sql mode
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;sql_mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;########### Network ###########
# æœ€å¤§è¿æ¥æ•°(è¯¥å‚æ•°å—åˆ°æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å½±å“ï¼Œå¦‚æœä¸ç”Ÿæ•ˆè¯·æ£€æŸ¥æœ€å¤§æ–‡ä»¶æè¿°ç¬¦è®¾ç½®)
# refs https://stackoverflow.com/questions/39976756/the-max-connections-in-mysql-5-7
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_connections&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1500&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# mysql å †æ ˆå†…æš‚å­˜çš„é“¾æ¥æ•°é‡
# å½“çŸ­æ—¶é—´å†…é“¾æ¥æ•°é‡è¶…è¿‡ max_connections æ—¶ï¼Œéƒ¨åˆ†é“¾æ¥ä¼šå­˜å‚¨åœ¨å †æ ˆå†…ï¼Œå­˜å‚¨æ•°é‡å—æ­¤å‚æ•°æ§åˆ¶
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;back_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æœ€å¤§é“¾æ¥é”™è¯¯ï¼Œé’ˆå¯¹äº client ä¸»æœºï¼Œè¶…è¿‡æ­¤æ•°é‡çš„é“¾æ¥é”™è¯¯å°†ä¼šå¯¼è‡´ mysql server é’ˆå¯¹æ­¤ä¸»æœºæ‰§è¡Œé”å®š(ç¦æ­¢é“¾æ¥ ERROR 1129 )
# æ­¤é”™è¯¯è®¡æ•°ä»…åœ¨ mysql é“¾æ¥æ¡æ‰‹å¤±è´¥æ‰ä¼šè®¡ç®—ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜æ—¶éƒ½æ˜¯ç½‘ç»œæ•…éšœ
# refs https://www.cnblogs.com/kerrycode/p/8405862.html
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_connect_errors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;100000&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# mysql server å…è®¸çš„æœ€å¤§æ•°æ®åŒ…å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_allowed_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;64M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# äº¤äº’å¼å®¢æˆ·ç«¯é“¾æ¥è¶…æ—¶(30åˆ†é’Ÿè‡ªåŠ¨æ–­å¼€)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;interactive_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1800&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# éäº¤äº’å¼é“¾æ¥è¶…æ—¶æ—¶é—´(10åˆ†é’Ÿ)
# å¦‚æœå®¢æˆ·ç«¯æœ‰è¿æ¥æ± ï¼Œåˆ™éœ€è¦åå•†æ­¤å‚æ•°(refs https://database.51cto.com/art/201909/603519.htm)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;wait_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;600&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è·³è¿‡å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿé”å®š
# If you run multiple servers that use the same database directory (not recommended), 
# each server must have external locking enabled.
# refs https://dev.mysql.com/doc/refman/5.7/en/external-locking.html
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;skip_external_locking&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è·³è¿‡é“¾æ¥çš„åŸŸåè§£æ(å¼€å¯æ­¤é€‰é¡¹å mysql ç”¨æˆ·æˆæƒçš„ host æ–¹å¼å¤±æ•ˆ)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;skip_name_resolve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç¦ç”¨ä¸»æœºåç¼“å­˜ï¼Œæ¯æ¬¡éƒ½ä¼šèµ° DNS
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;host_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;########### REPL ###########
# å¼€å¯ binlog
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_bin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-bin&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ä½œä¸ºä»åº“æ—¶ï¼ŒåŒæ­¥ä¿¡æ¯ä¾ç„¶å†™å…¥ binlogï¼Œæ–¹ä¾¿æ­¤ä»åº“å†ä½œä¸ºå…¶ä»–ä»åº“çš„ä¸»åº“
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_slave_updates&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# server idï¼Œé»˜è®¤ä¸º ipv4 åœ°å€å»é™¤ç¬¬ä¸€æ®µ
# eg: 172.16.10.11 =&amp;gt; 161011
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;server_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;161011&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ¯æ¬¡æ¬¡äº‹åŠ¡ binlog åˆ·æ–°åˆ°ç£ç›˜
# refs http://liyangliang.me/posts/2014/03/innodb_flush_log_at_trx_commit-and-sync_binlog/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;sync_binlog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# binlog æ ¼å¼(refs https://zhuanlan.zhihu.com/p/33504555)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;binlog_format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;row&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# binlog è‡ªåŠ¨æ¸…ç†æ—¶é—´
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;expire_logs_days&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼€å¯ relay-logï¼Œä¸€èˆ¬ä½œä¸º slave æ—¶å¼€å¯
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;relay_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-replay&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ä¸»ä»å¤åˆ¶æ—¶è·³è¿‡ test åº“
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;replicate_ignore_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;test&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ¯ä¸ª session binlog ç¼“å­˜
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;binlog_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# binlog æ»šåŠ¨å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_binlog_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1024M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# GTID ç›¸å…³(refs https://keithlan.github.io/2016/06/23/gtid/)
#gtid_mode=1
#enforce_gtid_consistency=1
&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;########### InnoDB ###########
# æ°¸ä¹…è¡¨é»˜è®¤å­˜å‚¨å¼•æ“
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;default_storage_engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;InnoDB&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç³»ç»Ÿè¡¨ç©ºé—´æ•°æ®æ–‡ä»¶å¤§å°(åˆå§‹åŒ–ä¸º 1Gï¼Œå¹¶ä¸”è‡ªåŠ¨å¢é•¿)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_data_file_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;ibdata1:1G:autoextend&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB ç¼“å­˜æ± å¤§å°
# innodb_buffer_pool_size å¿…é¡»ç­‰äº innodb_buffer_pool_chunk_size*innodb_buffer_pool_instancesï¼Œæˆ–è€…æ˜¯å…¶æ•´æ•°å€
# refs https://dev.mysql.com/doc/refman/5.7/en/innodb-buffer-pool-resize.html
# refs https://zhuanlan.zhihu.com/p/60089484
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;7680M&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_instances&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_chunk_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;128M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB å¼ºåˆ¶æ¢å¤(refs https://www.askmaclean.com/archives/mysql-innodb-innodb_force_recovery.html)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_force_recovery&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB buffer é¢„çƒ­(refs http://www.dbhelp.net/2017/01/12/mysql-innodb-buffer-pool-warmup.html)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_dump_at_shutdown&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_load_at_startup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB æ—¥å¿—ç»„ä¸­çš„æ—¥å¿—æ–‡ä»¶æ•°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_log_files_in_group&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB redo æ—¥å¿—å¤§å°
# refs https://www.percona.com/blog/2017/10/18/chose-mysql-innodb_log_file_size/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_log_file_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256MB&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç¼“å­˜è¿˜æœªæäº¤çš„äº‹åŠ¡çš„ç¼“å†²åŒºå¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_log_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB åœ¨äº‹åŠ¡æäº¤åçš„æ—¥å¿—å†™å…¥é¢‘ç‡
# refs http://liyangliang.me/posts/2014/03/innodb_flush_log_at_trx_commit-and-sync_binlog/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_flush_log_at_trx_commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB DML æ“ä½œè¡Œçº§é”ç­‰å¾…æ—¶é—´
# è¶…æ—¶è¿”å› ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
# refs https://ningyu1.github.io/site/post/75-mysql-lock-wait-timeout-exceeded/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_lock_wait_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;30&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB è¡Œçº§é”è¶…æ—¶æ˜¯å¦å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œé»˜è®¤ä¸º OFF ä»…å›æ»šä¸Šä¸€æ¡è¯­å¥
# æ­¤æ—¶åº”ç”¨ç¨‹åºå¯ä»¥æ¥å—åˆ°é”™è¯¯åé€‰æ‹©æ˜¯å¦ç»§ç»­æäº¤äº‹åŠ¡(å¹¶æ²¡æœ‰è¿å ACID åŸå­æ€§)
# refs https://www.cnblogs.com/hustcat/archive/2012/11/18/2775487.html
#innodb_rollback_on_timeout=ON
# InnoDB æ•°æ®å†™å…¥ç£ç›˜çš„æ–¹å¼ï¼Œå…·ä½“è§åšå®¢æ–‡ç« 
# refs https://www.cnblogs.com/gomysql/p/3595806.html
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_flush_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;O_DIRECT&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB ç¼“å†²æ± è„é¡µåˆ·æ–°ç™¾åˆ†æ¯”
# refs https://dbarobin.com/2015/08/29/mysql-optimization-under-ssd
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_max_dirty_pages_pct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;50&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB æ¯ç§’æ‰§è¡Œçš„å†™IOé‡
# refs https://www.centos.bz/2016/11/mysql-performance-tuning-15-config-item/#10.INNODB_IO_CAPACITY,%20INNODB_IO_CAPACITY_MAX
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_io_capacity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;500&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_io_capacity_max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1000&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è¯·æ±‚å¹¶å‘ InnoDB çº¿ç¨‹æ•°
# refs https://www.cnblogs.com/xinysu/p/6439715.html#_lab2_1_0
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_thread_concurrency&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;60&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å†ä½¿ç”¨å¤šä¸ª InnoDB è¡¨ç©ºé—´æ—¶ï¼Œå…è®¸æ‰“å¼€çš„æœ€å¤§ &quot;.ibd&quot; æ–‡ä»¶ä¸ªæ•°ï¼Œä¸è®¾ç½®é»˜è®¤ 300ï¼Œ
# å¹¶ä¸”å–ä¸ table_open_cache ç›¸æ¯”è¾ƒå¤§çš„ä¸€ä¸ªï¼Œæ­¤é€‰é¡¹ç‹¬ç«‹äº open_files_limit
# refs https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_open_files
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_open_files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;65535&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ¯ä¸ª InnoDB è¡¨éƒ½å­˜å‚¨åœ¨ç‹¬ç«‹çš„è¡¨ç©ºé—´(.ibd)ä¸­
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_file_per_table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# äº‹åŠ¡çº§åˆ«(å¯é‡å¤è¯»ï¼Œä¼šå‡ºå¹»è¯»)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;transaction_isolation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;REPEATABLE-READ&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ˜¯å¦åœ¨æœç´¢å’Œç´¢å¼•æ‰«æä¸­ä½¿ç”¨é—´éš™é”(gap locking)ï¼Œä¸å»ºè®®ä½¿ç”¨æœªæ¥å°†åˆ é™¤
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_locks_unsafe_for_binlog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB åå°æ¸…ç†çº¿ç¨‹æ•°ï¼Œæ›´å¤§çš„å€¼æœ‰åŠ©äº DML æ‰§è¡Œæ€§èƒ½ï¼Œ&amp;gt;= 5.7.8 é»˜è®¤ä¸º 4
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_purge_threads&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysqld_safe.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#
# The Percona Server 5.7 configuration file.
#
# One can use all long options that the program supports.
# Run program with --help to get a list of available options and with
# --print-defaults to see which it would actually understand and use.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html
&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;[mysqld_safe]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;pid-file&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/run/mysqld/mysqld.pid&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;socket&lt;/span&gt;   &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/run/mysqld/mysqld.sock&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;nice&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysqldump.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[mysqldump]&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;quick&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;default-character-set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;max_allowed_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256M&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;25å¯åŠ¨&quot;&gt;2.5ã€å¯åŠ¨&lt;/h3&gt;

&lt;p&gt;é…ç½®æ–‡ä»¶è°ƒæ•´å®Œæˆåå¯åŠ¨æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;systemctl start mysqld
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¯åŠ¨å®Œæˆåé»˜è®¤ root å¯†ç ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œé€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;grep 'temporary password' /var/log/mysql/*&lt;/code&gt; æŸ¥çœ‹é»˜è®¤å¯†ç ï¼›è·å¾—é»˜è®¤å¯†ç åå¯ä»¥é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mysqladmin -S /data/mysql/mysql.sock -u root -p password&lt;/code&gt; ä¿®æ”¹ root å¯†ç ã€‚&lt;/p&gt;

&lt;h2 id=&quot;ä¸‰percona-monitoring-and-management&quot;&gt;ä¸‰ã€Percona Monitoring and Management&lt;/h2&gt;

&lt;p&gt;æ•°æ®åº“åˆ›å»ºæˆåŠŸåéœ€è¦å¢åŠ  pmm ç›‘æ§ï¼Œåç»­å°†ä¼šé€šè¿‡ç›‘æ§ä¿¡æ¯æ¥è°ƒä¼˜æ•°æ®åº“ï¼Œæ‰€ä»¥æ•°æ®åº“ç›‘æ§å¿…ä¸å¯å°‘ã€‚&lt;/p&gt;

&lt;h3 id=&quot;31å®‰è£…å‰å‡†å¤‡&quot;&gt;3.1ã€å®‰è£…å‰å‡†å¤‡&lt;/h3&gt;

&lt;p&gt;pmm ç›‘æ§éœ€è¦ä½¿ç”¨ç‰¹å®šç”¨æˆ·æ¥ç›‘æ§æ•°æ®ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆä¸º pmm åˆ›å»ºç”¨æˆ·&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;USE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'pmm'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'pmm12345'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;OPTION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;FLUSH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;32å®‰è£…-pmm-server&quot;&gt;3.2ã€å®‰è£… PMM Server&lt;/h3&gt;

&lt;p&gt;pmm server ç«¯æ¨èç›´æ¥ä½¿ç”¨ docker å¯åŠ¨ï¼Œä»¥ä¸‹ä¸ºæ ·ä¾‹ docker compose&lt;/p&gt;

&lt;div class=&quot;language-yaml highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;na&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3.7'&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;services&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;pmm&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;percona/pmm-server:2.1.0&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;container_name&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;pmm&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;restart&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;always&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;data:/srv&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;ports&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;80:80&quot;&lt;/span&gt;
      &lt;span class=&quot;pi&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;443:443&quot;&lt;/span&gt;
&lt;span class=&quot;na&quot;&gt;volumes&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;å¦‚æœæƒ³è¦è‡ªå®šä¹‰è¯ä¹¦ï¼Œè¯·å°†è¯ä¹¦å¤åˆ¶åˆ° volume å†…çš„ nginx ç›®å½•ä¸‹ï¼Œè‡ªå®šä¹‰è¯ä¹¦éœ€è¦ä»¥ä¸‹è¯ä¹¦æ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pmmserver.node âœ tree
&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
â”œâ”€â”€ ca-certs.pem
â”œâ”€â”€ certificate.conf  &lt;span class=&quot;c&quot;&gt;# æ­¤æ–‡ä»¶æ˜¯ pmm é»˜è®¤ç”Ÿæˆè‡ªç­¾è¯ä¹¦çš„é…ç½®æ–‡ä»¶ï¼Œä¸éœ€è¦å…³æ³¨&lt;/span&gt;
â”œâ”€â”€ certificate.crt
â”œâ”€â”€ certificate.key
â””â”€â”€ dhparam.pem
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;pmm server å¯åŠ¨åè®¿é—® &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;http(s)://IP_ADDRESS&lt;/code&gt; æ—¢å¯è¿›å…¥ granafa é¢æ¿ï¼Œé»˜è®¤è´¦æˆ·åå’Œå¯†ç éƒ½æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin&lt;/code&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;33å®‰è£…-pmm-client&quot;&gt;3.3ã€å®‰è£… PMM Client&lt;/h3&gt;

&lt;p&gt;PMM Client åŒæ ·é‡‡ç”¨ rpm å®‰è£…ï¼Œä¸‹è½½åœ°å€ &lt;a href=&quot;https://www.percona.com/downloads/pmm2/&quot;&gt;https://www.percona.com/downloads/pmm2/&lt;/a&gt;ï¼Œå½“å‰é‡‡ç”¨æœ€æ–°çš„ 2.1.0 ç‰ˆæœ¬ï¼›rpm ä¸‹è½½å®Œæˆåç›´æ¥ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yum install&lt;/code&gt; æ—¢å¯ã€‚&lt;/p&gt;

&lt;p&gt;rpm å®‰è£…å®Œæˆåä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pmm-admin&lt;/code&gt; å‘½ä»¤é…ç½®æœåŠ¡ç«¯åœ°å€ï¼Œå¹¶æ·»åŠ å½“å‰ mysql å®ä¾‹ç›‘æ§&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# é…ç½®æœåŠ¡ç«¯åœ°å€&lt;/span&gt;
pmm-admin config &lt;span class=&quot;nt&quot;&gt;--server-url&lt;/span&gt; https://admin:admin@pmm.mysql.node 172.16.0.11 generic mysql
&lt;span class=&quot;c&quot;&gt;# é…ç½®å½“å‰ mysql å®ä¾‹&lt;/span&gt;
pmm-admin add mysql &lt;span class=&quot;nt&quot;&gt;--username&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;pmm &lt;span class=&quot;nt&quot;&gt;--password&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;pmm12345 mysql 172.16.0.11:3306
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å®Œæˆåç¨ç­‰ç‰‡åˆ»æ—¢å¯åœ¨ pmm server ç«¯çš„ granafa ä¸­çœ‹åˆ°ç›¸å…³æ•°æ®ã€‚&lt;/p&gt;

&lt;h2 id=&quot;å››æ•°æ®å¯¼å…¥&quot;&gt;å››ã€æ•°æ®å¯¼å…¥&lt;/h2&gt;

&lt;p&gt;ä»åŸå§‹æ•°æ®åº“ dump ç›¸å…³åº“ï¼Œå¹¶å¯¼å…¥åˆ°æ–°æ•°æ®åº“æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# dump&lt;/span&gt;
mysqldump &lt;span class=&quot;nt&quot;&gt;-h&lt;/span&gt; 172.16.1.10 &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--master-data&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2 &lt;span class=&quot;nt&quot;&gt;--routines&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--triggers&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--single_transaction&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--databases&lt;/span&gt; DATABASE_NAME &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; dump.sql
&lt;span class=&quot;c&quot;&gt;# load&lt;/span&gt;
mysql &lt;span class=&quot;nt&quot;&gt;-S&lt;/span&gt; /data/mysql/mysql.sock &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &amp;lt; dump.sql
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ•°æ®å¯¼å…¥åé‡å»ºä¸šåŠ¡ç”¨æˆ·æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;USE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'test_user'&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'%'&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'test_user'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;OPTION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;FLUSH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;äº”æ•°æ®å¤‡ä»½&quot;&gt;äº”ã€æ•°æ®å¤‡ä»½&lt;/h2&gt;

&lt;h3 id=&quot;51å®‰è£…-xtrabackup&quot;&gt;5.1ã€å®‰è£… xtrabackup&lt;/h3&gt;

&lt;p&gt;ç›®å‰æ•°æ®å¤‡ä»½é‡‡ç”¨ Perconra xtrabackup å·¥å…·ï¼Œxtrabackup å¯ä»¥å®ç°é«˜é€Ÿã€å‹ç¼©å¸¦å¢é‡çš„å¤‡ä»½ï¼›xtrabackup å®‰è£…åŒæ ·é‡‡ç”¨ rpm æ–¹å¼ï¼Œä¸‹è½½åœ°å€ä¸º &lt;a href=&quot;https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST/&quot;&gt;https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST/&lt;/a&gt;ï¼Œä¸‹è½½å®Œæˆåæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yum install&lt;/code&gt; æ—¢å¯&lt;/p&gt;

&lt;h3 id=&quot;52å¤‡ä»½å·¥å…·&quot;&gt;5.2ã€å¤‡ä»½å·¥å…·&lt;/h3&gt;

&lt;p&gt;ç›®å‰å¤‡ä»½å·¥å…·å¼€æºåœ¨ &lt;a href=&quot;https://github.com/gozap/mybak&quot;&gt;GitHub&lt;/a&gt; ä¸Šï¼Œæ¯æ¬¡å…¨é‡å¤‡ä»½ä¼šå†™å…¥ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.full-backup&lt;/code&gt; æ–‡ä»¶ï¼Œå¢é‡å¤‡ä»½ä¼šå†™å…¥ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.inc-backup&lt;/code&gt; æ–‡ä»¶&lt;/p&gt;

&lt;h3 id=&quot;53é…ç½®-systemd&quot;&gt;5.3ã€é…ç½® systemd&lt;/h3&gt;

&lt;p&gt;ä¸ºäº†ä½¿å¤‡ä»½è‡ªåŠ¨è¿è¡Œï¼Œç›®å‰å°†å®šæ—¶ä»»åŠ¡é…ç½®åˆ° systemd ä¸­ï¼Œç”± systemd è°ƒåº¦å¹¶æ‰§è¡Œï¼›ä»¥ä¸‹ä¸ºç›¸å…³ systemd é…ç½®æ–‡ä»¶&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;mysql-backup-full.service&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql full backup
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/mybak &lt;span class=&quot;nt&quot;&gt;--backup-dir&lt;/span&gt; /data/mysql_backup &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; mysql full

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysql-backup-inc.service&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql incremental backup
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/mybak &lt;span class=&quot;nt&quot;&gt;--backup-dir&lt;/span&gt; /data/mysql_backup &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; mysql inc

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysql-backup-compress.service&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql backup compress
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service]
&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;simple
&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-failure
&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/local/bin/mybak &lt;span class=&quot;nt&quot;&gt;--backup-dir&lt;/span&gt; /data/mysql_backup &lt;span class=&quot;nt&quot;&gt;--prefix&lt;/span&gt; mysql compress &lt;span class=&quot;nt&quot;&gt;--clean&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysql-backup-full.timer&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql weekly full backup
&lt;span class=&quot;c&quot;&gt;# å¤‡ä»½ä¹‹å‰ä¾èµ–ç›¸å…³ç›®å½•çš„æŒ‚è½½&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data.mount
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data-mysql_backup.mount

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Timer]
&lt;span class=&quot;c&quot;&gt;# ç›®å‰æ¯å‘¨æ—¥ä¸€ä¸ªå…¨é‡å¤‡ä»½&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Sun &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 3:00
&lt;span class=&quot;nv&quot;&gt;Persistent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;timers.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysql-backup-inc.timer&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql weekly full backup
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data.mount
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data-mysql_backup.mount

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Timer]
&lt;span class=&quot;c&quot;&gt;# æ¯å¤©ä¸‰ä¸ªå¢é‡å¤‡ä»½&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 9:00
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 13:00
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 18:00
&lt;span class=&quot;nv&quot;&gt;Persistent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;timers.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysql-backup-compress.timer&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit]
&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;mysql weekly backup compress
&lt;span class=&quot;c&quot;&gt;# å¤‡ä»½ä¹‹å‰ä¾èµ–ç›¸å…³ç›®å½•çš„æŒ‚è½½&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data.mount
&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;data-mysql_backup.mount

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Timer]
&lt;span class=&quot;c&quot;&gt;# ç›®å‰æ¯å‘¨æ—¥ä¸€ä¸ªå…¨é‡å¤‡ä»½ï¼Œè‡ªåŠ¨å‹ç¼©ååŒæ—¶å®Œæˆæ¸…ç†&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OnCalendar&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Sun &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;-&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; 5:00
&lt;span class=&quot;nv&quot;&gt;Persistent&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install]
&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;timers.target
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;åˆ›å»ºå¥½ç›¸å…³æ–‡ä»¶åå¯åŠ¨ç›¸å…³å®šæ—¶å™¨æ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.timer &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.service /lib/systemd/system
systemctl daemon-reload
systemctl start mysql-backup-full.timer mysql-backup-inc.timer mysql-backup-compress.timer
systemctl &lt;span class=&quot;nb&quot;&gt;enable &lt;/span&gt;mysql-backup-full.timer mysql-backup-inc.timer mysql-backup-compress.timer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;å…­æ•°æ®æ¢å¤&quot;&gt;å…­ã€æ•°æ®æ¢å¤&lt;/h2&gt;

&lt;h3 id=&quot;61å…¨é‡å¤‡ä»½æ¢å¤&quot;&gt;6.1ã€å…¨é‡å¤‡ä»½æ¢å¤&lt;/h3&gt;

&lt;p&gt;é’ˆå¯¹äºå…¨é‡å¤‡ä»½ï¼Œåªéœ€è¦æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„è¿˜åŸé¡ºåºè¿›è¡Œè¿˜åŸæ—¢å¯&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# ç”±äºå¤‡ä»½æ—¶è¿›è¡Œäº†å‹ç¼©ï¼Œæ‰€ä»¥å…ˆè§£å‹å¤‡ä»½æ–‡ä»¶&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--decompress&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--parallel&lt;/span&gt; 4 &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502
&lt;span class=&quot;c&quot;&gt;# æ‰§è¡Œé¢„å¤„ç†&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--prepare&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502
&lt;span class=&quot;c&quot;&gt;# æ‰§è¡Œæ¢å¤(æ¢å¤æ—¶è‡ªåŠ¨æ ¹æ® my.cnf å°†æ•°æ®è¦†ç›–åˆ° data æ•°æ®ç›®å½•)&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--copy-back&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502
&lt;span class=&quot;c&quot;&gt;# ä¿®å¤æ•°æ®ç›®å½•æƒé™&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mysql:mysql /data/mysql
&lt;span class=&quot;c&quot;&gt;# å¯åŠ¨ mysql&lt;/span&gt;
systemctl start mysqld
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;62å¢é‡å¤‡ä»½æ¢å¤&quot;&gt;6.2ã€å¢é‡å¤‡ä»½æ¢å¤&lt;/h3&gt;

&lt;p&gt;å¯¹äºå¢é‡å¤‡ä»½æ¢å¤ï¼Œå…¶ä¸å…¨é‡å¤‡ä»½æ¢å¤çš„æ ¹æœ¬åŒºåˆ«åœ¨äº: &lt;strong&gt;å¯¹äºéæœ€åä¸€ä¸ªå¢é‡æ–‡ä»¶çš„é¢„å¤„ç†å¿…é¡»ä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--apply-log-only&lt;/code&gt; é€‰é¡¹é˜²æ­¢è¿è¡Œå›æ»šé˜¶æ®µçš„å¤„ç†&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# å¯¹æ‰€æœ‰å¤‡ä»½æ–‡ä»¶è¿›è¡Œè§£å‹å¤„ç†&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;dir &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;xtrabackup &lt;span class=&quot;nt&quot;&gt;--decompress&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--parallel&lt;/span&gt; 4 &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$dir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¯¹å…¨é‡å¤‡ä»½æ–‡ä»¶æ‰§è¡Œé¢„å¤„ç†(æ³¨æ„å¢åŠ  --apply-log-only é€‰é¡¹)&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--prepare&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apply-log-only&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502
&lt;span class=&quot;c&quot;&gt;# å¯¹éæœ€åä¸€ä¸ªå¢é‡å¤‡ä»½æ‰§è¡Œé¢„å¤„ç†&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--prepare&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--apply-log-only&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502 &lt;span class=&quot;nt&quot;&gt;--incremental-dir&lt;/span&gt; /data/mysql_backup/mysql-inc-20191206230802
&lt;span class=&quot;c&quot;&gt;# å¯¹æœ€åä¸€ä¸ªå¢é‡å¤‡ä»½æ‰§è¡Œé¢„å¤„ç†(ä¸éœ€è¦ --apply-log-only)&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--prepare&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502 &lt;span class=&quot;nt&quot;&gt;--incremental-dir&lt;/span&gt; /data/mysql_backup/mysql-inc-20191207031005
&lt;span class=&quot;c&quot;&gt;# æ‰§è¡Œæ¢å¤(æ¢å¤æ—¶è‡ªåŠ¨æ ¹æ® my.cnf å°†æ•°æ®è¦†ç›–åˆ° data æ•°æ®ç›®å½•)&lt;/span&gt;
xtrabackup &lt;span class=&quot;nt&quot;&gt;--copy-back&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt; /data/mysql_backup/mysql-20191205230502
&lt;span class=&quot;c&quot;&gt;# ä¿®å¤æ•°æ®ç›®å½•æƒé™&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mysql:mysql /data/mysql
&lt;span class=&quot;c&quot;&gt;# å¯åŠ¨ mysql&lt;/span&gt;
systemctl start mysqld
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;63åˆ›å»º-slave&quot;&gt;6.3ã€åˆ›å»º slave&lt;/h3&gt;

&lt;p&gt;é’ˆå¯¹ xtrabackup å¤‡ä»½çš„æ•°æ®å¯ä»¥ç›´æ¥æ¢å¤æˆ slave èŠ‚ç‚¹ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹:&lt;/p&gt;

&lt;p&gt;é¦–å…ˆå°†å¤‡ä»½æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æœºå™¨ï¼Œç„¶åæ‰§è¡Œè§£å‹(é»˜è®¤å¤‡ä»½å·¥å…·é‡‡ç”¨ lz4 å‹ç¼©)&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;xtrabackup &lt;span class=&quot;nt&quot;&gt;--decompress&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xxxxxx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è§£å‹å®Œæˆåæ‰§è¡Œé¢„å¤„ç†æ“ä½œ(&lt;strong&gt;åœ¨æ‰§è¡Œé¢„å¤„ç†ä¹‹å‰è¯·ç¡®ä¿ slave æœºå™¨ä¸Šç›¸å…³é…ç½®æ–‡ä»¶ä¸ master ç›¸åŒï¼Œå¹¶ä¸”å¤„ç†å¥½æ•°æ®ç›®å½•å­˜æ”¾ç­‰&lt;/strong&gt;)&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;xtrabackup &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;root &lt;span class=&quot;nt&quot;&gt;--password&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xxxxxxx &lt;span class=&quot;nt&quot;&gt;--prepare&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xxxx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;é¢„å¤„ç†æˆåŠŸåä¾¿å¯æ‰§è¡Œæ¢å¤ï¼Œä»¥ä¸‹å‘½ä»¤å°†è‡ªåŠ¨è¯»å– &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;my.cnf&lt;/code&gt; é…ç½®ï¼Œè‡ªåŠ¨è¯†åˆ«æ•°æ®ç›®å½•ä½ç½®å¹¶å°†æ•°æ®æ–‡ä»¶ç§»åŠ¨åˆ°è¯¥ä½ç½®&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;xtrabackup &lt;span class=&quot;nt&quot;&gt;--move-back&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--target-dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;xxxxx
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ‰€ç”±å‡†å¤‡å°±ç»ªåéœ€è¦è¿›è¡Œæƒé™ä¿®å¤&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mysql:mysql MYSQL_DATA_DIR
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æœ€ååœ¨ mysql å†…å¯åŠ¨ slave æ—¢å¯ï¼Œslave ä¿¡æ¯å¯é€šè¿‡ä»æ•°æ®å¤‡ä»½ç›®å½•çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xtrabackup_binlog_info&lt;/code&gt; ä¸­è·å–&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# è·å–å¤‡ä»½ POS ä¿¡æ¯&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cat &lt;/span&gt;xxxxxx/xtrabackup_binlog_info

&lt;span class=&quot;c&quot;&gt;# åˆ›å»º slave èŠ‚ç‚¹&lt;/span&gt;
CHANGE MASTER TO
    &lt;span class=&quot;nv&quot;&gt;MASTER_HOST&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'192.168.2.48'&lt;/span&gt;,
    &lt;span class=&quot;nv&quot;&gt;MASTER_USER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'repl'&lt;/span&gt;,
    &lt;span class=&quot;nv&quot;&gt;MASTER_PASSWORD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'xxxxxxx'&lt;/span&gt;,
    &lt;span class=&quot;nv&quot;&gt;MASTER_LOG_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'mysql-bin.000005'&lt;/span&gt;,
    &lt;span class=&quot;nv&quot;&gt;MASTER_LOG_POS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;52500595&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# å¯åŠ¨ slave&lt;/span&gt;
start slave&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
show slave status &lt;span class=&quot;se&quot;&gt;\G&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;ä¸ƒç”Ÿäº§å¤„ç†&quot;&gt;ä¸ƒã€ç”Ÿäº§å¤„ç†&lt;/h2&gt;

&lt;h3 id=&quot;71æ•°æ®ç›®å½•&quot;&gt;7.1ã€æ•°æ®ç›®å½•&lt;/h3&gt;

&lt;p&gt;ç›®å‰ç”Ÿäº§ç¯å¢ƒæ•°æ®ç›®å½•ä½ç½®è°ƒæ•´åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/home/mysql&lt;/code&gt;ï¼Œæ‰€ä»¥ç›®å½•æƒé™å¤„ç†ä¹Ÿè¦åšå¯¹åº”è°ƒæ•´&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; /var/log/mysql /home/mysql_tmp
&lt;span class=&quot;nb&quot;&gt;chown&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-R&lt;/span&gt; mysql:mysql /var/log/mysql /home/mysql_tmp
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;72é…ç½®æ–‡ä»¶&quot;&gt;7.2ã€é…ç½®æ–‡ä»¶&lt;/h3&gt;

&lt;p&gt;ç”Ÿäº§ç¯å¢ƒç›®å‰èŠ‚ç‚¹é…ç½®å¦‚ä¸‹&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;CPU: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;RAM: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;128G&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;æ‰€ä»¥é…ç½®æ–‡ä»¶ä¹Ÿéœ€è¦åšç›¸åº”çš„ä¼˜åŒ–è°ƒæ•´&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;mysql.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[mysql]&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;auto-rehash&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;default_character_set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysqld.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# Percona Server template configuration
&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;[mysqld]&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#
# Remove leading # and set to the amount of RAM for the most important data
# cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.
# innodb_buffer_pool_size = 128M
#
# Remove leading # to turn on a very important data integrity option: logging
# changes to the binary log between backups.
# log_bin
#
# Remove leading # to set options mainly useful for reporting servers.
# The server defaults are faster for transactions and fast SELECTs.
# Adjust sizes as needed, experiment to find the optimal values.
# join_buffer_size = 128M
# sort_buffer_size = 2M
# read_rnd_buffer_size = 2M
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;3306&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;datadir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/home/mysql/mysql&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;socket&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/home/mysql/mysql/mysql.sock&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;pid_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/home/mysql/mysql/mysqld.pid&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# æœåŠ¡ç«¯ç¼–ç 
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;character_set_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æœåŠ¡ç«¯æ’åº
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;collation_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4_general_ci&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼ºåˆ¶ä½¿ç”¨ utf8mb4 ç¼–ç é›†ï¼Œå¿½ç•¥å®¢æˆ·ç«¯è®¾ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;skip_character_set_client_handshake&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_output&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;FILE&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼€å¯å¸¸è§„æ—¥å¿—è¾“å‡º
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;general_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¸¸è§„æ—¥å¿—è¾“å‡ºæ–‡ä»¶ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;general_log_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/mysql/mysqld.log&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# é”™è¯¯æ—¥å¿—ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/mysql/mysqld-error.log&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è®°å½•æ…¢æŸ¥è¯¢
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;slow_query_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ…¢æŸ¥è¯¢æ—¶é—´(å¤§äº 1s è¢«è§†ä¸ºæ…¢æŸ¥è¯¢)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;long_query_time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;slow_query_log_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/var/log/mysql/mysqld-slow.log&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ä¸´æ—¶æ–‡ä»¶ä½ç½®
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;tmpdir&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;/home/mysql/mysql_tmp&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# The number of open tables for all threads.(refs https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_table_open_cache)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;table_open_cache&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16384&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ–‡ä»¶æè¿°ç¬¦(æ­¤å¤„ä¿®æ”¹ä¸ç”Ÿæ•ˆï¼Œè¯·ä¿®æ”¹ systemd service é…ç½®) 
# refs https://www.percona.com/blog/2017/10/12/open_files_limit-mystery/
# refs https://www.cnblogs.com/wxxjianchi/p/10370419.html
#open_files_limit=65535
# è¡¨å®šä¹‰ç¼“å­˜(5.7 ä»¥åè‡ªåŠ¨è°ƒæ•´)
# refs https://dev.mysql.com/doc/refman/5.6/en/server-system-variables.html#sysvar_table_definition_cache
# refs http://mysql.taobao.org/monthly/2015/08/10/
#table_definition_cache=16384
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;sort_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;join_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MyiSAM å¼•æ“ä¸“ç”¨(å†…éƒ¨ä¸´æ—¶ç£ç›˜è¡¨å¯èƒ½ä¼šç”¨)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;read_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;read_rnd_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MyiSAM å¼•æ“ä¸“ç”¨(å†…éƒ¨ä¸´æ—¶ç£ç›˜è¡¨å¯èƒ½ä¼šç”¨)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;key_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# MyiSAM å¼•æ“ä¸“ç”¨(å†…éƒ¨ä¸´æ—¶ç£ç›˜è¡¨å¯èƒ½ä¼šç”¨)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;bulk_insert_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# myisam_sort_buffer_size ä¸ sort_buffer_size åŒºåˆ«è¯·å‚è€ƒ(https://stackoverflow.com/questions/7871027/myisam-sort-buffer-size-vs-sort-buffer-size)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;myisam_sort_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;64M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å†…éƒ¨å†…å­˜ä¸´æ—¶è¡¨å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;tmp_table_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç”¨æˆ·åˆ›å»ºçš„ MEMORY è¡¨æœ€å¤§å¤§å°(tmp_table_size å—æ­¤å€¼å½±å“)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_heap_table_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼€å¯æŸ¥è¯¢ç¼“å­˜
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;query_cache_type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æŸ¥è¯¢ç¼“å­˜å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;query_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;32M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# sql mode
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;sql_mode&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;'STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;########### Network ###########
# æœ€å¤§è¿æ¥æ•°(è¯¥å‚æ•°å—åˆ°æœ€å¤§æ–‡ä»¶æè¿°ç¬¦å½±å“ï¼Œå¦‚æœä¸ç”Ÿæ•ˆè¯·æ£€æŸ¥æœ€å¤§æ–‡ä»¶æè¿°ç¬¦è®¾ç½®)
# refs https://stackoverflow.com/questions/39976756/the-max-connections-in-mysql-5-7
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_connections&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1500&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# mysql å †æ ˆå†…æš‚å­˜çš„é“¾æ¥æ•°é‡
# å½“çŸ­æ—¶é—´å†…é“¾æ¥æ•°é‡è¶…è¿‡ max_connections æ—¶ï¼Œéƒ¨åˆ†é“¾æ¥ä¼šå­˜å‚¨åœ¨å †æ ˆå†…ï¼Œå­˜å‚¨æ•°é‡å—æ­¤å‚æ•°æ§åˆ¶
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;back_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æœ€å¤§é“¾æ¥é”™è¯¯ï¼Œé’ˆå¯¹äº client ä¸»æœºï¼Œè¶…è¿‡æ­¤æ•°é‡çš„é“¾æ¥é”™è¯¯å°†ä¼šå¯¼è‡´ mysql server é’ˆå¯¹æ­¤ä¸»æœºæ‰§è¡Œé”å®š(ç¦æ­¢é“¾æ¥ ERROR 1129 )
# æ­¤é”™è¯¯è®¡æ•°ä»…åœ¨ mysql é“¾æ¥æ¡æ‰‹å¤±è´¥æ‰ä¼šè®¡ç®—ï¼Œä¸€èˆ¬å‡ºç°é—®é¢˜æ—¶éƒ½æ˜¯ç½‘ç»œæ•…éšœ
# refs https://www.cnblogs.com/kerrycode/p/8405862.html
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_connect_errors&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;100000&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# mysql server å…è®¸çš„æœ€å¤§æ•°æ®åŒ…å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_allowed_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;64M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# äº¤äº’å¼å®¢æˆ·ç«¯é“¾æ¥è¶…æ—¶(30åˆ†é’Ÿè‡ªåŠ¨æ–­å¼€)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;interactive_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1800&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# éäº¤äº’å¼é“¾æ¥è¶…æ—¶æ—¶é—´(10åˆ†é’Ÿ)
# å¦‚æœå®¢æˆ·ç«¯æœ‰è¿æ¥æ± ï¼Œåˆ™éœ€è¦åå•†æ­¤å‚æ•°(refs https://database.51cto.com/art/201909/603519.htm)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;wait_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;28800&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è·³è¿‡å¤–éƒ¨æ–‡ä»¶ç³»ç»Ÿé”å®š
# If you run multiple servers that use the same database directory (not recommended), 
# each server must have external locking enabled.
# refs https://dev.mysql.com/doc/refman/5.7/en/external-locking.html
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;skip_external_locking&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è·³è¿‡é“¾æ¥çš„åŸŸåè§£æ(å¼€å¯æ­¤é€‰é¡¹å mysql ç”¨æˆ·æˆæƒçš„ host æ–¹å¼å¤±æ•ˆ)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;skip_name_resolve&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç¦ç”¨ä¸»æœºåç¼“å­˜ï¼Œæ¯æ¬¡éƒ½ä¼šèµ° DNS
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;host_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;########### REPL ###########
# å¼€å¯ binlog
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_bin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-bin&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ä½œä¸ºä»åº“æ—¶ï¼ŒåŒæ­¥ä¿¡æ¯ä¾ç„¶å†™å…¥ binlogï¼Œæ–¹ä¾¿æ­¤ä»åº“å†ä½œä¸ºå…¶ä»–ä»åº“çš„ä¸»åº“
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;log_slave_updates&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# server idï¼Œé»˜è®¤ä¸º ipv4 åœ°å€å»é™¤ç¬¬ä¸€æ®µ
# eg: 192.168.2.48 =&amp;gt; 168248
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;server_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;168248&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ¯ n æ¬¡äº‹åŠ¡ binlog åˆ·æ–°åˆ°ç£ç›˜
# refs http://liyangliang.me/posts/2014/03/innodb_flush_log_at_trx_commit-and-sync_binlog/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;sync_binlog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;100&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# binlog æ ¼å¼(refs https://zhuanlan.zhihu.com/p/33504555)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;binlog_format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;row&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# binlog è‡ªåŠ¨æ¸…ç†æ—¶é—´
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;expire_logs_days&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;20&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å¼€å¯ relay-logï¼Œä¸€èˆ¬ä½œä¸º slave æ—¶å¼€å¯
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;relay_log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;mysql-replay&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ä¸»ä»å¤åˆ¶æ—¶è·³è¿‡ test åº“
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;replicate_ignore_db&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;test&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ¯ä¸ª session binlog ç¼“å­˜
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;binlog_cache_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# binlog æ»šåŠ¨å¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;max_binlog_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1024M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# GTID ç›¸å…³(refs https://keithlan.github.io/2016/06/23/gtid/)
#gtid_mode=1
#enforce_gtid_consistency=1
&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;########### InnoDB ###########
# æ°¸ä¹…è¡¨é»˜è®¤å­˜å‚¨å¼•æ“
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;default_storage_engine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;InnoDB&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç³»ç»Ÿè¡¨ç©ºé—´æ•°æ®æ–‡ä»¶å¤§å°(åˆå§‹åŒ–ä¸º 1Gï¼Œå¹¶ä¸”è‡ªåŠ¨å¢é•¿)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_data_file_path&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;ibdata1:1G:autoextend&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB ç¼“å­˜æ± å¤§å°(èµ„æºå……è¶³ï¼Œä¸ºæ‰€æ¬²ä¸º)
# innodb_buffer_pool_size å¿…é¡»ç­‰äº innodb_buffer_pool_chunk_size*innodb_buffer_pool_instancesï¼Œæˆ–è€…æ˜¯å…¶æ•´æ•°å€
# refs https://dev.mysql.com/doc/refman/5.7/en/innodb-buffer-pool-resize.html
# refs https://zhuanlan.zhihu.com/p/60089484
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;61440M&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_instances&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# é»˜è®¤ 128M
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_chunk_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;128M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB å¼ºåˆ¶æ¢å¤(refs https://www.askmaclean.com/archives/mysql-innodb-innodb_force_recovery.html)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_force_recovery&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB buffer é¢„çƒ­(refs http://www.dbhelp.net/2017/01/12/mysql-innodb-buffer-pool-warmup.html)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_dump_at_shutdown&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_buffer_pool_load_at_startup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB æ—¥å¿—ç»„ä¸­çš„æ—¥å¿—æ–‡ä»¶æ•°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_log_files_in_group&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB redo æ—¥å¿—å¤§å°
# refs https://www.percona.com/blog/2017/10/18/chose-mysql-innodb_log_file_size/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_log_file_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256MB&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ç¼“å­˜è¿˜æœªæäº¤çš„äº‹åŠ¡çš„ç¼“å†²åŒºå¤§å°
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_log_buffer_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16M&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB åœ¨äº‹åŠ¡æäº¤åçš„æ—¥å¿—å†™å…¥é¢‘ç‡
# refs http://liyangliang.me/posts/2014/03/innodb_flush_log_at_trx_commit-and-sync_binlog/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_flush_log_at_trx_commit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB DML æ“ä½œè¡Œçº§é”ç­‰å¾…æ—¶é—´
# è¶…æ—¶è¿”å› ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction
# refs https://ningyu1.github.io/site/post/75-mysql-lock-wait-timeout-exceeded/
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_lock_wait_timeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;30&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB è¡Œçº§é”è¶…æ—¶æ˜¯å¦å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œé»˜è®¤ä¸º OFF ä»…å›æ»šä¸Šä¸€æ¡è¯­å¥
# æ­¤æ—¶åº”ç”¨ç¨‹åºå¯ä»¥æ¥å—åˆ°é”™è¯¯åé€‰æ‹©æ˜¯å¦ç»§ç»­æäº¤äº‹åŠ¡(å¹¶æ²¡æœ‰è¿å ACID åŸå­æ€§)
# refs https://www.cnblogs.com/hustcat/archive/2012/11/18/2775487.html
#innodb_rollback_on_timeout=ON
# InnoDB æ•°æ®å†™å…¥ç£ç›˜çš„æ–¹å¼ï¼Œå…·ä½“è§åšå®¢æ–‡ç« 
# refs https://www.cnblogs.com/gomysql/p/3595806.html
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_flush_method&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;O_DIRECT&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB ç¼“å†²æ± è„é¡µåˆ·æ–°ç™¾åˆ†æ¯”
# refs https://dbarobin.com/2015/08/29/mysql-optimization-under-ssd
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_max_dirty_pages_pct&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;50&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB æ¯ç§’æ‰§è¡Œçš„å†™IOé‡
# refs https://www.centos.bz/2016/11/mysql-performance-tuning-15-config-item/#10.INNODB_IO_CAPACITY,%20INNODB_IO_CAPACITY_MAX
# refs https://www.alibabacloud.com/blog/testing-io-performance-with-sysbench_594709
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_io_capacity&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;8000&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;innodb_io_capacity_max&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;16000&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# è¯·æ±‚å¹¶å‘ InnoDB çº¿ç¨‹æ•°
# refs https://www.cnblogs.com/xinysu/p/6439715.html#_lab2_1_0
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_thread_concurrency&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# å†ä½¿ç”¨å¤šä¸ª InnoDB è¡¨ç©ºé—´æ—¶ï¼Œå…è®¸æ‰“å¼€çš„æœ€å¤§ &quot;.ibd&quot; æ–‡ä»¶ä¸ªæ•°ï¼Œä¸è®¾ç½®é»˜è®¤ 300ï¼Œ
# å¹¶ä¸”å–ä¸ table_open_cache ç›¸æ¯”è¾ƒå¤§çš„ä¸€ä¸ªï¼Œæ­¤é€‰é¡¹ç‹¬ç«‹äº open_files_limit
# refs https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_open_files
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_open_files&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;65535&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ¯ä¸ª InnoDB è¡¨éƒ½å­˜å‚¨åœ¨ç‹¬ç«‹çš„è¡¨ç©ºé—´(.ibd)ä¸­
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_file_per_table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# äº‹åŠ¡çº§åˆ«(å¯é‡å¤è¯»ï¼Œä¼šå‡ºå¹»è¯»)
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;transaction_isolation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;REPEATABLE-READ&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# æ˜¯å¦åœ¨æœç´¢å’Œç´¢å¼•æ‰«æä¸­ä½¿ç”¨é—´éš™é”(gap locking)ï¼Œä¸å»ºè®®ä½¿ç”¨æœªæ¥å°†åˆ é™¤
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_locks_unsafe_for_binlog&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# InnoDB åå°æ¸…ç†çº¿ç¨‹æ•°ï¼Œæ›´å¤§çš„å€¼æœ‰åŠ©äº DML æ‰§è¡Œæ€§èƒ½ï¼Œ&amp;gt;= 5.7.8 é»˜è®¤ä¸º 4
&lt;/span&gt;&lt;span class=&quot;py&quot;&gt;innodb_purge_threads&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysqld_safe.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#
# The Percona Server 5.7 configuration file.
#
# One can use all long options that the program supports.
# Run program with --help to get a list of available options and with
# --print-defaults to see which it would actually understand and use.
#
# For explanations see
# http://dev.mysql.com/doc/mysql/en/server-system-variables.html
&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;[mysqld_safe]&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;pid-file&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/run/mysqld/mysqld.pid&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;socket&lt;/span&gt;   &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;/var/run/mysqld/mysqld.sock&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;nice&lt;/span&gt;     &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;0&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;mysqldump.cnf&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[mysqldump]&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;quick&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;default-character-set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;utf8mb4&lt;/span&gt;
&lt;span class=&quot;py&quot;&gt;max_allowed_packet&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;256M&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;å…«å¸¸ç”¨è¯Šæ–­&quot;&gt;å…«ã€å¸¸ç”¨è¯Šæ–­&lt;/h2&gt;

&lt;h3 id=&quot;81åŠ¨æ€é…ç½®-diff&quot;&gt;8.1ã€åŠ¨æ€é…ç½® diff&lt;/h3&gt;

&lt;p&gt;mysql é»˜è®¤å…è®¸åœ¨å®ä¾‹è¿è¡Œåä½¿ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;set global VARIABLES=VALUE&lt;/code&gt; çš„æ–¹å¼åŠ¨æ€è°ƒæ•´ä¸€äº›é…ç½®ï¼Œè¿™å¯èƒ½å¯¼è‡´åœ¨è¿è¡Œä¸€æ®µæ—¶é—´å(è¿ç»´åŠ¨æ€ä¿®æ”¹)å®ä¾‹è¿è¡Œé…ç½®å’Œé…ç½®æ–‡ä»¶ä¸­é…ç½®ä¸ä¸€è‡´ï¼›æ‰€ä»¥&lt;strong&gt;å»ºè®®å®šæœŸ diff è¿è¡Œæ—¶é…ç½®ä¸é…ç½®æ–‡ä»¶é…ç½®å·®å¼‚ï¼Œé˜²åˆ¶ç‰¹æ®Šæƒ…å†µä¸‹ mysql é‡å¯åè¿è¡ŒæœŸé…ç½®ä¸¢å¤±&lt;/strong&gt;&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pt-config-diff /etc/percona-server.conf.d/mysqld.cnf &lt;span class=&quot;nv&quot;&gt;h&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;127.0.0.1 &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;--ask-pass&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--report-width&lt;/span&gt; 100
Enter MySQL password:
2 config differences
Variable                  /etc/percona-server.conf.d/mysqld.cnf mysql47.test.com
&lt;span class=&quot;o&quot;&gt;=========================&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=====================================&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==================&lt;/span&gt;
innodb_max_dirty_pages... 50                                    50.000000
skip_name_resolve         0                                     ON
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;82é…ç½®ä¼˜åŒ–å»ºè®®&quot;&gt;8.2ã€é…ç½®ä¼˜åŒ–å»ºè®®&lt;/h3&gt;

&lt;p&gt;Percona Toolkit æä¾›äº†ä¸€ä¸ªè¯Šæ–­å·¥å…·ï¼Œç”¨äºå¯¹ mysql å†…çš„é…ç½®è¿›è¡Œæ‰«æå¹¶ç»™å‡ºä¼˜åŒ–å»ºè®®ï¼Œåœ¨åˆå§‹åŒ–æ—¶å¯ä»¥ä½¿ç”¨æ­¤å·¥å…·è¯„ä¼° mysql å½“å‰é…ç½®çš„å…·ä½“æƒ…å†µ&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pt-variable-advisor 127.0.0.1 &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;--ask-pass&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'^$'&lt;/span&gt;
Enter password: 

&lt;span class=&quot;c&quot;&gt;# WARN delay_key_write: MyISAM index blocks are never flushed until necessary.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WARN innodb_flush_log_at_trx_commit-1: InnoDB is not configured in strictly ACID mode.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# NOTE innodb_max_dirty_pages_pct: The innodb_max_dirty_pages_pct is lower than the default.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WARN max_connections: If the server ever really has more than a thousand threads running, then the system is likely to spend more time scheduling threads than really doing useful work.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# NOTE read_buffer_size-1: The read_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# NOTE read_rnd_buffer_size-1: The read_rnd_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# NOTE sort_buffer_size-1: The sort_buffer_size variable should generally be left at its default unless an expert determines it is necessary to change it.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# NOTE innodb_data_file_path: Auto-extending InnoDB files can consume a lot of disk space that is very difficult to reclaim later.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WARN myisam_recover_options: myisam_recover_options should be set to some value such as BACKUP,FORCE to ensure that table corruption is noticed.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WARN sync_binlog: Binary logging is enabled, but sync_binlog isn't configured so that every transaction is flushed to the binary log for durability.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;83æ­»é”è¯Šæ–­&quot;&gt;8.3ã€æ­»é”è¯Šæ–­&lt;/h3&gt;

&lt;p&gt;ä½¿ç”¨ pt-deadlock-logger å·¥å…·å¯ä»¥è¯Šæ–­å½“å‰çš„æ­»é”çŠ¶æ€ï¼Œä»¥ä¸‹ä¸ºå¯¹æ­»é”æ£€æµ‹çš„æµ‹è¯•&lt;/p&gt;

&lt;p&gt;é¦–å…ˆåˆ›å»ºæµ‹è¯•æ•°æ®åº“å’Œè¡¨&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;åˆ›å»ºæµ‹è¯•åº“&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DATABASE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dbatest&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;CHARACTER&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8mb4&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;COLLATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;utf8mb4_unicode_ci&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;åˆ‡æ¢åˆ°æµ‹è¯•åº“å¹¶å»ºç«‹æµ‹è¯•è¡¨&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;USE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dbatest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;EXISTS&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;INT&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTO_INCREMENT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;KEY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;VARCHAR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;255&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;createtime&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;TIMESTAMP&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;DEFAULT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CURRENT_TIMESTAMP&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ENGINE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;INNODB&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;åœ¨ä¸€ä¸ªå…¶ä»–ç»ˆç«¯ä¸Šå¼€å¯ pt-deadlock-logger æ£€æµ‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pt-deadlock-logger 127.0.0.1 &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;--ask-pass&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--tab&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ£€æµ‹å¼€å¯åè¿›è¡Œæ­»é”æµ‹è¯•&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;æ’å…¥ä¸¤æ¡æµ‹è¯•æ•°æ®&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'test1'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;INTO&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;VALUES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'test2'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;åœ¨ä¸¤ä¸ªç»ˆç«¯ä¸‹è¿›è¡Œäº¤å‰äº‹åŠ¡&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;ç»Ÿä¸€å…³é—­è‡ªåŠ¨æäº¤&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTOCOMMIT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;SET&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;AUTOCOMMIT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;äº¤å‰äº‹åŠ¡ï¼Œç»ˆç«¯&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;å…ˆæ›´æ–°ç¬¬ä¸€æ¡æ•°æ®ï¼Œç»ˆç«¯&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;å…ˆæ›´æ–°ç¬¬äºŒæ¡æ•°æ®&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BEGIN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'x1'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BEGIN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'x2'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;æ­¤åç»ˆç«¯&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;å†å°è¯•æ›´æ–°ç¬¬äºŒæ¡æ•°æ®ï¼Œç»ˆç«¯&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;å†å°è¯•æ›´æ–°ç¬¬ä¸€æ¡æ•°æ®ï¼›é€ æˆç­‰å¾…äº’å‘é‡Šæ”¾é”çš„æ­»é”&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'lock2'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;terminal_2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'lock1'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;æ­¤æ—¶ç”±äºå¼€å¯äº†&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;innodb&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;çš„æ­»é”è‡ªåŠ¨æ£€æµ‹æœºåˆ¶ï¼Œä¼šå¯¼è‡´ç»ˆç«¯&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;å¼¹å‡ºé”™è¯¯&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ERROR&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1213&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;40001&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Deadlock&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;found&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;when&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;trying&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;to&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;restarting&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;transaction&lt;/span&gt;

&lt;span class=&quot;o&quot;&gt;#&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;åŒæ—¶&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;deadlock&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;æœ‰æ—¥å¿—è¾“å‡º&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;server&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;ts&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;thread&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;txn_id&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;txn_time&lt;/span&gt;        &lt;span class=&quot;k&quot;&gt;user&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;hostname&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;ip&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;db&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;tbl&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;idx&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;lock_type&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;lock_mode&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;wait_hold&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;victim&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;query&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;2019&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;57&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;87&lt;/span&gt;      &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;52&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;            &lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;dbatest&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RECORD&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;       &lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'lock2'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;2019&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;24&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;T14&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;57&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;10&lt;/span&gt;     &lt;span class=&quot;mi&quot;&gt;89&lt;/span&gt;      &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;41&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;root&lt;/span&gt;            &lt;span class=&quot;mi&quot;&gt;127&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;dbatest&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;RECORD&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;X&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;       &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;       &lt;span class=&quot;k&quot;&gt;UPDATE&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'lock1'&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;where&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;84æŸ¥çœ‹-io-è¯¦æƒ…&quot;&gt;8.4ã€æŸ¥çœ‹ IO è¯¦æƒ…&lt;/h3&gt;

&lt;p&gt;ä¸åŒäº &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iostat&lt;/code&gt;ï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pt-diskstats&lt;/code&gt; æä¾›äº†æ›´åŠ è¯¦ç»†çš„ IO è¯¦æƒ…ç»Ÿè®¡ï¼Œå¹¶ä¸”æ®æœ‰äº¤äº’å¼å¤„ç†ï¼Œæ‰§è¡Œä¸€ä¸‹å‘½ä»¤å°†ä¼šå®æ—¶æ£€æµ‹ IO çŠ¶æ€&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pt-diskstats &lt;span class=&quot;nt&quot;&gt;--show-timestamps&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å…¶ä¸­å‡ ä¸ªå…³é”®å€¼å«ä¹‰å¦‚ä¸‹(æ›´è¯¦ç»†çš„è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ &lt;a href=&quot;https://www.percona.com/doc/percona-toolkit/LATEST/pt-diskstats.html#output&quot;&gt;https://www.percona.com/doc/percona-toolkit/LATEST/pt-diskstats.html#output&lt;/a&gt;)&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;rd_s: æ¯ç§’å¹³å‡è¯»å–æ¬¡æ•°ã€‚è¿™æ˜¯å‘é€åˆ°åŸºç¡€è®¾å¤‡çš„ IO è¯·æ±‚æ•°ã€‚é€šå¸¸ï¼Œæ­¤æ•°é‡å°‘äºåº”ç”¨ç¨‹åºå‘å‡ºçš„é€»è¾‘IOè¯·æ±‚çš„æ•°é‡ã€‚æ›´å¤šè¯·æ±‚å¯èƒ½å·²æ’é˜Ÿåˆ°å—è®¾å¤‡ï¼Œä½†æ˜¯å…¶ä¸­ä¸€äº›è¯·æ±‚é€šå¸¸åœ¨å‘é€åˆ°ç£ç›˜ä¹‹å‰å…ˆè¿›è¡Œåˆå¹¶ã€‚&lt;/li&gt;
  &lt;li&gt;rd_avkb: è¯»å–çš„å¹³å‡å¤§å°ï¼Œä»¥åƒå­—èŠ‚ä¸ºå•ä½ã€‚&lt;/li&gt;
  &lt;li&gt;rd_mb_s: æ¯ç§’è¯»å–çš„å¹³å‡å…†å­—èŠ‚æ•°ã€‚&lt;/li&gt;
  &lt;li&gt;rd_mrg: åœ¨å‘é€åˆ°ç‰©ç†è®¾å¤‡ä¹‹å‰åœ¨é˜Ÿåˆ—è°ƒåº¦ç¨‹åºä¸­åˆå¹¶åœ¨ä¸€èµ·çš„è¯»å–è¯·æ±‚çš„ç™¾åˆ†æ¯”ã€‚&lt;/li&gt;
  &lt;li&gt;rd_rt: è¯»å–æ“ä½œçš„å¹³å‡å“åº”æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½)ï¼›è¿™æ˜¯ç«¯åˆ°ç«¯å“åº”æ—¶é—´ï¼ŒåŒ…æ‹¬åœ¨é˜Ÿåˆ—ä¸­èŠ±è´¹çš„æ—¶é—´ã€‚è¿™æ˜¯å‘å‡º IO è¯·æ±‚çš„åº”ç”¨ç¨‹åºçœ‹åˆ°çš„å“åº”æ—¶é—´ï¼Œè€Œä¸æ˜¯å—è®¾å¤‡ä¸‹çš„ç‰©ç†ç£ç›˜çš„å“åº”æ—¶é—´ã€‚&lt;/li&gt;
  &lt;li&gt;busy: è®¾å¤‡è‡³å°‘æœ‰ä¸€ä¸ªè¯·æ±‚ wall-clock æ—¶é—´çš„æ¯”ä¾‹ï¼›ç­‰åŒäº &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;iostat&lt;/code&gt; çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ï¼…util&lt;/code&gt;ã€‚&lt;/li&gt;
  &lt;li&gt;in_prg: æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚æ•°ã€‚ä¸è¯»å†™å¹¶å‘æ˜¯ä»å¯é æ•°å­—ä¸­ç”Ÿæˆçš„å¹³å‡å€¼ä¸åŒï¼Œè¯¥æ•°å­—æ˜¯ä¸€ä¸ªæ—¶æ ·æœ¬ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å®ƒå¯èƒ½è¡¨ç¤ºè¯·æ±‚å³°å€¼ï¼Œè€Œä¸æ˜¯çœŸæ­£çš„é•¿æœŸå¹³å‡å€¼ã€‚å¦‚æœæ­¤æ•°å­—å¾ˆå¤§ï¼Œåˆ™ä»æœ¬è´¨ä¸Šè®²æ„å‘³ç€è®¾å¤‡é«˜è´Ÿè½½è¿è¡Œã€‚&lt;/li&gt;
  &lt;li&gt;ios_s: ç‰©ç†è®¾å¤‡çš„å¹³å‡ååé‡ï¼Œä»¥æ¯ç§’ IO æ“ä½œ(IOPS)ä¸ºå•ä½ã€‚æ­¤åˆ—æ˜¾ç¤ºåŸºç¡€è®¾å¤‡æ­£åœ¨å¤„ç†çš„æ€» IOPSï¼›å®ƒæ˜¯ rd_s å’Œ wr_s çš„æ€»å’Œã€‚&lt;/li&gt;
  &lt;li&gt;qtime: å¹³å‡æ’é˜Ÿæ—¶é—´ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯·æ±‚åœ¨å‘é€åˆ°ç‰©ç†è®¾å¤‡ä¹‹å‰åœ¨è®¾å¤‡è°ƒåº¦ç¨‹åºé˜Ÿåˆ—ä¸­èŠ±è´¹çš„æ—¶é—´ã€‚&lt;/li&gt;
  &lt;li&gt;stime: å¹³å‡æœåŠ¡æ—¶é—´ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯·æ±‚å®Œæˆåœ¨é˜Ÿåˆ—ä¸­çš„ç­‰å¾…ä¹‹åï¼Œç‰©ç†è®¾å¤‡å¤„ç†è¯·æ±‚çš„æ—¶é—´ã€‚&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;85é‡å¤ç´¢å¼•ä¼˜åŒ–&quot;&gt;8.5ã€é‡å¤ç´¢å¼•ä¼˜åŒ–&lt;/h3&gt;

&lt;p&gt;pt-duplicate-key-checker å·¥å…·æä¾›äº†å¯¹æ•°æ®åº“é‡å¤ç´¢å¼•å’Œå¤–é”®çš„è‡ªåŠ¨æŸ¥æ‰¾åŠŸèƒ½ï¼Œå·¥å…·ä½¿ç”¨å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pt-duplicate-key-checker 127.0.0.1 &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;--ask-pass&lt;/span&gt;
Enter password:

&lt;span class=&quot;c&quot;&gt;# A software update is available:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ########################################################################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# aaaaaa.aaaaaa_audit&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ########################################################################&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# index_linkId is a duplicate of unique_linkId&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Key definitions:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#   KEY `index_linkId` (`link_id`)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#   UNIQUE KEY `unique_linkId` (`link_id`),&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Column types:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;#         `link_id` bigint(20) not null comment 'bdid'&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# To remove this duplicate index, execute:&lt;/span&gt;
ALTER TABLE &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;aaaaaa.aaaaaa_audit&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt; DROP INDEX &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;index_linkId&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# ########################################################################&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Summary of indexes&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# ########################################################################&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;# Size Duplicate Indexes   927420&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Total Duplicate Indexes  3&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# Total Indexes            847&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;86è¡¨ç»Ÿè®¡&quot;&gt;8.6ã€è¡¨ç»Ÿè®¡&lt;/h3&gt;

&lt;p&gt;pt-find æ˜¯ä¸€ä¸ªå¾ˆæ–¹ä¾¿çš„è¡¨æŸ¥æ‰¾ç»Ÿè®¡å·¥å…·ï¼Œé»˜è®¤çš„ä¸€äº›é€‰é¡¹å¯ä»¥å®ç°æ‰¹é‡æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„è¡¨ï¼Œç”šè‡³æ‰§è¡Œä¸€äº› SQL å¤„ç†å‘½ä»¤&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# æ‰¹é‡æŸ¥æ‰¾å¤§äº 5G çš„è¡¨ï¼Œå¹¶æ’åº&lt;/span&gt;
pt-find &lt;span class=&quot;nt&quot;&gt;--host&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;--ask-pass&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--tablesize&lt;/span&gt; +5G | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rn&lt;/span&gt;
Enter password: 

&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;rss_service&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_feed_news&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;db_log_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click_201912&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;db_log_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click_201911&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;db_log_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click_201910&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_user_messages&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_user_link_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_message&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_link_votes&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_links_mobile_content&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_links&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_comment_votes&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_comments&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;å¦‚æœæƒ³è¦å®šåˆ¶è¾“å‡ºå¯ä»¥é‡‡ç”¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--printf&lt;/code&gt; é€‰é¡¹&lt;/p&gt;

&lt;div class=&quot;language-sh highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pt-find &lt;span class=&quot;nt&quot;&gt;--host&lt;/span&gt; 127.0.0.1 &lt;span class=&quot;nt&quot;&gt;--user&lt;/span&gt; root &lt;span class=&quot;nt&quot;&gt;--ask-pass&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--tablesize&lt;/span&gt; +5G &lt;span class=&quot;nt&quot;&gt;--printf&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;%T&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\t&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;%D.%N&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sort&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rn&lt;/span&gt;
Enter password: 

13918404608     &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_links_mobile_content&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
13735231488     &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_comment_votes&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
12633227264     &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_user_messages&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
12610174976     &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_user_link_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
10506305536     &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_links&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
9686745088      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_message&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
9603907584      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;rss_service&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_feed_news&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
9004122112      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;db_log_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click_201910&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
8919007232      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_comments&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
8045707264      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;db_log_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click_201912&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
7855915008      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;db_log_history&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click_201911&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
6099566592      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_mobile_click&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
5892898816      &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_dix&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;.&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;test_link_votes&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;é—æ†¾çš„æ˜¯ç›®å‰ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;printf&lt;/code&gt; æ ¼å¼æ¥æºä¸ Perl çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sprintf&lt;/code&gt; å‡½æ•°ï¼Œæ‰€ä»¥æ”¯æŒæ ¼å¼æœ‰é™ï¼Œä¸è¿‡ç®€å•çš„æ ¼å¼å®šåˆ¶å·²ç»åŸºæœ¬å®ç°ï¼Œå¤æ‚çš„å»ºè®®é€šè¿‡ awk å¤„ç†&lt;/strong&gt;ï¼›å…¶ä»–çš„å¯é€‰å‚æ•°å…·ä½“å‚è€ƒå®˜æ–¹æ–‡æ¡£ &lt;a href=&quot;https://www.percona.com/doc/percona-toolkit/LATEST/pt-find.html&quot;&gt;https://www.percona.com/doc/percona-toolkit/LATEST/pt-find.html&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;87å…¶ä»–å‘½ä»¤&quot;&gt;8.7ã€å…¶ä»–å‘½ä»¤&lt;/h3&gt;

&lt;p&gt;è¿«äºç¯‡å¹…ï¼Œå…¶ä»–æ›´å¤šçš„é«˜çº§å‘½ä»¤è¯·è‡ªè¡ŒæŸ¥é˜…å®˜æ–¹æ–‡æ¡£ &lt;a href=&quot;https://www.percona.com/doc/percona-toolkit/LATEST/index.html&quot;&gt;https://www.percona.com/doc/percona-toolkit/LATEST/index.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 21 Jan 2020 20:41:22 +0800</pubDate>
        <link>https://mritd.me/2020/01/21/set-up-percona-server/</link>
        <guid isPermaLink="true">https://mritd.me/2020/01/21/set-up-percona-server/</guid>
        
        <category>Linux</category>
        
        
        <category>Linux</category>
        
      </item>
    
      <item>
        <title>å¦‚ä½•ç¼–å†™ä¸€ä¸ª CoreDNS æ’ä»¶</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;ç›®å‰æµ‹è¯•ç¯å¢ƒä¸­æœ‰å¾ˆå¤šä¸ª DNS æœåŠ¡å™¨ï¼Œä¸åŒé¡¹ç›®ç»„ä½¿ç”¨çš„ DNS æœåŠ¡å™¨ä¸åŒï¼Œä½†æ˜¯ä¸å¯é¿å…çš„ä»–ä»¬ä¼šè®¿é—®ä¸€äº›å…¬å…±åŸŸåï¼›è€çš„ DNS æœåŠ¡å™¨éƒ½æ˜¯ dnsmasqï¼Œæ”¹èµ·æ¥å¾ˆéº»çƒ¦ï¼Œæœ€è¿‘ç ”ç©¶äº†ä¸€ä¸‹ CoreDNSï¼Œé€šè¿‡ç¼–å†™æ’ä»¶çš„æ–¹å¼å¯ä»¥å®ç°è®©å¤šä¸ª CoreDNS å®ä¾‹å®ç°åˆ†å¸ƒå¼çš„ç»Ÿä¸€æ§åˆ¶ï¼Œä»¥ä¸‹è®°å½•äº†æ’ä»¶ç¼–å†™è¿‡ç¨‹&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;ä¸€coredns-ç®€ä»‹&quot;&gt;ä¸€ã€CoreDNS ç®€ä»‹&lt;/h2&gt;

&lt;p&gt;CoreDNS ç›®å‰æ˜¯ CNCF æ——ä¸‹çš„é¡¹ç›®(å·²æ¯•ä¸š)ï¼Œä¸º Kubernetes ç­‰äº‘åŸç”Ÿç¯å¢ƒæä¾›å¯é çš„ DNS æœåŠ¡å‘ç°ç­‰åŠŸèƒ½ï¼›å®˜ç½‘çš„æè¿°åªæœ‰ä¸€å¥è¯: &lt;strong&gt;CoreDNS: DNS and Service Discovery&lt;/strong&gt;ï¼Œè€Œå®é™…ä¸Šåˆ†ææºç ä»¥åå‘ç° CoreDNS å®é™…ä¸Šæ˜¯åŸºäº Caddy (ä¸€ä¸ªç°ä»£åŒ–çš„è´Ÿè½½å‡è¡¡å™¨)è€Œå¼€å‘çš„ï¼Œé€šè¿‡æ’ä»¶å¼æ³¨å…¥ï¼Œå¹¶ç›‘å¬ TCP/UDP ç«¯å£æä¾› DNS æœåŠ¡ï¼›&lt;strong&gt;å¾—ç›Šäº Caddy çš„æ’ä»¶æœºåˆ¶ï¼ŒCoreDNS æ”¯æŒè‡ªè¡Œç¼–å†™æ’ä»¶ï¼Œæ‹¦æˆª DNS è¯·æ±‚ç„¶åå¤„ç†ï¼Œ&lt;/strong&gt;é€šè¿‡è¿™ä¸ªæ’ä»¶æœºåˆ¶ä½ å¯ä»¥åœ¨ CoreDNS ä¸Šå®ç°å„ç§åŠŸèƒ½ï¼Œæ¯”å¦‚æ„å»ºåˆ†å¸ƒå¼ä¸€è‡´æ€§çš„ DNS é›†ç¾¤ã€åŠ¨æ€çš„ DNS è´Ÿè½½å‡è¡¡ç­‰ç­‰&lt;/p&gt;

&lt;h2 id=&quot;äºŒcoredns-æ’ä»¶è§„èŒƒ&quot;&gt;äºŒã€CoreDNS æ’ä»¶è§„èŒƒ&lt;/h2&gt;

&lt;h3 id=&quot;21æ’ä»¶æ¨¡å¼&quot;&gt;2.1ã€æ’ä»¶æ¨¡å¼&lt;/h3&gt;

&lt;p&gt;CoreDNS æ’ä»¶ç¼–å†™ç›®å‰æœ‰ä¸¤ç§æ–¹å¼:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;æ·±åº¦è€¦åˆ CoreDNSï¼Œä½¿ç”¨ Go ç¼–å†™æ’ä»¶ï¼Œç›´æ¥ç¼–è¯‘è¿› CoreDNS äºŒè¿›åˆ¶æ–‡ä»¶&lt;/li&gt;
  &lt;li&gt;é€šè¿‡ GRPC è§£è€¦ï¼Œä»»æ„è¯­è¨€ç¼–å†™ GRPC æ¥å£å®ç°ï¼ŒCoreDNS é€šè¿‡ GRPC ä¸æ’ä»¶äº¤äº’&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ç”±äº GRPC é“¾æ¥å®é™…ä¸Šå€ŸåŠ©äº CoreDNS çš„ GRPC æ’ä»¶ï¼ŒåŒæ—¶ GRPC ä¼šæœ‰ç½‘ç»œå¼€é”€ï¼ŒTCP é“¾æ¥ä¸ç¨³å®šå¯èƒ½é€ æˆ DNS å“åº”è¿‡æ…¢ç­‰é—®é¢˜ï¼Œæ‰€ä»¥æœ¬æ–‡åªä»‹ç»å¦‚ä½•ä½¿ç”¨ Go ç¼–å†™ CoreDNS çš„æ’ä»¶ï¼Œè¿™ç§æ’ä»¶å°†ç›´æ¥ç¼–è¯‘è¿› CoreDNS äºŒè¿›åˆ¶æ–‡ä»¶ä¸­&lt;/p&gt;

&lt;h3 id=&quot;22æ’ä»¶æ³¨å†Œ&quot;&gt;2.2ã€æ’ä»¶æ³¨å†Œ&lt;/h3&gt;

&lt;p&gt;åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œæ’ä»¶ä¸­åº”å½“åŒ…å«ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;setup.go&lt;/code&gt; æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; æ–¹æ³•è°ƒç”¨æ’ä»¶æ³¨å†Œï¼Œç±»ä¼¼è¿™æ ·&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;init&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; 
    &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Register&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;gdns&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; 
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;æ³¨å†Œæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ’ä»¶åç§°ï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ª funcï¼Œfunc ç­¾åå¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// SetupFunc is used to set up a plugin, or in other words,&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// execute a directive. It will be called once per key for&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// each server block it appears in.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;SetupFunc&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;åœ¨è¿™ä¸ª SetupFunc ä¸­ï¼Œæ’ä»¶ç¼–å†™è€…åº”å½“é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*Controller&lt;/code&gt; æ‹¿åˆ° CoreDNS çš„é…ç½®å¹¶è§£æå®ƒï¼Œä»è€Œå®Œæˆè‡ªå·±æ’ä»¶çš„åˆå§‹åŒ–é…ç½®ï¼›&lt;/strong&gt;æ¯”å¦‚ä½ çš„æ’ä»¶éœ€è¦è¿æ¥ Etcdï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ–¹æ³•é‡Œä½ è¦é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*Controller&lt;/code&gt; éå†é…ç½®ï¼Œæ‹¿åˆ° Etcd çš„åœ°å€ã€è¯ä¹¦ã€ç”¨æˆ·åå¯†ç é…ç½®ç­‰ä¿¡æ¯ï¼›&lt;/p&gt;

&lt;p&gt;å¦‚æœé…ç½®ä¿¡æ¯æ²¡æœ‰é—®é¢˜ï¼Œè¯¥æ’ä»¶åº”å½“åˆå§‹åŒ–å®Œæˆï¼›å¦‚æœæœ‰é—®é¢˜å°±æŠ¥é”™é€€å‡ºï¼Œç„¶åæ•´ä¸ª CoreDNS å¯åŠ¨å¤±è´¥ï¼›å¦‚æœæ’ä»¶åˆå§‹åŒ–å®Œæˆï¼Œæœ€åä¸è¦å¿˜è®°å°†è‡ªå·±çš„æ’ä»¶åŠ å…¥åˆ°æ•´ä¸ªæ’ä»¶é“¾è·¯ä¸­(CoreDNS æ ¹æ®æƒ…å†µé€ä¸ªè°ƒç”¨)&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;setup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;caddy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Controller&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;etcdParse&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;gdns&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;dnsserver&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetConfig&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AddPlugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;next&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Next&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;23æ’ä»¶ç»“æ„ä½“&quot;&gt;2.3ã€æ’ä»¶ç»“æ„ä½“&lt;/h3&gt;

&lt;p&gt;ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸€ä¸ªæ’ä»¶éƒ½ä¼šå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œ&lt;strong&gt;ç»“æ„ä½“ä¸­åŒ…å«å¿…è¦çš„ CoreDNS å†…ç½®å±æ€§ï¼Œä»¥åŠå½“å‰æ’ä»¶ç‰¹æ€§çš„ç›¸å…³é…ç½®ï¼›&lt;/strong&gt;ä¸€ä¸ªæ ·ä¾‹çš„æ’ä»¶ç»“æ„ä½“å¦‚ä¸‹æ‰€ç¤º&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;GDNS&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;c&quot;&gt;// Next å±æ€§åœ¨ Setup ä¹‹åä¼šè¢«è®¾ç½®åˆ°ä¸‹ä¸€ä¸ªæ’ä»¶çš„å¼•ç”¨ï¼Œä»¥ä¾¿åœ¨æœ¬æ’ä»¶è§£æå¤±è´¥åå¯ä»¥äº¤ç”±ä¸‹é¢çš„æ’ä»¶ç»§ç»­è§£æ&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Next&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Fall åˆ—è¡¨ç”¨æ¥æ§åˆ¶å“ªäº›åŸŸåçš„è¯·æ±‚è§£æå¤±è´¥åå¯ä»¥ç»§ç»­ç©¿é€åˆ°ä¸‹ä¸€ä¸ªæ’ä»¶é‡æ–°å¤„ç†&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Fall&lt;/span&gt;       &lt;span class=&quot;n&quot;&gt;fall&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;F&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// Zones è¡¨ç¤ºå½“å‰æ’ä»¶åº”è¯¥ case å“ªäº›åŸŸåçš„ DNS è¯·æ±‚&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Zones&lt;/span&gt;      &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	
	&lt;span class=&quot;c&quot;&gt;// PathPrefix å’Œ Client å°±æ˜¯æ’ä»¶æœ¬èº«çš„ä¸šåŠ¡å±æ€§äº†ï¼Œç”±äºæ’ä»¶è¦è¿ Etcd&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// PathPrefix å°±æ˜¯ Etcd ç›®å½•å‰ç¼€ï¼ŒClient æ˜¯ä¸€ä¸ª Etcd çš„ client&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// endpoints æ˜¯ Etcd api ç«¯ç‚¹çš„åœ°å€&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;PathPrefix&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Client&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etcdcv3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Client&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;endpoints&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;// Stored here as well, to aid in testing.&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;24æ’ä»¶æ¥å£&quot;&gt;2.4ã€æ’ä»¶æ¥å£&lt;/h3&gt;

&lt;p&gt;ä¸€ä¸ª Go ç¼–å†™çš„ CoreDNS æ’ä»¶å®é™…ä¸Šåªéœ€è¦å®ç°ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Handler&lt;/code&gt; æ¥å£æ—¢å¯ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// Handler is like dns.Handler except ServeDNS may return an rcode&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// and/or error.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// If ServeDNS writes to the response body, it should return a status&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// code. CoreDNS assumes *no* reply has yet been written if the status&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// code is one of the following:&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// * SERVFAIL (dns.RcodeServerFailure)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// * REFUSED (dns.RecodeRefused)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// * FORMERR (dns.RcodeFormatError)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// * NOTIMP (dns.RcodeNotImplemented)&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// All other response codes signal other handlers above it that the&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// response message is already written, and that they should not write&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// to it also.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// If ServeDNS encounters an error, it should return the error value&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// so it can be logged by designated error-handling plugin.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// If writing a response after calling another ServeDNS method, the&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// returned rcode SHOULD be used when writing the response.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// If handling errors after calling another ServeDNS method, the&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// returned error value SHOULD be logged or handled accordingly.&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;//&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// Otherwise, return values should be propagated down the plugin&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;// chain by returning them unchanged.&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;Handler&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ServeDNS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ResponseWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ServeDNS&lt;/code&gt; æ–¹æ³•æ˜¯æ’ä»¶éœ€è¦å®ç°çš„ä¸»è¦é€»è¾‘æ–¹æ³•ï¼ŒDNS è¯·æ±‚æ¥å—åä¼šä»è¿™ä¸ªæ–¹æ³•ä¼ å…¥ï¼Œæ’ä»¶ç¼–å†™è€…éœ€è¦å®ç°æŸ¥è¯¢å¹¶è¿”å›ç»“æœ&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Name&lt;/code&gt; æ–¹æ³•åªè¿”å›ä¸€ä¸ªæ’ä»¶åç§°æ ‡è¯†ï¼Œå…·ä½“ä½œç”¨è®°ä¸å¤ªæ¸…æ¥šï¼Œå¥½åƒæ˜¯ä¸ºäº†åˆ¤æ–­æ’ä»¶å‘½åå”¯ä¸€æ€§ç„¶ååšé“¾å¼é¡ºåºè°ƒç”¨çš„ï¼ŒåŸåˆ™åªè¦ä½ ä¸è·Ÿç³»ç»Ÿæ’ä»¶é‡åå°±è¡Œ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;strong&gt;åŸºæœ¬é€»è¾‘å°±æ˜¯åœ¨ setup é˜¶æ®µé€šè¿‡é…ç½®æ–‡ä»¶åˆ›å»ºä½ çš„æ’ä»¶ç»“æ„ä½“å¯¹è±¡ï¼›ç„¶åæ’ä»¶ç»“æ„ä½“å®ç°è¿™ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Handler&lt;/code&gt; æ¥å£ï¼Œè¿è¡ŒæœŸ CoreDNS ä¼šè°ƒç”¨æ¥å£çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ServeDNS&lt;/code&gt; æ–¹æ³•æ¥å‘æ’ä»¶æŸ¥è¯¢ DNS è¯·æ±‚&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;25servedns-æ–¹æ³•&quot;&gt;2.5ã€ServeDNS æ–¹æ³•&lt;/h3&gt;

&lt;p&gt;ServeDNS æ–¹æ³•å…¥å‚æœ‰ 3 ä¸ª:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;context.Context&lt;/code&gt; ç”¨æ¥æ§åˆ¶è¶…æ—¶ç­‰æƒ…å†µçš„ context&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dns.ResponseWriter&lt;/code&gt; æ’ä»¶é€šè¿‡è¿™ä¸ªå¯¹è±¡å†™å…¥å¯¹ Client DNS è¯·æ±‚çš„å“åº”ç»“æœ&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*dns.Msg&lt;/code&gt; è¿™ä¸ªæ˜¯ Client å‘èµ·çš„ DNS è¯·æ±‚ï¼Œæ’ä»¶è´Ÿè´£å¤„ç†å®ƒï¼Œæ¯”å¦‚å½“ä½ å‘ç°è¯·æ±‚ç±»å‹æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;AAAA&lt;/code&gt; è€Œä½ çš„æ’ä»¶åˆä¸æƒ³å»æ”¯æŒæ—¶è¦å¦‚ä½•è¿”å›ç»“æœ&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;å¯¹äºè¿”å›ç»“æœï¼Œæ’ä»¶ç¼–å†™è€…åº”å½“é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dns.ResponseWriter.WriteMsg&lt;/code&gt; æ–¹æ³•å†™å…¥è¿”å›ç»“æœï¼ŒåŸºæœ¬ä»£ç å¦‚ä¸‹&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// ServeDNS implements the plugin.Handler interface.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gDNS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GDNS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServeDNS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ResponseWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	
	&lt;span class=&quot;c&quot;&gt;// ...... è¿™é‡Œåº”å½“å®ç°ä½ çš„ä¸šåŠ¡é€»è¾‘ï¼ŒæŸ¥æ‰¾ç›¸åº”çš„ DNS è®°å½•&lt;/span&gt;
	
	&lt;span class=&quot;c&quot;&gt;// æœ€åé€šè¿‡ new ä¸€ä¸ª dns.Msg ä½œä¸ºè¿”å›ç»“æœ&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Authoritative&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
	
	&lt;span class=&quot;c&quot;&gt;// records æ˜¯çœŸæ­£çš„è®°å½•ç»“æœï¼Œåº”å½“åœ¨ä¸šåŠ¡é€»è¾‘åŒºå‡†å¤‡å¥½&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Answer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Answer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	
	&lt;span class=&quot;c&quot;&gt;// è¿”å›ç»“æœ&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WriteMsg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

   &lt;span class=&quot;c&quot;&gt;// å‘Šè¯‰ CoreDNS æ˜¯å¦å¤„ç†æˆåŠŸ&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RcodeSuccess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºæ ¹æ®ä¸šåŠ¡é€»è¾‘æ˜¯å¦æŸ¥è¯¢åˆ° DNS è®°å½•ï¼Œéƒ½è¦è¿”å›å“åº”ç»“æœ(æ²¡æœ‰å°±è¿”å›ç©º)ï¼Œé”™è¯¯æˆ–è€…æœªè¿”å›å°†ä¼šå¯¼è‡´ Client ç«¯æŸ¥è¯¢ DNS è¶…æ—¶ï¼Œç„¶åä¸æ–­é‡è¯•ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´ Client ç«¯æœåŠ¡æ•…éšœ&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;26name-æ–¹æ³•&quot;&gt;2.6ã€Name æ–¹æ³•&lt;/h3&gt;

&lt;p&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Name&lt;/code&gt; æ–¹æ³•éå¸¸ç®€å•ï¼Œåªéœ€è¦è¿”å›å½“å‰æ’ä»¶åç§°æ—¢å¯ï¼›è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯ä¸ºäº†å…¶ä»–æ’ä»¶åˆ¤æ–­æœ¬æ’ä»¶æ˜¯å¦åŠ è½½ç­‰æƒ…å†µ&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// Name implements the Handler interface.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gDNS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GDNS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;gdns&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;ä¸‰coredns-æ’ä»¶å¤„ç†&quot;&gt;ä¸‰ã€CoreDNS æ’ä»¶å¤„ç†&lt;/h2&gt;

&lt;p&gt;å¯¹äºå®é™…çš„ä¸šåŠ¡å¤„ç†ï¼Œå¯ä»¥é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;case&lt;/code&gt; è¯·æ±‚ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;QType&lt;/code&gt; æ¥åšå…·ä½“çš„ä¸šåŠ¡å®ç°&lt;/p&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;// ServeDNS implements the plugin.Handler interface.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gDNS&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GDNS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ServeDNS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ResponseWriter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;request&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;W&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Req&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;zone&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Zones&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gDNS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Zones&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Matches&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;zone&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;plugin&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NextOrFailure&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gDNS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gDNS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// ...ä¸šåŠ¡å¤„ç†&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;switch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;QType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TypeA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// A è®°å½•æŸ¥è¯¢ä¸šåŠ¡é€»è¾‘&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TypeAAAA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// AAAA è®°å½•æŸ¥è¯¢ä¸šåŠ¡é€»è¾‘&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Msg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;SetReply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Authoritative&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Answer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;append&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Answer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;records&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;w&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WriteMsg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dns&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;RcodeSuccess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;å››æ’ä»¶ç¼–è¯‘åŠæµ‹è¯•&quot;&gt;å››ã€æ’ä»¶ç¼–è¯‘åŠæµ‹è¯•&lt;/h2&gt;

&lt;h3 id=&quot;41å®˜æ–¹æ ‡å‡†æ“ä½œ&quot;&gt;4.1ã€å®˜æ–¹æ ‡å‡†æ“ä½œ&lt;/h3&gt;

&lt;p&gt;æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼Œå½“ä½ ç¼–å†™å¥½æ’ä»¶ä»¥åï¼Œ&lt;strong&gt;ä½ çš„æ’ä»¶åº”å½“æäº¤åˆ°ä¸€ä¸ª Git ä»“åº“ä¸­ï¼Œå¯ä»¥ä½¿ Github ç­‰(ä¿è¯å¯ä»¥ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;go get&lt;/code&gt; æ‹‰å–å°±è¡Œ)ï¼Œç„¶åä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plugin.cfg&lt;/code&gt;ï¼Œæœ€åæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; æ—¢å¯&lt;/strong&gt;ï¼›å…·ä½“ä¿®æ”¹å¦‚ä¸‹æ‰€ç¤º&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/vey4u.png&quot; alt=&quot;plugin.cfg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;å€¼å¾—æ³¨æ„çš„æ˜¯: æ’ä»¶é…ç½®åœ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plugin.cfg&lt;/code&gt; å†…çš„é¡ºåºå†³å®šäº†æ’ä»¶çš„æ‰§è¡Œé¡ºåºï¼›é€šä¿—çš„è®²ï¼Œå¦‚æœ Client çš„ä¸€ä¸ª DNS è¯·æ±‚è¿›æ¥ï¼ŒCoreDNS æ ¹æ®ä½ åœ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plugin.cfg&lt;/code&gt; å†…ä¹¦å†™çš„é¡ºåºä¾æ¬¡è°ƒç”¨ï¼Œè€Œå¹¶é &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Corefile&lt;/code&gt; å†…çš„é…ç½®é¡ºåº&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;é…ç½®å¥½ä»¥åç›´æ¥æ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; æ—¢å¯ç¼–è¯‘æˆåŠŸä¸€ä¸ªåŒ…å«è‡ªå®šä¹‰æ’ä»¶çš„ CoreDNS äºŒè¿›åˆ¶æ–‡ä»¶(ç¼–è¯‘è¿‡ç¨‹çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;go mod&lt;/code&gt; ä¸‹è½½åŠ é€Ÿé—®é¢˜ä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…)ï¼›ä½ å¯ä»¥ç›´æ¥é€šè¿‡è¿™ä¸ªäºŒè¿›åˆ¶æµ‹è¯•æ’ä»¶çš„å¤„ç†æƒ…å†µï¼Œå½“ç„¶è¿™ç§æµ‹è¯•ä¸å¤Ÿç›´è§‚ï¼Œè€Œä¸”é¢‘ç¹ä¿®æ”¹ç”±äº &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;go mod&lt;/code&gt; ç¼“å­˜ç­‰åŸå› å¹¶ä¸ä¸€å®šèƒ½ä¿è¯æ¯æ¬¡ç¼–è¯‘çš„éƒ½åŒ…å«æœ€æ–°æ’ä»¶ä»£ç ï¼Œæ‰€ä»¥å¦ä¸€ç§æ–¹å¼è¯·çœ‹ä¸‹ä¸€ç« èŠ‚&lt;/p&gt;

&lt;h3 id=&quot;42ç»éªŒæ€§çš„æ“ä½œ&quot;&gt;4.2ã€ç»éªŒæ€§çš„æ“ä½œ&lt;/h3&gt;

&lt;p&gt;æ ¹æ®ä¸ªäººæµ‹è¯•ä»¥åŠå¯¹æºç çš„åˆ†æï¼Œåœ¨ä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plugin.cfg&lt;/code&gt; ç„¶åæ‰§è¡Œ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; å‘½ä»¤åï¼Œå®é™…ä¸Šæ˜¯è¿›è¡Œäº†ä»£ç ç”Ÿæˆï¼›å½“ä½ é€šè¿‡ git å‘½ä»¤æŸ¥çœ‹ç›¸å…³ä¿®æ”¹æ–‡ä»¶æ—¶ï¼Œæ•´ä¸ªæ’ä»¶åŠ è½½ä½“ç³»ä¾¿æ²¡ä»€ä¹ˆç§˜å¯†å¯è¨€äº†ï¼›&lt;strong&gt;åœ¨æ•´ä¸ªæ’ä»¶ä½“ç³»ä¸­ï¼Œæ’ä»¶åŠ è½½æ˜¯é€šè¿‡ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; æ–¹æ³•æ³¨å†Œçš„ï¼Œé‚£ä¹ˆæ—¢ç„¶ç”¨ go å†™æ’ä»¶ï¼Œé‚£ä¹ˆåº”è¯¥æ¸…æ¥š &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; æ–¹æ³•åªæœ‰åœ¨åŒ…å¼•ç”¨ä¹‹åæ‰ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥æ•´ä¸ªæ’ä»¶ä½“ç³»å®é™…ä¸Šæ˜¯è¿™æ ·äº‹å„¿çš„:&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;é¦–å…ˆ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; ä»¥åä¼šä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;core/plugin/zplugin.go&lt;/code&gt; æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å•¥ä¹Ÿä¸å¹²ï¼Œå°±æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;import&lt;/code&gt; æ¥å®ç°è°ƒç”¨å¯¹åº”åŒ…çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; æ–¹æ³•&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/ny1rz.png&quot; alt=&quot;zplugin.go&quot; /&gt;&lt;/p&gt;

&lt;p&gt;å½“ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; æ‰§è¡Œåä½ å»è¿½æºç ï¼Œå®é™…ä¸Šå°±æ˜¯ Caddy ç»´æŠ¤äº†ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;map[string]Plugin&lt;/code&gt;ï¼Œ&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;init&lt;/code&gt; ä¼šæŠŠä½ çš„æ’ä»¶ func å¡è¿›å»ç„¶ååé¢å†è°ƒç”¨ï¼Œå®ç°ä¸€ä¸ªæ‡’åŠ è½½æˆ–è€…è¯´å»¶è¿Ÿåˆå§‹åŒ–&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/idno4.png&quot; alt=&quot;caddy_plugin&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æ¥ç€ä¿®æ”¹äº†ä¸€ä¸‹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;core/dnsserver/zdirectives.go&lt;/code&gt;ï¼Œè¿™ä¸ªé‡Œé¢ä¹Ÿæ²¡å•¥ï¼Œå°±æ˜¯ä¸€ä¸ª &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;[]string&lt;/code&gt;ï¼Œ&lt;strong&gt;ä½†æ˜¯ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;[]string&lt;/code&gt; è¿™ç©æ„æœ‰é¡ºåºå•Šï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ åœ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plugin.cfg&lt;/code&gt; é‡Œå†™çš„é¡ºåºå†³å®šäº†æ’ä»¶å¤„ç†é¡ºåºçš„åŸå› (å› ä¸ºç”Ÿæˆçš„è¿™ä¸ªåˆ‡ç‰‡æœ‰é¡ºåº)&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/bixos.png&quot; alt=&quot;zdirectives.go&quot; /&gt;&lt;/p&gt;

&lt;p&gt;ç»¼ä¸Šæ‰€è¿°ï¼Œå®é™…ä¸Š &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;make&lt;/code&gt; å‘½ä»¤ä¸€å…±ä¿®æ”¹äº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæƒ³åœ¨ IDE å†…ç›´æ¥ debug CoreDNS + Plugin æºç ï¼Œé‚£ä¹ˆåªéœ€è¦è¿™æ ·åš:&lt;/p&gt;

&lt;p&gt;å¤åˆ¶è‡ªå·±ç¼–å†™çš„æ’ä»¶ç›®å½•åˆ° &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;plugin&lt;/code&gt; ç›®å½•ï¼Œç±»ä¼¼è¿™æ ·&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/whwuy.png&quot; alt=&quot;gdns&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æ‰‹åŠ¨ä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;core/plugin/zplugin.go&lt;/code&gt;ï¼ŒåŠ å…¥è‡ªå·±æ’ä»¶çš„ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;import&lt;/code&gt;(æ­¤æ—¶ä½ ç›´æ¥å¤åˆ¶ç³»ç»Ÿå…¶ä»–æ’ä»¶ï¼Œæ”¹ä¸€ä¸‹ç›®å½•åæ—¢å¯)&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/g7wp0.png&quot; alt=&quot;update_zplugin&quot; /&gt;&lt;/p&gt;

&lt;p&gt;æ‰‹åŠ¨ä¿®æ”¹ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;core/dnsserver/zdirectives.go&lt;/code&gt; æŠŠè‡ªå·±æ’ä»¶åç§°å†™è¿›å»(è‡ªå·±æ§åˆ¶é¡ºåº)ï¼Œç„¶å debug å¯åŠ¨ &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;coredns.go&lt;/code&gt; é‡Œé¢çš„ main æ–¹æ³•æµ‹è¯•æ—¢å¯&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://cdn.oss.link/markdown/4ucqg.png&quot; alt=&quot;coredns.go&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;äº”æœ¬æ–‡å‚è€ƒ&quot;&gt;äº”ã€æœ¬æ–‡å‚è€ƒ&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;Writing Plugins for CoreDNS: https://coredns.io/2016/12/19/writing-plugins-for-coredns&lt;/li&gt;
  &lt;li&gt;how-to-add-plugins.md: https://github.com/coredns/coredns.io/blob/master/content/blog/how-to-add-plugins.md&lt;/li&gt;
  &lt;li&gt;example plugin: https://github.com/coredns/example&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Tue, 05 Nov 2019 20:55:53 +0800</pubDate>
        <link>https://mritd.me/2019/11/05/writing-plugin-for-coredns/</link>
        <guid isPermaLink="true">https://mritd.me/2019/11/05/writing-plugin-for-coredns/</guid>
        
        <category>Golang</category>
        
        
        <category>Golang</category>
        
      </item>
    
      <item>
        <title>Golang Etcd client example</title>
        <description>&lt;blockquote&gt;
  &lt;p&gt;å‡†å¤‡å¼€å‘ç‚¹ä¸œè¥¿ï¼Œéœ€è¦ç”¨åˆ° Etcdï¼Œç”±äºç”Ÿäº§ Etcd å…¨éƒ¨å¼€å¯äº† TLS åŠ å¯†ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯éœ€è¦ç›¸åº”ä¿®æ”¹ï¼Œä»¥ä¸‹ä¸º Golang é“¾æ¥ Etcd å¹¶ä¸”ä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯çš„æ ·ä¾‹ä»£ç &lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;api-v2&quot;&gt;API V2&lt;/h2&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;context&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;crypto/tls&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;crypto/x509&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;io/ioutil&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;log&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;net&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;net/http&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;time&quot;&lt;/span&gt;

	&lt;span class=&quot;s&quot;&gt;&quot;go.etcd.io/etcd/client&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// ä¸ºäº†ä¿è¯ HTTPS é“¾æ¥å¯ä¿¡ï¼Œéœ€è¦é¢„å…ˆåŠ è½½ç›®æ ‡è¯ä¹¦ç­¾å‘æœºæ„çš„ CA æ ¹è¯ä¹¦&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;etcdCA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ioutil&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReadFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/Users/mritd/tmp/etcd_ssl/etcd-root-ca.pem&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// etcd å¯ç”¨äº†åŒå‘ TLS è®¤è¯ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è¯ä¹¦åŒæ ·éœ€è¦åŠ è½½&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;etcdClientCert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LoadX509KeyPair&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/Users/mritd/tmp/etcd_ssl/etcd.pem&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/Users/mritd/tmp/etcd_ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// åˆ›å»ºä¸€ä¸ªç©ºçš„ CA Pool&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// å› ä¸ºåç»­åªä¼šé“¾æ¥ Etcd çš„ api ç«¯ç‚¹ï¼Œæ‰€ä»¥æ­¤å¤„é€‰æ‹©ä½¿ç”¨ç©ºçš„ CA Poolï¼Œç„¶ååªåŠ å…¥ Etcd CA æ—¢å¯&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// å¦‚æœæœŸæœ›é“¾æ¥å…¶ä»– TLS ç«¯ç‚¹ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨ x509.SystemCertPool() æ–¹æ³•å…ˆ copy ä¸€ä»½ç³»ç»Ÿæ ¹ CA&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// ç„¶åå†å‘è¿™ä¸ª Pool ä¸­æ·»åŠ è‡ªå®šä¹‰ CA&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rootCertPool&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x509&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewCertPool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rootCertPool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendCertsFromPEM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etcdCA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// Etcd HTTPS api ç«¯ç‚¹&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;Endpoints&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://172.16.14.114:2379&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// è‡ªå®šä¹‰ Transport å®ç°è‡ªç­¾ CA åŠ è½½ä»¥åŠ Client Cert åŠ è½½&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// å…¶ä»–å‚æ•°æœ€å¥½ä» client.DefaultTranspor copyï¼Œä»¥ä¿è¯ä¸é»˜è®¤ client ç›¸åŒçš„è¡Œä¸º&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;Transport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Transport&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;Proxy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ProxyFromEnvironment&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// Dial æ–¹æ³•å·²è¢«å¯ç”¨ï¼Œé‡‡ç”¨æ–°çš„ DialContext è®¾ç½®è¶…æ—¶&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;DialContext&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;net&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Dialer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;KeepAlive&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;Timeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;m&quot;&gt;30&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;DialContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;c&quot;&gt;// è‡ªå®šä¹‰ CA åŠ Client Cert é…ç½®&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;TLSClientConfig&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;RootCAs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;rootCertPool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;Certificates&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Certificate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etcdClientCert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;TLSHandshakeTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// set timeout per request to fail fast when the target endpoint is unavailable&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;HeaderTimeoutPerRequest&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cfg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;kapi&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewKeysAPI&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// set &quot;/foo&quot; key with &quot;bar&quot; value&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Setting '/foo' key with 'bar' value&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kapi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/foo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;bar&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// print common key info&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Set is done. Metadata is %q&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// get &quot;/foo&quot; key's value&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Print&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Getting '/foo' key value&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kapi&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/foo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// print common key info&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Get is done. Metadata is %q&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// print value&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;%q key has %q value&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Node&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;api-v3&quot;&gt;API V3&lt;/h2&gt;

&lt;div class=&quot;language-golang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;context&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;crypto/tls&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;crypto/x509&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;io/ioutil&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;log&quot;&lt;/span&gt;
	&lt;span class=&quot;s&quot;&gt;&quot;time&quot;&lt;/span&gt;

	&lt;span class=&quot;s&quot;&gt;&quot;go.etcd.io/etcd/clientv3&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// ä¸ºäº†ä¿è¯ HTTPS é“¾æ¥å¯ä¿¡ï¼Œéœ€è¦é¢„å…ˆåŠ è½½ç›®æ ‡è¯ä¹¦ç­¾å‘æœºæ„çš„ CA æ ¹è¯ä¹¦&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;etcdCA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ioutil&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ReadFile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/Users/mritd/tmp/etcd_ssl/etcd-root-ca.pem&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// etcd å¯ç”¨äº†åŒå‘ TLS è®¤è¯ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è¯ä¹¦åŒæ ·éœ€è¦åŠ è½½&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;etcdClientCert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LoadX509KeyPair&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/Users/mritd/tmp/etcd_ssl/etcd.pem&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/Users/mritd/tmp/etcd_ssl/etcd-key.pem&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// åˆ›å»ºä¸€ä¸ªç©ºçš„ CA Pool&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// å› ä¸ºåç»­åªä¼šé“¾æ¥ Etcd çš„ api ç«¯ç‚¹ï¼Œæ‰€ä»¥æ­¤å¤„é€‰æ‹©ä½¿ç”¨ç©ºçš„ CA Poolï¼Œç„¶ååªåŠ å…¥ Etcd CA æ—¢å¯&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// å¦‚æœæœŸæœ›é“¾æ¥å…¶ä»– TLS ç«¯ç‚¹ï¼Œé‚£ä¹ˆæœ€å¥½ä½¿ç”¨ x509.SystemCertPool() æ–¹æ³•å…ˆ copy ä¸€ä»½ç³»ç»Ÿæ ¹ CA&lt;/span&gt;
	&lt;span class=&quot;c&quot;&gt;// ç„¶åå†å‘è¿™ä¸ª Pool ä¸­æ·»åŠ è‡ªå®šä¹‰ CA&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rootCertPool&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x509&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewCertPool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;rootCertPool&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AppendCertsFromPEM&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etcdCA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;c&quot;&gt;// åˆ›å»º api v3 çš„ client&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;clientv3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;New&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clientv3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// etcd https api ç«¯ç‚¹&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;Endpoints&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;   &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;https://172.16.14.114:2379&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;DialTimeout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;c&quot;&gt;// è‡ªå®šä¹‰ CA åŠ Client Cert é…ç½®&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;TLS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;RootCAs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;      &lt;span class=&quot;n&quot;&gt;rootCertPool&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;Certificates&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;tls&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Certificate&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;etcdClientCert&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;putResp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Put&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;sample_key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;sample_value&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;putResp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;delResp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cli&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Delete&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;sample_key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Fatal&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;delResp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼Œæœ¬æ–‡é‡‡ç”¨ &lt;a href=&quot;http://creativecommons.org/licenses/by-nc-nd/4.0/&quot;&gt;CC4.0&lt;/a&gt; åè®®æˆæƒ&lt;/p&gt;
</description>
        <pubDate>Wed, 16 Oct 2019 10:59:03 +0800</pubDate>
        <link>https://mritd.me/2019/10/16/golang-etcd-client-example/</link>
        <guid isPermaLink="true">https://mritd.me/2019/10/16/golang-etcd-client-example/</guid>
        
        <category>Golang</category>
        
        
        <category>Golang</category>
        
      </item>
    
  </channel>
</rss>
